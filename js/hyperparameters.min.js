!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.hpjs={})}(this,function(t){"use strict";var n,r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e=function(t){return function(){var n=t.apply(this,arguments);return new Promise(function(t,r){return function e(i,a){try{var o=n[i](a),s=o.value}catch(t){return void r(t)}if(!o.done)return Promise.resolve(s).then(function(t){e("next",t)},function(t){e("throw",t)});t(s)}("next")})}},i=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},a=function(){function t(t,n){for(var r=0;n.length>r;r++){var e=n[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(n,r,e){return r&&t(n.prototype,r),e&&t(n,e),n}}(),o=Object.assign||function(t){for(var n=1;arguments.length>n;n++){var r=arguments[n];for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&(t[e]=r[e])}return t},s=function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)},u=function(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n},l=function(){function t(n){i(this,t),this.bits={},this.seed=void 0===n?(new Date).getTime():n,this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=Array(this.N),this.mti=this.N+1,this.initGen(this.seed)}return t.prototype.initGen=function(t){for(this.mt[0]=t>>>0,this.mti=1;this.N>this.mti;this.mti+=1){var n=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&n)>>>16)<<16)+1812433253*(65535&n)+this.mti,this.mt[this.mti]>>>=0}this.next_gauss=null},t.prototype.randint=function(){var t=void 0,n=[0,this.MATRIX_A];if(this.mti>=this.N){var r=void 0;for(this.mti===this.N+1&&this.initGen(5489),r=0;this.N-this.M>r;r+=1)this.mt[r]=this.mt[r+this.M]^(t=this.mt[r]&this.UPPER_MASK|this.mt[r+1]&this.LOWER_MASK)>>>1^n[1&t];for(;this.N-1>r;r+=1)this.mt[r]=this.mt[r+(this.M-this.N)]^(t=this.mt[r]&this.UPPER_MASK|this.mt[r+1]&this.LOWER_MASK)>>>1^n[1&t];this.mt[this.N-1]=this.mt[this.M-1]^(t=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK)>>>1^n[1&t],this.mti=0}return t=this.mt[this.mti+=1],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,(t^=t>>>18)>>>0},t.prototype.random=function(){var t=this.randint();return 7.450580596923828e-9*((t>>>5)+1.4901161193847656e-8*(t>>>6))},t.prototype.randbelow=function(t){if(0>=t)return 0;if(4294967296>=t){for(var n=t,r=this.bits[t]||(this.bits[t]=1+(Math.LOG2E*Math.log(t-1+1e-10)>>0));n>=t;)0>(n=this.randint()>>>32-r)&&(n+=4294967296);return n}return this.randint()%t},t.prototype.randrange=function(t,n,r){return void 0===n?this.randbelow(t):r?t+r*this.randbelow(Math.floor((n-t)/r)):t+this.randbelow(n-t)},t.prototype.gauss=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=this.next_gauss;if(null!=r)this.next_gauss=null;else{for(var e=void 0,i=void 0,a=void 0;!e||1<=e;)e=(i=2*this.random()-1)*i+(a=2*this.random()-1)*a;var o=Math.sqrt(-2*Math.log(e)/e);r=i*o,this.next_gauss=a*o}return t+r*n},t.prototype.uniform=function(t,n){return t+this.random()*(n-t)},t}(),c=function t(){var n=this;i(this,t),this.eval=function(t,e){var i=e.rng;if(void 0===t||null===t)return t;var a=i;void 0===a&&(a=new l);var s=t.name,u=function(t,n){var r={};for(var e in t)0>n.indexOf(e)&&Object.prototype.hasOwnProperty.call(t,e)&&(r[e]=t[e]);return r}(t,["name"]),c=n[s];return"function"!=typeof c?Array.isArray(t)?t.map(function(t){return n.eval(t,{rng:a})}):"object"===(void 0===t?"undefined":r(t))?Object.keys(t).reduce(function(r,e){var i;return o({},r,((i={})[e]=n.eval(t[e],{rng:a}),i))},{}):t:c(u,a)}},h=["new","running","suspended","ok","fail"],f=0,m=3,p=[f,1,2,m],v=["id","result","args","state","book_time","refresh_time"],d=function(t,n){return Array.from({length:n-t},function(n,r){return r+t})},g=function(){function t(){var n=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=1>=arguments.length||void 0===arguments[1]||arguments[1];i(this,t),this.refresh=function(){null===n.expKey?n.trials=n.dynamicTrials.filter(function(t){return t.state!==m}):(n.trials=n.dynamicTrials.filter(function(t){return t.state!==m&&t.expKey===n.expKey}),n.ids=[])},this.assertValidTrial=function(t){if(0>=Object.keys(t).length)throw Error("trial should be an object");var r=v.find(function(n){return void 0===t[n]});if(void 0!==r)throw Error("trial missing key "+r);if(t.expKey!==n.expKey)throw Error("wrong trial expKey "+t.expKey+", expected "+n.expKey);return t},this.internalInsertTrialDocs=function(t){var r=t.map(function(t){return t.id});return n.dynamicTrials=[].concat(n.dynamicTrials,t),r},this.insertTrialDoc=function(t){var r=n.assertValidTrial(t);return n.internalInsertTrialDocs([r])[0]},this.insertTrialDocs=function(t){var r=t.map(function(t){return n.assertValidTrial(t)});return n.internalInsertTrialDocs(r)},this.newTrialIds=function(t){var r=n.ids.length,e=d(r,r+t);return n.ids=[].concat(n.ids,e),e},this.newTrialDocs=function(t,r,e){for(var i=[],a=0;t.length>a;a+=1){var o={state:f,id:t[a],result:r[a],args:e[a]};o.expKey=n.expKey,o.book_time=null,o.refresh_time=null,i.push(o)}return i},this.deleteAll=function(){n.dynamicTrials=[],n.refresh()},this.countByStateSynced=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,e=null===r?n.trials:r,i=Array.isArray(t)?t:[t];return e.filter(function(t){return i.indexOf(t.state)>=0}).length},this.countByStateUnsynced=function(t){var r=null!==n.expKey?n.dynamicTrials.map(function(t){return t.expKey===n.expKey}):n.dynamicTrials;return n.countByStateSynced(t,r)},this.losses=function(){return n.results.map(function(t){return t.loss||t.accuracy})},this.statuses=function(){return n.results.map(function(t){return t.status})},this.ids=[],this.dynamicTrials=[],this.trials=[],this.expKey=r,e&&this.refresh()}return t.prototype.bestTrial=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(t,n){return void 0!==t.loss?n.loss>t.loss:t.accuracy>n.accuracy},n=this.trials[0];return this.trials.forEach(function(r){"ok"===r.result.status&&t(r.result,n.result)&&(n=r)}),n},a(t,[{key:"length",get:function(){return this.trials.length}},{key:"results",get:function(){return this.trials.map(function(t){return t.result})}},{key:"args",get:function(){return this.trials.map(function(t){return t.args})}},{key:"argmin",get:function(){var t=this.bestTrial();return void 0!==t?t.args:void 0}},{key:"argmax",get:function(){var t=this.bestTrial(function(t,n){return void 0!==t.loss?t.loss>n.loss:t.accuracy>n.accuracy});return void 0!==t?t.args:void 0}}]),t}(),y=function t(n,r,a){var o,s=this;i(this,t),this.evaluate=(o=e(function*(t){var n=yield s.fn(t,s.params),r=void 0;if("number"!=typeof n||Number.isNaN(n)){if(void 0===(r=n))throw Error("Optimization function should return a loss value");var e=r.status,i=r.loss,a=r.accuracy;if(0>h.indexOf(e))throw Error("invalid status "+e);if("ok"===e&&void 0===i&&void 0===a)throw Error("invalid loss and accuracy")}else r={loss:n,status:"ok"};return r}),function(t){return o.apply(this,arguments)}),this.newResult=function(){return{status:"new"}},this.fn=n,this.expr=r,this.params=a},S=function(){return(new Date).getTime()},b=function(){function t(n,r,e){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=a.rng,s=a.catchExceptions,u=void 0!==s&&s,l=a.max_queue_len,c=void 0===l?1:l,h=a.max_evals,f=void 0===h?Number.MAX_VALUE:h,m=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};i(this,t),w.call(this),this.catchExceptions=u,this.algo=n,this.domain=r,this.trials=e,this.callbacks=m.callbacks||{},this.max_queue_len=c,this.max_evals=f,this.rng=o}return t.prototype.serial_evaluate=function(){var t=e(function*(){for(var t=this.callbacks,n=t.onExperimentBegin,r=t.onExperimentEnd,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,i=!1,a=0;this.trials.dynamicTrials.length>a;a+=1){var o=this.trials.dynamicTrials[a];if(o.state===f){o.state=1;var s=S();o.book_time=s,o.refresh_time=s;try{"function"==typeof n&&!0===(yield n(a,o))&&(i=!0);var u=yield this.domain.evaluate(o.args);o.state=2,o.result=u,o.refresh_time=S()}catch(t){if(o.state=m,o.error=t+", "+t.message,o.refresh_time=S(),!this.catchExceptions)throw this.trials.refresh(),t}"function"==typeof r&&!0===(yield r(a,o))&&(i=!0)}if(0===(e-=1)||i)break}return this.trials.refresh(),i});return function(){return t.apply(this,arguments)}}(),t}(),w=function(){var t,n=this;this.run=(t=e(function*(t){for(var r=n.trials,e=n.algo,i=0,a=function(){return n.trials.countByStateUnsynced(f)},o=!1;t>i;){for(var s=a();n.max_queue_len>s&&t>i;){var u=r.newTrialIds(Math.min(n.max_queue_len-s,t-i));r.refresh();var l=e(u,n.domain,r,n.rng.randrange(0,2147483647));if(console.assert(u.length>=l.length),!l.length){o=!0;break}n.trials.insertTrialDocs(l),n.trials.refresh(),i+=l.length,s=a()}if(o=o||(yield n.serial_evaluate()))break}var c=a();c&&console.error("Exiting run, not waiting for "+c+" jobs.")}),function(n){return t.apply(this,arguments)}),this.exhaust=e(function*(){return yield n.run(n.max_evals-n.trials.length),n.trials.refresh(),n})},_=(n=e(function*(t,n,r,e){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=i.trials,o=i.rng,s=i.catchExceptions,u=void 0!==s&&s,c=void 0;c=o||new l;var h=void 0;h=a||new g;var f=new y(t,n,i);return yield new b(r,f,h,{max_evals:e,rng:c,catchExceptions:u},i).exhaust(),h}),function(t,r,e,i){return n.apply(this,arguments)}),T=function(t){function n(){var r,e;i(this,n);for(var a=arguments.length,o=Array(a),s=0;a>s;s++)o[s]=arguments[s];return r=e=u(this,t.call.apply(t,[this].concat(o))),e.choice=function(t,n){var r=t.options,i=n.randrange(0,r.length,1);return e.eval(r[i],{rng:n})},e.randint=function(t,n){return n.randrange(0,t.upper,1)},e.uniform=function(t,n){return n.uniform(t.low,t.high)},e.quniform=function(t,n){var r=t.q;return Math.round(n.uniform(t.low,t.high)/r)*r},e.loguniform=function(t,n){return Math.exp(n.uniform(t.low,t.high))},e.qloguniform=function(t,n){var r=t.q;return Math.round(Math.exp(n.uniform(t.low,t.high))/r)*r},e.normal=function(t,n){return n.gauss(t.mu,t.sigma)},e.qnormal=function(t,n){var r=t.q;return Math.round(n.gauss(t.mu,t.sigma)/r)*r},e.lognormal=function(t,n){return Math.exp(n.gauss(t.mu,t.sigma))},e.qlognormal=function(t,n){var r=t.q;return Math.round(Math.exp(n.gauss(t.mu,t.sigma))/r)*r},u(e,r)}return s(n,t),n}(c),x=function(){function t(n,r){var e=this;i(this,t),this.getSample=function(){},this.sample=function(t){if(0>t||t>=e.numSamples)throw Error('invalid sample index "'+t+'"');return e.getSample(t)},this.params=n,this.gs=r}return a(t,[{key:"numSamples",get:function(){return 1}}]),t}(),E=function(t){function n(){var r,e;i(this,n);for(var a=arguments.length,o=Array(a),s=0;a>s;s++)o[s]=arguments[s];return r=e=u(this,t.call.apply(t,[this].concat(o))),e.getSample=function(t){return e.params.options[t]},u(e,r)}return s(n,t),a(n,[{key:"numSamples",get:function(){throw Error('Can not evaluate length of non-discrete parameter "'+this.params.name+'"')}}]),n}(x),A=function(t){function n(){var r,e;i(this,n);for(var a=arguments.length,o=Array(a),s=0;a>s;s++)o[s]=arguments[s];return r=e=u(this,t.call.apply(t,[this].concat(o))),e.getSample=function(t){return e.params.options[t]},u(e,r)}return s(n,t),a(n,[{key:"numSamples",get:function(){var t=this;return this.params.options.reduce(function(n,r){return n+t.gs.numSamples(r)},0)}}]),n}(x),O=function(t){function n(){var r,e;i(this,n);for(var a=arguments.length,o=Array(a),s=0;a>s;s++)o[s]=arguments[s];return r=e=u(this,t.call.apply(t,[this].concat(o))),e.getSample=function(t){return t},u(e,r)}return s(n,t),a(n,[{key:"numSamples",get:function(){return this.params.upper}}]),n}(x),k=function(t){function n(){var r,e;i(this,n);for(var a=arguments.length,o=Array(a),s=0;a>s;s++)o[s]=arguments[s];return r=e=u(this,t.call.apply(t,[this].concat(o))),e.getSample=function(t){return e.params.low+t*e.params.q},u(e,r)}return s(n,t),a(n,[{key:"numSamples",get:function(){return Math.floor((this.params.high-this.params.low)/this.params.q)+1}}]),n}(x),q=function(t){function n(){var r,e;i(this,n);for(var a=arguments.length,o=Array(a),s=0;a>s;s++)o[s]=arguments[s];return r=e=u(this,t.call.apply(t,[this].concat(o))),e.getSample=function(t){return e.params.mu-2*e.params.sigma+t*e.params.q},u(e,r)}return s(n,t),a(n,[{key:"numSamples",get:function(){return Math.floor(4*this.params.sigma/this.params.q)+1}}]),n}(x),M={choice:A,randint:O,quniform:k,qloguniform:k,qnormal:q,qlognormal:q,uniform:E,loguniform:E,normal:E,lognormal:E},N=function(t){function n(){var e,a;i(this,n);for(var o=arguments.length,s=Array(o),l=0;o>l;l++)s[l]=arguments[l];return e=a=u(this,t.call.apply(t,[this].concat(s))),a.numSamples=function(t){return a.samples(t).reduce(function(t,n){return t*n.samples},1)},a.samples=function(t){if(!t)return t;var n=[],e=t.name,i=M[e];return void 0===i?(Array.isArray(t)&&t.forEach(function(t){return n.push.apply(n,a.samples(t))}),"string"==typeof t&&n.push({name:e,samples:1,expr:t}),"object"===(void 0===t?"undefined":r(t))&&Object.keys(t).forEach(function(r){return n.push.apply(n,a.samples(t[r]))})):n.push({name:e,samples:new i(t,a).numSamples,expr:t}),n},u(a,e)}return s(n,t),n}(c),K={randomSearch:function(t,n,r,e){var i=new l(e),a=[],o=new T;return t.forEach(function(t){var e=o.eval(n.expr,{rng:i}),s=n.newResult();a=[].concat(a,r.newTrialDocs([t],[s],[e]))}),a},gridSearch:function(t,n,r){var e=[],i=new N;return t.forEach(function(t){var a=i.eval(n.expr),o=n.newResult();e=[].concat(e,r.newTrialDocs([t],[o],[a]))}),e}},j={randomSample:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=(new T).eval(t,n);if(1===Object.keys(r).length){var e=Object.keys(r).map(function(t){return r[t]});return 1===e.length?e[0]:e}return r},gridSample:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=(new N).eval(t,n);if(1===Object.keys(r).length){var e=Object.keys(r).map(function(t){return r[t]});return 1===e.length?e[0]:e}return r}};t.fmin=_,t.RandomState=l,t.choice=function(t){return{name:"choice",options:t}},t.randint=function(t){return{name:"randint",upper:t}},t.uniform=function(t,n){return{name:"uniform",low:t,high:n}},t.quniform=function(t,n,r){return{name:"quniform",low:t,high:n,q:r}},t.loguniform=function(t,n){return{name:"loguniform",low:t,high:n}},t.qloguniform=function(t,n,r){return{name:"qloguniform",low:t,high:n,q:r}},t.normal=function(t,n){return{name:"normal",mu:t,sigma:n}},t.qnormal=function(t,n,r){return{name:"qnormal",mu:t,sigma:n,q:r}},t.lognormal=function(t,n){return{name:"lognormal",mu:t,sigma:n}},t.qlognormal=function(t,n,r){return{name:"qlognormal",mu:t,sigma:n,q:r}},t.search=K,t.sample=j,t.STATUS_NEW="new",t.STATUS_RUNNING="running",t.STATUS_SUSPENDED="suspended",t.STATUS_OK="ok",t.STATUS_FAIL="fail",t.STATUS_STRINGS=h,t.JOB_STATE_NEW=f,t.JOB_STATE_RUNNING=1,t.JOB_STATE_DONE=2,t.JOB_STATE_ERROR=m,t.JOB_STATES=p,t.TRIAL_KEYS=v,t.range=d,t.Trials=g,t.Domain=y,Object.defineProperty(t,"__esModule",{value:!0})});
