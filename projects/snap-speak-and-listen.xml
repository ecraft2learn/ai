<blocks app="Snap! 4.0, http://snap.berkeley.edu" version="1"><block-definition s="speak %&apos;text&apos; %&apos;what to do when finished&apos;" type="command" category="sound"><header></header><code></code><inputs><input type="%s"></input><input type="%cmdRing"></input></inputs><script><block s="doRun"><block s="reportJSFunction"><list><l>message</l><l>finished_callback</l></list><l>var utterance = new SpeechSynthesisUtterance(message);&#xD;&#xD;if (typeof finished_callback === &apos;object&apos;) {&#xD;&#xD;   // callback provided&#xD;&#xD;   utterance.onend = function (event) {&#xD;&#xD;       invoke(finished_callback, new List([message]));&#xD;&#xD;   };&#xD;&#xD;}&#xD;&#xD;if (window.speech_recognition) {&#xD;&#xD;   window.speech_recognition.abort();&#xD;&#xD;}&#xD;&#xD;window.speechSynthesis.speak(utterance);&#xD;&#xD;</l></block><list><block var="text"/><block var="what to do when finished"/></list></block></script></block-definition><block-definition s="listen and then %&apos;do with recognised words&apos; %&apos;do if nothing recognised&apos;" type="command" category="other"><header></header><code></code><inputs><input type="%cmdRing"></input><input type="%cmdRing"></input></inputs><script><block s="doRun"><block s="reportJSFunction"><list><l>spoken_callback</l><l>error_callback</l></list><l>var restart = function () {&#xD;&#xD;    if (window.speechSynthesis.speaking) { // don&apos;t listen while speaking&#xD;&#xD;        // there remains the possibility of speech happening after recognition starts&#xD;&#xD;        setTimeout(restart, 500); // try again in half a second&#xD;&#xD;        return;&#xD;&#xD;    }&#xD;&#xD;    try {&#xD;&#xD;        window.speech_recognition.start();&#xD;&#xD;        console.log("recognition started");&#xD;&#xD;    } catch (error) {&#xD;&#xD;        if (error.name === &apos;InvalidStateError&apos;) {&#xD;&#xD;            // delay needed at least in Chrome 52&#xD;&#xD;            setTimeout(restart, 2000);&#xD;&#xD;        } else {&#xD;&#xD;            console.log(error);&#xD;&#xD;        }&#xD;&#xD;    }&#xD;&#xD;};&#xD;&#xD;var handle_result = function (callback, event) {&#xD;&#xD;    var spoken = event.results[0][0].transcript;&#xD;&#xD;    console.log("Confidence is " + event.results[0][0].confidence + " for " + spoken, spoken_callback);&#xD;&#xD;    window.speech_recognition.stop();&#xD;&#xD;    invoke(callback, new List([spoken]));&#xD;&#xD;};&#xD;&#xD;var handle_error = function (callback, event) {&#xD;&#xD;    if (event.error === &apos;aborted&apos;) {&#xD;&#xD;        console.log("aborted so restarting speech recognition in half a second");&#xD;&#xD;        setTimeout(restart, 500);&#xD;&#xD;        return;&#xD;&#xD;    }&#xD;&#xD;    if (event.error === &apos;no-speech&apos;) {&#xD;&#xD;        window.speech_recognition.onend = null;&#xD;&#xD;        window.speech_recognition.onresult = null;&#xD;&#xD;        window.speech_recognition.stop();&#xD;&#xD;    }&#xD;&#xD;    console.log("Recognition error: " + event.error);&#xD;&#xD;    if (typeof callback === &apos;object&apos;) {&#xD;&#xD;        invoke(callback, new List([event.error]));&#xD;&#xD;    }&#xD;&#xD;};&#xD;&#xD;if (!window.speech_recognition) {&#xD;&#xD;    window.speech_recognition = (typeof SpeechRecognition === &apos;undefined&apos;) ? &#xD;&#xD;        new webkitSpeechRecognition() :&#xD;&#xD;        new SpeechRecognition();&#xD;&#xD;}&#xD;&#xD;window.speech_recognition.onresult = function (event) {&#xD;&#xD;    handle_result(spoken_callback, event);&#xD;&#xD;};&#xD;&#xD;window.speech_recognition.onerror = function (event) {&#xD;&#xD;    handle_error(error_callback, event);&#xD;&#xD;};&#xD;&#xD;window.speech_recognition.onend = function (event) {&#xD;&#xD;    console.log("recognition ended");&#xD;&#xD;    restart(); &#xD;&#xD;};&#xD;&#xD;restart();&#xD;&#xD;</l></block><list><block var="do with recognised words"/><block var="do if nothing recognised"/></list></block></script></block-definition><block-definition s="listen" type="command" category="other"><header></header><code></code><inputs></inputs><script><block s="doSetVar"><l>listening</l><block s="reportBoolean"><l><bool>true</bool></l></block></block><custom-block s="listen and then %cmdRing %cmdRing"><block s="reifyScript"><script><block s="doSetVar"><l>last thing spoken</l><block var="spoken"/></block><block s="doBroadcast"><l>heard something</l></block><custom-block s="listen"></custom-block></script><list><l>spoken</l></list></block><block s="reifyScript"><script><block s="doSetVar"><l>speech recognition error</l><block var="error"/></block><block s="doBroadcast"><l>speech recognition error</l></block><block s="doIf"><block var="listening"/><script><block s="doIfElse"><block s="reportEquals"><block var="speech recognition error"/><l>no-speech</l></block><script><custom-block s="speak %s %cmdRing"><l>I didn&apos;t hear anything for a while. Bye.</l><block s="reifyScript"><script></script><list></list></block></custom-block><block s="doSetVar"><l>listening</l><block s="reportBoolean"><l><bool>false</bool></l></block></block></script><script><custom-block s="speak %s %cmdRing"><block s="reportJoinWords"><list><l>There was an error. </l><block var="speech recognition error"/></list></block><block s="reifyScript"><script></script><list></list></block></custom-block><block s="bubble"><block s="reportJoinWords"><list><l>There was an error. </l><block var="speech recognition error"/></list></block></block><custom-block s="speak %s %cmdRing"><l>Try again.</l><block s="reifyScript"><script><custom-block s="listen"></custom-block></script><list></list></block></custom-block></script></block></script></block></script><list><l>error</l></list></block></custom-block></script></block-definition></blocks>