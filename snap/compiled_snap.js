var morphicVersion="2017-September-26",modules={},useBlurredShadows=getBlurredShadowSupport(),standardSettings={minimumFontHeight:getMinimumFontHeight(),globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:12,bubbleHelpFontSize:10,prompterFontName:"sans-serif",prompterFontSize:12,prompterSliderSize:10,handleSize:15,scrollBarSize:12,mouseScrollAmount:40,useSliderForInput:!1,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},touchScreenSettings={minimumFontHeight:standardSettings.minimumFontHeight,
globalFontFamily:"",menuFontName:"sans-serif",menuFontSize:24,bubbleHelpFontSize:18,prompterFontName:"sans-serif",prompterFontSize:24,prompterSliderSize:20,handleSize:26,scrollBarSize:24,mouseScrollAmount:40,useSliderForInput:!0,useVirtualKeyboard:!0,isTouchDevice:!1,rasterizeSVGs:!1,isFlat:!1,grabThreshold:5},MorphicPreferences=standardSettings;enableRetinaSupport();function nop(){return null}function localize(a){return a}function isNil(a){return void 0===a||null===a}
function contains(a,b){return-1!==a.indexOf(b)}function detect(a,b){var c,d=a.length;for(c=0;c<d;c+=1)if(b.call(null,a[c]))return a[c];return null}function sizeOf(a){var b=0,c;for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b+=1);return b}function isString(a){return"string"===typeof a||a instanceof String}function isObject(a){return null!==a&&("object"===typeof a||a instanceof Object)}function radians(a){return a*Math.PI/180}function degrees(a){return 180*a/Math.PI}
function fontHeight(a){return 1.2*Math.max(a,MorphicPreferences.minimumFontHeight)}function isWordChar(a){return a.match(/[A-z\u00c0-\u00ff0-9]/)}function newCanvas(a,b){var c=a||{x:0,y:0};a=document.createElement("canvas");a.width=c.x;a.height=c.y;b&&a.isRetinaEnabled&&(a.isRetinaEnabled=!1);return a}
function getMinimumFontHeight(){var a=document.createElement("canvas"),b,c;a.width=50;a.height=50;a=a.getContext("2d");a.font="1px serif";var d=a.measureText("I").width;a.fillStyle="black";a.textBaseline="bottom";a.fillText("I",0,50);for(c=0;50>c;c+=1)for(b=0;b<d;b+=1){var e=a.getImageData(b,c,1,1);if(0!==e.data[3])return 50-c+1}return 0}
function getBlurredShadowSupport(){var a=document.createElement("canvas");a.width=10;a.height=10;var b=a.getContext("2d");b.fillStyle="rgb(255, 0, 0)";b.beginPath();b.arc(5,5,5,0,2*Math.PI,!0);b.closePath();b.fill();b=document.createElement("canvas");b.width=10;b.height=10;b=b.getContext("2d");b.shadowBlur=10;b.shadowColor="rgba(0, 0, 255, 1)";b.drawImage(a,0,0);return b.getImageData(0,0,1,1).data[3]?!0:!1}
function getDocumentPositionOf(a){if(null===a)return{x:0,y:0};var b={x:a.offsetLeft,y:a.offsetTop};for(a=a.offsetParent;null!==a;)b.x+=a.offsetLeft,b.y+=a.offsetTop,a!==document.body&&a!==document.documentElement&&(b.x-=a.scrollLeft,b.y-=a.scrollTop),a=a.offsetParent;return b}
function copy(a){var b;if("object"!==typeof a)return a;var c=a.valueOf();if(a!==c)return new a.constructor(c);if(a instanceof a.constructor&&a.constructor!==Object){c=Object.create(a.constructor.prototype);var d=Object.keys(a);var e=d.length;for(b=0;b<e;b+=1){var f=d[b];c[f]=a[f]}}else for(f in c={},a)c[f]=a[f];return c}
function enableRetinaSupport(){function a(a){return a.isRetinaEnabled?(d||1)/c:1}var b=document.createElement("canvas").getContext("2d"),c=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1,d=Math.ceil(window.devicePixelRatio);b=HTMLCanvasElement.prototype;var e=CanvasRenderingContext2D.prototype,f={drawImage:e.drawImage,getImageData:e.getImageData,width:Object.getOwnPropertyDescriptor(b,"width"),height:Object.getOwnPropertyDescriptor(b,
"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(e,"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(e,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(e,"shadowBlur")};c===d||Object.keys(f).some(function(a){a=f[a];return a.hasOwnProperty("configurable")&&!a.configurable})||(b._isRetinaEnabled=!0,b._bak=f,Object.defineProperty(b,"isRetinaEnabled",{get:function(){return this._isRetinaEnabled},set:function(b){var c=a(this),d=this.width,e=this.height;this._isRetinaEnabled=
b;a(this)!=c&&(this.width=d,this.height=e)},configurable:!0}),Object.defineProperty(b,"width",{get:function(){return f.width.get.call(this)/a(this)},set:function(b){try{var c=a(this);f.width.set.call(this,b*c);var d=this.getContext("2d");d.restore();d.save();d.scale(c,c)}catch(l){console.log("Retina Display Support Problem",l),f.width.set.call(this,b)}}}),Object.defineProperty(b,"height",{get:function(){return f.height.get.call(this)/a(this)},set:function(b){var c=a(this);f.height.set.call(this,b*
c);b=this.getContext("2d");b.restore();b.save();b.scale(c,c)}}),e.drawImage=function(b){var c=a(b);switch(arguments.length){case 9:var d=arguments[1];var e=arguments[2];var g=arguments[3];var n=arguments[4];var p=arguments[5];var q=arguments[6];var t=arguments[7];var r=arguments[8];break;case 5:e=d=0;g=b.width;n=b.height;p=arguments[1];q=arguments[2];t=arguments[3];r=arguments[4];break;case 3:e=d=0;g=b.width;n=b.height;p=arguments[1];q=arguments[2];t=b.width;r=b.height;break;default:throw Error("Called drawImage() with "+
arguments.length+" arguments");}f.drawImage.call(this,b,d*c,e*c,g*c,n*c,p,q,t,r)},e.getImageData=function(b,c,d,e){var g=a(this.canvas);return f.getImageData.call(this,b*g,c*g,d*g,e*g)},Object.defineProperty(e,"shadowOffsetX",{get:function(){return f.shadowOffsetX.get.call(this)/a(this.canvas)},set:function(b){var c=a(this.canvas);f.shadowOffsetX.set.call(this,b*c)}}),Object.defineProperty(e,"shadowOffsetY",{get:function(){return f.shadowOffsetY.get.call(this)/a(this.canvas)},set:function(b){var c=
a(this.canvas);f.shadowOffsetY.set.call(this,b*c)}}),Object.defineProperty(e,"shadowBlur",{get:function(){return f.shadowBlur.get.call(this)/a(this.canvas)},set:function(b){var c=a(this.canvas);f.shadowBlur.set.call(this,b*c)}}))}
function isRetinaSupported(){var a=document.createElement("canvas").getContext("2d");a=a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1;var b=HTMLCanvasElement.prototype,c=CanvasRenderingContext2D.prototype,d={drawImage:c.drawImage,getImageData:c.getImageData,width:Object.getOwnPropertyDescriptor(b,"width"),height:Object.getOwnPropertyDescriptor(b,"height"),shadowOffsetX:Object.getOwnPropertyDescriptor(c,
"shadowOffsetX"),shadowOffsetY:Object.getOwnPropertyDescriptor(c,"shadowOffsetY"),shadowBlur:Object.getOwnPropertyDescriptor(c,"shadowBlur")};return a!==window.devicePixelRatio&&!Object.keys(d).some(function(a){a=d[a];return a.hasOwnProperty("configurable")&&!a.configurable})}function isRetinaEnabled(){return HTMLCanvasElement.prototype.hasOwnProperty("_isRetinaEnabled")}
function disableRetinaSupport(){if(isRetinaEnabled()){var a=HTMLCanvasElement.prototype;var b=CanvasRenderingContext2D.prototype;var c=a._bak;Object.defineProperty(a,"width",c.width);Object.defineProperty(a,"height",c.height);b.drawImage=c.drawImage;b.getImageData=c.getImageData;Object.defineProperty(b,"shadowOffsetX",c.shadowOffsetX);Object.defineProperty(b,"shadowOffsetY",c.shadowOffsetY);Object.defineProperty(b,"shadowBlur",c.shadowBlur);delete a._isRetinaEnabled;delete a.isRetinaEnabled;delete a._bak}}
function normalizeCanvas(a,b){if(!a.isRetinaEnabled)return a;var c=newCanvas(new Point(a.width,a.height),!0);c.getContext("2d").drawImage(a,0,0);if(b)return c;a.isRetinaEnabled=!1;a.width=c.width;a.height=c.height;a.getContext("2d").drawImage(c,0,0);return a}
function Animation(a,b,c,d,e,f){this.setter=a;this.getter=b;this.delta=c||0;this.duration=d||0;this.easing=isString(e)?this.easings[e]||this.easings.sinusoidal:e||this.easings.sinusoidal;this.onComplete=f||null;this.destination=this.endTime=null;this.isActive=!1;this.start()}
Animation.prototype.easings={linear:function(a){return a},sinusoidal:function(a){return 1-Math.cos(radians(90*a))},quadratic:function(a){return.5>a?2*a*a:(4-2*a)*a-1},cubic:function(a){return.5>a?4*a*a*a:(a-1)*(2*a-2)*(2*a-2)+1},elastic:function(a){return 0>(a-=.5)?(.01+.01/a)*Math.sin(50*a):(.02-.01/a)*Math.sin(50*a)+1},sine_in:function(a){return 1-Math.sin(radians(90+90*a))},quad_in:function(a){return a*a},cubic_in:function(a){return a*a*a},elastic_in:function(a){return(.04-.04/a)*Math.sin(25*a)+
1},sine_out:function(a){return Math.sin(radians(90*a))},quad_out:function(a){return a*(2-a)},elastic_out:function(a){return.04*a/--a*Math.sin(25*a)}};Animation.prototype.start=function(){this.endTime=Date.now()+this.duration;this.destination=this.getter.call(this)+this.delta;this.isActive=!0};
Animation.prototype.step=function(){if(this.isActive){var a=Date.now();if(a>this.endTime){if(this.setter(this.destination),this.isActive=!1,this.onComplete)this.onComplete()}else this.setter(this.destination-this.delta*this.easing((this.endTime-a)/this.duration))}};function Color(a,b,c,d){this.r=a||0;this.g=b||0;this.b=c||0;this.a=d||(0===d?0:1)}Color.prototype.toString=function(){return"rgba("+Math.round(this.r)+","+Math.round(this.g)+","+Math.round(this.b)+","+this.a+")"};
Color.prototype.copy=function(){return new Color(this.r,this.g,this.b,this.a)};Color.prototype.eq=function(a){return a&&this.r===a.r&&this.g===a.g&&this.b===a.b};Color.prototype.hsv=function(){var a=this.r/255,b=this.g/255,c=this.b/255;var d=Math.max(a,b,c);var e=Math.min(a,b,c);var f=d;var g=d-e;if(d===e)f=0;else{switch(d){case a:f=(b-c)/g+(b<c?6:0);break;case b:f=(c-a)/g+2;break;case c:f=(a-b)/g+4}f/=6}return[f,0===d?0:g/d,d]};
Color.prototype.set_hsv=function(a,b,c){var d=Math.floor(6*a);var e=6*a-d;a=c*(1-b);var f=c*(1-e*b);b=c*(1-(1-e)*b);switch(d%6){case 0:this.r=c;this.g=b;this.b=a;break;case 1:this.r=f;this.g=c;this.b=a;break;case 2:this.r=a;this.g=c;this.b=b;break;case 3:this.r=a;this.g=f;this.b=c;break;case 4:this.r=b;this.g=a;this.b=c;break;case 5:this.r=c,this.g=a,this.b=f}this.r*=255;this.g*=255;this.b*=255};
Color.prototype.mixed=function(a,b){a=Math.min(Math.max(a,0),1);var c=1-a;return new Color(this.r*a+b.r*c,this.g*a+b.g*c,this.b*a+b.b*c)};Color.prototype.darker=function(a){var b=.8333;a&&(b=(100-a)/100);return this.mixed(b,new Color(0,0,0))};Color.prototype.lighter=function(a){var b=.8333;a&&(b=(100-a)/100);return this.mixed(b,new Color(255,255,255))};Color.prototype.dansDarker=function(){var a=this.hsv(),b=new Color;b.set_hsv(a[0],a[1],Math.max(a[2]-.16,0));return b};
Color.prototype.inverted=function(){return new Color(255-this.r,255-this.g,255-this.b)};function Point(a,b){this.x=a||0;this.y=b||0}Point.prototype.toString=function(){return Math.round(this.x.toString())+"@"+Math.round(this.y.toString())};Point.prototype.copy=function(){return new Point(this.x,this.y)};Point.prototype.eq=function(a){return this.x===a.x&&this.y===a.y};Point.prototype.lt=function(a){return this.x<a.x&&this.y<a.y};Point.prototype.gt=function(a){return this.x>a.x&&this.y>a.y};
Point.prototype.ge=function(a){return this.x>=a.x&&this.y>=a.y};Point.prototype.le=function(a){return this.x<=a.x&&this.y<=a.y};Point.prototype.max=function(a){return new Point(Math.max(this.x,a.x),Math.max(this.y,a.y))};Point.prototype.min=function(a){return new Point(Math.min(this.x,a.x),Math.min(this.y,a.y))};Point.prototype.round=function(){return new Point(Math.round(this.x),Math.round(this.y))};Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))};
Point.prototype.neg=function(){return new Point(-this.x,-this.y)};Point.prototype.mirror=function(){return new Point(this.y,this.x)};Point.prototype.floor=function(){return new Point(Math.max(Math.floor(this.x),0),Math.max(Math.floor(this.y),0))};Point.prototype.ceil=function(){return new Point(Math.ceil(this.x),Math.ceil(this.y))};Point.prototype.add=function(a){return a instanceof Point?new Point(this.x+a.x,this.y+a.y):new Point(this.x+a,this.y+a)};
Point.prototype.subtract=function(a){return a instanceof Point?new Point(this.x-a.x,this.y-a.y):new Point(this.x-a,this.y-a)};Point.prototype.multiplyBy=function(a){return a instanceof Point?new Point(this.x*a.x,this.y*a.y):new Point(this.x*a,this.y*a)};Point.prototype.divideBy=function(a){return a instanceof Point?new Point(this.x/a.x,this.y/a.y):new Point(this.x/a,this.y/a)};
Point.prototype.floorDivideBy=function(a){return a instanceof Point?new Point(Math.floor(this.x/a.x),Math.floor(this.y/a.y)):new Point(Math.floor(this.x/a),Math.floor(this.y/a))};Point.prototype.r=function(){var a=this.multiplyBy(this);return Math.sqrt(a.x+a.y)};Point.prototype.degrees=function(){if(0===this.x)return 0<=this.y?90:270;var a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?degrees(a):360+degrees(a):180+degrees(a)};
Point.prototype.theta=function(){if(0===this.x)return 0<=this.y?radians(90):radians(270);var a=Math.atan(this.y/this.x);return 0<=this.x?0<=this.y?a:radians(360)+a:radians(180)+a};Point.prototype.crossProduct=function(a){return this.multiplyBy(a.mirror())};Point.prototype.distanceTo=function(a){return a.subtract(this).r()};Point.prototype.rotate=function(a,b){var c=this.subtract(b);return"right"===a?(new Point(-c.y,c.y)).add(b):"left"===a?(new Point(c.y,-c.y)).add(b):b.subtract(c)};
Point.prototype.flip=function(a,b){return"vertical"===a?new Point(this.x,2*b.y-this.y):new Point(2*b.x-this.x,this.y)};Point.prototype.distanceAngle=function(a,b){270<b?b-=360:-270>b&&(b+=360);if(-90<=b&&90>=b)return b=Math.sin(radians(b))*a,a=Math.sqrt(a*a-b*b),new Point(b+this.x,this.y-a);b=Math.sin(radians(180-b))*a;a=Math.sqrt(a*a-b*b);return new Point(b+this.x,this.y+a)};Point.prototype.scaleBy=function(a){return this.multiplyBy(a)};Point.prototype.translateBy=function(a){return this.add(a)};
Point.prototype.rotateBy=function(a,b){b=b||new Point(0,0);var c=this.subtract(b),d=c.r();a-=c.theta();return new Point(b.x+d*Math.cos(a),b.y-d*Math.sin(a))};Point.prototype.asArray=function(){return[this.x,this.y]};function Rectangle(a,b,c,d){this.init(new Point(a||0,b||0),new Point(c||0,d||0))}Rectangle.prototype.init=function(a,b){this.origin=a;this.corner=b};Rectangle.prototype.toString=function(){return"["+this.origin.toString()+" | "+this.extent().toString()+"]"};
Rectangle.prototype.copy=function(){return new Rectangle(this.left(),this.top(),this.right(),this.bottom())};Point.prototype.corner=function(a){return new Rectangle(this.x,this.y,a.x,a.y)};Point.prototype.rectangle=function(a){var b=this.min(a);a=this.max(a);return new Rectangle(b.x,b.y,a.x,a.y)};Point.prototype.extent=function(a){a=this.add(a);return new Rectangle(this.x,this.y,a.x,a.y)};
Rectangle.prototype.setTo=function(a,b,c,d){this.origin=new Point(a||(0===a?0:this.left()),b||(0===b?0:this.top()));this.corner=new Point(c||(0===c?0:this.right()),d||(0===d?0:this.bottom()))};Rectangle.prototype.area=function(){var a=this.width();return 0>a?0:Math.max(a*this.height(),0)};Rectangle.prototype.bottom=function(){return this.corner.y};Rectangle.prototype.bottomCenter=function(){return new Point(this.center().x,this.bottom())};
Rectangle.prototype.bottomLeft=function(){return new Point(this.origin.x,this.corner.y)};Rectangle.prototype.bottomRight=function(){return this.corner.copy()};Rectangle.prototype.boundingBox=function(){return this};Rectangle.prototype.center=function(){return this.origin.add(this.corner.subtract(this.origin).floorDivideBy(2))};Rectangle.prototype.corners=function(){return[this.origin,this.bottomLeft(),this.corner,this.topRight()]};Rectangle.prototype.extent=function(){return this.corner.subtract(this.origin)};
Rectangle.prototype.height=function(){return this.corner.y-this.origin.y};Rectangle.prototype.left=function(){return this.origin.x};Rectangle.prototype.leftCenter=function(){return new Point(this.left(),this.center().y)};Rectangle.prototype.right=function(){return this.corner.x};Rectangle.prototype.rightCenter=function(){return new Point(this.right(),this.center().y)};Rectangle.prototype.top=function(){return this.origin.y};
Rectangle.prototype.topCenter=function(){return new Point(this.center().x,this.top())};Rectangle.prototype.topLeft=function(){return this.origin};Rectangle.prototype.topRight=function(){return new Point(this.corner.x,this.origin.y)};Rectangle.prototype.width=function(){return this.corner.x-this.origin.x};Rectangle.prototype.position=function(){return this.origin};Rectangle.prototype.eq=function(a){return this.origin.eq(a.origin)&&this.corner.eq(a.corner)};
Rectangle.prototype.abs=function(){var a=this.origin.abs();var b=this.corner.max(a);return a.corner(b)};Rectangle.prototype.insetBy=function(a){var b=new Rectangle;b.origin=this.origin.add(a);b.corner=this.corner.subtract(a);return b};Rectangle.prototype.expandBy=function(a){var b=new Rectangle;b.origin=this.origin.subtract(a);b.corner=this.corner.add(a);return b};Rectangle.prototype.growBy=function(a){var b=new Rectangle;b.origin=this.origin.copy();b.corner=this.corner.add(a);return b};
Rectangle.prototype.intersect=function(a){var b=new Rectangle;b.origin=this.origin.max(a.origin);b.corner=this.corner.min(a.corner);return b};Rectangle.prototype.merge=function(a){var b=new Rectangle;b.origin=this.origin.min(a.origin);b.corner=this.corner.max(a.corner);return b};Rectangle.prototype.mergeWith=function(a){this.origin=this.origin.min(a.origin);this.corner=this.corner.max(a.corner)};Rectangle.prototype.round=function(){return this.origin.round().corner(this.corner.round())};
Rectangle.prototype.spread=function(){return this.origin.floor().corner(this.corner.ceil()).expandBy(1)};Rectangle.prototype.amountToTranslateWithin=function(a){var b=0,c=0;this.right()>a.right()&&(b=a.right()-this.right());this.bottom()>a.bottom()&&(c=a.bottom()-this.bottom());this.left()+b<a.left()&&(b=a.left()-this.left());this.top()+c<a.top()&&(c=a.top()-this.top());return new Point(b,c)};Rectangle.prototype.containsPoint=function(a){return this.origin.le(a)&&a.lt(this.corner)};
Rectangle.prototype.containsRectangle=function(a){return a.origin.gt(this.origin)&&a.corner.lt(this.corner)};Rectangle.prototype.intersects=function(a){var b=a.origin;a=a.corner;return a.x>=this.origin.x&&a.y>=this.origin.y&&b.x<=this.corner.x&&b.y<=this.corner.y};Rectangle.prototype.isNearTo=function(a,b){var c=a.origin;a=a.corner;b=b||0;return a.x+b>=this.origin.x&&a.y+b>=this.origin.y&&c.x-b<=this.corner.x&&c.y-b<=this.corner.y};
Rectangle.prototype.scaleBy=function(a){var b=this.origin.multiplyBy(a);a=this.corner.multiplyBy(a);return new Rectangle(b.x,b.y,a.x,a.y)};Rectangle.prototype.translateBy=function(a){var b=this.origin.add(a);a=this.corner.add(a);return new Rectangle(b.x,b.y,a.x,a.y)};Rectangle.prototype.asArray=function(){return[this.left(),this.top(),this.right(),this.bottom()]};Rectangle.prototype.asArray_xywh=function(){return[this.left(),this.top(),this.width(),this.height()]};
function Node(a,b){this.init(a||null,b||[])}Node.prototype.init=function(a,b){this.parent=a||null;this.children=b||[]};Node.prototype.toString=function(){return"a Node["+this.children.length.toString()+"]"};Node.prototype.addChild=function(a){this.children.push(a);a.parent=this};Node.prototype.addChildFirst=function(a){this.children.splice(0,null,a);a.parent=this};Node.prototype.removeChild=function(a){a=this.children.indexOf(a);-1!==a&&this.children.splice(a,1)};
Node.prototype.root=function(){return null===this.parent?this:this.parent.root()};Node.prototype.depth=function(){return null===this.parent?0:this.parent.depth()+1};Node.prototype.allChildren=function(){var a=[this];this.children.forEach(function(b){a=a.concat(b.allChildren())});return a};Node.prototype.forAllChildren=function(a){0<this.children.length&&this.children.forEach(function(b){b.forAllChildren(a)});a.call(null,this)};
Node.prototype.anyChild=function(a){var b;if(a.call(null,this))return!0;for(b=0;b<this.children.length;b+=1)if(this.children[b].anyChild(a))return!0;return!1};Node.prototype.allLeafs=function(){var a=[];this.allChildren().forEach(function(b){0===b.children.length&&a.push(b)});return a};Node.prototype.allParents=function(){var a=[this];null!==this.parent&&(a=a.concat(this.parent.allParents()));return a};
Node.prototype.siblings=function(){var a=this;return null===this.parent?[]:this.parent.children.filter(function(b){return b!==a})};Node.prototype.parentThatIsA=function(a){return this instanceof a?this:this.parent?this.parent.parentThatIsA(a):null};Node.prototype.parentThatIsAnyOf=function(a){var b=!1,c=this;a.forEach(function(a){c.constructor===a&&(b=!0)});return b?this:this.parent?this.parent.parentThatIsAnyOf(a):null};Morph.prototype=new Node;Morph.prototype.constructor=Morph;Morph.uber=Node.prototype;
Morph.prototype.trackChanges=!0;Morph.prototype.shadowBlur=4;function Morph(){this.init()}
Morph.prototype.init=function(a){Morph.uber.init.call(this);this.isMorph=!0;this.image=null;this.bounds=new Rectangle(0,0,50,40);this.cachedFullBounds=this.cachedFullImage=null;this.color=new Color(80,80,80);this.cachedTexture=this.texture=null;this.alpha=1;this.isVisible=!0;this.noticesTransparentClick=this.acceptsDrops=this.isTemplate=this.isDraggable=!1;a||this.drawNew();this.fps=0;this.customContextMenu=null;this.lastTime=Date.now();this.onNextStep=null};
Morph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+" "+this.children.length.toString()+" "+this.bounds};Morph.prototype.destroy=function(){null!==this.parent&&(this.fullChanged(),this.parent.removeChild(this))};
Morph.prototype.stepFrame=function(){if(!this.step)return null;var a=Date.now();var b=a-this.lastTime;1>(0<this.fps?1E3/this.fps-b:0)&&(this.lastTime=a,this.onNextStep&&(a=this.onNextStep,this.onNextStep=null,a.call(this)),this.step(),this.children.forEach(function(a){a.stepFrame()}))};Morph.prototype.nextSteps=function(a){var b=a||[],c=b.shift(),d=this;c&&(this.onNextStep=function(){c.call(d);d.nextSteps(b)})};Morph.prototype.step=nop;Morph.prototype.left=function(){return this.bounds.left()};
Morph.prototype.right=function(){return this.bounds.right()};Morph.prototype.top=function(){return this.bounds.top()};Morph.prototype.bottom=function(){return this.bounds.bottom()};Morph.prototype.center=function(){return this.bounds.center()};Morph.prototype.bottomCenter=function(){return this.bounds.bottomCenter()};Morph.prototype.bottomLeft=function(){return this.bounds.bottomLeft()};Morph.prototype.bottomRight=function(){return this.bounds.bottomRight()};Morph.prototype.boundingBox=function(){return this.bounds};
Morph.prototype.corners=function(){return this.bounds.corners()};Morph.prototype.leftCenter=function(){return this.bounds.leftCenter()};Morph.prototype.rightCenter=function(){return this.bounds.rightCenter()};Morph.prototype.topCenter=function(){return this.bounds.topCenter()};Morph.prototype.topLeft=function(){return this.bounds.topLeft()};Morph.prototype.topRight=function(){return this.bounds.topRight()};Morph.prototype.position=function(){return this.bounds.origin};Morph.prototype.extent=function(){return this.bounds.extent()};
Morph.prototype.width=function(){return this.bounds.width()};Morph.prototype.height=function(){return this.bounds.height()};Morph.prototype.fullBounds=function(){var a=this.bounds;this.children.forEach(function(b){b.isVisible&&(a=a.merge(b.fullBounds()))});return a};Morph.prototype.fullBoundsNoShadow=function(){var a=this.bounds;this.children.forEach(function(b){b instanceof ShadowMorph||!b.isVisible||(a=a.merge(b.fullBounds()))});return a};
Morph.prototype.visibleBounds=function(){var a=this.bounds;this.allParents().filter(function(a){return a instanceof FrameMorph}).forEach(function(b){a=a.intersect(b.bounds)});return a};Morph.prototype.moveBy=function(a){this.fullChanged();this.silentMoveBy(a);this.fullChanged()};Morph.prototype.silentMoveBy=function(a){var b=this.children,c=b.length;this.bounds=this.bounds.translateBy(a);this.cachedFullBounds&&(this.cachedFullBounds=this.cachedFullBounds.translateBy(a));for(c;0<c;--c)b[c-1].silentMoveBy(a)};
Morph.prototype.setPosition=function(a){a=a.subtract(this.topLeft());0===a.x&&0===a.y||this.moveBy(a)};Morph.prototype.silentSetPosition=function(a){a=a.subtract(this.topLeft());0===a.x&&0===a.y||this.silentMoveBy(a)};Morph.prototype.setLeft=function(a){this.setPosition(new Point(a,this.top()))};Morph.prototype.setRight=function(a){this.setPosition(new Point(a-this.width(),this.top()))};Morph.prototype.setTop=function(a){this.setPosition(new Point(this.left(),a))};
Morph.prototype.setBottom=function(a){this.setPosition(new Point(this.left(),a-this.height()))};Morph.prototype.setCenter=function(a){this.setPosition(a.subtract(this.extent().floorDivideBy(2)))};Morph.prototype.setFullCenter=function(a){this.setPosition(a.subtract(this.fullBounds().extent().floorDivideBy(2)))};
Morph.prototype.keepWithin=function(a){var b=this.fullBounds().left()-a.left();0>b&&this.moveBy(new Point(-b,0));b=this.fullBounds().right()-a.right();0<b&&this.moveBy(new Point(-b,0));b=this.fullBounds().top()-a.top();0>b&&this.moveBy(new Point(0,-b));a=this.fullBounds().bottom()-a.bottom();0<a&&this.moveBy(new Point(0,-a))};
Morph.prototype.scrollIntoView=function(){var a=this.parentThatIsA(ScrollFrameMorph);if(a){var b=Math.min(this.fullBounds().right()-a.right(),a.contents.right()-a.right());0<b&&a.contents.moveBy(new Point(-b,0));b=this.fullBounds().left()-a.left();0>b&&a.contents.moveBy(new Point(-b,0));b=this.fullBounds().top()-a.top();0>b&&a.contents.moveBy(new Point(0,-b));b=this.fullBounds().bottom()-a.bottom();0<b&&a.contents.moveBy(new Point(0,-b));a.adjustScrollBars()}};
Morph.prototype.setExtent=function(a,b){b?this.silentSetExtent(a):a.eq(this.extent())||(this.changed(),this.silentSetExtent(a),this.changed(),this.drawNew())};Morph.prototype.silentSetExtent=function(a){a=a.round();this.bounds.corner=new Point(this.bounds.origin.x+Math.max(a.x,0),this.bounds.origin.y+Math.max(a.y,0))};Morph.prototype.setWidth=function(a){this.setExtent(new Point(a||0,this.height()))};
Morph.prototype.silentSetWidth=function(a){this.bounds.corner=new Point(this.bounds.origin.x+Math.max(Math.round(a||0),0),this.bounds.corner.y)};Morph.prototype.setHeight=function(a){this.setExtent(new Point(this.width(),a||0))};Morph.prototype.silentSetHeight=function(a){this.bounds.corner=new Point(this.bounds.corner.x,this.bounds.origin.y+Math.max(Math.round(a||0),0))};Morph.prototype.setColor=function(a){a&&!this.color.eq(a)&&(this.color=a,this.changed(),this.drawNew())};
Morph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.color.toString();a.beginPath();a.moveTo(0,0);a.lineTo(this.image.width,0);a.lineTo(this.image.width,this.image.height);a.lineTo(0,this.image.height+1E-4);a.closePath();a.fill();this.cachedTexture?this.drawCachedTexture():this.texture&&this.drawTexture(this.texture)};
Morph.prototype.drawTexture=function(a){var b=this;this.cachedTexture=new Image;this.cachedTexture.onload=function(){b.drawCachedTexture()};this.cachedTexture.src=this.texture=a};Morph.prototype.drawCachedTexture=function(){var a=this.cachedTexture,b=Math.floor(this.image.width/a.width),c=Math.floor(this.image.height/a.height),d,e,f=this.image.getContext("2d");for(e=0;e<=c;e+=1)for(d=0;d<=b;d+=1)f.drawImage(a,d*a.width,e*a.height);this.changed()};
Morph.prototype.drawOn=function(a,b){var c=this.cachedFullImage||this.image;var d=this.cachedFullBounds||this.bounds;if(!this.isVisible)return null;b=(b||d).intersect(d);if(b.extent().gt(new Point(0,0))){d=d.position().neg();d=b.copy().translateBy(d);a=a.getContext("2d");a.globalAlpha=this.alpha;var e=d.left();var f=d.top();var g=Math.min(d.width(),c.width-e);d=Math.min(d.height(),c.height-f);if(1>g||1>d)return null;a.drawImage(c,e,f,g,d,b.left(),b.top(),g,d)}};
Morph.prototype.fullDrawOn=function(a,b){if(!this.isVisible)return null;var c=b||this.cachedFullBounds||this.fullBounds();this.drawOn(a,c);this.cachedFullImage||this.children.forEach(function(b){b.fullDrawOn(a,c)})};Morph.prototype.hide=function(){this.isVisible=!1;this.changed();this.children.forEach(function(a){a.hide()})};Morph.prototype.show=function(){this.isVisible=!0;this.changed();this.children.forEach(function(a){a.show()})};
Morph.prototype.toggleVisibility=function(){this.isVisible=!this.isVisible;this.changed();this.children.forEach(function(a){a.toggleVisibility()})};Morph.prototype.fullImageClassic=function(){var a=this.cachedFullBounds||this.fullBounds(),b=newCanvas(a.extent());b.getContext("2d").translate(-a.origin.x,-a.origin.y);this.fullDrawOn(b,a);b.globalAlpha=this.alpha;return b};
Morph.prototype.fullImage=function(){var a=newCanvas(this.fullBounds().extent());var b=a.getContext("2d");var c=this.fullBounds();this.allChildren().forEach(function(a){a.isVisible&&(b.globalAlpha=a.alpha,a.image.width&&a.image.height&&b.drawImage(a.image,a.bounds.origin.x-c.origin.x,a.bounds.origin.y-c.origin.y))});return a};
Morph.prototype.shadowImage=function(a,b){var c=a||new Point(7,7);var d=b||new Color(0,0,0);b=this.fullBounds().extent();var e=this.fullImage();a=newCanvas(b);var f=a.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="destination-out";f.drawImage(e,-c.x,-c.y);c=newCanvas(b);f=c.getContext("2d");f.drawImage(a,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=d.toString();f.fillRect(0,0,b.x,b.y);return c};
Morph.prototype.shadowImageBlurred=function(a,b){a=a||new Point(7,7);var c=this.shadowBlur,d=b||new Color(0,0,0);var e=this.fullBounds().extent().add(2*c);b=this.fullImage();e=newCanvas(e);var f=e.getContext("2d");f.shadowOffsetX=a.x;f.shadowOffsetY=a.y;f.shadowBlur=c;f.shadowColor=d.toString();f.drawImage(b,c-a.x,c-a.y);f.shadowOffsetX=0;f.shadowOffsetY=0;f.shadowBlur=0;f.globalCompositeOperation="destination-out";f.drawImage(b,c-a.x,c-a.y);return e};
Morph.prototype.shadow=function(a,b,c){var d=new ShadowMorph;a=a||new Point(7,7);b=b||(0===b?0:.2);var e=this.fullBounds();d.setExtent(e.extent().add(2*this.shadowBlur));useBlurredShadows&&!MorphicPreferences.isFlat?(d.image=this.shadowImageBlurred(a,c),d.alpha=b,d.setPosition(e.origin.add(a).subtract(this.shadowBlur))):(d.image=this.shadowImage(a,c),d.alpha=b,d.setPosition(e.origin.add(a)));return d};
Morph.prototype.addShadow=function(a,b,c){a=a||new Point(7,7);b=this.shadow(a,b||(0===b?0:.2),c);this.addBack(b);this.fullChanged();return b};Morph.prototype.getShadow=function(){var a=this.children.slice(0).reverse().filter(function(a){return a instanceof ShadowMorph});return 0!==a.length?a[0]:null};Morph.prototype.removeShadow=function(){var a=this.getShadow();null!==a&&(this.fullChanged(),this.removeChild(a))};Morph.prototype.penTrails=function(){return this.image};
Morph.prototype.changed=function(){if(this.trackChanges){var a=this.root();a instanceof WorldMorph&&a.broken.push(this.visibleBounds().spread())}this.parent&&this.parent.childChanged(this)};Morph.prototype.fullChanged=function(){if(this.trackChanges){var a=this.root();a instanceof WorldMorph&&a.broken.push((this.cachedFullBounds||this.fullBounds()).spread())}};Morph.prototype.childChanged=function(){this.parent&&this.parent.childChanged(this)};
Morph.prototype.world=function(){var a=this.root();return a instanceof WorldMorph?a:a instanceof HandMorph?a.world:null};Morph.prototype.add=function(a){var b=a.parent;null!==b&&b.removeChild(a);this.addChild(a)};Morph.prototype.addBack=function(a){var b=a.parent;null!==b&&b.removeChild(a);this.addChildFirst(a)};
Morph.prototype.topMorphAt=function(a){var b,c;if(!this.isVisible)return null;for(b=this.children.length-1;0<=b;--b)if(c=this.children[b].topMorphAt(a))return c;return!this.bounds.containsPoint(a)||!this.noticesTransparentClick&&this.isTransparentAt(a)?null:this};Morph.prototype.topMorphSuchThat=function(a){var b;return a.call(null,this)?(b=detect(this.children.slice(0).reverse(),a))?b.topMorphSuchThat(a):this:null};
Morph.prototype.overlappedMorphs=function(){var a=this.world(),b=this.fullBounds(),c=this,d=this.allParents(),e=this.allChildren();return a.allChildren().filter(function(f){return f.isVisible&&f!==c&&f!==a&&!contains(d,f)&&!contains(e,f)&&f.fullBounds().intersects(b)})};Morph.prototype.getPixelColor=function(a){a=a.subtract(this.bounds.origin);a=this.image.getContext("2d").getImageData(a.x,a.y,1,1);return new Color(a.data[0],a.data[1],a.data[2],a.data[3]/255)};
Morph.prototype.isTransparentAt=function(a){if(this.bounds.containsPoint(a)){if(this.texture)return!1;a=a.subtract(this.bounds.origin);var b=this.image.getContext("2d");a=b.getImageData(Math.floor(a.x),Math.floor(a.y),1,1);return 0===a.data[3]}return!1};Morph.prototype.copy=function(){var a=copy(this);a.parent=null;a.children=[];a.bounds=this.bounds.copy();return a};
Morph.prototype.fullCopy=function(){var a=new Map;var b=this.copyRecordingReferences(a);b.forAllChildren(function(b){b.updateReferences(a)});return b};Morph.prototype.copyRecordingReferences=function(a){var b=this.copy();a.set(this,b);this.children.forEach(function(c){b.add(c.copyRecordingReferences(a))});return b};Morph.prototype.updateReferences=function(a){var b=Object.keys(this),c=b.length,d,e;for(e=0;e<c;e+=1){var f=b[e];(d=this[f])&&d.isMorph&&(d=a.get(d))&&(this[f]=d)}};
Morph.prototype.rootForGrab=function(){return this instanceof ShadowMorph?this.parent.rootForGrab():this.parent instanceof ScrollFrameMorph?this.parent:null===this.parent||this.parent instanceof WorldMorph||this.parent instanceof FrameMorph||!0===this.isDraggable?this:this.parent.rootForGrab()};Morph.prototype.isCorrectingOutsideDrag=function(){return!0};Morph.prototype.wantsDropOf=function(a){return a instanceof HandleMorph||a instanceof MenuMorph||a instanceof InspectorMorph?!1:this.acceptsDrops};
Morph.prototype.pickUp=function(a){a=a||this.world();this.setPosition(a.hand.position().subtract(this.extent().floorDivideBy(2)));a.hand.grab(this)};Morph.prototype.isPickedUp=function(){return null!==this.parentThatIsA(HandMorph)};Morph.prototype.situation=function(){return this.parent?{origin:this.parent,position:this.position().subtract(this.parent.position())}:null};
Morph.prototype.slideBackTo=function(a,b,c,d){var e=a.origin.position().add(a.position),f=this;this.glideTo(e,b,null,function(){a.origin.add(f);c&&c();f.justDropped&&f.justDropped();a.origin.reactToDropOf&&a.origin.reactToDropOf(f);d&&d()})};
Morph.prototype.glideTo=function(a,b,c,d){var e=this.world(),f=this;e.animations.push(new Animation(function(a){f.setLeft(a)},function(){return f.left()},-(this.left()-a.x),b||100,c,d));e.animations.push(new Animation(function(a){f.setTop(a)},function(){return f.top()},-(this.top()-a.y),b||100,c))};
Morph.prototype.fadeTo=function(a,b,c,d){var e=this.world(),f=this,g=this.alpha;this.children.forEach(function(d){d.fadeTo(a,b,c)});e.animations.push(new Animation(function(a){f.alpha=a;f.changed()},function(){return f.alpha},a-this.alpha,b||200,c,function(){f.alpha=g;d&&d()}))};Morph.prototype.perish=function(a,b){var c=this;this.fadeTo(0,a||100,null,function(){c.destroy();b&&b()})};Morph.prototype.nop=nop;Morph.prototype.resize=function(){this.world().activeHandle=new HandleMorph(this)};
Morph.prototype.move=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"move")};Morph.prototype.moveCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"moveCenter")};Morph.prototype.hint=function(a){var b;(b=a)?a.toString&&(b=a.toString()):b="NULL";a=new MenuMorph(this,b);a.isDraggable=!0;a.popUpCenteredAtHand(this.world())};
Morph.prototype.inform=function(a){var b;(b=a)?a.toString&&(b=a.toString()):b="NULL";a=new MenuMorph(this,b);a.addItem("Ok");a.isDraggable=!0;a.popUpCenteredAtHand(this.world())};
Morph.prototype.prompt=function(a,b,c,d,e,f,g,h){var k;g&&(k=!0);a=new MenuMorph(b||null,a||"",c||null);var l=new StringFieldMorph(d||"",e||100,MorphicPreferences.prompterFontSize,MorphicPreferences.prompterFontName,!1,!1,k);a.items.push(l);if(g||MorphicPreferences.useSliderForInput)d=new SliderMorph(f||0,g,parseFloat(d),Math.floor((g-f)/4),"horizontal"),d.alpha=1,d.color=new Color(225,225,225),d.button.color=a.borderColor,d.button.highlightColor=d.button.color.copy(),d.button.highlightColor.b+=100,
d.button.pressColor=d.button.color.copy(),d.button.pressColor.b+=150,d.setHeight(MorphicPreferences.prompterSliderSize),d.action=h?function(a){l.changed();l.text.text=Math.round(a).toString();l.text.drawNew();l.text.changed();l.text.edit()}:function(a){l.changed();l.text.text=a.toString();l.text.drawNew();l.text.changed()},a.items.push(d);a.addLine(2);a.addItem("Ok",function(){return l.string()});a.addItem("Cancel",function(){return null});a.isDraggable=!0;a.popUpAtHand(this.world());l.text.edit()};
Morph.prototype.pickColor=function(a,b,c,d){a=new MenuMorph(b||null,a||"",c||null);var e=new ColorPickerMorph(d);a.items.push(e);a.addLine(2);a.addItem("Ok",function(){return e.getChoice()});a.addItem("Cancel",function(){return null});a.isDraggable=!0;a.popUpAtHand(this.world())};Morph.prototype.inspect=function(a){var b=this.world instanceof Function?this.world():this.root()||this.world,c=this;a&&(c=a);a=new InspectorMorph(c);a.setPosition(b.hand.position());a.keepWithin(b);b.add(a);a.changed()};
Morph.prototype.contextMenu=function(){var a;return this.customContextMenu?this.customContextMenu:(a=this.world instanceof Function?this.world():this.world)&&a.isDevMode?this.parent===a?this.developersMenu():this.hierarchyMenu():this.userMenu()||this.parent&&this.parent.userMenu()};
Morph.prototype.hierarchyMenu=function(){var a=this.allParents(),b=this.world instanceof Function?this.world():this.world,c=new MenuMorph(this,null);a.forEach(function(a){a.developersMenu&&a!==b&&c.addMenu(a.toString().slice(0,50),a.developersMenu())});return c};
Morph.prototype.developersMenu=function(){var a=this.world instanceof Function?this.world():this.world,b=this.userMenu()||this.parent&&this.parent.userMenu(),c=new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]);b&&(c.addMenu("user features",b),c.addLine());c.addItem("color...",function(){this.pickColor(c.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose another color \nfor this morph");c.addItem("transparency...",function(){this.prompt(c.title+
localize("\nalpha\nvalue:"),this.setAlphaScaled,this,(100*this.alpha).toString(),null,1,100,!0)},"set this morph's\nalpha value");c.addItem("resize...","resize","show a handle\nwhich can be dragged\nto change this morph's extent");c.addLine();c.addItem("duplicate",function(){this.fullCopy().pickUp(this.world())},"make a copy\nand pick it up");c.addItem("pick up","pickUp","detach and put \ninto the hand");c.addItem("attach...","attach","stick this morph\nto another one");c.addItem("move...","move",
"show a handle\nwhich can be dragged\nto move this morph");c.addItem("inspect...","inspect","open a window\non all properties");c.addItem("pic...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph");c.addLine();this.isDraggable?c.addItem("lock","toggleIsDraggable","make this morph\nunmovable"):c.addItem("unlock","toggleIsDraggable","make this morph\nmovable");c.addItem("hide","hide");c.addItem("delete","destroy");this instanceof WorldMorph||
(c.addLine(),c.addItem("World...",function(){a.contextMenu().popUpAtHand(a)},"show the\nWorld's menu"));return c};Morph.prototype.userMenu=function(){return null};Morph.prototype.setAlphaScaled=function(a){"number"===typeof a?this.alpha=Math.min(Math.max(a/100,.1),1):(a=parseFloat(a),isNaN(a)||(this.alpha=Math.min(Math.max(a/100,.1),1)));this.changed()};
Morph.prototype.attach=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose new parent:"),c=this;a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){a.add(c);c.isDraggable=!1})});0<a.length&&b.popUpAtHand(this.world())};Morph.prototype.toggleIsDraggable=function(){this.isDraggable=!this.isDraggable};Morph.prototype.colorSetters=function(){return["color"]};Morph.prototype.numericalSetters=function(){return["setLeft","setTop","setWidth","setHeight","setAlphaScaled"]};
Morph.prototype.allEntryFields=function(){return this.allChildren().filter(function(a){return a.isEditable&&(a instanceof StringMorph||a instanceof TextMorph)})};Morph.prototype.nextEntryField=function(a){var b=this.allEntryFields();a=b.indexOf(a);return-1!==a&&b.length>a+1?b[a+1]:b[0]};Morph.prototype.previousEntryField=function(a){var b=this.allEntryFields();a=b.indexOf(a);return-1!==a?0<a?b[a-1]:b[b.length-1]:b[0]};Morph.prototype.tab=function(a){this.nextTab?this.nextTab(a):this.parent&&this.parent.tab(a)};
Morph.prototype.backTab=function(a){this.previousTab?this.previousTab(a):this.parent&&this.parent.backTab(a)};Morph.prototype.escalateEvent=function(a,b){for(var c=this.parent;!c[a]&&null!==c.parent;)c=c.parent;if(c[a])c[a](b)};Morph.prototype.evaluateString=function(a){try{var b=eval(a);this.drawNew();this.changed()}catch(c){this.inform(c)}return b};
Morph.prototype.isTouching=function(a){a=this.overlappingImage(a);if(!a.width||!a.height)return!1;a=a.getContext("2d").getImageData(1,1,a.width,a.height).data;return null!==detect(a,function(a){return 0!==a})};
Morph.prototype.overlappingImage=function(a){var b=this.fullBounds(),c=a.fullBounds(),d=b.intersect(c),e=newCanvas(d.extent()),f=e.getContext("2d");if(1>d.width()||1>d.height())return newCanvas(new Point(1,1));f.drawImage(this.fullImage(),d.origin.x-b.origin.x,d.origin.y-b.origin.y);f.globalCompositeOperation="source-in";f.drawImage(a.fullImage(),c.origin.x-d.origin.x,c.origin.y-d.origin.y);return e};ShadowMorph.prototype=new Morph;ShadowMorph.prototype.constructor=ShadowMorph;ShadowMorph.uber=Morph.prototype;
function ShadowMorph(){this.init()}ShadowMorph.prototype.topMorphAt=function(){return null};HandleMorph.prototype=new Morph;HandleMorph.prototype.constructor=HandleMorph;HandleMorph.uber=Morph.prototype;function HandleMorph(a,b,c,d,e,f){this.init(a,b,c,d,e,f)}
HandleMorph.prototype.init=function(a,b,c,d,e,f){var g=MorphicPreferences.handleSize;this.target=a||null;this.minExtent=new Point(b||0,c||0);this.inset=new Point(d||0,e||d||0);this.type=f||"resize";HandleMorph.uber.init.call(this);this.color=new Color(255,255,255);this.isDraggable=!1;this.noticesTransparentClick=!0;"movePivot"===this.type&&(g*=2);this.setExtent(new Point(g,g))};
HandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent());this.highlightImage=newCanvas(this.extent());"movePivot"===this.type?(this.drawCrosshairsOnCanvas(this.normalImage,.6),this.drawCrosshairsOnCanvas(this.highlightImage,.5)):(this.drawOnCanvas(this.normalImage,this.color,new Color(100,100,100)),this.drawOnCanvas(this.highlightImage,new Color(100,100,255),new Color(255,255,255)));this.image=this.normalImage;this.target&&("moveCenter"===this.type?this.setCenter(this.target.center()):
"movePivot"===this.type?this.setCenter(this.target.rotationCenter()):this.setPosition(this.target.bottomRight().subtract(this.extent().add(this.inset))),this.target.add(this),this.target.changed())};
HandleMorph.prototype.drawCrosshairsOnCanvas=function(a,b){var c=a.getContext("2d"),d=a.width/2;c.fillStyle="rgba(255, 255, 255, 0.5)";c.arc(d,d,.9*d,radians(0),radians(360),!1);c.fill();c.strokeStyle="black";c.lineWidth=1;c.beginPath();c.arc(d,d,d*b,radians(0),radians(360),!1);c.stroke();c.moveTo(0,d);c.lineTo(a.width,d);c.stroke();c.moveTo(d,0);c.lineTo(d,a.height);c.stroke()};
HandleMorph.prototype.drawOnCanvas=function(a,b,c){a=a.getContext("2d");var d=0===this.type.indexOf("move"),e;a.lineWidth=1;a.lineCap="round";a.strokeStyle=b.toString();if(d){b=this.bottomLeft().subtract(this.position());var f=b.copy();var g=this.topRight().subtract(this.position());var h=g.copy();for(e=0;e<=this.height();e+=6)f.y=b.y-e,h.y=g.y-e,a.beginPath(),a.moveTo(f.x,f.y),a.lineTo(h.x,h.y),a.closePath(),a.stroke()}b=this.bottomLeft().subtract(this.position());f=b.copy();g=this.topRight().subtract(this.position());
h=g.copy();for(e=0;e<=this.width();e+=6)f.x=b.x+e,h.x=g.x+e,a.beginPath(),a.moveTo(f.x,f.y),a.lineTo(h.x,h.y),a.closePath(),a.stroke();a.strokeStyle=c.toString();if(d)for(b=this.bottomLeft().subtract(this.position()),f=b.copy(),g=this.topRight().subtract(this.position()),h=g.copy(),e=-2;e<=this.height();e+=6)f.y=b.y-e,h.y=g.y-e,a.beginPath(),a.moveTo(f.x,f.y),a.lineTo(h.x,h.y),a.closePath(),a.stroke();b=this.bottomLeft().subtract(this.position());f=b.copy();g=this.topRight().subtract(this.position());
h=g.copy();for(e=2;e<=this.width();e+=6)f.x=b.x+e,h.x=g.x+e,a.beginPath(),a.moveTo(f.x,f.y),a.lineTo(h.x,h.y),a.closePath(),a.stroke()};HandleMorph.prototype.step=null;
HandleMorph.prototype.mouseDownLeft=function(a){var b=this.root(),c=this;if(!this.target)return null;var d=0===this.type.indexOf("move")?a.subtract(this.center()):a.subtract(this.bounds.origin);this.step=function(){if(b.hand.mouseButton){var a=b.hand.bounds.origin.copy().subtract(d);"resize"===this.type?(a=a.add(c.extent().add(c.inset)).subtract(c.target.bounds.origin),a=a.max(c.minExtent),c.target.setExtent(a),c.setPosition(c.target.bottomRight().subtract(c.extent().add(c.inset)))):"moveCenter"===
this.type?c.target.setCenter(a):"movePivot"===this.type?(c.target.setPivot(a),c.setCenter(this.target.rotationCenter())):c.target.setPosition(a.subtract(this.target.extent()).add(this.extent()))}else this.step=null};this.target.step||(this.target.step=function(){nop()})};HandleMorph.prototype.rootForGrab=function(){return this};HandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage;this.changed()};HandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage;this.changed()};
HandleMorph.prototype.attach=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose target:"),c=this;a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){c.isDraggable=!1;c.target=a;c.drawNew();c.noticesTransparentClick=!0})});0<a.length&&b.popUpAtHand(this.world())};PenMorph.prototype=new Morph;PenMorph.prototype.constructor=PenMorph;PenMorph.uber=Morph.prototype;function PenMorph(){this.init()}
PenMorph.prototype.init=function(){var a=4*MorphicPreferences.handleSize;this.isWarped=!1;this.heading=0;this.isDown=!0;this.size=1;this.wantsRedraw=!1;this.penPoint="tip";this.penBounds=null;HandleMorph.uber.init.call(this);this.setExtent(new Point(a,a))};PenMorph.prototype.changed=function(){if(!1===this.isWarped){var a=this.root();a instanceof WorldMorph&&a.broken.push(this.visibleBounds().spread());this.parent&&this.parent.childChanged(this)}};
PenMorph.prototype.drawNew=function(a){var b=a||this.heading;if(this.isWarped)this.wantsRedraw=!0;else{this.image=newCanvas(this.extent());a=this.image.getContext("2d");var c=this.width()/2;var d=this.center().subtract(this.bounds.origin);if("tip"===this.penPoint){var e=d.distanceAngle(.75*c,b-180);var f=d.distanceAngle(c,b+195);c=d.distanceAngle(c,b-195)}else e=d.distanceAngle(.75*c,b),f=d.distanceAngle(.33*c,b+230),c=d.distanceAngle(.33*c,b-230);this.penBounds=new Rectangle(Math.min(d.x,e.x,f.x,
c.x),Math.min(d.y,e.y,f.y,c.y),Math.max(d.x,e.x,f.x,c.x),Math.max(d.y,e.y,f.y,c.y));a.fillStyle=this.color.toString();a.beginPath();a.moveTo(d.x,d.y);a.lineTo(f.x,f.y);a.lineTo(e.x,e.y);a.lineTo(c.x,c.y);a.closePath();a.strokeStyle="white";a.lineWidth=3;a.stroke();a.strokeStyle="black";a.lineWidth=1;a.stroke();a.fill()}};PenMorph.prototype.setHeading=function(a){this.heading=(+a%360+360)%360;this.drawNew();this.changed()};
PenMorph.prototype.drawLine=function(a,b){var c=this.parent.penTrails().getContext("2d"),d=a.subtract(this.parent.bounds.origin),e=b.subtract(this.parent.bounds.origin);this.isDown&&(c.lineWidth=this.size,c.strokeStyle=this.color.toString(),c.lineCap="round",c.lineJoin="round",c.beginPath(),c.moveTo(d.x,d.y),c.lineTo(e.x,e.y),c.stroke(),!1===this.isWarped&&this.world().broken.push(a.rectangle(b).expandBy(Math.max(this.size/2,1)).intersect(this.parent.visibleBounds()).spread()))};
PenMorph.prototype.turn=function(a){this.setHeading(this.heading+parseFloat(a))};PenMorph.prototype.forward=function(a){var b=this.center();a=parseFloat(a);a=0<=a?this.position().distanceAngle(a,this.heading):this.position().distanceAngle(Math.abs(a),this.heading-180);this.setPosition(a);this.drawLine(b,this.center())};PenMorph.prototype.down=function(){this.isDown=!0};PenMorph.prototype.up=function(){this.isDown=!1};PenMorph.prototype.clear=function(){this.parent.drawNew();this.parent.changed()};
PenMorph.prototype.startWarp=function(){this.wantsRedraw=!1;this.isWarped=!0};PenMorph.prototype.endWarp=function(){this.isWarped=!1;this.wantsRedraw&&(this.drawNew(),this.wantsRedraw=!1);this.parent.changed()};PenMorph.prototype.warp=function(a){this.startWarp();a.call(this);this.endWarp()};PenMorph.prototype.warpOp=function(a,b){this.startWarp();this[a].apply(this,b);this.endWarp()};PenMorph.prototype.warpSierpinski=function(a,b){this.warpOp("sierpinski",[a,b])};
PenMorph.prototype.sierpinski=function(a,b){var c;if(a>b)for(c=0;3>c;c+=1)this.sierpinski(.5*a,b),this.turn(120),this.forward(a)};PenMorph.prototype.warpTree=function(a,b,c){this.warpOp("tree",[a,b,c])};PenMorph.prototype.tree=function(a,b,c){0<a&&(this.size=a,this.forward(b),this.turn(c),this.tree(a-1,.75*b,c),this.turn(-2*c),this.tree(a-1,.75*b,c),this.turn(c),this.forward(-b))};ColorPaletteMorph.prototype=new Morph;ColorPaletteMorph.prototype.constructor=ColorPaletteMorph;
ColorPaletteMorph.uber=Morph.prototype;function ColorPaletteMorph(a,b){this.init(a||null,b||new Point(80,50))}ColorPaletteMorph.prototype.init=function(a,b){ColorPaletteMorph.uber.init.call(this);this.target=a;this.targetSetter="color";this.silentSetExtent(b);this.choice=null;this.drawNew()};
ColorPaletteMorph.prototype.drawNew=function(){var a,b;var c=this.extent();this.image=newCanvas(this.extent());var d=this.image.getContext("2d");this.choice=new Color;for(a=0;a<=c.x;a+=1){var e=360*a/c.x;for(b=0;b<=c.y;b+=1){var f=100-b/c.y*100;d.fillStyle="hsl("+e+",100%,"+f+"%)";d.fillRect(a,b,1,1)}}};ColorPaletteMorph.prototype.mouseMove=function(a){this.choice=this.getPixelColor(a);this.updateTarget()};ColorPaletteMorph.prototype.mouseDownLeft=function(a){this.choice=this.getPixelColor(a);this.updateTarget()};
ColorPaletteMorph.prototype.updateTarget=function(){if(this.target instanceof Morph&&null!==this.choice)if(this.target[this.targetSetter]instanceof Function)this.target[this.targetSetter](this.choice);else this.target[this.targetSetter]=this.choice,this.target.drawNew(),this.target.changed()};
ColorPaletteMorph.prototype.developersMenu=function(){var a=ColorPaletteMorph.uber.developersMenu.call(this);a.addLine();a.addItem("set target","setTarget","choose another morph\nwhose color property\n will be controlled by this one");return a};
ColorPaletteMorph.prototype.setTarget=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose target:"),c=this;a.push(this.world());a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){c.target=a;c.setTargetSetter()})});1===a.length?(this.target=a[0],this.setTargetSetter()):0<a.length&&b.popUpAtHand(this.world())};
ColorPaletteMorph.prototype.setTargetSetter=function(){var a=this.target.colorSetters(),b=new MenuMorph(this,"choose target property:"),c=this;a.forEach(function(a){b.addItem(a,function(){c.targetSetter=a})});1===a.length?this.targetSetter=a[0]:0<a.length&&b.popUpAtHand(this.world())};GrayPaletteMorph.prototype=new ColorPaletteMorph;GrayPaletteMorph.prototype.constructor=GrayPaletteMorph;GrayPaletteMorph.uber=ColorPaletteMorph.prototype;
function GrayPaletteMorph(a,b){this.init(a||null,b||new Point(80,10))}GrayPaletteMorph.prototype.drawNew=function(){var a=this.extent();this.image=newCanvas(this.extent());var b=this.image.getContext("2d");this.choice=new Color;var c=b.createLinearGradient(0,0,a.x,a.y);c.addColorStop(0,"black");c.addColorStop(1,"white");b.fillStyle=c;b.fillRect(0,0,a.x,a.y)};ColorPickerMorph.prototype=new Morph;ColorPickerMorph.prototype.constructor=ColorPickerMorph;ColorPickerMorph.uber=Morph.prototype;
function ColorPickerMorph(a){this.init(a||new Color(255,255,255))}ColorPickerMorph.prototype.init=function(a){this.choice=a;ColorPickerMorph.uber.init.call(this);this.color=new Color(255,255,255);this.silentSetExtent(new Point(80,80));this.drawNew()};ColorPickerMorph.prototype.drawNew=function(){ColorPickerMorph.uber.drawNew.call(this);this.buildSubmorphs()};
ColorPickerMorph.prototype.buildSubmorphs=function(){this.children.forEach(function(a){a.destroy()});this.children=[];this.feedback=new Morph;this.feedback.color=this.choice;this.feedback.setExtent(new Point(20,20));var a=new ColorPaletteMorph(this.feedback,new Point(this.width(),50));var b=new GrayPaletteMorph(this.feedback,new Point(this.width(),5));a.setPosition(this.bounds.origin);this.add(a);b.setPosition(a.bottomLeft());this.add(b);a=b.left()+Math.floor((b.width()-this.feedback.width())/2);
b=b.bottom()+Math.floor((this.bottom()-b.bottom()-this.feedback.height())/2);this.feedback.setPosition(new Point(a,b));this.add(this.feedback)};ColorPickerMorph.prototype.getChoice=function(){return this.feedback.color};ColorPickerMorph.prototype.rootForGrab=function(){return this};BlinkerMorph.prototype=new Morph;BlinkerMorph.prototype.constructor=BlinkerMorph;BlinkerMorph.uber=Morph.prototype;function BlinkerMorph(a){this.init(a)}
BlinkerMorph.prototype.init=function(a){BlinkerMorph.uber.init.call(this);this.color=new Color(0,0,0);this.fps=a||2;this.drawNew()};BlinkerMorph.prototype.step=function(){this.toggleVisibility()};CursorMorph.prototype=new BlinkerMorph;CursorMorph.prototype.constructor=CursorMorph;CursorMorph.uber=BlinkerMorph.prototype;CursorMorph.prototype.viewPadding=1;function CursorMorph(a){this.init(a)}
CursorMorph.prototype.init=function(a){this.keyDownEventUsed=!1;this.target=a;this.originalContents=this.target.text;this.originalAlignment=this.target.alignment;this.slot=this.target.text.length;CursorMorph.uber.init.call(this);a=fontHeight(this.target.fontSize);this.setExtent(new Point(Math.max(Math.floor(a/20),1),a));this.drawNew();this.image.getContext("2d").font=this.target.font();this.target instanceof TextMorph&&"left"!==this.target.alignment&&this.target.setAlignmentToLeft();this.gotoSlot(this.slot);
this.initializeClipboardHandler()};
CursorMorph.prototype.initializeClipboardHandler=function(){var a=this,b=this.target.world();this.clipboardHandler=document.createElement("textarea");this.clipboardHandler.style.position="absolute";this.clipboardHandler.style.top=window.outerHeight;this.clipboardHandler.style.right="101%";document.body.appendChild(this.clipboardHandler);this.clipboardHandler.value=this.target.selection();this.clipboardHandler.focus();this.clipboardHandler.select();this.clipboardHandler.addEventListener("keypress",function(b){a.processKeyPress(b);
this.value=a.target.selection();this.select()},!1);this.clipboardHandler.addEventListener("keydown",function(c){a.processKeyDown(c);c.shiftKey&&(b.currentKey=16);this.value=a.target.selection();this.select();if("U+0009"===c.key||"Tab"===c.key)a.processKeyPress(c),c.preventDefault()},!1);this.clipboardHandler.addEventListener("keyup",function(a){b.currentKey=null},!1);this.clipboardHandler.addEventListener("input",function(b){""===this.value&&(a.gotoSlot(a.target.selectionStartSlot()),a.target.deleteSelection())},
!1)};
CursorMorph.prototype.processKeyPress=function(a){if(this.keyDownEventUsed)return this.keyDownEventUsed=!1,null;if(40===a.keyCode||40===a.charCode)return this.insert("("),null;if(37===a.keyCode||37===a.charCode)return this.insert("%"),null;a.keyCode?a.ctrlKey&&!a.altKey?this.ctrl(a.keyCode,a.shiftKey):a.metaKey?this.cmd(a.keyCode,a.shiftKey):this.insert(String.fromCharCode(a.keyCode),a.shiftKey):a.charCode&&(a.ctrlKey&&!a.altKey?this.ctrl(a.charCode,a.shiftKey):a.metaKey?this.cmd(a.charCode,a.shiftKey):
this.insert(String.fromCharCode(a.charCode),a.shiftKey));this.target.escalateEvent("reactToKeystroke",a)};
CursorMorph.prototype.processKeyDown=function(a){var b=a.shiftKey,c=a.ctrlKey||a.altKey,d=0<this.target.selection().length;this.keyDownEventUsed=!1;a.ctrlKey&&!a.altKey&&(this.ctrl(a.keyCode,a.shiftKey),this.target.escalateEvent("reactToKeystroke",a));a.metaKey&&(this.cmd(a.keyCode,a.shiftKey),this.target.escalateEvent("reactToKeystroke",a));switch(a.keyCode){case 37:!d||b||c?this.goLeft(b,c?this.slot-this.target.previousWordFrom(this.slot):1):(this.gotoSlot(Math.min(this.target.startMark,this.target.endMark)),
this.target.clearSelection());this.keyDownEventUsed=!0;break;case 39:!d||b||c?this.goRight(b,c?this.target.nextWordFrom(this.slot)-this.slot:1):(this.gotoSlot(Math.max(this.target.startMark,this.target.endMark)),this.target.clearSelection());this.keyDownEventUsed=!0;break;case 38:this.goUp(b);this.keyDownEventUsed=!0;break;case 40:this.goDown(b);this.keyDownEventUsed=!0;break;case 36:this.goHome(b);this.keyDownEventUsed=!0;break;case 35:this.goEnd(b);this.keyDownEventUsed=!0;break;case 46:this.deleteRight();
this.keyDownEventUsed=!0;break;case 8:this.deleteLeft();this.keyDownEventUsed=!0;break;case 13:this.target instanceof StringMorph||b?this.accept():this.insert("\n");this.keyDownEventUsed=!0;break;case 27:this.cancel();this.keyDownEventUsed=!0;break;default:nop()}this.target.escalateEvent("reactToKeystroke",a)};
CursorMorph.prototype.gotoSlot=function(a){var b=this.target.text.length,c=this.target.slotPosition(a);this.slot=0>a?0:a>b?b:a;this.parent&&this.target.isScrollable&&(a=this.parent.right()-this.viewPadding,b=this.parent.left()+this.viewPadding,c.x>a&&(this.target.setLeft(this.target.left()+a-c.x),c.x=a),c.x<b&&(b=Math.min(this.parent.left(),b),this.target.setLeft(this.target.left()+b-c.x),c.x=b),this.target.right()<a&&a-this.target.width()<b&&(c.x+=a-this.target.right(),this.target.setRight(a)));
this.show();this.setPosition(c);this.parent&&this.parent.parent instanceof ScrollFrameMorph&&this.target.isScrollable&&this.parent.parent.scrollCursorIntoView(this)};CursorMorph.prototype.goLeft=function(a,b){this.updateSelection(a);this.gotoSlot(this.slot-(b||1));this.updateSelection(a)};CursorMorph.prototype.goRight=function(a,b){this.updateSelection(a);this.gotoSlot(this.slot+(b||1));this.updateSelection(a)};
CursorMorph.prototype.goUp=function(a){this.updateSelection(a);this.gotoSlot(this.target.upFrom(this.slot));this.updateSelection(a)};CursorMorph.prototype.goDown=function(a){this.updateSelection(a);this.gotoSlot(this.target.downFrom(this.slot));this.updateSelection(a)};CursorMorph.prototype.goHome=function(a){this.updateSelection(a);this.gotoSlot(this.target.startOfLine(this.slot));this.updateSelection(a)};
CursorMorph.prototype.goEnd=function(a){this.updateSelection(a);this.gotoSlot(this.target.endOfLine(this.slot));this.updateSelection(a)};CursorMorph.prototype.gotoPos=function(a){this.gotoSlot(this.target.slotAt(a));this.show()};
CursorMorph.prototype.updateSelection=function(a){a?isNil(this.target.endMark)&&isNil(this.target.startMark)?(this.target.startMark=this.slot,this.target.endMark=this.slot):this.target.endMark!==this.slot&&(this.target.endMark=this.slot,this.target.drawNew(),this.target.changed()):this.target.clearSelection()};CursorMorph.prototype.accept=function(){var a=this.root();a&&a.stopEditing();this.escalateEvent("accept",this)};
CursorMorph.prototype.cancel=function(){var a=this.root();this.undo();a&&a.stopEditing();this.escalateEvent("cancel",this)};CursorMorph.prototype.undo=function(){this.target.text=this.originalContents;this.target.changed();this.target.drawNew();this.target.changed();this.gotoSlot(0)};
CursorMorph.prototype.insert=function(a,b){if("\t"===a)return this.target.escalateEvent("reactToEdit",this.target),b?this.target.backTab(this.target):this.target.tab(this.target);this.target.isNumeric&&isNaN(parseFloat(a))&&!contains(["-","."],a)||(""!==this.target.selection()&&(this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection()),b=this.target.text,b=b.slice(0,this.slot)+a+b.slice(this.slot),this.target.text=b,this.target.drawNew(),this.target.changed(),this.goRight(!1,
a.length))};CursorMorph.prototype.ctrl=function(a,b){64===a||65===a&&b?this.insert("@"):65===a?this.target.selectAll():90===a?this.undo():123===a?this.insert("{"):125===a?this.insert("}"):91===a?this.insert("["):93===a?this.insert("]"):isNil(this.target.receiver)||(68===a?this.target.doIt():73===a?this.target.inspectIt():80===a&&this.target.showIt())};
CursorMorph.prototype.cmd=function(a,b){64===a||65===a&&b?this.insert("@"):65===a?this.target.selectAll():90===a?this.undo():isNil(this.target.receiver)||(68===a?this.target.doIt():73===a?this.target.inspectIt():80===a&&this.target.showIt())};
CursorMorph.prototype.deleteRight=function(){if(""!==this.target.selection())this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection();else{var a=this.target.text;this.target.changed();a=a.slice(0,this.slot)+a.slice(this.slot+1);this.target.text=a;this.target.drawNew()}};
CursorMorph.prototype.deleteLeft=function(){if(this.target.selection())return this.gotoSlot(this.target.selectionStartSlot()),this.target.deleteSelection();var a=this.target.text;this.target.changed();this.target.text=a.substring(0,this.slot-1)+a.substr(this.slot);this.target.drawNew();this.goLeft()};
CursorMorph.prototype.destroy=function(){this.target.alignment!==this.originalAlignment&&(this.target.alignment=this.originalAlignment,this.target.drawNew(),this.target.changed());this.destroyClipboardHandler();CursorMorph.uber.destroy.call(this)};CursorMorph.prototype.destroyClipboardHandler=function(){var a=document.body.children,b;if(this.clipboardHandler)for(b=0;b<a.length;b+=1){var c=a[b];c===this.clipboardHandler&&(document.body.removeChild(this.clipboardHandler),this.clipboardHandler=null)}};
CursorMorph.prototype.inspectKeyEvent=function(a){this.inform("Key pressed: "+String.fromCharCode(a.charCode)+"\n------------------------\ncharCode: "+a.charCode.toString()+"\nkeyCode: "+a.keyCode.toString()+"\nshiftKey: "+a.shiftKey.toString()+"\naltKey: "+a.altKey.toString()+"\nctrlKey: "+a.ctrlKey.toString()+"\ncmdKey: "+a.metaKey.toString())};BoxMorph.prototype=new Morph;BoxMorph.prototype.constructor=BoxMorph;BoxMorph.uber=Morph.prototype;function BoxMorph(a,b,c){this.init(a,b,c)}
BoxMorph.prototype.init=function(a,b,c){this.edge=a||4;this.border=b||(0===b?0:2);this.borderColor=c||new Color;BoxMorph.uber.init.call(this)};
BoxMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var a=this.image.getContext("2d");if(0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;a.fillStyle=this.color.toString();a.beginPath();this.outlinePath(a,Math.max(this.edge-this.border,0),this.border);a.closePath();a.fill();0<this.border&&(a.lineWidth=this.border,a.strokeStyle=this.borderColor.toString(),a.beginPath(),this.outlinePath(a,this.edge,this.border/2),a.closePath(),a.stroke())};
BoxMorph.prototype.outlinePath=function(a,b,c){c=b+c;var d=this.width(),e=this.height();a.arc(c,c,b,radians(-180),radians(-90),!1);a.arc(d-c,c,b,radians(-90),radians(-0),!1);a.arc(d-c,e-c,b,radians(0),radians(90),!1);a.arc(c,e-c,b,radians(90),radians(180),!1)};
BoxMorph.prototype.developersMenu=function(){var a=BoxMorph.uber.developersMenu.call(this);a.addLine();a.addItem("border width...",function(){this.prompt(a.title+"\nborder\nwidth:",this.setBorderWidth,this,this.border.toString(),null,0,100,!0)},"set the border's\nline size");a.addItem("border color...",function(){this.pickColor(a.title+"\nborder color:",this.setBorderColor,this,this.borderColor)},"set the border's\nline color");a.addItem("corner size...",function(){this.prompt(a.title+"\ncorner\nsize:",
this.setCornerSize,this,this.edge.toString(),null,0,100,!0)},"set the corner's\nradius");return a};BoxMorph.prototype.setBorderWidth=function(a){"number"===typeof a?this.border=Math.max(a,0):(a=parseFloat(a),isNaN(a)||(this.border=Math.max(a,0)));this.drawNew();this.changed()};BoxMorph.prototype.setBorderColor=function(a){a&&(this.borderColor=a,this.drawNew(),this.changed())};
BoxMorph.prototype.setCornerSize=function(a){"number"===typeof a?this.edge=Math.max(a,0):(a=parseFloat(a),isNaN(a)||(this.edge=Math.max(a,0)));this.drawNew();this.changed()};BoxMorph.prototype.colorSetters=function(){return["color","borderColor"]};BoxMorph.prototype.numericalSetters=function(){var a=BoxMorph.uber.numericalSetters.call(this);a.push("setBorderWidth","setCornerSize");return a};SpeechBubbleMorph.prototype=new BoxMorph;SpeechBubbleMorph.prototype.constructor=SpeechBubbleMorph;
SpeechBubbleMorph.uber=BoxMorph.prototype;function SpeechBubbleMorph(a,b,c,d,e,f,g){this.init(a,b,c,d,e,f,g)}SpeechBubbleMorph.prototype.init=function(a,b,c,d,e,f,g){this.isPointingRight=!0;this.contents=a||"";this.padding=f||0;this.isThought=g||!1;this.isClickable=!1;SpeechBubbleMorph.uber.init.call(this,c||6,d||(0===d?0:1),e||new Color(140,140,140));this.color=b||new Color(230,230,230);this.drawNew()};
SpeechBubbleMorph.prototype.popUp=function(a,b,c){this.drawNew();this.setPosition(b.subtract(new Point(0,this.height())));this.addShadow(new Point(2,2),80);this.keepWithin(a);a.add(this);this.fullChanged();a.hand.destroyTemporaries();a.hand.temporaries.push(this);c?this.isClickable=!0:this.mouseEnter=function(){this.destroy()}};
SpeechBubbleMorph.prototype.drawNew=function(){this.contentsMorph&&this.contentsMorph.destroy();this.contents instanceof Morph?this.contentsMorph=this.contents:isString(this.contents)?this.contentsMorph=new TextMorph(this.contents,MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center"):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):
this.contentsMorph=new TextMorph(this.contents.toString(),MorphicPreferences.bubbleHelpFontSize,null,!1,!0,"center");this.add(this.contentsMorph);this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge));this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2);SpeechBubbleMorph.uber.drawNew.call(this);this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))};
SpeechBubbleMorph.prototype.outlinePath=function(a,b,c){function d(b,c,d){a.moveTo(b+d,c);a.arc(b,c,d,radians(0),radians(360))}var e=b+c,f=this.width(),g=this.height();a.arc(e,e,b,radians(-180),radians(-90),!1);a.arc(f-e,e,b,radians(-90),radians(-0),!1);a.arc(f-e,g-e-b,b,radians(0),radians(90),!1);this.isThought||(this.isPointingRight?(a.lineTo(e+b,g-e),a.lineTo(b/2+c,g-c)):(a.lineTo(f-(b/2+c),g-c),a.lineTo(f-(e+b),g-e)));a.arc(e,g-e-b,b,radians(90),radians(180),!1);!0===this.isThought&&(a.lineTo(c,
e),this.isPointingRight?(e=b/4,d(e+c,g-e-c,e),e=b/3.2,d(2*e+c,g-e-2*c,e),e=b/2.8,d(3*e+2*c,g-e-4*c,e)):(e=b/4,d(f-(e+c),g-e-c,e),e=b/3.2,d(f-(2*e+c),g-e-2*c,e),e=b/2.8,d(f-(3*e+2*c),g-e-4*c,e)))};
SpeechBubbleMorph.prototype.shadowImage=function(a,b){var c=a||new Point(7,7);var d=b||new Color(0,0,0);b=this.extent();var e=this.image;a=newCanvas(b);var f=a.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="destination-out";f.drawImage(e,-c.x,-c.y);c=newCanvas(b);f=c.getContext("2d");f.drawImage(a,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=d.toString();f.fillRect(0,0,b.x,b.y);return c};
SpeechBubbleMorph.prototype.shadowImageBlurred=function(a,b){a=a||new Point(7,7);var c=this.shadowBlur,d=b||new Color(0,0,0);var e=this.extent().add(2*c);b=this.image;e=newCanvas(e);var f=e.getContext("2d");f.shadowOffsetX=a.x;f.shadowOffsetY=a.y;f.shadowBlur=c;f.shadowColor=d.toString();f.drawImage(b,c-a.x,c-a.y);f.shadowOffsetX=0;f.shadowOffsetY=0;f.shadowBlur=0;f.globalCompositeOperation="destination-out";f.drawImage(b,c-a.x,c-a.y);return e};
SpeechBubbleMorph.prototype.fixLayout=function(){this.removeShadow();this.drawNew();this.addShadow(new Point(2,2),80)};CircleBoxMorph.prototype=new Morph;CircleBoxMorph.prototype.constructor=CircleBoxMorph;CircleBoxMorph.uber=Morph.prototype;function CircleBoxMorph(a){this.init(a||"vertical")}CircleBoxMorph.prototype.init=function(a){CircleBoxMorph.uber.init.call(this);this.orientation=a;this.autoOrient=!0;this.setExtent(new Point(20,100))};
CircleBoxMorph.prototype.autoOrientation=function(){this.height()>this.width()?this.orientation="vertical":this.orientation="horizontal"};
CircleBoxMorph.prototype.drawNew=function(){var a=this;this.autoOrient&&this.autoOrientation();this.image=newCanvas(this.extent());var b=this.image.getContext("2d");if("vertical"===this.orientation){var c=this.width()/2;var d=this.center().x;var e=new Point(d,this.top()+c);var f=new Point(d,this.bottom()-c);d=this.bounds.origin.add(new Point(0,c)).corner(this.bounds.corner.subtract(new Point(0,c)))}else c=this.height()/2,d=this.center().y,e=new Point(this.left()+c,d),f=new Point(this.right()-c,d),
d=this.bounds.origin.add(new Point(c,0)).corner(this.bounds.corner.subtract(new Point(c,0)));[e.subtract(this.bounds.origin),f.subtract(this.bounds.origin)].forEach(function(d){b.fillStyle=a.color.toString();b.beginPath();b.arc(d.x,d.y,c,0,2*Math.PI,!1);b.closePath();b.fill()});d=d.translateBy(this.bounds.origin.neg());e=d.extent();0<e.x&&0<e.y&&b.fillRect(d.origin.x,d.origin.y,d.width(),d.height())};
CircleBoxMorph.prototype.developersMenu=function(){var a=CircleBoxMorph.uber.developersMenu.call(this);a.addLine();"vertical"===this.orientation?a.addItem("horizontal...","toggleOrientation","toggle the\norientation"):a.addItem("vertical...","toggleOrientation","toggle the\norientation");return a};
CircleBoxMorph.prototype.toggleOrientation=function(){var a=this.center();this.changed();this.orientation="vertical"===this.orientation?"horizontal":"vertical";this.silentSetExtent(new Point(this.height(),this.width()));this.setCenter(a);this.drawNew();this.changed()};SliderButtonMorph.prototype=new CircleBoxMorph;SliderButtonMorph.prototype.constructor=SliderButtonMorph;SliderButtonMorph.uber=CircleBoxMorph.prototype;function SliderButtonMorph(a){this.init(a)}
SliderButtonMorph.prototype.init=function(a){this.color=new Color(80,80,80);this.highlightColor=new Color(90,90,140);this.pressColor=new Color(80,80,160);this.is3D=!1;this.hasMiddleDip=!0;SliderButtonMorph.uber.init.call(this,a)};SliderButtonMorph.prototype.autoOrientation=nop;
SliderButtonMorph.prototype.drawNew=function(){var a=this.color.copy();SliderButtonMorph.uber.drawNew.call(this);!this.is3D&&MorphicPreferences.isFlat||this.drawEdges();this.normalImage=this.image;this.color=this.highlightColor.copy();SliderButtonMorph.uber.drawNew.call(this);!this.is3D&&MorphicPreferences.isFlat||this.drawEdges();this.highlightImage=this.image;this.color=this.pressColor.copy();SliderButtonMorph.uber.drawNew.call(this);!this.is3D&&MorphicPreferences.isFlat||this.drawEdges();this.pressImage=
this.image;this.color=a;this.image=this.normalImage};
SliderButtonMorph.prototype.drawEdges=function(){var a=this.image.getContext("2d"),b=this.width(),c=this.height();a.lineJoin="round";a.lineCap="round";if("vertical"===this.orientation){a.lineWidth=b/3;var d=a.createLinearGradient(0,0,a.lineWidth,0);d.addColorStop(0,"white");d.addColorStop(1,this.color.toString());a.strokeStyle=d;a.beginPath();a.moveTo(.5*a.lineWidth,b/2);a.lineTo(.5*a.lineWidth,c-b/2);a.stroke();d=a.createLinearGradient(b-a.lineWidth,0,b,0);d.addColorStop(0,this.color.toString());
d.addColorStop(1,"black");a.strokeStyle=d;a.beginPath();a.moveTo(b-.5*a.lineWidth,b/2);a.lineTo(b-.5*a.lineWidth,c-b/2);a.stroke();if(this.hasMiddleDip){d=a.createLinearGradient(a.lineWidth,0,b-a.lineWidth,0);var e=b/4;d.addColorStop(0,"black");d.addColorStop(.35,this.color.toString());d.addColorStop(.65,this.color.toString());d.addColorStop(1,"white");a.fillStyle=d;a.beginPath();a.arc(b/2,c/2,e,radians(0),radians(360),!1);a.closePath();a.fill()}}else"horizontal"===this.orientation&&(a.lineWidth=
c/3,d=a.createLinearGradient(0,0,0,a.lineWidth),d.addColorStop(0,"white"),d.addColorStop(1,this.color.toString()),a.strokeStyle=d,a.beginPath(),a.moveTo(c/2,.5*a.lineWidth),a.lineTo(b-c/2,.5*a.lineWidth),a.stroke(),d=a.createLinearGradient(0,c-a.lineWidth,0,c),d.addColorStop(0,this.color.toString()),d.addColorStop(1,"black"),a.strokeStyle=d,a.beginPath(),a.moveTo(c/2,c-.5*a.lineWidth),a.lineTo(b-c/2,c-.5*a.lineWidth),a.stroke(),this.hasMiddleDip&&(d=a.createLinearGradient(0,a.lineWidth,0,c-a.lineWidth),
e=c/4,d.addColorStop(0,"black"),d.addColorStop(.35,this.color.toString()),d.addColorStop(.65,this.color.toString()),d.addColorStop(1,"white"),a.fillStyle=d,a.beginPath(),a.arc(this.width()/2,this.height()/2,e,radians(0),radians(360),!1),a.closePath(),a.fill()))};SliderButtonMorph.prototype.mouseEnter=function(){this.image=this.highlightImage;this.changed()};SliderButtonMorph.prototype.mouseLeave=function(){this.image=this.normalImage;this.changed()};
SliderButtonMorph.prototype.mouseDownLeft=function(a){this.image=this.pressImage;this.changed();this.escalateEvent("mouseDownLeft",a)};SliderButtonMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage;this.changed()};SliderButtonMorph.prototype.mouseMove=function(){nop()};SliderMorph.prototype=new CircleBoxMorph;SliderMorph.prototype.constructor=SliderMorph;SliderMorph.uber=CircleBoxMorph.prototype;
function SliderMorph(a,b,c,d,e,f){this.init(a||1,b||100,c||50,d||10,e||"vertical",f)}
SliderMorph.prototype.init=function(a,b,c,d,e,f){this.action=this.target=null;this.start=a;this.stop=b;this.value=c;this.size=d;this.offset=null;this.button=new SliderButtonMorph;this.button.isDraggable=!1;this.button.color=new Color(200,200,200);this.button.highlightColor=new Color(210,210,255);this.button.pressColor=new Color(180,180,255);SliderMorph.uber.init.call(this,e);this.add(this.button);this.alpha=.3;this.color=f||new Color(0,0,0);this.setExtent(new Point(20,100))};
SliderMorph.prototype.autoOrientation=nop;SliderMorph.prototype.rangeSize=function(){return this.stop-this.start};SliderMorph.prototype.ratio=function(){return this.size/(this.rangeSize()+1)};SliderMorph.prototype.unitSize=function(){return"vertical"===this.orientation?(this.height()-this.button.height())/this.rangeSize():(this.width()-this.button.width())/this.rangeSize()};
SliderMorph.prototype.drawNew=function(){SliderMorph.uber.drawNew.call(this);this.button.orientation=this.orientation;if("vertical"===this.orientation){var a=this.width()-2;var b=Math.max(a,Math.round(this.height()*this.ratio()));this.button.silentSetExtent(new Point(a,b));a=1;b=Math.min(Math.round((this.value-this.start)*this.unitSize()),this.height()-this.button.height())}else b=this.height()-2,a=Math.max(b,Math.round(this.width()*this.ratio())),this.button.silentSetExtent(new Point(a,b)),b=1,a=
Math.min(Math.round((this.value-this.start)*this.unitSize()),this.width()-this.button.width());this.button.setPosition((new Point(a,b)).add(this.bounds.origin));this.button.drawNew();this.button.changed()};SliderMorph.prototype.updateValue=function(){var a="vertical"===this.orientation?this.button.top()-this.top():this.button.left()-this.left();this.value=Math.round(a/this.unitSize()+this.start);this.updateTarget()};
SliderMorph.prototype.updateTarget=function(){if(this.action)if("function"===typeof this.action)this.action.call(this.target,this.value);else this.target[this.action](this.value)};
SliderMorph.prototype.developersMenu=function(){var a=SliderMorph.uber.developersMenu.call(this);a.addItem("show value...","showValue","display a dialog box\nshowing the selected number");a.addItem("floor...",function(){this.prompt(a.title+"\nfloor:",this.setStart,this,this.start.toString(),null,0,this.stop-this.size,!0)},"set the minimum value\nwhich can be selected");a.addItem("ceiling...",function(){this.prompt(a.title+"\nceiling:",this.setStop,this,this.stop.toString(),null,this.start+this.size,
100*this.size,!0)},"set the maximum value\nwhich can be selected");a.addItem("button size...",function(){this.prompt(a.title+"\nbutton size:",this.setSize,this,this.size.toString(),null,1,this.stop-this.start,!0)},"set the range\ncovered by\nthe slider button");a.addLine();a.addItem("set target","setTarget","select another morph\nwhose numerical property\nwill be controlled by this one");return a};SliderMorph.prototype.showValue=function(){this.inform(this.value)};
SliderMorph.prototype.userSetStart=function(a){this.start=Math.max(a,this.stop)};SliderMorph.prototype.setStart=function(a,b){"number"===typeof a?this.start=Math.min(a,this.stop-this.size):(a=parseFloat(a),isNaN(a)||(this.start=Math.min(a,this.stop-this.size)));this.value=Math.max(this.value,this.start);b||this.updateTarget();this.drawNew();this.changed()};
SliderMorph.prototype.setStop=function(a,b){"number"===typeof a?this.stop=Math.max(a,this.start+this.size):(a=parseFloat(a),isNaN(a)||(this.stop=Math.max(a,this.start+this.size)));this.value=Math.min(this.value,this.stop);b||this.updateTarget();this.drawNew();this.changed()};
SliderMorph.prototype.setSize=function(a,b){"number"===typeof a?this.size=Math.min(Math.max(a,1),this.stop-this.start):(a=parseFloat(a),isNaN(a)||(this.size=Math.min(Math.max(a,1),this.stop-this.start)));this.value=Math.min(this.value,this.stop-this.size);b||this.updateTarget();this.drawNew();this.changed()};
SliderMorph.prototype.setTarget=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose target:"),c=this;a.push(this.world());a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){c.target=a;c.setTargetSetter()})});1===a.length?(this.target=a[0],this.setTargetSetter()):0<a.length&&b.popUpAtHand(this.world())};
SliderMorph.prototype.setTargetSetter=function(){var a=this.target.numericalSetters(),b=new MenuMorph(this,"choose target property:"),c=this;a.forEach(function(a){b.addItem(a,function(){c.action=a})});1===a.length?this.action=a[0]:0<a.length&&b.popUpAtHand(this.world())};SliderMorph.prototype.numericalSetters=function(){var a=SliderMorph.uber.numericalSetters.call(this);a.push("setStart","setStop","setSize");return a};SliderMorph.prototype.step=null;
SliderMorph.prototype.mouseDownLeft=function(a){var b=this;this.button.bounds.containsPoint(a)?this.offset=a.subtract(this.button.bounds.origin):this.offset=new Point;var c=this.root();this.step=function(){if(c.hand.mouseButton){var a=c.hand.bounds.origin;if("vertical"===b.orientation){var e=b.button.bounds.origin.x;var f=Math.max(Math.min(a.y-b.offset.y,b.bottom()-b.button.height()),b.top())}else f=b.button.bounds.origin.y,e=Math.max(Math.min(a.x-b.offset.x,b.right()-b.button.width()),b.left());
b.button.setPosition(new Point(e,f));b.updateValue()}else this.step=null}};MouseSensorMorph.prototype=new BoxMorph;MouseSensorMorph.prototype.constructor=MouseSensorMorph;MouseSensorMorph.uber=BoxMorph.prototype;function MouseSensorMorph(a,b,c){this.init(a,b,c)}
MouseSensorMorph.prototype.init=function(a,b,c){MouseSensorMorph.uber.init.call(this);this.edge=a||4;this.border=b||2;this.color=new Color(255,255,255);this.borderColor=c||new Color;this.isTouched=!1;this.upStep=.05;this.downStep=.02;this.noticesTransparentClick=!1;this.drawNew()};
MouseSensorMorph.prototype.touch=function(){var a=this;this.isTouched||(this.isTouched=!0,this.alpha=.6,this.step=function(){a.isTouched?1>a.alpha&&(a.alpha+=a.upStep):a.alpha>a.downStep?a.alpha-=a.downStep:(a.alpha=0,a.step=null);a.changed()})};MouseSensorMorph.prototype.unTouch=function(){this.isTouched=!1};MouseSensorMorph.prototype.mouseEnter=function(){this.touch()};MouseSensorMorph.prototype.mouseLeave=function(){this.unTouch()};MouseSensorMorph.prototype.mouseDownLeft=function(){this.touch()};
MouseSensorMorph.prototype.mouseClickLeft=function(){this.unTouch()};InspectorMorph.prototype=new BoxMorph;InspectorMorph.prototype.constructor=InspectorMorph;InspectorMorph.uber=BoxMorph.prototype;function InspectorMorph(a){this.init(a)}
InspectorMorph.prototype.init=function(a){this.target=a;this.currentProperty=null;this.showing="attributes";this.hasUserEditedDetails=this.markOwnProperties=!1;InspectorMorph.uber.init.call(this);this.silentSetExtent(new Point(20*MorphicPreferences.handleSize,40*MorphicPreferences.handleSize/3));this.isDraggable=!0;this.border=1;this.edge=MorphicPreferences.isFlat?1:5;this.color=new Color(60,60,60);this.borderColor=new Color(95,95,95);this.fps=25;this.drawNew();this.resizer=this.buttonEdit=this.buttonSubset=
this.buttonClose=this.buttonInspect=this.work=this.detail=this.list=this.label=null;this.target&&this.buildPanes()};InspectorMorph.prototype.setTarget=function(a){this.target=a;this.currentProperty=null;this.buildPanes()};
InspectorMorph.prototype.updateCurrentSelection=function(){var a=this.list.selected;var b=this.detail.contents.children[0];var c=this.root();c&&c.keyboardReceiver instanceof CursorMorph&&c.keyboardReceiver.target===b?this.hasUserEditedDetails=!0:isNil(a)||this.hasUserEditedDetails||(this.currentProperty=a=this.target[a],a=isNil(a)?"NULL":isString(a)?a:a.toString(),b.text!==a&&(b=new TextMorph(a),b.isEditable=!0,b.enableSelecting(),b.setReceiver(this.target),this.detail.setContents(b)))};
InspectorMorph.prototype.buildPanes=function(){var a=[],b,c=this;this.children.forEach(function(a){a!==this.work&&a.destroy()});this.children=[];this.label=new TextMorph(this.target.toString());this.label.fontSize=MorphicPreferences.menuFontSize;this.label.isBold=!0;this.label.color=new Color(255,255,255);this.label.drawNew();this.add(this.label);for(b in this.target)b&&a.push(b);"attributes"===this.showing?a=a.filter(function(a){return"function"!==typeof c.target[a]}):"methods"===this.showing&&(a=
a.filter(function(a){return"function"===typeof c.target[a]}));this.list=new ListMorph(this.target instanceof Array?a:a.sort(),null,this.markOwnProperties?[[new Color(0,0,180),function(a){return Object.prototype.hasOwnProperty.call(c.target,a)}]]:null,function(){if(isObject(c.currentProperty)){var a=c.world();var b=new InspectorMorph(c.currentProperty);b.setPosition(a.hand.position());b.keepWithin(a);a.add(b);b.changed()}});this.list.action=function(){c.hasUserEditedDetails=!1;c.updateCurrentSelection()};
this.list.hBar.alpha=.6;this.list.vBar.alpha=.6;this.list.contents.step=null;this.add(this.list);this.detail=new ScrollFrameMorph;this.detail.acceptsDrops=!1;this.detail.contents.acceptsDrops=!1;this.detail.isTextLineWrapping=!0;this.detail.color=new Color(255,255,255);this.detail.hBar.alpha=.6;this.detail.vBar.alpha=.6;a=new TextMorph("");a.isEditable=!0;a.enableSelecting();a.setReceiver(this.target);this.detail.setContents(a);this.add(this.detail);null===this.work&&(this.work=new ScrollFrameMorph,
this.work.acceptsDrops=!1,this.work.contents.acceptsDrops=!1,this.work.isTextLineWrapping=!0,this.work.color=new Color(255,255,255),this.work.hBar.alpha=.6,this.work.vBar.alpha=.6,a=new TextMorph(""),a.isEditable=!0,a.enableSelecting(),a.setReceiver(this.target),this.work.setContents(a));this.add(this.work);this.buttonSubset=new TriggerMorph;this.buttonSubset.labelString="show...";this.buttonSubset.action=function(){var a=new MenuMorph;a.addItem("attributes",function(){c.showing="attributes";c.buildPanes()});
a.addItem("methods",function(){c.showing="methods";c.buildPanes()});a.addItem("all",function(){c.showing="all";c.buildPanes()});a.addLine();a.addItem(c.markOwnProperties?"un-mark own":"mark own",function(){c.markOwnProperties=!c.markOwnProperties;c.buildPanes()},"highlight\n'own' properties");a.popUpAtHand(c.world())};this.add(this.buttonSubset);this.buttonInspect=new TriggerMorph;this.buttonInspect.labelString="inspect...";this.buttonInspect.action=function(){var a,b;if(isObject(c.currentProperty)){var f=
new MenuMorph;f.addItem("in new inspector...",function(){a=c.world();b=new InspectorMorph(c.currentProperty);b.setPosition(a.hand.position());b.keepWithin(a);a.add(b);b.changed()});f.addItem("here...",function(){c.setTarget(c.currentProperty)});f.popUpAtHand(c.world())}else c.inform((null===c.currentProperty?"null":typeof c.currentProperty)+"\nis not inspectable")};this.add(this.buttonInspect);this.buttonEdit=new TriggerMorph;this.buttonEdit.labelString="edit...";this.buttonEdit.action=function(){var a=
new MenuMorph(c);a.addItem("save","save","accept changes");a.addLine();a.addItem("add property...","addProperty");a.addItem("rename...","renameProperty");a.addItem("remove...","removeProperty");a.popUpAtHand(c.world())};this.add(this.buttonEdit);this.buttonClose=new TriggerMorph;this.buttonClose.labelString="close";this.buttonClose.action=function(){c.destroy()};this.add(this.buttonClose);this.resizer=new HandleMorph(this,150,100,this.edge,this.edge);this.fixLayout()};
InspectorMorph.prototype.fixLayout=function(){Morph.prototype.trackChanges=!1;var a=this.left()+this.edge;var b=this.top()+this.edge;var c=this.right()-this.edge;c-=a;this.label.setPosition(new Point(a,b));this.label.setWidth(c);this.label.height()>this.height()-50&&(this.silentSetHeight(this.label.height()+50),this.drawNew(),this.changed(),this.resizer.drawNew());b=this.label.bottom()+2;c=Math.min(Math.floor(this.width()/3),this.list.listContents.width());c-=this.edge;var d=this.bottom()-2*this.edge-
MorphicPreferences.handleSize-b;this.list.setPosition(new Point(a,b));this.list.setExtent(new Point(c,d));a=this.list.right()+this.edge;c=this.right()-this.edge;c-=a;this.detail.setPosition(new Point(a,b));this.detail.setExtent(new Point(c,2*d/3-this.edge));b=this.detail.bottom()+this.edge;this.work.setPosition(new Point(a,b));this.work.setExtent(new Point(c,d/3));a=this.list.left();b=this.list.bottom()+this.edge;c=this.list.width();d=MorphicPreferences.handleSize;this.buttonSubset.setPosition(new Point(a,
b));this.buttonSubset.setExtent(new Point(c,d));a=this.detail.left();c=this.detail.width()-this.edge-MorphicPreferences.handleSize;c=c/3-this.edge/3;this.buttonInspect.setPosition(new Point(a,b));this.buttonInspect.setExtent(new Point(c,d));a=this.buttonInspect.right()+this.edge;this.buttonEdit.setPosition(new Point(a,b));this.buttonEdit.setExtent(new Point(c,d));a=this.buttonEdit.right()+this.edge;c=this.detail.right()-this.edge-MorphicPreferences.handleSize;c-=a;this.buttonClose.setPosition(new Point(a,
b));this.buttonClose.setExtent(new Point(c,d));Morph.prototype.trackChanges=!0;this.changed()};InspectorMorph.prototype.setExtent=function(a){InspectorMorph.uber.setExtent.call(this,a);this.fixLayout()};InspectorMorph.prototype.save=function(){var a=this.detail.contents.children[0].text.toString(),b=this.list.selected;try{this.target.evaluateString("this."+b+" = "+a),this.hasUserEditedDetails=!1,this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(c){this.inform(c)}};
InspectorMorph.prototype.addProperty=function(){var a=this;this.prompt("new property name:",function(b){b&&(a.target[b]=null,a.buildPanes(),a.target.drawNew&&(a.target.changed(),a.target.drawNew(),a.target.changed()))},this,"property")};
InspectorMorph.prototype.renameProperty=function(){var a=this,b=this.list.selected;this.prompt("property name:",function(c){try{delete a.target[b],a.target[c]=a.currentProperty}catch(d){a.inform(d)}a.buildPanes();a.target.drawNew&&(a.target.changed(),a.target.drawNew(),a.target.changed())},this,b)};
InspectorMorph.prototype.removeProperty=function(){var a=this.list.selected;try{delete this.target[a],this.currentProperty=null,this.buildPanes(),this.target.drawNew&&(this.target.changed(),this.target.drawNew(),this.target.changed())}catch(b){this.inform(b)}};InspectorMorph.prototype.step=function(){this.updateCurrentSelection();var a=this.target.toString();this.label.text!==a&&(this.label.text=a,this.label.drawNew(),this.fixLayout())};
InspectorMorph.prototype.updateReferences=function(a){var b=this.list.activeIndex();InspectorMorph.uber.updateReferences.call(this,a);this.buildPanes();this.list.activateIndex(b)};MenuMorph.prototype=new BoxMorph;MenuMorph.prototype.constructor=MenuMorph;MenuMorph.uber=BoxMorph.prototype;function MenuMorph(a,b,c,d){this.init(a,b,c,d)}
MenuMorph.prototype.init=function(a,b,c,d){this.target=a;this.title=b||null;this.environment=c||null;this.fontSize=d||null;this.items=[];this.world=this.label=null;this.hasFocus=this.isListContents=!1;this.submenu=this.selection=null;MenuMorph.uber.init.call(this);this.isDraggable=!1;this.edge=this.border=null};MenuMorph.prototype.addItem=function(a,b,c,d,e,f,g,h){this.items.push([localize(a||"close"),b||nop,c,d,e||!1,f||!1,g,h])};
MenuMorph.prototype.addMenu=function(a,b,c){this.addPair(a,b,isNil(c)?"\u25ba":c)};MenuMorph.prototype.addPair=function(a,b,c,d){this.addItem(a,b,d,null,null,null,null,c)};MenuMorph.prototype.addLine=function(a){this.items.push([0,a||1])};
MenuMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();var a=new TextMorph(localize(this.title),this.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,!0,!1,"center");a.alignment="center";a.color=new Color(255,255,255);a.backgroundColor=this.borderColor;a.drawNew();this.label=new BoxMorph(3,0);MorphicPreferences.isFlat&&(this.label.edge=0);this.label.color=this.borderColor;this.label.borderColor=this.borderColor;this.label.setExtent(a.extent().add(4));
this.label.drawNew();this.label.add(a);this.label.text=a};
MenuMorph.prototype.drawNew=function(){var a=this,b,c=!1;this.children.forEach(function(a){a.destroy()});this.children=[];this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2);this.color=new Color(255,255,255);this.borderColor=new Color(60,60,60);this.silentSetExtent(new Point(0,0));var d=2;var e=this.left()+4;this.isListContents||(this.title?(this.createLabel(),this.label.setPosition(this.bounds.origin.add(4)),this.add(this.label),d=this.label.bottom()):
d=this.top()+4);d+=1;this.items.forEach(function(f){c=!1;f instanceof StringFieldMorph||f instanceof ColorPickerMorph||f instanceof SliderMorph?b=f:0===f[0]?(c=!0,b=new Morph,b.color=a.borderColor,b.setHeight(f[1])):b=new MenuItemMorph(a.target,f[1],f[0],a.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,a.environment,f[2],f[3],f[4],f[5],f[6],f[7]);c&&(d+=1);b.setPosition(new Point(e,d));a.add(b);d+=b.height();c&&(d+=1)});var f=this.fullBounds();this.silentSetExtent(f.extent().add(4));
this.adjustWidths();MenuMorph.uber.drawNew.call(this)};
MenuMorph.prototype.maxWidth=function(){var a=0;this.parent instanceof FrameMorph&&this.parent.scrollFrame instanceof ScrollFrameMorph&&(a=this.parent.scrollFrame.width());this.children.forEach(function(b){if(b instanceof MenuItemMorph)a=Math.max(a,b.label.width()+8+(b.shortcut?b.shortcut.width()+4:0));else if(b instanceof StringFieldMorph||b instanceof ColorPickerMorph||b instanceof SliderMorph)a=Math.max(a,b.width())});this.label&&(a=Math.max(a,this.label.width()));return a};
MenuMorph.prototype.adjustWidths=function(){var a=this.maxWidth(),b,c=this;this.children.forEach(function(d){d.silentSetWidth(a);d instanceof MenuItemMorph?(d.fixLayout(),b=d.image===d.pressImage,d.createBackgrounds(),b&&(d.image=d.pressImage)):(d.drawNew(),d===c.label&&d.text.setPosition(d.center().subtract(d.text.extent().floorDivideBy(2))))})};MenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(a){a instanceof MenuItemMorph&&(a.image=a.normalImage)});this.changed()};
MenuMorph.prototype.popup=function(a,b){this.drawNew();this.setPosition(b);this.addShadow(new Point(2,2),80);this.keepWithin(a);a.activeMenu&&a.activeMenu.destroy();1>this.items.length&&!this.title||(a.add(this),a.activeMenu=this,this.world=a,this.fullChanged())};MenuMorph.prototype.popUpAtHand=function(a){a=a||this.world;this.popup(a,a.hand.position())};MenuMorph.prototype.popUpCenteredAtHand=function(a){a=a||this.world;this.drawNew();this.popup(a,a.hand.position().subtract(this.extent().floorDivideBy(2)))};
MenuMorph.prototype.popUpCenteredInWorld=function(a){a=a||this.world;this.drawNew();this.popup(a,a.center().subtract(this.extent().floorDivideBy(2)))};MenuMorph.prototype.closeRootMenu=function(){this.parent instanceof MenuMorph?this.parent.closeRootMenu():this.destroy()};MenuMorph.prototype.closeSubmenu=function(){this.submenu&&(this.submenu.destroy(),this.submenu=null,this.unselectAllItems())};
MenuMorph.prototype.getFocus=function(){this.world.keyboardReceiver=this;this.selection=null;this.selectFirst();this.hasFocus=!0};MenuMorph.prototype.processKeyDown=function(a){switch(a.keyCode){case 13:case 32:this.selection&&(this.selection.mouseClickLeft(),this.submenu&&this.submenu.getFocus());break;case 27:return this.destroy();case 37:return this.leaveSubmenu();case 38:return this.selectUp();case 39:return this.enterSubmenu();case 40:return this.selectDown();default:nop()}};
MenuMorph.prototype.processKeyUp=function(a){nop(a)};MenuMorph.prototype.processKeyPress=function(a){nop(a)};MenuMorph.prototype.selectFirst=function(){var a;for(a=0;a<this.children.length;a+=1)if(this.children[a]instanceof MenuItemMorph){this.select(this.children[a]);break}};MenuMorph.prototype.selectUp=function(){var a=this.children.filter(function(a){return a instanceof MenuItemMorph});if(this.selection){var b=a.indexOf(this.selection)-1;0>b&&(b=a.length-1);this.select(a[b])}else a.length&&this.select(a[0])};
MenuMorph.prototype.selectDown=function(){var a=this.children.filter(function(a){return a instanceof MenuItemMorph});if(this.selection){var b=a.indexOf(this.selection)+1;b>=a.length&&(b=0);this.select(a[b])}else a.length&&this.select(a[0])};MenuMorph.prototype.enterSubmenu=function(){this.selection&&this.selection.action instanceof MenuMorph&&(this.selection.popUpSubmenu(),this.submenu&&this.submenu.getFocus())};
MenuMorph.prototype.leaveSubmenu=function(){var a=this.parent;this.parent instanceof MenuMorph&&(a.submenu=null,a.hasFocus=!0,this.destroy(),a.world.keyboardReceiver=a)};MenuMorph.prototype.select=function(a){this.unselectAllItems();a.image=a.highlightImage;a.changed();this.selection=a};MenuMorph.prototype.destroy=function(){this.hasFocus&&(this.world.keyboardReceiver=null);MenuMorph.uber.destroy.call(this)};StringMorph.prototype=new Morph;StringMorph.prototype.constructor=StringMorph;
StringMorph.uber=Morph.prototype;function StringMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
StringMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l){this.text=a||(""===a?"":"StringMorph");this.fontSize=b||12;this.fontName=l||MorphicPreferences.globalFontFamily;this.fontStyle=c||"sans-serif";this.isBold=d||!1;this.isItalic=e||!1;this.isEditable=!1;this.isNumeric=f||!1;this.isPassword=!1;this.shadowOffset=g||new Point(0,0);this.shadowColor=h||null;this.isShowingBlanks=!1;this.blanksColor=new Color(180,140,140);this.isScrollable=!0;this.currentlySelecting=!1;this.endMark=this.startMark=0;this.markedTextColor=
new Color(255,255,255);this.markedBackgoundColor=new Color(60,60,120);StringMorph.uber.init.call(this,!0);this.color=k||new Color(0,0,0);this.noticesTransparentClick=!0;this.drawNew()};StringMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+'("'+this.text.slice(0,30)+'...")'};StringMorph.prototype.password=function(a,b){var c="",d;for(d=0;d<b;d+=1)c+=a;return c};
StringMorph.prototype.font=function(){var a="";this.isBold&&(a+="bold ");this.isItalic&&(a+="italic ");return a+this.fontSize+"px "+(this.fontName?this.fontName+", ":"")+this.fontStyle};
StringMorph.prototype.drawNew=function(){var a=this.shadowOffset||new Point;var b=this.isPassword?this.password("*",this.text.length):this.text;this.image=newCanvas();var c=this.image.getContext("2d");c.font=this.font();var d=Math.max(c.measureText(b).width+Math.abs(a.x),1);this.bounds.corner=this.bounds.origin.add(new Point(d,fontHeight(this.fontSize)+Math.abs(a.y)));this.image.width=d;this.image.height=this.height();c.font=this.font();c.textAlign="left";c.textBaseline="bottom";if(this.shadowColor){d=
Math.max(a.x,0);var e=Math.max(a.y,0);c.fillStyle=this.shadowColor.toString();c.fillText(b,d,fontHeight(this.fontSize)+e)}d=Math.abs(Math.min(a.x,0));e=Math.abs(Math.min(a.y,0));c.fillStyle=this.color.toString();this.isShowingBlanks?this.renderWithBlanks(c,d,fontHeight(this.fontSize)+e):c.fillText(b,d,fontHeight(this.fontSize)+e);var f=Math.min(this.startMark,this.endMark);for(a=Math.max(this.startMark,this.endMark);f<a;f+=1){var g=this.slotPosition(f).subtract(this.position());var h=b.charAt(f);
c.fillStyle=this.markedBackgoundColor.toString();c.fillRect(g.x,g.y,c.measureText(h).width+1+d,fontHeight(this.fontSize)+e);c.fillStyle=this.markedTextColor.toString();c.fillText(h,g.x+d,fontHeight(this.fontSize)+e)}this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};
StringMorph.prototype.renderWithBlanks=function(a,b,c){var d=a.measureText(" ").width,e=newCanvas(new Point(d,this.height())),f=e.getContext("2d"),g=this.text.split(" "),h=b||0,k=!0;f.fillStyle=this.blanksColor.toString();f.arc(d/2,e.height/2,d/2,radians(0),radians(360));f.fill();g.forEach(function(b){k||(a.drawImage(e,h,0),h+=d);k=!1;""!==b&&(a.fillText(b,h,c),h+=a.measureText(b).width)})};
StringMorph.prototype.slotPosition=function(a){var b=this.isPassword?this.password("*",this.text.length):this.text;a=Math.min(Math.max(a,0),b.length);var c=this.image.getContext("2d"),d,e;for(e=d=0;e<a;e+=1)d+=c.measureText(b[e]).width;this.pos=a;b=this.left()+d;a=this.top();return new Point(b,a)};
StringMorph.prototype.slotAt=function(a){for(var b=this.isPassword?this.password("*",this.text.length):this.text,c=0,d=0,e=this.image.getContext("2d");a.x-this.left()>d;)if(d+=e.measureText(b[c]).width,c+=1,c===b.length&&e.measureText(b).width-e.measureText(b[c-1]).width/2<a.x-this.left())return c;return a.x-this.left()>d-e.measureText(b[c-1]).width/2?c:c-1};StringMorph.prototype.upFrom=function(a){return a};StringMorph.prototype.downFrom=function(a){return a};StringMorph.prototype.startOfLine=function(){return 0};
StringMorph.prototype.endOfLine=function(){return this.text.length};StringMorph.prototype.previousWordFrom=function(a){for(--a;0<a&&!isWordChar(this.text[a]);)--a;for(;0<a&&isWordChar(this.text[a-1]);)--a;return a};StringMorph.prototype.nextWordFrom=function(a){for(;a<this.endOfLine()&&!isWordChar(this.text[a]);)a+=1;for(;a<this.endOfLine()&&isWordChar(this.text[a]);)a+=1;return a};StringMorph.prototype.rawHeight=function(){return this.height()/1.2};
StringMorph.prototype.developersMenu=function(){var a=StringMorph.uber.developersMenu.call(this);a.addLine();a.addItem("edit","edit");a.addItem("font size...",function(){this.prompt(a.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,500,!0)},"set this String's\nfont point size");"serif"!==this.fontStyle&&a.addItem("serif","setSerif");"sans-serif"!==this.fontStyle&&a.addItem("sans-serif","setSansSerif");this.isBold?a.addItem("normal weight","toggleWeight"):a.addItem("bold",
"toggleWeight");this.isItalic?a.addItem("normal style","toggleItalic"):a.addItem("italic","toggleItalic");this.isShowingBlanks?a.addItem("hide blanks","toggleShowBlanks"):a.addItem("show blanks","toggleShowBlanks");this.isPassword?a.addItem("show characters","toggleIsPassword"):a.addItem("hide characters","toggleIsPassword");return a};StringMorph.prototype.toggleIsDraggable=function(){(this.isDraggable=!this.isDraggable)?this.disableSelecting():this.enableSelecting()};
StringMorph.prototype.toggleShowBlanks=function(){this.isShowingBlanks=!this.isShowingBlanks;this.changed();this.drawNew();this.changed()};StringMorph.prototype.toggleWeight=function(){this.isBold=!this.isBold;this.changed();this.drawNew();this.changed()};StringMorph.prototype.toggleItalic=function(){this.isItalic=!this.isItalic;this.changed();this.drawNew();this.changed()};StringMorph.prototype.toggleIsPassword=function(){this.isPassword=!this.isPassword;this.changed();this.drawNew();this.changed()};
StringMorph.prototype.setSerif=function(){this.fontStyle="serif";this.changed();this.drawNew();this.changed()};StringMorph.prototype.setSansSerif=function(){this.fontStyle="sans-serif";this.changed();this.drawNew();this.changed()};StringMorph.prototype.setFontSize=function(a){"number"===typeof a?this.fontSize=Math.round(Math.min(Math.max(a,4),500)):(a=parseFloat(a),isNaN(a)||(this.fontSize=Math.round(Math.min(Math.max(a,4),500))));this.changed();this.drawNew();this.changed()};
StringMorph.prototype.setText=function(a){this.text=Math.round(a).toString();this.changed();this.drawNew();this.changed()};StringMorph.prototype.numericalSetters=function(){return["setLeft","setTop","setAlphaScaled","setFontSize","setText"]};StringMorph.prototype.edit=function(){this.root().edit(this)};StringMorph.prototype.selection=function(){return this.text.slice(Math.min(this.startMark,this.endMark),Math.max(this.startMark,this.endMark))};
StringMorph.prototype.selectionStartSlot=function(){return Math.min(this.startMark,this.endMark)};StringMorph.prototype.clearSelection=function(){!this.currentlySelecting&&isNil(this.startMark)&&isNil(this.endMark)||(this.currentlySelecting=!1,this.endMark=this.startMark=null,this.drawNew(),this.changed())};
StringMorph.prototype.deleteSelection=function(){var a=this.text;var b=Math.min(this.startMark,this.endMark);var c=Math.max(this.startMark,this.endMark);this.text=a.slice(0,b)+a.slice(c);this.changed();this.clearSelection()};StringMorph.prototype.selectAll=function(){var a;this.isEditable&&(this.startMark=0,(a=this.root().cursor)&&a.gotoSlot(this.text.length),this.endMark=this.text.length,this.drawNew(),this.changed())};
StringMorph.prototype.mouseDownLeft=function(a){16===this.world().currentKey?this.shiftClick(a):this.isEditable?this.clearSelection():this.escalateEvent("mouseDownLeft",a)};StringMorph.prototype.shiftClick=function(a){var b=this.root().cursor;b&&(this.startMark||(this.startMark=b.slot),b.gotoPos(a),this.endMark=b.slot,this.drawNew(),this.changed());this.currentlySelecting=!1;this.escalateEvent("mouseDownLeft",a)};
StringMorph.prototype.mouseClickLeft=function(a){var b;this.isEditable?(this.currentlySelecting||this.edit(),(b=this.root().cursor)&&b.gotoPos(a),this.currentlySelecting=!0):this.escalateEvent("mouseClickLeft",a)};StringMorph.prototype.mouseDoubleClick=function(a){var b=this.slotAt(a);this.isEditable?(this.edit(),b===this.text.length&&--b,this.text[b]&&isWordChar(this.text[b])?this.selectWordAt(b):this.text[b]?this.selectBetweenWordsAt(b):this.selectAll()):this.escalateEvent("mouseDoubleClick",a)};
StringMorph.prototype.selectWordAt=function(a){var b=this.root().cursor;0===a||isWordChar(this.text[a-1])?(b.gotoSlot(this.previousWordFrom(a)),this.startMark=b.slot,this.endMark=this.nextWordFrom(b.slot)):(b.gotoSlot(a),this.startMark=a,this.endMark=this.nextWordFrom(a));this.drawNew();this.changed()};
StringMorph.prototype.selectBetweenWordsAt=function(a){var b=this.root().cursor;b.gotoSlot(this.nextWordFrom(this.previousWordFrom(a)));for(this.endMark=this.startMark=b.slot;this.endMark<this.text.length&&!isWordChar(this.text[this.endMark]);)this.endMark+=1;this.drawNew();this.changed()};
StringMorph.prototype.enableSelecting=function(){this.mouseDownLeft=function(a){var b=this.root().cursor;b=b?b.target===this:!1;16===this.world().currentKey?this.shiftClick(a):(this.clearSelection(),this.isEditable&&!this.isDraggable&&(this.edit(),this.root().cursor.gotoPos(a),this.endMark=this.startMark=this.slotAt(a),this.currentlySelecting=!0,b||this.escalateEvent("mouseDownLeft",a)))};this.mouseMove=function(a){this.isEditable&&this.currentlySelecting&&!this.isDraggable&&(a=this.slotAt(a),a!==
this.endMark&&(this.endMark=a,this.drawNew(),this.changed()))}};StringMorph.prototype.disableSelecting=function(){this.mouseDownLeft=StringMorph.prototype.mouseDownLeft;delete this.mouseMove};TextMorph.prototype=new Morph;TextMorph.prototype.constructor=TextMorph;TextMorph.uber=Morph.prototype;function TextMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
TextMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l){this.text=a||(""===a?a:"TextMorph");this.words=[];this.lines=[];this.lineSlots=[];this.fontSize=b||12;this.fontName=h||MorphicPreferences.globalFontFamily;this.fontStyle=c||"sans-serif";this.isBold=d||!1;this.isItalic=e||!1;this.alignment=f||"left";this.shadowOffset=k||new Point(0,0);this.shadowColor=l||null;this.maxWidth=g||0;this.maxLineWidth=0;this.backgroundColor=null;this.isEditable=!1;this.receiver=null;this.isScrollable=!0;this.currentlySelecting=
!1;this.endMark=this.startMark=0;this.markedTextColor=new Color(255,255,255);this.markedBackgoundColor=new Color(60,60,120);TextMorph.uber.init.call(this);this.color=new Color(0,0,0);this.noticesTransparentClick=!0;this.drawNew()};TextMorph.prototype.toString=function(){return'a TextMorph("'+this.text.slice(0,30)+'...")'};TextMorph.prototype.font=StringMorph.prototype.font;
TextMorph.prototype.parse=function(){var a=this,b=this.text.split("\n"),c=newCanvas().getContext("2d"),d="",e,f,g=0;c.font=this.font();this.maxLineWidth=0;this.lines=[];this.lineSlots=[0];this.words=[];b.forEach(function(b){a.words=a.words.concat(b.split(" "));a.words.push("\n")});this.words.forEach(function(b){"\n"===b?(a.lines.push(d),a.lineSlots.push(g),a.maxLineWidth=Math.max(a.maxLineWidth,c.measureText(d).width),d=""):(0<a.maxWidth?(e=d+b+" ",f=c.measureText(e).width,f>a.maxWidth?(a.lines.push(d),
a.lineSlots.push(g),a.maxLineWidth=Math.max(a.maxLineWidth,c.measureText(d).width),d=b+" "):d=e):d=d+b+" ",g+=b.length+1)})};
TextMorph.prototype.drawNew=function(){var a;this.image=newCanvas();var b=this.image.getContext("2d");b.font=this.font();this.parse();var c=Math.abs(this.shadowOffset.x);var d=Math.abs(this.shadowOffset.y);b=this.lines.length*(fontHeight(this.fontSize)+d);this.bounds=0===this.maxWidth?this.bounds.origin.extent(new Point(this.maxLineWidth+c,b)):this.bounds.origin.extent(new Point(this.maxWidth+c,b));this.image.width=this.width();this.image.height=this.height();b=this.image.getContext("2d");b.font=
this.font();b.textAlign="left";b.textBaseline="bottom";this.backgroundColor&&(b.fillStyle=this.backgroundColor.toString(),b.fillRect(0,0,this.width(),this.height()));if(this.shadowColor){var e=Math.max(this.shadowOffset.x,0);var f=Math.max(this.shadowOffset.y,0);b.fillStyle=this.shadowColor.toString();for(a=0;a<this.lines.length;a+=1){var g=this.lines[a];var h=b.measureText(g).width+c;h="right"===this.alignment?this.width()-h:"center"===this.alignment?(this.width()-h)/2:0;var k=(a+1)*(fontHeight(this.fontSize)+
d)-d;b.fillText(g,h+e,k+f)}}e=Math.abs(Math.min(this.shadowOffset.x,0));f=Math.abs(Math.min(this.shadowOffset.y,0));b.fillStyle=this.color.toString();for(a=0;a<this.lines.length;a+=1)g=this.lines[a],h=b.measureText(g).width+c,h="right"===this.alignment?this.width()-h:"center"===this.alignment?(this.width()-h)/2:0,k=(a+1)*(fontHeight(this.fontSize)+d)-d,b.fillText(g,h+e,k+f);a=Math.min(this.startMark,this.endMark);for(d=Math.max(this.startMark,this.endMark);a<d;a+=1)c=this.slotPosition(a).subtract(this.position()),
g=this.text.charAt(a),b.fillStyle=this.markedBackgoundColor.toString(),b.fillRect(c.x,c.y,b.measureText(g).width+1,fontHeight(this.fontSize)),b.fillStyle=this.markedTextColor.toString(),b.fillText(g,c.x,c.y+fontHeight(this.fontSize));this.parent&&this.parent.layoutChanged&&this.parent.layoutChanged()};TextMorph.prototype.setExtent=function(a){this.maxWidth=Math.max(a.x,0);this.changed();this.drawNew()};
TextMorph.prototype.columnRow=function(a){var b,c;for(b=0;b<this.lines.length;b+=1){var d=this.lineSlots[b];for(c=0;c<this.lines[b].length;c+=1){if(d===a)return new Point(c,b);d+=1}}return new Point(this.lines[this.lines.length-1].length-1,this.lines.length-1)};
TextMorph.prototype.slotPosition=function(a){a=this.columnRow(a);var b=this.image.getContext("2d"),c=Math.abs(this.shadowOffset.y),d=0,e;c=a.y*(fontHeight(this.fontSize)+c);for(e=0;e<a.x;e+=1)d+=b.measureText(this.lines[a.y][e]).width;a=this.left()+d;b=this.top()+c;return new Point(a,b)};
TextMorph.prototype.slotAt=function(a){for(var b=0,c=0,d=0,e=Math.abs(this.shadowOffset.y),f=this.image.getContext("2d");a.y-this.top()>(fontHeight(this.fontSize)+e)*c;)c+=1;for(c=Math.max(c,1);a.x-this.left()>b;)b+=f.measureText(this.lines[c-1][d]).width,d+=1;return a.x-this.left()>b-f.measureText(this.lines[c-1][d]).width/2?this.lineSlots[Math.max(c-1,0)]+d:this.lineSlots[Math.max(c-1,0)]+d-1};
TextMorph.prototype.upFrom=function(a){var b=this.columnRow(a);if(1>b.y)return a;a=this.lines[b.y-1];return a.length<b.x-1?this.lineSlots[b.y-1]+a.length:this.lineSlots[b.y-1]+b.x};TextMorph.prototype.downFrom=function(a){var b=this.columnRow(a);if(b.y>this.lines.length-2)return a;a=this.lines[b.y+1];return a.length<b.x-1?this.lineSlots[b.y+1]+a.length:this.lineSlots[b.y+1]+b.x};TextMorph.prototype.startOfLine=function(a){return this.lineSlots[this.columnRow(a).y]};
TextMorph.prototype.endOfLine=function(a){return this.startOfLine(a)+this.lines[this.columnRow(a).y].length-1};TextMorph.prototype.previousWordFrom=StringMorph.prototype.previousWordFrom;TextMorph.prototype.nextWordFrom=StringMorph.prototype.nextWordFrom;TextMorph.prototype.edit=StringMorph.prototype.edit;TextMorph.prototype.selection=StringMorph.prototype.selection;TextMorph.prototype.selectionStartSlot=StringMorph.prototype.selectionStartSlot;TextMorph.prototype.clearSelection=StringMorph.prototype.clearSelection;
TextMorph.prototype.deleteSelection=StringMorph.prototype.deleteSelection;TextMorph.prototype.selectAll=StringMorph.prototype.selectAll;TextMorph.prototype.mouseDownLeft=StringMorph.prototype.mouseDownLeft;TextMorph.prototype.shiftClick=StringMorph.prototype.shiftClick;TextMorph.prototype.mouseClickLeft=StringMorph.prototype.mouseClickLeft;TextMorph.prototype.mouseDoubleClick=StringMorph.prototype.mouseDoubleClick;TextMorph.prototype.selectWordAt=StringMorph.prototype.selectWordAt;
TextMorph.prototype.selectBetweenWordsAt=StringMorph.prototype.selectBetweenWordsAt;TextMorph.prototype.enableSelecting=StringMorph.prototype.enableSelecting;TextMorph.prototype.disableSelecting=StringMorph.prototype.disableSelecting;TextMorph.prototype.selectAllAndEdit=function(){this.edit();this.selectAll()};
TextMorph.prototype.developersMenu=function(){var a=TextMorph.uber.developersMenu.call(this);a.addLine();a.addItem("edit","edit");a.addItem("font size...",function(){this.prompt(a.title+"\nfont\nsize:",this.setFontSize,this,this.fontSize.toString(),null,6,100,!0)},"set this Text's\nfont point size");"left"!==this.alignment&&a.addItem("align left","setAlignmentToLeft");"right"!==this.alignment&&a.addItem("align right","setAlignmentToRight");"center"!==this.alignment&&a.addItem("align center","setAlignmentToCenter");
a.addLine();"serif"!==this.fontStyle&&a.addItem("serif","setSerif");"sans-serif"!==this.fontStyle&&a.addItem("sans-serif","setSansSerif");this.isBold?a.addItem("normal weight","toggleWeight"):a.addItem("bold","toggleWeight");this.isItalic?a.addItem("normal style","toggleItalic"):a.addItem("italic","toggleItalic");return a};TextMorph.prototype.setAlignmentToLeft=function(){this.alignment="left";this.drawNew();this.changed()};
TextMorph.prototype.setAlignmentToRight=function(){this.alignment="right";this.drawNew();this.changed()};TextMorph.prototype.setAlignmentToCenter=function(){this.alignment="center";this.drawNew();this.changed()};TextMorph.prototype.toggleIsDraggable=StringMorph.prototype.toggleIsDraggable;TextMorph.prototype.toggleWeight=StringMorph.prototype.toggleWeight;TextMorph.prototype.toggleItalic=StringMorph.prototype.toggleItalic;TextMorph.prototype.setSerif=StringMorph.prototype.setSerif;
TextMorph.prototype.setSansSerif=StringMorph.prototype.setSansSerif;TextMorph.prototype.setText=StringMorph.prototype.setText;TextMorph.prototype.setFontSize=StringMorph.prototype.setFontSize;TextMorph.prototype.numericalSetters=StringMorph.prototype.numericalSetters;
TextMorph.prototype.evaluationMenu=function(){var a=new MenuMorph(this,null);a.addItem("do it","doIt","evaluate the\nselected expression");a.addItem("show it","showIt","evaluate the\nselected expression\nand show the result");a.addItem("inspect it","inspectIt","evaluate the\nselected expression\nand inspect the result");a.addLine();a.addItem("select all","selectAllAndEdit");return a};TextMorph.prototype.setReceiver=function(a){this.receiver=a;this.customContextMenu=this.evaluationMenu()};
TextMorph.prototype.doIt=function(){this.receiver.evaluateString(this.selection());this.edit()};TextMorph.prototype.showIt=function(){var a=this.receiver.evaluateString(this.selection());null!==a&&this.inform(a)};TextMorph.prototype.inspectIt=function(){var a=this.receiver.evaluateString(this.selection()),b=this.world();isObject(a)&&(a=new InspectorMorph(a),a.setPosition(b.hand.position()),a.keepWithin(b),b.add(a),a.changed())};TriggerMorph.prototype=new Morph;TriggerMorph.prototype.constructor=TriggerMorph;
TriggerMorph.uber=Morph.prototype;function TriggerMorph(a,b,c,d,e,f,g,h,k,l,m){this.init(a,b,c,d,e,f,g,h,k,l,m)}
TriggerMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l,m){this.target=a||null;this.action=b||null;this.doubleClickAction=m||null;this.environment=f||null;this.labelString=c||null;this.label=null;this.hint=g||null;this.schedule=null;this.fontSize=d||MorphicPreferences.menuFontSize;this.fontStyle=e||"sans-serif";this.highlightColor=new Color(192,192,192);this.pressColor=new Color(128,128,128);this.labelColor=h||new Color(0,0,0);this.labelBold=k||!1;this.labelItalic=l||!1;TriggerMorph.uber.init.call(this);
this.color=new Color(255,255,255);this.drawNew()};TriggerMorph.prototype.drawNew=function(){this.createBackgrounds();null!==this.labelString&&this.createLabel()};
TriggerMorph.prototype.createBackgrounds=function(){var a=this.extent();this.normalImage=newCanvas(a);var b=this.normalImage.getContext("2d");b.fillStyle=this.color.toString();b.fillRect(0,0,a.x,a.y);this.highlightImage=newCanvas(a);b=this.highlightImage.getContext("2d");b.fillStyle=this.highlightColor.toString();b.fillRect(0,0,a.x,a.y);this.pressImage=newCanvas(a);b=this.pressImage.getContext("2d");b.fillStyle=this.pressColor.toString();b.fillRect(0,0,a.x,a.y);this.image=this.normalImage};
TriggerMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();this.label=new StringMorph(this.labelString,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic,!1,null,null,this.labelColor);this.label.setPosition(this.center().subtract(this.label.extent().floorDivideBy(2)));this.add(this.label)};
TriggerMorph.prototype.trigger=function(){this.schedule&&(this.schedule.isActive=!1);if("function"===typeof this.target)"function"===typeof this.action?this.target.call(this.environment,this.action.call(),this):this.target.call(this.environment,this.action,this);else if("function"===typeof this.action)this.action.call(this.target);else this.target[this.action]()};
TriggerMorph.prototype.triggerDoubleClick=function(){if(this.doubleClickAction)if(this.schedule&&(this.schedule.isActive=!1),"function"===typeof this.target)"function"===typeof this.doubleClickAction?this.target.call(this.environment,this.doubleClickAction.call(),this):this.target.call(this.environment,this.doubleClickAction,this);else if("function"===typeof this.doubleClickAction)this.doubleClickAction.call(this.target);else this.target[this.doubleClickAction]()};
TriggerMorph.prototype.mouseEnter=function(){var a=this.hint instanceof Function?this.hint():this.hint;this.image=this.highlightImage;this.changed();a&&this.bubbleHelp(a)};TriggerMorph.prototype.mouseLeave=function(){this.image=this.normalImage;this.changed();this.schedule&&(this.schedule.isActive=!1);this.hint&&this.world().hand.destroyTemporaries()};TriggerMorph.prototype.mouseDownLeft=function(){this.image=this.pressImage;this.changed()};
TriggerMorph.prototype.mouseClickLeft=function(){this.image=this.highlightImage;this.changed();this.trigger()};TriggerMorph.prototype.mouseDoubleClick=function(){this.triggerDoubleClick()};TriggerMorph.prototype.rootForGrab=function(){return this.isDraggable?TriggerMorph.uber.rootForGrab.call(this):null};TriggerMorph.prototype.bubbleHelp=function(a){var b=this.world(),c=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){c.popUpbubbleHelp(a)});b.animations.push(this.schedule)};
TriggerMorph.prototype.popUpbubbleHelp=function(a){(new SpeechBubbleMorph(localize(a),null,null,1)).popUp(this.world(),this.rightCenter().add(new Point(-8,0)))};MenuItemMorph.prototype=new TriggerMorph;MenuItemMorph.prototype.constructor=MenuItemMorph;MenuItemMorph.uber=TriggerMorph.prototype;function MenuItemMorph(a,b,c,d,e,f,g,h,k,l,m,n){this.shortcutString=n||null;this.shortcut=null;this.init(a,b,c,d,e,f,g,h,k,l,m)}
MenuItemMorph.prototype.createLabel=function(){this.label&&this.label.destroy();this.label=this.createLabelPart(this.labelString);this.add(this.label);var a=this.label.width();var b=this.label.height();this.shortcut&&this.shortcut.destroy();this.shortcutString&&(this.shortcut=this.createLabelPart(this.shortcutString),a+=this.shortcut.width()+4,b=Math.max(b,this.shortcut.height()),this.add(this.shortcut));this.silentSetExtent(new Point(a+8,b));this.fixLayout()};
MenuItemMorph.prototype.fixLayout=function(){var a=this.center();this.label.setCenter(a);this.label.setLeft(this.left()+4);this.shortcut&&(this.shortcut.setCenter(a),this.shortcut.setRight(this.right()-4))};
MenuItemMorph.prototype.createLabelPart=function(a){if(isString(a))return this.createLabelString(a);if(a instanceof Array){var b=new Morph;b.alpha=0;var c=this.createIcon(a[0]);b.add(c);a=this.createLabelString(a[1]);b.add(a);a.setCenter(c.center());a.setLeft(c.right()+4);b.bounds=c.bounds.merge(a.bounds);b.drawNew();return b}return this.createIcon(a)};
MenuItemMorph.prototype.createIcon=function(a){var b=new Morph;b.image=a instanceof Morph?a.fullImage():a;if(a instanceof Morph&&a.getShadow()){var c=b.image;b.image=newCanvas(a.fullBounds().extent().subtract(this.shadowBlur*(useBlurredShadows?1:2)));b.image.getContext("2d").drawImage(c,0,0)}b.silentSetWidth(b.image.width);b.silentSetHeight(b.image.height);return b};
MenuItemMorph.prototype.createLabelString=function(a){a=new TextMorph(a,this.fontSize,this.fontStyle,this.labelBold,this.labelItalic);a.setColor(this.labelColor);return a};MenuItemMorph.prototype.mouseEnter=function(){var a=this.parentThatIsA(MenuMorph);this.isShowingSubmenu()||(a&&a.closeSubmenu(),this.isListItem()||(this.image=this.highlightImage,this.changed()),this.action instanceof MenuMorph?this.delaySubmenu():this.hint&&this.bubbleHelp(this.hint))};
MenuItemMorph.prototype.mouseLeave=function(){this.isListItem()||(this.isShowingSubmenu()?this.image=this.highlightImage:this.image=this.normalImage,this.changed());this.schedule&&(this.schedule.isActive=!1);this.hint&&this.world().hand.destroyTemporaries()};MenuItemMorph.prototype.mouseDownLeft=function(a){this.isListItem()&&(this.parent.unselectAllItems(),this.escalateEvent("mouseDownLeft",a));this.image=this.pressImage;this.changed()};
MenuItemMorph.prototype.mouseMove=function(){this.isListItem()&&this.escalateEvent("mouseMove")};MenuItemMorph.prototype.mouseClickLeft=function(){this.action instanceof MenuMorph?this.popUpSubmenu():(this.isListItem()||(this.parent.closeRootMenu(),this.world().activeMenu=null),this.trigger())};MenuItemMorph.prototype.isListItem=function(){return this.parent?this.parent.isListContents:!1};MenuItemMorph.prototype.isSelectedListItem=function(){return this.isListItem()?this.image===this.pressImage:!1};
MenuItemMorph.prototype.isShowingSubmenu=function(){var a=this.parentThatIsA(MenuMorph);return a&&this.action instanceof MenuMorph?a.submenu===this.action:!1};MenuItemMorph.prototype.delaySubmenu=function(){var a=this.world(),b=this;this.schedule=new Animation(nop,nop,0,500,nop,function(){b.popUpSubmenu()});a.animations.push(this.schedule)};
MenuItemMorph.prototype.popUpSubmenu=function(){var a=this.parentThatIsA(MenuMorph);this.action instanceof MenuMorph&&(this.action.drawNew(),this.action.setPosition(this.topRight().subtract(new Point(0,5))),this.action.addShadow(new Point(2,2),80),this.action.keepWithin(this.world()),1>this.action.items.length&&!this.action.title||(a.add(this.action),a.submenu=this.action,a.submenu.world=a.world,this.action.fullChanged()))};FrameMorph.prototype=new Morph;FrameMorph.prototype.constructor=FrameMorph;
FrameMorph.uber=Morph.prototype;function FrameMorph(a){this.init(a)}FrameMorph.prototype.init=function(a){this.scrollFrame=a||null;FrameMorph.uber.init.call(this);this.color=new Color(255,250,245);this.drawNew();this.acceptsDrops=!0;this.scrollFrame&&(this.noticesTransparentClick=this.isDraggable=!1,this.alpha=0)};FrameMorph.prototype.fullBounds=function(){var a=this.getShadow();return null!==a?this.bounds.merge(a.bounds):this.bounds};FrameMorph.prototype.fullImage=function(){return this.image};
FrameMorph.prototype.fullDrawOn=function(a,b){if(!this.isVisible)return null;var c=b||this.fullBounds();var d=this.bounds.intersect(c);if(!d.extent().gt(new Point(0,0)))return null;this.drawOn(a,d);this.children.forEach(function(b){b instanceof ShadowMorph?b.fullDrawOn(a,c):b.fullDrawOn(a,d)})};
FrameMorph.prototype.topMorphAt=function(a){var b,c;if(!this.isVisible||!this.bounds.containsPoint(a))return null;for(b=this.children.length-1;0<=b;--b)if(c=this.children[b].topMorphAt(a))return c;return this.noticesTransparentClick||!this.isTransparentAt(a)?this:null};FrameMorph.prototype.submorphBounds=function(){var a=null;0<this.children.length&&(a=this.children[0].bounds,this.children.forEach(function(b){a=a.merge(b.fullBounds())}));return a};
FrameMorph.prototype.keepInScrollFrame=function(){if(null===this.scrollFrame)return null;this.left()>this.scrollFrame.left()&&this.moveBy(new Point(this.scrollFrame.left()-this.left(),0));this.right()<this.scrollFrame.right()&&this.moveBy(new Point(this.scrollFrame.right()-this.right(),0));this.top()>this.scrollFrame.top()&&this.moveBy(new Point(0,this.scrollFrame.top()-this.top()));this.bottom()<this.scrollFrame.bottom()&&this.moveBy(0,new Point(this.scrollFrame.bottom()-this.bottom(),0))};
FrameMorph.prototype.adjustBounds=function(){var a=this;if(null===this.scrollFrame)return null;var b=(b=this.submorphBounds())&&!this.scrollFrame.isTextLineWrapping?b.expandBy(this.scrollFrame.padding).growBy(this.scrollFrame.growth).merge(this.scrollFrame.bounds):this.scrollFrame.bounds.copy();this.bounds.eq(b)||(this.bounds=b,this.drawNew(),this.keepInScrollFrame());this.scrollFrame.isTextLineWrapping&&this.children.forEach(function(b){b instanceof TextMorph&&(b.setWidth(a.width()),a.setHeight(Math.max(b.height(),
a.scrollFrame.height())))});this.scrollFrame.adjustScrollBars()};FrameMorph.prototype.reactToDropOf=function(){this.adjustBounds()};FrameMorph.prototype.reactToGrabOf=function(){this.adjustBounds()};FrameMorph.prototype.developersMenu=function(){var a=FrameMorph.uber.developersMenu.call(this);0<this.children.length&&(a.addLine(),a.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"));return a};
FrameMorph.prototype.keepAllSubmorphsWithin=function(){var a=this;this.children.forEach(function(b){b.keepWithin(a)})};ScrollFrameMorph.prototype=new FrameMorph;ScrollFrameMorph.prototype.constructor=ScrollFrameMorph;ScrollFrameMorph.uber=FrameMorph.prototype;function ScrollFrameMorph(a,b,c){this.init(a,b,c)}
ScrollFrameMorph.prototype.init=function(a,b,c){var d=this;ScrollFrameMorph.uber.init.call(this);this.scrollBarSize=b||MorphicPreferences.scrollBarSize;this.autoScrollTrigger=null;this.hasVelocity=this.isScrollingByDragging=this.enableAutoScrolling=!0;this.growth=this.padding=0;this.isTextLineWrapping=!1;this.contents=a||new FrameMorph(this);this.add(this.contents);this.hBar=new SliderMorph(null,null,null,null,"horizontal",c);this.hBar.setHeight(this.scrollBarSize);this.hBar.action=function(a){d.contents.setPosition(new Point(d.left()-
a,d.contents.position().y))};this.hBar.isDraggable=!1;this.add(this.hBar);this.vBar=new SliderMorph(null,null,null,null,"vertical",c);this.vBar.setWidth(this.scrollBarSize);this.vBar.action=function(a){d.contents.setPosition(new Point(d.contents.position().x,d.top()-a))};this.vBar.isDraggable=!1;this.add(this.vBar);this.toolBar=null};
ScrollFrameMorph.prototype.adjustScrollBars=function(){var a=this.width()-this.scrollBarSize,b=this.height()-this.scrollBarSize;this.changed();this.contents.width()>this.width()+MorphicPreferences.scrollBarSize?(this.hBar.show(),this.hBar.width()!==a&&this.hBar.setWidth(a),this.hBar.setPosition(new Point(this.left(),this.bottom()-this.hBar.height())),this.hBar.start=0,this.hBar.stop=this.contents.width()-this.width(),this.hBar.size=this.width()/this.contents.width()*this.hBar.stop,this.hBar.value=
this.left()-this.contents.left(),this.hBar.drawNew()):this.hBar.hide();this.contents.height()>this.height()+this.scrollBarSize?(this.vBar.show(),this.vBar.height()!==b&&this.vBar.setHeight(b),this.vBar.setPosition(new Point(this.right()-this.vBar.width(),this.top())),this.vBar.start=0,this.vBar.stop=this.contents.height()-this.height(),this.vBar.size=this.height()/this.contents.height()*this.vBar.stop,this.vBar.value=this.top()-this.contents.top(),this.vBar.drawNew()):this.vBar.hide();this.adjustToolBar()};
ScrollFrameMorph.prototype.adjustToolBar=function(){this.toolBar&&(this.toolBar.setTop(this.top()+3),this.toolBar.setRight((this.vBar.isVisible?this.vBar.left():this.right())-3))};ScrollFrameMorph.prototype.addContents=function(a){this.contents.add(a);this.contents.adjustBounds()};ScrollFrameMorph.prototype.setContents=function(a){this.contents.children.forEach(function(a){a.destroy()});this.contents.children=[];a.setPosition(this.position().add(this.padding+2));this.addContents(a)};
ScrollFrameMorph.prototype.setExtent=function(a){this.isTextLineWrapping&&this.contents.setPosition(this.position().copy());ScrollFrameMorph.uber.setExtent.call(this,a);this.contents.adjustBounds()};ScrollFrameMorph.prototype.scrollX=function(a){var b=this.contents.left(),c=this.left(),d=this.contents.width(),e=this.right();a=b+a;a+d<e&&(a=e-d);a>c&&(a=c);a!==b&&this.contents.setLeft(a)};
ScrollFrameMorph.prototype.scrollY=function(a){var b=this.contents.top(),c=this.top(),d=this.contents.height(),e=this.bottom();a=b+a;a+d<e&&(a=e-d);a>c&&(a=c);a!==b&&this.contents.setTop(a)};ScrollFrameMorph.prototype.step=nop;
ScrollFrameMorph.prototype.mouseDownLeft=function(a){if(!this.isScrollingByDragging)return null;var b=this.root().hand,c=a,d=this,e=0,f=0;this.step=function(){if(b.mouseButton&&0===b.children.length&&d.bounds.containsPoint(b.bounds.origin)){if(b.grabPosition&&b.grabPosition.distanceTo(b.position())<=MorphicPreferences.grabThreshold)return null;var a=b.bounds.origin;e=a.x-c.x;0!==e&&d.scrollX(e);f=a.y-c.y;0!==f&&d.scrollY(f);c=a}else d.hasVelocity?.5>Math.abs(e)&&.5>Math.abs(f)?d.step=function(){nop()}:
(e*=.8,d.scrollX(Math.round(e)),f*=.8,d.scrollY(Math.round(f))):d.step=function(){nop()};this.adjustScrollBars()}};
ScrollFrameMorph.prototype.startAutoScrolling=function(){var a=this,b=3*MorphicPreferences.scrollBarSize,c=this.world(),d,e;if(!c)return null;var f=c.hand;this.autoScrollTrigger||(this.autoScrollTrigger=Date.now());this.step=function(){e=f.bounds.origin;d=a.bounds.insetBy(b);a.bounds.containsPoint(e)&&!d.containsPoint(e)&&0<f.children.length?a.autoScroll(e):(a.step=function(){nop()},a.autoScrollTrigger=null)}};
ScrollFrameMorph.prototype.autoScroll=function(a){if(500>Date.now()-this.autoScrollTrigger)return null;var b=3*MorphicPreferences.scrollBarSize;var c=this.topLeft().extent(new Point(this.width(),b));c.containsPoint(a)&&this.scrollY(b-(a.y-this.top()));c=this.topLeft().extent(new Point(b,this.height()));c.containsPoint(a)&&this.scrollX(b-(a.x-this.left()));c=(new Point(this.right()-b,this.top())).extent(new Point(b,this.height()));c.containsPoint(a)&&this.scrollX(-(b-(this.right()-a.x)));c=(new Point(this.left(),
this.bottom()-b)).extent(new Point(this.width(),b));c.containsPoint(a)&&this.scrollY(-(b-(this.bottom()-a.y)));this.adjustScrollBars()};
ScrollFrameMorph.prototype.scrollCursorIntoView=function(a){var b=a.target,c=b.position().subtract(this.contents.position()),d=this.top()+this.padding,e=this.bottom()-this.padding;this.contents.setExtent(b.extent().add(c).add(this.padding));a.top()<d?(this.contents.setTop(this.contents.top()+d-a.top()),a.setTop(d)):a.bottom()>e&&(this.contents.setBottom(this.contents.bottom()+e-a.bottom()),a.setBottom(e));this.adjustScrollBars()};
ScrollFrameMorph.prototype.mouseScroll=function(a,b){a&&this.scrollY(a*MorphicPreferences.mouseScrollAmount);b&&this.scrollX(b*MorphicPreferences.mouseScrollAmount);this.adjustScrollBars()};
ScrollFrameMorph.prototype.updateReferences=function(a){var b=this;ScrollFrameMorph.uber.updateReferences.call(this,a);this.hBar&&(this.hBar.action=function(a){b.contents.setPosition(new Point(b.left()-a,b.contents.position().y))});this.vBar&&(this.vBar.action=function(a){b.contents.setPosition(new Point(b.contents.position().x,b.top()-a))})};
ScrollFrameMorph.prototype.developersMenu=function(){var a=ScrollFrameMorph.uber.developersMenu.call(this);this.isTextLineWrapping?a.addItem("auto line wrap off...","toggleTextLineWrapping","turn automatic\nline wrapping\noff"):a.addItem("auto line wrap on...","toggleTextLineWrapping","enable automatic\nline wrapping");return a};ScrollFrameMorph.prototype.toggleTextLineWrapping=function(){this.isTextLineWrapping=!this.isTextLineWrapping};ListMorph.prototype=new ScrollFrameMorph;
ListMorph.prototype.constructor=ListMorph;ListMorph.uber=ScrollFrameMorph.prototype;function ListMorph(a,b,c,d){this.init(a||[],b||function(a){return isString(a)?a:a.toSource?a.toSource():a.toString()},c||[],d)}
ListMorph.prototype.init=function(a,b,c,d){ListMorph.uber.init.call(this);this.contents.acceptsDrops=!1;this.color=new Color(255,255,255);this.hBar.alpha=.6;this.vBar.alpha=.6;this.elements=a||[];this.labelGetter=b;this.format=c;this.action=this.active=this.selected=this.listContents=null;this.doubleClickAction=d||null;this.acceptsDrops=!1;this.buildListContents()};
ListMorph.prototype.buildListContents=function(){var a=this;this.listContents&&this.listContents.destroy();this.listContents=new MenuMorph(this.select,null,this);0===this.elements.length&&(this.elements=["(empty)"]);this.elements.forEach(function(b){var c=null,d=!1,e=!1;a.format.forEach(function(a){a[1].call(null,b)&&("bold"===a[0]?d=!0:"italic"===a[0]?e=!0:c=a[0])});a.listContents.addItem(a.labelGetter(b),b,null,c,d,e,a.doubleClickAction)});this.listContents.isListContents=!0;this.listContents.drawNew();
this.listContents.setPosition(this.contents.position());this.addContents(this.listContents)};ListMorph.prototype.select=function(a,b){isNil(a)||(this.selected=a,this.active=b,this.action&&this.action.call(null,a))};
ListMorph.prototype.setExtent=function(a){var b=this.listContents.bounds,c=this.bounds.origin.copy().corner(this.bounds.origin.add(a));c.right()>b.right()&&c.width()<=b.width()&&this.listContents.setRight(c.right());c.bottom()>b.bottom()&&c.height()<=b.height()&&this.listContents.setBottom(c.bottom());ListMorph.uber.setExtent.call(this,a)};ListMorph.prototype.activeIndex=function(){return this.listContents.children.indexOf(this.active)};
ListMorph.prototype.activateIndex=function(a){if(a=this.listContents.children[a])a.image=a.pressImage,a.changed(),a.trigger()};StringFieldMorph.prototype=new FrameMorph;StringFieldMorph.prototype.constructor=StringFieldMorph;StringFieldMorph.uber=FrameMorph.prototype;function StringFieldMorph(a,b,c,d,e,f,g){this.init(a||"",b||100,c||12,d||"sans-serif",e||!1,f||!1,g)}
StringFieldMorph.prototype.init=function(a,b,c,d,e,f,g){this.defaultContents=a;this.minWidth=b;this.fontSize=c;this.fontStyle=d;this.isBold=e;this.isItalic=f;this.isNumeric=g||!1;this.text=null;StringFieldMorph.uber.init.call(this);this.color=new Color(255,255,255);this.isEditable=!0;this.acceptsDrops=!1;this.drawNew()};
StringFieldMorph.prototype.drawNew=function(){var a=this.text?this.string():this.defaultContents;this.text=null;this.children.forEach(function(a){a.destroy()});this.children=[];this.text=new StringMorph(a,this.fontSize,this.fontStyle,this.isBold,this.isItalic,this.isNumeric);this.text.isNumeric=this.isNumeric;this.text.setPosition(this.bounds.origin.copy());this.text.isEditable=this.isEditable;this.text.isDraggable=!1;this.text.enableSelecting();this.silentSetExtent(new Point(Math.max(this.width(),
this.minWidth),this.text.height()));StringFieldMorph.uber.drawNew.call(this);this.add(this.text)};StringFieldMorph.prototype.string=function(){return this.text.text};StringFieldMorph.prototype.mouseClickLeft=function(a){this.isEditable?this.text.edit():this.escalateEvent("mouseClickLeft",a)};BouncerMorph.prototype=new Morph;BouncerMorph.prototype.constructor=BouncerMorph;BouncerMorph.uber=Morph.prototype;function BouncerMorph(){this.init()}
BouncerMorph.prototype.init=function(a,b){BouncerMorph.uber.init.call(this);this.fps=50;this.isStopped=!1;this.type=a||"vertical";this.direction="vertical"===this.type?"down":"right";this.speed=b||1};BouncerMorph.prototype.moveUp=function(){this.moveBy(new Point(0,-this.speed))};BouncerMorph.prototype.moveDown=function(){this.moveBy(new Point(0,this.speed))};BouncerMorph.prototype.moveRight=function(){this.moveBy(new Point(this.speed,0))};
BouncerMorph.prototype.moveLeft=function(){this.moveBy(new Point(-this.speed,0))};
BouncerMorph.prototype.step=function(){this.isStopped||("vertical"===this.type?("down"===this.direction?this.moveDown():this.moveUp(),this.fullBounds().top()<this.parent.top()&&"up"===this.direction&&(this.direction="down"),this.fullBounds().bottom()>this.parent.bottom()&&"down"===this.direction&&(this.direction="up")):"horizontal"===this.type&&("right"===this.direction?this.moveRight():this.moveLeft(),this.fullBounds().left()<this.parent.left()&&"left"===this.direction&&(this.direction="right"),
this.fullBounds().right()>this.parent.right()&&"right"===this.direction&&(this.direction="left")))};HandMorph.prototype=new Morph;HandMorph.prototype.constructor=HandMorph;HandMorph.uber=Morph.prototype;function HandMorph(a){this.init(a)}
HandMorph.prototype.init=function(a){HandMorph.uber.init.call(this,!0);this.bounds=new Rectangle;this.world=a;this.mouseButton=null;this.mouseOverList=[];this.grabOrigin=this.grabPosition=this.morphToGrab=null;this.temporaries=[];this.touchHoldTimeout=null;this.contextMenuEnabled=!1};HandMorph.prototype.changed=function(){if(null!==this.world){var a=this.fullBounds();a.extent().eq(new Point)||this.world.broken.push(a.spread())}};HandMorph.prototype.fullChanged=HandMorph.prototype.changed;
HandMorph.prototype.morphAtPointer=function(){return this.world.topMorphAt(this.bounds.origin)||this.world};HandMorph.prototype.allMorphsAtPointer=function(){var a=this;return this.world.allChildren().filter(function(b){return b.isVisible&&b.visibleBounds().containsPoint(a.bounds.origin)})};HandMorph.prototype.dropTargetFor=function(a){for(var b=this.morphAtPointer();!b.wantsDropOf(a);)b=b.parent;return b};
HandMorph.prototype.grab=function(a){var b=a.parent;if(a instanceof WorldMorph)return null;0===this.children.length&&(this.world.stopEditing(),this.grabOrigin=a.situation(),a.addShadow(),a.prepareToBeGrabbed&&a.prepareToBeGrabbed(this),a.cachedFullImage=a.fullImageClassic(),a.cachedFullBounds=a.fullBounds(),this.add(a),this.changed(),b&&b.reactToGrabOf&&b.reactToGrabOf(a))};
HandMorph.prototype.drop=function(){if(0!==this.children.length){var a=this.children[0];var b=this.dropTargetFor(a);b=b.selectForEdit?b.selectForEdit():b;this.changed();b.add(a);a.cachedFullImage=null;a.cachedFullBounds=null;a.changed();a.removeShadow();this.children=[];this.setExtent(new Point);a.justDropped&&a.justDropped(this);b.reactToDropOf&&b.reactToDropOf(a,this)}};
HandMorph.prototype.processMouseDown=function(a){this.destroyTemporaries();this.contextMenuEnabled=!0;this.grabPosition=this.morphToGrab=null;if(0!==this.children.length)this.drop(),this.mouseButton=null;else{var b=this.morphAtPointer();this.world.activeMenu&&(contains(b.allParents(),this.world.activeMenu)?clearInterval(this.touchHoldTimeout):this.world.activeMenu.destroy());this.world.activeHandle&&b!==this.world.activeHandle&&this.world.activeHandle.destroy();this.world.cursor&&b!==this.world.cursor.target&&
this.world.stopEditing();b.mouseMove||(this.morphToGrab=b.rootForGrab(),this.grabPosition=this.bounds.origin.copy());2===a.button||a.ctrlKey?(this.mouseButton="right",a="mouseDownRight"):(this.mouseButton="left",a="mouseDownLeft");for(;!b[a];)b=b.parent;b[a](this.bounds.origin)}};
HandMorph.prototype.processTouchStart=function(a){var b=this;MorphicPreferences.isTouchDevice=!0;clearInterval(this.touchHoldTimeout);1===a.touches.length&&(this.touchHoldTimeout=setInterval(function(){b.processMouseDown({button:2});b.processMouseUp({button:2});a.preventDefault();clearInterval(b.touchHoldTimeout)},400),this.processMouseMove(a.touches[0]),this.processMouseDown({button:0}),a.preventDefault())};
HandMorph.prototype.processTouchMove=function(a){MorphicPreferences.isTouchDevice=!0;1===a.touches.length&&(this.processMouseMove(a.touches[0]),clearInterval(this.touchHoldTimeout))};HandMorph.prototype.processTouchEnd=function(a){MorphicPreferences.isTouchDevice=!0;clearInterval(this.touchHoldTimeout);nop(a);this.processMouseUp({button:0})};
HandMorph.prototype.processMouseUp=function(){var a=this.morphAtPointer(),b;this.destroyTemporaries();if(0!==this.children.length)this.drop();else{if("left"===this.mouseButton)var c="mouseClickLeft";else if(c="mouseClickRight",this.mouseButton&&this.contextMenuEnabled){var d=a;for(b=d.contextMenu();!b&&d.parent;)d=d.parent,b=d.contextMenu();b&&b.popUpAtHand(this.world)}for(;!a[c];)a=a.parent;a[c](this.bounds.origin)}this.mouseButton=null};
HandMorph.prototype.processDoubleClick=function(){var a=this.morphAtPointer();this.destroyTemporaries();if(0!==this.children.length)this.drop();else{for(;a&&!a.mouseDoubleClick;)a=a.parent;a&&a.mouseDoubleClick(this.bounds.origin)}this.mouseButton=null};
HandMorph.prototype.processMouseMove=function(a){var b=getDocumentPositionOf(this.world.worldCanvas),c=this;a=new Point(a.pageX-b.x,a.pageY-b.y);this.setPosition(a);var d=this.morphAtPointer().allParents();if(!this.children.length&&this.mouseButton){var e=this.morphAtPointer();b=e.rootForGrab();e.mouseMove&&(e.mouseMove(a,this.mouseButton),"right"===this.mouseButton&&(this.contextMenuEnabled=!1));"left"===this.mouseButton&&this.morphToGrab&&this.grabPosition.distanceTo(this.bounds.origin)>MorphicPreferences.grabThreshold&&
(this.setPosition(this.grabPosition),this.morphToGrab.isDraggable?(b=this.morphToGrab.selectForEdit?this.morphToGrab.selectForEdit():this.morphToGrab,this.grab(b)):this.morphToGrab.isTemplate&&(b=this.morphToGrab.fullCopy(),b.isTemplate=!1,b.isDraggable=!0,b.reactToTemplateCopy&&b.reactToTemplateCopy(),this.grab(b),this.grabOrigin=this.morphToGrab.situation()),this.setPosition(a))}this.mouseOverList.forEach(function(a){contains(d,a)||(a.mouseLeave&&a.mouseLeave(),a.mouseLeaveDragging&&c.mouseButton&&
a.mouseLeaveDragging())});d.forEach(function(a){contains(c.mouseOverList,a)||(a.mouseEnter&&a.mouseEnter(),a.mouseEnterDragging&&c.mouseButton&&a.mouseEnterDragging());0<c.children.length&&a instanceof ScrollFrameMorph&&a.enableAutoScrolling&&a.contents.allChildren().some(function(a){return a.wantsDropOf(c.children[0])})&&(a.bounds.insetBy(3*MorphicPreferences.scrollBarSize).containsPoint(c.bounds.origin)||a.startAutoScrolling())});this.mouseOverList=d};
HandMorph.prototype.processMouseScroll=function(a){for(var b=this.morphAtPointer();b&&!b.mouseScroll;)b=b.parent;b&&b.mouseScroll(a.detail/-3||(Object.prototype.hasOwnProperty.call(a,"wheelDeltaY")?a.wheelDeltaY/120:a.wheelDelta/120),a.wheelDeltaX/120||0)};
HandMorph.prototype.processDrop=function(a){function b(a){for(var b=new Image,c=new FileReader;!m.droppedSVG;)m=m.parent;b.onload=function(){m.droppedSVG(b,a.name)};c=new FileReader;c.onloadend=function(a){b.src=a.target.result};c.readAsDataURL(a)}function c(a){for(var b=new Image,c=new FileReader;!m.droppedImage;)m=m.parent;b.onload=function(){p=newCanvas(new Point(b.width,b.height),!0);p.getContext("2d").drawImage(b,0,0);m.droppedImage(p,a.name)};c=new FileReader;c.onloadend=function(a){b.src=a.target.result};
c.readAsDataURL(a)}function d(a){for(var b=new Audio,c=new FileReader;!m.droppedAudio;)m=m.parent;c.onloadend=function(c){b.src=c.target.result;m.droppedAudio(b,a.name)};c.readAsDataURL(a)}function e(a){for(var b=new FileReader;!m.droppedText;)m=m.parent;b.onloadend=function(b){m.droppedText(b.target.result,a.name)};b.readAsText(a)}function f(a){for(var b=new FileReader;!m.droppedBinary;)m=m.parent;b.onloadend=function(b){m.droppedBinary(b.target.result,a.name)};b.readAsArrayBuffer(a)}function g(a,
b){var c=new XMLHttpRequest;c.open("GET",a);c.onreadystatechange=function(){if(4===c.readyState)if(c.responseText)b(c.responseText);else throw Error("unable to retrieve "+a);};c.send()}function h(a){var b="";var c=a.indexOf('<img src="');if(-1===c)return null;for(c+=10;c<a.length;c+=1){var d=a[c];if('"'===d)return b;b=b.concat(d)}return null}var k=a instanceof FileList?a:a.target.files||a.dataTransfer.files,l=a.dataTransfer?a.dataTransfer.getData("URL"):null;a=a.dataTransfer?a.dataTransfer.getData("Text/HTML"):
null;var m=this.morphAtPointer(),n=new Image,p,q;if(0<k.length)for(q=0;q<k.length;q+=1)a=k[q],-1===a.type.indexOf("svg")||MorphicPreferences.rasterizeSVGs?0===a.type.indexOf("image")?c(a):0===a.type.indexOf("audio")?d(a):0===a.type.indexOf("text")?e(a):f(a):b(a);else if(l)if(k=l.slice(l.lastIndexOf(".")+1).toLowerCase(),contains(["gif","png","jpg","jpeg","bmp"],k)){for(;!m.droppedImage;)m=m.parent;n=new Image;n.onload=function(){p=newCanvas(new Point(n.width,n.height),!0);p.getContext("2d").drawImage(n,
0,0);m.droppedImage(p)};n.src=l}else{if("svg"===k&&!MorphicPreferences.rasterizeSVGs){for(;!m.droppedSVG;)m=m.parent;g(l,function(a){var b=new Image;b.onload=function(){m.droppedSVG(b,l.slice(l.lastIndexOf("/")+1,l.lastIndexOf(".")))};b.src="data:image/svg+xml;utf8,"+encodeURIComponent(a)})}}else if(a){for(;!m.droppedImage;)m=m.parent;n=new Image;n.onload=function(){p=newCanvas(new Point(n.width,n.height),!0);p.getContext("2d").drawImage(n,0,0);m.droppedImage(p)};if(k=h(a))n.src=k}};
HandMorph.prototype.destroyTemporaries=function(){var a=this;this.temporaries.forEach(function(b){b.isClickable&&b.bounds.containsPoint(a.position())||(b.destroy(),a.temporaries.splice(a.temporaries.indexOf(b),1))})};WorldMorph.prototype=new FrameMorph;WorldMorph.prototype.constructor=WorldMorph;WorldMorph.uber=FrameMorph.prototype;function WorldMorph(a,b){this.init(a,b)}
WorldMorph.prototype.init=function(a,b){WorldMorph.uber.init.call(this);this.color=new Color(205,205,205);this.alpha=1;this.bounds=new Rectangle(0,0,a.width,a.height);this.drawNew();this.isVisible=!0;this.isDraggable=!1;this.currentKey=null;this.worldCanvas=a;this.noticesTransparentClick=!0;for(this.stamp=Date.now();this.stamp===Date.now();)nop();this.stamp=Date.now();this.useFillPage=b;void 0===this.useFillPage&&(this.useFillPage=!0);this.isDevMode=!1;this.broken=[];this.animations=[];this.hand=
new HandMorph(this);this.virtualKeyboard=this.activeHandle=this.activeMenu=this.lastEditedText=this.cursor=this.keyboardReceiver=null;this.initEventListeners()};WorldMorph.prototype.brokenFor=function(a){var b=a.fullBounds();return this.broken.filter(function(a){return a.intersects(b)})};WorldMorph.prototype.fullDrawOn=function(a,b){WorldMorph.uber.fullDrawOn.call(this,a,b);this.hand.fullDrawOn(a,b)};
WorldMorph.prototype.updateBroken=function(){var a=this;this.condenseDamages();this.broken.forEach(function(b){b.extent().gt(new Point(0,0))&&a.fullDrawOn(a.worldCanvas,b)});this.broken=[]};WorldMorph.prototype.stepAnimations=function(){this.animations.forEach(function(a){a.step()});this.animations=this.animations.filter(function(a){return a.isActive})};
WorldMorph.prototype.condenseDamages=function(){function a(a){var b=[],c;a.forEach(function(a){(c=detect(b,function(b){return b.isNearTo(a,20)}))?c.mergeWith(a):b.push(a)});return b}for(var b=!0,c=this.broken.length;b;)this.broken=a(this.broken),b=this.broken.length<c,c=this.broken.length};WorldMorph.prototype.doOneCycle=function(){this.stepFrame();this.stepAnimations();this.updateBroken()};
WorldMorph.prototype.fillPage=function(){var a=window.innerHeight,b=window.innerWidth,c=this;this.worldCanvas.style.position="absolute";this.worldCanvas.style.left="0px";this.worldCanvas.style.right="0px";this.worldCanvas.style.width="100%";this.worldCanvas.style.height="100%";document.documentElement.scrollTop&&(a=document.documentElement.clientHeight);document.documentElement.scrollLeft&&(b=document.documentElement.clientWidth);this.worldCanvas.width!==b&&(this.worldCanvas.width=b,this.setWidth(b));
this.worldCanvas.height!==a&&(this.worldCanvas.height=a,this.setHeight(a));this.children.forEach(function(a){a.reactToWorldResize&&a.reactToWorldResize(c.bounds.copy())})};WorldMorph.prototype.getGlobalPixelColor=function(a){return this.hand.morphAtPointer().getPixelColor(this.hand.position())};
WorldMorph.prototype.initVirtualKeyboard=function(){var a=this;this.virtualKeyboard&&(document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null);MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard=document.createElement("input"),this.virtualKeyboard.type="text",this.virtualKeyboard.style.color="transparent",this.virtualKeyboard.style.backgroundColor="transparent",this.virtualKeyboard.style.border="none",this.virtualKeyboard.style.outline=
"none",this.virtualKeyboard.style.position="absolute",this.virtualKeyboard.style.top="0px",this.virtualKeyboard.style.left="0px",this.virtualKeyboard.style.width="0px",this.virtualKeyboard.style.height="0px",this.virtualKeyboard.autocapitalize="none",document.body.appendChild(this.virtualKeyboard),this.virtualKeyboard.addEventListener("keydown",function(b){a.currentKey=b.keyCode;a.keyboardReceiver&&a.keyboardReceiver.processKeyDown(b);8===b.keyCode&&b.preventDefault();9===b.keyCode&&(a.keyboardReceiver&&
a.keyboardReceiver.processKeyPress(b),b.preventDefault())},!1),this.virtualKeyboard.addEventListener("keyup",function(b){a.currentKey=null;a.keyboardReceiver&&a.keyboardReceiver.processKeyUp&&a.keyboardReceiver.processKeyUp(b);b.preventDefault()},!1),this.virtualKeyboard.addEventListener("keypress",function(b){a.keyboardReceiver&&a.keyboardReceiver.processKeyPress(b);b.preventDefault()},!1))};
WorldMorph.prototype.initEventListeners=function(){var a=this.worldCanvas,b=this;b.useFillPage?b.fillPage():this.changed();a.addEventListener("mousedown",function(c){c.preventDefault();a.focus();b.hand.processMouseDown(c)},!1);a.addEventListener("touchstart",function(a){b.hand.processTouchStart(a)},!1);a.addEventListener("mouseup",function(a){a.preventDefault();b.hand.processMouseUp(a)},!1);a.addEventListener("dblclick",function(a){a.preventDefault();b.hand.processDoubleClick(a)},!1);a.addEventListener("touchend",
function(a){b.hand.processTouchEnd(a)},!1);a.addEventListener("mousemove",function(a){b.hand.processMouseMove(a)},!1);a.addEventListener("touchmove",function(a){b.hand.processTouchMove(a)},!1);a.addEventListener("contextmenu",function(a){a.preventDefault()},!1);a.addEventListener("keydown",function(a){b.currentKey=a.keyCode;b.keyboardReceiver&&b.keyboardReceiver.processKeyDown(a);8===a.keyCode&&a.preventDefault();9===a.keyCode&&(b.keyboardReceiver&&b.keyboardReceiver.processKeyPress(a),a.preventDefault());
(a.ctrlKey&&!a.altKey||a.metaKey)&&86!==a.keyCode&&a.preventDefault()},!1);a.addEventListener("keyup",function(a){b.currentKey=null;b.keyboardReceiver&&b.keyboardReceiver.processKeyUp&&b.keyboardReceiver.processKeyUp(a);a.preventDefault()},!1);a.addEventListener("keypress",function(a){b.keyboardReceiver&&b.keyboardReceiver.processKeyPress(a);a.preventDefault()},!1);a.addEventListener("mousewheel",function(a){b.hand.processMouseScroll(a);a.preventDefault()},!1);a.addEventListener("DOMMouseScroll",
function(a){b.hand.processMouseScroll(a);a.preventDefault()},!1);document.body.addEventListener("paste",function(a){(a=a.clipboardData.getData("Text"))&&b.cursor&&b.cursor.insert(a)},!1);window.addEventListener("dragover",function(a){a.preventDefault()},!1);window.addEventListener("drop",function(a){b.hand.processDrop(a);a.preventDefault()},!1);window.addEventListener("resize",function(){b.useFillPage&&b.fillPage()},!1);window.onbeforeunload=function(a){if(a=a||window.event)a.returnValue="Are you sure you want to leave?";
return"Are you sure you want to leave?"}};WorldMorph.prototype.mouseDownLeft=nop;WorldMorph.prototype.mouseClickLeft=nop;WorldMorph.prototype.mouseDownRight=nop;WorldMorph.prototype.mouseClickRight=nop;WorldMorph.prototype.wantsDropOf=function(){return this.acceptsDrops};WorldMorph.prototype.droppedImage=function(){return null};WorldMorph.prototype.droppedSVG=function(){return null};WorldMorph.prototype.nextTab=function(a){var b=this.nextEntryField(a);b&&(a.clearSelection(),b.selectAll(),b.edit())};
WorldMorph.prototype.previousTab=function(a){var b=this.previousEntryField(a);b&&(a.clearSelection(),b.selectAll(),b.edit())};
WorldMorph.prototype.contextMenu=function(){var a=this.isDevMode?new MenuMorph(this,this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0]):new MenuMorph(this,"Morphic");this.isDevMode&&(a.addItem("demo...","userCreateMorph","sample morphs"),a.addLine(),a.addItem("hide all...","hideAll"),a.addItem("show all...","showAllHiddens"),a.addItem("move all inside...","keepAllSubmorphsWithin","keep all submorphs\nwithin and visible"),a.addItem("inspect...","inspect","open a window on\nall properties"),
a.addItem("screenshot...",function(){window.open(this.fullImageClassic().toDataURL())},"open a new window\nwith a picture of this morph"),a.addLine(),a.addItem("restore display","changed","redraw the\nscreen once"),a.addItem("fill page...","fillPage","let the World automatically\nadjust to browser resizing"),useBlurredShadows?a.addItem("sharp shadows...","toggleBlurredShadows","sharp drop shadows\nuse for old browsers"):a.addItem("blurred shadows...","toggleBlurredShadows","blurry shades,\n use for new browsers"),
a.addItem("color...",function(){this.pickColor(a.title+localize("\ncolor:"),this.setColor,this,this.color)},"choose the World's\nbackground color"),MorphicPreferences===standardSettings?a.addItem("touch screen settings","togglePreferences","bigger menu fonts\nand sliders"):a.addItem("standard settings","togglePreferences","smaller menu fonts\nand sliders"),a.addLine());this.isDevMode?a.addItem("user mode...","toggleDevMode","disable developers'\ncontext menus"):a.addItem("development mode...","toggleDevMode");
a.addItem("about morphic.js...","about");return a};
WorldMorph.prototype.userCreateMorph=function(){function a(a){a.isDraggable=!0;a.pickUp(b)}var b=this,c;var d=new MenuMorph(this,"make a morph");d.addItem("rectangle",function(){a(new Morph)});d.addItem("box",function(){a(new BoxMorph)});d.addItem("circle box",function(){a(new CircleBoxMorph)});d.addLine();d.addItem("slider",function(){a(new SliderMorph)});d.addItem("frame",function(){c=new FrameMorph;c.setExtent(new Point(350,250));a(c)});d.addItem("scroll frame",function(){c=new ScrollFrameMorph;
c.contents.acceptsDrops=!0;c.contents.adjustBounds();c.setExtent(new Point(350,250));a(c)});d.addItem("handle",function(){a(new HandleMorph)});d.addLine();d.addItem("string",function(){c=new StringMorph("Hello, World!");c.isEditable=!0;a(c)});d.addItem("text",function(){c=new TextMorph("Ich wei\u00df nicht, was soll es bedeuten, dass ich so traurig bin, ein M\u00e4rchen aus uralten Zeiten, das kommt mir nicht aus dem Sinn. Die Luft ist k\u00fchl und es dunkelt, und ruhig flie\u00dft der Rhein; der Gipfel des Berges funkelt im Abendsonnenschein. Die sch\u00f6nste Jungfrau sitzet dort oben wunderbar, ihr gold'nes Geschmeide blitzet, sie k\u00e4mmt ihr goldenes Haar, sie k\u00e4mmt es mit goldenem Kamme, und singt ein Lied dabei; das hat eine wundersame, gewalt'ge Melodei. Den Schiffer im kleinen Schiffe, ergreift es mit wildem Weh; er schaut nicht die Felsenriffe, er schaut nur hinauf in die H\u00f6h'. Ich glaube, die Wellen verschlingen am Ende Schiffer und Kahn, und das hat mit ihrem Singen, die Loreley getan.");
c.isEditable=!0;c.maxWidth=300;c.drawNew();a(c)});d.addItem("speech bubble",function(){c=new SpeechBubbleMorph("Hello, World!");a(c)});d.addLine();d.addItem("gray scale palette",function(){a(new GrayPaletteMorph)});d.addItem("color palette",function(){a(new ColorPaletteMorph)});d.addItem("color picker",function(){a(new ColorPickerMorph)});d.addLine();d.addItem("sensor demo",function(){c=new MouseSensorMorph;c.setColor(new Color(230,200,100));c.edge=35;c.border=15;c.borderColor=new Color(200,100,50);
c.alpha=.2;c.setExtent(new Point(100,100));a(c)});d.addItem("animation demo",function(){var b=new BouncerMorph;b.setPosition(new Point(50,20));b.setExtent(new Point(300,200));b.alpha=.9;b.speed=3;var c=new BouncerMorph;c.setColor(new Color(50,50,50));c.setPosition(new Point(80,80));c.setExtent(new Point(80,250));c.type="horizontal";c.direction="right";c.alpha=.9;c.speed=5;var d=new BouncerMorph;d.setColor(new Color(20,20,20));d.setPosition(new Point(90,140));d.setExtent(new Point(40,30));d.type="horizontal";
d.direction="right";d.speed=3;var h=new BouncerMorph;h.setColor(new Color(200,20,20));h.setPosition(new Point(90,140));h.setExtent(new Point(20,20));h.type="vertical";h.direction="up";h.speed=8;var k=new BouncerMorph;k.setColor(new Color(20,200,20));k.setPosition(new Point(120,140));k.setExtent(new Point(20,20));k.type="vertical";k.direction="down";k.speed=4;c.add(h);c.add(d);b.add(k);b.add(c);a(b)});d.addItem("pen",function(){a(new PenMorph)});b.customMorphs&&(d.addLine(),b.customMorphs().forEach(function(b){d.addItem(b.toString(),
function(){a(b)})}));d.popUpAtHand(this)};WorldMorph.prototype.toggleDevMode=function(){this.isDevMode=!this.isDevMode};WorldMorph.prototype.hideAll=function(){this.children.forEach(function(a){a.hide()})};WorldMorph.prototype.showAllHiddens=function(){this.forAllChildren(function(a){a.isVisible||a.show()})};
WorldMorph.prototype.about=function(){var a="",b;for(b in modules)Object.prototype.hasOwnProperty.call(modules,b)&&(a+="\n"+b+" ("+modules[b]+")");""!==a&&(a="\n\nmodules:\n\nmorphic ("+morphicVersion+")"+a);this.inform("morphic.js\n\na lively Web GUI\ninspired by Squeak\n"+morphicVersion+"\n\nwritten by Jens M\u00f6nig\njens@moenig.org"+a)};
WorldMorph.prototype.edit=function(a){var b=getDocumentPositionOf(this.worldCanvas);if(!a.isEditable)return null;this.cursor&&this.cursor.destroy();this.cursor=new CursorMorph(a);a.parent.add(this.cursor);this.keyboardReceiver=this.cursor;this.initVirtualKeyboard();MorphicPreferences.isTouchDevice&&MorphicPreferences.useVirtualKeyboard&&(this.virtualKeyboard.style.top=this.cursor.top()+b.y+"px",this.virtualKeyboard.style.left=this.cursor.left()+b.x+"px",this.virtualKeyboard.focus());MorphicPreferences.useSliderForInput&&
(a.parentThatIsA(MenuMorph)||this.slide(a));this.lastEditedText!==a&&a.escalateEvent("freshTextEdit",a);this.lastEditedText=a};
WorldMorph.prototype.slide=function(a){var b=parseFloat(a.text);isNaN(b)&&(b=0);var c=new MenuMorph;b=new SliderMorph(b-25,b+25,b,10,"horizontal");b.alpha=1;b.color=new Color(225,225,225);b.button.color=c.borderColor;b.button.highlightColor=b.button.color.copy();b.button.highlightColor.b+=100;b.button.pressColor=b.button.color.copy();b.button.pressColor.b+=150;b.silentSetHeight(MorphicPreferences.scrollBarSize);b.silentSetWidth(10*MorphicPreferences.menuFontSize);b.drawNew();b.action=function(b){a.changed();
a.text=Math.round(b).toString();a.drawNew();a.changed();a.escalateEvent("reactToSliderEdit",a)};c.items.push(b);c.popup(this,a.bottomLeft().add(new Point(0,5)))};
WorldMorph.prototype.stopEditing=function(){this.cursor&&(this.cursor.target.escalateEvent("reactToEdit",this.cursor.target),this.cursor.target.clearSelection(),this.cursor.destroy(),this.cursor=null);this.keyboardReceiver&&this.keyboardReceiver.stopEditing&&this.keyboardReceiver.stopEditing();this.keyboardReceiver=null;this.virtualKeyboard&&(this.virtualKeyboard.blur(),document.body.removeChild(this.virtualKeyboard),this.virtualKeyboard=null);this.lastEditedText=null;this.worldCanvas.focus()};
WorldMorph.prototype.toggleBlurredShadows=function(){useBlurredShadows=!useBlurredShadows};WorldMorph.prototype.togglePreferences=function(){MorphicPreferences=MorphicPreferences===standardSettings?touchScreenSettings:standardSettings};modules.widgets="2017-September-25";PushButtonMorph.prototype=new TriggerMorph;PushButtonMorph.prototype.constructor=PushButtonMorph;PushButtonMorph.uber=TriggerMorph.prototype;PushButtonMorph.prototype.fontSize=10;PushButtonMorph.prototype.fontStyle="sans-serif";PushButtonMorph.prototype.labelColor=new Color(0,0,0);PushButtonMorph.prototype.labelShadowColor=new Color(255,255,255);PushButtonMorph.prototype.labelShadowOffset=new Point(1,1);PushButtonMorph.prototype.color=new Color(220,220,220);
PushButtonMorph.prototype.pressColor=new Color(115,180,240);PushButtonMorph.prototype.highlightColor=PushButtonMorph.prototype.pressColor.lighter(50);PushButtonMorph.prototype.outlineColor=new Color(30,30,30);PushButtonMorph.prototype.outlineGradient=!1;PushButtonMorph.prototype.contrast=60;PushButtonMorph.prototype.edge=2;PushButtonMorph.prototype.corner=5;PushButtonMorph.prototype.outline=1.00001;PushButtonMorph.prototype.padding=3;function PushButtonMorph(a,b,c,d,e,f){this.init(a,b,c,d,e,f)}
PushButtonMorph.prototype.init=function(a,b,c,d,e,f){this.is3D=!1;this.target=a||null;this.action=b||null;this.environment=d||null;this.labelString=c||null;this.label=null;this.labelMinExtent=new Point(0,0);this.hint=e||null;this.template=f||null;this.isDisabled=!1;TriggerMorph.uber.init.call(this);this.color=PushButtonMorph.prototype.color;this.drawNew();this.fixLayout()};
PushButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var a=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(Math.max(this.label.width(),this.labelMinExtent.x)+a,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+a));this.label.setCenter(this.center())}};PushButtonMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this);this.label&&this.label.setCenter(this.center().add(1))};
PushButtonMorph.prototype.mouseClickLeft=function(){this.isDisabled||(PushButtonMorph.uber.mouseClickLeft.call(this),this.label&&this.label.setCenter(this.center()))};PushButtonMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this);this.label&&this.label.setCenter(this.center())};PushButtonMorph.prototype.outlinePath=BoxMorph.prototype.outlinePath;
PushButtonMorph.prototype.drawOutline=function(a){var b=MorphicPreferences.isFlat&&!this.is3D;if(!this.outline||b)return null;if(this.outlineGradient){var c=a.createLinearGradient(0,0,0,this.height());c.addColorStop(0,this.outlineColor.darker().toString());c.addColorStop(1,"white")}else c=this.outlineColor.toString();a.fillStyle=c;a.beginPath();this.outlinePath(a,b?0:this.corner,0);a.closePath();a.fill()};
PushButtonMorph.prototype.drawBackground=function(a,b){var c=MorphicPreferences.isFlat&&!this.is3D;a.fillStyle=b.toString();a.beginPath();this.outlinePath(a,c?0:Math.max(this.corner-this.outline,0),this.outline);a.closePath();a.fill();a.lineWidth=this.outline};
PushButtonMorph.prototype.drawEdges=function(a,b,c,d){if(!MorphicPreferences.isFlat||this.is3D){var e=Math.max(this.corner,this.outline+this.edge),f=this.width(),g=this.height();var h=a.createLinearGradient(0,this.outline,0,this.outline+this.edge);h.addColorStop(0,c.toString());h.addColorStop(1,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(e,this.outline+this.edge/2);a.lineTo(f-e,this.outline+this.edge/2);a.stroke();h=a.createRadialGradient(this.corner,
this.corner,Math.max(this.corner-this.outline-this.edge,0),this.corner,this.corner,Math.max(this.corner-this.outline,0));h.addColorStop(0,b.toString());h.addColorStop(1,c.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.arc(this.corner,this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(180),radians(270),!1);a.stroke();h=a.createLinearGradient(this.outline,0,this.outline+this.edge,0);h.addColorStop(0,c.toString());h.addColorStop(1,b.toString());
a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(this.outline+this.edge/2,e);a.lineTo(this.outline+this.edge/2,g-e);a.stroke();h=a.createLinearGradient(0,g-this.outline,0,g-this.outline-this.edge);h.addColorStop(0,d.toString());h.addColorStop(1,b.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(e,g-this.outline-this.edge/2);a.lineTo(f-e,g-this.outline-this.edge/2);a.stroke();h=a.createRadialGradient(f-this.corner,g-this.corner,
Math.max(this.corner-this.outline-this.edge,0),f-this.corner,g-this.corner,Math.max(this.corner-this.outline,0));h.addColorStop(0,b.toString());h.addColorStop(1,d.toString());a.strokeStyle=h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.arc(f-this.corner,g-this.corner,Math.max(this.corner-this.outline-this.edge/2,0),radians(0),radians(90),!1);a.stroke();h=a.createLinearGradient(f-this.outline,0,f-this.outline-this.edge,0);h.addColorStop(0,d.toString());h.addColorStop(1,b.toString());a.strokeStyle=
h;a.lineCap="round";a.lineWidth=this.edge;a.beginPath();a.moveTo(f-this.outline-this.edge/2,e);a.lineTo(f-this.outline-this.edge/2,g-e);a.stroke()}};
PushButtonMorph.prototype.createBackgrounds=function(){var a=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(a);var b=this.normalImage.getContext("2d");this.drawOutline(b);this.drawBackground(b,this.color);this.drawEdges(b,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast));this.highlightImage=
newCanvas(a);b=this.highlightImage.getContext("2d");this.drawOutline(b);this.drawBackground(b,this.highlightColor);this.drawEdges(b,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast));this.pressImage=newCanvas(a);b=this.pressImage.getContext("2d");this.drawOutline(b);this.drawBackground(b,this.pressColor);this.drawEdges(b,this.pressColor,this.pressColor.darker(this.contrast),this.pressColor.lighter(this.contrast));this.image=this.normalImage};
PushButtonMorph.prototype.createLabel=function(){var a=!MorphicPreferences.isFlat||this.is3D;null!==this.label&&this.label.destroy();this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),a&&(this.label.shadowOffset=this.labelShadowOffset,this.label.shadowColor=this.labelShadowColor),this.label.color=this.labelColor,this.label.drawNew()):this.label=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,a?this.labelShadowOffset:null,this.labelShadowColor,
this.labelColor);this.add(this.label)};PushButtonMorph.prototype.disable=function(){this.isDisabled=!0;this.forAllChildren(function(a){a.alpha=.3});this.changed()};PushButtonMorph.prototype.enable=function(){this.isDisabled=!1;this.forAllChildren(function(a){a.alpha=1});this.changed()};ToggleButtonMorph.prototype=new PushButtonMorph;ToggleButtonMorph.prototype.constructor=ToggleButtonMorph;ToggleButtonMorph.uber=PushButtonMorph.prototype;ToggleButtonMorph.prototype.contrast=30;
function ToggleButtonMorph(a,b,c,d,e,f,g,h,k,l,m){this.init(a,b,c,d,e,f,g,h,k,l,m)}ToggleButtonMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l,m){this.state=!1;this.query=e||function(){return!0};this.minWidth=k||null;this.hasPreview=l||!1;this.isPicture=m||!1;this.trueStateLabel=null;ToggleButtonMorph.uber.init.call(this,b,c,d,f,g,h);a&&(this.color=a[0],this.highlightColor=a[1],this.pressColor=a[2]);this.refresh();this.drawNew()};
ToggleButtonMorph.prototype.mouseEnter=function(){var a=this.hint instanceof Function?this.hint():this.hint;this.state||(this.image=this.highlightImage,this.changed());a&&this.bubbleHelp(a)};ToggleButtonMorph.prototype.mouseLeave=function(){this.state||(this.image=this.normalImage,this.changed());this.schedule&&(this.schedule.isActive=!1);this.hint&&this.world().hand.destroyTemporaries()};ToggleButtonMorph.prototype.mouseDownLeft=function(){this.state||(this.image=this.pressImage,this.changed())};
ToggleButtonMorph.prototype.mouseClickLeft=function(){this.state||(this.image=this.highlightImage,this.changed());this.trigger()};ToggleButtonMorph.prototype.trigger=function(){ToggleButtonMorph.uber.trigger.call(this);this.refresh()};
ToggleButtonMorph.prototype.refresh=function(){(this.state="function"===typeof this.query?this.query.call(this.target):this.target[this.query]())?(this.image=this.pressImage,this.trueStateLabel&&(this.label.hide(),this.trueStateLabel.show())):(this.image=this.normalImage,this.trueStateLabel&&(this.label.show(),this.trueStateLabel.hide()));this.changed()};
ToggleButtonMorph.prototype.fixLayout=function(){if(null!==this.label){var a=Math.max(this.label.width(),this.labelMinExtent.x),b=2*this.padding+2*this.outline+2*this.edge;this.setExtent(new Point(this.minWidth?Math.max(this.minWidth,a)+b:a+b,Math.max(this.label instanceof StringMorph?this.label.rawHeight():this.label.height(),this.labelMinExtent.y)+b));this.label.setCenter(this.center());this.trueStateLabel&&this.trueStateLabel.setCenter(this.center());this.minWidth&&this.label.setLeft(this.left()+
this.outline+this.edge+this.corner+this.padding)}};
ToggleButtonMorph.prototype.createBackgrounds=function(){var a=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(a);var b=this.normalImage.getContext("2d");this.drawOutline(b);this.drawBackground(b,this.color);this.drawEdges(b,this.color,this.color.lighter(this.contrast),this.color.darker(this.contrast));this.highlightImage=
newCanvas(a);b=this.highlightImage.getContext("2d");this.drawOutline(b);this.drawBackground(b,this.highlightColor);this.drawEdges(b,this.highlightColor,this.highlightColor.lighter(this.contrast),this.highlightColor.darker(this.contrast));this.pressImage=newCanvas(a);b=this.pressImage.getContext("2d");this.drawOutline(b);this.drawBackground(b,this.pressColor);this.drawEdges(b,this.pressColor,this.pressColor.lighter(40),this.pressColor.darker(40));this.image=this.normalImage};
ToggleButtonMorph.prototype.drawEdges=function(a,b,c,d){ToggleButtonMorph.uber.drawEdges.call(this,a,b,c,d);this.hasPreview&&(MorphicPreferences.isFlat&&!this.is3D?(a.fillStyle=this.pressColor.toString(),a.fillRect(this.outline,this.outline,this.corner,this.height()-2*this.outline)):(b=a.createLinearGradient(0,0,this.corner,0),b.addColorStop(0,this.pressColor.lighter(40).toString()),b.addColorStop(1,this.pressColor.darker(40).toString()),a.fillStyle=b,a.beginPath(),this.previewPath(a,Math.max(this.corner-
this.outline,0),this.outline),a.closePath(),a.fill()))};ToggleButtonMorph.prototype.previewPath=function(a,b,c){c=b+c;var d=this.height();a.arc(c,c,b,radians(-180),radians(-90),!1);a.arc(c,d-c,b,radians(90),radians(180),!1)};
ToggleButtonMorph.prototype.createLabel=function(){var a=!MorphicPreferences.isFlat||this.is3D,b=new Point;null!==this.label&&this.label.destroy();null!==this.trueStateLabel&&this.trueStateLabel.destroy();this.labelString instanceof Array&&2===this.labelString.length?this.labelString[0]instanceof SymbolMorph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy(),this.isPicture||(this.label.shadowOffset=a?this.labelShadowOffset:b,this.label.shadowColor=this.labelShadowColor,
this.label.color=this.labelColor,this.label.drawNew(),this.trueStateLabel.shadowOffset=a?this.labelShadowOffset:b,this.trueStateLabel.shadowColor=this.labelShadowColor,this.trueStateLabel.color=this.labelColor,this.trueStateLabel.drawNew())):this.labelString[0]instanceof Morph?(this.label=this.labelString[0].fullCopy(),this.trueStateLabel=this.labelString[1].fullCopy()):(this.label=new StringMorph(localize(this.labelString[0]),this.fontSize,this.fontStyle,!0,!1,!1,a?this.labelShadowOffset:null,this.labelShadowColor,
this.labelColor),this.trueStateLabel=new StringMorph(localize(this.labelString[1]),this.fontSize,this.fontStyle,!0,!1,!1,a?this.labelShadowOffset:null,this.labelShadowColor,this.labelColor)):this.labelString instanceof SymbolMorph?(this.label=this.labelString.fullCopy(),this.isPicture||(this.label.shadowOffset=a?this.labelShadowOffset:b,this.label.shadowColor=this.labelShadowColor,this.label.color=this.labelColor,this.label.drawNew())):this.label=this.labelString instanceof Morph?this.labelString.fullCopy():
new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,a?this.labelShadowOffset:b,this.labelShadowColor,this.labelColor);this.add(this.label);this.trueStateLabel&&this.add(this.trueStateLabel)};ToggleButtonMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};ToggleButtonMorph.prototype.show=function(){this.isVisible=!0;this.changed()};TabMorph.prototype=new ToggleButtonMorph;TabMorph.prototype.constructor=TabMorph;TabMorph.uber=ToggleButtonMorph.prototype;
function TabMorph(a,b,c,d,e,f,g){this.init(a,b,c,d,e,f,g)}TabMorph.prototype.fixLayout=function(){null!==this.label&&(this.setExtent(new Point(this.label.width()+2*this.padding+3*this.corner+2*this.edge,(this.label instanceof StringMorph?this.label.rawHeight():this.label.height())+2*this.padding+this.edge)),this.label.setCenter(this.center()))};TabMorph.prototype.refresh=function(){this.state&&this.parent&&this.parent.add(this);TabMorph.uber.refresh.call(this)};
TabMorph.prototype.drawBackground=function(a,b){var c=this.width(),d=this.height(),e=this.corner;a.fillStyle=b.toString();a.beginPath();a.moveTo(0,d);a.bezierCurveTo(e,d,e,0,2*e,0);a.lineTo(c-2*e,0);a.bezierCurveTo(c-e,0,c-e,d,c,d);a.closePath();a.fill()};TabMorph.prototype.drawOutline=function(){nop()};
TabMorph.prototype.drawEdges=function(a,b,c,d){if(!MorphicPreferences.isFlat||this.is3D){var e=this.width(),f=this.height(),g=this.corner,h=this.edge,k=h/2;nop(b);b=a.createLinearGradient(0,0,e,0);b.addColorStop(0,c.toString());b.addColorStop(1,d.toString());a.strokeStyle=b;a.lineCap="round";a.lineWidth=h;a.beginPath();a.moveTo(0,f+k);a.bezierCurveTo(g,f,g,0,2*g,k);a.lineTo(e-2*g,k);a.bezierCurveTo(e-g,0,e-g,f,e,f+k);a.stroke()}};ToggleMorph.prototype=new PushButtonMorph;
ToggleMorph.prototype.constructor=ToggleMorph;ToggleMorph.uber=PushButtonMorph.prototype;function ToggleMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
ToggleMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l){this.padding=1;a=a||"checkbox";this.corner="checkbox"===a?0:fontHeight(this.fontSize)/2+this.outline+this.padding;this.state=!1;this.query=e||function(){return!0};this.tick=null;this.captionString=d||null;this.labelAlignment="right";this.element=k||null;this.builder=l||null;this.toggleElement=null;ToggleMorph.uber.init.call(this,b,c,"checkbox"===a?"\u2713":"\u25cf",f,g,h);this.refresh();this.drawNew()};
ToggleMorph.prototype.fixLayout=function(){var a=2*this.padding+2*this.outline;null!==this.tick&&(this.silentSetHeight(this.tick.rawHeight()+a),this.silentSetWidth(this.tick.width()+a),this.setExtent(new Point(Math.max(this.width(),this.height()),Math.max(this.width(),this.height()))),this.tick.setCenter(this.center()));this.state?this.tick.show():this.tick.hide();if(this.toggleElement&&"right"===this.labelAlignment){var b=this.top()+(this.height()-this.toggleElement.height())/2;this.toggleElement.setPosition(new Point(this.right()+
a,b))}null!==this.label&&(b=this.top()+(this.height()-this.label.height())/2,"right"===this.labelAlignment?this.label.setPosition(new Point(this.toggleElement?this.toggleElement instanceof ToggleElementMorph?this.toggleElement.right():this.toggleElement.right()+a:this.right()+a,b)):this.label.setPosition(new Point(this.left()-this.label.width()-a,b)))};
ToggleMorph.prototype.createLabel=function(){var a=!MorphicPreferences.isFlat||this.is3D;null===this.label&&this.captionString&&(this.label=new TextMorph(localize(this.captionString),this.fontSize,this.fontStyle,!0),this.add(this.label));null===this.tick&&(this.tick=new StringMorph(localize(this.labelString),this.fontSize,this.fontStyle,!0,!1,!1,a?new Point(1,1):null,new Color(240,240,240)),this.add(this.tick));null===this.toggleElement&&this.element&&(this.element instanceof Morph?this.toggleElement=
new ToggleElementMorph(this.target,this.action,this.element,this.query,this.environment,this.hint,this.builder):this.element instanceof HTMLCanvasElement&&(this.toggleElement=new Morph,this.toggleElement.silentSetExtent(new Point(this.element.width,this.element.height)),this.toggleElement.image=this.element),this.add(this.toggleElement))};ToggleMorph.prototype.trigger=function(){ToggleMorph.uber.trigger.call(this);this.refresh()};
ToggleMorph.prototype.refresh=function(){(this.state="function"===typeof this.query?this.query.call(this.target):this.target[this.query]())?this.tick.show():this.tick.hide();this.toggleElement&&this.toggleElement.refresh&&this.toggleElement.refresh()};ToggleMorph.prototype.mouseDownLeft=function(){PushButtonMorph.uber.mouseDownLeft.call(this);this.tick&&this.tick.setCenter(this.center().add(1))};
ToggleMorph.prototype.mouseClickLeft=function(){PushButtonMorph.uber.mouseClickLeft.call(this);this.tick&&this.tick.setCenter(this.center())};ToggleMorph.prototype.mouseLeave=function(){PushButtonMorph.uber.mouseLeave.call(this);this.tick&&this.tick.setCenter(this.center())};ToggleMorph.prototype.hide=ToggleButtonMorph.prototype.hide;ToggleMorph.prototype.show=ToggleButtonMorph.prototype.show;ToggleElementMorph.prototype=new TriggerMorph;ToggleElementMorph.prototype.constructor=ToggleElementMorph;
ToggleElementMorph.uber=TriggerMorph.prototype;ToggleElementMorph.prototype.contrast=50;ToggleElementMorph.prototype.shadowOffset=new Point(2,2);ToggleElementMorph.prototype.shadowAlpha=.6;ToggleElementMorph.prototype.fontSize=10;ToggleElementMorph.prototype.inactiveColor=new Color(180,180,180);function ToggleElementMorph(a,b,c,d,e,f,g,h){this.init(a,b,c,d,e,f,g,h)}
ToggleElementMorph.prototype.init=function(a,b,c,d,e,f,g,h){this.target=a||null;this.action=b||null;this.element=c;this.query=d||function(){return!0};this.environment=e||null;this.hint=f||null;this.builder=g||"nop";this.captionString=h||null;this.labelAlignment="right";this.state=!1;TriggerMorph.uber.init.call(this);this.color=c.color;this.createLabel()};
ToggleElementMorph.prototype.createBackgrounds=function(){var a=!MorphicPreferences.isFlat||this.is3D;this.color=this.element.color;this.element.removeShadow();this.element[this.builder]();a&&this.element.addShadow(this.shadowOffset,this.shadowAlpha);this.silentSetExtent(this.element.fullBounds().extent());this.pressImage=this.element.fullImage();this.element.removeShadow();this.element.setColor(this.inactiveColor);this.element[this.builder](this.contrast);a&&this.element.addShadow(this.shadowOffset,
0);this.normalImage=this.element.fullImage();this.element.removeShadow();this.element.setColor(this.color.lighter(this.contrast));this.element[this.builder](this.contrast);a&&this.element.addShadow(this.shadowOffset,this.shadowAlpha);this.highlightImage=this.element.fullImage();this.element.removeShadow();this.element.setColor(this.color);this.element[this.builder]();this.image=this.normalImage};ToggleElementMorph.prototype.setColor=function(a){this.element.setColor(a);this.createBackgrounds();this.refresh()};
ToggleElementMorph.prototype.createLabel=function(){if(this.captionString){this.label=new StringMorph(this.captionString,this.fontSize,this.fontStyle,!0);this.add(this.label);var a=this.top()+(this.height()-this.label.height())/2;"right"===this.labelAlignment?this.label.setPosition(new Point(this.right(),a)):this.label.setPosition(new Point(this.left()-this.label.width(),a))}};ToggleElementMorph.prototype.trigger=ToggleButtonMorph.prototype.trigger;ToggleElementMorph.prototype.refresh=ToggleButtonMorph.prototype.refresh;
ToggleElementMorph.prototype.mouseEnter=ToggleButtonMorph.prototype.mouseEnter;ToggleElementMorph.prototype.mouseLeave=ToggleButtonMorph.prototype.mouseLeave;ToggleElementMorph.prototype.mouseDownLeft=ToggleButtonMorph.prototype.mouseDownLeft;ToggleElementMorph.prototype.mouseClickLeft=ToggleButtonMorph.prototype.mouseClickLeft;DialogBoxMorph.prototype=new Morph;DialogBoxMorph.prototype.constructor=DialogBoxMorph;DialogBoxMorph.uber=Morph.prototype;DialogBoxMorph.prototype.fontSize=12;
DialogBoxMorph.prototype.titleFontSize=14;DialogBoxMorph.prototype.fontStyle="sans-serif";DialogBoxMorph.prototype.color=PushButtonMorph.prototype.color;DialogBoxMorph.prototype.titleTextColor=new Color(255,255,255);DialogBoxMorph.prototype.titleBarColor=PushButtonMorph.prototype.pressColor;DialogBoxMorph.prototype.contrast=40;DialogBoxMorph.prototype.corner=12;DialogBoxMorph.prototype.padding=14;DialogBoxMorph.prototype.titlePadding=6;DialogBoxMorph.prototype.buttonContrast=50;
DialogBoxMorph.prototype.buttonFontSize=12;DialogBoxMorph.prototype.buttonCorner=12;DialogBoxMorph.prototype.buttonEdge=6;DialogBoxMorph.prototype.buttonPadding=0;DialogBoxMorph.prototype.buttonOutline=3;DialogBoxMorph.prototype.buttonOutlineColor=PushButtonMorph.prototype.color;DialogBoxMorph.prototype.buttonOutlineGradient=!0;DialogBoxMorph.prototype.instances={};function DialogBoxMorph(a,b,c){this.init(a,b,c)}
DialogBoxMorph.prototype.init=function(a,b,c){this.is3D=!1;this.target=a||null;this.action=b||null;this.environment=c||null;this.buttons=this.body=this.head=this.label=this.labelString=this.key=null;DialogBoxMorph.uber.init.call(this);this.isDraggable=!0;this.color=PushButtonMorph.prototype.color;this.createLabel();this.createButtons();this.setExtent(new Point(300,150))};
DialogBoxMorph.prototype.inform=function(a,b,c,d){var e=new TextMorph(b,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="inform"+a+b);this.labelString=a;this.createLabel();d&&this.setPicture(d);b&&this.addBody(e);this.addButton("ok","OK");this.drawNew();this.fixLayout();this.popUp(c)};
DialogBoxMorph.prototype.askYesNo=function(a,b,c,d){var e=new TextMorph(b,this.fontSize,this.fontStyle,!0,!1,"center",null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255));this.key||(this.key="decide"+a+b);this.labelString=a;this.createLabel();d&&this.setPicture(d);this.addBody(e);this.addButton("ok","Yes");this.addButton("cancel","No");this.fixLayout();this.drawNew();this.fixLayout();this.popUp(c)};
DialogBoxMorph.prototype.prompt=function(a,b,c,d,e,f,g,h,k,l){var m=new InputFieldMorph(b,g||!1,e||null,e?f||!1:!1);m.setWidth(250);if(g){if(d){var n=new AlignmentMorph("column",this.padding);d.setPosition(n.position());n.add(d)}if(!isNil(h)&&!isNil(k)){var p=new SliderMorph(100*h,100*k,100*parseFloat(b),(k-h)/10*100,"horizontal");p.alpha=1;p.color=this.color.lighter(50);p.setHeight(.7*m.height());p.setWidth(m.width());p.action=function(a){l&&l(a/100);m.setContents(a/100);m.edit()};n||(n=new AlignmentMorph("column",
this.padding));n.add(p)}n&&(n.fixLayout(),this.setPicture(n),n.fixLayout())}else d&&this.setPicture(d);this.reactToChoice=function(a){p&&(p.value=100*a,p.drawNew(),p.changed());l&&l(a)};m.reactToKeystroke=function(){var a=m.getValue();p&&(a=Math.max(a,h),p.value=100*a,p.drawNew(),p.changed());l&&l(a)};this.labelString=a;this.createLabel();this.key||(this.key="prompt"+a+b);this.addBody(m);m.drawNew();this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.drawNew();this.fixLayout();
this.popUp(c)};
DialogBoxMorph.prototype.promptCode=function(a,b,c,d,e){var f=new ScrollFrameMorph,g=new TextMorph(b||""),h=new AlignmentMorph("column",this.padding),k=d?Math.max(d.width,400):400;this.getInput=function(){return g.text};f.padding=6;f.setWidth(k);f.acceptsDrops=!1;f.contents.acceptsDrops=!1;g.fontName="monospace";g.fontStyle="monospace";g.fontSize=11;g.setPosition(f.topLeft().add(f.padding));g.enableSelecting();g.isEditable=!0;f.setHeight(k/4);f.fixLayout=nop;f.edge=InputFieldMorph.prototype.edge;f.fontSize=
InputFieldMorph.prototype.fontSize;f.typeInPadding=InputFieldMorph.prototype.typeInPadding;f.contrast=InputFieldMorph.prototype.contrast;f.drawNew=InputFieldMorph.prototype.drawNew;f.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;f.addContents(g);g.drawNew();d&&this.setPicture(d);this.labelString=a;this.createLabel();this.key||(this.key="promptCode"+a+b);h.setColor(this.color);h.add(f);e&&h.add(new TextMorph(localize(e),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,
1),new Color(255,255,255)));h.fixLayout();this.addBody(h);f.drawNew();h.drawNew();this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.drawNew();this.fixLayout();this.popUp(c);g.edit()};
DialogBoxMorph.prototype.promptVector=function(a,b,c,d,e,f,g,h){function k(a){return new TextMorph(localize(a),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}var l=new AlignmentMorph("row",4),m=new InputFieldMorph(b.x.toString(),!0),n=new InputFieldMorph(b.y.toString(),!0);b=new AlignmentMorph("column",2);var p=new AlignmentMorph("column",2),q=new AlignmentMorph("column",2),t=new AlignmentMorph("column",this.padding);q.alignment="left";q.setColor(this.color);
t.setColor(this.color);b.alignment="left";b.setColor(this.color);p.alignment="left";p.setColor(this.color);b.add(k(d));b.add(m);p.add(k(e));p.add(n);l.add(b);l.add(p);q.add(l);h&&t.add(k(h));t.add(q);l.fixLayout();b.fixLayout();p.fixLayout();q.fixLayout();t.fixLayout();this.labelString=a;this.createLabel();g&&this.setPicture(g);this.addBody(t);l.drawNew();b.drawNew();m.drawNew();p.drawNew();n.drawNew();t.fixLayout();this.addButton("ok","OK");c instanceof Point&&this.addButton(function(){m.setContents(c.x.toString());
n.setContents(c.y.toString())},"Default");this.addButton("cancel","Cancel");this.fixLayout();this.drawNew();this.fixLayout();this.edit=function(){m.edit()};this.getInput=function(){return new Point(m.getValue(),n.getValue())};this.key||(this.key="vector"+a);this.popUp(f)};
DialogBoxMorph.prototype.promptCredentials=function(a,b,c,d,e,f,g,h,k,l){function m(a){return new TextMorph(localize(a),10,null,!1,null,null,null,null,MorphicPreferences.isFlat?null:new Point(1,1),new Color(255,255,255))}function n(a,b){a=new PushButtonMorph(u,function(){window.open(b)},"  "+localize(a)+"  ");a.fontSize=10;a.corner=u.buttonCorner;a.edge=u.buttonEdge;a.outline=u.buttonOutline;a.outlineColor=u.buttonOutlineColor;a.outlineGradient=u.buttonOutlineGradient;a.padding=u.buttonPadding;a.contrast=
u.buttonContrast;a.drawNew();a.fixLayout();return a}function p(){function a(a,b){b=new SpeechBubbleMorph(localize(b));b.isPointingRight=!1;b.drawNew();b.popUp(h,a.leftCenter().subtract(new Point(b.width()+2,0)));a.edit&&a.edit()}var c,d=t.getValue();"login"===b?c=[q,r]:"signup"===b?c=[q,I,B,t]:"changePassword"===b?c=[S,r,z]:"resetPassword"===b&&(c=[q]);if(c=detect(c,function(a){return!a.getValue()}))return a(c,"please fill out\nthis field"),!1;if("signup"===b){if(4>q.getValue().length)return a(q,
"User name must be four\ncharacters or longer"),!1;if(-1<d.indexOf(" ")||-1===d.indexOf("@")||-1===d.indexOf("."))return a(t,"please provide a valid\nemail address"),!1}if("changePassword"===b){if(6>r.getValue().length)return a(r,"password must be six\ncharacters or longer"),!1;if(r.getValue()!==z.getValue())return a(z,"passwords do\nnot match"),!1}return"signup"!==b||Y?!0:(a(C,"please agree to\nthe TOS"),!1)}var q=new InputFieldMorph,t=new InputFieldMorph,r=new InputFieldMorph,z=new InputFieldMorph,
S=new InputFieldMorph,Y=!1,Z=new AlignmentMorph("row",4),O=new AlignmentMorph("column",2),T=new AlignmentMorph("column",2),w=new AlignmentMorph("column",2),U=new AlignmentMorph("row",4),D=new AlignmentMorph("column",this.padding),P={},x=(new Date).getFullYear(),A=x-20,u=this;var I=new InputFieldMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],
December:["December"]},!0);for(x;x>A;--x)P[x.toString()+" "]=x;P[A+" "+localize("or before")]="< "+x;var B=new InputFieldMorph(null,!1,P,!0);w.alignment="left";w.setColor(this.color);D.setColor(this.color);O.alignment="left";O.setColor(this.color);T.alignment="left";T.setColor(this.color);q.setWidth(200);I.setWidth(100);B.contents().minWidth=80;B.setWidth(80);t.setWidth(200);r.setWidth(200);z.setWidth(200);S.setWidth(200);r.contents().text.toggleIsPassword();z.contents().text.toggleIsPassword();S.contents().text.toggleIsPassword();
"login"===b&&(w.add(m("User name:")),w.add(q));if("signup"===b){w.add(m("User name:"));w.add(q);O.add(m("Birth date:"));O.add(I);T.add(m("year:"));T.add(B);Z.add(O);Z.add(T);w.add(Z);var L=m("foo");w.add(L);w.add(t)}"login"===b&&(w.add(m("Password:")),w.add(r));"changePassword"===b&&(w.add(m("Old password:")),w.add(S),w.add(m("New password:")),w.add(r),w.add(m("Repeat new password:")),w.add(z));"resetPassword"===b&&(w.add(m("User name:")),w.add(q));l&&D.add(m(l));D.add(w);(c||e)&&D.add(U);c&&U.add(n(d,
c));e&&U.add(n(f,e));if(g){var C=new ToggleMorph("checkbox",this,function(){Y=!Y},g,function(){return Y});C.edge=this.buttonEdge/2;C.outline=this.buttonOutline/2;C.outlineColor=this.buttonOutlineColor;C.outlineGradient=this.buttonOutlineGradient;C.contrast=this.buttonContrast;C.drawNew();C.fixLayout();D.add(C)}Z.fixLayout();O.fixLayout();T.fixLayout();w.fixLayout();U.fixLayout();D.fixLayout();this.labelString=a;this.createLabel();k&&this.setPicture(k);this.addBody(D);q.drawNew();Z.drawNew();O.drawNew();
I.drawNew();T.drawNew();B.drawNew();r.drawNew();z.drawNew();S.drawNew();t.drawNew();D.fixLayout();this.addButton("ok","OK");this.addButton("cancel","Cancel");this.fixLayout();this.drawNew();this.fixLayout();this.accept=function(){p()&&DialogBoxMorph.prototype.accept.call(u)};this.edit=function(){"changePassword"===b?S.edit():q.edit()};this.getInput=function(){return{username:q.getValue(),email:t.getValue(),oldpassword:S.getValue(),password:r.getValue(),choice:Y}};this.reactToChoice=function(){if("signup"===
b){L.changed();var a=L,c=(new Date).getFullYear()+(new Date).getMonth()/12,d=+B.getValue()||0,e=I.getValue();e instanceof Array&&(e=e[0]);isNaN(d)&&(d=0);e="January February March April May June July August September October November December".split(" ").indexOf(e);isNaN(e)&&(e=0);a.text=13>=c-(d+e/12)?"E-mail address of parent or guardian:":"E-mail address:";L.text=localize(L.text);L.drawNew();L.changed()}};this.reactToChoice();this.key||(this.key="credentials"+a+b);this.popUp(h)};
DialogBoxMorph.prototype.accept=function(){if(this.action)if("function"===typeof this.target)"function"===typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action);else if("function"===typeof this.action)this.action.call(this.target,this.getInput());else this.target[this.action](this.getInput());this.destroy()};DialogBoxMorph.prototype.withKey=function(a){this.key=a;return this};
DialogBoxMorph.prototype.popUp=function(a){a&&(this.key&&(this.instances[a.stamp]?this.instances[a.stamp][this.key]&&this.instances[a.stamp][this.key].destroy():this.instances[a.stamp]={},this.instances[a.stamp][this.key]=this),a.add(this),a.keyboardReceiver=this,this.setCenter(a.center()),this.edit())};DialogBoxMorph.prototype.destroy=function(){DialogBoxMorph.uber.destroy.call(this);this.key&&delete this.instances[this.key]};DialogBoxMorph.prototype.ok=function(){this.accept()};
DialogBoxMorph.prototype.cancel=function(){this.destroy()};DialogBoxMorph.prototype.edit=function(){this.children.forEach(function(a){if(a.edit)return a.edit()})};DialogBoxMorph.prototype.getInput=function(){return this.body instanceof InputFieldMorph?this.body.getValue():null};DialogBoxMorph.prototype.justDropped=function(a){a.world.keyboardReceiver=this;this.edit()};DialogBoxMorph.prototype.destroy=function(){var a=this.world();a.keyboardReceiver=null;a.hand.destroyTemporaries();DialogBoxMorph.uber.destroy.call(this)};
DialogBoxMorph.prototype.normalizeSpaces=function(a){var b="",c,d=!1;for(c=0;c<a.length;c+=1){var e=a[c];" "===e?d&&(b+=e,d=!1):(b+=e,d=!0)}return b.trim()};
DialogBoxMorph.prototype.createLabel=function(){var a=!MorphicPreferences.isFlat||this.is3D;this.label&&this.label.destroy();this.labelString&&(this.label=new StringMorph(localize(this.labelString),this.titleFontSize,this.fontStyle,!0,!1,!1,a?new Point(2,1):null,this.titleBarColor.darker(this.contrast)),this.label.color=this.titleTextColor,this.label.drawNew(),this.add(this.label))};
DialogBoxMorph.prototype.createButtons=function(){this.buttons&&this.buttons.destroy();this.buttons=new AlignmentMorph("row",this.padding);this.add(this.buttons)};
DialogBoxMorph.prototype.addButton=function(a,b){a=new PushButtonMorph(this,a||"ok","  "+localize(b||"OK")+"  ");a.fontSize=this.buttonFontSize;a.corner=this.buttonCorner;a.edge=this.buttonEdge;a.outline=this.buttonOutline;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.padding=this.buttonPadding;a.contrast=this.buttonContrast;a.drawNew();a.fixLayout();this.buttons.add(a);return a};
DialogBoxMorph.prototype.setPicture=function(a){if(a instanceof Morph)var b=a;else b=new Morph,b.image=a,b.silentSetWidth(a.width),b.silentSetHeight(a.height);this.addHead(b)};DialogBoxMorph.prototype.addHead=function(a){this.head&&this.head.destroy();this.head=a;this.add(this.head)};DialogBoxMorph.prototype.addBody=function(a){this.body&&this.body.destroy();this.body=a;this.add(this.body)};DialogBoxMorph.prototype.addShadow=function(){nop()};DialogBoxMorph.prototype.removeShadow=function(){nop()};
DialogBoxMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.head&&(this.head.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.silentSetWidth(this.head.width()+2*this.padding),this.silentSetHeight(this.head.height()+2*this.padding+a));if(this.body)if(this.head){this.body.setPosition(this.head.bottomLeft().add(new Point(0,this.padding)));this.silentSetWidth(Math.max(this.width(),this.body.width()+2*this.padding));this.silentSetHeight(this.height()+
this.body.height()+this.padding);var b=this.width();this.head.setLeft(this.left()+Math.round((b-this.head.width())/2));this.body.setLeft(this.left()+Math.round((b-this.body.width())/2))}else this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+a);this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&
0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.buttons.width()+2*this.padding)),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))};
DialogBoxMorph.prototype.shadowImage=function(a,b){var c=a||new Point(7,7);var d=b||new Color(0,0,0);b=this.extent();var e=this.image;a=newCanvas(b);var f=a.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="destination-out";f.drawImage(e,-c.x,-c.y);c=newCanvas(b);f=c.getContext("2d");f.drawImage(a,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=d.toString();f.fillRect(0,0,b.x,b.y);return c};
DialogBoxMorph.prototype.shadowImageBlurred=function(a,b){a=a||new Point(7,7);var c=this.shadowBlur,d=b||new Color(0,0,0);var e=this.extent().add(2*c);b=this.image;e=newCanvas(e);var f=e.getContext("2d");f.shadowOffsetX=a.x;f.shadowOffsetY=a.y;f.shadowBlur=c;f.shadowColor=d.toString();f.drawImage(b,c-a.x,c-a.y);f.shadowOffsetX=0;f.shadowOffsetY=0;f.shadowBlur=0;f.globalCompositeOperation="destination-out";f.drawImage(b,c-a.x,c-a.y);return e};DialogBoxMorph.prototype.processKeyPress=function(){nop()};
DialogBoxMorph.prototype.processKeyDown=function(a){switch(a.keyCode){case 13:this.ok();break;case 27:this.cancel();break;default:nop()}};
DialogBoxMorph.prototype.drawNew=function(){this.fullChanged();Morph.prototype.trackChanges=!1;DialogBoxMorph.uber.removeShadow.call(this);this.fixLayout();var a=this.width(),b=this.height(),c=Math.floor(fontHeight(this.titleFontSize)+2*this.titlePadding),d=this.corner/2;var e=MorphicPreferences.isFlat&&!this.is3D;this.image=newCanvas(this.extent());var f=this.image.getContext("2d");if(e)f.fillStyle=this.titleBarColor.toString();else{var g=f.createLinearGradient(0,0,0,c);g.addColorStop(0,this.titleBarColor.lighter(this.contrast/
2).toString());g.addColorStop(1,this.titleBarColor.darker(this.contrast).toString());f.fillStyle=g}f.beginPath();this.outlinePathTitle(f,e?0:this.corner);f.closePath();f.fill();f.fillStyle=this.color.toString();f.beginPath();this.outlinePathBody(f,e?0:this.corner);f.closePath();f.fill();e||(g=f.createLinearGradient(0,b-this.corner,0,b),g.addColorStop(0,this.color.toString()),g.addColorStop(1,this.color.darker(this.contrast.toString())),f.lineWidth=this.corner,f.lineCap="round",f.strokeStyle=g,f.beginPath(),
f.moveTo(this.corner,b-d),f.lineTo(this.corner+1,b-d),f.stroke(),g=f.createLinearGradient(0,b-this.corner,0,b),g.addColorStop(0,this.color.toString()),g.addColorStop(1,this.color.darker(this.contrast.toString())),f.lineWidth=this.corner,f.lineCap="butt",f.strokeStyle=g,f.beginPath(),f.moveTo(this.corner,b-d),f.lineTo(a-this.corner,b-d),f.stroke(),g=f.createLinearGradient(a-this.corner,0,a,0),g.addColorStop(0,this.color.toString()),g.addColorStop(1,this.color.darker(this.contrast).toString()),f.lineWidth=
this.corner,f.lineCap="butt",f.strokeStyle=g,f.beginPath(),f.moveTo(a-d,c),f.lineTo(a-d,b-this.corner),f.stroke(),a-=this.corner,e=b-this.corner,g=f.createRadialGradient(a,e,0,a,e,this.corner),g.addColorStop(0,this.color.toString()),g.addColorStop(1,this.color.darker(this.contrast.toString())),f.lineCap="butt",f.strokeStyle=g,f.beginPath(),f.arc(a,e,d,radians(90),radians(0),!0),f.stroke(),g=f.createLinearGradient(0,0,this.corner,0),g.addColorStop(0,this.color.lighter(this.contrast).toString()),g.addColorStop(1,
this.color.toString()),f.lineCap="butt",f.strokeStyle=g,f.beginPath(),f.moveTo(d,c),f.lineTo(d,b-2*this.corner),f.stroke(),g=f.createLinearGradient(0,0,this.corner,0),g.addColorStop(0,this.color.lighter(this.contrast).toString()),g.addColorStop(1,this.color.toString()),f.lineCap="round",f.strokeStyle=g,f.beginPath(),f.moveTo(d,b-2*this.corner),f.lineTo(d,b-this.corner-d),f.stroke());DialogBoxMorph.uber.addShadow.call(this);Morph.prototype.trackChanges=!0;this.fullChanged()};
DialogBoxMorph.prototype.outlinePathTitle=function(a,b){var c=this.width(),d=Math.ceil(fontHeight(this.titleFontSize))+2*this.titlePadding;a.arc(b,b,b,radians(-180),radians(-90),!1);a.arc(c-b,b,b,radians(-90),radians(-0),!1);a.lineTo(c,d);a.lineTo(0,d)};
DialogBoxMorph.prototype.outlinePathBody=function(a,b){var c=this.width(),d=this.height(),e=Math.floor(fontHeight(this.titleFontSize))+2*this.titlePadding;a.moveTo(0,e);a.lineTo(c,e);a.arc(c-b,d-b,b,radians(0),radians(90),!1);a.arc(b,d-b,b,radians(90),radians(180),!1)};AlignmentMorph.prototype=new Morph;AlignmentMorph.prototype.constructor=AlignmentMorph;AlignmentMorph.uber=Morph.prototype;function AlignmentMorph(a,b){this.init(a,b)}
AlignmentMorph.prototype.init=function(a,b){this.orientation=a||"row";this.alignment="center";this.padding=b||0;this.respectHiddens=!1;AlignmentMorph.uber.init.call(this)};AlignmentMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(1,1));this.fixLayout()};
AlignmentMorph.prototype.fixLayout=function(){var a=this,b=null,c;if(0===this.children.length)return null;this.children.forEach(function(d){var e=d.fullBounds();if(d.isVisible||a.respectHiddens){if(b){var f=b.fullBounds();"row"===a.orientation?d.setPosition(f.topRight().add(new Point(a.padding,(f.height()-e.height())/2))):d.setPosition(f.bottomLeft().add(new Point("center"===a.alignment?(f.width()-e.width())/2:0,a.padding)));e=d.fullBounds();c=c.merge(e)}else c=e;b=d}});this.bounds=c};
InputFieldMorph.prototype=new Morph;InputFieldMorph.prototype.constructor=InputFieldMorph;InputFieldMorph.uber=Morph.prototype;InputFieldMorph.prototype.edge=2;InputFieldMorph.prototype.fontSize=12;InputFieldMorph.prototype.typeInPadding=2;InputFieldMorph.prototype.contrast=65;function InputFieldMorph(a,b,c,d){this.init(a,b,c,d)}
InputFieldMorph.prototype.init=function(a,b,c,d){a=new StringFieldMorph(a||"");var e=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));this.choices=c||null;this.isReadOnly=d||!1;this.isNumeric=b||!1;a.alpha=0;a.fontSize=this.fontSize;a.drawNew();this.oldContentsExtent=a.extent();this.isNumeric=b||!1;InputFieldMorph.uber.init.call(this);this.color=new Color(255,255,255);this.add(a);this.add(e);a.isDraggable=!1;this.drawNew()};
InputFieldMorph.prototype.contents=function(){return detect(this.children,function(a){return a instanceof StringFieldMorph})};InputFieldMorph.prototype.arrow=function(){return detect(this.children,function(a){return a instanceof ArrowMorph})};InputFieldMorph.prototype.setChoice=function(a){this.setContents(a);this.escalateEvent("reactToChoice",a)};
InputFieldMorph.prototype.setContents=function(a){var b=this.contents();b.text.text=a;if(void 0===a)return null;null===a?b.text.text="":a.toString&&(b.text.text=a.toString());b.drawNew();b.changed()};InputFieldMorph.prototype.edit=function(){var a=this.contents();a.text.edit();a.text.selectAll()};InputFieldMorph.prototype.setIsNumeric=function(a){this.isNumeric=a;this.contents().isNumeric=a;this.contents().text.isNumeric=a;a=this.getValue();this.isNumeric&&(a=parseFloat(a),isNaN(a)&&(a=null));this.setContents(a)};
InputFieldMorph.prototype.dropDownMenu=function(){var a=this.choices,b,c=new MenuMorph(this.setChoice,null,this,this.fontSize);a instanceof Function?a=a.call(this):isString(a)&&(a=this[a]());if(!a)return null;c.addItem(" ",null);if(a instanceof Array)a.forEach(function(a){c.addItem(a[0],a[1])});else for(b in a)Object.prototype.hasOwnProperty.call(a,b)&&("~"===b[0]?c.addLine():c.addItem(b,a[b]));if(0<c.items.length)c.popUpAtHand(this.world());else return null};
InputFieldMorph.prototype.fixLayout=function(){var a=this.contents(),b=this.arrow();if(!a)return null;a.isNumeric=this.isNumeric;a.isEditable=!this.isReadOnly;this.choices?(b.setSize(this.fontSize),b.show()):(b.setSize(0),b.hide());this.silentSetHeight(a.height()+2*this.edge+2*this.typeInPadding);this.silentSetWidth(Math.max(a.minWidth+2*this.edge+2*this.typeInPadding,this.width()));a.setWidth(this.width()-this.edge-this.typeInPadding-(this.choices?b.width()+this.typeInPadding:0));a.silentSetPosition((new Point(this.edge,
this.edge)).add(this.typeInPadding).add(this.position()));b.silentSetPosition(new Point(this.right()-b.width()-this.edge,a.top()))};InputFieldMorph.prototype.mouseClickLeft=function(a){this.arrow().bounds.containsPoint(a)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.escalateEvent("mouseClickLeft",a)};InputFieldMorph.prototype.getValue=function(){var a=this.contents();if(this.isNumeric){var b=parseFloat(a.text);if(!isNaN(b))return b}return this.normalizeSpaces(a.string())};
InputFieldMorph.prototype.normalizeSpaces=DialogBoxMorph.prototype.normalizeSpaces;
InputFieldMorph.prototype.drawNew=function(){this.fixLayout();this.image=newCanvas(this.extent());var a=this.image.getContext("2d");if(this.parent){this.parent.color.eq(new Color(255,255,255))?this.color=this.parent.color.darker(.1*this.contrast):this.color=this.parent.color.lighter(.75*this.contrast);var b=this.parent.color}else b=new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();
a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge);this.drawRectBorder(a)};
InputFieldMorph.prototype.drawRectBorder=function(a){var b=.5*this.edge;if(!MorphicPreferences.isFlat||this.is3D){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.shadowOffsetY=b;a.shadowBlur=4*this.edge;a.shadowColor=this.cachedClrDark;var c=a.createLinearGradient(0,0,0,this.edge);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,b);a.lineTo(this.width()-this.edge-b,b);a.stroke();a.shadowOffsetY=0;c=a.createLinearGradient(0,
0,this.edge,0);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(b,this.edge);a.lineTo(b,this.height()-this.edge-b);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;c=a.createLinearGradient(0,this.height()-this.edge,0,this.height());c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,this.height()-b);a.lineTo(this.width()-this.edge,this.height()-b);a.stroke();
c=a.createLinearGradient(this.width()-this.edge,0,this.width(),0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.width()-b,this.edge);a.lineTo(this.width()-b,this.height()-this.edge);a.stroke()}};PianoMenuMorph.prototype=new MenuMorph;PianoMenuMorph.prototype.constructor=PianoMenuMorph;PianoMenuMorph.uber=MenuMorph.prototype;function PianoMenuMorph(a,b,c,d){this.init(a,b,c,d)}
PianoMenuMorph.prototype.init=function(a,b,c,d){var e;this.soundType=d;PianoMenuMorph.uber.init.call(this,a,null,b,c);a={"C (48)":48,"D (50)":50,"C# (49)":49,"E (52)":52,"Eb (51)":51,"F (53)":53,"G (55)":55,"F# (54)":54,"A (57)":57,"G# (56)":56,"B (59)":59,"Bb (58)":58,"C (60)":60,"D (62)":62,"C# (61)":61,"E (64)":64,"Eb (63)":63,"F (65)":65,"G (67)":67,"F# (66)":66,"A (69)":69,"G# (68)":68,"B (71)":71,"Bb (70)":70,"C (72)":72};for(e in a)Object.prototype.hasOwnProperty.call(a,e)&&this.addItem(e,
a[e]);this.drawNew()};
PianoMenuMorph.prototype.drawNew=function(){var a=this,b,c,d,e,f,g,h;this.children.forEach(function(a){a.destroy()});this.children=[];this.isListContents||(this.edge=MorphicPreferences.isFlat?0:5,this.border=MorphicPreferences.isFlat?1:2);this.color=new Color(255,255,255);this.borderColor=new Color(60,60,60);this.silentSetExtent(new Point(0,0));var k=this.left()+1;var l=this.top()+1.5*this.fontSize+2;var m=new StringMorph("",this.fontSize);this.items.forEach(function(p){c=" "!==p[0][1];d=new BoxMorph(1,
1);c?(e=new Color(0,0,0),f=a.fontSize,g=2.5*a.fontSize,h=new Point(k+2-2*a.fontSize,l)):(e=new Color(255,255,255),f=1.5*a.fontSize,g=4*a.fontSize,h=new Point(k+1,l),k+=f-1);d.setColor(e);d.setWidth(f);d.setHeight(g);b=new PianoKeyMorph(a.target,p[1],[d,p[0]],a.fontSize||MorphicPreferences.menuFontSize,MorphicPreferences.menuFontName,a.environment,p[2],p[3],p[4],p[5],p[6],m);b.setPosition(h);a.add(b)});var n=this.fullBounds();m.setPosition(new Point(n.width()/2-this.fontSize,2));this.add(m);n=this.fullBounds();
this.silentSetExtent(n.extent().add(2));MenuMorph.uber.drawNew.call(this)};PianoMenuMorph.prototype.select=function(a){this.unselectAllItems();a.mouseEnter();this.selection=a;this.world.keyboardReceiver=this;this.hasFocus=!0};PianoMenuMorph.prototype.unselectAllItems=function(){this.children.forEach(function(a){a instanceof MenuItemMorph&&a.mouseLeave()});this.changed()};
PianoMenuMorph.prototype.selectKey=function(a){var b;isNil(a)||((b=detect(this.children,function(b){return b.action===a}))?this.select(b):this.selectKey(48))};
PianoMenuMorph.prototype.processKeyDown=function(a){switch(a.keyCode){case 13:case 32:this.selection&&this.selection.mouseClickLeft();break;case 27:return this.destroy();case 37:case 40:case 189:return this.selectDown();case 38:case 39:case 187:case 220:return this.selectUp();default:switch(a.key){case "C":return this.selectKey(48);case "c":return this.selectKey(60);case "D":return this.selectKey(50);case "d":return this.selectKey(62);case "E":return this.selectKey(52);case "e":return this.selectKey(64);
case "F":return this.selectKey(53);case "f":return this.selectKey(65);case "G":return this.selectKey(55);case "g":return this.selectKey(67);case "A":return this.selectKey(57);case "a":return this.selectKey(69);case "B":case "H":return this.selectKey(59);case "b":case "h":return this.selectKey(71);default:nop()}}};PianoMenuMorph.prototype.selectUp=function(){var a=48;this.selection&&(a=this.selection.action+1,72<a&&(a=48));this.selectKey(a)};
PianoMenuMorph.prototype.selectDown=function(){var a=48;this.selection&&(a=this.selection.action-1,48>a&&(a=72));this.selectKey(a)};PianoMenuMorph.prototype.destroy=function(){this.children.forEach(function(a){a.note&&a.note.stop()});PianoMenuMorph.uber.destroy.call(this)};PianoKeyMorph.prototype=new MenuItemMorph;PianoKeyMorph.prototype.constructor=PianoKeyMorph;PianoKeyMorph.uber=MenuItemMorph.prototype;
function PianoKeyMorph(a,b,c,d,e,f,g,h,k,l,m,n){this.init(a,b,c,d,e,f,g,h,k,l,m,n);this.feedback=n}PianoKeyMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l,m,n){this.note=new Note(b);PianoKeyMorph.uber.init.call(this,a,b,c,d,e,f,g,h,k,l,m,n)};
PianoKeyMorph.prototype.createLabel=function(){null!==this.label&&this.label.destroy();this.label=new Morph;var a=this.createIcon(this.labelString[0]);this.label.add(a);this.label.drawNew();this.silentSetExtent(a.extent());this.label.bounds=this.position().extent(this.label.extent());this.label.silentSetExtent(new Point(0,0));this.add(this.label)};
PianoKeyMorph.prototype.mouseEnter=function(){var a=this.parentThatIsA(PianoMenuMorph),b=a?a.soundType:1,c=this;a&&(a.unselectAllItems(),a.selection=this,a.world.keyboardReceiver=a,a.hasFocus=!0);this.label.children[0].hide();this.image=this.highlightImage;this.changed();this.feedback.text=this.labelString[1];this.feedback.changed();this.feedback.drawNew();this.feedback.changed();this.note.play(b);setTimeout(function(){c.note.stop()},400)};
PianoKeyMorph.prototype.mouseLeave=function(){this.note.stop();this.label.children[0].show();this.image=this.normalImage;this.changed()};modules.blocks="2017-November-16";SyntaxElementMorph.prototype=new Morph;SyntaxElementMorph.prototype.constructor=SyntaxElementMorph;SyntaxElementMorph.uber=Morph.prototype;
SyntaxElementMorph.prototype.setScale=function(a){this.scale=a=Math.min(Math.max(a,1),25);this.corner=3*a;this.rounding=9*a;this.edge=1.000001*a;this.inset=6*a;this.hatHeight=12*a;this.hatWidth=70*a;this.rfBorder=3*a;this.minWidth=0;this.dent=8*a;this.bottomPadding=3*a;this.cSlotPadding=4*a;this.typeInPadding=a;this.labelPadding=4*a;this.labelFontName="Verdana";this.labelFontStyle="sans-serif";this.fontSize=10*a;this.embossing=new Point(-1*Math.max(a/2,1),-1*Math.max(a/2,1));this.labelWidth=450*a;
this.dynamicInputLabels=this.labelWordWrap=!0;this.feedbackColor=new Color(255,255,255);this.feedbackMinHeight=5;this.minSnapDistance=20;this.reporterDropFeedbackPadding=10*a;this.contrast=65;this.labelContrast=25;this.activeHighlight=new Color(153,255,213);this.errorHighlight=new Color(173,15,0);this.activeBlur=20;this.activeBorder=4;this.rfColor=new Color(120,120,120)};SyntaxElementMorph.prototype.setScale(1);SyntaxElementMorph.prototype.isCachingInputs=!1;
function SyntaxElementMorph(){this.init()}SyntaxElementMorph.prototype.init=function(a){this.cachedNormalColor=this.cachedClrDark=this.cachedClrBright=this.cachedClr=null;this.isStatic=!1;SyntaxElementMorph.uber.init.call(this,a);this.defaults=[];this.cachedInputs=null};SyntaxElementMorph.prototype.parts=function(){var a=null;this.nextBlock&&(a=this.nextBlock());return this.children.filter(function(b){return b!==a&&!(b instanceof ShadowMorph)&&!(b instanceof BlockHighlightMorph)})};
SyntaxElementMorph.prototype.inputs=function(){if(isNil(this.cachedInputs)||!this.isCachingInputs)this.cachedInputs=this.parts().filter(function(a){return a instanceof SyntaxElementMorph});return this.cachedInputs};
SyntaxElementMorph.prototype.debugCachedInputs=function(){var a,b;isNil(this.cachedInputs)||(a=this.parts().filter(function(a){return a instanceof SyntaxElementMorph}));if(this.cachedInputs.length!==a.length)throw Error("cached inputs size do not match: "+this.constructor.name);for(b=0;b<a.length;b+=1)if(this.cachedInputs[b]!==a[b])throw Error("cached input does not match: "+this.constructor.name+" #"+b+" "+this.cachedInputs[b].constructor.name+" != "+a[b].constructor.name);};
SyntaxElementMorph.prototype.allInputs=function(){var a=this;return this.allChildren().slice(0).reverse().filter(function(b){return b instanceof ArgMorph||b instanceof ReporterBlockMorph&&b!==a})};SyntaxElementMorph.prototype.allEmptySlots=function(){var a=[];this instanceof RingMorph||"reportJSFunction"===this.selector||this.children.forEach(function(b){b.isEmptySlot&&b.isEmptySlot()?a.push(b):b.allEmptySlots&&(a=a.concat(b.allEmptySlots()))});return a};
SyntaxElementMorph.prototype.tagExitBlocks=function(a,b){"doReport"===this.selector?this.partOfCustomCommand=b:"doStopThis"===this.selector?this.exitTag=a:this instanceof RingMorph||this.children.forEach(function(c){c.tagExitBlocks&&c.tagExitBlocks(a,b)})};
SyntaxElementMorph.prototype.replaceInput=function(a,b){var c=this.parentThatIsA(ScriptsMorph),d=b,e=this.children.indexOf(a),f=0;-1===e&&b instanceof MultiArgMorph&&this.children.forEach(function(b){b instanceof ArgLabelMorph&&b.argMorph()===a&&(e=f);f+=1});if(-1===e||null===c)return null;a.cachedSlotSpec&&(a.cachedSlotSpec=null);b.cachedSlotSpec&&(b.cachedSlotSpec=null);this.startLayout();b.parent&&b.parent.removeChild(b);a instanceof MultiArgMorph&&(a.inputs().forEach(function(b){a.replaceInput(b,
new InputSlotMorph)}),this.dynamicInputLabels&&(d=new ArgLabelMorph(b)));d.parent=this;this.children[e]=d;a instanceof ReporterBlockMorph&&(!(a instanceof RingMorph)||a instanceof RingMorph&&a.contents())&&(c.add(a),a.moveBy(d.extent()),a.fixBlockColor());d instanceof MultiArgMorph||d instanceof ArgLabelMorph||d.constructor===CommandSlotMorph?(d.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(d.drawNew(),this.fixLayout());this.cachedInputs=null;this.endLayout()};
SyntaxElementMorph.prototype.silentReplaceInput=function(a,b){var c=this.children.indexOf(a);-1!==c&&(a.cachedSlotSpec&&(a.cachedSlotSpec=null),b.cachedSlotSpec&&(b.cachedSlotSpec=null),b.parent&&b.parent.removeChild(b),a=a instanceof MultiArgMorph&&this.dynamicInputLabels?new ArgLabelMorph(b):b,a.parent=this,this.children[c]=a,a instanceof MultiArgMorph||a instanceof ArgLabelMorph||a.constructor===CommandSlotMorph?(a.fixLayout(),this.fixLabelColor&&this.fixLabelColor()):(a.drawNew(),this.fixLayout()),
this.cachedInputs=null)};
SyntaxElementMorph.prototype.revertToDefaultInput=function(a,b){var c=this.parts().indexOf(a),d=this.inputs().indexOf(a),e=new InputSlotMorph;-1!==c&&(this instanceof BlockMorph?(e=this.labelPart(this.parseSpec(this.blockSpec)[c]),this.isCustomBlock&&(c=this.isGlobal?this.definition:this.scriptTarget().getMethod(this.blockSpec),e instanceof InputSlotMorph&&e.setChoices.apply(e,c.inputOptionsOfIdx(d)),(e instanceof InputSlotMorph||e instanceof BooleanSlotMorph)&&e.setContents(c.defaultValueOfInputIdx(d)))):this instanceof
MultiArgMorph?e=this.labelPart(this.slotSpec):this instanceof ReporterSlotMorph&&(e=this.emptySlot()));b||-1===d||(e instanceof MultiArgMorph?(e.setContents(this.defaults),e.defaults=this.defaults):isNil(this.defaults[d])||e.setContents(this.defaults[d]));this.silentReplaceInput(a,e);e instanceof MultiArgMorph?e.refresh():e instanceof RingMorph&&e.fixBlockColor();this.cachedInputs=null};SyntaxElementMorph.prototype.isLocked=function(){return this.isStatic};
SyntaxElementMorph.prototype.topBlock=function(){return this.parent&&this.parent.topBlock?this.parent.topBlock():this};
SyntaxElementMorph.prototype.getVarNamesDict=function(){var a=this.parentThatIsA(BlockMorph),b=[];if(!a)return{};var c=a.scriptTarget();a.allParents().forEach(function(a){a instanceof PrototypeHatBlockMorph?(b.push.apply(b,a.variableNames()),b.push.apply(b,a.inputs()[0].inputFragmentNames())):a instanceof BlockMorph&&a.inputs().forEach(function(a){a instanceof TemplateSlotMorph?b.push(a.contents()):a instanceof MultiArgMorph&&a.children.forEach(function(a){a instanceof TemplateSlotMorph&&b.push(a.contents())})})});
if(c){var d=c.variables.allNamesDict();b.forEach(function(a){d[a]=a});return d}return{}};
SyntaxElementMorph.prototype.refactorVarInStack=function(a,b,c){this instanceof RingMorph&&contains(this.inputNames(),a)||!c&&this.definesScriptVariable(a)||("reportGetVar"===this.selector&&this.blockSpec===a&&(this.setSpec(b),this.fullChanged(),this.fixLabelColor()),"getVarNamesDict"===this.choices&&this.contents().text===a&&this.setContents(b),this instanceof CustomCommandBlockMorph&&this.definition.body&&isNil(this.definition.declarations[a])&&!contains(this.definition.variableNames,a)&&this.definition.body.expression.refactorVarInStack(a,
b),this.inputs().forEach(function(c){c.refactorVarInStack(a,b)}),this.nextBlock&&(c=this.nextBlock())&&c.refactorVarInStack(a,b))};SyntaxElementMorph.prototype.definesScriptVariable=function(a){return("doDeclareVariables"===this.selector||this.blockSpec&&this.blockSpec.match("%upvar"))&&detect(this.inputs()[0].allInputs(),function(b){return"reportGetVar"===b.selector&&b.blockSpec===a})};
SyntaxElementMorph.prototype.selectForEdit=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.parentThatIsA(IDE_Morph);b=b?b.currentSprite:null;return a&&b&&b.inheritsAttribute("scripts")?(this.selectionID=!0,b.shadowAttribute("scripts"),a=detect(b.scripts.allChildren(),function(a){return a.selectionID}),delete this.selectionID,delete a.selectionID,a):this};
SyntaxElementMorph.prototype.reactToGrabOf=function(a){var b=this.topBlock();a instanceof CommandBlockMorph&&(a=this.parentThatIsA(CommandSlotMorph))&&(this.startLayout(),a.fixLayout(),this.endLayout());b&&(b.allComments().forEach(function(a){a.align(b)}),b.getHighlight()&&b.addHighlight(b.removeHighlight()))};SyntaxElementMorph.prototype.bright=function(){return this.color.lighter(this.contrast).toString()};SyntaxElementMorph.prototype.dark=function(){return this.color.darker(this.contrast).toString()};
SyntaxElementMorph.prototype.setColor=function(a,b){a&&!this.color.eq(a)&&(this.color=a,b||this.drawNew(),this.children.forEach(function(a){b&&!(a instanceof TemplateSlotMorph)||a instanceof BlockHighlightMorph||(a.drawNew(),a.changed())}),this.changed())};
SyntaxElementMorph.prototype.setLabelColor=function(a,b,c){this.children.forEach(function(d){d instanceof StringMorph&&!d.isProtectedLabel?(d.shadowOffset=c||d.shadowOffset,d.shadowColor=b||d.shadowColor,d.setColor(a)):(d instanceof MultiArgMorph||d instanceof ArgLabelMorph||d instanceof SymbolMorph&&!d.isProtectedLabel||d instanceof InputSlotMorph&&d.isReadOnly)&&d.setLabelColor(a,b,c)})};SyntaxElementMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.setColor(this.activeHighlight))};
SyntaxElementMorph.prototype.unflash=function(){if(this.cachedNormalColor){var a=this.cachedNormalColor;this.cachedNormalColor=null;this.setColor(a)}};SyntaxElementMorph.prototype.fixBlockColor=function(a,b){this.children.forEach(function(c){c instanceof SyntaxElementMorph&&c.fixBlockColor(a,b)})};
SyntaxElementMorph.prototype.labelPart=function(a){if("%"===a[0]&&1<a.length&&("reportGetVar"!==this.selector||"%turtleOutline"===a&&this.isObjInputFragment())){if(5<a.length&&"%mult"===a.slice(0,5)){var b=new MultiArgMorph(a.slice(5));b.addInput();return b}switch(a){case "%imgsource":b=new InputSlotMorph(null,!1,{"pen trails":["pen trails"],"stage image":["stage image"]},!0);b.setContents(["pen trails"]);break;case "%inputs":b=new MultiArgMorph("%s","with inputs");b.isStatic=!1;b.canBeEmpty=!1;break;
case "%scriptVars":b=new MultiArgMorph("%t",null,1,a);b.canBeEmpty=!1;break;case "%blockVars":b=new MultiArgMorph("%t","block variables",0,a);b.canBeEmpty=!1;break;case "%parms":b=new MultiArgMorph("%t","Input Names:",0,a);b.canBeEmpty=!1;break;case "%ringparms":b=new MultiArgMorph("%t","input names:",0,a);break;case "%cmdRing":b=new RingMorph;b.color=SpriteMorph.prototype.blockColor.other;b.selector="reifyScript";b.setSpec("%rc %ringparms");b.isDraggable=!0;break;case "%repRing":b=new RingMorph;
b.color=SpriteMorph.prototype.blockColor.other;b.selector="reifyReporter";b.setSpec("%rr %ringparms");b.isDraggable=!0;b.isStatic=!0;break;case "%predRing":b=new RingMorph(!0);b.color=SpriteMorph.prototype.blockColor.other;b.selector="reifyPredicate";b.setSpec("%rp %ringparms");b.isDraggable=!0;b.isStatic=!0;break;case "%words":b=new MultiArgMorph("%s",null,0);b.addInput();b.addInput();b.isStatic=!1;break;case "%exp":b=new MultiArgMorph("%s",null,0);b.addInput();b.isStatic=!0;b.canBeEmpty=!1;break;
case "%br":b=new Morph;b.setExtent(new Point(0,0));b.isBlockLabelBreak=!0;b.getSpec=function(){return"%br"};break;case "%inputName":b=new ReporterBlockMorph;b.category="variables";b.color=SpriteMorph.prototype.blockColor.variables;b.setSpec(localize("Input name"));break;case "%s":b=new InputSlotMorph;break;case "%anyUE":b=new InputSlotMorph;b.isUnevaluated=!0;break;case "%txt":b=new InputSlotMorph;b.minWidth=1.7*b.height();b.fixLayout();break;case "%mlt":b=new TextSlotMorph;b.fixLayout();break;case "%code":b=
new TextSlotMorph;b.contents().fontName="monospace";b.contents().fontStyle="monospace";b.fixLayout();break;case "%obj":b=new ArgMorph("object");break;case "%n":b=new InputSlotMorph(null,!0);break;case "%dir":b=new InputSlotMorph(null,!0,{"(90) right":90,"(-90) left":-90,"(0) up":"0","(180) down":180});b.setContents(90);break;case "%note":b=new InputSlotMorph(null,!0,"pianoKeyboardMenu",!1);break;case "%inst":b=new InputSlotMorph(null,!0,{"(1) sine":1,"(2) square":2,"(3) sawtooth":3,"(4) triangle":4});
b.setContents(1);break;case "%month":b=new InputSlotMorph(null,!1,{January:["January"],February:["February"],March:["March"],April:["April"],May:["May"],June:["June"],July:["July"],August:["August"],September:["September"],October:["October"],November:["November"],December:["December"]},!0);break;case "%interaction":b=new InputSlotMorph(null,!1,{clicked:["clicked"],pressed:["pressed"],dropped:["dropped"],"mouse-entered":["mouse-entered"],"mouse-departed":["mouse-departed"]},!0);b.isStatic=!0;break;
case "%dates":b=new InputSlotMorph(null,!1,{year:["year"],month:["month"],date:["date"],"day of week":["day of week"],hour:["hour"],minute:["minute"],second:["second"],"time in milliseconds":["time in milliseconds"]},!0);b.setContents(["date"]);break;case "%delim":b=new InputSlotMorph(null,!1,{letter:["letter"],whitespace:["whitespace"],line:["line"],tab:["tab"],cr:["cr"],csv:["csv"]},!1);break;case "%ida":b=new InputSlotMorph(null,!0,{1:1,last:["last"],"~":null,all:["all"]});b.setContents(1);break;
case "%idx":b=new InputSlotMorph(null,!0,{1:1,last:["last"],any:["any"]});b.setContents(1);break;case "%spr":b=new InputSlotMorph(null,!1,"objectsMenu",!0);break;case "%col":b=new InputSlotMorph(null,!1,"collidablesMenu",!0);break;case "%dst":b=new InputSlotMorph(null,!1,"distancesMenu",!0);break;case "%cln":b=new InputSlotMorph(null,!1,"clonablesMenu",!0);break;case "%get":b=new InputSlotMorph(null,!1,"gettablesMenu",!0);b.isStatic=!0;break;case "%cst":b=new InputSlotMorph(null,!1,"costumesMenu",
!0);break;case "%eff":b=new InputSlotMorph(null,!1,{color:["color"],fisheye:["fisheye"],whirl:["whirl"],pixelate:["pixelate"],mosaic:["mosaic"],duplicate:["duplicate"],negative:["negative"],comic:["comic"],confetti:["confetti"],saturation:["saturation"],brightness:["brightness"],ghost:["ghost"]},!0);b.setContents(["ghost"]);break;case "%snd":b=new InputSlotMorph(null,!1,"soundsMenu",!0);break;case "%key":b=new InputSlotMorph(null,!1,{"any key":["any key"],"up arrow":["up arrow"],"down arrow":["down arrow"],
"right arrow":["right arrow"],"left arrow":["left arrow"],space:["space"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"]},!0);b.setContents(["space"]);break;case "%keyHat":b=this.labelPart("%key");b.isStatic=!0;break;case "%msg":b=new InputSlotMorph(null,!1,"messagesMenu",
!0);break;case "%msgHat":b=new InputSlotMorph(null,!1,"messagesReceivedMenu",!0);b.isStatic=!0;break;case "%att":b=new InputSlotMorph(null,!1,"attributesMenu",!0);break;case "%fun":b=new InputSlotMorph(null,!1,{abs:["abs"],ceiling:["ceiling"],floor:["floor"],sqrt:["sqrt"],sin:["sin"],cos:["cos"],tan:["tan"],asin:["asin"],acos:["acos"],atan:["atan"],ln:["ln"],log:["log"],"e^":["e^"],"10^":["10^"]},!0);b.setContents(["sqrt"]);break;case "%txtfun":b=new InputSlotMorph(null,!1,{"encode URI":["encode URI"],
"decode URI":["decode URI"],"encode URI component":["encode URI component"],"decode URI component":["decode URI component"],"XML escape":["XML escape"],"XML unescape":["XML unescape"],"hex sha512 hash":["hex sha512 hash"]},!0);b.setContents(["encode URI"]);break;case "%stopChoices":b=new InputSlotMorph(null,!1,{all:["all"],"this script":["this script"],"this block":["this block"],"all but this script":["all but this script"],"other scripts in sprite":["other scripts in sprite"]},!0);b.setContents(["all"]);
b.isStatic=!0;break;case "%typ":b=new InputSlotMorph(null,!1,"typesMenu",!0);b.setContents(["number"]);break;case "%mapValue":b=new InputSlotMorph(null,!1,{String:["String"],Number:["Number"],"true":["true"],"false":["false"]},!0);b.setContents(["String"]);b.isStatic=!0;break;case "%var":b=new InputSlotMorph(null,!1,"getVarNamesDict",!0);b.isStatic=!0;break;case "%shd":b=new InputSlotMorph(null,!1,"shadowedVariablesMenu",!0);break;case "%lst":b=new InputSlotMorph(null,!1,{list1:"list1",list2:"list2",
list3:"list3"},!0);break;case "%codeKind":b=new InputSlotMorph(null,!1,{code:["code"],header:["header"]},!0);b.setContents(["code"]);break;case "%l":b=new ArgMorph("list");break;case "%b":b=new BooleanSlotMorph;break;case "%boolUE":b=new BooleanSlotMorph;b.isUnevaluated=!0;break;case "%bool":b=new BooleanSlotMorph(!0);b.isStatic=!0;break;case "%cmd":b=new CommandSlotMorph;break;case "%rc":b=new RingCommandSlotMorph;b.isStatic=!0;break;case "%rr":b=new RingReporterSlotMorph;b.isStatic=!0;break;case "%rp":b=
new RingReporterSlotMorph(!0);b.isStatic=!0;break;case "%c":b=new CSlotMorph;b.isStatic=!0;break;case "%cs":b=new CSlotMorph;break;case "%cl":b=new CSlotMorph;b.isStatic=!0;b.isLambda=!0;break;case "%clr":b=new ColorSlotMorph;b.isStatic=!0;break;case "%t":b=new TemplateSlotMorph("a");break;case "%upvar":b=new TemplateSlotMorph("\u2191");break;case "%f":b=new FunctionSlotMorph;break;case "%r":b=new ReporterSlotMorph;break;case "%p":b=new ReporterSlotMorph(!0);break;case "%codeListPart":b=new InputSlotMorph(null,
!1,{list:["list"],item:["item"],delimiter:["delimiter"]},!0);break;case "%codeListKind":b=new InputSlotMorph(null,!1,{collection:["collection"],variables:["variables"],parameters:["parameters"]},!0);break;case "%turtle":b=new SymbolMorph("turtle");b.size=1.2*this.fontSize;b.color=new Color(255,255,255);b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing;b.drawNew();break;case "%turtleOutline":b=new SymbolMorph("turtleOutline");b.size=
this.fontSize;b.color=new Color(255,255,255);b.isProtectedLabel=!0;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing;b.drawNew();break;case "%clockwise":b=new SymbolMorph("turnRight");b.size=1.5*this.fontSize;b.color=new Color(255,255,255);b.isProtectedLabel=!1;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing;b.drawNew();break;case "%counterclockwise":b=new SymbolMorph("turnLeft");
b.size=1.5*this.fontSize;b.color=new Color(255,255,255);b.isProtectedLabel=!1;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing;b.drawNew();break;case "%greenflag":b=new SymbolMorph("flag");b.size=1.5*this.fontSize;b.color=new Color(0,200,0);b.isProtectedLabel=!0;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing;b.drawNew();break;case "%stop":b=new SymbolMorph("octagon");
b.size=1.5*this.fontSize;b.color=new Color(200,0,0);b.isProtectedLabel=!0;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing;b.drawNew();break;case "%pause":b=new SymbolMorph("pause");b.size=this.fontSize;b.color=new Color(255,220,0);b.isProtectedLabel=!0;b.shadowColor=this.color.darker(this.labelContrast);b.shadowOffset=MorphicPreferences.isFlat?new Point:this.embossing;b.drawNew();break;default:nop()}}else"$"===a[0]&&1<a.length&&
"reportGetVar"!==this.selector?(a=a.slice(1).split("-"),contains(SymbolMorph.prototype.names,a[0])?(b=new SymbolMorph(a[0]),b.size=this.fontSize*(+a[1]||1.2)):(b=new StringMorph(a[0]),b.fontName=this.labelFontName,b.fontStyle=this.labelFontStyle,b.fontSize=this.fontSize*(+a[1]||1)),b.color=new Color(0===+a[2]?0:+a[2]||255,0===+a[3]?0:+a[3]||255,0===+a[4]?0:+a[4]||255),b.isProtectedLabel=2<a.length,b.shadowColor=this.color.darker(this.labelContrast),b.shadowOffset=MorphicPreferences.isFlat?new Point:
this.embossing,b.drawNew()):b=new StringMorph(a,this.fontSize,this.labelFontStyle,!0,!1,!1,MorphicPreferences.isFlat?new Point:this.embossing,this.color.darker(this.labelContrast),new Color(255,255,255),this.labelFontName);return b};SyntaxElementMorph.prototype.isObjInputFragment=function(){return"reportGetVar"===this.selector&&"%t"===this.getSlotSpec()&&"%obj"===this.parent.fragment.type};
SyntaxElementMorph.prototype.fixLayout=function(a){var b,c=this.parts(),d=this,e=0,f=0,g=0,h=this.minWidth,k,l=[],m=[],n=this.isPrototype?1:Math.floor(fontHeight(this.fontSize)/3),p=this.isCustomBlock&&!this.isGlobal?this.methodIconExtent().x+n:0,q=this.extent();h=this instanceof MultiArgMorph&&"%c"!==this.slotSpec?h+this.arrows().width():this instanceof ReporterBlockMorph?h+(2*this.rounding+2*this.edge):h+(4*this.corner+2*this.edge+3*this.inset+this.dent);this.nextBlock&&(b=this.nextBlock());c.forEach(function(a){a instanceof
CSlotMorph||"%c"===a.slotSpec?0<l.length?(m.push(l),m.push([a]),l=[],e=0):m.push([a]):a instanceof BlockHighlightMorph?nop():(a.isVisible&&(e+=a.fullBounds().width()+n),(e>d.labelWidth||a.isBlockLabelBreak)&&0<l.length&&(m.push(l),l=[],e=a.fullBounds().width()+n),l.push(a),a.isBlockLabelBreak&&(e=0))});0<l.length&&m.push(l);if(this instanceof CommandBlockMorph){var t=this.top()+this.corner+this.edge;this instanceof HatBlockMorph&&(t+=this.hatHeight)}else if(this instanceof ReporterBlockMorph)t=this.top()+
2*this.edge;else if(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)t=this.top();m.forEach(function(a){e=d.left()+p+d.edge+d.labelPadding;if(d instanceof RingMorph)e=d.left()+n;else if(d.isPredicate)e=d.left()+p+d.rounding;else if(d instanceof MultiArgMorph||d instanceof ArgLabelMorph)e=d.left();t+=f;f=0;a.forEach(function(a){a instanceof CSlotMorph?(e-=d.labelPadding,d.isPredicate&&(e=d.left()+p+d.rounding),a.setColor(d.color),a.setPosition(new Point(e,t)),f=a.height()):(a.setPosition(new Point(e,
t)),a.isBlockLabelBreak||("%c"===a.slotSpec?e+=a.width():a.isVisible&&(e+=a.fullBounds().width()+n)),g=Math.max(g,e),f=Math.max(f,a instanceof StringMorph?a.rawHeight():a.height()))});a.forEach(function(a){a.moveBy(new Point(0,Math.floor((f-a.height())/2)))})});t+=f;if(this.children.some(function(a){return a instanceof CSlotMorph})){var r=this.bottomPadding;this instanceof ReporterBlockMorph&&!this.isPredicate&&(r=Math.max(this.bottomPadding,this.rounding-this.bottomPadding));t+=r}if(this instanceof
CommandBlockMorph)var z=t-this.top()+2*this.corner;else if(this instanceof ReporterBlockMorph)z=t-this.top()+2*this.edge;else if(this instanceof MultiArgMorph||this instanceof ArgLabelMorph)z=t-this.top();this.isPredicate?h=Math.max(h,g-this.left()+this.rounding):this instanceof MultiArgMorph||this instanceof ArgLabelMorph?h=Math.max(h,g-this.left()-n):(h=Math.max(h,g-this.left()+this.labelPadding-this.edge),c[c.length-1]instanceof MultiArgMorph&&1===m.length&&(h-=n),this instanceof HatBlockMorph&&
(h=Math.max(h,1.5*this.hatWidth)));this.silentSetExtent(new Point(h,z));c.forEach(function(a){a instanceof CSlotMorph&&(d.isPredicate?a.setWidth(h-p-2*d.rounding):a.setWidth(h-d.edge-p))});a||this.drawNew();b&&b.setPosition(new Point(this.left(),this.bottom()-this.corner));if(this instanceof CommandBlockMorph){if(this.height()!==q.y&&(k=this.parentThatIsA(CommandSlotMorph))&&k.fixLayout(),this.width()!==q.x&&(k=this.parentThatIsAnyOf([ReporterBlockMorph,CommandSlotMorph,RingCommandSlotMorph]))&&k.fixLayout(),
k)return}else if(this instanceof ReporterBlockMorph&&this.parent&&this.parent.fixLayout)return this.parent.fixLayout();this.fixHighlight()};SyntaxElementMorph.prototype.fixHighlight=function(){var a=this.topBlock();a.getHighlight&&a.getHighlight()&&a.addHighlight(a.removeHighlight())};SyntaxElementMorph.prototype.methodIconExtent=function(){var a=1.2*this.fontSize;return this.isCustomBlock&&!this.isGlobal?new Point(.66*a,a):new Point(0,0)};SyntaxElementMorph.prototype.evaluate=function(){return null};
SyntaxElementMorph.prototype.isEmptySlot=function(){return!1};
SyntaxElementMorph.prototype.showBubble=function(a,b,c){var d=!1,e=this.parentThatIsA(IDE_Morph),f=this,g=this.rightCenter().add(new Point(2,0)),h=this.parentThatIsA(ScrollFrameMorph),k=this.world();if(void 0===a||!k)return null;if(a instanceof ListWatcherMorph){var l=a;l.update(!0);l.step=a.update;l.isDraggable=!1;l.expand(this.parentThatIsA(ScrollFrameMorph).extent());d=!0}else if(a instanceof TableFrameMorph)l=a,l.isDraggable=!1,l.expand(this.parentThatIsA(ScrollFrameMorph).extent()),d=!0;else if(a instanceof
Morph)if(isSnapObject(a)){var m=a.thumbnail(new Point(40,40));l=new Morph;l.silentSetWidth(m.width);l.silentSetHeight(m.height);l.image=m;l.version=a.version;l.step=function(){this.version!==a.version&&(this.image=m=a.thumbnail(new Point(40,40)),this.version=a.version,this.changed())}}else m=a.fullImage(),l=new Morph,l.silentSetWidth(m.width),l.silentSetHeight(m.height),l.image=m;else a instanceof Costume?(m=a.thumbnail(new Point(40,40)),l=new Morph,l.silentSetWidth(m.width),l.silentSetHeight(m.height),
l.image=m):a instanceof Sound?l=new SymbolMorph("notes",30):a instanceof Context?(m=a.image(),l=new Morph,l.silentSetWidth(m.width),l.silentSetHeight(m.height),l.image=m):"boolean"===typeof a?l=SpriteMorph.prototype.booleanMorph.call(null,a):isString(a)?(l=500<a.length?a.slice(0,500)+"...":a,l=new TextMorph(l,this.fontSize)):null===a?l=new TextMorph("",this.fontSize):0===a?l=new TextMorph("0",this.fontSize):a.toString&&(l=new TextMorph(a.toString(),this.fontSize));e&&e.currentSprite!==c&&(c instanceof
StageMorph?f=e.corral.stageIcon:(c.isTemporary&&(c=detect(c.allExemplars(),function(a){return!a.isTemporary})),f=detect(e.corral.frame.contents.children,function(a){return a.object===c})),g=f.center());l=new SpeechBubbleMorph(l,null,Math.max(this.rounding-2,6),0);l.popUp(k,g,d);b&&this.exportPictureWithResult(l);f instanceof SpriteIconMorph?l.keepWithin(e.corral):h&&l.keepWithin(h)};
SyntaxElementMorph.prototype.exportPictureWithResult=function(a){var b=this.parentThatIsA(IDE_Morph),c=this.fullImage();a=a.fullImageClassic();var d=newCanvas(new Point(c.width+a.width+2,c.height+Math.max(0,a.height-c.height))),e=d.getContext("2d");e.drawImage(c,0,d.height-c.height);e.drawImage(a,c.width+2,0);b.saveCanvasAs(d,(b.projectName||localize("untitled"))+" "+localize("script pic"))};
SyntaxElementMorph.prototype.mappedCode=function(a){var b=this.evaluate();return b instanceof BlockMorph?b.mappedCode(a):b};SyntaxElementMorph.prototype.startLayout=function(){this.topBlock().fullChanged();Morph.prototype.trackChanges=!1};SyntaxElementMorph.prototype.endLayout=function(){Morph.prototype.trackChanges=!0;this.topBlock().fullChanged()};BlockMorph.prototype=new SyntaxElementMorph;BlockMorph.prototype.constructor=BlockMorph;BlockMorph.uber=SyntaxElementMorph.prototype;
BlockMorph.prototype.isCachingInputs=!0;BlockMorph.prototype.zebraContrast=40;BlockMorph.prototype.snapSound=null;BlockMorph.prototype.toggleSnapSound=function(){null!==this.snapSound?this.snapSound=null:(BlockMorph.prototype.snapSound=document.createElement("audio"),BlockMorph.prototype.snapSound.src="click.wav");CommentMorph.prototype.snapSound=BlockMorph.prototype.snapSound};function BlockMorph(){this.init()}
BlockMorph.prototype.init=function(a){this.selector=null;this.blockSpec="";this.category=this.instantiationSpec=this.comment=null;this.isCorpse=!1;BlockMorph.uber.init.call(this,a);this.color=new Color(0,17,173);this.cachedInputs=null};BlockMorph.prototype.scriptTarget=function(){var a=this.parentThatIsA(ScriptsMorph);if(a)return a.scriptTarget();if(a=this.parentThatIsA(IDE_Morph))return a.currentSprite;throw Error("script target cannot be found for orphaned block");};
BlockMorph.prototype.toString=function(){return"a "+(this.constructor.name||this.constructor.toString().split(" ")[1].split("(")[0])+' ("'+this.blockSpec.slice(0,30)+'...")'};BlockMorph.prototype.parseSpec=function(a){var b=[],c="";var d=isString(a)?a.split(" "):[];0===d.length&&(d=[a]);if(this.labelWordWrap)return d;d.forEach(function(a){"%"===a[0]&&1<a.length?(""!==c&&(b.push(c),c=""),b.push(a)):c=""!==c?c+(" "+a):a});""!==c&&b.push(c);return b};
BlockMorph.prototype.setSpec=function(a,b,c){var d=this,e,f=-1;a&&(this.parts().forEach(function(a){a.destroy()}),this.isPrototype&&this.add(this.placeHolder()),this.parseSpec(a).forEach(function(a){"%"===a[0]&&(f+=1);e=d.labelPart(a);isNil(e)||(d.add(e),e instanceof CommandSlotMorph||e instanceof StringMorph||e.drawNew(),e instanceof RingMorph&&e.fixBlockColor(),(e instanceof MultiArgMorph||e.constructor===CommandSlotMorph||e.constructor===RingCommandSlotMorph)&&e.fixLayout(),d.isPrototype&&d.add(d.placeHolder()),
e instanceof InputSlotMorph&&d.isCustomBlock&&e.setChoices.apply(e,(c||d.definition).inputOptionsOfIdx(f)))}),this.blockSpec=a,this.fixLayout(b),this.cachedInputs=null)};BlockMorph.prototype.userSetSpec=function(a){var b=this.topBlock();b.fullChanged();this.setSpec(a);b.fullChanged()};
BlockMorph.prototype.buildSpec=function(){var a=this;this.blockSpec="";this.parts().forEach(function(b){a.blockSpec=b instanceof StringMorph?a.blockSpec+b.text:b instanceof ArgMorph?a.blockSpec+b.getSpec():b.isBlockLabelBreak?a.blockSpec+b.getSpec():a.blockSpec+"[undefined]";a.blockSpec+=" "});this.blockSpec=this.blockSpec.trim()};
BlockMorph.prototype.rebuild=function(a){this.setSpec(this.blockSpec);a&&this.inputs().forEach(function(b){b instanceof ReporterBlockMorph&&(b.setColor(b.color.lighter(a)),b.setSpec(b.blockSpec))})};
BlockMorph.prototype.userMenu=function(){function a(a,b,d,e,f){c.addItem((d?"\u2611 ":"\u2610 ")+localize(a),b,d?e:f)}function b(){var a=e.fullCopy();a.addShadow();(new DialogBoxMorph(e,e.userSetSpec,e)).prompt("Variable name",e.blockSpec,d,a.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(e))}var c=new MenuMorph(this),d=this.world(),e=this,f=16===d.currentKey,g=this.activeProcess(),h=g&&g.context&&g.context.outerContext?g.context.outerContext.variables.names():[],k;c.addItem("help...",
"showHelp");if(f){var l=this.topBlock();l instanceof ReporterBlockMorph&&c.addItem("script pic with result...",function(){l.exportResultPic()},"open a new window\nwith a picture of both\nthis script and its result",new Color(100,0,0))}if(this.isTemplate){if(this.parent instanceof SyntaxElementMorph)"reportGetVar"===this.selector&&(c.addLine(),c.addItem("rename...",function(){e.refactorThisVar(!0)},"rename only\nthis reporter"),c.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable"));
else{if("reportGetVar"===this.selector){var m=this.scriptTarget();this.isInheritedVariable(!1)?a("inherited",function(){m.toggleInheritedVariable(e.blockSpec)},!0,"uncheck to\ndisinherit",null):(this.isInheritedVariable(!0)&&a("inherited",function(){m.toggleInheritedVariable(e.blockSpec)},!1,null,localize("check to inherit\nfrom")+" "+m.exemplar.name),a("transient","toggleTransientVariable",e.isTransientVariable(),"uncheck to save contents\nin the project","check to prevent contents\nfrom being saved"),
c.addLine(),c.addItem("rename...",function(){e.refactorThisVar(!0)},"rename only\nthis reporter"),c.addItem("rename all...","refactorThisVar","rename all blocks that\naccess this variable"))}else"evaluateCustomBlock"!==this.selector&&c.addItem("hide","hidePrimitive");StageMorph.prototype.enableInheritance&&(m=this.scriptTarget(),(k={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getCostumeIdx:"costume #"}[this.selector])&&m&&m.exemplar&&(c.addLine(),a("inherited",
function(){m.toggleInheritanceForAttribute(k)},m.inheritsAttribute(k),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+m.exemplar.name)));StageMorph.prototype.enableCodeMapping&&(c.addLine(),c.addItem("header mapping...","mapToHeader"),c.addItem("code mapping...","mapToCode"))}return c}c.addLine();if("reportGetVar"===this.selector)c.addItem("rename...",b,"rename only\nthis reporter");else if(SpriteMorph.prototype.blockAlternatives[this.selector])c.addItem("relabel...",function(){e.relabel(SpriteMorph.prototype.blockAlternatives[e.selector])});
else if(this.isCustomBlock&&this.alternatives){var n=this.alternatives();0<n.length&&c.addItem("relabel...",function(){e.relabel(n)})}c.addItem("duplicate",function(){var a=e.fullCopy(),b=e.parentThatIsA(IDE_Morph),c=e.parentThatIsA(BlockEditorMorph);a.pickUp(d);!b&&c&&(b=c.target.parentThatIsA(IDE_Morph));b&&(d.hand.grabOrigin={origin:b.palette,position:b.palette.center()})},"make a copy\nand pick it up");this instanceof CommandBlockMorph&&this.nextBlock()&&c.addItem((g?this.fullCopy():this).thumbnail(.5,
60),function(){var a=e.fullCopy(),b=a.nextBlock(),c=e.parentThatIsA(IDE_Morph),f=e.parentThatIsA(BlockEditorMorph);b&&b.destroy();a.pickUp(d);!c&&f&&(c=f.target.parentThatIsA(IDE_Morph));c&&(d.hand.grabOrigin={origin:c.palette,position:c.palette.center()})},"only duplicate this block");c.addItem("delete","userDestroy");c.addItem("script pic...",function(){var a=e.parentThatIsA(IDE_Morph)||e.parentThatIsA(BlockEditorMorph).target.parentThatIsA(IDE_Morph);a.saveCanvasAs(e.topBlock().scriptPic(),(a.projectName||
localize("untitled"))+" "+localize("script pic"))},"open a new window\nwith a picture of this script");f&&c.addItem("download script",function(){var a=e.parentThatIsA(IDE_Morph),b=e.parentThatIsA(BlockEditorMorph);!a&&b&&(a=b.target.parentThatIsA(IDE_Morph));a&&a.saveXMLAs(a.serializer.serialize(e),e.selector+" script",!1)},"download this script\nas an XML file",new Color(100,0,0));if(g)return h.length&&(c.addLine(),h.forEach(function(a){c.addItem(a+"...",function(){g.doShowVar(a)})})),g.homeContext.variables.names().forEach(function(a){contains(h,
a)||c.addItem(a+"...",function(){g.doShowVar(a)})}),c;if(this.parent.parentThatIsA(RingMorph))return c.addLine(),c.addItem("unringify","unringify"),l=this.topBlock(),!(this instanceof ReporterBlockMorph)&&l instanceof HatBlockMorph||c.addItem("ringify","ringify"),c;if(this.parent instanceof ReporterSlotMorph||this.parent instanceof CommandSlotMorph||this instanceof HatBlockMorph||this instanceof CommandBlockMorph&&this.topBlock()instanceof HatBlockMorph)return c;c.addLine();c.addItem("ringify","ringify");
StageMorph.prototype.enableCodeMapping&&(c.addLine(),c.addItem("header mapping...","mapToHeader"),c.addItem("code mapping...","mapToCode"));return c};BlockMorph.prototype.developersMenu=function(){var a=BlockMorph.uber.developersMenu.call(this);a.addLine();a.addItem("delete block","deleteBlock");a.addItem("spec...",function(){(new DialogBoxMorph(this,this.userSetSpec,this)).prompt(a.title+"\nspec",this.blockSpec,this.world())});return a};
BlockMorph.prototype.hidePrimitive=function(){var a=this.parentThatIsA(IDE_Morph);if(a){StageMorph.prototype.hiddenPrimitives[this.selector]=!0;var b={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category;"lists"===b&&(b="variables");a.flushBlocksCache(b);a.refreshPalette()}};
BlockMorph.prototype.isInheritedVariable=function(a){return this.isTemplate&&"reportGetVar"===this.selector&&this.parent instanceof FrameMorph?contains(this.scriptTarget().inheritedVariableNames(a),this.blockSpec):!1};BlockMorph.prototype.isTransientVariable=function(){var a=this.scriptTarget().variables.silentFind(this.blockSpec);return a?a.vars[this.blockSpec].isTransient:!1};
BlockMorph.prototype.toggleTransientVariable=function(){var a=this.scriptTarget().variables.silentFind(this.blockSpec);a&&(a.vars[this.blockSpec].isTransient=!a.vars[this.blockSpec].isTransient)};
BlockMorph.prototype.deleteBlock=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.nextBlock?this.nextBlock():null,c,d;a&&(b&&a.add(b),this.inputs().forEach(function(b){b instanceof BlockMorph&&a.add(b)}));this instanceof ReporterBlockMorph&&(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)?this.parent.revertToDefaultInput(this):this.parent&&this.parent.fixLayout?c=this.parentThatIsA(ArgMorph):d=!0;this.destroy();d&&(this.isCorpse=
!0);c&&c.fixLayout()};
BlockMorph.prototype.ringify=function(){var a=this.selectForEdit();if(a!==this)return this.ringify.call(a);a=new RingMorph;var b=this.topBlock();var c=b.fullBounds().center();if(null===this.parent)return null;b.fullChanged();if(this.parent instanceof SyntaxElementMorph)if(this instanceof ReporterBlockMorph)this.parent.silentReplaceInput(this,a),a.embed(this);else{if(b){if(b instanceof HatBlockMorph)return;b.parent.add(a);a.embed(b);a.setCenter(c)}}else this.parent.add(a),a.embed(this),a.setCenter(c);
this.fixBlockColor(null,!0);b.fullChanged()};
BlockMorph.prototype.unringify=function(){var a=this.selectForEdit();if(a!==this)return this.unringify.call(a);a=this.parent.parentThatIsA(RingMorph);var b=this.topBlock();var c=this.parentThatIsA(ScriptsMorph);if(null===a)return null;var d=a.contents();var e=a.center();b.fullChanged();a.parent instanceof SyntaxElementMorph?d instanceof ReporterBlockMorph?a.parent.silentReplaceInput(a,d):c&&(c.add(d),d.setFullCenter(e),d.moveBy(20),a.parent.revertToDefaultInput(a)):(a.parent.add(d),d.setFullCenter(e),
a.destroy());this.fixBlockColor(null,!0);b.fullChanged()};
BlockMorph.prototype.relabel=function(a){var b=this.selectForEdit();if(b!==this)return this.relabel.call(b,a);var c=new MenuMorph(this);var d=this.inputs();var e=this;a.forEach(function(a){var b=SpriteMorph.prototype.blockForSelector(a);b.restoreInputs(d);b.fixBlockColor(null,!0);b.addShadow(new Point(3,3));c.addItem(b,function(){e.setSelector(a)})});c.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))};
BlockMorph.prototype.setSelector=function(a){var b=this.inputs(),c=this.parentThatIsA(ScriptsMorph);var d=SpriteMorph.prototype.blocks[a];this.setCategory(d.category);this.selector=a;this.setSpec(localize(d.spec));a=this.restoreInputs(b);this.fixLabelColor();c&&a.length&&a.forEach(function(a){a.moveBy(10);c.add(a)})};
BlockMorph.prototype.restoreInputs=function(a){var b=0,c,d=[],e=this;this.inputs().forEach(function(d){f=a[b];f instanceof ReporterBlockMorph?e.silentReplaceInput(d,f.fullCopy()):f&&d instanceof InputSlotMorph?f.contents&&d.setContents(f.contents().text):f instanceof CSlotMorph&&d instanceof CSlotMorph&&(c=f.nestedBlock())&&d.nestedBlock(c.fullCopy());b+=1});for(b;b<a.length;b+=1){var f=a[b];f instanceof ReporterBlockMorph?d.push(f):f instanceof CommandSlotMorph&&(c=f.nestedBlock())&&d.push(c)}this.cachedInputs=
null;return d};
BlockMorph.prototype.showHelp=function(){var a=this,b=this.parentThatIsA(IDE_Morph),c,d=new Image,e=this.isCustomBlock?this.definition.helpSpec():this.selector,f;b||(c=this.parentThatIsA(BlockEditorMorph))&&(b=c.target.parentThatIsA(IDE_Morph));d.onload=function(){g=newCanvas(new Point(d.width,d.height),!0);f=g.getContext("2d");f.drawImage(d,0,0);(new DialogBoxMorph).inform("Help",null,a.world(),g)};if(this.isCustomBlock&&this.definition.comment){c=this.fullCopy();c.addShadow();b=this.definition.comment.fullCopy();b.contents.parse();
var g="";b.contents.lines.forEach(function(a){g=g+"\n"+a});(new DialogBoxMorph).inform("Help",g.substr(1),a.world(),c.fullImage())}else d.src=b.resourceURL("help",e+".png")};
BlockMorph.prototype.mapToHeader=function(){var a="reify"===this.selector.substr(0,5)?"reify":this.selector,b=this.codeDefinitionHeader(),c=this;b.addShadow(new Point(3,3));var d=b.fullImageClassic();b=this.isCustomBlock?"Enter code that corresponds to the block's definition. Use the formal parameter\nnames as shown and <body> to reference the definition body's generated text code.":"Enter code that corresponds to the block's definition. Choose your own\nformal parameter names (ignoring the ones shown).";
(new DialogBoxMorph(this,function(b){"evaluateCustomBlock"===a?c.definition.codeHeader=b:StageMorph.prototype.codeHeaders[a]=b},this)).promptCode("Header mapping","evaluateCustomBlock"===a?this.definition.codeHeader||"":StageMorph.prototype.codeHeaders[a]||"",this.world(),d,b)};
BlockMorph.prototype.mapToCode=function(){var a="reify"===this.selector.substr(0,5)?"reify":this.selector,b=this.codeMappingHeader(),c=this;b.addShadow(new Point(3,3));b=b.fullImageClassic();(new DialogBoxMorph(this,function(b){"evaluateCustomBlock"===a?c.definition.codeMapping=b:StageMorph.prototype.codeMappings[a]=b},this)).promptCode("Code mapping","evaluateCustomBlock"===a?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[a]||"",this.world(),b,"Enter code that corresponds to the block's operation (usually a single\nfunction invocation). Use <#n> to reference actual arguments as shown.")};
BlockMorph.prototype.mapHeader=function(a,b){b=b||"reify"===this.selector.substr(0,5)?"reify":this.selector;a&&(this.isCustomBlock?this.definition.codeHeader=a:StageMorph.prototype.codeHeaders[b]=a)};BlockMorph.prototype.mapCode=function(a,b){b=b||"reify"===this.selector.substr(0,5)?"reify":this.selector;a&&(this.isCustomBlock?this.definition.codeMapping=a:StageMorph.prototype.codeMappings[b]=a)};
BlockMorph.prototype.mappedCode=function(a){var b="reify"===this.selector.substr(0,5)?"reify":this.selector,c=1,d=this.isCustomBlock?this.definition.spec:b,e=a||{},f=[];var g="reportGetVar"===b?this.blockSpec:this.isCustomBlock?this.definition.codeMapping||"":StageMorph.prototype.codeMappings[b]||"";if("reportGetVar"!==b&&!e.hasOwnProperty(d))if(e[d]=null,this.isCustomBlock){b=this.definition.codeHeader||"";if(-1!==b.indexOf("<body")){var h="";this.definition.body&&(h=this.definition.body.expression.mappedCode(e));
var k=h.split("\n");var l=b.split("\n");l.forEach(function(a,b){var c="";0===a.trimLeft().indexOf("<body")&&(c=a.indexOf("<body"),c=a.slice(0,c));l[b]=a.replace(/<body>/,k.join("\n"+c));l[b]=l[b].replace(/<body>/g,k.join("\n"))});b=l.join("\n")}e[d]=b}else e[d]=StageMorph.prototype.codeHeaders[d];var m=g.split("\n");this.inputs().forEach(function(a){f.push(a.mappedCode(e).toString())});f.forEach(function(a){var b=a.split("\n"),d="<#"+c+">",e=new RegExp(d,"g");m.forEach(function(a,c){var f="";0===
a.trimLeft().indexOf(d)&&(f=a.indexOf(d),f=a.slice(0,f));m[c]=a.replace(new RegExp(d),b.join("\n"+f));m[c]=m[c].replace(e,b.join("\n"))});c+=1});g=m.join("\n");this.nextBlock&&this.nextBlock()&&(g+="\n"+this.nextBlock().mappedCode(e));if(!a){var n=[];Object.keys(e).forEach(function(a){e[a]&&n.push(e[a])});if(n.length)return n.join("\n\n")+"\n\n"+g}return g};
BlockMorph.prototype.codeDefinitionHeader=function(){var a=this.isCustomBlock?new PrototypeHatBlockMorph(this.definition):SpriteMorph.prototype.blockForSelector(this.selector),b=new HatBlockMorph,c=1;if(this.isCustomBlock)return a;a.inputs().forEach(function(b){var d=new TemplateSlotMorph("#"+c);a.silentReplaceInput(b,d);c+=1});a.isPrototype=!0;b.setCategory("control");b.setSpec("%s");b.silentReplaceInput(b.inputs()[0],a);"control"===this.category&&b.alternateBlockColor();return b};
BlockMorph.prototype.codeMappingHeader=function(){var a=this.isCustomBlock?this.definition.blockInstance():SpriteMorph.prototype.blockForSelector(this.selector),b=new HatBlockMorph,c=1;a.inputs().forEach(function(b){var d=new TemplateSlotMorph("<#"+c+">");a.silentReplaceInput(b,d);c+=1});a.isPrototype=!0;b.setCategory("control");b.setSpec("%s");b.silentReplaceInput(b.inputs()[0],a);"control"===this.category&&b.alternateBlockColor();return b};
BlockMorph.prototype.refactorThisVar=function(a){var b=this.scriptTarget(),c=this.instantiationSpec||this.blockSpec,d=this.fullCopy();d.addShadow();(new DialogBoxMorph(this,function(d){this.parent instanceof SyntaxElementMorph?this.parentThatIsA(BlockEditorMorph)?this.doRefactorBlockParameter(c,d,a):this.parentThatIsA(RingMorph)?this.doRefactorRingParameter(c,d,a):this.doRefactorScriptVar(c,d,a):b.hasSpriteVariable(c)?this.doRefactorSpriteVar(c,d,a):this.doRefactorGlobalVar(c,d,a)},this)).prompt("Variable name",
c,this.world(),d.fullImage(),InputSlotMorph.prototype.getVarNamesDict.call(this))};BlockMorph.prototype.varExistsError=function(a,b){a.inform("Variable exists","A variable with this name already exists "+(b||"in this context")+".")};
BlockMorph.prototype.doRefactorBlockParameter=function(a,b,c){var d=this.parentThatIsA(BlockInputFragmentMorph),e=d.fragment.copy(),f=d.parent,g=this.parentThatIsA(BlockEditorMorph),h=g.body.contents;f.anyChild(function(a){return a.blockSpec===b})?this.varExistsError(g.target.parentThatIsA(IDE_Morph)):(e.labelString=b,d.updateBlockLabel(e),c||h.children.forEach(function(c){c.refactorVarInStack(a,b)}))};
BlockMorph.prototype.doRefactorRingParameter=function(a,b,c){var d=this.parentThatIsA(RingMorph),e=d.contents(),f=this.topBlock();contains(d.inputNames(),b)?this.varExistsError(this.parentThatIsA(IDE_Morph)):(f.fullChanged(),this.setSpec(b),c||e&&e.refactorVarInStack(a,b),f.fullChanged())};
BlockMorph.prototype.doRefactorScriptVar=function(a,b,c){var d=this.parentThatIsA(CommandBlockMorph);d.definesScriptVariable(b)?(a=this.scriptTarget(),a=a.parentThatIsA(IDE_Morph),this.varExistsError(a)):(this.userSetSpec(b),c||d.refactorVarInStack(a,b,!0))};
BlockMorph.prototype.doRefactorSpriteVar=function(a,b,c){var d=this.scriptTarget(),e=d.parentThatIsA(IDE_Morph),f=d.findVariableWatcher(a);if(d.hasSpriteVariable(b))this.varExistsError(e);else if(isNil(e.globalVariables.vars[b])){var g=d.variables.getVar(a);d.deleteVariable(a);d.addVariable(b,!1);d.variables.setVar(b,g);f&&f.isVisible&&(g=d.toggleVariableWatcher(b,!1),g.setPosition(f.position()));c||(d.refactorVariableInstances(a,b,!1),d.customBlocks.forEach(function(c){c.body.expression.refactorVarInStack(a,
b)}));e.flushBlocksCache("variables");e.refreshPalette()}else this.varExistsError(e,"as a global variable")};
BlockMorph.prototype.doRefactorGlobalVar=function(a,b,c){var d=this.scriptTarget(),e=d.parentThatIsA(IDE_Morph),f=e?e.stage:null,g=d.findVariableWatcher(a);if(isNil(e.globalVariables.vars[b]))if(detect(f.children,function(a){return a instanceof SpriteMorph&&a.hasSpriteVariable(b)}))this.varExistsError(e,"as a sprite local variable");else{var h=e.globalVariables.getVar(a);f.deleteVariable(a);f.addVariable(b,!0);e.globalVariables.setVar(b,h);g&&g.isVisible&&(d=d.toggleVariableWatcher(b,!0),d.setPosition(g.position()));
c||(f.refactorVariableInstances(a,b,!0),f.globalBlocks.forEach(function(c){c.body.expression.refactorVarInStack(a,b)}),f.forAllChildren(function(c){c instanceof SpriteMorph&&(c.refactorVariableInstances(a,b,!0),c.customBlocks.forEach(function(c){c.body.expression.refactorVarInStack(a,b)}))}));e.flushBlocksCache("variables");e.refreshPalette()}else this.varExistsError(e)};
BlockMorph.prototype.eraseHoles=function(a){var b=this,c=this instanceof RingMorph,d=.5*this.edge,e=this.parts().filter(function(a){return a.isHole});if(this.isPredicate&&0<e.length){var f=this.width()-this.rounding;a.clearRect(f,0,this.width(),this.height());var g=a.createLinearGradient(f-this.edge,0,this.width(),0);g.addColorStop(0,this.color.toString());g.addColorStop(1,this.dark());a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=g;a.beginPath();a.moveTo(f-d,this.edge+
d);a.lineTo(f-d,this.height()-this.edge-d);a.stroke()}e.forEach(function(d){var e=d.width(),f=Math.floor(d.height())-2;a.clearRect(d.bounds.origin.x-b.bounds.origin.x+1,d.bounds.origin.y-b.bounds.origin.y+1,c?e-2:e+1,f)})};BlockMorph.prototype.addHighlight=function(a){var b=!this.isVisible;b&&this.show();a=this.highlight(a?a.color:this.activeHighlight,this.activeBlur,this.activeBorder);this.addBack(a);this.fullChanged();b&&this.hide();return a};
BlockMorph.prototype.addErrorHighlight=function(){var a=!this.isVisible;a&&this.show();this.removeHighlight();var b=this.highlight(this.errorHighlight,this.activeBlur,this.activeBorder);this.addBack(b);this.fullChanged();a&&this.hide();return b};BlockMorph.prototype.removeHighlight=function(){var a=this.getHighlight();null!==a&&(this.fullChanged(),this.removeChild(a));return a};BlockMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()};
BlockMorph.prototype.highlight=function(a,b,c){var d=new BlockHighlightMorph,e=this.fullBounds(),f=useBlurredShadows&&!MorphicPreferences.isFlat?b:c;d.setExtent(e.extent().add(2*f));d.color=a;d.image=useBlurredShadows&&!MorphicPreferences.isFlat?this.highlightImageBlurred(a,b):this.highlightImage(a,c);d.setPosition(e.origin.subtract(new Point(f,f)));return d};
BlockMorph.prototype.highlightImage=function(a,b){var c=this.fullBounds().extent();var d=this.fullImage();var e=newCanvas(c.add(2*b));var f=e.getContext("2d");f.drawImage(d,0,0);f.drawImage(d,b,0);f.drawImage(d,2*b,0);f.drawImage(d,2*b,b);f.drawImage(d,2*b,2*b);f.drawImage(d,b,2*b);f.drawImage(d,0,2*b);f.drawImage(d,0,b);f.globalCompositeOperation="destination-out";f.drawImage(d,b,b);b=newCanvas(c.add(2*b));f=b.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=
a.toString();f.fillRect(0,0,b.width,b.height);return b};BlockMorph.prototype.highlightImageBlurred=function(a,b){var c=this.fullBounds().extent();var d=this.fullImage();c=newCanvas(c.add(2*b));var e=c.getContext("2d");e.shadowBlur=b;e.shadowColor=a.toString();e.drawImage(d,b,b);e.shadowBlur=0;e.globalCompositeOperation="destination-out";e.drawImage(d,b,b);return c};
BlockMorph.prototype.getHighlight=function(){var a=this.children.slice(0).reverse().filter(function(a){return a instanceof BlockHighlightMorph});return 0!==a.length?a[0]:null};BlockMorph.prototype.outline=function(a,b){var c=new BlockHighlightMorph,d=this.fullBounds();c.setExtent(d.extent().add(2*b));c.color=a;c.image=this.highlightImage(a,b);c.setPosition(d.origin.subtract(new Point(b,b)));return c};
BlockMorph.prototype.fixBlockColor=function(a,b){var c;if(this.zebraContrast||b){if(!this.zebraContrast&&b)return this.forceNormalColoring(!0);!a&&this.parent&&(this.isPrototype?a=null:this instanceof ReporterBlockMorph?a=this.parent.parentThatIsA(BlockMorph):(c=this.parentThatIsA(CommandSlotMorph))&&(a=c.parentThatIsA(BlockMorph)));a?a.category===this.category?a.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor():
(a=SpriteMorph.prototype.blockColor[this.category],this.color.eq(a)||this.alternateBlockColor());b&&this.fixChildrensBlockColor(!0)}};BlockMorph.prototype.forceNormalColoring=function(a){var b=SpriteMorph.prototype.blockColor[this.category];this.setColor(b,a);this.setLabelColor(new Color(255,255,255),b.darker(this.labelContrast),new Point(-1,-1));this.fixChildrensBlockColor(!0)};
BlockMorph.prototype.alternateBlockColor=function(){var a=SpriteMorph.prototype.blockColor[this.category];this.color.eq(a)?this.setColor(0>this.zebraContrast?a.darker(Math.abs(this.zebraContrast)):a.lighter(this.zebraContrast),this.hasLabels()):this.setColor(a,this.hasLabels());this.fixLabelColor();this.fixChildrensBlockColor(!0)};BlockMorph.prototype.ghost=function(){this.setColor(SpriteMorph.prototype.blockColor[this.category].lighter(35))};
BlockMorph.prototype.fixLabelColor=function(){if(0<this.zebraContrast&&this.category){var a=SpriteMorph.prototype.blockColor[this.category];this.color.eq(a)?this.setLabelColor(new Color(255,255,255),a.darker(this.labelContrast),MorphicPreferences.isFlat?null:new Point(-1,-1)):this.setLabelColor(new Color(0,0,0),a.lighter(this.zebraContrast).lighter(2*this.labelContrast),MorphicPreferences.isFlat?null:new Point(1,1))}};
BlockMorph.prototype.fixChildrensBlockColor=function(a){var b=this;this.children.forEach(function(c){c instanceof CommandBlockMorph?c.fixBlockColor(null,a):c instanceof SyntaxElementMorph&&(c.fixBlockColor(b,a),c instanceof BooleanSlotMorph&&c.drawNew())})};BlockMorph.prototype.setCategory=function(a){this.category=a;this.startLayout();this.fixBlockColor();this.endLayout()};BlockMorph.prototype.hasLabels=function(){return this.children.some(function(a){return a instanceof StringMorph})};
BlockMorph.prototype.fullCopy=function(){var a=BlockMorph.uber.fullCopy.call(this);a.removeHighlight();a.isDraggable=!0;this.instantiationSpec&&a.setSpec(this.instantiationSpec);a.allChildren().filter(function(a){a instanceof SyntaxElementMorph&&(a.cachedInputs=null,a.isCustomBlock&&a.initializeVariables());return!isNil(a.comment)}).forEach(function(a){var b=a.comment.fullCopy();a.comment=b;b.block=a});a.cachedInputs=null;return a};BlockMorph.prototype.reactToTemplateCopy=function(){this.forceNormalColoring()};
BlockMorph.prototype.hasBlockVars=function(){return this.anyChild(function(a){return a.isCustomBlock&&a.isGlobal&&a.definition.variableNames.length})};BlockMorph.prototype.mouseClickLeft=function(){var a=this.topBlock(),b=a.scriptTarget(),c;if(16===this.world().currentKey&&!this.isTemplate)return this.selectForEdit().focus();if(a instanceof PrototypeHatBlockMorph)return a.mouseClickLeft();b&&(c=b.parentThatIsA(StageMorph))&&c.threads.toggleProcess(a,b)};
BlockMorph.prototype.focus=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.world();if(a&&ScriptsMorph.prototype.enableKeyboard){a.focus&&a.focus.stopEditing();b.stopEditing();var c=new ScriptFocusMorph(a,this);a.focus=c;c.getFocus(b);this instanceof HatBlockMorph&&c.nextCommand()}};BlockMorph.prototype.activeProcess=function(){var a=this.topBlock(),b=a.scriptTarget(),c;return a instanceof PrototypeHatBlockMorph?null:b&&(c=b.parentThatIsA(StageMorph))?c.threads.findProcess(a,b):null};
BlockMorph.prototype.thumbnail=function(a,b){var c=this.nextBlock();c&&(c.isVisible=!1);var d=this.fullBounds().extent();var e=newCanvas(new Point(b?Math.min(d.x*a,b):d.x*a,d.y*a));var f=e.getContext("2d");f.scale(a,a);f.drawImage(this.fullImage(),0,0);b&&d.x*a>b&&(b=f.createLinearGradient(e.width/a-12,0,e.width/a,0),b.addColorStop(0,"transparent"),b.addColorStop(1,"black"),f.globalCompositeOperation="destination-out",f.fillStyle=b,f.fillRect(e.width/a-12,0,e.width/a,e.height/a));c&&(c.isVisible=
!0);return e};BlockMorph.prototype.scriptPic=function(){var a=this.fullImage(),b=this.stackFullBounds(),c=newCanvas(b.extent()),d=c.getContext("2d");this.allComments().forEach(function(a){d.drawImage(a.fullImageClassic(),a.fullBounds().left()-b.left(),a.top()-b.top())});d.drawImage(a,0,0);return c};
BlockMorph.prototype.drawMethodIcon=function(a){var b=this.methodIconExtent(),c=b.y;b=b.x/2;var d=this.edge+this.labelPadding,e=this.edge,f=this.color===SpriteMorph.prototype.blockColor[this.category];this.isPredicate&&(d=this.rounding);this instanceof CommandBlockMorph&&(e+=this.corner);a.fillStyle=f?this.cachedClrBright:this.cachedClrDark;a.beginPath();a.arc(d+b,e+b,b,radians(-210),radians(30),!1);a.lineTo(d+b,e+c);a.closePath();a.fill();a.fillStyle=this.cachedClr;a.beginPath();a.arc(d+b,e+b,.4*
b,radians(0),radians(360),!1);a.closePath();a.fill()};BlockMorph.prototype.rootForGrab=function(){return this};BlockMorph.prototype.wantsDropOf=function(a){return(a instanceof ArgMorph||a instanceof StringMorph||a instanceof TextMorph)&&!this.isTemplate};BlockMorph.prototype.reactToDropOf=function(a){a.isDraggable=!1;a instanceof InputSlotMorph?a.drawNew():a instanceof MultiArgMorph&&a.fixLayout();this.fixLayout();this.buildSpec()};
BlockMorph.prototype.situation=function(){if(!(this.parent instanceof TemplateSlotMorph)){var a=this.parentThatIsA(ScriptsMorph);if(a)return{origin:a,position:this.position().subtract(a.position())}}return BlockMorph.uber.situation.call(this)};BlockMorph.prototype.prepareToBeGrabbed=function(a){var b=this;this.allComments().forEach(function(c){c.startFollowing(b,a.world)})};BlockMorph.prototype.justDropped=function(){this.alpha=1;this.allComments().forEach(function(a){a.stopFollowing()})};
BlockMorph.prototype.allComments=function(){return this.allChildren().filter(function(a){return!isNil(a.comment)}).map(function(a){return a.comment})};BlockMorph.prototype.destroy=function(a){a?isNil(this.comment)||this.comment.destroy():this.allComments().forEach(function(a){a.destroy()});BlockMorph.uber.destroy.call(this)};
BlockMorph.prototype.stackHeight=function(){var a=this.fullBounds(),b=Math.max(this.allComments().map(function(a){return a.bottom()}))||this.bottom();return Math.max(a.bottom(),b)-a.top()};BlockMorph.prototype.stackFullBounds=function(){var a=this.fullBounds();this.allComments().forEach(function(b){a.mergeWith(b.bounds)});return a};
BlockMorph.prototype.stackWidth=function(){var a=this.fullBounds(),b=Math.max(this.allComments().map(function(a){return a.right()}))||this.right();return Math.max(a.right(),b)-a.left()};
BlockMorph.prototype.snap=function(){var a=this.topBlock(),b;a.allComments().forEach(function(b){b.align(a)});this.getHighlight()&&this!==a&&this.removeHighlight();a.getHighlight()&&a.addHighlight(a.removeHighlight());"receiveCondition"===this.selector&&(b=a.scriptTarget())&&(b=b.parentThatIsA(StageMorph))&&(b.enableCustomHatBlocks=!0,b.threads.pauseCustomHatBlocks=!1,(b=b.parentThatIsA(IDE_Morph))&&b.controlBar.stopButton.refresh())};CommandBlockMorph.prototype=new BlockMorph;
CommandBlockMorph.prototype.constructor=CommandBlockMorph;CommandBlockMorph.uber=BlockMorph.prototype;function CommandBlockMorph(){this.init()}CommandBlockMorph.prototype.init=function(a){CommandBlockMorph.uber.init.call(this,a);this.setExtent(new Point(200,100),a);this.partOfCustomCommand=!1;this.exitTag=null};CommandBlockMorph.prototype.blockSequence=function(){var a=this.nextBlock(),b=[this];a&&(b=b.concat(a.blockSequence()));return b};
CommandBlockMorph.prototype.bottomBlock=function(){return this.nextBlock()?this.nextBlock().bottomBlock():this};CommandBlockMorph.prototype.nextBlock=function(a){if(a){var b=this.nextBlock(),c=this.parentThatIsA(CommandSlotMorph);this.add(a);b&&a.bottomBlock().nextBlock(b);a.setPosition(new Point(this.left(),this.bottom()-this.corner));c&&c.fixLayout()}else return detect(this.children,function(a){return a instanceof CommandBlockMorph&&!a.isPrototype})};
CommandBlockMorph.prototype.topAttachPoint=function(){return new Point(this.dentCenter(),this.top())};CommandBlockMorph.prototype.bottomAttachPoint=function(){return new Point(this.dentCenter(),this.bottom())};CommandBlockMorph.prototype.wrapAttachPoint=function(){var a=detect(this.inputs(),function(a){return a instanceof CSlotMorph});return a&&!a.nestedBlock()?new Point(a.left()+2*a.inset+a.corner,a.top()+2*a.corner):null};
CommandBlockMorph.prototype.dentLeft=function(){return this.left()+this.corner+this.inset};CommandBlockMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent};
CommandBlockMorph.prototype.attachTargets=function(){var a=[];if(!(this instanceof HatBlockMorph)){var b=this.topAttachPoint();this.parent instanceof SyntaxElementMorph||a.push({point:b,element:this,loc:"top",type:"block"});!ScriptsMorph.prototype.enableNestedAutoWrapping&&this.parentThatIsA(CommandSlotMorph)||a.push({point:b,element:this,loc:"wrap",type:"block"})}this.isStop()||a.push({point:this.bottomAttachPoint(),element:this,loc:"bottom",type:"block"});return a};
CommandBlockMorph.prototype.allAttachTargets=function(a){var b=this,c=[];if(this instanceof HatBlockMorph&&a.rejectsHats)return c;(a||this.parent).children.filter(function(a){return a!==b&&a instanceof SyntaxElementMorph&&!a.isTemplate}).forEach(function(a){a.forAllChildren(function(a){a.attachTargets&&a.attachTargets().forEach(function(a){c.push(a)})})});return c};
CommandBlockMorph.prototype.closestAttachTarget=function(a){a=a||this.parent;var b=this.bottomBlock(),c=null,d=Math.max(2*this.corner+this.dent,this.minSnapDistance),e,f=[],g=1E3,h;this instanceof HatBlockMorph||(f.push({point:this.topAttachPoint(),loc:"top"}),(h=this.wrapAttachPoint())&&f.push({point:h,loc:"wrap"}));b.isStop()||f.push({point:b.bottomAttachPoint(),loc:"bottom"});this.allAttachTargets(a).forEach(function(a){f.forEach(function(b){if("wrap"===b.loc&&"wrap"===a.loc||b.loc!==a.loc&&"wrap"!==
b.loc&&"wrap"!==a.loc)e=b.point.distanceTo(a.point),e<d&&e<g&&(g=e,c=a)})});return c};
CommandBlockMorph.prototype.snap=function(a){var b=this.closestAttachTarget(),c=this.parentThatIsA(ScriptsMorph);c.clearDropInfo();c.lastDroppedBlock=this;if(null===b)this.startLayout(),this.fixBlockColor(),this.endLayout(),CommandBlockMorph.uber.snap.call(this),a&&c.recordDrop(a.grabOrigin);else{c.lastDropTarget=b;this.startLayout();if("bottom"===b.loc){if("slot"===b.type?(this.removeHighlight(),c.lastNextBlock=b.element.nestedBlock(),b.element.nestedBlock(this)):(c.lastNextBlock=b.element.nextBlock(),
b.element.nextBlock(this)),this.isStop()&&(b=this.nextBlock()))c.add(b),b.moveBy(this.extent().floorDivideBy(2)),(b=this.parentThatIsA(CommandSlotMorph))&&b.fixLayout()}else if("top"===b.loc){b.element.removeHighlight();var d=this.bottomBlock().bottom()-this.bottom();this.setBottom(b.element.top()+this.corner-d);this.setLeft(b.element.left());this.bottomBlock().nextBlock(b.element)}else if("wrap"===b.loc){var e=detect(this.inputs(),function(a){return a instanceof CSlotMorph});d=b.element.parent;c.lastWrapParent=
d;this.moveBy(b.point.subtract(e.slotAttachPoint()));e.nestedBlock(b.element);d instanceof CommandBlockMorph?d.nextBlock(this):d instanceof CommandSlotMorph&&d.nestedBlock(this);b.element.blockSequence().forEach(function(a){a.fixBlockColor()})}this.fixBlockColor();this.endLayout();CommandBlockMorph.uber.snap.call(this);a&&c.recordDrop(a.grabOrigin);this.snapSound&&this.snapSound.play()}};CommandBlockMorph.prototype.isStop=function(){return-1<"doStopThis doStop doStopBlock doStopAll doForever doReport removeClone".split(" ").indexOf(this.selector)};
CommandBlockMorph.prototype.userDestroy=function(){var a=this.selectForEdit();if(a!==this)return this.userDestroy.call(a);if(this.nextBlock())this.userDestroyJustThis();else{a=this.parentThatIsA(ScriptsMorph);var b=this.parentThatIsA(IDE_Morph),c=this.parentThatIsA(SyntaxElementMorph),d=this.parentThatIsA(CSlotMorph);a&&(a.clearDropInfo(),a.lastDroppedBlock=this,a.recordDrop(this.situation()),a.dropRecord.action="delete");b?b.removeBlock(this):this.destroy();d&&d.fixLayout();c&&c.reactToGrabOf(this)}};
CommandBlockMorph.prototype.userDestroyJustThis=function(){var a=this.parentThatIsA(ScriptsMorph),b=this.parentThatIsA(IDE_Morph),c=this.parentThatIsA(CommandSlotMorph),d,e=this.nextBlock(),f,g=this.parentThatIsA(SyntaxElementMorph),h=this.parentThatIsA(CSlotMorph);a&&(a.clearDropInfo(),a.lastDroppedBlock=this,a.recordDrop(this.situation()),a.dropRecord.lastNextBlock=e,a.dropRecord.action="delete");this.topBlock().fullChanged();this.parent&&(d=this.parent.parentThatIsA(CommandBlockMorph));d&&d.nextBlock()===
this?f=d:c&&c.nestedBlock()===this&&(f=c);b?b.removeBlock(this,!0):this.destroy(!0);e?f instanceof CommandSlotMorph?f.nestedBlock(e):f instanceof CommandBlockMorph?f.nextBlock(e):a.add(e):h&&h.fixLayout();g&&g.reactToGrabOf(this)};
CommandBlockMorph.prototype.drawNew=function(){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawTop(a);this.drawBody(a);this.drawBottom(a);MorphicPreferences.isFlat?nop():(this.drawTopDentEdge(a,0,0),this.drawBottomDentEdge(a,0,this.height()-this.corner),this.drawLeftEdge(a),this.drawRightEdge(a),this.drawTopLeftEdge(a),this.drawBottomRightEdge(a));
this.isCustomBlock&&!this.isGlobal&&this.drawMethodIcon(a);this.eraseHoles(a)};CommandBlockMorph.prototype.drawBody=function(a){a.fillRect(0,Math.floor(this.corner),this.width(),this.height()-Math.floor(3*this.corner)+1)};CommandBlockMorph.prototype.drawTop=function(a){a.beginPath();a.arc(this.corner,this.corner,this.corner,radians(-180),radians(-90),!1);this.drawDent(a,0,0);a.arc(this.width()-this.corner,this.corner,this.corner,radians(-90),radians(-0),!1);a.closePath();a.fill()};
CommandBlockMorph.prototype.drawBottom=function(a){var b=this.height()-2*this.corner;a.beginPath();a.arc(this.corner,b,this.corner,radians(180),radians(90),!0);this.isStop()||this.drawDent(a,0,this.height()-this.corner);a.arc(this.width()-this.corner,b,this.corner,radians(90),radians(0),!0);a.closePath();a.fill()};
CommandBlockMorph.prototype.drawDent=function(a,b,c){var d=b+2*this.corner+this.inset;a.lineTo(b+this.corner+this.inset,c);a.lineTo(d,c+this.corner);a.lineTo(d+this.dent,c+this.corner);a.lineTo(b+3*this.corner+this.inset+this.dent,c);a.lineTo(this.width()-this.corner,c)};
CommandBlockMorph.prototype.drawTopDentEdge=function(a,b,c){var d=.5*this.edge,e=b+2*this.corner+this.inset;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var f=a.createLinearGradient(0,c,0,c+this.edge);f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(this.corner,c+d);a.lineTo(b+this.corner+this.inset,c+d);a.stroke();a.strokeStyle=f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent+d,c+d);a.lineTo(this.width()-this.corner,
c+d);a.stroke();f=b+this.corner+this.inset;f=a.createLinearGradient(f-this.edge,c+this.edge,f,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(b+this.corner+this.inset,c+d);a.lineTo(e,c+this.corner+d);a.stroke();b=a.createLinearGradient(0,c+this.corner,0,c+this.corner+this.edge);b.addColorStop(0,this.cachedClrBright);b.addColorStop(1,this.cachedClr);a.strokeStyle=b;a.beginPath();a.moveTo(e,c+this.corner+d);a.lineTo(e+this.dent,c+this.corner+
d);a.stroke()};
CommandBlockMorph.prototype.drawBottomDentEdge=function(a,b,c){var d=.5*this.edge,e=b+2*this.corner+this.inset;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var f=a.createLinearGradient(0,c-this.edge,0,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(this.corner,c-d);this.isStop()?a.lineTo(this.width()-this.corner,c-d):a.lineTo(b+this.corner+this.inset-d,c-d);a.stroke();if(this.isStop())return null;var g=a.createLinearGradient(0,c+
this.corner-this.edge,0,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(e+d,c+this.corner-d);a.lineTo(e+this.dent,c+this.corner-d);a.stroke();g=a.createLinearGradient(b+e+this.dent-this.edge,c+this.corner-this.edge,b+e+this.dent,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(b+e+this.dent,c+this.corner-d);a.lineTo(b+3*this.corner+this.inset+this.dent,
c-d);a.stroke();a.strokeStyle=f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent,c-d);a.lineTo(this.width()-this.corner,c-d);a.stroke()};CommandBlockMorph.prototype.drawFlatBottomDentEdge=function(a){this.isStop()||(a.fillStyle=this.color.darker(this.contrast/2).toString(),a.beginPath(),this.drawDent(a,0,this.height()-this.corner),a.closePath(),a.fill())};
CommandBlockMorph.prototype.drawLeftEdge=function(a){var b=.5*this.edge,c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.moveTo(b,this.corner);a.lineTo(b,this.height()-2*this.corner-b);a.stroke()};
CommandBlockMorph.prototype.drawRightEdge=function(a){var b=.5*this.edge,c=this.width();var d=a.createLinearGradient(c-this.edge,0,c,0);d.addColorStop(0,this.cachedClr);d.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.moveTo(c-b,this.corner+b);a.lineTo(c-b,this.height()-2*this.corner);a.stroke()};
CommandBlockMorph.prototype.drawTopLeftEdge=function(a){var b=.5*this.edge;var c=a.createRadialGradient(this.corner,this.corner,this.corner,this.corner,this.corner,this.corner-this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.arc(this.corner,this.corner,this.corner-b,radians(-180),radians(-90),!1);a.stroke()};
CommandBlockMorph.prototype.drawBottomRightEdge=function(a){var b=.5*this.edge,c=this.width()-this.corner,d=this.height()-2*this.corner;var e=a.createRadialGradient(c,d,this.corner,c,d,this.corner-this.edge);e.addColorStop(0,this.cachedClrDark);e.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=e;a.beginPath();a.arc(c,d,this.corner-b,radians(90),radians(0),!0);a.stroke()};HatBlockMorph.prototype=new CommandBlockMorph;
HatBlockMorph.prototype.constructor=HatBlockMorph;HatBlockMorph.uber=CommandBlockMorph.prototype;function HatBlockMorph(){this.init()}HatBlockMorph.prototype.init=function(){HatBlockMorph.uber.init.call(this,!0);this.setExtent(new Point(300,150))};HatBlockMorph.prototype.blockSequence=function(){var a=HatBlockMorph.uber.blockSequence.call(this);a.shift();return a};
HatBlockMorph.prototype.drawTop=function(a){var b=this.hatWidth,c=this.hatHeight,d=(4*c*c+b*b)/(8*c),e=degrees(4*Math.atan(2*c/b))/2,f=Math.min(1.7*b,this.width()-this.corner);a.beginPath();a.moveTo(0,c+this.corner);a.arc(b/2,d,d,radians(-e-90),radians(-90),!1);a.bezierCurveTo(b,0,b,c,f,c);a.arc(this.width()-this.corner,c+this.corner,this.corner,radians(-90),radians(-0),!1);a.closePath();a.fill()};
HatBlockMorph.prototype.drawBody=function(a){a.fillRect(0,this.hatHeight+Math.floor(this.corner)-1,this.width(),this.height()-Math.floor(3*this.corner)-this.hatHeight+2)};
HatBlockMorph.prototype.drawLeftEdge=function(a){var b=.5*this.edge,c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.moveTo(b,this.hatHeight+b);a.lineTo(b,this.height()-2*this.corner-b);a.stroke()};
HatBlockMorph.prototype.drawRightEdge=function(a){var b=.5*this.edge,c=this.width();var d=a.createLinearGradient(c-this.edge,0,c,0);d.addColorStop(0,this.cachedClr);d.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.moveTo(c-b,this.corner+this.hatHeight+b);a.lineTo(c-b,this.height()-2*this.corner);a.stroke()};HatBlockMorph.prototype.drawTopDentEdge=function(){return null};
HatBlockMorph.prototype.drawTopLeftEdge=function(a){var b=.5*this.edge,c=this.hatWidth,d=this.hatHeight,e=(4*d*d+c*c)/(8*d),f=degrees(4*Math.atan(2*d/c))/2,g=Math.min(1.7*c,this.width()-this.corner);var h=a.createRadialGradient(c/2,e,e-this.edge,c/2,e,e);h.addColorStop(1,this.cachedClrBright);h.addColorStop(0,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=h;a.beginPath();a.arc(Math.round(c/2),e,e-b,radians(-f-90),radians(-90),!1);a.moveTo(c/2,b);a.bezierCurveTo(c,
b,c,d+b,g,d+b);a.lineTo(this.width()-this.corner,d+b);a.stroke()};ReporterBlockMorph.prototype=new BlockMorph;ReporterBlockMorph.prototype.constructor=ReporterBlockMorph;ReporterBlockMorph.uber=BlockMorph.prototype;function ReporterBlockMorph(a){this.init(a)}ReporterBlockMorph.prototype.init=function(a,b){ReporterBlockMorph.uber.init.call(this,b);this.isPredicate=a||!1;this.setExtent(new Point(200,80),b);this.cachedSlotSpec=null};
ReporterBlockMorph.prototype.snap=function(a){var b=this.parent,c;this.cachedSlotSpec=null;if(!(b instanceof ScriptsMorph))return null;b.clearDropInfo();b.lastDroppedBlock=this;var d=b.closestInput(this,a);null!==d&&(b.lastReplacedInput=d,b.lastDropTarget=d.parent,d instanceof MultiArgMorph?(b.lastPreservedBlocks=d.inputs(),b.lastReplacedInput=d.fullCopy()):d instanceof CommandSlotMorph&&(b.lastReplacedInput=d,c=d.nestedBlock())&&(c=c.fullCopy(),b.add(c),c.moveBy(c.extent()),c.fixBlockColor(),b.lastPreservedBlocks=
[c]),d.parent.replaceInput(d,this),this.snapSound&&this.snapSound.play());this.startLayout();this.fixBlockColor();this.endLayout();ReporterBlockMorph.uber.snap.call(this);a&&b.recordDrop(a.grabOrigin)};
ReporterBlockMorph.prototype.prepareToBeGrabbed=function(a){var b=this.position();nop(a);if(this.parent instanceof BlockMorph||this.parent instanceof MultiArgMorph||this.parent instanceof ReporterSlotMorph)this.parent.revertToDefaultInput(this),this.setPosition(b);ReporterBlockMorph.uber.prepareToBeGrabbed.call(this,a);this.alpha=.85;this.cachedSlotSpec=null};ReporterBlockMorph.prototype.blockSequence=function(){return this};
ReporterBlockMorph.prototype.isUnevaluated=function(){var a=this.getSlotSpec();return"%anyUE"===a||"%boolUE"===a||"%f"===a};ReporterBlockMorph.prototype.isLocked=function(){return this.isStatic||"%t"===this.getSlotSpec()};ReporterBlockMorph.prototype.getSlotSpec=function(){this.cachedSlotSpec||(this.cachedSlotSpec=this.determineSlotSpec());return this.cachedSlotSpec};
ReporterBlockMorph.prototype.determineSlotSpec=function(){if(this.parent instanceof BlockMorph){var a=this.parent.parts().filter(function(a){return!(a instanceof BlockHighlightMorph)});a=a.indexOf(this);if(-1!==a&&this.parent.blockSpec)return this.parseSpec(this.parent.blockSpec)[a]}return this.parent instanceof MultiArgMorph?this.parent.slotSpec:this.parent instanceof TemplateSlotMorph?this.parent.getSpec():null};
ReporterBlockMorph.prototype.mouseClickLeft=function(a){if(this.parent instanceof BlockInputFragmentMorph)return this.parent.mouseClickLeft();this.parent instanceof TemplateSlotMorph?(a=this.parent.parent&&this.parent.parent.parent&&this.parent.parent.parent instanceof RingMorph?"Input name":"%blockVars"===this.parent.parent.elementSpec?"Block variable name":"Script variable name",(new DialogBoxMorph(this,this.userSetSpec,this)).prompt(a,this.blockSpec,this.world())):ReporterBlockMorph.uber.mouseClickLeft.call(this,
a)};ReporterBlockMorph.prototype.exportResultPic=function(){var a=this.topBlock(),b=a.scriptTarget(),c;a===this&&b&&(c=b.parentThatIsA(StageMorph))&&(c.threads.stopProcess(a),c.threads.startProcess(a,b,!1,!0))};
ReporterBlockMorph.prototype.userDestroy=function(){var a=this.selectForEdit();if(a!==this)return this.userDestroy.call(a);if(a=this.parentThatIsA(ScriptsMorph))a.clearDropInfo(),a.lastDroppedBlock=this,a.recordDrop(this.situation()),a.dropRecord.action="delete";this.topBlock().fullChanged();this.prepareToBeGrabbed(this.world().hand);this.destroy()};
ReporterBlockMorph.prototype.drawNew=function(){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.isPredicate?this.drawDiamond(a):this.drawRounded(a);this.isCustomBlock&&!this.isGlobal&&this.drawMethodIcon(a);this.eraseHoles(a)};
ReporterBlockMorph.prototype.drawRounded=function(a){var b=this.height(),c=Math.min(this.rounding,b/2),d=this.width(),e=this.edge/2;a.fillStyle=this.cachedClr;a.beginPath();a.arc(c,c,c,radians(-180),radians(-90),!1);a.arc(d-c,c,c,radians(-90),radians(-0),!1);a.arc(d-c,b-c,c,radians(0),radians(90),!1);a.arc(c,b-c,c,radians(90),radians(180),!1);a.closePath();a.fill();if(!MorphicPreferences.isFlat){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var f=a.createRadialGradient(c,b-c,c-this.edge,
c,b-c,c+this.edge);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(c,b-c,c-e,radians(90),radians(180),!1);a.stroke();f=a.createRadialGradient(d-c,c,c-this.edge,d-c,c,c+this.edge);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(d-c,c,c-e,radians(-90),radians(0),!1);a.stroke();f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);
a.strokeStyle=f;a.beginPath();a.moveTo(c-e,e);a.lineTo(d-c+e,e);a.stroke();f=a.createRadialGradient(c,c,c-this.edge,c,c,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-e,radians(180),radians(270),!1);a.stroke();f=a.createRadialGradient(d-c,b-c,c-this.edge,d-c,b-c,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(d-c,b-c,c-e,radians(0),radians(90),!1);a.stroke();f=a.createLinearGradient(0,
b-this.edge,0,b);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,b-e);a.lineTo(d-c+e,b-e);a.stroke();f=a.createLinearGradient(0,0,this.edge,0);f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(e,c);a.lineTo(e,b-c);a.stroke();f=a.createLinearGradient(d-this.edge,0,d,0);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(d-
e,c+e);a.lineTo(d-e,b-c);a.stroke()}};
ReporterBlockMorph.prototype.drawDiamond=function(a){var b=this.width(),c=this.height(),d=Math.floor(c/2),e=this.rounding,f=this.edge/2;a.fillStyle=this.cachedClr;a.beginPath();a.moveTo(0,d);a.lineTo(e,0);a.lineTo(b-e,0);a.lineTo(b,d);a.lineTo(b-e,c);a.lineTo(e,c);a.closePath();a.fill();if(!MorphicPreferences.isFlat){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var g=a.createLinearGradient(-e,0,e,0);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=
g;a.beginPath();a.moveTo(f,d);a.lineTo(e,c-f);a.closePath();a.stroke();g=a.createLinearGradient(b-e,0,b+e,0);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(b-f,d);a.lineTo(b-e,f);a.closePath();a.stroke();g=a.createLinearGradient(0,0,e,0);g.addColorStop(0,this.cachedClrBright);g.addColorStop(1,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(f,d);a.lineTo(e,f);a.closePath();a.stroke();g=a.createLinearGradient(0,0,0,this.edge);g.addColorStop(0,
this.cachedClrBright);g.addColorStop(1,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(e,f);a.lineTo(b-e,f);a.closePath();a.stroke();g=a.createLinearGradient(b-e,0,b,0);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(b-e,c-f);a.lineTo(b-f,d);a.closePath();a.stroke();g=a.createLinearGradient(0,c-this.edge,0,c);g.addColorStop(0,this.cachedClr);g.addColorStop(1,this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(e+f,c-f);a.lineTo(b-
e-f,c-f);a.closePath();a.stroke()}};RingMorph.prototype=new ReporterBlockMorph;RingMorph.prototype.constructor=RingMorph;RingMorph.uber=ReporterBlockMorph.prototype;RingMorph.prototype.isCachingInputs=!1;function RingMorph(){this.init()}RingMorph.prototype.init=function(){RingMorph.uber.init.call(this);this.category="other";this.alpha=RingMorph.prototype.alpha;this.contrast=RingMorph.prototype.contrast;this.setExtent(new Point(200,80))};
RingMorph.prototype.rootForGrab=function(){return this.isDraggable?this:BlockMorph.uber.rootForGrab.call(this)};
RingMorph.prototype.embed=function(a,b){this.color=SpriteMorph.prototype.blockColor.other;this.isDraggable=!0;if(a instanceof CommandBlockMorph){this.isStatic=!1;this.setSpec("%rc %ringparms");this.selector="reifyScript";var c=this.parts()[0];c.nestedBlock(a)}else a.isPredicate?(this.isStatic=!0,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate"):a instanceof BooleanSlotMorph?(this.isStatic=!1,this.setSpec("%rp %ringparms"),this.selector="reifyPredicate"):(this.isStatic=!1,this.setSpec("%rr %ringparms"),
this.selector="reifyReporter"),c=this.parts()[0],c.silentReplaceInput(c.contents(),a);c=this.parts()[1];b&&b.forEach(function(a){c.addInput(a)});this.fixBlockColor(null,!0)};
RingMorph.prototype.vanishForSimilar=function(){var a=this.parts()[0].nestedBlock();if(!(a&&this.parent instanceof SyntaxElementMorph)||this.parent instanceof RingReporterSlotMorph||this.parent instanceof RingCommandSlotMorph)return null;("reportGetVar"===a.selector||"reportJSFunction"===a.selector||a instanceof RingMorph)&&this.parent.silentReplaceInput(this,a)};RingMorph.prototype.contents=function(){return this.parts()[0].nestedBlock()};RingMorph.prototype.inputNames=function(){return this.parts()[1].evaluate()};
RingMorph.prototype.dataType=function(){switch(this.selector){case "reifyScript":return"command";case "reifyPredicate":return"predicate";default:return"reporter"}};RingMorph.prototype.fixBlockColor=function(a,b){var c=this.parts()[0];RingMorph.uber.fixBlockColor.call(this,a,b);c.fixLayout()};ScriptsMorph.prototype=new FrameMorph;ScriptsMorph.prototype.constructor=ScriptsMorph;ScriptsMorph.uber=FrameMorph.prototype;ScriptsMorph.prototype.cleanUpMargin=20;ScriptsMorph.prototype.cleanUpSpacing=15;
ScriptsMorph.prototype.isPreferringEmptySlots=!0;ScriptsMorph.prototype.enableKeyboard=!0;ScriptsMorph.prototype.enableNestedAutoWrapping=!0;function ScriptsMorph(){this.init()}
ScriptsMorph.prototype.init=function(){this.feedbackColor=SyntaxElementMorph.prototype.feedbackColor;this.feedbackMorph=new BoxMorph;this.rejectsHats=!1;this.focus=this.lastWrapParent=this.lastNextBlock=this.lastPreservedBlocks=this.lastDropTarget=this.lastReplacedInput=this.lastDroppedBlock=null;ScriptsMorph.uber.init.call(this);this.setColor(new Color(70,70,70));this.noticesTransparentClick=!0;this.isAnimating=!1;this.dropRecord=null;this.recordDrop()};
ScriptsMorph.prototype.fullCopy=function(){var a=new ScriptsMorph,b=this.position(),c;this.focus&&this.focus.stopEditing();this.children.forEach(function(d){d.block||(c=d.fullCopy(),a.add(c),c.setPosition(d.position().subtract(b)),c instanceof BlockMorph&&c.allComments().forEach(function(a){a.align(c)}))});a.adjustBounds();return a};
ScriptsMorph.prototype.step=function(){var a=this.world(),b=a.hand;this.feedbackMorph.parent&&(this.feedbackMorph.destroy(),this.feedbackMorph.parent=null);this.focus&&(!a.keyboardReceiver||a.keyboardReceiver instanceof StageMorph)&&this.focus.getFocus(a);if(0===b.children.length||!this.bounds.containsPoint(b.bounds.origin))return null;a=b.children[0];if(!(a instanceof BlockMorph||a instanceof CommentMorph)||!contains(b.morphAtPointer().allParents(),this))return null;a instanceof CommentMorph?this.showCommentDropFeedback(a,
b):a instanceof ReporterBlockMorph?this.showReporterDropFeedback(a,b):this.showCommandDropFeedback(a)};
ScriptsMorph.prototype.showReporterDropFeedback=function(a,b){b=this.closestInput(a,b);if(null===b)return null;this.feedbackMorph.bounds=b.fullBounds().expandBy(Math.max(2*a.edge,a.reporterDropFeedbackPadding));this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);b instanceof MultiArgMorph?(this.feedbackMorph.color=SpriteMorph.prototype.blockColor.lists.copy(),this.feedbackMorph.borderColor=
SpriteMorph.prototype.blockColor.lists):(this.feedbackMorph.color=this.feedbackColor.copy(),this.feedbackMorph.borderColor=this.feedbackColor);this.feedbackMorph.color.a=.5;this.feedbackMorph.drawNew();this.feedbackMorph.changed()};
ScriptsMorph.prototype.showCommandDropFeedback=function(a){var b=a.closestAttachTarget(this);if(!b)return null;"wrap"===b.loc?this.showCSlotWrapFeedback(a,b.element):(this.add(this.feedbackMorph),this.feedbackMorph.border=0,this.feedbackMorph.edge=0,this.feedbackMorph.alpha=1,this.feedbackMorph.setExtent(new Point(b.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight))),this.feedbackMorph.color=this.feedbackColor,this.feedbackMorph.drawNew(),
this.feedbackMorph.changed(),a=b.point.y,"bottom"===b.loc&&("block"===b.type?b.element.nextBlock()&&(a-=SyntaxElementMorph.prototype.corner):"slot"===b.type&&b.element.nestedBlock()&&(a-=SyntaxElementMorph.prototype.corner)),this.feedbackMorph.setPosition(new Point(b.element.left(),a)))};
ScriptsMorph.prototype.showCommentDropFeedback=function(a,b){b=this.closestBlock(a,b);if(!b)return null;this.feedbackMorph.bounds=b.bounds.expandBy(Math.max(2*BlockMorph.prototype.edge,BlockMorph.prototype.reporterDropFeedbackPadding));this.feedbackMorph.edge=SyntaxElementMorph.prototype.rounding;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);this.feedbackMorph.color=a.color.copy();this.feedbackMorph.color.a=.25;this.feedbackMorph.borderColor=
a.titleBar.color;this.feedbackMorph.drawNew();this.feedbackMorph.changed()};
ScriptsMorph.prototype.showCSlotWrapFeedback=function(a,b){this.feedbackMorph.bounds=b.fullBounds().expandBy(BlockMorph.prototype.corner);this.feedbackMorph.edge=SyntaxElementMorph.prototype.corner;this.feedbackMorph.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.add(this.feedbackMorph);a=a.color.lighter(40);this.feedbackMorph.color=a.copy();this.feedbackMorph.color.a=.1;this.feedbackMorph.borderColor=a;this.feedbackMorph.drawNew();this.feedbackMorph.changed()};
ScriptsMorph.prototype.closestInput=function(a,b){var c=a.fullBoundsNoShadow(),d=this.children.filter(function(a){return a instanceof BlockMorph&&a.fullBounds().intersects(c)}),e=a.allInputs();var f=[];d.forEach(function(a){f=f.concat(a.allInputs())});if(0===f.length)return null;if(this.isPreferringEmptySlots){if(b){var g=b.position();if(d=detect(f,function(a){return(a instanceof InputSlotMorph||a instanceof ArgMorph&&!(a instanceof CommandSlotMorph)&&!(a instanceof MultiArgMorph)||a instanceof RingMorph&&
!a.contents()||a.isEmptySlot())&&!a.isLocked()&&a.bounds.containsPoint(g)&&!contains(e,a)}))return d}if(d=detect(f,function(a){var b;if(b=(a instanceof InputSlotMorph||a instanceof ArgMorph||a instanceof RingMorph&&!a.contents()||a.isEmptySlot())&&!a.isLocked()&&a.bounds.intersects(c)&&!contains(e,a))b=a instanceof MultiArgMorph?a.arrows().bounds.intersects(c):!0;return b}))return d}return b&&(g=b.position(),d=detect(f,function(b){return b!==a&&!b.isLocked()&&b.bounds.containsPoint(g)&&!(b.parent instanceof
PrototypeHatBlockMorph)&&!contains(e,b)}))?d:detect(f,function(b){return b!==a&&!b.isLocked()&&b.fullBounds().intersects(c)&&!(b.parent instanceof PrototypeHatBlockMorph)&&!contains(e,b)})};
ScriptsMorph.prototype.closestBlock=function(a,b){var c=a.bounds;a=this.children.filter(function(a){return a instanceof BlockMorph&&a.fullBounds().intersects(c)});var d=[];a.forEach(function(a){d=d.concat(a.allChildren().slice(0).reverse().filter(function(a){return a instanceof BlockMorph&&!a.isTemplate}))});if(0===d.length)return null;if(b){var e=b.position();if(b=detect(d,function(a){return!a.comment&&!a.isPrototype&&a.bounds.containsPoint(e)}))return b}return detect(d,function(a){return!a.comment&&
!a.isPrototype&&a.bounds.intersects(c)})};
ScriptsMorph.prototype.userMenu=function(){function a(a,c,d,e,f){b.addItem((d?"\u2611 ":"\u2610 ")+localize(a),c,d?e:f)}var b=new MenuMorph(this),c=this.parentThatIsA(IDE_Morph),d=16===this.world().currentKey,e,f=this,g=this.scriptTarget(),h=g.parentThatIsA(StageMorph);c||(e=this.parentThatIsA(BlockEditorMorph))&&(c=e.target.parentThatIsA(IDE_Morph));if(this.dropRecord){if(this.dropRecord.lastRecord){var k=!0;b.addPair([new SymbolMorph("turnBack",MorphicPreferences.menuFontSize),localize("undrop")],
"undrop","^Z","undo the last\nblock drop\nin this pane")}this.dropRecord.nextRecord&&(k=!0,b.addPair([new SymbolMorph("turnForward",MorphicPreferences.menuFontSize),localize("redrop")],"redrop","^Y","redo the last undone\nblock drop\nin this pane"));k&&(d&&b.addItem("clear undrop queue",function(){f.dropRecord=null;f.clearDropInfo();f.recordDrop()},"forget recorded block drops\non this pane",new Color(100,0,0)),b.addLine())}b.addItem("clean up","cleanUp","arrange scripts\nvertically");b.addItem("add comment",
"addComment");b.addItem("scripts pic...","exportScriptsPicture","open a new window\nwith a picture of all scripts");c&&(b.addLine(),!e&&g.exemplar&&a("inherited",function(){g.toggleInheritanceForAttribute("scripts")},g.inheritsAttribute("scripts"),"uncheck to\ndisinherit",localize("check to inherit\nfrom")+" "+g.exemplar.name),b.addItem("make a block...",function(){(new BlockDialogMorph(null,function(a){""!==a.spec&&(a.isGlobal?h.globalBlocks.push(a):g.customBlocks.push(a),c.flushPaletteCache(),c.refreshPalette(),
(new BlockEditorMorph(a,g)).popUp())},f)).prompt("Make a block",null,f.world())}));return b};
ScriptsMorph.prototype.cleanUp=function(){var a=this.selectForEdit(),b=a.topLeft(),c=a.cleanUpMargin;a.children.sort(function(a,b){return a instanceof PrototypeHatBlockMorph?0:a.top()-b.top()}).forEach(function(d){d instanceof CommentMorph&&d.block||(d.setPosition(b.add(new Point(a.cleanUpMargin,c))),d instanceof BlockMorph&&d.allComments().forEach(function(a){a.align(d,!0)}),c+=d.stackHeight()+a.cleanUpSpacing)});a.parent&&a.setPosition(a.parent.topLeft());a.adjustBounds()};
ScriptsMorph.prototype.exportScriptsPicture=function(){var a=this.scriptsPicture(),b=this.world().children[0];a&&b.saveCanvasAs(a,(b.projectName||localize("untitled"))+" "+localize("script pic"))};
ScriptsMorph.prototype.scriptsPicture=function(){if(0!==this.children.length){var a=this.children[0].fullBounds();this.children.forEach(function(b){b.isVisible&&(a=a.merge(b.fullBounds()))});var b=newCanvas(a.extent());var c=b.getContext("2d");this.children.forEach(function(b){var d=b.fullBounds().origin;b.isVisible&&c.drawImage(b.fullImageClassic(),d.x-a.origin.x,d.y-a.origin.y)});return b}};
ScriptsMorph.prototype.addComment=function(){var a=this.parentThatIsA(IDE_Morph),b=this.parentThatIsA(BlockEditorMorph),c=this.world();(new CommentMorph).pickUp(c);!a&&b&&(a=b.target.parentThatIsA(IDE_Morph));a&&(c.hand.grabOrigin={origin:a.palette,position:a.palette.center()})};
ScriptsMorph.prototype.undrop=function(){var a=this;!this.isAnimating&&this.dropRecord&&this.dropRecord.lastRecord&&(this.dropRecord.situation||(this.dropRecord.situation=this.dropRecord.lastDroppedBlock.situation()),this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.lastOrigin,null,this.recoverLastDrop(),function(){a.updateToolbar();a.isAnimating=!1}),this.dropRecord=this.dropRecord.lastRecord)};
ScriptsMorph.prototype.redrop=function(){var a=this;!this.isAnimating&&this.dropRecord&&this.dropRecord.nextRecord&&(this.dropRecord=this.dropRecord.nextRecord,"delete"===this.dropRecord.action?(this.recoverLastDrop(!0),this.dropRecord.lastDroppedBlock.destroy(),this.updateToolbar()):(this.isAnimating=!0,this.dropRecord.lastDroppedBlock.slideBackTo(this.dropRecord.situation,null,this.recoverLastDrop(!0),function(){a.updateToolbar();a.isAnimating=!1})))};
ScriptsMorph.prototype.recoverLastDrop=function(a){var b=this.dropRecord,c;if(!b||!b.lastDroppedBlock)throw Error("nothing to undrop");var d=b.lastDroppedBlock;var e=d.parent;if(d instanceof CommandBlockMorph){if(b.lastNextBlock&&("delete"===b.action?a&&this.add(b.lastNextBlock):this.add(b.lastNextBlock)),b.lastDropTarget)if("bottom"===b.lastDropTarget.loc)"slot"===b.lastDropTarget.type?b.lastNextBlock&&b.lastDropTarget.element.nestedBlock(b.lastNextBlock):b.lastNextBlock&&b.lastDropTarget.element.nextBlock(b.lastNextBlock);
else if("top"===b.lastDropTarget.loc)this.add(b.lastDropTarget.element);else if("wrap"===b.lastDropTarget.loc){var f=detect(b.lastDroppedBlock.inputs(),function(a){return a instanceof CSlotMorph});b.lastWrapParent instanceof CommandBlockMorph?a?c=function(){f.nestedBlock(b.lastDropTarget.element)}:b.lastWrapParent.nextBlock(b.lastDropTarget.element):b.lastWrapParent instanceof CommandSlotMorph?a?c=function(){f.nestedBlock(b.lastDropTarget.element)}:b.lastWrapParent.nestedBlock(b.lastDropTarget.element):
this.add(b.lastDropTarget.element);b.lastDropTarget.element.blockSequence().forEach(function(a){a.fixBlockColor()});f.fixLayout()}}else if(d instanceof ReporterBlockMorph)b.lastDropTarget&&(b.lastDropTarget.replaceInput(b.lastDroppedBlock,b.lastReplacedInput),b.lastDropTarget.fixBlockColor(null,!0),b.lastPreservedBlocks&&b.lastPreservedBlocks.forEach(function(a){a.destroy()}));else if(d instanceof CommentMorph)a&&b.lastDropTarget&&(c=function(){b.lastDropTarget.element.comment=d;d.block=b.lastDropTarget.element;
d.align()});else throw Error("unsupported action for "+d);this.clearDropInfo();d.prepareToBeGrabbed(this.world().hand);d instanceof CommentMorph&&d.removeShadow();this.add(d);e.reactToGrabOf(d);d instanceof ReporterBlockMorph&&e instanceof BlockMorph&&e.changed();"delete"===b.action&&(a&&b.lastNextBlock&&(e instanceof CommandBlockMorph?e.nextBlock(b.lastNextBlock):e instanceof CommandSlotMorph&&e.nestedBlock(b.lastNextBlock)),a||d.moveBy(new Point(-100,-20)));return c};
ScriptsMorph.prototype.clearDropInfo=function(){this.lastWrapParent=this.lastNextBlock=this.lastPreservedBlocks=this.lastDropTarget=this.lastReplacedInput=this.lastDroppedBlock=null};
ScriptsMorph.prototype.recordDrop=function(a){a={lastDroppedBlock:this.lastDroppedBlock,lastReplacedInput:this.lastReplacedInput,lastDropTarget:this.lastDropTarget,lastPreservedBlocks:this.lastPreservedBlocks,lastNextBlock:this.lastNextBlock,lastWrapParent:this.lastWrapParent,lastOrigin:a,action:null,situation:null,lastRecord:this.dropRecord,nextRecord:null};this.dropRecord&&(this.dropRecord.nextRecord=a);this.dropRecord=a;this.updateToolbar()};
ScriptsMorph.prototype.addToolbar=function(){var a=new AlignmentMorph,b=this,c=new Color(140,140,140);a.respectHiddens=!0;a.undoButton=new PushButtonMorph(this,"undrop",new SymbolMorph("turnBack",12));a.undoButton.alpha=.2;a.undoButton.padding=2;a.undoButton.labelShadowColor=c;a.undoButton.drawNew();a.undoButton.fixLayout();a.add(a.undoButton);a.redoButton=new PushButtonMorph(this,"redrop",new SymbolMorph("turnForward",12));a.redoButton.alpha=.2;a.redoButton.padding=2;a.redoButton.labelShadowColor=
c;a.redoButton.drawNew();a.redoButton.fixLayout();a.add(a.redoButton);a.keyboardButton=new ToggleButtonMorph(null,this,"toggleKeyboardEntry",[new SymbolMorph("keyboard",12),new SymbolMorph("keyboardFilled",12)],function(){return!isNil(b.focus)});a.keyboardButton.alpha=.2;a.keyboardButton.padding=2;a.keyboardButton.hint="use the keyboard\nto enter blocks";a.keyboardButton.labelShadowColor=c;a.keyboardButton.drawNew();a.keyboardButton.fixLayout();a.add(a.keyboardButton);return a};
ScriptsMorph.prototype.updateToolbar=function(){var a=this.parentThatIsA(ScrollFrameMorph);a&&(a.toolBar||(a.toolBar=this.addToolbar(),a.add(a.toolBar)),this.enableKeyboard?(a.toolBar.keyboardButton.show(),a.toolBar.keyboardButton.refresh()):a.toolBar.keyboardButton.hide(),this.dropRecord&&(this.dropRecord.lastRecord?a.toolBar.undoButton.isVisible||a.toolBar.undoButton.show():a.toolBar.undoButton.isVisible&&a.toolBar.undoButton.hide(),this.dropRecord.nextRecord?a.toolBar.redoButton.isVisible||(a.toolBar.redoButton.show(),
a.toolBar.undoButton.mouseLeave()):a.toolBar.redoButton.isVisible&&a.toolBar.redoButton.hide()),detect(a.toolBar.children,function(a){return a.isVisible})&&(a.toolBar.fixLayout(),a.adjustToolBar()))};ScriptsMorph.prototype.sortedElements=function(){var a=this.children.filter(function(a){return a instanceof CommentMorph?!a.block:!0});a.sort(function(a,c){return a instanceof PrototypeHatBlockMorph?0:a.top()-c.top()});return a};
ScriptsMorph.prototype.fixMultiArgs=function(){var a=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.forAllChildren(function(a){a instanceof MultiArgMorph&&a.fixLayout()});Morph.prototype.trackChanges=a};ScriptsMorph.prototype.wantsDropOf=function(a){return a instanceof HatBlockMorph?!this.rejectsHats:a instanceof SyntaxElementMorph||a instanceof CommentMorph};ScriptsMorph.prototype.reactToDropOf=function(a,b){(a instanceof BlockMorph||a instanceof CommentMorph)&&a.snap(b);this.adjustBounds()};
ScriptsMorph.prototype.mouseClickLeft=function(a){if(16===this.world().currentKey)return this.edit(a);this.focus&&this.focus.stopEditing()};ScriptsMorph.prototype.selectForEdit=function(){var a=this.parentThatIsA(IDE_Morph);return(a=a?a.currentSprite:null)&&a.inheritsAttribute("scripts")?(this.feedbackMorph.destroy(),a.shadowAttribute("scripts"),a.scripts):this};
ScriptsMorph.prototype.edit=function(a){var b=this.world();this.focus&&this.focus.stopEditing();b.stopEditing();if(ScriptsMorph.prototype.enableKeyboard){var c=this.selectForEdit();c.focus=new ScriptFocusMorph(c,c,a);c.focus.getFocus(b)}};
ScriptsMorph.prototype.toggleKeyboardEntry=function(){var a=this.world();if(this.focus)this.focus.stopEditing();else if(a.stopEditing(),ScriptsMorph.prototype.enableKeyboard){var b=this.selectForEdit();b.focus=new ScriptFocusMorph(b,b,b.position());b.focus.getFocus(a);a=b.focus.sortedScripts();a.length?(b.focus.element=a[0],b.focus.element instanceof HatBlockMorph&&b.focus.nextCommand()):b.focus.moveBy(new Point(50,50));b.focus.fixLayout()}};
ScriptsMorph.prototype.scriptTarget=function(){var a=this.parentThatIsA(IDE_Morph);if(a)return a.currentSprite;if(a=this.parentThatIsA(BlockEditorMorph))return a.target;throw Error("script target bannot be found for orphaned scripts");};ArgMorph.prototype=new SyntaxElementMorph;ArgMorph.prototype.constructor=ArgMorph;ArgMorph.uber=SyntaxElementMorph.prototype;function ArgMorph(a){this.init(a)}
ArgMorph.prototype.init=function(a,b){this.type=a||null;this.isHole=!1;ArgMorph.uber.init.call(this,b);this.color=new Color(0,17,173);this.setExtent(new Point(50,50),b)};ArgMorph.prototype.executeOnSliderEdit=!1;
ArgMorph.prototype.reactToSliderEdit=function(){var a,b;if(this.executeOnSliderEdit&&(a=this.parentThatIsA(BlockMorph))){a=a.topBlock();var c=a.scriptTarget();a instanceof PrototypeHatBlockMorph||!c||((b=c.parentThatIsA(StageMorph))&&(b.isThreadSafe||Process.prototype.enableSingleStepping)?b.threads.startProcess(a,c,b.isThreadSafe):a.mouseClickLeft())}};ArgMorph.prototype.justDropped=function(){this instanceof CommandSlotMorph||(this.drawNew(),this.changed())};ArgMorph.prototype.getSpec=function(){return"%s"};
ArgMorph.prototype.drawNew=function(){"list"===this.type?(this.image=this.listIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):"object"===this.type?(this.image=this.objectIcon(),this.silentSetExtent(new Point(this.image.width,this.image.height))):ArgMorph.uber.drawNew.call(this)};
ArgMorph.prototype.listIcon=function(){var a=new Morph,b=new CellMorph,c=new CellMorph;a.color=new Color(255,255,255);c.setPosition(b.bottomLeft().add(new Point(0,this.fontSize/3)));b.add(c);b.setPosition(a.position().add(this.fontSize));a.add(b);a.bounds.corner=c.bounds.corner.add(this.fontSize);a.drawNew();a=a.fullImage();var d=(this.fontSize+this.edge)/a.height;b=newCanvas(new Point(Math.ceil(a.width*d)+1,Math.ceil(a.height*d)+1));c=b.getContext("2d");c.fillStyle="black";c.fillRect(0,0,b.width,
b.height);c.scale(d,d);c.drawImage(a,1/d,1/d);return b};ArgMorph.prototype.objectIcon=function(){return this.labelPart("%turtle").image};ArgMorph.prototype.isEmptySlot=function(){return null!==this.type};CommandSlotMorph.prototype=new ArgMorph;CommandSlotMorph.prototype.constructor=CommandSlotMorph;CommandSlotMorph.uber=ArgMorph.prototype;function CommandSlotMorph(){this.init()}
CommandSlotMorph.prototype.init=function(a){CommandSlotMorph.uber.init.call(this,null,!0);this.color=new Color(0,17,173);this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),a)};CommandSlotMorph.prototype.getSpec=function(){return"%cmd"};CommandSlotMorph.prototype.topBlock=function(){return this.parent.topBlock?this.parent.topBlock():this.nestedBlock()};
CommandSlotMorph.prototype.nestedBlock=function(a){if(a){var b=this.nestedBlock();this.add(a);b&&a.bottomBlock().nextBlock(b);this.fixLayout()}else return detect(this.children,function(a){return a instanceof CommandBlockMorph})};CommandSlotMorph.prototype.slotAttachPoint=function(){return new Point(this.dentCenter(),this.top()+2*this.corner)};CommandSlotMorph.prototype.dentLeft=function(){return this.left()+this.corner+2*this.inset};
CommandSlotMorph.prototype.dentCenter=function(){return this.dentLeft()+this.corner+.5*this.dent};CommandSlotMorph.prototype.attachTargets=function(){var a=[];a.push({point:this.slotAttachPoint(),element:this,loc:"bottom",type:"slot"});return a};
CommandSlotMorph.prototype.fixLayout=function(){var a=this.nestedBlock();this.parent&&(this.color.eq(this.parent.color)||this.setColor(this.parent.color));a?(a.setPosition(new Point(this.left()+this.edge+this.rfBorder,this.top()+this.edge+this.rfBorder)),this.setWidth(a.fullBounds().width()+2*(this.edge+this.rfBorder)),this.setHeight(a.fullBounds().height()+this.edge+2*this.rfBorder-(this.corner-this.edge))):(this.setHeight(4*this.corner),this.setWidth(4*this.corner+this.inset+this.dent));this.parent.fixLayout&&
this.parent.fixLayout()};CommandSlotMorph.prototype.evaluate=function(){return this.nestedBlock()};CommandSlotMorph.prototype.isEmptySlot=function(){return!this.isStatic&&null===this.nestedBlock()};CommandSlotMorph.prototype.attach=function(){var a=this.overlappedMorphs(),b=new MenuMorph(this,"choose new parent:"),c=this;a.forEach(function(a){b.addItem(a.toString().slice(0,50),function(){a.add(c);c.isDraggable=!1;a.fixLayout&&a.fixLayout()})});0<a.length&&b.popUpAtHand(this.world())};
CommandSlotMorph.prototype.drawNew=function(){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.cachedClr;a.fillRect(0,0,this.width(),this.height());a.fillStyle=this.rfColor.toString();this.drawFlat(a);MorphicPreferences.isFlat||this.drawEdges(a)};
CommandSlotMorph.prototype.drawFlat=function(a){var b=null!==this.nestedBlock(),c=b?this.inset:this.inset/2,d=b?this.dent:this.dent/2,e=2*this.corner+c,f=this.edge;b=b?this.rfBorder:0;var g=this.height()-this.corner-f;a.beginPath();a.arc(this.corner+f,this.corner+f,this.corner,radians(-180),radians(-90),!1);a.lineTo(this.corner+c+f+2*b,f);a.lineTo(e+f+2*b,this.corner+f);a.lineTo(e+f+2*b+(d-2*b),this.corner+f);a.lineTo(e+f+2*b+(d-2*b)+this.corner,f);a.lineTo(this.width()-this.corner-f,f);a.arc(this.width()-
this.corner-f,this.corner+f,this.corner,radians(-90),radians(-0),!1);a.arc(this.width()-this.corner-f,g,this.corner,radians(0),radians(90),!1);a.arc(this.corner+f,g,this.corner,radians(90),radians(180),!1);a.closePath();a.fill()};
CommandSlotMorph.prototype.drawEdges=function(a){var b=null!==this.nestedBlock(),c=b?this.inset:this.inset/2,d=b?this.dent:this.dent/2,e=2*this.corner+c,f=this.edge;b=b?this.rfBorder:0;var g=.5*this.edge;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var h=a.createLinearGradient(0,this.height(),0,this.height()-this.edge);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrBright);a.strokeStyle=h;a.beginPath();a.moveTo(this.corner+f,this.height()-g);a.lineTo(this.width()-this.corner-
f,this.height()-g);a.stroke();h=a.createRadialGradient(this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner,this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner+f);h.addColorStop(0,this.cachedClrBright);h.addColorStop(1,this.cachedClr);a.strokeStyle=h;a.beginPath();a.arc(this.width()-(this.corner+f),this.height()-(this.corner+f),this.corner+g,radians(0),radians(90),!1);a.stroke();h=a.createLinearGradient(this.width(),0,this.width()-this.edge,0);h.addColorStop(0,
this.cachedClr);h.addColorStop(1,this.cachedClrBright);a.strokeStyle=h;a.beginPath();a.moveTo(this.width()-g,this.height()-this.corner-this.edge);a.lineTo(this.width()-g,f+this.corner);a.stroke();a.shadowOffsetY=g;a.shadowBlur=this.edge;a.shadowColor=this.rfColor.darker(80).toString();h=a.createLinearGradient(0,0,f,0);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrDark);a.strokeStyle=h;a.beginPath();a.moveTo(g,f+this.corner);a.lineTo(g,this.height()-f-this.corner);a.stroke();h=a.createRadialGradient(this.corner+
f,this.corner+f,this.corner,this.corner+f,this.corner+f,this.corner+f);h.addColorStop(0,this.cachedClrDark);h.addColorStop(1,this.cachedClr);a.strokeStyle=h;a.beginPath();a.arc(this.corner+f,this.corner+f,this.corner+g,radians(-180),radians(-90),!1);a.stroke();h=a.createLinearGradient(0,0,0,this.edge);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrDark);a.strokeStyle=h;a.beginPath();a.moveTo(this.corner+f,g);a.lineTo(this.corner+c+f+2*b-g,g);a.stroke();c=a.createLinearGradient(0,
this.corner,0,this.corner+f);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(e+f+2*b+g,this.corner+g);a.lineTo(e+f+2*b+(d-2*b),this.corner+g);a.stroke();c=a.createLinearGradient(e+f+2*b+(d-2*b)-g,this.corner,e+f+2*b+(d-2*b)+.7*g,this.corner+g+.7*g);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(e+f+2*b+(d-2*b),this.corner+g);a.lineTo(e+f+2*b+(d-2*b)+this.corner,g);a.stroke();
a.strokeStyle=h;a.beginPath();a.moveTo(e+f+2*b+(d-2*b)+this.corner,g);a.lineTo(this.width()-this.corner-f,g);a.stroke()};RingCommandSlotMorph.prototype=new CommandSlotMorph;RingCommandSlotMorph.prototype.constructor=RingCommandSlotMorph;RingCommandSlotMorph.uber=CommandSlotMorph.prototype;RingCommandSlotMorph.prototype.rfBorder=0;RingCommandSlotMorph.prototype.edge=RingMorph.prototype.edge;function RingCommandSlotMorph(){this.init()}
RingCommandSlotMorph.prototype.init=function(a){RingCommandSlotMorph.uber.init.call(this,a);this.noticesTransparentClick=this.isHole=!0;this.color=new Color(0,17,173);this.alpha=RingMorph.prototype.alpha;this.contrast=RingMorph.prototype.contrast};RingCommandSlotMorph.prototype.getSpec=function(){return"%rc"};
RingCommandSlotMorph.prototype.drawNew=function(){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawFlat(a);MorphicPreferences.isFlat||this.drawEdges(a)};
RingCommandSlotMorph.prototype.drawFlat=function(a){var b=null!==this.nestedBlock(),c=b?this.inset:this.inset/2,d=b?this.dent:this.dent/2,e=2*this.corner+c,f=this.edge,g=this.width(),h=this.height();b=b?this.rfBorder:0;var k=h-this.corner-f;a.beginPath();a.moveTo(0,h/2);a.lineTo(f,h/2);a.arc(this.corner+f,this.corner+f,this.corner,radians(-180),radians(-90),!1);a.lineTo(this.corner+c+f+2*b,f);a.lineTo(e+f+2*b,this.corner+f);a.lineTo(e+f+2*b+(d-2*b),this.corner+f);a.lineTo(e+f+2*b+(d-2*b)+this.corner,
f);a.lineTo(this.width()-this.corner-f,f);a.arc(g-this.corner-f,this.corner+f,this.corner,radians(-90),radians(-0),!1);a.lineTo(g-this.edge,h/2);a.lineTo(g,h/2);a.lineTo(g,0);a.lineTo(0,0);a.closePath();a.fill();a.beginPath();a.moveTo(g,h/2);a.lineTo(g-f,h/2);a.arc(this.width()-this.corner-f,k,this.corner,radians(0),radians(90),!1);a.arc(this.corner+f,k,this.corner,radians(90),radians(180),!1);a.lineTo(f,h/2);a.lineTo(0,h/2);a.lineTo(0,h);a.lineTo(g,h);a.closePath();a.fill()};
CSlotMorph.prototype=new CommandSlotMorph;CSlotMorph.prototype.constructor=CSlotMorph;CSlotMorph.uber=CommandSlotMorph.prototype;function CSlotMorph(){this.init()}CSlotMorph.prototype.init=function(a){CommandSlotMorph.uber.init.call(this,null,!0);this.isHole=!0;this.isLambda=!1;this.color=new Color(0,17,173);this.setExtent(new Point(230,4*this.corner+this.cSlotPadding),a)};CSlotMorph.prototype.getSpec=function(){return"%c"};
CSlotMorph.prototype.mappedCode=function(a){var b=(StageMorph.prototype.codeMappings.reify||"<#1>").split("\n"),c=this.nestedBlock(),d=(c?c.mappedCode(a):"").toString().split("\n"),e=/<#1>/g;b.forEach(function(a,c){var f="";0===a.trimLeft().indexOf("<#1>")&&(f=a.indexOf("<#1>"),f=a.slice(0,f));b[c]=a.replace(/<#1>/,d.join("\n"+f));b[c]=b[c].replace(e,d.join("\n"))});return b.join("\n")};
CSlotMorph.prototype.fixLayout=function(){var a=this.nestedBlock();a?(a.setPosition(new Point(this.left()+this.inset,this.top()+this.corner)),this.setHeight(a.fullBounds().height()+this.corner),this.setWidth(a.fullBounds().width()+2*this.cSlotPadding)):(this.setHeight(4*this.corner+this.cSlotPadding),this.setWidth(4*this.corner+2*this.inset+this.dent+2*this.cSlotPadding));this.parent.fixLayout&&this.parent.fixLayout()};
CSlotMorph.prototype.drawNew=function(){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawFlat(a);MorphicPreferences.isFlat||(this.drawTopRightEdge(a),this.drawTopEdge(a,this.inset,this.corner),this.drawTopLeftEdge(a),this.drawBottomEdge(a),this.drawRightEdge(a))};
CSlotMorph.prototype.drawFlat=function(a){a.beginPath();a.moveTo(0,0);a.lineTo(this.width(),0);a.arc(this.width()-this.corner,0,this.corner,radians(90),radians(0),!0);a.lineTo(this.width()-this.corner,this.corner);a.lineTo(2*this.inset+3*this.corner+this.dent,this.corner);a.lineTo(2*this.inset+2*this.corner+this.dent,2*this.corner);a.lineTo(2*this.inset+2*this.corner,2*this.corner);a.lineTo(2*this.inset+this.corner,this.corner);a.lineTo(this.inset+this.corner,this.corner);a.arc(this.inset+this.corner,
2*this.corner,this.corner,radians(270),radians(180),!0);a.lineTo(this.inset,this.height()-2*this.corner);a.arc(this.inset+this.corner,this.height()-2*this.corner,this.corner,radians(180),radians(90),!0);a.lineTo(this.width()-this.corner,this.height()-this.corner);a.arc(this.width()-this.corner,this.height(),this.corner,radians(-90),radians(-0),!1);a.lineTo(0,this.height());a.closePath();a.fill()};
CSlotMorph.prototype.drawTopRightEdge=function(a){var b=.5*this.edge,c=this.width()-this.corner;var d=a.createRadialGradient(c,0,this.corner,c,0,this.corner-this.edge);d.addColorStop(0,this.cachedClrDark);d.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.arc(c,0,this.corner-b,radians(90),radians(0),!0);a.stroke()};
CSlotMorph.prototype.drawTopEdge=function(a,b,c){var d=.5*this.edge,e=b+2*this.corner+this.inset;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var f=a.createLinearGradient(0,c-this.edge,0,c);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(b+this.corner,c-d);a.lineTo(b+this.corner+this.inset-d,c-d);a.stroke();var g=a.createLinearGradient(0,c+this.corner-this.edge,0,c+this.corner);g.addColorStop(0,this.cachedClr);g.addColorStop(1,
this.cachedClrDark);a.strokeStyle=g;a.beginPath();a.moveTo(e+d,c+this.corner-d);a.lineTo(e+this.dent,c+this.corner-d);a.stroke();e=a.createLinearGradient(b+this.inset+2*this.corner+this.dent-d,c+this.corner-d-d,b+this.inset+2*this.corner+this.dent+.7*d,c+this.corner-d+.7*d);e.addColorStop(0,this.cachedClr);e.addColorStop(1,this.cachedClrDark);a.strokeStyle=e;a.beginPath();a.moveTo(b+this.inset+2*this.corner+this.dent,c+this.corner-d);a.lineTo(b+3*this.corner+this.inset+this.dent,c-d);a.stroke();a.strokeStyle=
f;a.beginPath();a.moveTo(b+3*this.corner+this.inset+this.dent,c-d);a.lineTo(this.width()-this.corner,c-d);a.stroke()};
CSlotMorph.prototype.drawTopLeftEdge=function(a){var b=.5*this.edge;var c=a.createRadialGradient(this.corner+this.inset,2*this.corner,this.corner,this.corner+this.inset,2*this.corner,this.corner+this.edge);c.addColorStop(0,this.cachedClrDark);c.addColorStop(1,this.cachedClr);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=c;a.beginPath();a.arc(this.corner+this.inset,2*this.corner,this.corner+b,radians(-180),radians(-90),!1);a.stroke()};
CSlotMorph.prototype.drawRightEdge=function(a){var b=.5*this.edge,c=this.inset;var d=a.createLinearGradient(c-this.edge,0,c,0);d.addColorStop(0,this.cachedClr);d.addColorStop(1,this.cachedClrDark);a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=d;a.beginPath();a.moveTo(c-b,2*this.corner);a.lineTo(c-b,this.height()-2*this.corner);a.stroke()};
CSlotMorph.prototype.drawBottomEdge=function(a){var b=.5*this.edge;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var c=a.createRadialGradient(this.corner+this.inset,this.height()-2*this.corner,this.corner,this.corner+this.inset,this.height()-2*this.corner,this.corner+this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.arc(this.corner+this.inset,this.height()-2*this.corner,this.corner+b,radians(180),radians(90),!0);a.stroke();
c=a.createLinearGradient(0,this.height()-this.corner,0,this.height()-this.corner+this.edge);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.inset+this.corner,this.height()-this.corner+b);a.lineTo(this.width()-this.corner,this.height()-this.corner+b);a.stroke()};InputSlotMorph.prototype=new ArgMorph;InputSlotMorph.prototype.constructor=InputSlotMorph;InputSlotMorph.uber=ArgMorph.prototype;
function InputSlotMorph(a,b,c,d){this.init(a,b,c,d)}
InputSlotMorph.prototype.init=function(a,b,c,d){var e=new StringMorph(""),f=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));e.fontSize=this.fontSize;e.isShowingBlanks=!0;e.drawNew();this.isUnevaluated=!1;this.choices=c||null;this.oldContentsExtent=e.extent();this.isNumeric=b||!1;this.isReadOnly=d||!1;this.minWidth=0;this.constant=null;InputSlotMorph.uber.init.call(this,null,!0);this.color=new Color(255,255,255);this.add(e);this.add(f);e.isEditable=!0;e.isDraggable=!1;e.enableSelecting();
this.setContents(a)};InputSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%n":"%s"};InputSlotMorph.prototype.contents=function(){return detect(this.children,function(a){return a instanceof StringMorph})};InputSlotMorph.prototype.arrow=function(){return detect(this.children,function(a){return a instanceof ArrowMorph})};
InputSlotMorph.prototype.setContents=function(a){var b=this.contents(),c=a,d=c instanceof Array;if(d)c=localize(c[0]),b.isItalic=!this.isReadOnly;else if(b.isItalic=!1,!isNil(this.choices)&&this.choices[c]instanceof Array)return this.setContents(this.choices[c]);b.text=c;isNil(c)?b.text="":c.toString&&(b.text=c.toString());b.drawNew();this.isReadOnly&&this.parent instanceof BlockMorph&&this.parent.fixLabelColor();this.constant=d?a:null};InputSlotMorph.prototype.userSetContents=function(a){this.selectForEdit().setContents(a)};
InputSlotMorph.prototype.dropDownMenu=function(a){var b=this.menuFromDict(this.choices,null,a);b&&0<b.items.length&&(a?(b.popup(this.world(),this.bottomLeft()),b.getFocus()):b.popUpAtHand(this.world()))};
InputSlotMorph.prototype.menuFromDict=function(a,b,c){var d,e=new MenuMorph(this.userSetContents,null,this,this.fontSize);if(a instanceof Function)a=a.call(this);else if(isString(a)&&(a=this[a](c),!a))return;b||e.addItem(" ",null);for(d in a)Object.prototype.hasOwnProperty.call(a,d)&&("~"===d[0]?e.addLine():a[d]instanceof Object&&!(a[d]instanceof Array)&&"function"!==typeof a[d]?e.addMenu(d,this.menuFromDict(a[d],!0)):e.addItem(d,a[d]));return e};
InputSlotMorph.prototype.messagesMenu=function(){var a={},b=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),c=this,d=[];b.children.concat(b).forEach(function(a){isSnapObject(a)&&(d=d.concat(a.allMessageNames()))});d.forEach(function(b){a[b]=b});0<d.length&&(a["~"]=null);a["new..."]=function(){(new DialogBoxMorph(c,c.setContents,c)).prompt("Message name",null,c.world())};return a};
InputSlotMorph.prototype.messagesReceivedMenu=function(){var a={"any message":["any message"]},b=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),c=this,d=[];b.children.concat(b).forEach(function(a){isSnapObject(a)&&(d=d.concat(a.allMessageNames()))});d.forEach(function(b){a[b]=b});a["~"]=null;a["new..."]=function(){(new DialogBoxMorph(c,c.setContents,c)).prompt("Message name",null,c.world())};return a};
InputSlotMorph.prototype.collidablesMenu=function(){var a={"mouse-pointer":["mouse-pointer"],edge:["edge"],"pen trails":["pen trails"]},b=this.parentThatIsA(BlockMorph).scriptTarget(),c=[];b.parentThatIsA(StageMorph).children.forEach(function(a){a instanceof SpriteMorph&&!a.isTemporary&&a.name!==b.name&&(c=c.concat(a.name))});0<c.length&&(a["~"]=null,c.forEach(function(b){a[b]=b}));return a};
InputSlotMorph.prototype.distancesMenu=function(){var a={"mouse-pointer":["mouse-pointer"]},b=this.parentThatIsA(BlockMorph).scriptTarget(),c=[];b.parentThatIsA(StageMorph).children.forEach(function(a){a instanceof SpriteMorph&&!a.isTemporary&&a.name!==b.name&&(c=c.concat(a.name))});0<c.length&&(a["~"]=null,c.forEach(function(b){a[b]=b}));return a};
InputSlotMorph.prototype.clonablesMenu=function(){var a={},b=this.parentThatIsA(BlockMorph).scriptTarget(),c=b.parentThatIsA(StageMorph),d=[];b instanceof SpriteMorph&&(a.myself=["myself"]);c.children.forEach(function(a){a instanceof SpriteMorph&&!a.isTemporary&&(d=d.concat(a.name))});0<d.length&&(a["~"]=null,d.forEach(function(b){a[b]=b}));return a};
InputSlotMorph.prototype.objectsMenu=function(){var a=this.parentThatIsA(BlockMorph).scriptTarget().parentThatIsA(StageMorph),b={},c=[];b[a.name]=a.name;a.children.forEach(function(a){a instanceof SpriteMorph&&!a.isTemporary&&c.push(a.name)});0<c.length&&(b["~"]=null,c.forEach(function(a){b[a]=a}));return b};
InputSlotMorph.prototype.typesMenu=function(){var a={number:["number"],text:["text"],Boolean:["Boolean"],list:["list"]};SpriteMorph.prototype.enableFirstClass&&(a.sprite=["sprite"]);a.costume=["costume"];a.sound=["sound"];a.command=["command"];a.reporter=["reporter"];a.predicate=["predicate"];return a};
InputSlotMorph.prototype.gettablesMenu=function(){var a={neighbors:["neighbors"],self:["self"],"other sprites":["other sprites"],clones:["clones"],"other clones":["other clones"]};SpriteMorph.prototype.enableNesting&&(a.parts=["parts"],a.anchor=["anchor"]);a.stage=["stage"];StageMorph.prototype.enableInheritance&&(a.children=["children"],a.parent=["parent"],this.world().isDevMode&&(a["temporary?"]=["temporary?"]));a.name=["name"];a.costumes=["costumes"];a.sounds=["sounds"];a["dangling?"]=["dangling?"];
a["rotation x"]=["rotation x"];a["rotation y"]=["rotation y"];a["center x"]=["center x"];a["center y"]=["center y"];return a};
InputSlotMorph.prototype.attributesMenu=function(){var a=this.parentThatIsA(BlockMorph),b=a.inputs()[1].evaluate();a=a.scriptTarget().parentThatIsA(StageMorph);var c={},d=[];a=b===a.name?a:detect(a.children,function(a){return a.name===b});if(!a)return c;c=a instanceof SpriteMorph?{"x position":["x position"],"y position":["y position"],direction:["direction"],"costume #":["costume #"],"costume name":["costume name"],size:["size"]}:{"costume #":["costume #"],"costume name":["costume name"]};d=a.variables.names();
0<d.length&&(c["~"]=null,d.forEach(function(a){c[a]=a}));return c};InputSlotMorph.prototype.costumesMenu=function(){var a=this.parentThatIsA(BlockMorph).scriptTarget(),b=[];var c=a instanceof SpriteMorph?{Turtle:["Turtle"]}:{Empty:["Empty"]};a.costumes.asArray().forEach(function(a){b=b.concat(a.name)});0<b.length&&(c["~"]=null,b.forEach(function(a){c[a]=a}));return c};
InputSlotMorph.prototype.soundsMenu=function(){var a=[],b={};this.parentThatIsA(BlockMorph).scriptTarget().sounds.asArray().forEach(function(b){a=a.concat(b.name)});0<a.length&&a.forEach(function(a){b[a]=a});return b};
InputSlotMorph.prototype.shadowedVariablesMenu=function(){var a=this.parentThatIsA(BlockMorph),b={};if(!a)return b;var c=a.scriptTarget();this.parentThatIsA(RingMorph)?(a=c.variables.names(),a.forEach(function(a){b[a]=a}),a=c.attributes,a.forEach(function(a){b[a]=[a]})):c&&c.exemplar&&(a=c.inheritedVariableNames(!0),a.forEach(function(a){b[a]=a}),a=c.shadowedAttributes(),a.forEach(function(a){b[a]=[a]}));return b};
InputSlotMorph.prototype.pianoKeyboardMenu=function(){var a;if(a=this.parentThatIsA(BlockMorph))var b=a.scriptTarget().instrument;a=new PianoMenuMorph(this.setContents,this,this.fontSize,b);a.popup(this.world(),new Point(this.right()-a.width()/2,this.bottom()));a.selectKey(this.evaluate())};
InputSlotMorph.prototype.setChoices=function(a,b){var c=this.contents();this.choices=a;this.isReadOnly=b||!1;this.parent instanceof BlockMorph&&(this.parent.fixLabelColor(),b||(c.shadowOffset=new Point,c.shadowColor=null,c.setColor(new Color(0,0,0))));this.fixLayout()};
InputSlotMorph.prototype.fixLayout=function(){var a=this.contents(),b=this.arrow();a.isNumeric=this.isNumeric;a.isEditable=!this.isReadOnly;this.isReadOnly?(a.disableSelecting(),a.color=new Color(254,254,254)):(a.enableSelecting(),a.color=new Color(0,0,0));this.choices?(b.setSize(this.fontSize),b.show()):b.hide();var c=b.isVisible?b.width():0;var d=a.height()+2*this.edge;var e=this.isNumeric?a.width()+Math.floor(.5*c)+d+2*this.typeInPadding:Math.max(a.width()+c+2*this.edge+2*this.typeInPadding,a.rawHeight?
a.rawHeight()+c:fontHeight(a.fontSize)/1.3+c,this.minWidth);this.setExtent(new Point(e,d));this.isNumeric?a.setPosition((new Point(Math.floor(d/2),this.edge)).add(new Point(this.typeInPadding,0)).add(this.position())):a.setPosition((new Point(this.edge,this.edge)).add(new Point(this.typeInPadding,0)).add(this.position()));b.isVisible&&b.setPosition(new Point(this.right()-c-this.edge,a.top()));this.parent&&this.parent.fixLayout&&(this.world()?(this.startLayout(),this.parent.fixLayout(),this.endLayout()):
this.parent.fixLayout())};InputSlotMorph.prototype.mouseDownLeft=function(a){this.isReadOnly||this.arrow().bounds.containsPoint(a)?this.escalateEvent("mouseDownLeft",a):((a=this.world())&&a.stopEditing(),this.selectForEdit().contents().edit())};InputSlotMorph.prototype.mouseClickLeft=function(a){this.arrow().bounds.containsPoint(a)?this.dropDownMenu():this.isReadOnly?this.dropDownMenu():this.contents().edit()};
InputSlotMorph.prototype.reactToKeystroke=function(){if(this.constant){var a=this.contents();this.constant=null;a.isItalic=!1;a.drawNew()}};InputSlotMorph.prototype.reactToEdit=function(){this.contents().clearSelection()};InputSlotMorph.prototype.freshTextEdit=function(a){this.onNextStep=function(){a.selectAll()}};
InputSlotMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!StageMorph.prototype.enableCodeMapping)return this.parent.userMenu();this.isNumeric?a.addItem("code number mapping...","mapNumberToCode"):a.addItem("code string mapping...","mapStringToCode");return a};
InputSlotMorph.prototype.mapStringToCode=function(){(new DialogBoxMorph(this,function(a){StageMorph.prototype.codeMappings.string=a},this)).promptCode("Code mapping - String <#1>",StageMorph.prototype.codeMappings.string||"",this.world())};InputSlotMorph.prototype.mapNumberToCode=function(){(new DialogBoxMorph(this,function(a){StageMorph.prototype.codeMappings.number=a},this)).promptCode("Code mapping - Number <#1>",StageMorph.prototype.codeMappings.number||"",this.world())};
InputSlotMorph.prototype.mappedCode=function(){var a=this.parentThatIsA(BlockMorph),b=this.evaluate();if(this.isNumeric)return a=StageMorph.prototype.codeMappings.number||"<#1>",a.replace(/<#1>/g,b);if(!isNaN(parseFloat(b))||!isString(b)||a&&contains(["doSetVar","doChangeVar","doShowVar","doHideVar"],a.selector))return b;a=StageMorph.prototype.codeMappings.string||"<#1>";return a.replace(/<#1>/g,b)};
InputSlotMorph.prototype.evaluate=function(){var a=this.contents();if(this.constant)return this.constant;if(this.isNumeric){var b=parseFloat(a.text||"0");if(!isNaN(b))return b}return a.text};InputSlotMorph.prototype.isEmptySlot=function(){return""===this.contents().text};InputSlotMorph.prototype.flash=function(){this.cachedNormalColor||(this.cachedNormalColor=this.color,this.color=this.activeHighlight,this.drawNew(),this.changed())};
InputSlotMorph.prototype.unflash=function(){if(this.cachedNormalColor){var a=this.cachedNormalColor;this.cachedNormalColor=null;this.color=a;this.drawNew();this.changed()}};
InputSlotMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var a=this.image.getContext("2d");var b=this.cachedNormalColor?this.color:this.parent?this.parent.color:new Color(120,120,120);a.fillStyle=this.color.toString();this.isReadOnly&&!this.cachedNormalColor&&(a.fillStyle=b.darker().toString());this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();this.isNumeric?(b=(this.height()-2*this.edge)/
2,a.beginPath(),a.arc(b+this.edge,b+this.edge,b,radians(90),radians(-90),!1),a.arc(this.width()-b-this.edge,b+this.edge,b,radians(-90),radians(90),!1),a.closePath(),a.fill(),MorphicPreferences.isFlat||this.drawRoundBorder(a)):(a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-2*this.edge),MorphicPreferences.isFlat||this.drawRectBorder(a))};
InputSlotMorph.prototype.drawRectBorder=function(a){var b=.5*this.edge;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.shadowOffsetY=b;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var c=a.createLinearGradient(0,0,0,this.edge);c.addColorStop(0,this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,b);a.lineTo(this.width()-this.edge-b,b);a.stroke();a.shadowOffsetY=0;c=a.createLinearGradient(0,0,this.edge,0);c.addColorStop(0,
this.cachedClr);c.addColorStop(1,this.cachedClrDark);a.strokeStyle=c;a.beginPath();a.moveTo(b,this.edge);a.lineTo(b,this.height()-this.edge-b);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;c=a.createLinearGradient(0,this.height()-this.edge,0,this.height());c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.edge,this.height()-b);a.lineTo(this.width()-this.edge,this.height()-b);a.stroke();c=a.createLinearGradient(this.width()-
this.edge,0,this.width(),0);c.addColorStop(0,this.cachedClrBright);c.addColorStop(1,this.cachedClr);a.strokeStyle=c;a.beginPath();a.moveTo(this.width()-b,this.edge);a.lineTo(this.width()-b,this.height()-this.edge);a.stroke()};
InputSlotMorph.prototype.drawRoundBorder=function(a){var b=.5*this.edge,c=(this.height()-2*this.edge)/2;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var d=c+this.edge;var e=this.width()-c-this.edge;if(e>d){a.shadowOffsetX=b;a.shadowOffsetY=b;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(0,this.cachedClr);f.addColorStop(1,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.moveTo(d,b);a.lineTo(e,b);a.stroke();
a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0}f=a.createLinearGradient(0,this.height()-this.edge,0,this.height());f.addColorStop(0,this.cachedClrBright);f.addColorStop(1,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(c+this.edge,this.height()-b);a.lineTo(this.width()-c-this.edge,this.height()-b);a.stroke();c=this.height()/2;a.shadowOffsetX=b;a.shadowOffsetY=b;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();f=a.createRadialGradient(c,c,c-this.edge,c,c,c);f.addColorStop(1,
this.cachedClr);f.addColorStop(0,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-b,radians(180),radians(270),!1);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;f=a.createRadialGradient(this.width()-c,c,c-this.edge,this.width()-c,c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(this.width()-c,c,c-b,radians(0),radians(90),!1);a.stroke()};TemplateSlotMorph.prototype=new ArgMorph;
TemplateSlotMorph.prototype.constructor=TemplateSlotMorph;TemplateSlotMorph.uber=ArgMorph.prototype;function TemplateSlotMorph(a){this.init(a)}
TemplateSlotMorph.prototype.init=function(a){var b=new ReporterBlockMorph;this.labelString=a||"";b.isDraggable=!1;b.isTemplate=!0;void 0!==modules.objects?(b.color=SpriteMorph.prototype.blockColor.variables,b.category="variables"):(b.color=new Color(243,118,29),b.category=null);b.setSpec(this.labelString);b.selector="reportGetVar";TemplateSlotMorph.uber.init.call(this);this.add(b);this.fixLayout();this.isDraggable=!1;this.isStatic=!0};TemplateSlotMorph.prototype.getSpec=function(){return"%t"};
TemplateSlotMorph.prototype.template=function(){return this.children[0]};TemplateSlotMorph.prototype.contents=function(){return this.template().blockSpec};TemplateSlotMorph.prototype.setContents=function(a){var b=this.template();b.setSpec(a);b.fixBlockColor();b.fixLabelColor()};TemplateSlotMorph.prototype.evaluate=function(){return this.contents()};
TemplateSlotMorph.prototype.fixLayout=function(){var a=this.template();this.setExtent(a.extent().add(2*this.edge+2));a.setPosition(this.position().add(this.edge+1));this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};TemplateSlotMorph.prototype.wantsDropOf=function(a){return"reportGetVar"===a.selector};TemplateSlotMorph.prototype.reactToDropOf=function(a){"reportGetVar"===a.selector&&a.destroy()};
TemplateSlotMorph.prototype.drawNew=function(){this.parent instanceof Morph&&(this.color=this.parent.color.copy());this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawRounded(a)};TemplateSlotMorph.prototype.drawRounded=ReporterBlockMorph.prototype.drawRounded;TemplateSlotMorph.prototype.flash=function(){this.template().flash()};
TemplateSlotMorph.prototype.unflash=function(){this.template().unflash()};BooleanSlotMorph.prototype=new ArgMorph;BooleanSlotMorph.prototype.constructor=BooleanSlotMorph;BooleanSlotMorph.uber=ArgMorph.prototype;BooleanSlotMorph.prototype.isTernary=!0;function BooleanSlotMorph(a){this.init(a)}BooleanSlotMorph.prototype.init=function(a){this.value="boolean"===typeof a?a:null;this.isUnevaluated=!1;BooleanSlotMorph.uber.init.call(this)};
BooleanSlotMorph.prototype.getSpec=function(){return this.isUnevaluated?"%boolUE":"%b"};BooleanSlotMorph.prototype.evaluate=function(){return this.value};BooleanSlotMorph.prototype.isEmptySlot=function(){return null===this.value};BooleanSlotMorph.prototype.isBinary=function(){return!this.isTernary&&isNil(this.parentThatIsA(RingMorph))&&!isNil(this.parentThatIsA(ScriptsMorph))};BooleanSlotMorph.prototype.setContents=function(a,b){this.value="boolean"===typeof a?a:null;b||(this.drawNew(),this.changed())};
BooleanSlotMorph.prototype.toggleValue=function(){var a=this.selectForEdit();if(a!==this)return this.toggleValue.call(a);a=this.parentThatIsA(IDE_Morph);if(this.isStatic||this.isBinary())this.setContents(!this.value,!0);else switch(this.value){case !0:this.value=!1;break;case !1:this.value=null;break;default:this.value=!0}a&&!a.isAnimating?(this.drawNew(),this.changed()):(this.drawNew(3),this.changed(),this.nextSteps([function(){this.drawNew(2);this.changed()},function(){this.drawNew(1);this.changed()},
function(){this.drawNew();this.changed()}]))};BooleanSlotMorph.prototype.mouseClickLeft=function(){this.toggleValue();isNil(this.value)||this.reactToSliderEdit()};BooleanSlotMorph.prototype.mouseEnter=function(){if(!this.isStatic)if(!1!==this.value||this.isBinary())this.drawNew(1),this.changed();else{var a=this.value;this.value=null;this.drawNew(3);this.changed();this.value=a}};BooleanSlotMorph.prototype.mouseLeave=function(){this.isStatic||(this.drawNew(),this.changed())};
BooleanSlotMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!StageMorph.prototype.enableCodeMapping)return this.parent.userMenu();!0===this.evaluate()?a.addItem("code true mapping...","mapTrueToCode"):a.addItem("code false mapping...","mapFalseToCode");return a};
BooleanSlotMorph.prototype.mapTrueToCode=function(){(new DialogBoxMorph(this,function(a){StageMorph.prototype.codeMappings["true"]=a},this)).promptCode("Code mapping - true",StageMorph.prototype.codeMappings["true"]||"true",this.world())};BooleanSlotMorph.prototype.mapFalseToCode=function(){(new DialogBoxMorph(this,function(a){StageMorph.prototype.codeMappings["false"]=a},this)).promptCode("Code mapping - false",StageMorph.prototype.codeMappings["false"]||"false",this.world())};
BooleanSlotMorph.prototype.mappedCode=function(){return!0===this.evaluate()?StageMorph.prototype.codeMappings.boolTrue||"true":StageMorph.prototype.codeMappings.boolFalse||"false"};
BooleanSlotMorph.prototype.drawNew=function(a){var b=this.isStatic?this.textLabel():null;if(b){var c=b.height+3*this.edge;this.silentSetExtent(new Point(b.width+1.5*c+2*this.edge,c))}else this.silentSetExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge));this.cachedNormalColor||(this.color=this.parent?this.parent.color:new Color(200,200,200));this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());
c=this.image.getContext("2d");this.drawDiamond(c,a);this.drawLabel(c,b);this.drawKnob(c,a)};
BooleanSlotMorph.prototype.drawDiamond=function(a,b){var c=this.width(),d=this.height(),e=d/2,f=c/2,g=this.edge/2;if(this.cachedNormalColor)a.fillStyle=this.color.toString();else switch(this.value){case !0:a.fillStyle="rgb(0, 200, 0)";break;case !1:a.fillStyle="rgb(200, 0, 0)";break;default:a.fillStyle=this.color.darker(25).toString()}b&&!this.isEmptySlot()?(a.fillStyle="rgb(0, 200, 0)",a.beginPath(),a.moveTo(0,e),a.lineTo(e,0),a.lineTo(f,0),a.lineTo(f,d),a.lineTo(e,d),a.closePath(),a.fill(),a.fillStyle=
"rgb(200, 0, 0)",a.beginPath(),a.moveTo(f,0),a.lineTo(c-e,0),a.lineTo(c,e),a.lineTo(c-e,d),a.lineTo(f,d)):(a.beginPath(),a.moveTo(0,e),a.lineTo(e,0),a.lineTo(c-e,0),a.lineTo(c,e),a.lineTo(c-e,d),a.lineTo(e,d));a.closePath();a.fill();MorphicPreferences.isFlat||(a.lineWidth=this.edge,a.lineJoin="round",a.lineCap="round",a.shadowOffsetX=g,a.shadowBlur=g,a.shadowColor="black",b=a.createLinearGradient(0,e,.6*this.edge,e+.6*this.edge),b.addColorStop(1,this.cachedClrDark),b.addColorStop(0,this.cachedClr),
a.strokeStyle=b,a.beginPath(),a.moveTo(g,e),a.lineTo(e,g),a.closePath(),a.stroke(),a.shadowOffsetX=0,a.shadowOffsetY=g,a.shadowBlur=this.edge,b=a.createLinearGradient(0,0,0,this.edge),b.addColorStop(1,this.cachedClrDark),b.addColorStop(0,this.cachedClr),a.strokeStyle=b,a.beginPath(),a.moveTo(e,g),a.lineTo(c-e,g),a.closePath(),a.stroke(),a.shadowOffsetY=0,a.shadowBlur=0,b=a.createLinearGradient(c-e-.6*this.edge,d-.6*this.edge,c-e,d),b.addColorStop(1,this.cachedClr),b.addColorStop(0,this.cachedClrBright),
a.strokeStyle=b,a.beginPath(),a.moveTo(c-e,d-g),a.lineTo(c-g,e),a.closePath(),a.stroke(),b=a.createLinearGradient(0,d-this.edge,0,d),b.addColorStop(1,this.cachedClr),b.addColorStop(0,this.cachedClrBright),a.strokeStyle=b,a.beginPath(),a.moveTo(e,d-g),a.lineTo(c-e-g,d-g),a.closePath(),a.stroke())};
BooleanSlotMorph.prototype.drawLabel=function(a,b){var c=this.width(),d=this.height()/2-this.edge,e=d/2,f=this.edge/2,g=this.height()/2;this.isEmptySlot()||(b?(g=(this.height()-b.height)/2,d=this.value?this.height()/2:this.width()-this.height()/2-b.width,MorphicPreferences.isFlat||(a.shadowOffsetX=-f,a.shadowOffsetY=-f,a.shadowBlur=f,a.shadowColor=this.value?"rgb(0, 100, 0)":"rgb(100, 0, 0)"),a.drawImage(b,d,g)):(d=d+2*this.edge+f,MorphicPreferences.isFlat||(a.shadowOffsetX=-f,a.shadowOffsetY=-f,
a.shadowBlur=f,a.shadowColor="rgb(0, 100, 0)"),a.strokeStyle="white",a.lineWidth=this.edge+f,a.lineCap="round",a.lineJoin="miter",a.beginPath(),a.moveTo(d-e,g),a.lineTo(d,g+e),a.lineTo(d+e,e+this.edge),a.stroke(),d=c-g-2*this.edge,MorphicPreferences.isFlat||(a.shadowOffsetX=-f,a.shadowOffsetY=-f,a.shadowBlur=f,a.shadowColor="rgb(100, 0, 0)"),a.strokeStyle="white",a.lineWidth=this.edge,a.lineCap="butt",a.beginPath(),a.moveTo(d-e,g-e),a.lineTo(d+e,g+e),a.moveTo(d-e,g+e),a.lineTo(d+e,g-e),a.stroke()))};
BooleanSlotMorph.prototype.drawKnob=function(a,b){var c=this.width(),d=this.height()/2,e=this.edge/2,f=(this.width()-this.height())/4*(b||0),g=PushButtonMorph.prototype.outline/2,h=PushButtonMorph.prototype.outlineColor,k=PushButtonMorph.prototype.color,l=PushButtonMorph.prototype.contrast,m=k.lighter(l);l=k.darker(l);switch(this.value){case !1:c=d+f;MorphicPreferences.isFlat||(a.shadowOffsetX=e,a.shadowOffsetY=0,a.shadowBlur=e,a.shadowColor="black");break;case !0:c=c-d-f;MorphicPreferences.isFlat||
(a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0);break;default:if(!b)return;c=d;MorphicPreferences.isFlat||(a.shadowOffsetX=e,a.shadowOffsetY=0,a.shadowBlur=e,a.shadowColor="black");a.globalAlpha=.2*((b||0)+1)}a.fillStyle=k.toString();a.beginPath();a.arc(c,d,d,radians(0),radians(360));a.closePath();a.fill();MorphicPreferences.isFlat||(a.shadowOffsetX=0,a.shadowBlur=0,a.shadowColor="black",a.lineWidth=g,a.strokeStyle=h.toString(),a.beginPath(),a.arc(c,d,d-g/2,radians(0),radians(360)),a.stroke(),
b=a.createRadialGradient(c,d,d-g-this.edge,c,d,d-g),b.addColorStop(1,m.toString()),b.addColorStop(0,k.toString()),a.strokeStyle=b,a.lineCap="round",a.lineWidth=this.edge,a.beginPath(),a.arc(c,d,d-g-this.edge/2,radians(180),radians(270),!1),a.stroke(),b=a.createRadialGradient(c,d,d-g-this.edge,c,d,d-g),b.addColorStop(1,l.toString()),b.addColorStop(0,k.toString()),a.strokeStyle=b,a.lineCap="round",a.lineWidth=this.edge,a.beginPath(),a.arc(c,d,d-g-this.edge/2,radians(0),radians(90),!1),a.stroke())};
BooleanSlotMorph.prototype.textLabel=function(){if(this.isEmptySlot())return null;var a=(new StringMorph(localize("true"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255))).image;var b=(new StringMorph(localize("false"),this.fontSize,null,!0,null,null,null,null,new Color(255,255,255))).image;var c=newCanvas(new Point(Math.max(a.width,b.width),Math.max(a.height,b.height)));a=this.value?a:b;b=(c.width-a.width)/2;var d=(c.height-a.height)/2;c.getContext("2d").drawImage(a,b,d);return c};
ArrowMorph.prototype=new Morph;ArrowMorph.prototype.constructor=ArrowMorph;ArrowMorph.uber=Morph.prototype;function ArrowMorph(a,b,c,d){this.init(a,b,c,d)}ArrowMorph.prototype.init=function(a,b,c,d){this.direction=a||"down";this.size=b||(0===b?0:50);this.padding=c||0;ArrowMorph.uber.init.call(this,!0);this.color=d||new Color(0,0,0);this.setExtent(new Point(this.size,this.size))};ArrowMorph.prototype.setSize=function(a){var b=Math.max(a,1);this.size=a;this.setExtent(new Point(b,b))};
ArrowMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var a=this.image.getContext("2d"),b=this.padding,c=this.height(),d=Math.floor(c/2),e=this.width(),f=Math.floor(e/2);a.fillStyle=this.color.toString();a.beginPath();"down"===this.direction?(a.moveTo(b,d),a.lineTo(e-b,d),a.lineTo(f,c-b)):"up"===this.direction?(a.moveTo(b,d),a.lineTo(e-b,d),a.lineTo(f,b)):("left"===this.direction?(a.moveTo(b,d),a.lineTo(f,b)):(a.moveTo(f,b),a.lineTo(e-b,d)),a.lineTo(f,c-b));a.closePath();a.fill()};
TextSlotMorph.prototype=new InputSlotMorph;TextSlotMorph.prototype.constructor=TextSlotMorph;TextSlotMorph.uber=InputSlotMorph.prototype;function TextSlotMorph(a,b,c,d){this.init(a,b,c,d)}
TextSlotMorph.prototype.init=function(a,b,c,d){var e=new TextMorph(""),f=new ArrowMorph("down",0,Math.max(Math.floor(this.fontSize/6),1));e.fontSize=this.fontSize;e.drawNew();this.isUnevaluated=!1;this.choices=c||null;this.oldContentsExtent=e.extent();this.isNumeric=b||!1;this.isReadOnly=d||!1;this.minWidth=0;this.constant=null;InputSlotMorph.uber.init.call(this,null,null,null,null,!0);this.color=new Color(255,255,255);this.add(e);this.add(f);e.isEditable=!0;e.isDraggable=!1;e.enableSelecting();this.setContents(a)};
TextSlotMorph.prototype.getSpec=function(){return this.isNumeric?"%mln":"%mlt"};TextSlotMorph.prototype.contents=function(){return detect(this.children,function(a){return a instanceof TextMorph})};TextSlotMorph.prototype.layoutChanged=function(){this.fixLayout()};ColorSlotMorph.prototype=new ArgMorph;ColorSlotMorph.prototype.constructor=ColorSlotMorph;ColorSlotMorph.uber=ArgMorph.prototype;function ColorSlotMorph(a){this.init(a)}
ColorSlotMorph.prototype.init=function(a){ColorSlotMorph.uber.init.call(this,null,!0);this.setColor(a||new Color(145,26,68))};ColorSlotMorph.prototype.getSpec=function(){return"%clr"};
ColorSlotMorph.prototype.getUserColor=function(){var a=this,b=this.world(),c=b.hand,d=getDocumentPositionOf(b.worldCanvas),e=c.processMouseMove,f=c.processMouseDown,g=c.processMouseUp,h=new ColorPaletteMorph(null,new Point(16*this.fontSize,10*this.fontSize));b.add(h);h.setPosition(this.bottomLeft().add(new Point(0,this.edge)));c.processMouseMove=function(e){var f=b.getGlobalPixelColor(c.position());c.setPosition(new Point(e.pageX-d.x,e.pageY-d.y));f.a&&a.setColor(f)};c.processMouseDown=nop;c.processMouseUp=
function(){h.destroy();c.processMouseMove=e;c.processMouseDown=f;c.processMouseUp=g}};ColorSlotMorph.prototype.mouseClickLeft=function(){this.selectForEdit().getUserColor()};ColorSlotMorph.prototype.evaluate=function(){return this.color};
ColorSlotMorph.prototype.drawNew=function(){var a=this.fontSize+2*this.edge+2*this.typeInPadding;this.silentSetExtent(new Point(a,a));this.image=newCanvas(this.extent());a=this.image.getContext("2d");var b=this.parent?this.parent.color:new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();a.fillRect(this.edge,this.edge,this.width()-2*this.edge,this.height()-
2*this.edge);MorphicPreferences.isFlat||this.drawRectBorder(a)};ColorSlotMorph.prototype.drawRectBorder=InputSlotMorph.prototype.drawRectBorder;BlockHighlightMorph.prototype=new Morph;BlockHighlightMorph.prototype.constructor=BlockHighlightMorph;BlockHighlightMorph.uber=Morph.prototype;function BlockHighlightMorph(){this.threadCount=0;this.init()}BlockHighlightMorph.prototype.readout=function(){return this.children.length?this.children[0]:null};
BlockHighlightMorph.prototype.updateReadout=function(){var a=this.readout(),b=useBlurredShadows&&!MorphicPreferences.isFlat?.4*SyntaxElementMorph.prototype.activeBlur:-2*SyntaxElementMorph.prototype.activeBorder;2>this.threadCount?a&&a.destroy():(a?(a.contents=this.threadCount.toString(),a.fullChanged(),a.drawNew(),a.fullChanged()):(a=new SpeechBubbleMorph(this.threadCount.toString(),this.color,null,null,this.color.darker(),null,1),this.add(a)),a.setPosition(this.position().add(b)))};
MultiArgMorph.prototype=new ArgMorph;MultiArgMorph.prototype.constructor=MultiArgMorph;MultiArgMorph.uber=ArgMorph.prototype;function MultiArgMorph(a,b,c,d,e,f,g,h,k){this.init(a,b,c,d,e,f,g,h,k)}
MultiArgMorph.prototype.init=function(a,b,c,d,e,f,g,h,k){var l=new FrameMorph;this.slotSpec=a||"%s";this.labelText=localize(b||"");this.minInputs=c||0;this.elementSpec=d||null;this.labelColor=f||null;this.shadowColor=g||null;this.shadowOffset=h||null;this.canBeEmpty=!0;MultiArgMorph.uber.init.call(this,null,!0);this.alpha=!1===k?1:0;l.alpha=!1===k?1:0;this.noticesTransparentclick=l.noticesTransparentClick=!0;a=this.labelPart(this.labelText);this.add(a);a.hide();a=new ArrowMorph("left",this.fontSize,
Math.max(Math.floor(this.fontSize/6),1),e);e=new ArrowMorph("right",this.fontSize,Math.max(Math.floor(this.fontSize/6),1),e);l.add(a);l.add(e);l.drawNew();l.acceptsDrops=!1;this.add(l);for(l=0;l<this.minInputs;l+=1)this.addInput()};MultiArgMorph.prototype.label=function(){return this.children[0]};MultiArgMorph.prototype.arrows=function(){return this.children[this.children.length-1]};MultiArgMorph.prototype.getSpec=function(){return"%mult"+this.slotSpec};
MultiArgMorph.prototype.setContents=function(a){var b=this.inputs(),c;for(c=0;c<a.length;c+=1)null!==a[c]&&b[c]&&b[c].setContents(a[c])};MultiArgMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};MultiArgMorph.prototype.show=function(){this.isVisible=!0;this.changed()};MultiArgMorph.prototype.setLabelColor=function(a,b,c){this.textColor=a;this.shadowColor=b;this.shadowOffset=c;MultiArgMorph.uber.setLabelColor.call(this,a,b,c)};
MultiArgMorph.prototype.fixLayout=function(){"%t"===this.slotSpec&&(this.isStatic=!0);if(this.parent){var a=this.label();this.color=this.parent.color;var b=this.shadowColor||this.parent.color.darker(this.labelContrast);var c=this.shadowOffset||a.shadowOffset;this.arrows().color=this.color;""===this.labelText||a.shadowColor.eq(b)||(a.shadowColor=b,a.shadowOffset=c,a.drawNew())}this.fixArrowsLayout();MultiArgMorph.uber.fixLayout.call(this);this.parent&&this.parent.fixLayout()};
MultiArgMorph.prototype.fixArrowsLayout=function(){var a=this.label(),b=this.arrows(),c=b.children[0],d=b.children[1],e=new Point(d.width()/2,d.height());this.inputs().length<this.minInputs+1?(a.hide(),c.hide(),d.setPosition(b.position().subtract(new Point(e.x,0))),b.setExtent(e)):(""!==this.labelText&&a.show(),c.show(),d.setPosition(c.topCenter()),b.bounds.corner=d.bottomRight().copy());b.drawNew()};MultiArgMorph.prototype.refresh=function(){this.inputs().forEach(function(a){a.drawNew()})};
MultiArgMorph.prototype.drawNew=function(){MultiArgMorph.uber.drawNew.call(this);this.refresh()};
MultiArgMorph.prototype.addInput=function(a){var b=this.labelPart(this.slotSpec),c=this.children.length-1;if(a)b.setContents(a);else if("%scriptVars"===this.elementSpec||"%blockVars"===this.elementSpec){var d="";for(a=c;0<a;)d=String.fromCharCode(97+(a-1)%26)+d,a=Math.floor((a-1)/26);b.setContents(d)}else contains(["%parms","%ringparms"],this.elementSpec)&&b.setContents("#"+c);b.parent=this;this.children.splice(c,0,b);b.drawNew();this.fixLayout()};
MultiArgMorph.prototype.removeInput=function(){var a;if(1<this.children.length){var b=this.children[this.children.length-2];this.removeChild(b);b instanceof BlockMorph&&(a=this.parentThatIsA(ScriptsMorph))&&a.add(b)}this.fixLayout()};
MultiArgMorph.prototype.mouseClickLeft=function(a){if(this.parentThatIsA(ScriptsMorph)){var b=this.selectForEdit(),c=b.arrows(),d=c.children[0];c=c.children[1];var e=16===b.world().currentKey?3:1;b.startLayout();if(c.bounds.containsPoint(a))for(a=0;a<e;a+=1)c.isVisible&&b.addInput();else if(d.bounds.containsPoint(a))for(a=0;a<e;a+=1)d.isVisible&&b.removeInput();else b.escalateEvent("mouseClickLeft",a);b.endLayout()}else this.escalateEvent("mouseClickLeft",a)};
MultiArgMorph.prototype.userMenu=function(){var a=new MenuMorph(this),b=this.parentThatIsA(BlockMorph),c="",d=this;if(!StageMorph.prototype.enableCodeMapping)return this.parent.userMenu();b&&(b instanceof RingMorph?c="parms_":"doDeclareVariables"===b.selector&&(c="tempvars_"));a.addItem("code list mapping...",function(){d.mapCodeList(c)});a.addItem("code item mapping...",function(){d.mapCodeItem(c)});a.addItem("code delimiter mapping...",function(){d.mapCodeDelimiter(c)});return a};
MultiArgMorph.prototype.mapCodeDelimiter=function(a){this.mapToCode(a+"delim","list item delimiter")};MultiArgMorph.prototype.mapCodeList=function(a){this.mapToCode(a+"list","list contents <#1>")};MultiArgMorph.prototype.mapCodeItem=function(a){this.mapToCode(a+"item","list item <#1>")};MultiArgMorph.prototype.mapToCode=function(a,b){(new DialogBoxMorph(this,function(b){StageMorph.prototype.codeMappings[a]=b},this)).promptCode("Code mapping - "+b,StageMorph.prototype.codeMappings[a]||"",this.world())};
MultiArgMorph.prototype.mappedCode=function(a){var b=this.parentThatIsA(BlockMorph),c="",d="",e=0,f=[];b&&(b instanceof RingMorph?c="parms_":"doDeclareVariables"===b.selector&&(c="tempvars_"));b=StageMorph.prototype.codeMappings[c+"list"]||"<#1>";var g=StageMorph.prototype.codeMappings[c+"item"]||"<#1>";var h=StageMorph.prototype.codeMappings[c+"delim"]||" ";this.inputs().forEach(function(b){f.push(g.replace(/<#1>/g,b.mappedCode(a)))});f.forEach(function(a){e&&(d+=h);d+=a;e+=1});return b=b.replace(/<#1>/g,
d)};MultiArgMorph.prototype.evaluate=function(){var a=[];this.inputs().forEach(function(b){a.push(b.evaluate())});return a};MultiArgMorph.prototype.isEmptySlot=function(){return this.canBeEmpty?0===this.inputs().length:!1};ArgLabelMorph.prototype=new ArgMorph;ArgLabelMorph.prototype.constructor=ArgLabelMorph;ArgLabelMorph.uber=ArgMorph.prototype;function ArgLabelMorph(a,b){this.init(a,b)}
ArgLabelMorph.prototype.init=function(a,b){this.labelText=localize(b||"input list:");ArgLabelMorph.uber.init.call(this,null,!0);this.isStatic=!0;this.alpha=0;this.noticesTransparentclick=!0;b=this.labelPart(this.labelText);this.add(b);this.add(a)};ArgLabelMorph.prototype.label=function(){return this.children[0]};ArgLabelMorph.prototype.argMorph=function(){return this.children[1]};
ArgLabelMorph.prototype.fixLayout=function(){var a=this.label();if(this.parent){this.color=this.parent.color;var b=a.shadowOffset||new Point;var c=0>b.x?this.parent.color.darker(this.labelContrast):this.parent.color.lighter(this.labelContrast);""===this.labelText||a.shadowColor.eq(c)||(a.shadowColor=c,a.shadowOffset=b,a.drawNew())}ArgLabelMorph.uber.fixLayout.call(this);this.parent&&this.parent.fixLayout()};ArgLabelMorph.prototype.refresh=function(){this.inputs().forEach(function(a){a.drawNew()})};
ArgLabelMorph.prototype.drawNew=function(){ArgLabelMorph.uber.drawNew.call(this);this.refresh()};ArgLabelMorph.prototype.setLabelColor=function(a,b,c){if(""!==this.labelText){var d=this.label();d.color=a;d.shadowColor=b;d.shadowOffset=c;d.drawNew()}};ArgLabelMorph.prototype.reactToGrabOf=function(){this.parent instanceof SyntaxElementMorph&&this.parent.revertToDefaultInput(this)};ArgLabelMorph.prototype.evaluate=function(){return this.argMorph().evaluate()};ArgLabelMorph.prototype.isEmptySlot=function(){return!1};
FunctionSlotMorph.prototype=new ArgMorph;FunctionSlotMorph.prototype.constructor=FunctionSlotMorph;FunctionSlotMorph.uber=ArgMorph.prototype;function FunctionSlotMorph(a){this.init(a)}FunctionSlotMorph.prototype.init=function(a,b){FunctionSlotMorph.uber.init.call(this,null,!0);this.isPredicate=a||!1;this.color=this.rfColor;this.setExtent(new Point(2*(this.fontSize+2*this.edge),this.fontSize+2*this.edge),b)};FunctionSlotMorph.prototype.getSpec=function(){return"%f"};
FunctionSlotMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var a=this.image.getContext("2d");var b=this.parent?this.parent.color:new Color(120,120,120);this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();this.isPredicate?this.drawDiamond(a):this.drawRounded(a)};
FunctionSlotMorph.prototype.drawRounded=function(a){var b=this.height(),c=Math.min(this.rounding,b/2),d=this.width(),e=this.edge/2;a.fillStyle=this.color.toString();a.beginPath();a.arc(c,c,c,radians(-180),radians(-90),!1);a.arc(d-c,c,c,radians(-90),radians(-0),!1);a.arc(d-c,b-c,c,radians(0),radians(90),!1);a.arc(c,b-c,c,radians(90),radians(180),!1);a.closePath();a.fill();if(!MorphicPreferences.isFlat){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();
a.arc(c,b-c,c-e,radians(90),radians(180),!1);a.stroke();a.strokeStyle=this.cachedClr;a.beginPath();a.arc(d-c,c,c-e,radians(-90),radians(0),!1);a.stroke();a.shadowOffsetX=e;a.shadowOffsetY=e;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,e);a.lineTo(d-c+e,e);a.stroke();f=a.createRadialGradient(c,c,c-this.edge,c,c,c);f.addColorStop(1,
this.cachedClr);f.addColorStop(0,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-e,radians(180),radians(270),!1);a.stroke();f=a.createLinearGradient(0,0,this.edge,0);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(e,c);a.lineTo(e,b-c);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;f=a.createRadialGradient(d-c,b-c,c-this.edge,d-c,b-c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=
f;a.beginPath();a.arc(d-c,b-c,c-e,radians(0),radians(90),!1);a.stroke();f=a.createLinearGradient(0,b-this.edge,0,b);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,b-e);a.lineTo(d-c+e,b-e);a.stroke();f=a.createLinearGradient(d-this.edge,0,d,0);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(d-e,c+e);a.lineTo(d-e,b-c);a.stroke()}};
FunctionSlotMorph.prototype.drawDiamond=function(a){var b=this.width(),c=this.height(),d=Math.floor(c/2),e=Math.min(this.rounding,d),f=this.edge/2;a.fillStyle=this.color.toString();a.beginPath();a.moveTo(0,d);a.lineTo(e,0);a.lineTo(b-e,0);a.lineTo(b,d);a.lineTo(b-e,c);a.lineTo(e,c);a.closePath();a.fill();if(!MorphicPreferences.isFlat){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();a.moveTo(f,d);a.lineTo(e,c-f);a.stroke();a.strokeStyle=this.cachedClr;
a.beginPath();a.moveTo(b-f,d);a.lineTo(b-e,f);a.stroke();a.shadowOffsetX=f;a.shadowOffsetY=f;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var g=a.createLinearGradient(0,0,e,0);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(f,d);a.lineTo(e,f);a.stroke();g=a.createLinearGradient(0,0,0,this.edge);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(e,f);a.lineTo(b-
e,f);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;g=a.createLinearGradient(b-e,0,b,0);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(b-e,c-f);a.lineTo(b-f,d);a.stroke();g=a.createLinearGradient(0,c-this.edge,0,c);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(e+f,c-f);a.lineTo(b-e-f,c-f);a.stroke()}};ReporterSlotMorph.prototype=new FunctionSlotMorph;
ReporterSlotMorph.prototype.constructor=ReporterSlotMorph;ReporterSlotMorph.uber=FunctionSlotMorph.prototype;function ReporterSlotMorph(a){this.init(a)}ReporterSlotMorph.prototype.init=function(a){ReporterSlotMorph.uber.init.call(this,a,!0);this.add(this.emptySlot());this.fixLayout()};ReporterSlotMorph.prototype.emptySlot=function(){var a=new ArgMorph,b=2*this.rfBorder+2*this.edge;a.color=this.rfColor;a.alpha=0;a.setExtent(new Point(2*(this.fontSize+2*this.edge)-b,this.fontSize+2*this.edge-b));return a};
ReporterSlotMorph.prototype.getSpec=function(){return"%r"};ReporterSlotMorph.prototype.contents=function(){return this.children[0]};ReporterSlotMorph.prototype.nestedBlock=function(){var a=this.contents();return a instanceof ReporterBlockMorph?a:null};ReporterSlotMorph.prototype.evaluate=function(){return this.nestedBlock()};ReporterSlotMorph.prototype.isEmptySlot=function(){return null===this.nestedBlock()};
ReporterSlotMorph.prototype.fixLayout=function(){var a=this.contents();this.setExtent(a.extent().add(2*this.edge+2*this.rfBorder));a.setCenter(this.center());this.parent&&this.parent.fixLayout&&this.parent.fixLayout()};RingReporterSlotMorph.prototype=new ReporterSlotMorph;RingReporterSlotMorph.prototype.constructor=RingReporterSlotMorph;RingReporterSlotMorph.uber=ReporterSlotMorph.prototype;RingReporterSlotMorph.prototype.rfBorder=RingCommandSlotMorph.prototype.rfBorder;
RingReporterSlotMorph.prototype.edge=RingCommandSlotMorph.prototype.edge;function RingReporterSlotMorph(a){this.init(a)}RingReporterSlotMorph.prototype.init=function(a){RingReporterSlotMorph.uber.init.call(this,a,!0);this.alpha=RingMorph.prototype.alpha;this.contrast=RingMorph.prototype.contrast;this.isHole=!0};RingReporterSlotMorph.prototype.getSpec=function(){return"%rr"};
RingReporterSlotMorph.prototype.replaceInput=function(a,b){RingReporterSlotMorph.uber.replaceInput.call(this,a,b);this.parent instanceof RingMorph&&this.parent.vanishForSimilar()};
RingReporterSlotMorph.prototype.drawRounded=function(a){var b=this.height(),c=Math.min(this.rounding,b/2),d=this.width(),e=this.edge/2;a.fillStyle=this.cachedClr;a.beginPath();a.moveTo(0,b/2);a.arc(c,c,c,radians(-180),radians(-90),!1);a.arc(d-c,c,c,radians(-90),radians(-0),!1);a.lineTo(d,b/2);a.lineTo(d,0);a.lineTo(0,0);a.closePath();a.fill();a.beginPath();a.moveTo(d,b/2);a.arc(d-c,b-c,c,radians(0),radians(90),!1);a.arc(c,b-c,c,radians(90),radians(180),!1);a.lineTo(0,b/2);a.lineTo(0,b);a.lineTo(d,
b);a.closePath();a.fill();if(!MorphicPreferences.isFlat){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=this.cachedClr;a.beginPath();a.arc(c,b-c,c-e,radians(90),radians(180),!1);a.stroke();a.strokeStyle=this.cachedClr;a.beginPath();a.arc(d-c,c,c-e,radians(-90),radians(0),!1);a.stroke();a.shadowOffsetX=e;a.shadowOffsetY=e;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var f=a.createLinearGradient(0,0,0,this.edge);f.addColorStop(1,this.cachedClrDark);
f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,e);a.lineTo(d-c+e,e);a.stroke();f=a.createRadialGradient(c,c,c-this.edge,c,c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrDark);a.strokeStyle=f;a.beginPath();a.arc(c,c,c-e,radians(180),radians(270),!1);a.stroke();f=a.createLinearGradient(0,0,this.edge,0);f.addColorStop(1,this.cachedClrDark);f.addColorStop(0,this.cachedClr);a.strokeStyle=f;a.beginPath();a.moveTo(e,c);a.lineTo(e,b-c);a.stroke();a.shadowOffsetX=
0;a.shadowOffsetY=0;a.shadowBlur=0;f=a.createRadialGradient(d-c,b-c,c-this.edge,d-c,b-c,c);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.arc(d-c,b-c,c-e,radians(0),radians(90),!1);a.stroke();f=a.createLinearGradient(0,b-this.edge,0,b);f.addColorStop(1,this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(c-e,b-e);a.lineTo(d-c+e,b-e);a.stroke();f=a.createLinearGradient(d-this.edge,0,d,0);f.addColorStop(1,
this.cachedClr);f.addColorStop(0,this.cachedClrBright);a.strokeStyle=f;a.beginPath();a.moveTo(d-e,c+e);a.lineTo(d-e,b-c);a.stroke()}};
RingReporterSlotMorph.prototype.drawDiamond=function(a){var b=this.width(),c=this.height(),d=Math.floor(c/2),e=Math.min(this.rounding,d),f=this.edge/2;a.fillStyle=this.cachedClr;a.beginPath();a.moveTo(0,0);a.lineTo(0,d);a.lineTo(e,0);a.lineTo(b-e,0);a.lineTo(b,d);a.lineTo(b,0);a.closePath();a.fill();a.moveTo(b,d);a.lineTo(b-e,c);a.lineTo(e,c);a.lineTo(0,d);a.lineTo(0,c);a.lineTo(b,c);a.closePath();a.fill();if(!MorphicPreferences.isFlat){a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";a.strokeStyle=
this.cachedClr;a.beginPath();a.moveTo(f,d);a.lineTo(e,c-f);a.stroke();a.strokeStyle=this.cachedClr;a.beginPath();a.moveTo(b-f,d);a.lineTo(b-e,f);a.stroke();a.shadowOffsetX=f;a.shadowOffsetY=f;a.shadowBlur=this.edge;a.shadowColor=this.color.darker(80).toString();var g=a.createLinearGradient(0,0,e,0);g.addColorStop(1,this.cachedClrDark);g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(f,d);a.lineTo(e,f);a.stroke();g=a.createLinearGradient(0,0,0,this.edge);g.addColorStop(1,this.cachedClrDark);
g.addColorStop(0,this.cachedClr);a.strokeStyle=g;a.beginPath();a.moveTo(e,f);a.lineTo(b-e,f);a.stroke();a.shadowOffsetX=0;a.shadowOffsetY=0;a.shadowBlur=0;g=a.createLinearGradient(b-e,0,b,0);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(b-e,c-f);a.lineTo(b-f,d);a.stroke();g=a.createLinearGradient(0,c-this.edge,0,c);g.addColorStop(1,this.cachedClr);g.addColorStop(0,this.cachedClrBright);a.strokeStyle=g;a.beginPath();a.moveTo(e+f,c-f);
a.lineTo(b-e-f,c-f);a.stroke()}};CommentMorph.prototype=new BoxMorph;CommentMorph.prototype.constructor=CommentMorph;CommentMorph.uber=BoxMorph.prototype;CommentMorph.prototype.refreshScale=function(){CommentMorph.prototype.fontSize=SyntaxElementMorph.prototype.fontSize;CommentMorph.prototype.padding=5*SyntaxElementMorph.prototype.scale;CommentMorph.prototype.rounding=8*SyntaxElementMorph.prototype.scale};CommentMorph.prototype.refreshScale();function CommentMorph(a){this.init(a)}
CommentMorph.prototype.init=function(a){var b=this,c=SyntaxElementMorph.prototype.scale;this.stickyOffset=this.block=null;this.isCollapsed=!1;this.titleBar=new BoxMorph(this.rounding,1.000001*c,new Color(255,255,180));this.titleBar.color=new Color(255,255,180);this.titleBar.setHeight(fontHeight(this.fontSize)+this.padding);this.title=null;this.arrow=new ArrowMorph("down",this.fontSize);this.arrow.noticesTransparentClick=!0;this.arrow.mouseClickLeft=function(){b.toggleExpand()};this.contents=new TextMorph(a||
localize("add comment here..."),this.fontSize);this.contents.isEditable=!0;this.contents.enableSelecting();this.contents.maxWidth=90*c;this.contents.drawNew();this.handle=new HandleMorph(this.contents,80,2*this.fontSize,-2,-2);this.handle.setExtent(new Point(11*c,11*c));this.anchor=null;CommentMorph.uber.init.call(this,this.rounding,1.000001*c,new Color(255,255,180));this.color=new Color(255,255,220);this.isDraggable=!0;this.add(this.titleBar);this.add(this.arrow);this.add(this.contents);this.add(this.handle);
this.fixLayout()};CommentMorph.prototype.fullCopy=function(){var a=new CommentMorph(this.contents.text);a.isCollapsed=this.isCollapsed;a.setTextWidth(this.textWidth());this.selectionID&&(a.selectionID=!0);return a};CommentMorph.prototype.setTextWidth=function(a){this.contents.maxWidth=a;this.contents.drawNew();this.fixLayout()};CommentMorph.prototype.textWidth=function(){return this.contents.maxWidth};CommentMorph.prototype.text=function(){return this.contents.text};
CommentMorph.prototype.toggleExpand=function(){this.isCollapsed=!this.isCollapsed;this.fixLayout();this.align()};CommentMorph.prototype.layoutChanged=function(){this.fixLayout();this.align()};
CommentMorph.prototype.fixLayout=function(){var a=this.contents.width()+2*this.padding,b=this,c=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.title&&(this.title.destroy(),this.title=null);if(this.isCollapsed){this.contents.hide();this.title=new FrameMorph;this.title.alpha=0;this.title.acceptsDrops=!1;var d=new StringMorph(this.contents.text,this.fontSize,null,!0);d.rootForGrab=function(){return b};this.title.add(d);this.title.setHeight(d.height());this.title.setWidth(a-this.arrow.width()-
2*this.padding-this.rounding);this.add(this.title)}else this.contents.show();this.titleBar.setWidth(a);this.contents.setLeft(this.titleBar.left()+this.padding);this.contents.setTop(this.titleBar.bottom()+this.padding);this.arrow.direction=this.isCollapsed?"right":"down";this.arrow.drawNew();this.arrow.setCenter(this.titleBar.center());this.arrow.setLeft(this.titleBar.left()+this.padding);this.title&&this.title.setPosition(this.arrow.topRight().add(new Point(this.padding,0)));Morph.prototype.trackChanges=
c;this.changed();this.silentSetHeight(this.titleBar.height()+(this.isCollapsed?0:this.padding+this.contents.height()+this.padding));this.silentSetWidth(this.titleBar.width());this.drawNew();this.handle.drawNew();this.changed()};
CommentMorph.prototype.userMenu=function(){var a=new MenuMorph(this),b=this;a.addItem("duplicate",function(){b.fullCopy().pickUp(b.world())},"make a copy\nand pick it up");a.addItem("delete","userDestroy");a.addItem("comment pic...",function(){var a=b.parentThatIsA(IDE_Morph);a.saveCanvasAs(b.fullImageClassic(),(a.projectName||localize("untitled"))+" "+localize("comment pic"))},"open a new window\nwith a picture of this comment");return a};CommentMorph.prototype.userDestroy=function(){this.selectForEdit().destroy()};
CommentMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};CommentMorph.prototype.show=function(){this.isVisible=!0;this.changed()};CommentMorph.prototype.prepareToBeGrabbed=function(a){this.block&&(this.block=this.block.comment=null);this.anchor&&(this.anchor.destroy(),this.anchor=null,this.removeShadow(),this.addShadow())};CommentMorph.prototype.selectForEdit=SyntaxElementMorph.prototype.selectForEdit;
CommentMorph.prototype.snap=function(a){var b=this.parent;if(!(b instanceof ScriptsMorph))return null;b.clearDropInfo();var c=b.closestBlock(this,a);null!==c&&(c.comment=this,this.block=c,this.snapSound&&this.snapSound.play(),b.lastDropTarget={element:c});this.align();b.lastDroppedBlock=this;a&&b.recordDrop(a.grabOrigin)};
CommentMorph.prototype.align=function(a,b){if(this.block){var c=a||this.block.topBlock();a=c.parentThatIsA(ScriptsMorph);this.setTop(this.block.top()+this.block.corner);var d=this.top();var e=this.bottom();c=c.allChildren().filter(function(a){return a instanceof BlockMorph&&a.bottom()>d&&a.top()<e});c=Math.max.apply(null,c.map(function(a){return a.right()}));this.setLeft(c+5);!b&&a&&a.addBack(this);this.anchor||(this.anchor=new Morph,this.anchor.color=this.titleBar.color);this.anchor.silentSetPosition(new Point(this.block.right(),
this.top()+this.edge));this.anchor.bounds.corner=new Point(this.left(),this.top()+this.edge+1);this.anchor.drawNew();this.addBack(this.anchor);this.anchor.changed()}};CommentMorph.prototype.startFollowing=function(a,b){this.align(a);b.add(this);this.addShadow();this.stickyOffset=this.position().subtract(this.block.position());this.step=function(){this.block?this.setPosition(this.block.position().add(this.stickyOffset)):this.stopFollowing()}};
CommentMorph.prototype.stopFollowing=function(){this.removeShadow();delete this.step};CommentMorph.prototype.destroy=function(){this.block&&(this.block.comment=null);CommentMorph.uber.destroy.call(this)};CommentMorph.prototype.stackHeight=function(){return this.height()};ScriptFocusMorph.prototype=new BoxMorph;ScriptFocusMorph.prototype.constructor=ScriptFocusMorph;ScriptFocusMorph.uber=BoxMorph.prototype;function ScriptFocusMorph(a,b,c){this.init(a,b,c)}
ScriptFocusMorph.prototype.init=function(a,b,c){this.editor=a;this.element=b;this.atEnd=!1;ScriptFocusMorph.uber.init.call(this);this.element instanceof ScriptsMorph&&this.setPosition(c)};ScriptFocusMorph.prototype.getFocus=function(a){a||(a=this.world());a&&a.keyboardReceiver!==this&&a.stopEditing();a.keyboardReceiver=this;this.fixLayout();this.editor.updateToolbar()};
ScriptFocusMorph.prototype.fixLayout=function(){this.changed();this.element instanceof CommandBlockMorph||this.element instanceof CommandSlotMorph||this.element instanceof ScriptsMorph?this.manifestStatement():this.manifestExpression();this.editor.add(this);this.scrollIntoView();this.changed()};
ScriptFocusMorph.prototype.manifestStatement=function(){var a=this.element instanceof ScriptsMorph,b=this.element.top();this.edge=this.border=0;this.alpha=1;this.color=this.editor.feedbackColor;this.setExtent(new Point(a?SyntaxElementMorph.prototype.hatWidth:this.element.width(),Math.max(SyntaxElementMorph.prototype.corner,SyntaxElementMorph.prototype.feedbackMinHeight)));this.element instanceof CommandSlotMorph?b+=SyntaxElementMorph.prototype.corner:this.atEnd&&(b=this.element.bottom());a||this.setPosition(new Point(this.element.left(),
b));this.fps=2;this.show();this.step=function(){this.toggleVisibility()}};
ScriptFocusMorph.prototype.manifestExpression=function(){this.edge=SyntaxElementMorph.prototype.rounding;this.border=Math.max(SyntaxElementMorph.prototype.edge,3);this.color=this.editor.feedbackColor.copy();this.color.a=.5;this.borderColor=this.editor.feedbackColor;this.bounds=this.element.fullBounds().expandBy(Math.max(2*SyntaxElementMorph.prototype.edge,SyntaxElementMorph.prototype.reporterDropFeedbackPadding));this.drawNew();delete this.fps;delete this.step;this.show()};
ScriptFocusMorph.prototype.trigger=function(){var a=this.element;a instanceof MultiArgMorph?a.arrows().children[1].isVisible&&(a.addInput(),this.fixLayout()):a.parent instanceof TemplateSlotMorph?a.mouseClickLeft():a instanceof BooleanSlotMorph?a.toggleValue():a instanceof InputSlotMorph&&(a.isReadOnly?a.choices&&(a.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):(delete this.fps,delete this.step,this.hide(),this.world().onNextStep=function(){a.contents().edit();a.contents().selectAll()}))};
ScriptFocusMorph.prototype.menu=function(){var a=this.element;a instanceof InputSlotMorph&&a.choices?(a.dropDownMenu(!0),delete this.fps,delete this.step,this.hide()):this.insertVariableGetter()};
ScriptFocusMorph.prototype.deleteLastElement=function(){var a=this.element;if(a.parent instanceof ScriptsMorph){if(this.atEnd||a instanceof ReporterBlockMorph)a.destroy(),this.element=this.editor,this.atEnd=!1}else a instanceof MultiArgMorph?a.arrows().children[0].isVisible&&a.removeInput():a instanceof BooleanSlotMorph?a.isStatic||a.setContents(null):a instanceof ReporterBlockMorph?a.isTemplate||(this.lastElement(),a.prepareToBeGrabbed(),a.destroy()):a instanceof CommandBlockMorph&&(this.atEnd?(this.element=
a.parent,a.userDestroy()):a.parent instanceof CommandBlockMorph&&a.parent.userDestroy());this.editor.adjustBounds();this.fixLayout()};
ScriptFocusMorph.prototype.insertBlock=function(a){a.isTemplate=!1;a.isDraggable=!0;a.snapSound&&a.snapSound.play();if(this.element instanceof ScriptsMorph)this.editor.add(a),this.element=a,a instanceof CommandBlockMorph?(a.setLeft(this.left()),a.isStop()?a.setTop(this.top()):(a.setBottom(this.top()),this.atEnd=!0)):(a.setCenter(this.center()),a.setLeft(this.left()));else if(this.element instanceof CommandBlockMorph)if(this.atEnd)this.element.nextBlock(a),this.element=a,this.fixLayout();else{var b=
this.element.parent;b instanceof ScriptsMorph?(a.setLeft(this.element.left()),a.setBottom(this.element.top()+this.element.corner),this.editor.add(a),a.nextBlock(this.element),this.fixLayout()):b instanceof CommandSlotMorph?b.nestedBlock(a):b instanceof CommandBlockMorph&&b.nextBlock(a)}else this.element instanceof CommandSlotMorph?(this.element.nestedBlock(a),this.element=a,this.atEnd=!0):(b=this.element.parent,b instanceof ScriptsMorph?(this.editor.add(a),a.setPosition(this.element.position()),this.element.destroy()):
b.replaceInput(this.element,a),this.element=a);a.fixBlockColor();this.editor.adjustBounds();this.fixLayout();"receiveCondition"===a.selector&&(b=this.editor.scriptTarget())&&(b=b.parentThatIsA(StageMorph))&&(b.enableCustomHatBlocks=!0,b.threads.pauseCustomHatBlocks=!1,(b=b.parentThatIsA(IDE_Morph))&&b.controlBar.stopButton.refresh());a.inputs&&a.inputs().length&&(this.element=a,this.atEnd=!1,this.nextElement())};
ScriptFocusMorph.prototype.insertVariableGetter=function(){var a=this.blockTypes(),b=this,c=new MenuMorph;a&&contains(a,"reporter")&&(a=InputSlotMorph.prototype.getVarNamesDict.call(this.element),Object.keys(a).forEach(function(a){var d=SpriteMorph.prototype.variableBlock(a);d.addShadow(new Point(3,3));c.addItem(d,function(){d.removeShadow();b.insertBlock(d)})}),0<c.items.length&&(c.popup(this.world(),this.element.bottomLeft()),c.getFocus()))};
ScriptFocusMorph.prototype.stopEditing=function(){this.editor.focus=null;this.editor.updateToolbar();this.world().keyboardReceiver=null;this.destroy()};
ScriptFocusMorph.prototype.lastElement=function(){var a=this.items();if(a.length){if(this.atEnd)this.element=a[a.length-1],this.atEnd=!1;else{var b=a.indexOf(this.element)-1;0>b&&(b=a.length-1);this.element=a[b]}this.element instanceof CommandSlotMorph&&this.element.nestedBlock()?this.lastElement():this.element instanceof HatBlockMorph&&(1<a.length?this.lastElement():this.atEnd=!0);this.fixLayout()}else this.shiftScript(new Point(-50,0))};
ScriptFocusMorph.prototype.nextElement=function(){var a=this.items();if(a.length){var b=a.indexOf(this.element)+1;b>=a.length&&(b=0);this.atEnd=!1;this.element=a[b];if(this.element instanceof CommandSlotMorph){if(a=this.element.nestedBlock())this.element=a}else this.element instanceof HatBlockMorph&&(1===a.length?this.atEnd=!0:this.nextElement());this.fixLayout()}else this.shiftScript(new Point(50,0))};
ScriptFocusMorph.prototype.lastCommand=function(){var a=this.element.parentThatIsA(CommandBlockMorph),b;if(a){if(this.element instanceof CommandBlockMorph)if(this.atEnd)this.atEnd=!1;else if(b=a.parent.parentThatIsA(CommandBlockMorph))this.element=b;else{if(b=a.topBlock().bottomBlock())this.element=b,this.atEnd=!0}else this.element=a,this.atEnd=!1;this.element instanceof HatBlockMorph&&!this.atEnd&&this.lastCommand();this.fixLayout()}else this.element instanceof ScriptsMorph&&this.shiftScript(new Point(0,
-50))};
ScriptFocusMorph.prototype.nextCommand=function(){var a=this.element,b;if(a instanceof ScriptsMorph)this.shiftScript(new Point(0,50));else{for(;!(a instanceof CommandBlockMorph);)if(a=a.parent,a instanceof ScriptsMorph)return;if(this.atEnd)if(b=a.parentThatIsA(CommandSlotMorph))this.element=b.parentThatIsA(CommandBlockMorph),this.atEnd=!1,this.nextCommand();else{if(a=a.topBlock().parentThatIsA(CommandBlockMorph))this.element=a,this.atEnd=!1,this.element instanceof HatBlockMorph&&this.nextCommand()}else(b=a.nextBlock())?
this.element=b:(this.element=a,this.atEnd=!0);this.fixLayout()}};ScriptFocusMorph.prototype.nextScript=function(){var a=this.sortedScripts();if(!(1>a.length)){this.element instanceof ScriptsMorph&&(this.element=a[0]);var b=a.indexOf(this.element.topBlock())+1;b>=a.length&&(b=0);this.element=a[b];this.element.scrollIntoView();this.atEnd=!1;if(this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}};
ScriptFocusMorph.prototype.lastScript=function(){var a=this.sortedScripts();if(!(1>a.length)){this.element instanceof ScriptsMorph&&(this.element=a[0]);var b=a.indexOf(this.element.topBlock())-1;0>b&&(b=a.length-1);this.element=a[b];this.element.scrollIntoView();this.atEnd=!1;if(this.element instanceof HatBlockMorph)return this.nextElement();this.fixLayout()}};
ScriptFocusMorph.prototype.shiftScript=function(a){if(this.element instanceof ScriptsMorph)this.moveBy(a);else{var b=this.element.topBlock();!b||b instanceof PrototypeHatBlockMorph||b.moveBy(a)}this.editor.adjustBounds();this.fixLayout()};ScriptFocusMorph.prototype.newScript=function(){var a=this.position();this.element instanceof ScriptsMorph||(a=this.element.topBlock().fullBounds().bottomLeft().add(new Point(0,50)));this.setPosition(a);this.element=this.editor;this.editor.adjustBounds();this.fixLayout()};
ScriptFocusMorph.prototype.runScript=function(){this.element instanceof ScriptsMorph||this.element.topBlock().mouseClickLeft()};ScriptFocusMorph.prototype.items=function(){return this.element instanceof ScriptsMorph?[]:this.element.topBlock().allChildren().filter(function(a){return a instanceof SyntaxElementMorph&&!(a instanceof TemplateSlotMorph)&&(!a.isStatic||a.choices||a instanceof BooleanSlotMorph||a instanceof RingMorph||a instanceof MultiArgMorph||a instanceof CommandSlotMorph)})};
ScriptFocusMorph.prototype.sortedScripts=function(){var a=this.editor.children.filter(function(a){return a instanceof BlockMorph});a.sort(function(a,c){return a instanceof PrototypeHatBlockMorph?0:a.top()-c.top()});return a};ScriptFocusMorph.prototype.undrop=function(){this.editor.undrop()};ScriptFocusMorph.prototype.redrop=function(){this.editor.redrop()};
ScriptFocusMorph.prototype.blockTypes=function(){return this.element.isTemplate?null:this.element instanceof ScriptsMorph?["hat","command","reporter","predicate","ring"]:this.element instanceof HatBlockMorph||this.element instanceof CommandSlotMorph?["command"]:this.element instanceof CommandBlockMorph?this.atEnd&&this.element.isStop()?null:this.element.parent instanceof ScriptsMorph?["hat","command"]:["command"]:this.element instanceof ReporterBlockMorph?"%n"===this.element.getSlotSpec()?["reporter"]:
["reporter","predicate","ring"]:"%n"===this.element.getSpec()?["reporter"]:this.element.isStatic?null:["reporter","predicate","ring"]};ScriptFocusMorph.prototype.processKeyDown=function(a){this.processKeyEvent(a,this.reactToKeyEvent)};ScriptFocusMorph.prototype.processKeyUp=function(a){nop(a)};ScriptFocusMorph.prototype.processKeyPress=function(a){nop(a)};
ScriptFocusMorph.prototype.processKeyEvent=function(a,b){this.world().hand.destroyTemporaries();switch(a.keyCode){case 8:var c="backspace";break;case 9:c="tab";break;case 13:c="enter";break;case 16:case 17:case 18:return;case 27:c="esc";break;case 32:c="space";break;case 37:c="left arrow";break;case 39:c="right arrow";break;case 38:c="up arrow";break;case 40:c="down arrow";break;default:c=String.fromCharCode(a.keyCode||a.charCode)}b.call(this,(a.ctrlKey||a.metaKey?"ctrl ":"")+(a.shiftKey?"shift ":
"")+c)};
ScriptFocusMorph.prototype.reactToKeyEvent=function(a){var b;switch(a.toLowerCase()){case "esc":return this.stopEditing();case "enter":return this.trigger();case "shift enter":return this.newScript();case "ctrl shift enter":return this.runScript();case "space":return this.menu();case "left arrow":return this.lastElement();case "shift left arrow":return this.shiftScript(new Point(-50,0));case "right arrow":return this.nextElement();case "shift right arrow":return this.shiftScript(new Point(50,0));
case "up arrow":return this.lastCommand();case "shift up arrow":return this.shiftScript(new Point(0,-50));case "down arrow":return this.nextCommand();case "shift down arrow":return this.shiftScript(new Point(0,50));case "tab":return this.nextScript();case "shift tab":return this.lastScript();case "backspace":return this.deleteLastElement();case "ctrl z":return this.undrop();case "ctrl y":case "ctrl shift z":return this.redrop();case "ctrl [":break;default:var c=this.blockTypes();this.element instanceof
ScriptsMorph||!c||!contains(c,"reporter")||(b=Object.keys(this.element.getVarNamesDict()));c&&(delete this.fps,delete this.step,this.show(),this.editor.scriptTarget().searchBlocks(a,c,b,this))}};modules.threads="2017-November-16";function snapEquals(a,b){if(a instanceof List||b instanceof List)return a instanceof List&&b instanceof List?a.equalTo(b):!1;var c=+a,d=+b,e,f=[!0,!1,""];for(e=9;13>=e;e+=1)f.push(String.fromCharCode(e));f.push(String.fromCharCode(160));if(isNaN(c)||isNaN(d)||[a,b].some(function(a){return contains(f,a)||isString(a)&&-1<a.indexOf(" ")}))c=a,d=b;return isString(c)&&isString(d)?c.toLowerCase()===d.toLowerCase():c===d}
function invoke(a,b,c,d,e,f){var g=new Process;d=d?Date.now()+d:null;if(a instanceof Context)c&&(a=g.reportContextFor(c)),g.initializeFor(a,b||new List);else if(a instanceof BlockMorph){g.topBlock=a;if(c)g.homeContext=new Context,g.homeContext.receiver=c,c.variables&&(g.homeContext.variables.parentFrame=c.variables);else throw Error("expecting a receiver but getting "+c);g.context=new Context(null,a.blockSequence(),g.homeContext)}else{if(a.evaluate)return a.evaluate();throw Error("expecting a block or ring but getting "+
a);}f&&(g.isCatchingErrors=!1);for(;g.isRunning();){if(d&&Date.now()>d)throw Error(localize(e||"a synchronous Snap! script has timed out"));g.runStep(d)}return g.homeContext.inputs[0]}function ThreadManager(){this.processes=[];this.wantsToPause=!1}ThreadManager.prototype.pauseCustomHatBlocks=!1;ThreadManager.prototype.toggleProcess=function(a,b){var c=this.findProcess(a,b);if(c)c.stop();else return this.startProcess(a,b,null,null,null,!0)};
ThreadManager.prototype.startProcess=function(a,b,c,d,e,f,g){a=a.topBlock();var h=this.findProcess(a,b);if(h){if(c)return h;h.stop();this.removeTerminatedProcesses()}b=new Process(a,b,e,f);b.exportResult=d;b.isClicked=f||!1;(d=a.getHighlight())?(d.threadCount=this.processesForBlock(a).length+1,d.updateReadout()):a.addHighlight();this.processes.push(b);g&&b.runStep();return b};ThreadManager.prototype.stopAll=function(a){this.processes.forEach(function(b){b!==a&&b.stop()})};
ThreadManager.prototype.stopAllForReceiver=function(a,b){this.processes.forEach(function(c){c.homeContext.receiver===a&&c!==b&&(c.stop(),a.isTemporary&&(c.isDead=!0))})};ThreadManager.prototype.stopAllForBlock=function(a){this.processesForBlock(a,!0).forEach(function(a){a.stop()})};ThreadManager.prototype.stopProcess=function(a,b){(a=this.findProcess(a,b))&&a.stop()};ThreadManager.prototype.pauseAll=function(a){this.processes.forEach(function(a){a.pause()});a&&a.pauseAllActiveSounds()};
ThreadManager.prototype.isPaused=function(){return null!==detect(this.processes,function(a){return a.isPaused})};ThreadManager.prototype.resumeAll=function(a){this.processes.forEach(function(a){a.resume()});a&&a.resumeAllActiveSounds()};
ThreadManager.prototype.step=function(){var a;if(Process.prototype.enableSingleStepping&&(this.processes.forEach(function(b){b.isInterrupted?(b.runStep(),a=!0):b.lastYield=Date.now()}),this.wantsToPause=.5<Process.prototype.flashTime,a)){this.wantsToPause&&this.pauseAll();return}this.processes.forEach(function(a){a.homeContext.receiver.isPickedUp()||a.isDead||a.runStep()});this.removeTerminatedProcesses()};
ThreadManager.prototype.removeTerminatedProcesses=function(){var a=[],b,c=this;this.processes.forEach(function(d){if(!d.isRunning()&&!d.errorFlag||d.isDead){if(d.topBlock instanceof BlockMorph)if(d.unflash(),b=c.processesForBlock(d.topBlock).length){var e=d.topBlock.getHighlight()||d.topBlock.addHighlight();e.threadCount=b;e.updateReadout()}else d.topBlock.removeHighlight();d.prompter&&(d.prompter.destroy(),d.homeContext.receiver.stopTalking&&d.homeContext.receiver.stopTalking());if(d.topBlock instanceof
ReporterBlockMorph||d.isShowingResult)if(e=d.homeContext.inputs[0],d.onComplete instanceof Function)d.onComplete(e);else e instanceof List?d.topBlock.showBubble(e.isTable()?new TableFrameMorph(new TableMorph(e,10)):new ListWatcherMorph(e),d.exportResult,d.receiver):d.topBlock.showBubble(e,d.exportResult,d.receiver)}else a.push(d)});this.processes=a};ThreadManager.prototype.findProcess=function(a,b){var c=a.topBlock();return detect(this.processes,function(a){return a.topBlock===c&&a.receiver===b})};
ThreadManager.prototype.processesForBlock=function(a,b){var c=b?a:a.topBlock();return this.processes.filter(function(a){return a.topBlock===c&&a.isRunning()&&!a.isDead})};
ThreadManager.prototype.doWhen=function(a,b,c){if(!this.pauseCustomHatBlocks&&a&&!this.findProcess(a,b)){var d=a.inputs()[0],e;a.removeHighlight()&&(e=a.world())&&e.hand.destroyTemporaries();if(!c)try{!0===invoke(d,null,b,50,"the predicate takes\ntoo long for a\ncustom hat block",!0)&&this.startProcess(a,b,null,null,null,null,!0)}catch(f){a.addErrorHighlight(),a.showBubble(f.name+"\n"+f.message)}}};
ThreadManager.prototype.toggleSingleStepping=function(){Process.prototype.enableSingleStepping=!Process.prototype.enableSingleStepping;Process.prototype.enableSingleStepping||this.processes.forEach(function(a){a.isPaused||a.unflash()})};Process.prototype={};Process.prototype.constructor=Process;Process.prototype.timeout=500;Process.prototype.isCatchingErrors=!0;Process.prototype.enableLiveCoding=!1;Process.prototype.enableSingleStepping=!1;Process.prototype.flashTime=0;
function Process(a,b,c,d){this.topBlock=a||null;this.instrument=(this.receiver=b)?b.instrument:null;this.errorFlag=this.isShowingResult=this.isClicked=this.isDead=this.readyToTerminate=this.readyToYield=!1;this.context=null;this.homeContext=new Context(null,null,null,b);this.lastYield=Date.now();this.isFirstStep=!0;this.isAtomic=!1;this.httpRequest=this.prompter=null;this.isPaused=!1;this.pauseOffset=null;this.frameCount=0;this.exportResult=!1;this.onComplete=c||null;this.procedureCount=0;this.flashingContext=
null;this.isInterrupted=!1;a&&(this.homeContext.variables.parentFrame=this.homeContext.receiver.variables,this.context=new Context(null,a.blockSequence(),this.homeContext),d&&this.pushContext("doYield"))}Process.prototype.isRunning=function(){return null!==this.context&&!this.readyToTerminate};
Process.prototype.runStep=function(a){if(this.isPaused)return this.pauseStep();for(this.isInterrupted=this.readyToYield=!1;!this.readyToYield&&!this.isInterrupted&&this.context&&Date.now()-this.lastYield<this.timeout;){if(this.isPaused)return this.pauseStep();if(a&&Date.now()>a){this.isAtomic&&this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp();return}this.evaluateContext()}this.lastYield=Date.now();this.isFirstStep=!1;this.isAtomic&&this.homeContext.receiver&&
this.homeContext.receiver.endWarp&&(this.homeContext.receiver.endWarp(),this.homeContext.receiver.startWarp());if(this.readyToTerminate){for(;this.context;)this.popContext();this.homeContext.receiver&&this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp()}};Process.prototype.stop=function(){this.readyToTerminate=this.readyToYield=!0;this.errorFlag=!1;this.context&&this.context.stopMusic()};
Process.prototype.pause=function(){this.readyToTerminate||(this.isPaused=!0,this.flashPausedContext(),this.context&&this.context.startTime&&(this.pauseOffset=Date.now()-this.context.startTime))};Process.prototype.resume=function(){this.enableSingleStepping||this.unflash();this.isPaused=!1;this.pauseOffset=null};Process.prototype.pauseStep=function(){this.lastYield=Date.now();this.context&&this.context.startTime&&(this.context.startTime=this.lastYield-this.pauseOffset)};
Process.prototype.evaluateContext=function(){var a=this.context.expression;this.frameCount+=1;"exit"===this.context.tag&&this.expectReport();if(a instanceof Array)return this.evaluateSequence(a);if(a instanceof MultiArgMorph)return this.evaluateMultiSlot(a,a.inputs().length);if(a instanceof ArgLabelMorph)return this.evaluateArgLabel(a);if(a instanceof ArgMorph||a.bindingID)return this.evaluateInput(a);if(a instanceof BlockMorph)return this.evaluateBlock(a,a.inputs().length);if(isString(a))return this[a].apply(this,
this.context.inputs);this.popContext()};
Process.prototype.evaluateBlock=function(a,b){var c=a.selector;if("reportOr"===c||"reportAnd"===c||"doReport"===c)return this[c](a);var d=this.context.receiver||this.receiver,e=this.context.inputs;if(b>e.length)this.evaluateNextInput(a);else if(!this.flashContext())if(this[c]&&(d=this),this.isCatchingErrors)try{this.returnValueToParentContext(d[c].apply(d,e)),this.popContext()}catch(f){this.handleError(f,a)}else this.returnValueToParentContext(d[c].apply(d,e)),this.popContext()};
Process.prototype.reportOr=function(a){var b=this.context.inputs;1>b.length?this.evaluateNextInput(a):b[0]?this.flashContext()||(this.returnValueToParentContext(!0),this.popContext()):2>b.length?this.evaluateNextInput(a):this.flashContext()||(this.returnValueToParentContext(!0===b[1]),this.popContext())};
Process.prototype.reportAnd=function(a){var b=this.context.inputs;1>b.length?this.evaluateNextInput(a):b[0]?2>b.length?this.evaluateNextInput(a):this.flashContext()||(this.returnValueToParentContext(!0===b[1]),this.popContext()):this.flashContext()||(this.returnValueToParentContext(!1),this.popContext())};
Process.prototype.doReport=function(a){var b=this.context.outerContext;if(!this.flashContext()){this.isClicked&&a.topBlock()===this.topBlock&&(this.isShowingResult=!0);if(this.context.expression.partOfCustomCommand)this.doStopCustomBlock(),this.popContext();else{for(;this.context&&"exit"!==this.context.tag;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.context&&("expectReport"===this.context.expression?this.popContext():this.context.tag=null)}this.pushContext(a.inputs()[0],
b)}};Process.prototype.evaluateMultiSlot=function(a,b){var c=this.context.inputs;if(a.bindingID){if(this.isCatchingErrors)try{var d=this.context.variables.getVar(a.bindingID)}catch(e){this.handleError(e,a)}else d=this.context.variables.getVar(a.bindingID);this.returnValueToParentContext(d);this.popContext()}else b>c.length?this.evaluateNextInput(a):(this.returnValueToParentContext(new List(c)),this.popContext())};
Process.prototype.evaluateArgLabel=function(a){var b=this.context.inputs;1>b.length?this.evaluateNextInput(a):(this.returnValueToParentContext(b[0]),this.popContext())};
Process.prototype.evaluateInput=function(a){if(!this.flashContext()){if(a.bindingID)if(this.isCatchingErrors)try{var b=this.context.variables.getVar(a.bindingID)}catch(c){this.handleError(c,a)}else b=this.context.variables.getVar(a.bindingID);else(b=a.evaluate())&&(a.constructor===CommandSlotMorph||a.constructor===ReporterSlotMorph||a instanceof CSlotMorph&&(!a.isStatic||a.isLambda))&&(b=this.reify(b,new List));this.returnValueToParentContext(b);this.popContext()}};
Process.prototype.evaluateSequence=function(a){var b=this.context.pc,c=this.context.outerContext,d=this.context.isCustomBlock;b===a.length-1?(this.context=new Context(this.context.parentContext,a[b],this.context.outerContext,this.context.receiver),this.context.isCustomBlock=d):b>=a.length?this.popContext():(this.context.pc+=1,this.pushContext(a[b],c))};
Process.prototype.evaluateNextInput=function(a){var b=this.context.inputs.length;a=a.inputs()[b];b=this.context.expression.selector;var c=this.context.outerContext;a.isUnevaluated?!0===a.isUnevaluated||a.isUnevaluated()?"reify"===b||"reportScript"===b?this.context.addInput(a):this.context.addInput(this.reify(a,new List)):this.pushContext(a,c):this.pushContext(a,c)};Process.prototype.doYield=function(){this.popContext();this.isAtomic||(this.readyToYield=!0)};Process.prototype.expectReport=function(){this.handleError(Error("reporter didn't report"))};
Process.prototype.handleError=function(a,b){var c=b;this.stop();this.errorFlag=!0;this.topBlock.addErrorHighlight();if(isNil(c)||isNil(c.world()))c=this.topBlock;c.showBubble((c===b?"":"Inside: ")+a.name+"\n"+a.message,this.exportResult,this.receiver)};Process.prototype.errorObsolete=function(){throw Error("a custom block definition is missing");};
Process.prototype.reify=function(a,b,c){var d=new Context(null,null,this.context?this.context.outerContext:null),e=0;a?(d.expression=this.enableLiveCoding||this.enableSingleStepping?a:a.fullCopy(),d.expression.show(),c||b.length()||(d.expression.allEmptySlots().forEach(function(a){e+=1;a.bindingID=a instanceof MultiArgMorph?["arguments"]:e}),d.emptySlots=e)):d.expression=this.enableLiveCoding||this.enableSingleStepping?[this.context.expression]:[this.context.expression.fullCopy()];d.inputs=b.asArray();
d.receiver=this.context?this.context.receiver:this.receiver;d.origin=d.receiver;return d};Process.prototype.reportScript=function(a,b){return this.reify(b,a)};Process.prototype.reifyScript=function(a,b){return this.reify(a,b)};Process.prototype.reifyReporter=function(a,b){return this.reify(a,b)};Process.prototype.reifyPredicate=function(a,b){return this.reify(a,b)};Process.prototype.reportJSFunction=function(a,b){return Function.apply(null,a.asArray().concat([b]))};
Process.prototype.doRun=function(a,b){return this.evaluate(a,b,!0)};
Process.prototype.evaluate=function(a,b,c){if(!a)return null;if(a instanceof Function)return a.apply(this.blockReceiver(),b.asArray().concat([this]));if(a.isContinuation)return this.runContinuation(a,b);if(!(a instanceof Context))throw Error("expecting a ring but getting "+a);var d=new Context(null,null,a.outerContext),e=this.context.parentContext,f=b.asArray(),g;d.receiver||(d.receiver=a.receiver);var h=new Context(this.context.parentContext,a.expression,d,a.receiver);this.context.parentContext=
h;a.expression instanceof ReporterBlockMorph&&(this.readyToYield=Date.now()-this.lastYield>this.timeout);if(0<f.length){for(g=0;g<a.inputs.length;g+=1){var k=0;isNil(f[g])||(k=f[g]);d.variables.addVar(a.inputs[g],k)}if(0===a.inputs.length)if(d.variables.addVar(["arguments"],b),1===f.length)for(g=1;g<=a.emptySlots;g+=1)d.variables.addVar(g,f[0]);else if(f.length===a.emptySlots)for(g=1;g<=f.length;g+=1)d.variables.addVar(g,f[g-1]);else if(1!==a.emptySlots)throw Error(localize("expecting")+" "+a.emptySlots+
" "+localize("input(s), but getting")+" "+f.length);}h.expression instanceof CommandBlockMorph&&(h.expression=h.expression.blockSequence(),c||(e?e.tag="exit":(a=new Context(h.parentContext,"expectReport",d,d.receiver),a.tag="exit",h.parentContext=a)))};Process.prototype.fork=function(a,b){var c=new Process,d=this.homeContext.receiver.parentThatIsA(StageMorph);c.instrument=this.instrument;c.receiver=this.receiver;c.initializeFor(a,b,this.enableSingleStepping);d.threads.processes.push(c)};
Process.prototype.initializeFor=function(a,b,c){if(a.isContinuation)throw Error("continuations cannot be forked");if(!(a instanceof Context))throw Error("expecting a ring but getting "+a);var d=new Context(null,null,a.outerContext),e=new Context(null,a.expression,d),f=b.asArray(),g;this.context=a.receiver;if(0<f.length){for(g=0;g<a.inputs.length;g+=1){var h=0;isNil(f[g])||(h=f[g]);d.variables.addVar(a.inputs[g],h)}if(0===a.inputs.length)if(d.variables.addVar(["arguments"],b),1===f.length)for(g=1;g<=
a.emptySlots;g+=1)d.variables.addVar(g,f[0]);else if(f.length===a.emptySlots)for(g=1;g<=f.length;g+=1)d.variables.addVar(g,f[g-1]);else if(1!==a.emptySlots)throw Error(localize("expecting")+" "+a.emptySlots+" "+localize("input(s), but getting")+" "+f.length);}e.expression instanceof CommandBlockMorph&&(e.expression=e.expression.blockSequence(),c||(b=new Context(e.parentContext,"expectReport",d,d.receiver),b.tag="exit",e.parentContext=b));this.homeContext=new Context;this.homeContext.receiver=a.outerContext.receiver;
this.topBlock=a.expression;this.context=e};Process.prototype.doStopBlock=function(){var a=this.context.expression.exitTag;if(isNil(a))return this.doStopCustomBlock();for(;this.context&&(isNil(this.context.tag)||this.context.tag>a);)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext();this.pushContext()};Process.prototype.doStopCustomBlock=function(){for(;this.context&&!this.context.isCustomBlock;)"doStopWarping"===this.context.expression?this.doStopWarping():this.popContext()};
Process.prototype.doCallCC=function(a,b){this.evaluate(a,new List([this.context.continuation()]),!b)};Process.prototype.reportCallCC=function(a){this.doCallCC(a,!0)};Process.prototype.runContinuation=function(a,b){b=b.asArray();"expectReport"===a.expression&&b.length?(this.stop(),this.homeContext.inputs[0]=b[0]):(this.context.parentContext=a.copyForContinuationCall(),1===b.length&&this.context.parentContext.outerContext.variables.addVar(1,b[0]))};
Process.prototype.evaluateCustomBlock=function(){var a=this.context.parentContext,b=this.context.expression,c=b.isGlobal?b.definition:this.blockReceiver().getMethod(b.blockSpec),d=c.body,e=c.declarations,f=(new List(this.context.inputs)).asArray(),g;if(!d)return null;this.procedureCount+=1;var h=new Context;h.receiver=this.context.receiver;h.variables.parentFrame=b.variables;c.variableNames.length?b.variables.parentFrame=h.receiver?h.receiver.variables:null:h.variables.parentFrame=h.receiver?h.receiver.variables:
null;b=new Context(this.context.parentContext,d.expression,h,h.receiver);b.isCustomBlock=!0;this.context.parentContext=b;if(0<f.length)for(g=0;g<d.inputs.length;g+=1){var k=0;isNil(f[g])||(k=f[g]);h.variables.addVar(d.inputs[g],k);"%upvar"===e[d.inputs[g]][0]&&(this.context.outerContext.variables.vars[k]=h.variables.vars[d.inputs[g]])}"command"!==c.type?(a?a.tag="exit":(a=new Context(b.parentContext,"expectReport",h,h.receiver),a.tag="exit",b.parentContext=a),this.readyToYield=Date.now()-this.lastYield>
this.timeout):(b.expression.tagExitBlocks(this.procedureCount,!0),a&&!a.tag&&(a.tag=this.procedureCount),!this.isAtomic&&c.isDirectlyRecursive()&&(this.readyToYield=!0));b.expression=b.expression.blockSequence()};Process.prototype.doDeclareVariables=function(a){var b=this.context.outerContext.variables;a.asArray().forEach(function(a){b.addVar(a)})};
Process.prototype.doSetVar=function(a,b){var c=this.context.variables;a instanceof Context?(c=this.blockReceiver(),"reportGetVar"===a.expression.selector?a.variables.setVar(a.expression.blockSpec,b,c):this.doSet(a,b)):c.setVar(a,b,this.blockReceiver())};Process.prototype.doChangeVar=function(a,b){var c=this.context.variables;a instanceof Context&&"reportGetVar"===a.expression.selector?a.variables.changeVar(a.expression.blockSpec,b,this.blockReceiver()):c.changeVar(a,b,this.blockReceiver())};
Process.prototype.reportGetVar=function(){return this.context.variables.getVar(this.context.expression.blockSpec)};
Process.prototype.doShowVar=function(a){var b=this.context.variables,c,d,e=a;if(e instanceof Context)if("reportGetVar"===e.expression.selector)e=e.expression.blockSpec;else{this.doChangePrimitiveVisibility(e.expression,!1);return}this.homeContext.receiver&&(c=this.homeContext.receiver.parentThatIsA(StageMorph))&&(d=b.silentFind(e))&&(b=detect(c.children,function(a){return a instanceof WatcherMorph&&a.target===d&&a.getter===e}),null!==b?b.show():(a=(a=contains(this.homeContext.receiver.globalVariables().names(),
a))||d.owner?e:e+" "+localize("(temporary)"),b=new WatcherMorph(a,SpriteMorph.prototype.blockColor.variables,d,e),b.setPosition(c.position().add(10)),a=c.watchers(b.left()),0<a.length&&b.setTop(a[a.length-1].bottom()),c.add(b)),b.fixLayout())};
Process.prototype.doHideVar=function(a){var b=this.context.variables,c=a;if(c instanceof Context)if("reportGetVar"===c.expression.selector)c=c.expression.blockSpec;else{this.doChangePrimitiveVisibility(c.expression,!0);return}if(!c)this.doRemoveTemporaries();else if(this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))){var d=b.find(c);b=detect(a.children,function(a){return a instanceof WatcherMorph&&a.target===d&&a.getter===c});null!==b&&(b.isTemporary()?b.destroy():
b.hide())}};Process.prototype.doRemoveTemporaries=function(){var a;this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&a.watchers().forEach(function(a){a.isTemporary()&&a.destroy()})};
Process.prototype.doChangePrimitiveVisibility=function(a,b){var c=this.homeContext.receiver.parentThatIsA(IDE_Morph);c&&"evaluateCustomBlock"!==a.selector&&(b?StageMorph.prototype.hiddenPrimitives[a.selector]=!0:delete StageMorph.prototype.hiddenPrimitives[a.selector],a={doWarp:"control",reifyScript:"operators",reifyReporter:"operators",reifyPredicate:"operators",doDeclareVariables:"variables"}[this.selector]||this.category,"lists"===a&&(a="variables"),c.flushBlocksCache(a),c.refreshPalette())};
Process.prototype.doDeleteAttr=function(a){var b=this.blockReceiver();if(a instanceof Context)if("reportGetVar"===a.expression.selector)a=a.expression.blockSpec;else{a={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",size:"size"}[a.expression.selector];isNil(a)||b.inheritAttribute(a);return}if(a instanceof Array)return b.inheritAttribute(this.inputOption(a));contains(b.inheritedVariableNames(!0),a)&&b.deleteVariable(a)};
Process.prototype.doTellTo=function(a,b,c){this.doRun(this.reportAttributeOf(b,a),c)};Process.prototype.reportAskFor=function(a,b,c){this.evaluate(this.reportAttributeOf(b,a),c)};Process.prototype.reportNewList=function(a){return a};Process.prototype.reportCONS=function(a,b){this.assertType(b,"list");return(new List).cons(a,b)};Process.prototype.reportCDR=function(a){this.assertType(a,"list");return a.cdr()};
Process.prototype.doAddToList=function(a,b){this.assertType(b,"list");b.type&&this.assertType(a,b.type);b.add(a)};Process.prototype.doDeleteFromList=function(a,b){var c=a;this.assertType(b,"list");if("all"===this.inputOption(a))return b.clear();if(""===a)return null;if("last"===this.inputOption(a))c=b.length();else if(isNaN(+this.inputOption(a)))return null;b.remove(c)};
Process.prototype.doInsertInList=function(a,b,c){var d=b;this.assertType(c,"list");c.type&&this.assertType(a,c.type);if(""===b)return null;"any"===this.inputOption(b)&&(d=this.reportRandom(1,c.length()+1));"last"===this.inputOption(b)&&(d=c.length()+1);c.add(a,d)};
Process.prototype.doReplaceInList=function(a,b,c){var d=a;this.assertType(b,"list");b.type&&this.assertType(c,b.type);if(""===a)return null;"any"===this.inputOption(a)&&(d=this.reportRandom(1,b.length()));"last"===this.inputOption(a)&&(d=b.length());b.put(c,d)};Process.prototype.reportListItem=function(a,b){var c=a;this.assertType(b,"list");if(""===a)return"";"any"===this.inputOption(a)&&(c=this.reportRandom(1,b.length()));"last"===this.inputOption(a)&&(c=b.length());return b.at(c)};
Process.prototype.reportListLength=function(a){this.assertType(a,"list");return a.length()};Process.prototype.reportListContainsItem=function(a,b){this.assertType(a,"list");return a.contains(b)};Process.prototype.doShowTable=function(a){this.assertType(a,"list");(new TableDialogMorph(a)).popUp(this.blockReceiver().world())};
Process.prototype.doIf=function(){var a=this.context.inputs,b=this.context.outerContext,c=this.context.isCustomBlock;this.popContext();a[0]&&a[1]&&(this.pushContext(a[1].blockSequence(),b),this.context.isCustomBlock=c);this.pushContext()};
Process.prototype.doIfElse=function(){var a=this.context.inputs,b=this.context.outerContext,c=this.context.isCustomBlock;this.popContext();a[0]?a[1]&&this.pushContext(a[1].blockSequence(),b):a[2]?this.pushContext(a[2].blockSequence(),b):this.pushContext("doYield");this.context&&(this.context.isCustomBlock=c);this.pushContext()};Process.prototype.doStop=function(){this.stop()};
Process.prototype.doStopAll=function(){var a;if(this.homeContext.receiver){if(a=this.homeContext.receiver.parentThatIsA(StageMorph))a.threads.resumeAll(a),a.keysPressed={},a.threads.stopAll(),a.stopAllActiveSounds(),a.children.forEach(function(a){a.stopTalking&&a.stopTalking()}),a.removeAllClones();(a=a.parentThatIsA(IDE_Morph))&&a.controlBar.pauseButton.refresh()}};
Process.prototype.doStopThis=function(a){switch(this.inputOption(a)){case "all":this.doStopAll();break;case "this script":this.doStop();break;case "this block":this.doStopBlock();break;default:this.doStopOthers(a)}};
Process.prototype.doStopOthers=function(a){var b;if(this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph)))switch(this.inputOption(a)){case "all but this script":b.threads.stopAll(this);break;case "other scripts in sprite":b.threads.stopAllForReceiver(this.homeContext.receiver,this);break;default:nop()}};
Process.prototype.doWarp=function(a){var b=this.context.outerContext,c=this.context.isCustomBlock,d;this.popContext();a&&(this.homeContext.receiver&&(this.homeContext.receiver.startWarp&&this.homeContext.receiver.startWarp(),d=this.homeContext.receiver.parentThatIsA(StageMorph))&&(d.fps=0),this.pushContext("doYield"),this.context.isCustomBlock=c,this.isAtomic||this.pushContext("doStopWarping"),this.pushContext(a.blockSequence(),b),this.isAtomic=!0);this.pushContext()};
Process.prototype.doStopWarping=function(){var a;this.popContext();this.isAtomic=!1;this.homeContext.receiver&&(this.homeContext.receiver.endWarp&&this.homeContext.receiver.endWarp(),a=this.homeContext.receiver.parentThatIsA(StageMorph))&&(a.fps=a.frameRate)};Process.prototype.reportIsFastTracking=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(IDE_Morph))?a.stage.isFastTracked:!1};
Process.prototype.doSetFastTracking=function(a){var b;this.reportIsA(a,"Boolean")&&this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(IDE_Morph))&&(a?b.startFastTracking():b.stopFastTracking())};Process.prototype.doPauseAll=function(){var a;this.homeContext.receiver&&((a=this.homeContext.receiver.parentThatIsA(StageMorph))&&a.threads.pauseAll(a),(a=a.parentThatIsA(IDE_Morph))&&a.controlBar.pauseButton.refresh())};
Process.prototype.doForever=function(a){this.context.inputs=[];this.pushContext("doYield");a&&this.pushContext(a.blockSequence());this.pushContext()};Process.prototype.doRepeat=function(a,b){var c=this.context.expression,d=this.context.outerContext,e=this.context.isCustomBlock;if(1>a)return null;this.popContext();this.pushContext(c,d);this.context.isCustomBlock=e;this.context.addInput(a-1);this.pushContext("doYield");b&&this.pushContext(b.blockSequence());this.pushContext()};
Process.prototype.doUntil=function(a,b){if(a)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[];this.pushContext("doYield");b&&this.pushContext(b.blockSequence());this.pushContext()};Process.prototype.doWaitUntil=function(a){if(a)return this.popContext(),this.pushContext("doYield"),null;this.context.inputs=[];this.pushContext("doYield");this.pushContext()};
Process.prototype.reportMap=function(a,b){if(b.isLinked){3>this.context.inputs.length&&(this.context.addInput(new List),this.context.inputs[2].isLinked=!0,this.context.addInput(this.context.inputs[2]),this.context.addInput(b));if(0===this.context.inputs[4].length()){this.context.inputs[3].rest=b.cons(this.context.inputs[5]);this.returnValueToParentContext(this.context.inputs[2].cdr());return}5<this.context.inputs.length&&(this.context.inputs[3].rest=b.cons(this.context.inputs[5]),this.context.inputs[3]=
this.context.inputs[3].rest,this.context.inputs.splice(5));b=this.context.inputs[4].at(1);this.context.inputs[4]=this.context.inputs[4].cdr()}else{if(this.context.inputs.length-2===b.length()){this.returnValueToParentContext(new List(this.context.inputs.slice(2)));return}b=b.at(this.context.inputs.length-1)}this.pushContext();this.evaluate(a,new List([b]))};
Process.prototype.doForEach=function(a,b,c){isNil(this.context.inputs[3])&&(this.context.inputs[3]=1);var d=this.context.inputs[3];this.context.outerContext.variables.addVar(a);this.context.outerContext.variables.setVar(a,b.at(d));d>b.length()||(this.context.inputs[3]+=1,this.pushContext("doYield"),this.pushContext(),this.evaluate(c,new List,!0))};
Process.prototype.doWait=function(a){this.context.startTime||(this.context.startTime=Date.now());if(Date.now()-this.context.startTime>=1E3*a)return this.isAtomic||0!==a||(this.readyToYield=!0),null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doGlide=function(a,b,c){this.context.startTime||(this.context.startTime=Date.now(),this.context.startValue=new Point(this.blockReceiver().xPosition(),this.blockReceiver().yPosition()));if(Date.now()-this.context.startTime>=1E3*a)return this.blockReceiver().gotoXY(b,c),null;this.blockReceiver().glide(1E3*a,b,c,Date.now()-this.context.startTime,this.context.startValue);this.pushContext("doYield");this.pushContext()};
Process.prototype.doSayFor=function(a,b){this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().bubble(a));if(Date.now()-this.context.startTime>=1E3*b)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doThinkFor=function(a,b){this.context.startTime||(this.context.startTime=Date.now(),this.blockReceiver().doThink(a));if(Date.now()-this.context.startTime>=1E3*b)return this.blockReceiver().stopTalking(),null;this.pushContext("doYield");this.pushContext()};Process.prototype.blockReceiver=function(){return this.context?this.context.receiver||this.homeContext.receiver:this.homeContext.receiver||this.receiver};
Process.prototype.doPlaySoundUntilDone=function(a){var b=this.blockReceiver();null===this.context.activeAudio&&(this.context.activeAudio=b.playSound(a));if(this.context.activeAudio.ended||this.context.activeAudio.terminated)return null;this.pushContext("doYield");this.pushContext()};
Process.prototype.doStopAllSounds=function(){var a=this.homeContext.receiver.parentThatIsA(StageMorph);a&&(a.threads.processes.forEach(function(a){a.context&&(a.context.stopMusic(),a.context.activeAudio&&a.popContext())}),a.stopAllActiveSounds())};
Process.prototype.doAsk=function(a){var b=this.homeContext.receiver.parentThatIsA(StageMorph),c=this.blockReceiver(),d=c instanceof StageMorph,e=c instanceof SpriteMorph&&!c.isVisible;b.keysPressed={};if(!this.prompter){var f=detect(b.children,function(a){return a instanceof StagePrompterMorph});f||(d||e||c.bubble(a,!1,!0),this.prompter=new StagePrompterMorph(d||e?a:null),1>b.scale?this.prompter.setWidth(b.width()-10):this.prompter.setWidth(b.dimensions.x-20),this.prompter.fixLayout(),this.prompter.setCenter(b.center()),
this.prompter.setBottom(b.bottom()-this.prompter.border),b.add(this.prompter),this.prompter.inputField.edit(),b.changed())}else if(this.prompter.isDone)return b.lastAnswer=this.prompter.inputField.getValue(),this.prompter.destroy(),this.prompter=null,d||c.stopTalking(),null;this.pushContext("doYield");this.pushContext()};Process.prototype.reportLastAnswer=function(){return this.homeContext.receiver.parentThatIsA(StageMorph).lastAnswer};
Process.prototype.reportURL=function(a){if(!this.httpRequest){if(0>a.indexOf("//")||8<a.indexOf("//"))a="file:"===location.protocol?"https://"+a:location.protocol+"//"+a;this.httpRequest=new XMLHttpRequest;this.httpRequest.open("GET",a,!0);this.httpRequest.send(null)}else if(4===this.httpRequest.readyState)return a=this.httpRequest.responseText,this.httpRequest=null,a;this.pushContext("doYield");this.pushContext()};
Process.prototype.doBroadcast=function(a){var b=this.homeContext.receiver.parentThatIsA(StageMorph),c=a,d=this,e=[];if(a instanceof List&&2===a.length()){var f=this.blockReceiver();c=a.at(1);var g=a.at(2);if(isSnapObject(g))g=[g];else if(isString(g))g=g===b.name?[b]:[this.getOtherObject(g,f,b)];else if(g instanceof List)g=g.itemsArray().map(function(a){return d.getOtherObject(a,f,b)});else return}else g=b.children.concat(b);""!==c&&(b.lastMessage=a,g.forEach(function(a){isSnapObject(a)&&a.allHatBlocksFor(c).forEach(function(c){e.push(b.threads.startProcess(c,
a,b.isThreadSafe))})}));return e};Process.prototype.doBroadcastAndWait=function(a){this.context.activeSends||(this.context.activeSends=this.doBroadcast(a));this.context.activeSends=this.context.activeSends.filter(function(a){return a.isRunning()});if(0===this.context.activeSends.length)return null;this.pushContext("doYield");this.pushContext()};
Process.prototype.getLastMessage=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))?a.getLastMessage():""};Process.prototype.reportIsA=function(a,b){return this.reportTypeOf(a)===this.inputOption(b)};Process.prototype.assertType=function(a,b){a=this.reportTypeOf(a);if(a===b||b instanceof Array&&contains(b,a))return!0;throw Error("expecting "+b+" but getting "+a);};
Process.prototype.assertAlive=function(a){if(a&&a.isCorpse)throw Error("cannot operate on a deleted sprite");};
Process.prototype.reportTypeOf=function(a){return null===a||void 0===a?"nothing":!0===a||!1===a?"Boolean":isNaN(+a)?isString(a)?"text":a instanceof List?"list":a instanceof SpriteMorph?"sprite":a instanceof StageMorph?"stage":a instanceof Costume?"costume":a instanceof Sound?"sound":a instanceof Context?a.expression instanceof RingMorph?a.expression.dataType():a.expression instanceof ReporterBlockMorph?a.expression.isPredicate?"predicate":"reporter":a.expression instanceof Array?(a=a.expression[a.pc||
0],a.isPredicate?"predicate":a instanceof RingMorph?a.dataType():a instanceof ReporterBlockMorph?"reporter":a instanceof CommandBlockMorph?"command":"reporter"):a.expression instanceof CommandBlockMorph?"command":"reporter":"undefined":"number"};Process.prototype.reportSum=function(a,b){return+a+ +b};Process.prototype.reportDifference=function(a,b){return+a-+b};Process.prototype.reportProduct=function(a,b){return+a*+b};Process.prototype.reportQuotient=function(a,b){return+a/+b};
Process.prototype.reportModulus=function(a,b){b=+b;return(+a%b+b)%b};Process.prototype.reportRandom=function(a,b){a=+a;b=+b;return 0!==a%1||0!==b%1?Math.random()*(b-a)+a:Math.floor(Math.random()*(b-a+1))+a};Process.prototype.reportLessThan=function(a,b){var c=+a,d=+b;if(isNaN(c)||isNaN(d))c=a,d=b;return c<d};Process.prototype.reportNot=function(a){return!a};Process.prototype.reportGreaterThan=function(a,b){var c=+a,d=+b;if(isNaN(c)||isNaN(d))c=a,d=b;return c>d};
Process.prototype.reportEquals=function(a,b){return snapEquals(a,b)};Process.prototype.reportIsIdentical=function(a,b){function c(){Object.prototype.hasOwnProperty.call(a,"idTag")&&delete a.idTag;Object.prototype.hasOwnProperty.call(b,"idTag")&&delete b.idTag}if(this.isImmutable(a)||this.isImmutable(b))return snapEquals(a,b);c();a.idTag=Date.now();if(b.idTag===a.idTag)return c(),!0;c();return!1};
Process.prototype.isImmutable=function(a){a=this.reportTypeOf(a);return"nothing"===a||"Boolean"===a||"text"===a||"number"===a||"undefined"===a};Process.prototype.reportBoolean=function(a){return a};Process.prototype.reportRound=function(a){return Math.round(+a)};
Process.prototype.reportMonadic=function(a,b){b=+b;var c=0;switch(this.inputOption(a)){case "abs":c=Math.abs(b);break;case "ceiling":c=Math.ceil(b);break;case "floor":c=Math.floor(b);break;case "sqrt":c=Math.sqrt(b);break;case "sin":c=Math.sin(radians(b));break;case "cos":c=Math.cos(radians(b));break;case "tan":c=Math.tan(radians(b));break;case "asin":c=degrees(Math.asin(b));break;case "acos":c=degrees(Math.acos(b));break;case "atan":c=degrees(Math.atan(b));break;case "ln":c=Math.log(b);break;case "log":c=
Math.log(b)/Math.LN10;break;case "e^":c=Math.exp(b);break;case "10^":c=Math.pow(10,b);break;default:nop()}return c};
Process.prototype.reportTextFunction=function(a,b){b=(isNil(b)?"":b).toString();var c="";switch(this.inputOption(a)){case "encode URI":c=encodeURI(b);break;case "decode URI":c=decodeURI(b);break;case "encode URI component":c=encodeURIComponent(b);break;case "decode URI component":c=decodeURIComponent(b);break;case "XML escape":c=(new XML_Element).escape(b);break;case "XML unescape":c=(new XML_Element).unescape(b);break;case "hex sha512 hash":c=hex_sha512(b);break;default:nop()}return c};
Process.prototype.reportJoin=function(a,b){a=(isNil(a)?"":a).toString();b=(isNil(b)?"":b).toString();return a.concat(b)};Process.prototype.reportJoinWords=function(a){return a instanceof List?a.asText():(a||"").toString()};Process.prototype.reportLetter=function(a,b){if(b instanceof List)return"";a=+(a||0);return(isNil(b)?"":b.toString())[a-1]||""};Process.prototype.reportStringSize=function(a){return a instanceof List?a.length():isNil(a)?0:a.toString().length};
Process.prototype.reportUnicode=function(a){return(a=(a||"").toString()[0])?a.charCodeAt(0):0};Process.prototype.reportUnicodeAsLetter=function(a){return String.fromCharCode(+(a||0))};
Process.prototype.reportTextSplit=function(a,b){var c=["text","number"],d=this.reportTypeOf(a),e=this.reportTypeOf(this.inputOption(b));if(!contains(c,d))throw Error("expecting text instead of a "+d);if(!contains(c,e))throw Error("expecting a text delimiter instead of a "+e);c=isNil(a)?"":a.toString();switch(this.inputOption(b)){case "line":a=/\r\n|[\n\v\f\r\x85\u2028\u2029]/;break;case "tab":a="\t";break;case "cr":a="\r";break;case "whitespace":c=c.trim();a=/\s+/;break;case "letter":a="";break;case "csv":return this.parseCSV(a);
default:a=isNil(b)?"":b.toString()}return new List(c.split(a))};
Process.prototype.parseCSV=function(a){var b=[];if(!/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/.test(a))return new List;a.replace(/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g,function(a,d,e,f){void 0!==d?b.push(d.replace(/\\'/g,"'")):void 0!==e?b.push(e.replace(/\\"/g,
'"')):void 0!==f&&b.push(f);return""});/,\s*$/.test(a)&&b.push("");return new List(b)};Process.prototype.alert=function(a){if(this.homeContext.receiver){var b=this.homeContext.receiver.world();b.isDevMode&&alert("Snap! "+a.asArray())}};Process.prototype.log=function(a){if(this.homeContext.receiver){var b=this.homeContext.receiver.world();b.isDevMode&&console.log("Snap! "+a.asArray())}};
Process.prototype.getOtherObject=function(a,b,c){if(isSnapObject(a))return a;b=isNil(c)?b.parentThatIsA(StageMorph):c;c=null;b&&((c=detect(b.children,function(b){return b.name===a}))||(c=detect(b.world().hand.children,function(b){return b instanceof SpriteMorph&&b.name===a})));return c};
Process.prototype.getObjectsNamed=function(a,b,c){function d(b){return b instanceof SpriteMorph&&b.isTemporary?b.cloneOriginName===a:b.name===a}b=isNil(c)?b.parentThatIsA(StageMorph):c;c=[];b&&(c=b.children.filter(d),c.length||(c=b.world().hand.children.filter(d)));return c};
Process.prototype.doFaceTowards=function(a){var b=this.blockReceiver();b&&("mouse-pointer"===this.inputOption(a)?b.faceToXY(this.reportMouseX(),this.reportMouseY()):a instanceof List?b.faceToXY(a.at(1),a.at(2)):(a=this.getOtherObject(a,this.homeContext.receiver))&&b.faceToXY(a.xPosition(),a.yPosition()))};
Process.prototype.doGotoObject=function(a){var b=this.blockReceiver();b&&("mouse-pointer"===this.inputOption(a)?b.gotoXY(this.reportMouseX(),this.reportMouseY()):a instanceof List?b.gotoXY(a.at(1),a.at(2)):(a=this.getOtherObject(a,this.homeContext.receiver))&&b.gotoXY(a.xPosition(),a.yPosition()))};Process.prototype.createClone=function(a){var b=this.blockReceiver();a&&b&&("myself"===this.inputOption(a)?b.createClone(!this.isFirstStep):(a=this.getOtherObject(a,b))&&a.createClone(!this.isFirstStep))};
Process.prototype.newClone=function(a){var b=this.blockReceiver();if(a&&b){if("myself"===this.inputOption(a))return b.newClone(!this.isFirstStep);if(a=this.getOtherObject(a,b))return a.newClone(!this.isFirstStep)}};Process.prototype.reportTouchingObject=function(a){var b=this.blockReceiver();return b?this.objectTouchingObject(b,a):!1};
Process.prototype.objectTouchingObject=function(a,b){var c=this;if("mouse-pointer"===this.inputOption(b)){var d=a.world().hand.position();if(a.bounds.containsPoint(d)&&!a.isTransparentAt(d))return!0}else if(d=a.parentThatIsA(StageMorph)){if("edge"===this.inputOption(b)){var e=a.bounds;!a.costume&&a.penBounds&&(e=a.penBounds.translateBy(a.position()));if(!d.bounds.containsRectangle(e))return!0}if("pen trails"===this.inputOption(b)&&a.isTouching(d.penTrailsMorph()))return!0;if(isSnapObject(b))return a.isTouching(b);
d=b instanceof List?b.itemsArray():this.getObjectsNamed(b,a,d);if(d.some(function(b){return a.isTouching(b)}))return!0}return a.parts.some(function(a){return c.objectTouchingObject(a,b)})};Process.prototype.reportTouchingColor=function(a){var b=this.blockReceiver(),c;return b&&(c=b.parentThatIsA(StageMorph))?b.isTouching(c.colorFiltered(a,b))?!0:b.parts.some(function(b){return b.isTouching(c.colorFiltered(a,b))}):!1};
Process.prototype.reportColorIsTouchingColor=function(a,b){var c=this.blockReceiver(),d;return c&&(d=c.parentThatIsA(StageMorph))?c.colorFiltered(a).isTouching(d.colorFiltered(b,c))?!0:c.parts.some(function(c){return c.colorFiltered(a).isTouching(d.colorFiltered(b,c))}):!1};
Process.prototype.reportDistanceTo=function(a){var b=this.blockReceiver(),c;if(b){var d=c=b.rotationCenter();if("mouse-pointer"===this.inputOption(a))d=b.world().hand.position();else if(a instanceof List)return(new Point(b.xPosition(),b.yPosition())).distanceTo(new Point(a.at(1),a.at(2)));var e=b.parentThatIsA(StageMorph);(a=this.getOtherObject(a,b,e))&&(d=a.rotationCenter());return c.distanceTo(d)/e.scale}return 0};
Process.prototype.reportAttributeOf=function(a,b){var c=this.blockReceiver();if(c){this.assertAlive(c);var d=c.parentThatIsA(StageMorph);if(b=d.name===b?d:this.getOtherObject(b,c,d)){this.assertAlive(b);if(a instanceof Context)return this.reportContextFor(a,b);if(isString(a))return b.variables.getVar(a);switch(this.inputOption(a)){case "x position":return b.xPosition?b.xPosition():"";case "y position":return b.yPosition?b.yPosition():"";case "direction":return b.direction?b.direction():"";case "costume #":return b.getCostumeIdx();
case "costume name":return b.costume?b.costume.name:b instanceof SpriteMorph?localize("Turtle"):localize("Empty");case "size":return b.getScale?b.getScale():""}}}return""};
Process.prototype.reportGet=function(a){var b=this.blockReceiver();if(b)switch(this.inputOption(a)){case "self":return b;case "other sprites":return a=b.parentThatIsA(StageMorph),new List(a.children.filter(function(a){return a instanceof SpriteMorph&&a!==b}));case "parts":return new List(b.parts||[]);case "anchor":return b.anchor||"";case "parent":return b.exemplar||"";case "children":return new List(b.specimens?b.specimens():[]);case "temporary?":return b.isTemporary||!1;case "clones":a=b.parentThatIsA(StageMorph);
var c=b.name||b.cloneOriginName;return new List(a.children.filter(function(a){return a.isTemporary&&a!==b&&a.cloneOriginName===c}));case "other clones":return b.isTemporary?this.reportGet(["clones"]):new List;case "neighbors":a=b.parentThatIsA(StageMorph);var d=b.bounds.expandBy(new Point(b.width(),b.height()));return new List(a.children.filter(function(a){return a instanceof SpriteMorph&&a!==b&&a.bounds.intersects(d)}));case "dangling?":return!b.rotatesWithAnchor;case "rotation x":return b.xPosition();
case "rotation y":return b.yPosition();case "center x":return b.xCenter();case "center y":return b.yCenter();case "name":return b.name;case "stage":return b.parentThatIsA(StageMorph);case "costumes":return b.reportCostumes();case "sounds":return b.sounds}return""};
Process.prototype.doSet=function(a,b){if(a instanceof Context){var c=this.blockReceiver();this.assertAlive(c);if(!(a instanceof Context)||"reportGet"!==a.expression.selector)throw Error(localize("unsupported attribute"));a=a.expression.inputs()[0].evaluate();a instanceof Array&&(a=a[0]);switch(a){case "anchor":this.assertType(c,"sprite");if(b instanceof SpriteMorph){if(!c.enableNesting||contains(c.allParts(),b))throw Error(localize("unable to nest\n(disabled or circular?)"));b.attachPart(c)}else c.detachFromAnchor();
break;case "parent":this.assertType(c,"sprite");b=b instanceof SpriteMorph?b:null;c.setExemplar(b);break;case "temporary?":this.assertType(c,"sprite");this.assertType(b,"Boolean");c.world().isDevMode&&(b?c.release():c.perpetuate());break;case "dangling?":this.assertType(c,"sprite");this.assertType(b,"Boolean");c.rotatesWithAnchor=!b;c.version=Date.now();break;case "rotation x":this.assertType(c,"sprite");this.assertType(b,"number");c.setRotationX(b);break;case "rotation y":this.assertType(c,"sprite");
this.assertType(b,"number");c.setRotationY(b);break;default:throw Error('"'+localize(a)+'" '+localize("is read-only"));}}};Process.prototype.reportContextFor=function(a,b){a=copy(a);a.receiver=b;a.outerContext&&(a.outerContext=copy(a.outerContext),a.outerContext.variables=copy(a.outerContext.variables),a.outerContext.receiver=b,a.outerContext.variables.parentFrame=b.variables);return a};
Process.prototype.reportMouseX=function(){var a,b;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&(b=a.world())?(b.hand.position().x-a.center().x)/a.scale:0};Process.prototype.reportMouseY=function(){var a,b;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&(b=a.world())?(a.center().y-b.hand.position().y)/a.scale:0};
Process.prototype.reportMouseDown=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.world())?"left"===a.hand.mouseButton:!1};Process.prototype.reportKeyPressed=function(a){var b;return this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph))?"any key"===this.inputOption(a)?0<Object.keys(b.keysPressed).length:void 0!==b.keysPressed[a]:!1};
Process.prototype.doResetTimer=function(){var a;this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))&&a.resetTimer()};Process.prototype.reportTimer=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))?a.getTimer():0};
Process.prototype.reportDate=function(a){a=this.inputOption(a);var b={year:"getFullYear",month:"getMonth",date:"getDate","day of week":"getDay",hour:"getHours",minute:"getMinutes",second:"getSeconds","time in milliseconds":"getTime"};if(!b[a])return"";b=(new Date)[b[a]]();if("month"===a||"day of week"===a)b+=1;return b};
Process.prototype.doMapCodeOrHeader=function(a,b,c){if("code"===this.inputOption(b))return this.doMapCode(a,c);if("header"===this.inputOption(b))return this.doMapHeader(a,c);throw Error(" '"+b+"'\nis not a valid option");};Process.prototype.doMapHeader=function(a,b){if(a instanceof Context&&a.expression instanceof SyntaxElementMorph)return a.expression.mapHeader(b||"")};
Process.prototype.doMapCode=function(a,b){if(a instanceof Context&&a.expression instanceof SyntaxElementMorph)return a.expression.mapCode(b||"")};
Process.prototype.doMapValueCode=function(a,b){a=this.inputOption(a);switch(a){case "String":StageMorph.prototype.codeMappings.string=b||"<#1>";break;case "Number":StageMorph.prototype.codeMappings.number=b||"<#1>";break;case "true":StageMorph.prototype.codeMappings.boolTrue=b||"true";break;case "false":StageMorph.prototype.codeMappings.boolFalse=b||"true";break;default:throw Error(localize("unsupported data type")+" "+a);}};
Process.prototype.doMapListCode=function(a,b,c){var d="",e="delim";"parameters"===this.inputOption(b)?d="parms_":"variables"===this.inputOption(b)&&(d="tempvars_");"list"===this.inputOption(a)?e="list":"item"===this.inputOption(a)&&(e="item");StageMorph.prototype.codeMappings[d+e]=c||""};Process.prototype.reportMappedCode=function(a){return a instanceof Context&&a.expression instanceof SyntaxElementMorph?a.expression.mappedCode():""};
Process.prototype.doRest=function(a){var b=this.reportTempo();this.doWait(60/b*a)};Process.prototype.reportTempo=function(){var a;return this.homeContext.receiver&&(a=this.homeContext.receiver.parentThatIsA(StageMorph))?a.getTempo():0};Process.prototype.doChangeTempo=function(a){var b;this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph))&&b.changeTempo(a)};
Process.prototype.doSetTempo=function(a){var b;this.homeContext.receiver&&(b=this.homeContext.receiver.parentThatIsA(StageMorph))&&b.setTempo(a)};Process.prototype.doPlayNote=function(a,b){var c=this.reportTempo();this.doPlayNoteForSecs(parseFloat(a||"0"),60/c*parseFloat(b||"0"))};
Process.prototype.doPlayNoteForSecs=function(a,b){this.context.startTime||(this.context.startTime=Date.now(),this.context.activeNote=new Note(a),this.context.activeNote.play(this.instrument));if(Date.now()-this.context.startTime>=1E3*b)return this.context.activeNote&&(this.context.activeNote.stop(),this.context.activeNote=null),null;this.pushContext("doYield");this.pushContext()};Process.prototype.doSetInstrument=function(a){this.instrument=+a;this.receiver.instrument=+a};
Process.prototype.inputOption=function(a){return a instanceof Array?a[0]:a};Process.prototype.pushContext=function(a,b){this.context=new Context(this.context,a,b||(this.context?this.context.outerContext:null),this.context?this.context.receiver:this.homeContext.receiver)};Process.prototype.popContext=function(){this.context&&this.context.stopMusic();this.context=this.context?this.context.parentContext:null};
Process.prototype.returnValueToParentContext=function(a){void 0!==a&&(this.context?this.context.parentContext||this.homeContext:this.homeContext).addInput(a)};Process.prototype.reportStackSize=function(){return this.context?this.context.stackSize():0};Process.prototype.reportFrameCount=function(){return this.frameCount};
Process.prototype.flashContext=function(){var a=this.context.expression;return!(this.enableSingleStepping&&!this.isAtomic&&a instanceof SyntaxElementMorph)||a instanceof CommandSlotMorph||this.context.isFlashing||!a.world()||a instanceof ColorSlotMorph?!1:(this.unflash(),a.flash(),this.context.isFlashing=!0,this.flashingContext=this.context,0<this.flashTime&&.5>=this.flashTime?(this.pushContext("doIdle"),this.context.addInput(this.flashTime)):this.pushContext("doInterrupt"),!0)};
Process.prototype.flashPausedContext=function(){var a=this.context?this.context.lastFlashable():null;a&&(this.unflash(),a.expression.flash(),a.isFlashing=!0,this.flashingContext=a)};Process.prototype.doInterrupt=function(){this.popContext();this.isAtomic||(this.isInterrupted=!0)};Process.prototype.doIdle=function(a){this.context.startTime||(this.context.startTime=Date.now());Date.now()-this.context.startTime<1E3*a?this.pushContext("doInterrupt"):this.popContext()};
Process.prototype.unflash=function(){this.flashingContext&&(this.flashingContext.expression.unflash(),this.flashingContext.isFlashing=!1,this.flashingContext=null)};
function Context(a,b,c,d){this.outerContext=c||null;this.parentContext=a||null;this.expression=b||null;this.receiver=d||null;this.origin=d||null;this.variables=new VariableFrame;this.outerContext&&(this.variables.parentFrame=this.outerContext.variables,this.receiver=this.outerContext.receiver);this.inputs=[];this.pc=0;this.isContinuation=!1;this.activeNote=this.activeAudio=this.startTime=null;this.isCustomBlock=!1;this.emptySlots=0;this.tag=null;this.isFlashing=!1}
Context.prototype.toString=function(){var a=this.expression;a instanceof Array&&0<a.length&&(a="["+a[0]+"]");return"Context >> "+a+" "+this.variables};
Context.prototype.image=function(){var a=new RingMorph,b;if(this.expression instanceof Morph){var c=this.expression.fullCopy();this.isContinuation&&(b=detect(c.allInputs(),function(a){return 1===a.bindingID}))&&c.revertToDefaultInput(b,!0);a.embed(c,this.inputs);return a.fullImage()}if(this.expression instanceof Array){c=this.expression[this.pc].fullCopy();if(c instanceof RingMorph&&!c.contents())return c.fullImage();a.embed(c,this.isContinuation?[]:this.inputs);return a.fullImage()}a.color=SpriteMorph.prototype.blockColor.other;
a.setSpec("%rc %ringparms");this.isContinuation||this.inputs.forEach(function(b){a.parts()[1].addInput(b)});return a.fullImage()};Context.prototype.continuation=function(){if(this.expression instanceof Array)var a=this;else if(this.parentContext)a=this.parentContext;else return a=new Context(null,"expectReport"),a.isContinuation=!0,a;a=a.copyForContinuation();a.tag=null;a.isContinuation=!0;return a};
Context.prototype.copyForContinuation=function(){var a=copy(this),b=a;if(!(this.expression instanceof Array||isString(this.expression)))for(b.prepareContinuationForBinding();b.parentContext;)b.parentContext=copy(b.parentContext),b=b.parentContext,b.inputs=[];return a};
Context.prototype.copyForContinuationCall=function(){var a=copy(this),b=a;if(!(this.expression instanceof Array||isString(this.expression)))for(this.expression=this.expression.fullCopy(),this.inputs=[];b.parentContext;)b.parentContext=copy(b.parentContext),b=b.parentContext,b.inputs=[];return a};Context.prototype.prepareContinuationForBinding=function(){var a=this.inputs.length;this.expression=this.expression.fullCopy();if(a=this.expression.inputs()[a])this.inputs=[],this.emptySlots=a.bindingID=1};
Context.prototype.addInput=function(a){this.inputs.push(a)};Context.prototype.stopMusic=function(){this.activeNote&&(this.activeNote.stop(),this.activeNote=null)};Context.prototype.lastFlashable=function(){return this.expression instanceof SyntaxElementMorph&&!(this.expression instanceof CommandSlotMorph)?this:this.parentContext?this.parentContext.lastFlashable():null};Context.prototype.stackSize=function(){return this.parentContext?1+this.parentContext.stackSize():1};
function Variable(a,b){this.value=a;this.isTransient=b||!1}Variable.prototype.toString=function(){return"a "+(this.isTransient?"transient ":"")+"Variable ["+this.value+"]"};Variable.prototype.copy=function(){return new Variable(this.value,this.isTransient)};function VariableFrame(a,b){this.vars={};this.parentFrame=a||null;this.owner=b||null}VariableFrame.prototype.toString=function(){return"a VariableFrame {"+this.names()+"}"};
VariableFrame.prototype.copy=function(){var a=new VariableFrame(this.parentFrame),b=this;this.names().forEach(function(c){a.addVar(c,b.getVar(c))});return a};VariableFrame.prototype.deepCopy=function(){var a=this.parentFrame?new VariableFrame(this.parentFrame.deepCopy()):new VariableFrame(this.parentFrame);a.vars=copy(this.vars);return a};
VariableFrame.prototype.find=function(a){var b=this.silentFind(a);if(b)return b;throw Error(localize("a variable of name '")+a+localize("'\ndoes not exist in this context"));};VariableFrame.prototype.silentFind=function(a){return void 0!==this.vars[a]?this:this.parentFrame?this.parentFrame.silentFind(a):null};VariableFrame.prototype.setVar=function(a,b,c){var d=this.find(a);d&&(c instanceof SpriteMorph&&d.owner instanceof SpriteMorph&&c!==d.owner?c.shadowVar(a,b):d.vars[a].value=b)};
VariableFrame.prototype.changeVar=function(a,b,c){var d=this.find(a);if(d){var e=parseFloat(d.vars[a].value);b=isNaN(e)?b:e+parseFloat(b);c instanceof SpriteMorph&&d.owner instanceof SpriteMorph&&c!==d.owner?c.shadowVar(a,b):d.vars[a].value=b}};
VariableFrame.prototype.getVar=function(a){var b=this.silentFind(a);if(b)return a=b.vars[a].value,0===a?0:!1===a?!1:""===a?"":a||0;if("number"===typeof a)return"";throw Error(localize("a variable of name '")+a+localize("'\ndoes not exist in this context"));};VariableFrame.prototype.addVar=function(a,b){this.vars[a]=new Variable(0===b?0:!1===b?!1:""===b?"":b||0)};VariableFrame.prototype.deleteVar=function(a){var b=this.find(a);b&&delete b.vars[a]};
VariableFrame.prototype.names=function(){var a,b=[];for(a in this.vars)Object.prototype.hasOwnProperty.call(this.vars,a)&&b.push(a);return b};VariableFrame.prototype.allNamesDict=function(){for(var a={},b=this;b;){var c=void 0,d=b.vars,e=a;for(c in d)Object.prototype.hasOwnProperty.call(d,c)&&(e[c]=c);b=b.parentFrame}return a};VariableFrame.prototype.allNames=function(){var a=[],b,c=this.allNamesDict();for(b in c)Object.prototype.hasOwnProperty.call(c,b)&&a.push(b);return a};modules.objects="2017-October-28";function isSnapObject(a){return a instanceof SpriteMorph||a instanceof StageMorph}SpriteMorph.prototype=new PenMorph;SpriteMorph.prototype.constructor=SpriteMorph;SpriteMorph.uber=PenMorph.prototype;SpriteMorph.prototype.attributes="x position;y position;direction;size;costumes;costume #;sounds;scripts".split(";");SpriteMorph.prototype.categories="motion control looks sensing sound operators pen variables lists other".split(" ");
SpriteMorph.prototype.blockColor={motion:new Color(74,108,212),looks:new Color(143,86,227),sound:new Color(207,74,217),pen:new Color(0,161,120),control:new Color(230,168,34),sensing:new Color(4,148,220),operators:new Color(98,194,19),variables:new Color(243,118,29),lists:new Color(217,77,17),other:new Color(150,150,150)};SpriteMorph.prototype.paletteColor=new Color(55,55,55);SpriteMorph.prototype.paletteTextColor=new Color(230,230,230);SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30);
SpriteMorph.prototype.isCachingPrimitives=!0;SpriteMorph.prototype.enableNesting=!0;SpriteMorph.prototype.enableFirstClass=!0;SpriteMorph.prototype.useFlatLineEnds=!1;SpriteMorph.prototype.highlightColor=new Color(250,200,130);SpriteMorph.prototype.highlightBorder=8;SpriteMorph.prototype.bubbleColor=new Color(255,255,255);SpriteMorph.prototype.bubbleFontSize=14;SpriteMorph.prototype.bubbleFontIsBold=!0;SpriteMorph.prototype.bubbleCorner=10;SpriteMorph.prototype.bubbleBorder=3;
SpriteMorph.prototype.bubbleBorderColor=new Color(190,190,190);SpriteMorph.prototype.bubbleMaxTextWidth=130;
SpriteMorph.prototype.initBlocks=function(){SpriteMorph.prototype.blocks={forward:{only:SpriteMorph,type:"command",category:"motion",spec:"move %n steps",defaults:[10]},turn:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %clockwise %n degrees",defaults:[15]},turnLeft:{only:SpriteMorph,type:"command",category:"motion",spec:"turn %counterclockwise %n degrees",defaults:[15]},setHeading:{only:SpriteMorph,type:"command",category:"motion",spec:"point in direction %dir"},doFaceTowards:{only:SpriteMorph,
type:"command",category:"motion",spec:"point towards %dst"},gotoXY:{only:SpriteMorph,type:"command",category:"motion",spec:"go to x: %n y: %n",defaults:[0,0]},doGotoObject:{only:SpriteMorph,type:"command",category:"motion",spec:"go to %dst"},doGlide:{only:SpriteMorph,type:"command",category:"motion",spec:"glide %n secs to x: %n y: %n",defaults:[1,0,0]},changeXPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change x by %n",defaults:[10]},setXPosition:{only:SpriteMorph,type:"command",
category:"motion",spec:"set x to %n",defaults:[0]},changeYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"change y by %n",defaults:[10]},setYPosition:{only:SpriteMorph,type:"command",category:"motion",spec:"set y to %n",defaults:[0]},bounceOffEdge:{only:SpriteMorph,type:"command",category:"motion",spec:"if on edge, bounce"},xPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"x position"},yPosition:{only:SpriteMorph,type:"reporter",category:"motion",spec:"y position"},
direction:{only:SpriteMorph,type:"reporter",category:"motion",spec:"direction"},doSwitchToCostume:{type:"command",category:"looks",spec:"switch to costume %cst"},doWearNextCostume:{type:"command",category:"looks",spec:"next costume"},getCostumeIdx:{type:"reporter",category:"looks",spec:"costume #"},doSayFor:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s for %n secs",defaults:[localize("Hello!"),2]},bubble:{only:SpriteMorph,type:"command",category:"looks",spec:"say %s",defaults:[localize("Hello!")]},
doThinkFor:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s for %n secs",defaults:[localize("Hmm..."),2]},doThink:{only:SpriteMorph,type:"command",category:"looks",spec:"think %s",defaults:[localize("Hmm...")]},changeEffect:{type:"command",category:"looks",spec:"change %eff effect by %n",defaults:[null,25]},setEffect:{type:"command",category:"looks",spec:"set %eff effect to %n",defaults:[null,0]},clearEffects:{type:"command",category:"looks",spec:"clear graphic effects"},changeScale:{only:SpriteMorph,
type:"command",category:"looks",spec:"change size by %n",defaults:[10]},setScale:{only:SpriteMorph,type:"command",category:"looks",spec:"set size to %n %",defaults:[100]},getScale:{only:SpriteMorph,type:"reporter",category:"looks",spec:"size"},show:{only:SpriteMorph,type:"command",category:"looks",spec:"show"},hide:{only:SpriteMorph,type:"command",category:"looks",spec:"hide"},comeToFront:{only:SpriteMorph,type:"command",category:"looks",spec:"go to front"},goBack:{only:SpriteMorph,type:"command",
category:"looks",spec:"go back %n layers",defaults:[1]},doScreenshot:{type:"command",category:"looks",spec:"save %imgsource as costume named %s",defaults:[["pen trails"],localize("screenshot")]},reportCostumes:{dev:!0,type:"reporter",category:"looks",spec:"wardrobe"},alert:{dev:!0,type:"command",category:"looks",spec:"alert %mult%s"},log:{dev:!0,type:"command",category:"looks",spec:"console log %mult%s"},playSound:{type:"command",category:"sound",spec:"play sound %snd"},doPlaySoundUntilDone:{type:"command",
category:"sound",spec:"play sound %snd until done"},doStopAllSounds:{type:"command",category:"sound",spec:"stop all sounds"},doRest:{type:"command",category:"sound",spec:"rest for %n beats",defaults:[.2]},doPlayNote:{type:"command",category:"sound",spec:"play note %note for %n beats",defaults:[60,.5]},doSetInstrument:{type:"command",category:"sound",spec:"set instrument to %inst",defaults:[1]},doChangeTempo:{type:"command",category:"sound",spec:"change tempo by %n",defaults:[20]},doSetTempo:{type:"command",
category:"sound",spec:"set tempo to %n bpm",defaults:[60]},getTempo:{type:"reporter",category:"sound",spec:"tempo"},reportSounds:{dev:!0,type:"reporter",category:"sound",spec:"jukebox"},clear:{type:"command",category:"pen",spec:"clear"},down:{only:SpriteMorph,type:"command",category:"pen",spec:"pen down"},up:{only:SpriteMorph,type:"command",category:"pen",spec:"pen up"},setColor:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %clr"},changeHue:{only:SpriteMorph,type:"command",
category:"pen",spec:"change pen color by %n",defaults:[10]},setHue:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen color to %n",defaults:[0]},changeBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen shade by %n",defaults:[10]},setBrightness:{only:SpriteMorph,type:"command",category:"pen",spec:"set pen shade to %n",defaults:[100]},changeSize:{only:SpriteMorph,type:"command",category:"pen",spec:"change pen size by %n",defaults:[1]},setSize:{only:SpriteMorph,type:"command",
category:"pen",spec:"set pen size to %n",defaults:[1]},doStamp:{only:SpriteMorph,type:"command",category:"pen",spec:"stamp"},floodFill:{only:SpriteMorph,type:"command",category:"pen",spec:"fill"},reportPenTrailsAsCostume:{type:"reporter",category:"pen",spec:"pen trails"},receiveGo:{type:"hat",category:"control",spec:"when %greenflag clicked"},receiveKey:{type:"hat",category:"control",spec:"when %keyHat key pressed"},receiveInteraction:{type:"hat",category:"control",spec:"when I am %interaction",defaults:["clicked"]},
receiveMessage:{type:"hat",category:"control",spec:"when I receive %msgHat"},receiveCondition:{type:"hat",category:"control",spec:"when %b"},doBroadcast:{type:"command",category:"control",spec:"broadcast %msg"},doBroadcastAndWait:{type:"command",category:"control",spec:"broadcast %msg and wait"},getLastMessage:{type:"reporter",category:"control",spec:"message"},doWait:{type:"command",category:"control",spec:"wait %n secs",defaults:[1]},doWaitUntil:{type:"command",category:"control",spec:"wait until %b"},
doForever:{type:"command",category:"control",spec:"forever %c"},doRepeat:{type:"command",category:"control",spec:"repeat %n %c",defaults:[10]},doUntil:{type:"command",category:"control",spec:"repeat until %b %c"},doIf:{type:"command",category:"control",spec:"if %b %c"},doIfElse:{type:"command",category:"control",spec:"if %b %c else %c"},doStopThis:{type:"command",category:"control",spec:"stop %stopChoices"},doRun:{type:"command",category:"control",spec:"run %cmdRing %inputs"},fork:{type:"command",
category:"control",spec:"launch %cmdRing %inputs"},evaluate:{type:"reporter",category:"control",spec:"call %repRing %inputs"},doReport:{type:"command",category:"control",spec:"report %s"},doCallCC:{type:"command",category:"control",spec:"run %cmdRing w/continuation"},reportCallCC:{type:"reporter",category:"control",spec:"call %cmdRing w/continuation"},doWarp:{type:"command",category:"other",spec:"warp %c"},doTellTo:{dev:!0,type:"command",category:"control",spec:"tell %spr to %cmdRing %inputs"},reportAskFor:{dev:!0,
type:"reporter",category:"control",spec:"ask %spr for %repRing %inputs"},receiveOnClone:{type:"hat",category:"control",spec:"when I start as a clone"},createClone:{type:"command",category:"control",spec:"create a clone of %cln"},newClone:{type:"reporter",category:"control",spec:"a new clone of %cln",defaults:[["myself"]]},removeClone:{type:"command",category:"control",spec:"delete this clone"},doPauseAll:{type:"command",category:"control",spec:"pause all %pause"},reportTouchingObject:{only:SpriteMorph,
type:"predicate",category:"sensing",spec:"touching %col ?"},reportTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"touching %clr ?"},reportColorIsTouchingColor:{only:SpriteMorph,type:"predicate",category:"sensing",spec:"color %clr is touching %clr ?"},colorFiltered:{dev:!0,type:"reporter",category:"sensing",spec:"filtered for %clr"},reportStackSize:{dev:!0,type:"reporter",category:"sensing",spec:"stack size"},reportFrameCount:{dev:!0,type:"reporter",category:"sensing",spec:"frames"},
reportThreadCount:{dev:!0,type:"reporter",category:"sensing",spec:"processes"},doAsk:{type:"command",category:"sensing",spec:"ask %s and wait",defaults:[localize("what's your name?")]},reportLastAnswer:{dev:!0,type:"reporter",category:"sensing",spec:"answer"},getLastAnswer:{type:"reporter",category:"sensing",spec:"answer"},reportMouseX:{type:"reporter",category:"sensing",spec:"mouse x"},reportMouseY:{type:"reporter",category:"sensing",spec:"mouse y"},reportMouseDown:{type:"predicate",category:"sensing",
spec:"mouse down?"},reportKeyPressed:{type:"predicate",category:"sensing",spec:"key %key pressed?"},reportDistanceTo:{type:"reporter",category:"sensing",spec:"distance to %dst"},doResetTimer:{type:"command",category:"sensing",spec:"reset timer"},reportTimer:{dev:!0,type:"reporter",category:"sensing",spec:"timer"},getTimer:{type:"reporter",category:"sensing",spec:"timer"},reportAttributeOf:{type:"reporter",category:"sensing",spec:"%att of %spr",defaults:[["costume #"]]},reportURL:{type:"reporter",
category:"sensing",spec:"url %s",defaults:["snap.berkeley.edu"]},reportIsFastTracking:{type:"predicate",category:"sensing",spec:"turbo mode?"},doSetFastTracking:{type:"command",category:"sensing",spec:"set turbo mode to %b"},reportDate:{type:"reporter",category:"sensing",spec:"current %dates"},reportGet:{type:"reporter",category:"sensing",spec:"my %get",defaults:[["neighbors"]]},reifyScript:{type:"ring",category:"other",spec:"%rc %ringparms",alias:"command ring lambda"},reifyReporter:{type:"ring",
category:"other",spec:"%rr %ringparms",alias:"reporter ring lambda"},reifyPredicate:{type:"ring",category:"other",spec:"%rp %ringparms",alias:"predicate ring lambda"},reportSum:{type:"reporter",category:"operators",spec:"%n + %n"},reportDifference:{type:"reporter",category:"operators",spec:"%n \u2212 %n",alias:"-"},reportProduct:{type:"reporter",category:"operators",spec:"%n \u00d7 %n",alias:"*"},reportQuotient:{type:"reporter",category:"operators",spec:"%n / %n"},reportRound:{type:"reporter",category:"operators",
spec:"round %n"},reportMonadic:{type:"reporter",category:"operators",spec:"%fun of %n",defaults:[null,10]},reportModulus:{type:"reporter",category:"operators",spec:"%n mod %n"},reportRandom:{type:"reporter",category:"operators",spec:"pick random %n to %n",defaults:[1,10]},reportLessThan:{type:"predicate",category:"operators",spec:"%s < %s"},reportEquals:{type:"predicate",category:"operators",spec:"%s = %s"},reportGreaterThan:{type:"predicate",category:"operators",spec:"%s > %s"},reportAnd:{type:"predicate",
category:"operators",spec:"%b and %b"},reportOr:{type:"predicate",category:"operators",spec:"%b or %b"},reportNot:{type:"predicate",category:"operators",spec:"not %b"},reportBoolean:{type:"predicate",category:"operators",spec:"%bool",alias:"true boolean"},reportFalse:{type:"predicate",category:"operators",spec:"%bool",defaults:[!1],alias:"false boolean"},reportJoinWords:{type:"reporter",category:"operators",spec:"join %words",defaults:[localize("hello")+" ",localize("world")]},reportLetter:{type:"reporter",
category:"operators",spec:"letter %n of %s",defaults:[1,localize("world")]},reportStringSize:{type:"reporter",category:"operators",spec:"length of %s",defaults:[localize("world")]},reportUnicode:{type:"reporter",category:"operators",spec:"unicode of %s",defaults:["a"]},reportUnicodeAsLetter:{type:"reporter",category:"operators",spec:"unicode %n as letter",defaults:[65]},reportIsA:{type:"predicate",category:"operators",spec:"is %s a %typ ?",defaults:[5]},reportIsIdentical:{type:"predicate",category:"operators",
spec:"is %s identical to %s ?"},reportTextSplit:{type:"reporter",category:"operators",spec:"split %s by %delim",defaults:[localize("hello")+" "+localize("world")," "]},reportJSFunction:{type:"reporter",category:"operators",spec:"JavaScript function ( %mult%s ) { %code }"},reportTypeOf:{dev:!0,type:"reporter",category:"operators",spec:"type of %s",defaults:[5]},reportTextFunction:{dev:!0,type:"reporter",category:"operators",spec:"%txtfun of %s",defaults:[null,"Abelson & Sussman"]},doSetVar:{type:"command",
category:"variables",spec:"set %var to %s",defaults:[null,0]},doChangeVar:{type:"command",category:"variables",spec:"change %var by %n",defaults:[null,1]},doShowVar:{type:"command",category:"variables",spec:"show variable %var"},doHideVar:{type:"command",category:"variables",spec:"hide variable %var"},doDeclareVariables:{type:"command",category:"other",spec:"script variables %scriptVars"},doDeleteAttr:{type:"command",category:"variables",spec:"inherit %shd"},reportNewList:{type:"reporter",category:"lists",
spec:"list %exp"},reportCONS:{type:"reporter",category:"lists",spec:"%s in front of %l"},reportListItem:{type:"reporter",category:"lists",spec:"item %idx of %l",defaults:[1]},reportCDR:{type:"reporter",category:"lists",spec:"all but first of %l"},reportListLength:{type:"reporter",category:"lists",spec:"length of %l"},reportListContainsItem:{type:"predicate",category:"lists",spec:"%l contains %s",defaults:[null,localize("thing")]},doAddToList:{type:"command",category:"lists",spec:"add %s to %l",defaults:[localize("thing")]},
doDeleteFromList:{type:"command",category:"lists",spec:"delete %ida of %l",defaults:[1]},doInsertInList:{type:"command",category:"lists",spec:"insert %s at %idx of %l",defaults:[localize("thing"),1]},doReplaceInList:{type:"command",category:"lists",spec:"replace item %idx of %l with %s",defaults:[1,null,localize("thing")]},reportMap:{dev:!0,type:"reporter",category:"lists",spec:"map %repRing over %l"},doForEach:{dev:!0,type:"command",category:"lists",spec:"for %upvar in %l %cl",defaults:[localize("each item")]},
doShowTable:{dev:!0,type:"command",category:"lists",spec:"show table %l"},doMapCodeOrHeader:{type:"command",category:"other",spec:"map %cmdRing to %codeKind %code"},doMapValueCode:{type:"command",category:"other",spec:"map %mapValue to code %code",defaults:[["String"],"<#1>"]},doMapListCode:{type:"command",category:"other",spec:"map %codeListPart of %codeListKind to code %code"},reportMappedCode:{type:"reporter",category:"other",spec:"code of %cmdRing"}}};SpriteMorph.prototype.initBlocks();
SpriteMorph.prototype.initBlockMigrations=function(){SpriteMorph.prototype.blockMigrations={doStopAll:{selector:"doStopThis",inputs:[["all"]]},doStop:{selector:"doStopThis",inputs:[["this script"]]},doStopBlock:{selector:"doStopThis",inputs:[["this block"]]},doStopOthers:{selector:"doStopThis",inputs:[["all"]],offset:0},receiveClick:{selector:"receiveInteraction",inputs:[["clicked"]]},reportTrue:{selector:"reportBoolean",inputs:[!0]},reportFalse:{selector:"reportBoolean",inputs:[!1]},reportCostumes:{selector:"reportGet",
inputs:[["costumes"]]},reportSounds:{selector:"reportGet",inputs:[["sounds"]]},doMapStringCode:{selector:"doMapValueCode",inputs:[["String"],"<#1>"],offset:1}}};SpriteMorph.prototype.initBlockMigrations();
SpriteMorph.prototype.blockAlternatives={turn:["turnLeft"],turnLeft:["turn"],changeXPosition:["changeYPosition","setXPosition","setYPosition"],setXPosition:["setYPosition","changeXPosition","changeYPosition"],changeYPosition:["changeXPosition","setYPosition","setXPosition"],setYPosition:["setXPosition","changeYPosition","changeXPosition"],xPosition:["yPosition"],yPosition:["xPosition"],doSayFor:["doThinkFor","bubble","doThink","doAsk"],doThinkFor:["doSayFor","doThink","bubble","doAsk"],bubble:["doThink",
"doAsk","doSayFor","doThinkFor"],doThink:["bubble","doAsk","doSayFor","doThinkFor"],show:["hide"],hide:["show"],changeEffect:["setEffect"],setEffect:["changeEffect"],changeScale:["setScale"],setScale:["changeScale"],playSound:["doPlaySoundUntilDone"],doPlaySoundUntilDone:["playSound"],doChangeTempo:["doSetTempo"],doSetTempo:["doChangeTempo"],clear:["down","up","doStamp"],down:["up","clear","doStamp"],up:["down","clear","doStamp"],doStamp:["clear","down","up"],changeHue:["setHue","changeBrightness",
"setBrightness"],setHue:["changeHue","changeBrightness","setBrightness"],changeBrightness:["setBrightness","setHue","changeHue"],setBrightness:["changeBrightness","setHue","changeHue"],changeSize:["setSize"],setSize:["changeSize"],doBroadcast:["doBroadcastAndWait"],doBroadcastAndWait:["doBroadcast"],doIf:["doIfElse","doUntil"],doIfElse:["doIf","doUntil"],doRepeat:["doUntil"],doUntil:["doRepeat","doIf"],doAsk:["bubble","doThink","doSayFor","doThinkFor"],getLastAnswer:["getTimer"],getTimer:["getLastAnswer"],
reportMouseX:["reportMouseY"],reportMouseY:["reportMouseX"],reportSum:["reportDifference","reportProduct","reportQuotient"],reportDifference:["reportSum","reportProduct","reportQuotient"],reportProduct:["reportDifference","reportSum","reportQuotient"],reportQuotient:["reportDifference","reportProduct","reportSum"],reportLessThan:["reportEquals","reportGreaterThan"],reportEquals:["reportLessThan","reportGreaterThan"],reportGreaterThan:["reportEquals","reportLessThan"],reportAnd:["reportOr"],reportOr:["reportAnd"],
doSetVar:["doChangeVar"],doChangeVar:["doSetVar"],doShowVar:["doHideVar"],doHideVar:["doShowVar"]};function SpriteMorph(a){this.init(a)}
SpriteMorph.prototype.init=function(a){this.name=localize("Sprite");this.instrument=null;this.variables=new VariableFrame(a||null,this);this.scripts=new ScriptsMorph;this.customBlocks=[];this.costumes=new List;this.costumes.type="costume";this.costume=null;this.sounds=new List;this.sounds.type="sound";this.normalExtent=new Point(60,60);this.rotationStyle=this.scale=1;this.version=Date.now();this.isCorpse=this.isTemporary=!1;this.cloneOriginName="";this.inheritedMethodsCache=[];this.parts=[];this.anchor=
null;this.nestingScale=1;this.rotatesWithAnchor=!0;this.layers=null;this.blocksCache={};this.paletteCache={};this.rotationOffset=new Point;this.idx=0;this.wasWarped=!1;this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0};this.exemplar=null;this.instances=[];this.cachedPropagation=!1;this.inheritedAttributes=[];SpriteMorph.uber.init.call(this);this.isDraggable=!0;this.isDown=!1;this.heading=90;this.changed();this.drawNew();
this.changed()};
SpriteMorph.prototype.fullCopy=function(a){var b=SpriteMorph.uber.fullCopy.call(this),c=this,d=[],e,f;b.instances=[];b.stopTalking();b.color=this.color.copy();b.blocksCache={};b.paletteCache={};d=[];this.inheritedAttributes.forEach(function(a){d.push(a)});b.inheritedAttributes=d;a?(b.exemplar=this,b.customBlocks=[],b.variables=new VariableFrame(null,b),b.variables.parentFrame=this.variables,b.inheritedVariableNames().forEach(function(a){b.shadowVar(a,b.variables.getVar(a))}),this.addSpecimen(b),this.cachedPropagation=
!1,["scripts","costumes","sounds"].forEach(function(a){contains(b.inheritedAttributes,a)||b.inheritedAttributes.push(a)})):(b.variables=this.variables.copy(),b.variables.owner=b,b.scripts=this.scripts.fullCopy(),b.customBlocks=[],this.customBlocks.forEach(function(a){e=a.copyAndBindTo(b);b.customBlocks.push(e);b.allBlockInstances(a).forEach(function(a){a.definition=e})}),d=[],this.costumes.asArray().forEach(function(e){var f=a?e:e.copy();d.push(f);e===c.costume&&(b.costume=f)}),b.costumes=new List(d),
d=[],this.sounds.asArray().forEach(function(b){b=a?b:b.copy();d.push(b)}),b.sounds=new List(d),d=[]);b.nestingScale=1;b.rotatesWithAnchor=!0;b.anchor=null;b.parts=[];this.parts.forEach(function(c){var d=c.fullCopy(a);d.nestingScale=c.nestingScale;d.rotatesWithAnchor=c.rotatesWithAnchor;b.attachPart(d)});b.graphicsValues={};for(f in this.graphicsValues)this.graphicsValues.hasOwnProperty(f)&&(b.graphicsValues[f]=this.graphicsValues[f]);return b};
SpriteMorph.prototype.appearIn=function(a){this.isTemporary||(this.name=a.newSpriteName(this.name),a.corral.addSprite(this),a.sprites.add(this));a.stage.add(this);this.parts.forEach(function(b){b.appearIn(a)})};SpriteMorph.prototype.setName=function(a){this.name=a||this.name;this.version=Date.now()};
SpriteMorph.prototype.drawNew=function(){var a=this;var b=[];if(this.isWarped)this.wantsRedraw=!0;else{var c=this.center();b=this.costume&&"function"===typeof this.costume.loaded;var d=this.parent instanceof StageMorph?this.parent.scale:1;var e=this.rotationStyle?this.heading:90;if(2===this.rotationStyle&&(e=90,180<this.heading&&360>this.heading||0>this.heading&&-180<this.heading))var f=!0;if(this.costume&&!b){f=f?this.costume.flipped():this.costume;b=f.bounds().corners().map(function(b){return b.rotateBy(radians(e-
90),a.costume.center())});var g=b[0];var h=b[0];b.forEach(function(a){g=g.min(a);h=h.max(a)});var k=g.corner(h).extent().multiplyBy(this.scale*d);b=(new Point(0,0)).rotateBy(radians(-(e-90)),f.center()).subtract(g);this.image=newCanvas(k,!0);this.silentSetExtent(k);k=this.image.getContext("2d");k.scale(this.scale*d,this.scale*d);k.translate(b.x,b.y);k.rotate(radians(e-90));k.drawImage(f.contents,0,0);this.image=this.applyGraphicsEffects(this.image);this.setCenter(c,!0);this.rotationOffset=b.translateBy(f.rotationCenter).rotateBy(radians(-(e-
90)),b).scaleBy(this.scale*d)}else if(e=f?-90:e,d=Math.min(Math.max(this.normalExtent.x*this.scale*d,5),1E3),this.silentSetExtent(new Point(d,d)),this.image=newCanvas(this.extent(),!0),this.setCenter(c,!0),SpriteMorph.uber.drawNew.call(this,e),this.rotationOffset=this.extent().divideBy(2),this.image=this.applyGraphicsEffects(this.image),b){var l=this.costume;var m=setInterval(function(){a.wearCostume(l);clearInterval(m)},100);return a.wearCostume(null)}this.version=Date.now()}};
SpriteMorph.prototype.endWarp=function(){this.isWarped=!1;if(this.wantsRedraw){var a=this.xPosition(),b=this.yPosition();this.drawNew();this.silentGotoXY(a,b,!0);this.wantsRedraw=!1}this.parent.changed()};SpriteMorph.prototype.rotationCenter=function(){return this.position().add(this.rotationOffset)};
SpriteMorph.prototype.colorFiltered=function(a){var b=new Morph,c=this.extent(),d;var e=normalizeCanvas(this.image,!0).getContext("2d").getImageData(0,0,c.x,c.y);b.image=newCanvas(c,!0);b.bounds=this.bounds.copy();var f=b.image.getContext("2d");var g=f.createImageData(c.x,c.y);for(d=0;d<c.x*c.y*4;d+=4){var h=new Color(e.data[d],e.data[d+1],e.data[d+2]);h.eq(a)&&(g.data[d]=e.data[d],g.data[d+1]=e.data[d+1],g.data[d+2]=e.data[d+2],g.data[d+3]=255)}f.putImageData(g,0,0);return b};
SpriteMorph.prototype.blockForSelector=function(a,b){var c=this.blockMigrations[a];var d=this.blocks[c?c.selector:a];if(!d)return null;var e="command"===d.type?new CommandBlockMorph:"hat"===d.type?new HatBlockMorph:"ring"===d.type?new RingMorph:new ReporterBlockMorph("predicate"===d.type);e.color=this.blockColor[d.category];e.category=d.category;e.selector=c?c.selector:a;contains(["reifyReporter","reifyPredicate"],e.selector)&&(e.isStatic=!0);e.setSpec(localize(d.spec));if(b&&d.defaults||c&&c.inputs)if(a=
c?c.inputs:d.defaults,e.defaults=a,b=e.inputs(),b[0]instanceof MultiArgMorph)b[0].setContents(a),b[0].defaults=a;else for(c=0;c<a.length;c+=1)null!==a[c]&&b[c].setContents(a[c]);return e};SpriteMorph.prototype.variableBlock=function(a){var b=new ReporterBlockMorph(!1);b.selector="reportGetVar";b.color=this.blockColor.variables;b.category="variables";b.setSpec(a);b.isDraggable=!0;return b};
SpriteMorph.prototype.blockTemplates=function(a){function b(a,b){if(StageMorph.prototype.hiddenPrimitives[a])return null;a=SpriteMorph.prototype.blockForSelector(a,!0);a.isTemplate=!0;b&&a.ghost();return a}function c(a){var b=SpriteMorph.prototype.variableBlock(a);b.isDraggable=!1;b.isTemplate=!0;contains(l,a)&&b.ghost();return b}function d(a){if(StageMorph.prototype.hiddenPrimitives[a])return null;var b=SpriteMorph.prototype.blocks[a];return new ToggleMorph("checkbox",this,function(){k.toggleWatcher(a,
localize(b.spec),k.blockColor[b.category])},null,function(){return k.showingWatcher(a)},null)}function e(a){return new ToggleMorph("checkbox",this,function(){k.toggleVariableWatcher(a)},null,function(){return k.showingVariableWatcher(a)},null)}function f(){var a=new MenuMorph(this);a.addItem("help...","showHelp");return a}function g(a){if(a)if(k.isVariableNameInUse(a[0],a[1]))k.inform("that name is already in use");else{var b=k.parentThatIsA(IDE_Morph);k.addVariable(a[0],a[1]);k.showingVariableWatcher(a[0])||
k.toggleVariableWatcher(a[0],a[1]);b.flushBlocksCache("variables");b.refreshPalette()}}var h=[],k=this;a=a||"motion";var l=this.inheritedVariableNames();if("motion"===a)h.push(b("forward")),h.push(b("turn")),h.push(b("turnLeft")),h.push("-"),h.push(b("setHeading")),h.push(b("doFaceTowards")),h.push("-"),h.push(b("gotoXY")),h.push(b("doGotoObject")),h.push(b("doGlide")),h.push("-"),h.push(b("changeXPosition")),h.push(b("setXPosition")),h.push(b("changeYPosition")),h.push(b("setYPosition")),h.push("-"),
h.push(b("bounceOffEdge")),h.push("-"),h.push(d("xPosition")),h.push(b("xPosition",this.inheritsAttribute("x position"))),h.push(d("yPosition")),h.push(b("yPosition",this.inheritsAttribute("y position"))),h.push(d("direction")),h.push(b("direction",this.inheritsAttribute("direction"))),h.push("="),h.push(this.makeBlockButton(a));else if("looks"===a){h.push(b("doSwitchToCostume"));h.push(b("doWearNextCostume"));h.push(d("getCostumeIdx"));h.push(b("getCostumeIdx",this.inheritsAttribute("costume #")));
h.push("-");h.push(b("doSayFor"));h.push(b("bubble"));h.push(b("doThinkFor"));h.push(b("doThink"));h.push("-");h.push(b("changeEffect"));h.push(b("setEffect"));h.push(b("clearEffects"));h.push("-");h.push(b("changeScale"));h.push(b("setScale"));h.push(d("getScale"));h.push(b("getScale",this.inheritsAttribute("size")));h.push("-");h.push(b("show"));h.push(b("hide"));h.push("-");h.push(b("comeToFront"));h.push(b("goBack"));if(this.world().isDevMode){h.push("-");var m=new TextMorph(localize("development mode \ndebugging primitives:"));
m.fontSize=9;m.setColor(this.paletteTextColor);h.push(m);h.push("-");h.push(b("log"));h.push(b("alert"));h.push("-");h.push(b("doScreenshot"))}h.push("=");h.push(this.makeBlockButton(a))}else"sound"===a?(h.push(b("playSound")),h.push(b("doPlaySoundUntilDone")),h.push(b("doStopAllSounds")),h.push("-"),h.push(b("doRest")),h.push(b("doPlayNote")),h.push(b("doSetInstrument")),h.push("-"),h.push(b("doChangeTempo")),h.push(b("doSetTempo")),h.push(d("getTempo")),h.push(b("getTempo")),h.push("="),h.push(this.makeBlockButton(a))):
"pen"===a?(h.push(b("clear")),h.push("-"),h.push(b("down")),h.push(b("up")),h.push("-"),h.push(b("setColor")),h.push(b("changeHue")),h.push(b("setHue")),h.push("-"),h.push(b("changeBrightness")),h.push(b("setBrightness")),h.push("-"),h.push(b("changeSize")),h.push(b("setSize")),h.push("-"),h.push(b("doStamp")),h.push(b("floodFill")),h.push("-"),h.push(b("reportPenTrailsAsCostume")),h.push("="),h.push(this.makeBlockButton(a))):"control"===a?(h.push(b("receiveGo")),h.push(b("receiveKey")),h.push(b("receiveInteraction")),
h.push(b("receiveCondition")),h.push(b("receiveMessage")),h.push("-"),h.push(b("doBroadcast")),h.push(b("doBroadcastAndWait")),h.push(d("getLastMessage")),h.push(b("getLastMessage")),h.push("-"),h.push(b("doWarp")),h.push("-"),h.push(b("doWait")),h.push(b("doWaitUntil")),h.push("-"),h.push(b("doForever")),h.push(b("doRepeat")),h.push(b("doUntil")),h.push("-"),h.push(b("doIf")),h.push(b("doIfElse")),h.push("-"),h.push(b("doReport")),h.push(b("doStopThis")),h.push("-"),h.push(b("doRun")),h.push(b("fork")),
h.push(b("evaluate")),h.push("-"),h.push(b("doTellTo")),h.push(b("reportAskFor")),h.push("-"),h.push(b("doCallCC")),h.push(b("reportCallCC")),h.push("-"),h.push(b("receiveOnClone")),h.push(b("createClone")),h.push(b("newClone")),h.push(b("removeClone")),h.push("-"),h.push(b("doPauseAll")),h.push("="),h.push(this.makeBlockButton(a))):"sensing"===a?(h.push(b("reportTouchingObject")),h.push(b("reportTouchingColor")),h.push(b("reportColorIsTouchingColor")),h.push("-"),h.push(b("doAsk")),h.push(d("getLastAnswer")),
h.push(b("getLastAnswer")),h.push("-"),h.push(d("reportMouseX")),h.push(b("reportMouseX")),h.push(d("reportMouseY")),h.push(b("reportMouseY")),h.push(b("reportMouseDown")),h.push("-"),h.push(b("reportKeyPressed")),h.push("-"),h.push(b("reportDistanceTo")),h.push("-"),h.push(b("doResetTimer")),h.push(d("getTimer")),h.push(b("getTimer")),h.push("-"),h.push(b("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&h.push(b("reportGet")),h.push("-"),h.push(b("reportURL")),h.push("-"),h.push(b("reportIsFastTracking")),
h.push(b("doSetFastTracking")),h.push("-"),h.push(b("reportDate")),this.world().isDevMode&&(h.push("-"),m=new TextMorph(localize("development mode \ndebugging primitives:")),m.fontSize=9,m.setColor(this.paletteTextColor),h.push(m),h.push("-"),h.push(d("reportThreadCount")),h.push(b("reportThreadCount")),h.push(b("colorFiltered")),h.push(b("reportStackSize")),h.push(b("reportFrameCount"))),h.push("="),h.push(this.makeBlockButton(a))):"operators"===a?(h.push(b("reifyScript")),h.push(b("reifyReporter")),
h.push(b("reifyPredicate")),h.push("#"),h.push("-"),h.push(b("reportSum")),h.push(b("reportDifference")),h.push(b("reportProduct")),h.push(b("reportQuotient")),h.push("-"),h.push(b("reportModulus")),h.push(b("reportRound")),h.push(b("reportMonadic")),h.push(b("reportRandom")),h.push("-"),h.push(b("reportLessThan")),h.push(b("reportEquals")),h.push(b("reportGreaterThan")),h.push("-"),h.push(b("reportAnd")),h.push(b("reportOr")),h.push(b("reportNot")),h.push(b("reportBoolean")),h.push("-"),h.push(b("reportJoinWords")),
h.push(b("reportTextSplit")),h.push(b("reportLetter")),h.push(b("reportStringSize")),h.push("-"),h.push(b("reportUnicode")),h.push(b("reportUnicodeAsLetter")),h.push("-"),h.push(b("reportIsA")),h.push(b("reportIsIdentical")),h.push("-"),h.push(b("reportJSFunction")),this.world().isDevMode&&(h.push("-"),m=new TextMorph(localize("development mode \ndebugging primitives:")),m.fontSize=9,m.setColor(this.paletteTextColor),h.push(m),h.push("-"),h.push(b("reportTypeOf")),h.push(b("reportTextFunction"))),
h.push("="),h.push(this.makeBlockButton(a))):"variables"===a&&(a=new PushButtonMorph(null,function(){(new VariableDialogMorph(null,g,k)).prompt("Variable name",null,k.world())},"Make a variable"),a.userMenu=f,a.selector="addVariable",a.showHelp=BlockMorph.prototype.showHelp,h.push(a),0<this.deletableVariableNames().length&&(a=new PushButtonMorph(null,function(){var a=new MenuMorph(k.deleteVariable,null,k);k.deletableVariableNames().forEach(function(b){a.addItem(b,b)});a.popUpAtHand(k.world())},"Delete a variable"),
a.userMenu=f,a.selector="deleteVariable",a.showHelp=BlockMorph.prototype.showHelp,h.push(a)),h.push("-"),a=this.variables.allNames(),0<a.length&&(a.forEach(function(a){h.push(e(a));h.push(c(a))}),h.push("-")),h.push(b("doSetVar")),h.push(b("doChangeVar")),h.push(b("doShowVar")),h.push(b("doHideVar")),h.push(b("doDeclareVariables")),StageMorph.prototype.enableInheritance&&(h.push("-"),h.push(b("doDeleteAttr"))),h.push("="),h.push(b("reportNewList")),h.push("-"),h.push(b("reportCONS")),h.push(b("reportListItem")),
h.push(b("reportCDR")),h.push("-"),h.push(b("reportListLength")),h.push(b("reportListContainsItem")),h.push("-"),h.push(b("doAddToList")),h.push(b("doDeleteFromList")),h.push(b("doInsertInList")),h.push(b("doReplaceInList")),this.world().isDevMode&&(h.push("-"),m=new TextMorph(localize("development mode \ndebugging primitives:")),m.fontSize=9,m.setColor(this.paletteTextColor),h.push(m),h.push("-"),h.push(b("reportMap")),h.push("-"),h.push(b("doForEach")),h.push(b("doShowTable"))),h.push("="),StageMorph.prototype.enableCodeMapping&&
(h.push(b("doMapCodeOrHeader")),h.push(b("doMapValueCode")),h.push(b("doMapListCode")),h.push("-"),h.push(b("reportMappedCode")),h.push("=")),h.push(this.makeBlockButton()));return h};SpriteMorph.prototype.makeBlockButton=function(a){a=new PushButtonMorph(this,"makeBlock","Make a block");a.userMenu=function(){var a=new MenuMorph(this);a.addItem("help...","showHelp");return a};a.selector="addCustomBlock";a.showHelp=BlockMorph.prototype.showHelp;return a};
SpriteMorph.prototype.makeBlock=function(){var a=this.parentThatIsA(IDE_Morph),b=this.parentThatIsA(StageMorph),c=a.currentCategory,d=SpriteMorph.prototype.blockColor[c],e=this;var f=new BlockDialogMorph(null,function(c){""!==c.spec&&(c.isGlobal?b.globalBlocks.push(c):e.customBlocks.push(c),a.flushPaletteCache(),a.refreshPalette(),(new BlockEditorMorph(c,e)).popUp())},e);"variables"!==c&&(f.category=c,f.categories.children.forEach(function(a){a.refresh()}),f.types.children.forEach(function(a){a.setColor(d);
a.refresh()}));f.prompt("Make a block",null,e.world())};SpriteMorph.prototype.palette=function(a){this.paletteCache[a]||(this.paletteCache[a]=this.freshPalette(a));return this.paletteCache[a]};
SpriteMorph.prototype.freshPalette=function(a){var b=new ScrollFrameMorph(null,null,this.sliderColor),c=SyntaxElementMorph.prototype.fontSize,d=0,e=5,f=0,g=!1,h=this,k=this.parentThatIsA(StageMorph),l=Morph.prototype.trackChanges;var m=new Color(140,140,140);Morph.prototype.trackChanges=!1;b.owner=this;b.padding=c/2;b.color=this.paletteColor;b.growth=new Point(0,MorphicPreferences.scrollBarSize);b.toolBar=new AlignmentMorph("column");var n=new PushButtonMorph(this,"searchBlocks",new SymbolMorph("magnifierOutline",
16));n.alpha=.2;n.padding=1;n.hint=localize("find blocks")+"...";n.labelShadowColor=m;n.drawNew();n.fixLayout();b.toolBar.add(n);n=new PushButtonMorph(this,"makeBlock",new SymbolMorph("cross",16));n.alpha=.2;n.padding=1;n.hint=localize("Make a block")+"...";n.labelShadowColor=m;n.drawNew();n.fixLayout();b.toolBar.add(n);b.toolBar.fixLayout();b.add(b.toolBar);b.userMenu=function(){var c=new MenuMorph,d=this.parentThatIsA(IDE_Morph),e={operators:["reifyScript","reifyReporter","reifyPredicate"],control:["doWarp"],
variables:"doDeclareVariables reportNewList reportCONS reportListItem reportCDR reportListLength reportListContainsItem doAddToList doDeleteFromList doInsertInList doReplaceInList".split(" ")};c.addPair([new SymbolMorph("magnifyingGlass",MorphicPreferences.menuFontSize),localize("find blocks")+"..."],function(){h.searchBlocks()},"^F");(function(){return b.contents.children.some(function(a){return contains(Object.keys(SpriteMorph.prototype.blocks),a.selector)})})()&&c.addItem("hide primitives",function(){var b=
SpriteMorph.prototype.blocks;Object.keys(b).forEach(function(c){b[c].category===a&&(StageMorph.prototype.hiddenPrimitives[c]=!0)});(e[a]||[]).forEach(function(a){StageMorph.prototype.hiddenPrimitives[a]=!0});d.flushBlocksCache(a);d.refreshPalette()});(function(){var b=SpriteMorph.prototype.blocks;return Object.keys(StageMorph.prototype.hiddenPrimitives).some(function(c){return!isNil(b[c])&&(b[c].category===a||contains(e[a]||[],c))})})()&&c.addItem("show primitives",function(){var b=SpriteMorph.prototype.blocks;
Object.keys(StageMorph.prototype.hiddenPrimitives).forEach(function(c){b[c]&&b[c].category===a&&delete StageMorph.prototype.hiddenPrimitives[c]});(e[a]||[]).forEach(function(a){delete StageMorph.prototype.hiddenPrimitives[a]});d.flushBlocksCache(a);d.refreshPalette()});return c};m=this.blocksCache[a];m||(m=this.blockTemplates(a),this.isCachingPrimitives&&(this.blocksCache[a]=m));m.forEach(function(a){null!==a&&("-"===a?g||(e+=.8*c,g=!0):"="===a?g||(e+=1.6*c,g=!0):"#"===a?(d=0,e=f):(g=!1,0===d&&(e+=
.3*c),a.setPosition(new Point(d,e)),b.addContents(a),a instanceof ToggleMorph||a instanceof RingMorph?(d=a.right()+c/2,f=a.bottom()):(d=0,e+=a.height())))});k&&(e+=1.6*c,k.globalBlocks.forEach(function(f){if(f.category===a||"variables"===a&&contains(["lists","other"],f.category))f=f.templateInstance(),e+=.3*c,f.setPosition(new Point(d,e)),b.addContents(f),d=0,e+=f.height()}));e+=1.6*c;this.customBlocks.forEach(function(f){if(f.category===a||"variables"===a&&contains(["lists","other"],f.category))f=
f.templateInstance(),e+=.3*c,f.setPosition(new Point(d,e)),b.addContents(f),d=0,e+=f.height()});this.exemplar&&this.inheritedBlocks(!0).forEach(function(f){if(f.category===a||"variables"===a&&contains(["lists","other"],f.category))f=f.templateInstance(),e+=.3*c,f.setPosition(new Point(d,e)),b.addContents(f),f.ghost(),d=0,e+=f.height()});b.scrollX(b.padding);b.scrollY(b.padding);Morph.prototype.trackChanges=l;return b};
SpriteMorph.prototype.blocksMatching=function(a,b,c,d){function e(a){return BlockMorph.prototype.parseSpec(a).filter(function(a){return 0!==a.indexOf("%")}).join(" ")}function f(a,c){a=" "+a;c=a.indexOf(c);if(-1===c)return-1;a=" "===a.charAt(c-1);if(b&&!a)return-1;for(c=String(c);4>c.length;)c="0"+c;return(a?"1":"2")+c}function g(a){a=SpriteMorph.prototype.blockForSelector(a,!0);a.isTemplate=!0;return a}var h=[],k=this,l=a.toLowerCase(),m=this.parentThatIsA(StageMorph);c&&c.length||(c=["hat","command",
"reporter","predicate","ring"]);d||(d=[]);d.forEach(function(a){var b=f(e(a.toLowerCase()),l);-1!==b&&h.push([k.variableBlock(a),b+"1"])});[this.customBlocks,m.globalBlocks].forEach(function(a){a.forEach(function(a){if(contains(c,a.type)){var b=localize(a.blockSpec()).toLowerCase();b=f(e(b),l);-1!==b&&h.push([a.templateInstance(),b+"2"])}})});var n=SpriteMorph.prototype.blocks;Object.keys(n).forEach(function(a){if(!StageMorph.prototype.hiddenPrimitives[a]&&contains(c,n[a].type)){var b=n[a],d=localize(b.alias||
b.spec).toLowerCase();d=f(e(d),l);-1===d||b.dev||b.only&&b.only!==k.constructor||h.push([g(a),d+"3"])}});contains(c,"reporter")&&(a=this.reporterize(a))&&h.push([a,""]);h.sort(function(a,b){return a[1]<b[1]?-1:1});return h.map(function(a){return a[0]})};
SpriteMorph.prototype.searchBlocks=function(a,b,c,d){function e(){t&&t.destroy();q&&d&&(t=q.outline(MorphicPreferences.isFlat?new Color(150,200,255):new Color(255,255,255),2),n.contents.add(t),t.scrollIntoView())}function f(a){var b=Morph.prototype.trackChanges,c=n.contents.left()+5,f=m.bottom()+h;p=a;q=null;a.length&&d&&(q=a[0]);Morph.prototype.trackChanges=!1;n.contents.children=[n.contents.children[0]];a.forEach(function(a){a.setPosition(new Point(c,f));n.addContents(a);f+=a.height();f+=.3*h});
Morph.prototype.trackChanges=b;e();n.changed()}var g=this,h=SyntaxElementMorph.prototype.fontSize,k=this.parentThatIsA(IDE_Morph),l="",m=new InputFieldMorph(a||""),n=k.createPalette("forSearch"),p=[],q,t;n.owner=this;n.color=g.paletteColor;n.contents.color=g.paletteColor;n.addContents(m);m.drawNew();m.setWidth(k.logo.width()-30);m.contrast=90;m.setPosition(n.contents.topLeft().add(new Point(10,10)));m.drawNew();n.accept=function(){if(d)m.cancel(),q&&d.insertBlock(q);else{var a=m.getValue();0<a.length&&
f(g.blocksMatching(a))}};n.reactToKeystroke=function(a){switch(a?a.keyCode:0){case 38:if(!d||!q)break;a=p.indexOf(q)-1;0>a&&(a=p.length-1);q=p[a];e();break;case 40:if(!d||!q)break;a=p.indexOf(q)+1;a>=p.length&&(a=0);q=p[a];e();break;default:a=m.getValue(),a!==l&&(l=a,f(g.blocksMatching(a,2>a.length,b,c)))}};m.cancel=function(){k.refreshPalette();k.palette.adjustScrollBars()};k.fixLayout("refreshPalette");m.edit();a&&n.reactToKeystroke()};
SpriteMorph.prototype.reporterize=function(a){function b(a,c,d){function e(a){return a instanceof Array||isNaN(+a)?a:+a}function f(){for(var b=1,c="";m<a.length;){n=a[m];m+=1;switch(n){case "(":b+=1;break;case ")":if(--b,!b)return c}c+=n}}for(var g=["",""],m=0,n;m<a.length;)switch(n=a[m],m+=1,n){case " ":break;case "(":g[c?1:0]=g[c?1:0].length?[g[c?1:0],b(f())]:b(f());break;case "-":case "+":case "*":case "/":case "%":case "=":case "<":case ">":case "&":case "|":if(c||g[0].length)if(c){if(g[1].length)return b(a.slice(m),
n,[c,d,e(g[1])]);g[1]=n}else c=n,d=e(g[0]);else g[0]=n;break;default:g[c?1:0]+=n}return c?[c,d,e(g[1])]:e(g[0])}function c(a){var b=1,d={};var e={"+":"reportSum","-":"reportDifference","*":"reportProduct","/":"reportQuotient","%":"reportModulus","=":"reportEquals","<":"reportLessThan",">":"reportGreaterThan","&":"reportAnd","|":"reportOr",round:"reportRound",not:"reportNot"};var k="abs ceiling floor sqrt sin cos tan asin acos atan ln log round not".split(" ");k.concat(["true","false"]).forEach(function(a){d[localize(a).toLowerCase()]=
a});var l={ceil:"ceiling","!":"not"}[a[0]]||d[a[0].toLowerCase()]||a[0];contains(k,l)?(e=e[l])?(e=SpriteMorph.prototype.blockForSelector(e),k=e.inputs()):(e=SpriteMorph.prototype.blockForSelector("reportMonadic"),k=e.inputs(),k[0].setContents([l]),b=0):(e=SpriteMorph.prototype.blockForSelector(e[l]),k=e.inputs());for(l=1;l<a.length;l+=1)a[l]instanceof Array?e.silentReplaceInput(k[l-b],c(a[l])):isString(a[l])?contains(["true","false"],d[a[l]]||a[l])?e.silentReplaceInput(k[l-b],SpriteMorph.prototype.blockForSelector("true"===
(d[a[l]]||a[l])?"reportTrue":"reportFalse")):"_"!==a[l]&&e.silentReplaceInput(k[l-b],SpriteMorph.prototype.variableBlock(a[l])):k[l-b].setContents(a[l]);e.isDraggable=!0;e.fixLayout();e.fixBlockColor(null,!0);return e}if(100<a.length)return null;try{var d=b(a);return d instanceof Array?c(d):null}catch(e){return null}};
SpriteMorph.prototype.addVariable=function(a,b){var c=this.parentThatIsA(IDE_Morph);b?(this.globalVariables().addVar(a),c&&c.flushBlocksCache("variables")):(this.variables.addVar(a),this.blocksCache.variables=null)};SpriteMorph.prototype.deleteVariable=function(a){var b=this.parentThatIsA(IDE_Morph);contains(this.inheritedVariableNames(!0),a)||this.deleteVariableWatcher(a);this.variables.deleteVar(a);b&&(b.flushBlocksCache("variables"),b.refreshPalette())};
SpriteMorph.prototype.addCostume=function(a){a.name||(a.name="costume"+(this.costumes.length()+1));this.shadowAttribute("costumes");this.costumes.add(a)};
SpriteMorph.prototype.wearCostume=function(a,b){var c=this.xPosition?this.xPosition():null,d=this.yPosition?this.yPosition():null,e=isNil(a)?null:this.costumes.asArray().indexOf(a),f=this.isWarped;f&&this.endWarp();this.changed();this.costume=a;this.drawNew();this.changed();f&&this.startWarp();null!==c&&this.silentGotoXY(c,d,!0);this.positionTalkBubble&&this.positionTalkBubble();this.version=Date.now();b||this.shadowAttribute("costume #");this.specimens().forEach(function(b){b.cachedPropagation&&
b.inheritsAttribute("costume #")&&(null===e?b.wearCostume(null,!0):-1===e?b.wearCostume(a,!0):b.doSwitchToCostume(e+1,!0))})};SpriteMorph.prototype.getCostumeIdx=function(){return this.inheritsAttribute("costume #")?this.exemplar.getCostumeIdx():this.costumes.asArray().indexOf(this.costume)+1};SpriteMorph.prototype.doWearNextCostume=function(){var a=this.costumes.asArray();if(1<a.length){var b=a.indexOf(this.costume);-1<b&&(b+=1,b>a.length-1&&(b=0),this.wearCostume(a[b]))}};
SpriteMorph.prototype.doWearPreviousCostume=function(){var a=this.costumes.asArray();if(1<a.length){var b=a.indexOf(this.costume);-1<b&&(--b,0>b&&(b=a.length-1),this.wearCostume(a[b]))}};
SpriteMorph.prototype.doSwitchToCostume=function(a,b){if(a instanceof Costume)this.wearCostume(a,b);else{var c=this.costumes.asArray();if(contains([localize("Turtle"),localize("Empty")],a instanceof Array?a[0]:null))var d=null;else{if(-1===a){this.doWearPreviousCostume();return}d=detect(c,function(b){return b.name===a});null===d&&(d=parseFloat(a),d=0===d?null:c[d-1]||null)}this.wearCostume(d,b)}};SpriteMorph.prototype.reportCostumes=function(){return this.costumes};
SpriteMorph.prototype.addSound=function(a,b){this.shadowAttribute("sounds");this.sounds.add(new Sound(a,b))};SpriteMorph.prototype.playSound=function(a){var b=this.parentThatIsA(StageMorph),c=a instanceof Sound?a:detect(this.sounds.asArray(),function(b){return b.name===a});if(c)return c=c.play(),b&&(b.activeSounds.push(c),b.activeSounds=b.activeSounds.filter(function(a){return!a.ended&&!a.terminated})),c};SpriteMorph.prototype.reportSounds=function(){return this.sounds};
SpriteMorph.prototype.userMenu=function(){var a=this.parentThatIsA(IDE_Morph),b=new MenuMorph(this);if(a&&a.isAppMode)return b;this.isTemporary||(b.addItem("duplicate","duplicate"),StageMorph.prototype.enableInheritance&&(b.addItem("clone","instantiate"),b.addLine()));b.addItem("delete","remove");b.addItem("move","moveCenter");this.costume&&b.addItem("pivot","moveRotationCenter","edit the costume's\nrotation center");this.isTemporary?StageMorph.prototype.enableInheritance&&b.addItem("edit","perpetuateAndEdit",
"make permanent and\nshow in the sprite corral"):b.addItem("edit","edit");b.addLine();this.anchor&&b.addItem(localize("detach from")+" "+this.anchor.name,"detachFromAnchor");this.parts.length&&b.addItem("detach all parts","detachAllParts");b.addItem("export...","exportSprite");return b};SpriteMorph.prototype.exportSprite=function(){if(!this.isTemporary){var a=this.parentThatIsA(IDE_Morph);a&&a.exportSprite(this)}};
SpriteMorph.prototype.edit=function(){var a=this.parentThatIsA(IDE_Morph);a&&!a.isAppMode&&a.selectSprite(this)};SpriteMorph.prototype.showOnStage=function(){var a=this.parentThatIsA(StageMorph);a&&(this.keepWithin(a),a.add(this));this.show()};SpriteMorph.prototype.duplicate=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.duplicateSprite(this)};SpriteMorph.prototype.instantiate=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.instantiateSprite(this)};
SpriteMorph.prototype.remove=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.removeSprite(this)};SpriteMorph.prototype.createClone=function(a){var b=this.parentThatIsA(StageMorph);if(b&&5E3>=b.cloneCount){var c=this.fullCopy(!0);c.clonify(b,a)}return c};SpriteMorph.prototype.newClone=function(a){a=this.createClone(a);if(isNil(a))throw Error("exceeding maximum number of clones");return a};
SpriteMorph.prototype.clonify=function(a,b){var c=this;this.parts.forEach(function(b){b.clonify(a)});a.cloneCount+=1;this.cloneOriginName=this.isTemporary?this.cloneOriginName:this.name;this.isTemporary=!0;this.name="";a.add(this);this.allHatBlocksFor("__clone__init__").forEach(function(d){a.threads.startProcess(d,c,a.isThreadSafe,null,null,null,b)});this.endWarp()};
SpriteMorph.prototype.initClone=function(a){var b=this.parentThatIsA(StageMorph),c=this;b&&(a.forEach(function(a){b.threads.startProcess(a,c,b.isThreadSafe)}),this.endWarp())};SpriteMorph.prototype.removeClone=function(){var a=this.exemplar;this.isTemporary&&(this.parent.threads.stopAllForReceiver(this),this.corpsify(),this.instances.forEach(function(b){b.isTemporary&&b.setExemplar(a)}),this.destroy(),--this.parent.cloneCount)};
SpriteMorph.prototype.perpetuate=function(){var a=this.parentThatIsA(StageMorph),b=this.parentThatIsA(IDE_Morph);this.exemplar&&this.exemplar.perpetuate();this.isTemporary&&a&&b&&(this.isTemporary=!1,this.name=b.newSpriteName(this.cloneOriginName),this.cloneOriginName="",--a.cloneCount,b.corral.addSprite(this),b.sprites.add(this),this.parts.forEach(function(a){a.perpetuate()}))};SpriteMorph.prototype.perpetuateAndEdit=function(){var a=this.parentThatIsA(IDE_Morph);a&&(this.perpetuate(),a.selectSprite(this))};
SpriteMorph.prototype.release=function(){var a=this.parentThatIsA(StageMorph),b=this.parentThatIsA(IDE_Morph);if(!this.isTemporary&&this.exemplar&&a&&b){this.parts.forEach(function(a){a.release()});this.instances.forEach(function(a){a.release()});this.isTemporary=!0;this.name="";this.cloneOriginName=this.exemplar.name;a.cloneCount+=1;var c=b.sprites.asArray().indexOf(this)+1;a.watchers().forEach(function(a){a.object()===this&&a.destroy()});0<c&&b.sprites.remove(c);b.createCorral();b.fixLayout();b.currentSprite===
this&&(b.currentSprite=detect(a.children,function(a){return a instanceof SpriteMorph&&!a.isTemporary})||this.stage);b.selectSprite(b.currentSprite)}};SpriteMorph.prototype.corpsify=function(){this.isCorpse=!0;this.version=Date.now()};SpriteMorph.prototype.hide=function(){SpriteMorph.uber.hide.call(this);this.parts.forEach(function(a){a.hide()})};SpriteMorph.prototype.show=function(){SpriteMorph.uber.show.call(this);this.parts.forEach(function(a){a.show()})};
SpriteMorph.prototype.setColor=function(a){var b=this.xPosition(),c=this.yPosition();this.color.eq(a)||(this.color=a.copy(),this.costume||(this.drawNew(),this.silentGotoXY(b,c)))};SpriteMorph.prototype.getHue=function(){return 100*this.color.hsv()[0]};
SpriteMorph.prototype.setHue=function(a){var b=this.color.hsv(),c=this.xPosition(),d=this.yPosition();b[0]=Math.max(Math.min(+a||0,100),0)/100;b[1]=1;this.color.set_hsv.apply(this.color,b);this.costume||(this.drawNew(),this.changed());this.gotoXY(c,d)};SpriteMorph.prototype.changeHue=function(a){this.setHue(this.getHue()+(+a||0))};SpriteMorph.prototype.getBrightness=function(){return 100*this.color.hsv()[2]};
SpriteMorph.prototype.setBrightness=function(a){var b=this.color.hsv(),c=this.xPosition(),d=this.yPosition();b[1]=1;b[2]=Math.max(Math.min(+a||0,100),0)/100;this.color.set_hsv.apply(this.color,b);this.costume||(this.drawNew(),this.changed());this.gotoXY(c,d)};SpriteMorph.prototype.changeBrightness=function(a){this.setBrightness(this.getBrightness()+(+a||0))};SpriteMorph.prototype.comeToFront=function(){this.parent&&(this.parent.add(this),this.changed())};
SpriteMorph.prototype.goBack=function(a){var b=+a;if(!this.parent)return null;a=this.parent.children.indexOf(this);this.parent.removeChild(this);this.parent.children.splice(Math.max(a-b,0),null,this);this.parent.changed()};
SpriteMorph.prototype.overlappingImage=function(a){var b=this.bounds.intersect(a.bounds),c=newCanvas(b.extent(),!0),d=c.getContext("2d");if(1>b.width()||1>b.height())return newCanvas(new Point(1,1),!0);d.drawImage(this.image,this.left()-b.left(),this.top()-b.top());d.globalCompositeOperation="source-in";d.drawImage(a.image,a.left()-b.left(),a.top()-b.top());return c};
SpriteMorph.prototype.doStamp=function(){var a=this.parent,b=a.penTrails().getContext("2d"),c=this.isWarped,d=b.globalAlpha;c&&this.endWarp();b.save();b.scale(1/a.scale,1/a.scale);b.globalAlpha=this.alpha;b.drawImage(this.image,this.left()-a.left(),this.top()-a.top());b.globalAlpha=d;b.restore();this.changed();c&&this.startWarp()};SpriteMorph.prototype.clear=function(){this.parent.clearPenTrails()};SpriteMorph.prototype.setSize=function(a){isNaN(a)||(this.size=Math.min(Math.max(+a,1E-4),1E3))};
SpriteMorph.prototype.changeSize=function(a){this.setSize(this.size+(+a||0))};SpriteMorph.prototype.getScale=function(){return this.inheritsAttribute("size")?this.exemplar.getScale():100*this.scale};
SpriteMorph.prototype.setScale=function(a,b){var c=this.xPosition(),d=this.yPosition(),e=this.isWarped;e&&this.endWarp();var f=(+a||0)/100;var g=f/this.nestingScale;this.nestingScale=f;this.scale=Math.max(f,.01);this.changed();this.drawNew();this.changed();e&&this.startWarp();this.silentGotoXY(c,d,!0);this.positionTalkBubble();this.parts.forEach(function(a){var b=a.xPosition()-c,e=a.yPosition()-d;a.setScale(100*a.scale*g);a.silentGotoXY(c+b*g,d+e*g)});b||this.shadowAttribute("size");this.instances.forEach(function(b){b.cachedPropagation&&
b.inheritsAttribute("size")&&b.setScale(a,!0)})};SpriteMorph.prototype.changeScale=function(a){this.setScale(this.getScale()+(+a||0))};SpriteMorph.prototype.graphicsChanged=function(){var a=this;return Object.keys(this.graphicsValues).some(function(b){return 0>a.graphicsValues[b]||0<a.graphicsValues[b]})};
SpriteMorph.prototype.applyGraphicsEffects=function(a){function b(a,b){var c,d;var e=a.width;var f=a.height;a=a.data;var g=m.createImageData(e,f);var h=g.data;var k=e/2;var l=f/2;b=Math.max(0,(b+100)/100);for(d=0;d<f;d++)for(c=0;c<e;c++){var n=(c-k)/k;var p=(d-l)/l;var q=Math.pow(Math.sqrt(n*n+p*p),b);1>=q?(p=Math.atan2(p,n),n=Math.floor(k+q*Math.cos(p)*k),p=Math.floor(l+q*Math.sin(p)*l)):(n=c,p=d);q=4*(d*e+c);n=4*(p*e+n);h[q]=a[n];h[q+1]=a[n+1];h[q+2]=a[n+2];h[q+3]=a[n+3]}return g}function c(a,b){var c;
var d=a.width;var e=a.height;a=a.data;var f=m.createImageData(d,e);var g=f.data;var h=d/2;var k=e/2;var l=Math.min(h,k);if(d<e){var n=e/d;var p=1}else n=1,p=d/e;var q=-radians(b);var P=l*l;for(c=0;c<e;c++)for(b=0;b<d;b++){var x=n*(b-h);var A=p*(c-k);var u=x*x+A*A;if(u<P){u=1-Math.sqrt(u)/l;u*=q*u;var I=Math.sin(u);var B=Math.cos(u);u=Math.floor((B*x-I*A)/n+h);A=Math.floor((I*x+B*A)/p+k)}else u=b,A=c;x=4*(c*d+b);A=4*(A*d+u);g[x]=a[A];g[x+1]=a[A+1];g[x+2]=a[A+2];g[x+3]=a[A+3]}return f}function d(a,
b){var c,d;var e=a.width;var f=a.height;a=a.data;var g=m.createImageData(e,f);var h=g.data;b=Math.floor(Math.abs(b/10)+1);for(d=0;d<f;d++)for(c=0;c<e;c++){var k=Math.floor(c/b)*b;var l=Math.floor(d/b)*b;var n=4*(d*e+c);k=4*(l*e+k);h[n]=a[k];h[n+1]=a[k+1];h[n+2]=a[k+2];h[n+3]=a[k+3]}return g}function e(a,b){var c;var d=a.data;var e=m.createImageData(a.width,a.height);var f=e.data;b=Math.round((Math.abs(b)+10)/10);b=Math.max(0,Math.min(b,Math.min(a.width,a.height)));a=0;for(c=d.length;a<c;a+=4){var g=
a*b%c;f[a]=d[g];f[a+1]=d[g+1];f[a+2]=d[g+2];f[a+3]=d[g+3]}return e}function f(a,b){var c;var d=a.data;for(c=0;c<d.length;c+=4)d[c]=d[c*b],d[c+1]=d[c*b+1],d[c+2]=d[c*b+2],d[c+3]=d[c*b+3];return a}function g(a,b,c,d){var e;var f=a.data;var g=0;for(e=f.length;g<e;g+=4){var h=f[g];var k=f[g+1];var l=f[g+2];var m=Math.max(h,k,l);var n=Math.min(h,k,l);var p=m-n;if(0===p)var r=h=0;else m===h?r=60*(k-l)/p:m===k?r=120+60*(l-h)/p:m===l&&(r=240+60*(h-k)/p),h=(m-n)/m;0>r&&(r+=360);m/=255;r=(r+360*b/200)%360;
h=Math.max(0,Math.min(h+c/100,1));m=Math.max(0,Math.min(m+d/100,1));k=Math.floor(r/60);p=r/60-k;l=m*(1-h);n=m*(1-h*p);h=m*(1-h*(1-p));if(0===k||6===k){var q=m;var t=h;var u=l}else 1===k?(q=n,t=m,u=l):2===k?(q=l,t=m,u=h):3===k?(q=l,t=n,u=m):4===k?(q=h,t=l,u=m):5===k&&(q=m,t=l,u=n);f[g]=255*q;f[g+1]=255*t;f[g+2]=255*u}return a}function h(a,b){var c;var d=a.data;var e=0;for(c=d.length;e<c;e+=4){var f=255-d[e];var g=255-d[e+1];var h=255-d[e+2];d[e]<f?d[e]+=b:d[e]>f&&(d[e]-=b);d[e+1]<g?d[e+1]+=b:d[e+1]>
g&&(d[e+1]-=b);d[e+2]<h?d[e+2]+=b:d[e+2]>h&&(d[e+2]-=b)}return a}function k(a,b){var c;var d=a.data;var e=0;for(c=d.length;e<c;e+=4)d[e]+=127*Math.sin(e*b)+128,d[e+1]+=127*Math.sin(e*b)+128,d[e+2]+=127*Math.sin(e*b)+128;return a}function l(a,b){var c;var d=a.data;var e=0;for(c=d.length;e<c;e+=1)d[e]=127*Math.sin(b*d[e])+d[e];return a}if(this.graphicsChanged()){var m=a.getContext("2d");var n=m.getImageData(0,0,a.width,a.height);this.graphicsValues.fisheye&&(n=b(n,this.graphicsValues.fisheye));this.graphicsValues.whirl&&
(n=c(n,this.graphicsValues.whirl));this.graphicsValues.pixelate&&(n=d(n,this.graphicsValues.pixelate));this.graphicsValues.mosaic&&(n=e(n,this.graphicsValues.mosaic));this.graphicsValues.duplicate&&(n=f(n,this.graphicsValues.duplicate));if(this.graphicsValues.color||this.graphicsValues.saturation||this.graphicsValues.brightness)n=g(n,this.graphicsValues.color,this.graphicsValues.saturation,this.graphicsValues.brightness);this.graphicsValues.negative&&(n=h(n,this.graphicsValues.negative));this.graphicsValues.comic&&
(n=k(n,this.graphicsValues.comic));this.graphicsValues.confetti&&(n=l(n,this.graphicsValues.confetti));m.putImageData(n,0,0)}return a};SpriteMorph.prototype.setEffect=function(a,b){a=a instanceof Array?a[0]:null;"ghost"===a?this.alpha=1-Math.min(Math.max(+b||0,0),100)/100:this.graphicsValues[a]=+b;this.drawNew();this.changed()};SpriteMorph.prototype.getGhostEffect=function(){return 100*(1-this.alpha)};
SpriteMorph.prototype.changeEffect=function(a,b){var c=a instanceof Array?a[0]:null;"ghost"===c?this.setEffect(a,this.getGhostEffect()+(+b||0)):this.setEffect(a,+this.graphicsValues[c]+ +b)};SpriteMorph.prototype.clearEffects=function(){for(var a in this.graphicsValues)this.graphicsValues.hasOwnProperty(a)&&this.setEffect([a],0);this.setEffect(["ghost"],0)};SpriteMorph.prototype.stopTalking=function(){var a=this.talkBubble();a&&a.destroy()};
SpriteMorph.prototype.doThink=function(a){this.bubble(a,!0)};SpriteMorph.prototype.bubble=function(a,b,c){var d=this.parentThatIsA(StageMorph);this.stopTalking();""===a||isNil(a)||(a=new SpriteBubbleMorph(a,d,b,c),this.add(a),this.positionTalkBubble())};SpriteMorph.prototype.talkBubble=function(){return detect(this.children,function(a){return a instanceof SpeechBubbleMorph})};
SpriteMorph.prototype.positionTalkBubble=function(){var a=this.parentThatIsA(StageMorph),b=a?a.scale:1,c=this.talkBubble(),d=this.center().y;if(!c)return null;c.show();c.isPointingRight||(c.isPointingRight=!0,c.drawNew(),c.changed());c.setLeft(this.right());for(c.setBottom(this.top());!this.isTouching(c)&&c.bottom()<d;)c.silentMoveBy((new Point(-1,1)).scaleBy(b));if(!a)return null;c.right()>a.right()&&(c.isPointingRight=!1,c.drawNew(),c.setRight(this.center().x));c.keepWithin(a);c.changed()};
SpriteMorph.prototype.prepareToBeGrabbed=function(a){this.removeShadow();this.recordLayers();this.shadowAttribute("x position");this.shadowAttribute("y position");!this.bounds.containsPoint(a.position())&&this.isCorrectingOutsideDrag()&&this.setCenter(a.position());this.addShadow()};SpriteMorph.prototype.isCorrectingOutsideDrag=function(){return!this.parts.length};
SpriteMorph.prototype.justDropped=function(){var a=this.parentThatIsA(StageMorph),b=this;a&&(a.enableCustomHatBlocks=!0);this.exemplar&&this.inheritedAttributes.forEach(function(a){contains(["direction","size","costume #"],a)&&b.refreshInheritedAttribute(a)});this.restoreLayers();this.positionTalkBubble();this.receiveUserInteraction("dropped")};
SpriteMorph.prototype.drawLine=function(a,b){var c=this.parent.bounds.origin,d=this.parent.scale,e=this.parent.penTrails().getContext("2d");a=a.subtract(c).divideBy(d);b=b.subtract(c).divideBy(d);var f=a.multiplyBy(d).add(c);c=b.multiplyBy(d).add(c);d=f.rectangle(c).expandBy(Math.max(this.size*d/2,1)).intersect(this.parent.visibleBounds()).spread();this.isDown&&(e.lineWidth=this.size,e.strokeStyle=this.color.toString(),this.useFlatLineEnds?(e.lineCap="butt",e.lineJoin="miter"):(e.lineCap="round",
e.lineJoin="round"),e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(b.x,b.y),e.stroke(),!1===this.isWarped&&this.world().broken.push(d))};
SpriteMorph.prototype.floodFill=function(){function a(a){a*=4;return[g[a],g[a+1],g[a+2],g[a+3]]}function b(a){return a[0]===k[0]&&a[1]===k[1]&&a[2]===k[2]&&a[3]===k[3]}if(this.parent.bounds.containsPoint(this.rotationCenter())){1<this.color.a&&(this.color.a/=255);var c=normalizeCanvas(this.parent.penTrails()),d=c.width,e=c.height;c=c.getContext("2d");var f=c.getImageData(0,0,d,e),g=f.data,h=[Math.round(e/2-this.yPosition())*d+Math.round(this.xPosition()+d/2)];var k=a(h[0]);if(k[0]!==Math.round(this.color.r)||
k[1]!==Math.round(this.color.g)||k[2]!==Math.round(this.color.b)||k[3]!==Math.round(255*this.color.a)){for(;0<h.length;){var l=h.pop();b(a(l))&&(1<l%d&&(h.push(l+1),h.push(l-1)),0<l&&l<e*d&&(h.push(l+d),h.push(l-d)));g[4*l]=Math.round(this.color.r);g[4*l+1]=Math.round(this.color.g);g[4*l+2]=Math.round(this.color.b);g[4*l+3]=Math.round(255*this.color.a)}c.putImageData(f,0,0);this.parent.changed()}}};
SpriteMorph.prototype.reportPenTrailsAsCostume=function(){var a=new Costume(this.parentThatIsA(StageMorph).trailsCanvas,this.newCostumeName(localize("Costume")));a.shrinkWrap();return a};
SpriteMorph.prototype.moveBy=function(a,b){var c=this.isDown&&!b&&this.parent?this.rotationCenter():null;SpriteMorph.uber.moveBy.call(this,a);c&&this.drawLine(c,this.rotationCenter());b||(this.parts.forEach(function(b){b.moveBy(a)}),this.instances.forEach(function(b){if(b.cachedPropagation){var c=b.inheritsAttribute("x position"),d=b.inheritsAttribute("y position");c&&d?b.moveBy(a):c?b.moveBy(new Point(a.x,0)):d&&b.moveBy(new Point(0,a.y))}}))};
SpriteMorph.prototype.silentMoveBy=function(a,b){SpriteMorph.uber.silentMoveBy.call(this,a);!b&&this.parent instanceof HandMorph&&(this.parts.forEach(function(b){b.moveBy(a)}),this.instances.forEach(function(b){if(b.cachedPropagation){var c=b.inheritsAttribute("x position"),e=b.inheritsAttribute("y position");c&&e?b.moveBy(a):c?b.moveBy(new Point(a.x,0)):e&&b.moveBy(new Point(0,a.y))}}))};SpriteMorph.prototype.rootForGrab=function(){return this.anchor?this.anchor.rootForGrab():SpriteMorph.uber.rootForGrab.call(this)};
SpriteMorph.prototype.setCenter=function(a,b){a=a.subtract(this.center());this.moveBy(a,b)};SpriteMorph.prototype.nestingBounds=function(){var a=this.bounds;!this.costume&&this.penBounds&&(a=this.penBounds.translateBy(this.position()));this.parts.forEach(function(b){b.isVisible&&(a=a.merge(b.nestingBounds()))});return a};SpriteMorph.prototype.setPosition=function(a,b){a=a.subtract(this.topLeft());0===a.x&&0===a.y||this.moveBy(a,b)};
SpriteMorph.prototype.forward=function(a){a=a*this.parent.scale||0;a=0<=a?this.position().distanceAngle(a,this.heading):this.position().distanceAngle(Math.abs(a),this.heading-180);this.shadowAttribute("x position");this.shadowAttribute("y position");this.setPosition(a);this.positionTalkBubble()};
SpriteMorph.prototype.setHeading=function(a,b){var c=this.xPosition(),d=this.yPosition(),e=isFinite(a)?+a:0,f=e-this.heading;this.rotationStyle?(this.changed(),SpriteMorph.uber.setHeading.call(this,e),this.silentGotoXY(c,d,!0),this.positionTalkBubble()):this.heading=(+a%360+360)%360;this.parts.forEach(function(a){var b=(new Point(a.xPosition(),a.yPosition())).rotateBy(radians(f),new Point(c,d));a.rotatesWithAnchor&&a.turn(f);a.gotoXY(b.x,b.y)});b||this.shadowAttribute("direction");this.instances.forEach(function(b){b.cachedPropagation&&
b.inheritsAttribute("direction")&&b.setHeading(a,!0)})};SpriteMorph.prototype.faceToXY=function(a,b){a=(a-this.xPosition())*this.parent.scale;b=(b-this.yPosition())*this.parent.scale;this.setHeading((.001>Math.abs(a)?0>b?90:270:Math.round((0<=a?0:180)-57.2957795131*Math.atan(b/a)))+90)};SpriteMorph.prototype.turn=function(a){this.setHeading(this.heading+(+a||0))};SpriteMorph.prototype.turnLeft=function(a){this.setHeading(this.heading-(+a||0))};
SpriteMorph.prototype.xPosition=function(){if(this.inheritsAttribute("x position"))return this.exemplar.xPosition();var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(this.rotationCenter().x-a.center().x)/a.scale:this.rotationCenter().x};
SpriteMorph.prototype.yPosition=function(){if(this.inheritsAttribute("y position"))return this.exemplar.yPosition();var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(a.center().y-this.rotationCenter().y)/a.scale:this.rotationCenter().y};SpriteMorph.prototype.direction=function(){return this.inheritsAttribute("direction")?this.exemplar.direction():this.heading};SpriteMorph.prototype.penSize=function(){return this.size};
SpriteMorph.prototype.gotoXY=function(a,b,c,d){var e=this.parentThatIsA(StageMorph);e&&(d||(this.shadowAttribute("x position"),this.shadowAttribute("y position")),a=isFinite(+a)?+a:0,b=isFinite(+b)?+b:0,a=e.center().x+a*e.scale,b=e.center().y-b*e.scale,b=this.costume?(new Point(a,b)).subtract(this.rotationOffset):(new Point(a,b)).subtract(this.extent().divideBy(2)),this.setPosition(b,c),this.positionTalkBubble())};
SpriteMorph.prototype.silentGotoXY=function(a,b,c){var d=this.isDown;this.isDown=!1;this.gotoXY(a,b,c,!0);this.isDown=d};SpriteMorph.prototype.setXPosition=function(a){this.shadowAttribute("x position");this.gotoXY(+a||0,this.yPosition(),!1,!0)};SpriteMorph.prototype.changeXPosition=function(a){this.setXPosition(this.xPosition()+(+a||0))};SpriteMorph.prototype.setYPosition=function(a){this.shadowAttribute("y position");this.gotoXY(this.xPosition(),+a||0,!1,!0)};
SpriteMorph.prototype.changeYPosition=function(a){this.setYPosition(this.yPosition()+(+a||0))};SpriteMorph.prototype.glide=function(a,b,c,d,e){b=new Point(b,c);a=Math.max(Math.min(d/a,1),0);e=e.add(b.subtract(e).multiplyBy(a));this.gotoXY(e.x,e.y)};
SpriteMorph.prototype.bounceOffEdge=function(){var a=this.parentThatIsA(StageMorph),b=this.nestingBounds();if(!a||a.bounds.containsRectangle(b))return null;var c=Math.cos(radians(this.heading-90));var d=-Math.sin(radians(this.heading-90));b.left()<a.left()&&(c=Math.abs(c));b.right()>a.right()&&(c=-Math.abs(c));b.top()<a.top()&&(d=-Math.abs(d));b.bottom()>a.bottom()&&(d=Math.abs(d));this.shadowAttribute("x position");this.shadowAttribute("y position");this.shadowAttribute("direction");this.setHeading(degrees(Math.atan2(-d,
c))+90);this.setPosition(this.position().add(b.amountToTranslateWithin(a.bounds)));this.positionTalkBubble()};SpriteMorph.prototype.setRotationX=function(a){this.setRotationCenter(new Point(a,this.yPosition()))};SpriteMorph.prototype.setRotationY=function(a){this.setRotationCenter(new Point(this.xPosition(),a))};
SpriteMorph.prototype.setRotationCenter=function(a){if(!this.costume)throw Error("setting the rotation center requires a costume");a=a.subtract(new Point(this.xPosition(),this.yPosition())).divideBy(this.scale).rotateBy(radians(90-this.heading));a=this.costume.rotationCenter.add(new Point(a.x,-a.y));this.costume.rotationCenter=a;this.drawNew()};SpriteMorph.prototype.moveRotationCenter=function(){this.world().activeHandle=new HandleMorph(this,null,null,null,null,"movePivot")};
SpriteMorph.prototype.setPivot=function(a){var b=this.parentThatIsA(StageMorph);if(b){var c=b.center();this.setRotationCenter(new Point((a.x-c.x)/b.scale,(c.y-a.y)/b.scale))}};SpriteMorph.prototype.xCenter=function(){var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(this.center().x-a.center().x)/a.scale:this.center().x};
SpriteMorph.prototype.yCenter=function(){var a=this.parentThatIsA(StageMorph);!a&&this.parent.grabOrigin&&(a=this.parent.grabOrigin.origin);return a?(a.center().y-this.center().y)/a.scale:this.center().y};
SpriteMorph.prototype.allMessageNames=function(){var a=[],b=this.scripts.children.slice();this.customBlocks.forEach(function(a){a.body&&b.push(a.body.expression);a.scripts.forEach(function(a){b.push(a)})});this.globalBlocks&&this.globalBlocks.forEach(function(a){a.body&&b.push(a.body.expression);a.scripts.forEach(function(a){b.push(a)})});b.forEach(function(b){b.allChildren().forEach(function(b){b.selector&&contains(["receiveMessage","doBroadcast","doBroadcastAndWait"],b.selector)&&(b=b.inputs()[0].evaluate(),
isString(b)&&""!==b&&(contains(a,b)||a.push(b)))})});return a};SpriteMorph.prototype.allHatBlocksFor=function(a){"number"===typeof a&&(a=a.toString());return this.scripts.children.filter(function(b){if(b.selector){if("receiveMessage"===b.selector)return b=b.inputs()[0].evaluate(),b===a||b instanceof Array&&"__shout__go__"!==a&&"__clone__init__"!==a;if("receiveGo"===b.selector)return"__shout__go__"===a;if("receiveOnClone"===b.selector)return"__clone__init__"===a}return!1})};
SpriteMorph.prototype.allHatBlocksForKey=function(a){return this.scripts.children.filter(function(b){return b.selector&&"receiveKey"===b.selector?(b=b.inputs()[0].evaluate()[0],b===a||"any key"===b):!1})};SpriteMorph.prototype.allHatBlocksForInteraction=function(a){return this.scripts.children.filter(function(b){return b.selector&&"receiveInteraction"===b.selector?b.inputs()[0].evaluate()[0]===a:!1})};
SpriteMorph.prototype.allGenericHatBlocks=function(){return this.scripts.children.filter(function(a){return a.selector?"receiveCondition"===a.selector:!1})};SpriteMorph.prototype.mouseClickLeft=function(){return this.receiveUserInteraction("clicked")};SpriteMorph.prototype.mouseEnter=function(){return this.receiveUserInteraction("mouse-entered")};SpriteMorph.prototype.mouseDownLeft=function(){return this.receiveUserInteraction("pressed")};
SpriteMorph.prototype.receiveUserInteraction=function(a){var b=this.parentThatIsA(StageMorph),c=[],d=this;if(b)return this.allHatBlocksForInteraction(a).forEach(function(a){c.push(b.threads.startProcess(a,d,b.isThreadSafe))}),c};SpriteMorph.prototype.mouseDoubleClick=function(){this.isTemporary||this.edit()};SpriteMorph.prototype.getTimer=function(){var a=this.parentThatIsA(StageMorph);return a?a.getTimer():0};
SpriteMorph.prototype.getTempo=function(){var a=this.parentThatIsA(StageMorph);return a?a.getTempo():0};SpriteMorph.prototype.getLastMessage=function(){var a=this.parentThatIsA(StageMorph);return a?a.getLastMessage():""};SpriteMorph.prototype.getLastAnswer=function(){return this.parentThatIsA(StageMorph).lastAnswer};SpriteMorph.prototype.reportMouseX=function(){var a=this.parentThatIsA(StageMorph);return a?a.reportMouseX():0};
SpriteMorph.prototype.reportMouseY=function(){var a=this.parentThatIsA(StageMorph);return a?a.reportMouseY():0};SpriteMorph.prototype.reportThreadCount=function(){var a=this.parentThatIsA(StageMorph);return a?a.threads.processes.length:0};SpriteMorph.prototype.refactorVariableInstances=function(a,b,c){c&&this.hasSpriteVariable(a)||this.scripts.children.forEach(function(c){c instanceof BlockMorph&&c.refactorVarInStack(a,b)})};
SpriteMorph.prototype.findVariableWatcher=function(a){var b=this.parentThatIsA(StageMorph),c=this.globalVariables(),d=this;return null===b?null:detect(b.children,function(b){return b instanceof WatcherMorph&&(b.target===d.variables||b.target===c)&&b.getter===a})};
SpriteMorph.prototype.toggleVariableWatcher=function(a,b){var c=this.parentThatIsA(StageMorph),d=this.globalVariables();if(null===c)return null;var e=this.findVariableWatcher(a);if(null!==e)e.isVisible?e.hide():(e.show(),e.fixLayout(),e.keepWithin(c));else return isNil(b)&&(b=contains(d.names(),a)),e=new WatcherMorph(a,this.blockColor.variables,b?d:this.variables,a),e.setPosition(c.position().add(10)),a=c.watchers(e.left()),0<a.length&&e.setTop(a[a.length-1].bottom()),c.add(e),e.fixLayout(),e.keepWithin(c),
e};SpriteMorph.prototype.showingVariableWatcher=function(a){return null===this.parentThatIsA(StageMorph)?!1:(a=this.findVariableWatcher(a))?a.isVisible:!1};SpriteMorph.prototype.deleteVariableWatcher=function(a){if(null===this.parentThatIsA(StageMorph))return null;a=this.findVariableWatcher(a);null!==a&&a.destroy()};
SpriteMorph.prototype.toggleWatcher=function(a,b,c){var d=this.parentThatIsA(StageMorph),e;d&&((e=this.watcherFor(d,a))?e.isVisible?e.hide():(e.show(),e.fixLayout(),e.keepWithin(d)):(e=new WatcherMorph(b,c,WatcherMorph.prototype.isGlobal(a)?d:this,a),e.setPosition(d.position().add(10)),a=d.watchers(e.left()),0<a.length&&e.setTop(a[a.length-1].bottom()),d.add(e),e.fixLayout(),e.keepWithin(d)))};
SpriteMorph.prototype.showingWatcher=function(a){var b=this.parentThatIsA(StageMorph);return null===b?!1:(a=this.watcherFor(b,a))?a.isVisible:!1};SpriteMorph.prototype.watcherFor=function(a,b){var c=this;return detect(a.children,function(d){return d instanceof WatcherMorph&&d.getter===b&&d.target===(d.isGlobal(b)?a:c)})};
SpriteMorph.prototype.deleteAllBlockInstances=function(a){(a.isGlobal?this.allBlockInstances(a):this.allIndependentInvocationsOf(a.blockSpec())).forEach(function(a){a.deleteBlock()});if(a.isGlobal){if(a=this.parentThatIsA(StageMorph))a.globalBlocks.forEach(function(a){a.purgeCorpses()}),a.children.concat(a).forEach(function(a){a.isSnapObject&&a.customBlocks.forEach(function(a){a.purgeCorpses()})})}else this.allSpecimens().concat(this).forEach(function(a){a.customBlocks.forEach(function(a){a.purgeCorpses()})})};
SpriteMorph.prototype.allBlockInstances=function(a){var b=[];if(a.isGlobal){var c=this.parentThatIsA(StageMorph);var d=c.children.filter(function(a){return a instanceof SpriteMorph});d.push(c);d.forEach(function(c){b=b.concat(c.allLocalBlockInstances(a))});var e=[];c.globalBlocks.forEach(function(b){b.scripts.forEach(function(b){b.allChildren().forEach(function(b){b.isCustomBlock&&b.definition===a&&e.push(b)})});b.body&&b.body.expression.allChildren().forEach(function(b){b.isCustomBlock&&b.definition===
a&&e.push(b)})});return b.concat(e)}return this.allLocalBlockInstances(a)};SpriteMorph.prototype.allIndependentInvocationsOf=function(a){if(this.exemplar&&this.exemplar.getMethod(a))return[];var b=this.allInvocationsOf(a);this.instances.forEach(function(c){c.addAllInvocationsOf(a,b)});return b};SpriteMorph.prototype.allDependentInvocationsOf=function(a){var b=this.allInvocationsOf(a);this.instances.forEach(function(c){c.addAllInvocationsOf(a,b)});return b};
SpriteMorph.prototype.allInvocationsOf=function(a){var b=this.scripts.allChildren().filter(function(b){return b.isCustomBlock&&!b.isGlobal&&b.blockSpec===a});var c=[];this.customBlocks.forEach(function(b){b.scripts.forEach(function(b){b.allChildren().forEach(function(b){b.isCustomBlock&&!b.isGlobal&&b.blockSpec===a&&c.push(b)})});b.body&&b.body.expression.allChildren().forEach(function(b){b.isCustomBlock&&!b.isGlobal&&b.blockSpec===a&&c.push(b)})});var d=this.allEditorBlockInstances(null,a);return b.concat(c).concat(d)};
SpriteMorph.prototype.addAllInvocationsOf=function(a,b){this.getLocalMethod(a)||(this.allInvocationsOf(a).forEach(function(a){b.push(a)}),this.instances.forEach(function(c){c.addAllInvocationsOf(a,b)}))};
SpriteMorph.prototype.allLocalBlockInstances=function(a){var b=this.scripts.allChildren().filter(function(b){return b.isCustomBlock&&b.definition===a});var c=[];this.customBlocks.forEach(function(b){b.body&&b.body.expression.allChildren().forEach(function(b){b.isCustomBlock&&b.definition===a&&c.push(b)})});var d=this.allEditorBlockInstances(a);var e=this.paletteBlockInstance(a);b=b.concat(c).concat(d);e&&b.push(e);return b};
SpriteMorph.prototype.allEditorBlockInstances=function(a,b){var c=[];if(!this.world())return[];this.world().children.forEach(function(d){d instanceof BlockEditorMorph&&d.body.contents.allChildren().forEach(function(d){a?d.isPrototype||d instanceof PrototypeHatBlockMorph||d.definition!==a||c.push(d):!d.isCustomBlock||d.isGlobal||d.isPrototype||d instanceof PrototypeHatBlockMorph||d.blockSpec!==b||c.push(d)})});return c};
SpriteMorph.prototype.paletteBlockInstance=function(a){var b=this.parentThatIsA(IDE_Morph);return b?detect(b.palette.contents.children,function(b){return b.isCustomBlock&&b.definition===a}):null};
SpriteMorph.prototype.usesBlockInstance=function(a,b,c,d){if(detect(this.scripts.allChildren(),function(b){return b.isCustomBlock&&b.definition===a}))return!0;if(a.isGlobal&&!c){var e=[];this.parentThatIsA(StageMorph).globalBlocks.forEach(function(c){b&&a===c||d&&contains(d,c)||c.body&&c.body.expression.allChildren().forEach(function(b){b.isCustomBlock&&b.definition===a&&e.push(b)})});if(0<e.length)return!0}e=[];this.customBlocks.forEach(function(b){b.body&&b.body.expression.allChildren().forEach(function(b){b.isCustomBlock&&
b.definition===a&&e.push(b)})});return 0<e.length};SpriteMorph.prototype.doubleDefinitionsFor=function(a){var b=a.blockSpec();if(a.isGlobal){var c=this.parentThatIsA(StageMorph);if(!c)return[];c=c.globalBlocks}else c=this.customBlocks;var d=c.indexOf(a);return-1===d?[]:c.filter(function(a,c){return a.blockSpec()===b&&c!==d})};
SpriteMorph.prototype.replaceDoubleDefinitionsFor=function(a){var b=this.doubleDefinitionsFor(a),c=this;b.forEach(function(b){c.allBlockInstances(b).forEach(function(b){b.definition=a;b.refresh()})});if(a.isGlobal){var d=this.parentThatIsA(StageMorph);d.globalBlocks=d.globalBlocks.filter(function(a){return!contains(b,a)})}else this.customBlocks=this.customBlocks.filter(function(a){return!contains(b,a)});if(d=this.parentThatIsA(IDE_Morph))d.flushPaletteCache(),d.refreshPalette()};
SpriteMorph.prototype.chooseExemplar=function(){var a=this,b=this.parentThatIsA(StageMorph).children.filter(function(b){return b instanceof SpriteMorph&&!b.isTemporary&&!contains(b.allExemplars(),a)});var c=new MenuMorph(function(b){a.setExemplar(b)},localize("current parent")+":\n"+(this.exemplar?this.exemplar.name:localize("none")));b.forEach(function(a){c.addItem(a.name,a)});c.addLine();c.addItem(localize("none"),null);c.popUpAtHand(this.world())};
SpriteMorph.prototype.setExemplar=function(a){this.emancipate();(this.exemplar=a)?(this.variables.parentFrame=a.variables,a.addSpecimen(this)):this.variables.parentFrame=this.globalVariables();!this.isTemporary&&(a=this.parentThatIsA(IDE_Morph))&&(a.flushBlocksCache("variables"),a.refreshPalette())};SpriteMorph.prototype.prune=function(){this.instances.forEach(function(a){a.shadowAllAttributes();a.shadowAllMethods();a.shadowAllVars();a.exemplar=null});this.instances=[]};
SpriteMorph.prototype.emancipate=function(){this.exemplar&&(this.isTemporary||(this.shadowAllAttributes(),this.shadowAllMethods(),this.shadowAllVars()),this.exemplar.removeSpecimen(this),this.exemplar=null)};SpriteMorph.prototype.allExemplars=function(){for(var a=[],b=this;!isNil(b);)a.push(b),b=b.exemplar;return a};SpriteMorph.prototype.specimens=function(){return this.instances};
SpriteMorph.prototype.allSpecimens=function(){var a=this.instances.slice();this.instances.forEach(function(b){a.push.apply(a,b.allSpecimens())});return a};SpriteMorph.prototype.addSpecimen=function(a){this.instances.push(a)};SpriteMorph.prototype.removeSpecimen=function(a){a=this.instances.indexOf(a);-1!==a&&this.instances.splice(a,1)};SpriteMorph.prototype.inheritsAttribute=function(a){return!isNil(this.exemplar)&&contains(this.inheritedAttributes,a)};
SpriteMorph.prototype.updatePropagationCache=function(){var a=this;this.cachedPropagation=!isNil(this.exemplar)&&detect(["x position","y position","direction","size","costume #"],function(b){return contains(a.inheritedAttributes,b)})};SpriteMorph.prototype.shadowedAttributes=function(){var a=this.inheritedAttributes;return this.attributes.filter(function(b){return!contains(a,b)})};SpriteMorph.prototype.shadowAllAttributes=function(){var a=this;this.attributes.forEach(function(b){a.shadowAttribute(b)})};
SpriteMorph.prototype.shadowAttribute=function(a){var b=this;if(this.inheritsAttribute(a)){var c=this.parentThatIsA(IDE_Morph);this.inheritedAttributes=this.inheritedAttributes.filter(function(b){return b!==a});if("costumes"===a){var d=new List;this.costumes.asArray().forEach(function(a){var c=a.copy();d.add(c);a===b.costume&&b.wearCostume(c)});this.costumes=d;this.instances.forEach(function(a){a.inheritsAttribute("costumes")&&a.refreshInheritedAttribute("costumes")})}else if("sounds"===a){var e=
new List;this.sounds.asArray().forEach(function(a){e.add(a.copy())});this.sounds=e;this.instances.forEach(function(a){a.inheritsAttribute("sounds")&&a.refreshInheritedAttribute("sounds")})}else if("scripts"===a){c.stage.threads.stopAllForReceiver(this);var f=this.scripts.position();this.scripts=this.exemplar.scripts.fullCopy();c&&contains(c.currentSprite.allExemplars(),this)&&(c.createSpriteEditor(),c.fixLayout("selectSprite"),this.scripts.fixMultiArgs(),this.scripts.setPosition(f),c.spriteEditor.adjustScrollBars());
this.instances.forEach(function(a){a.inheritsAttribute("scripts")&&a.refreshInheritedAttribute("scripts")})}else this.updatePropagationCache(),c&&!this.isTemporary&&(c.flushBlocksCache(),c.refreshPalette())}};SpriteMorph.prototype.inheritAttribute=function(a){var b=this.parentThatIsA(IDE_Morph);this.exemplar&&contains(this.attributes,a)&&!this.inheritsAttribute(a)&&(this.inheritedAttributes.push(a),this.refreshInheritedAttribute(a),b&&(b.flushBlocksCache(),b.refreshPalette()))};
SpriteMorph.prototype.refreshInheritedAttribute=function(a){switch(a){case "x position":case "y position":this.cachedPropagation=!0;this.gotoXY(this.xPosition(),this.yPosition(),!1,!0);break;case "direction":this.cachedPropagation=!0;this.setHeading(this.direction(),!0);break;case "size":this.cachedPropagation=!0;this.setScale(this.getScale(),!0);break;case "costume #":this.cachedPropagation=!0;this.doSwitchToCostume(this.getCostumeIdx(),!0);break;case "costumes":a=this.getCostumeIdx();this.costumes=
this.exemplar.costumes;this.doSwitchToCostume(a,!0);this.instances.forEach(function(a){a.inheritsAttribute("costumes")&&a.refreshInheritedAttribute("costumes")});break;case "sounds":this.sounds=this.exemplar.sounds;this.instances.forEach(function(a){a.inheritsAttribute("sounds")&&a.refreshInheritedAttribute("sounds")});break;case "scripts":this.scripts=this.exemplar.scripts;if(a=this.parentThatIsA(IDE_Morph))a.stage.threads.stopAllForReceiver(this),contains(a.currentSprite.allExemplars(),this)&&(a.createSpriteEditor(),
a.fixLayout("selectSprite"));this.instances.forEach(function(a){a.inheritsAttribute("scripts")&&a.refreshInheritedAttribute("scripts")});break;default:nop()}};SpriteMorph.prototype.toggleInheritanceForAttribute=function(a){this.inheritsAttribute(a)?this.shadowAttribute(a):this.inheritAttribute(a)};SpriteMorph.prototype.isVariableNameInUse=function(a,b){return b?contains(this.variables.allNames(),a):contains(this.variables.names(),a)?!0:contains(this.globalVariables().names(),a)};
SpriteMorph.prototype.globalVariables=function(){for(var a=this.variables.parentFrame;a.owner;)a=a.parentFrame;return a};SpriteMorph.prototype.shadowAllVars=function(){var a=this;this.inheritedVariableNames().forEach(function(b){a.shadowVar(b,a.variables.getVar(b))})};SpriteMorph.prototype.shadowVar=function(a,b){this.variables.addVar(a,b);!this.isTemporary&&(a=this.parentThatIsA(IDE_Morph))&&(a.flushBlocksCache("variables"),a.refreshPalette())};
SpriteMorph.prototype.toggleInheritedVariable=function(a){contains(this.inheritedVariableNames(!0),a)?this.deleteVariable(a):contains(this.inheritedVariableNames(),a)&&this.shadowVar(a,this.variables.getVar(a))};SpriteMorph.prototype.inheritedVariableNames=function(a){function b(b){return a?contains(d,b):!contains(d,b)}for(var c=[],d=this.variables.names(),e=this.variables.parentFrame;e.owner instanceof SpriteMorph;)c.push.apply(c,e.names().filter(b)),e=e.parentFrame;return c};
SpriteMorph.prototype.deletableVariableNames=function(){var a=this.variables.names(),b=this.inheritedVariableNames();return a.concat(this.globalVariables().names().filter(function(c){return!contains(a,c)&&!contains(b,c)}))};SpriteMorph.prototype.hasSpriteVariable=function(a){return contains(this.variables.names(),a)};SpriteMorph.prototype.getMethod=function(a){return this.allBlocks()[a]};SpriteMorph.prototype.getLocalMethod=function(a){return this.ownBlocks()[a]};
SpriteMorph.prototype.ownBlocks=function(){var a={};this.customBlocks.forEach(function(b){a[b.blockSpec()]=b});return a};SpriteMorph.prototype.allBlocks=function(a){var b={};this.allExemplars().reverse().forEach(function(a){a.customBlocks.forEach(function(a){b[a.blockSpec()]=a})});return a?Object.keys(b).map(function(a){return b[a]}):b};
SpriteMorph.prototype.inheritedBlocks=function(a){var b={},c=Object.keys(this.ownBlocks()),d=this.allExemplars().reverse();d.pop();d.forEach(function(a){a.customBlocks.forEach(function(a){var d=a.blockSpec();contains(c,d)||(b[d]=a)})});return a?Object.keys(b).map(function(a){return b[a]}):b};
SpriteMorph.prototype.shadowAllMethods=function(){var a,b=this;this.inheritedMethods().forEach(function(a){b.customBlocks.push(a)});!this.isTemporary&&(a=this.parentThatIsA(IDE_Morph))&&(a.flushPaletteCache(),a.refreshPalette())};SpriteMorph.prototype.inheritedMethods=function(){var a=this;return this.inheritedBlocks(!0).map(function(b){return b.copyAndBindTo(a,!0)})};
SpriteMorph.prototype.thumbnail=function(a){function b(b,c,d){var e=Math.min(a.x,a.y)/10;h.strokeStyle=b;h.globalAlpha=c;h.compositeOperation="lighter";h.lineWidth=d||1;h.moveTo(e,e);h.lineTo(g.width-e,g.height-e);h.moveTo(e,g.height-e);h.lineTo(g.width-e,e);h.stroke()}var c=this.image,d=Math.min(a.x/c.width,a.y/c.height),e=(a.x-c.width*d)/2,f=(a.y-c.height*d)/2,g=newCanvas(a),h=g.getContext("2d");h.save();this.isCorpse&&(h.globalAlpha=.3);c.width&&c.height&&(h.scale(d,d),h.drawImage(c,Math.floor(e/
d),Math.floor(f/d)));this.isCorpse&&(h.restore(),b("white",.8,6),b("black",.8,1));return g};SpriteMorph.prototype.fullThumbnail=function(a){var b=this.thumbnail(a),c=b.getContext("2d"),d=a.divideBy(3),e;c.restore();this.anchor&&c.drawImage(this.anchor.thumbnail(d),0,0);for(e=0;3>e;e+=1)this.parts[e]&&c.drawImage(this.parts[e].thumbnail(d),e*d.x,a.y-d.y);return b};SpriteMorph.prototype.booleanMorph=function(a){a=new BooleanSlotMorph(a);a.isStatic=!0;a.drawNew();return a};
SpriteMorph.prototype.attachPart=function(a){var b=Date.now();a.anchor&&a.anchor.detachPart(a);this.parts.push(a);this.version=b;a.anchor=this;this.allParts().forEach(function(a){a.nestingScale=a.scale});a.version=b};SpriteMorph.prototype.detachPart=function(a){var b=this.parts.indexOf(a);if(-1!==b){var c=Date.now();this.parts.splice(b,1);this.version=c;a.anchor=null;a.version=c}};
SpriteMorph.prototype.detachAllParts=function(){var a=Date.now();this.parts.forEach(function(b){b.anchor=null;b.version=a});this.parts=[];this.version=a};SpriteMorph.prototype.detachFromAnchor=function(){this.anchor&&this.anchor.detachPart(this)};SpriteMorph.prototype.allParts=function(){var a=[this];this.parts.forEach(function(b){a=a.concat(b.allParts())});return a};SpriteMorph.prototype.allAnchors=function(){var a=[this];null!==this.anchor&&(a=a.concat(this.anchor.allAnchors()));return a};
SpriteMorph.prototype.recordLayers=function(){var a=this.parentThatIsA(StageMorph);a?(this.layers=this.allParts(),this.layers.forEach(function(a){(a=a.talkBubble())&&a.hide()}),this.layers.sort(function(b,c){return a.children.indexOf(b)<a.children.indexOf(c)?-1:1})):this.layerCache=null};SpriteMorph.prototype.restoreLayers=function(){this.layers&&1<this.layers.length&&this.layers.forEach(function(a){a.comeToFront();a.positionTalkBubble()});this.layers=null};
SpriteMorph.prototype.destroy=function(){this.anchor&&this.anchor.detachPart(this);this.emancipate();this.isTemporary||this.prune();SpriteMorph.uber.destroy.call(this)};SpriteMorph.prototype.flash=function(){var a=this.world(),b=this;this.addHighlight();a.animations.push(new Animation(nop,nop,0,800,nop,function(){b.removeHighlight()}))};
SpriteMorph.prototype.addHighlight=function(a){var b=!this.isVisible;b&&this.show();a=this.highlight(a?a.color:this.highlightColor,this.highlightBorder);this.addBack(a);this.fullChanged();b&&this.hide();return a};SpriteMorph.prototype.removeHighlight=function(){var a=this.getHighlight();null!==a&&(this.fullChanged(),this.removeChild(a));return a};SpriteMorph.prototype.toggleHighlight=function(){this.getHighlight()?this.removeHighlight():this.addHighlight()};
SpriteMorph.prototype.highlight=function(a,b){var c=new SpriteHighlightMorph,d=this.bounds;c.setExtent(d.extent().add(2*b));c.color=a;c.image=this.highlightImage(a,b);a=c.image.getContext("2d");a.drawImage(this.highlightImage(new Color(255,255,255),4),b-4,b-4);a.drawImage(this.highlightImage(new Color(50,50,50),2),b-2,b-2);a.drawImage(this.highlightImage(new Color(255,255,255),1),b-1,b-1);c.setPosition(d.origin.subtract(new Point(b,b)));return c};
SpriteMorph.prototype.highlightImage=function(a,b){var c=this.extent();var d=this.image;var e=newCanvas(c.add(2*b));var f=e.getContext("2d");f.drawImage(d,0,0);f.drawImage(d,b,0);f.drawImage(d,2*b,0);f.drawImage(d,2*b,b);f.drawImage(d,2*b,2*b);f.drawImage(d,b,2*b);f.drawImage(d,0,2*b);f.drawImage(d,0,b);f.globalCompositeOperation="destination-out";f.drawImage(d,b,b);b=newCanvas(c.add(2*b));f=b.getContext("2d");f.drawImage(e,0,0);f.globalCompositeOperation="source-atop";f.fillStyle=a.toString();f.fillRect(0,
0,b.width,b.height);return b};SpriteMorph.prototype.getHighlight=function(){var a=this.children.slice(0).reverse().filter(function(a){return a instanceof SpriteHighlightMorph});return 0!==a.length?a[0]:null};SpriteMorph.prototype.mouseEnterDragging=function(){if(this.enableNesting){var a=this.world().hand.children[0];this.wantsDropOf(a)&&this.addHighlight()}};SpriteMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed");this.enableNesting&&this.removeHighlight()};
SpriteMorph.prototype.wantsDropOf=function(a){return this.enableNesting&&a instanceof SpriteIconMorph&&!contains(a.object.allParts(),this)};SpriteMorph.prototype.reactToDropOf=function(a,b){this.removeHighlight();this.attachPart(a.object);this.world().add(a);a.slideBackTo(b.grabOrigin)};
SpriteMorph.prototype.newCostumeName=function(a,b){var c=a.indexOf("(");a=0>c?a:a.substring(0,c);c=1;for(var d=a,e=this.costumes.asArray().filter(function(a){return a!==b}).map(function(a){return a.name});contains(e,d);)c+=1,d=a+"("+c+")";return d};
SpriteMorph.prototype.doScreenshot=function(a,b){var c=this.parentThatIsA(StageMorph);b=this.newCostumeName(b);if(void 0!==a[0]){if("pen trails"===a[0]){a=c.trailsCanvas;var d=(new Costume(a,b)).copy()}else"stage image"===a[0]&&(a=c.fullImageClassic(),d=new Costume(a,b));this.addCostume(d)}};SpriteHighlightMorph.prototype=new Morph;SpriteHighlightMorph.prototype.constructor=SpriteHighlightMorph;SpriteHighlightMorph.uber=Morph.prototype;function SpriteHighlightMorph(){this.init()}
StageMorph.prototype=new FrameMorph;StageMorph.prototype.constructor=StageMorph;StageMorph.uber=FrameMorph.prototype;StageMorph.prototype.dimensions=new Point(480,360);StageMorph.prototype.frameRate=0;StageMorph.prototype.isCachingPrimitives=SpriteMorph.prototype.isCachingPrimitives;StageMorph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.hiddenPrimitives={};
StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=!1;StageMorph.prototype.enableInheritance=!0;StageMorph.prototype.enableSublistIDs=!1;function StageMorph(a){this.init(a)}
StageMorph.prototype.init=function(a){this.name=localize("Stage");this.instrument=null;this.threads=new ThreadManager;this.variables=new VariableFrame(a||null,this);this.scripts=new ScriptsMorph;this.customBlocks=[];this.globalBlocks=[];this.costumes=new List;this.costume=null;this.sounds=new List;this.version=Date.now();this.isFastTracked=!1;this.enableCustomHatBlocks=!0;this.cloneCount=0;this.timerStart=Date.now();this.tempo=60;this.lastMessage="";this.watcherUpdateFrequency=2;this.lastWatcherUpdate=
Date.now();this.scale=1;this.keysPressed={};this.blocksCache={};this.paletteCache={};this.lastAnswer="";this.activeSounds=[];this.trailsCanvas=null;this.isThreadSafe=!1;this.graphicsValues={color:0,fisheye:0,whirl:0,pixelate:0,mosaic:0,duplicate:0,negative:0,comic:0,confetti:0,saturation:0,brightness:0};StageMorph.uber.init.call(this);this.acceptsDrops=!1;this.setColor(new Color(255,255,255));this.fps=this.frameRate};
StageMorph.prototype.setScale=function(a){var b=a/this.scale,c=this.position(),d,e,f=Morph.prototype.trackChanges,g=this;1!==b&&(Morph.prototype.trackChanges=!1,this.scale=a,this.setExtent(this.dimensions.multiplyBy(a)),this.children.forEach(function(f){d=f.position().subtract(c);f.drawNew();f.setPosition(d.multiplyBy(b).add(c),!0);if(f instanceof SpriteMorph){if(e=f.talkBubble())e.setScale(a),f.positionTalkBubble()}else f instanceof StagePrompterMorph&&(1>g.scale?f.setWidth(g.width()-10):f.setWidth(g.dimensions.x-
20),f.fixLayout(),f.setCenter(g.center()),f.setBottom(g.bottom()))}),Morph.prototype.trackChanges=f,this.changed())};StageMorph.prototype.drawNew=function(){StageMorph.uber.drawNew.call(this);if(this.costume){var a=this.image.getContext("2d");a.scale(this.scale,this.scale);a.drawImage(this.costume.contents,(this.width()/this.scale-this.costume.width())/2,(this.height()/this.scale-this.costume.height())/2);this.image=this.applyGraphicsEffects(this.image)}this.version=Date.now()};
StageMorph.prototype.drawOn=function(a,b){if(!this.isVisible)return null;b=(b||this.bounds).intersect(this.bounds);if(b.extent().gt(new Point(0,0))){var c=this.position().neg();var d=b.copy().translateBy(c);a=a.getContext("2d");a.globalAlpha=this.alpha;c=d.left();var e=d.top();var f=Math.min(d.width(),this.image.width-c);d=Math.min(d.height(),this.image.height-e);if(1>f||1>d)return null;a.drawImage(this.image,c,e,f,d,b.left(),b.top(),f,d);f/=this.scale;d/=this.scale;a.save();a.scale(this.scale,this.scale);
try{a.drawImage(this.penTrails(),c/this.scale,e/this.scale,f,d,b.left()/this.scale,b.top()/this.scale,f,d)}catch(g){a.restore(),a.drawImage(this.penTrails(),0,0,this.dimensions.x,this.dimensions.y,this.left(),this.top(),this.dimensions.x*this.scale,this.dimensions.y*this.scale)}a.restore()}};StageMorph.prototype.clearPenTrails=function(){this.trailsCanvas=newCanvas(this.dimensions);this.changed()};
StageMorph.prototype.penTrails=function(){this.trailsCanvas||(this.trailsCanvas=newCanvas(this.dimensions));return this.trailsCanvas};StageMorph.prototype.penTrailsMorph=function(){var a=new Morph,b=this.penTrails();a.bounds=this.bounds.copy();a.image=newCanvas(this.extent());a.image.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,this.image.width,this.image.height);return a};
StageMorph.prototype.colorFiltered=function(a,b){var c=new Morph,d=this.extent();b=this.thumbnail(d,b);var e;var f=normalizeCanvas(b,!0).getContext("2d").getImageData(0,0,d.x,d.y);c.bounds=this.bounds.copy();c.image=newCanvas(d,!0);b=c.image.getContext("2d");var g=b.createImageData(d.x,d.y);for(e=0;e<d.x*d.y*4;e+=4){var h=new Color(f.data[e],f.data[e+1],f.data[e+2]);h.eq(a)&&(g.data[e]=f.data[e],g.data[e+1]=f.data[e+1],g.data[e+2]=f.data[e+2],g.data[e+3]=255)}b.putImageData(g,0,0);return c};
StageMorph.prototype.watchers=function(a){return this.children.filter(function(b){return b instanceof WatcherMorph?a?b.left()===a:b.isVisible:!1})};StageMorph.prototype.resetTimer=function(){this.timerStart=Date.now()};StageMorph.prototype.getTimer=function(){return Math.floor((Date.now()-this.timerStart)/100)/10};StageMorph.prototype.setTempo=function(a){this.tempo=Math.max(20,+a||0)};StageMorph.prototype.changeTempo=function(a){this.setTempo(this.getTempo()+(+a||0))};
StageMorph.prototype.getTempo=function(){return+this.tempo};StageMorph.prototype.getLastMessage=function(){return this.lastMessage||""};StageMorph.prototype.reportMouseX=function(){var a=this.world();return a?(a.hand.position().x-this.center().x)/this.scale:0};StageMorph.prototype.reportMouseY=function(){var a=this.world();return a?(this.center().y-a.hand.position().y)/this.scale:0};
StageMorph.prototype.wantsDropOf=function(a){return a instanceof SpriteMorph||a instanceof WatcherMorph||a instanceof ListWatcherMorph||a instanceof SpriteIconMorph};StageMorph.prototype.reactToDropOf=function(a,b){a instanceof SpriteIconMorph&&(a.object.anchor&&a.object.anchor.detachPart(a.object),this.world().add(a),a.slideBackTo(b.grabOrigin))};
StageMorph.prototype.step=function(){var a=this.world();null===a.keyboardReceiver&&(a.keyboardReceiver=this);null===a.currentKey&&(this.keyPressed=null);this.enableCustomHatBlocks&&this.stepGenericConditions();if(this.isFastTracked&&this.threads.processes.length){for(this.children.forEach(function(a){a instanceof SpriteMorph&&((a.wasWarped=a.isWarped)||a.startWarp())});17>Date.now()-this.lastTime;)this.threads.step();this.children.forEach(function(a){a instanceof SpriteMorph&&(a.wasWarped||a.endWarp())});
this.changed()}else this.threads.step(),this.threads.wantsToPause&&(a=this.parentThatIsA(IDE_Morph))&&a.controlBar.pauseButton.refresh();a=Date.now()-this.lastWatcherUpdate;1>1E3/this.watcherUpdateFrequency-a&&(this.watchers().forEach(function(a){a.update()}),this.lastWatcherUpdate=Date.now())};
StageMorph.prototype.stepGenericConditions=function(a){var b=0,c=this,d;this.children.concat(this).forEach(function(d){isSnapObject(d)&&d.allGenericHatBlocks().forEach(function(e){b+=1;c.threads.doWhen(e,d,a)})});b||(this.enableCustomHatBlocks=!1,(d=this.parentThatIsA(IDE_Morph))&&d.controlBar.stopButton.refresh())};
StageMorph.prototype.developersMenu=function(){var a=this,b=StageMorph.uber.developersMenu.call(this);b.addItem("stop",function(){a.threads.stopAll()},"terminate all running threads");return b};StageMorph.prototype.processKeyDown=function(a){this.processKeyEvent(a,this.fireKeyEvent)};StageMorph.prototype.processKeyUp=function(a){this.processKeyEvent(a,this.removePressedKey)};
StageMorph.prototype.processKeyEvent=function(a,b){switch(a.keyCode){case 13:var c="enter";a.ctrlKey||a.metaKey?c="ctrl enter":a.shiftKey&&(c="shift enter");break;case 27:c="esc";break;case 32:c="space";break;case 37:c="left arrow";break;case 39:c="right arrow";break;case 38:c="up arrow";break;case 40:c="down arrow";break;default:if(c=String.fromCharCode(a.keyCode||a.charCode),a.ctrlKey||a.metaKey)c="ctrl "+(a.shiftKey?"shift ":"")+c}b.call(this,c)};
StageMorph.prototype.fireKeyEvent=function(a){var b=a.toLowerCase(),c=[];a=this.parentThatIsA(IDE_Morph);var d=this;this.keysPressed[b]=!0;if("ctrl enter"===b)return this.fireGreenFlagEvent();if("shift enter"===b)return this.editScripts();if("ctrl f"===b)a.isAppMode||a.currentSprite.searchBlocks();else if("ctrl z"===b)a.isAppMode||a.currentSprite.scripts.undrop();else if("ctrl shift z"===b||"ctrl y"===b)a.isAppMode||a.currentSprite.scripts.redrop();else if("ctrl n"===b)a.isAppMode||a.createNewProject();
else if("ctrl o"===b)a.isAppMode||a.openProjectsBrowser();else if("ctrl s"===b)a.isAppMode||a.save();else if("ctrl shift s"===b){if(!a.isAppMode)return a.saveProjectsBrowser()}else{if("esc"===b)return this.fireStopAllEvent();this.children.concat(this).forEach(function(a){isSnapObject(a)&&a.allHatBlocksForKey(b).forEach(function(b){c.push(d.threads.startProcess(b,a,d.isThreadSafe))})});return c}};StageMorph.prototype.removePressedKey=function(a){delete this.keysPressed[a.toLowerCase()]};
StageMorph.prototype.processKeyPress=function(a){nop(a)};StageMorph.prototype.inspectKeyEvent=CursorMorph.prototype.inspectKeyEvent;StageMorph.prototype.fireGreenFlagEvent=function(){var a=[],b=this.parentThatIsA(IDE_Morph),c=this;this.children.concat(this).forEach(function(b){isSnapObject(b)&&b.allHatBlocksFor("__shout__go__").forEach(function(d){a.push(c.threads.startProcess(d,b,c.isThreadSafe))})});b&&b.controlBar.pauseButton.refresh();return a};
StageMorph.prototype.fireStopAllEvent=function(){var a=this.parentThatIsA(IDE_Morph);this.threads.resumeAll(this.stage);this.keysPressed={};this.threads.stopAll();this.stopAllActiveSounds();this.children.forEach(function(a){a.stopTalking&&a.stopTalking()});this.removeAllClones();a&&a.nextSteps([nop,function(){a.controlBar.pauseButton.refresh()}])};
StageMorph.prototype.removeAllClones=function(){var a=this;this.children.filter(function(a){return a instanceof SpriteMorph&&a.isTemporary}).forEach(function(b){a.threads.stopAllForReceiver(b);b.detachFromAnchor();b.corpsify();b.destroy()});this.cloneCount=0};
StageMorph.prototype.editScripts=function(){if(!this.parentThatIsA(IDE_Morph).isAppMode&&ScriptsMorph.prototype.enableKeyboard){var a=this.parentThatIsA(IDE_Morph).currentSprite.scripts.selectForEdit();a.edit(a.position());var b=a.focus.sortedScripts();b.length?(a.focus.element=b[0],a.focus.element instanceof HatBlockMorph&&a.focus.nextCommand()):a.focus.moveBy(new Point(50,50));a.focus.fixLayout()}};
StageMorph.prototype.blockTemplates=function(a){function b(a){if(h.hiddenPrimitives[a])return null;a=SpriteMorph.prototype.blockForSelector(a,!0);a.isTemplate=!0;return a}function c(a){a=SpriteMorph.prototype.variableBlock(a);a.isDraggable=!1;a.isTemplate=!0;return a}function d(a){if(h.hiddenPrimitives[a])return null;var b=SpriteMorph.prototype.blocks[a];return new ToggleMorph("checkbox",this,function(){h.toggleWatcher(a,localize(b.spec),h.blockColor[b.category])},null,function(){return h.showingWatcher(a)},
null)}function e(a){return new ToggleMorph("checkbox",this,function(){h.toggleVariableWatcher(a)},null,function(){return h.showingVariableWatcher(a)},null)}function f(a){a&&(h.isVariableNameInUse(a[0])?h.inform("that name is already in use"):(h.addVariable(a[0],a[1]),h.toggleVariableWatcher(a[0],a[1]),h.blocksCache[k]=null,h.paletteCache[k]=null,h.parentThatIsA(IDE_Morph).refreshPalette()))}var g=[],h=this,k=a||"motion";"motion"===k?(a=new TextMorph(localize("Stage selected:\nno motion primitives")),
a.fontSize=9,a.setColor(this.paletteTextColor),g.push(a),g.push("="),g.push(this.makeBlockButton(k))):"looks"===k?(g.push(b("doSwitchToCostume")),g.push(b("doWearNextCostume")),g.push(d("getCostumeIdx")),g.push(b("getCostumeIdx")),g.push("-"),g.push(b("changeEffect")),g.push(b("setEffect")),g.push(b("clearEffects")),g.push("-"),g.push(b("show")),g.push(b("hide")),this.world().isDevMode&&(g.push("-"),a=new TextMorph(localize("development mode \ndebugging primitives:")),a.fontSize=9,a.setColor(this.paletteTextColor),
g.push(a),g.push("-"),g.push(b("log")),g.push(b("alert")),g.push("-"),g.push(b("doScreenshot"))),g.push("="),g.push(this.makeBlockButton(k))):"sound"===k?(g.push(b("playSound")),g.push(b("doPlaySoundUntilDone")),g.push(b("doStopAllSounds")),g.push("-"),g.push(b("doRest")),g.push(b("doPlayNote")),g.push(b("doSetInstrument")),g.push("-"),g.push(b("doChangeTempo")),g.push(b("doSetTempo")),g.push(d("getTempo")),g.push(b("getTempo")),g.push("="),g.push(this.makeBlockButton(k))):"pen"===k?(g.push(b("clear")),
g.push(b("reportPenTrailsAsCostume")),g.push("="),g.push(this.makeBlockButton(k))):"control"===k?(g.push(b("receiveGo")),g.push(b("receiveKey")),g.push(b("receiveInteraction")),g.push(b("receiveCondition")),g.push(b("receiveMessage")),g.push("-"),g.push(b("doBroadcast")),g.push(b("doBroadcastAndWait")),g.push(d("getLastMessage")),g.push(b("getLastMessage")),g.push("-"),g.push(b("doWarp")),g.push("-"),g.push(b("doWait")),g.push(b("doWaitUntil")),g.push("-"),g.push(b("doForever")),g.push(b("doRepeat")),
g.push(b("doUntil")),g.push("-"),g.push(b("doIf")),g.push(b("doIfElse")),g.push("-"),g.push(b("doReport")),g.push(b("doStopThis")),g.push(b("doStopOthers")),g.push("-"),g.push(b("doRun")),g.push(b("fork")),g.push(b("evaluate")),g.push("-"),g.push(b("doTellTo")),g.push(b("reportAskFor")),g.push("-"),g.push(b("doCallCC")),g.push(b("reportCallCC")),g.push("-"),g.push(b("createClone")),g.push(b("newClone")),g.push("-"),g.push(b("doPauseAll")),g.push("="),g.push(this.makeBlockButton(k))):"sensing"===k?
(g.push(b("doAsk")),g.push(d("getLastAnswer")),g.push(b("getLastAnswer")),g.push("-"),g.push(d("reportMouseX")),g.push(b("reportMouseX")),g.push(d("reportMouseY")),g.push(b("reportMouseY")),g.push(b("reportMouseDown")),g.push("-"),g.push(b("reportKeyPressed")),g.push("-"),g.push(b("doResetTimer")),g.push(d("getTimer")),g.push(b("getTimer")),g.push("-"),g.push(b("reportAttributeOf")),SpriteMorph.prototype.enableFirstClass&&g.push(b("reportGet")),g.push("-"),g.push(b("reportURL")),g.push("-"),g.push(b("reportIsFastTracking")),
g.push(b("doSetFastTracking")),g.push("-"),g.push(b("reportDate")),this.world().isDevMode&&(g.push("-"),a=new TextMorph(localize("development mode \ndebugging primitives:")),a.fontSize=9,a.setColor(this.paletteTextColor),g.push(a),g.push("-"),g.push(d("reportThreadCount")),g.push(b("reportThreadCount")),g.push(b("colorFiltered")),g.push(b("reportStackSize")),g.push(b("reportFrameCount"))),g.push("="),g.push(this.makeBlockButton(k))):"operators"===k?(g.push(b("reifyScript")),g.push(b("reifyReporter")),
g.push(b("reifyPredicate")),g.push("#"),g.push("-"),g.push(b("reportSum")),g.push(b("reportDifference")),g.push(b("reportProduct")),g.push(b("reportQuotient")),g.push("-"),g.push(b("reportModulus")),g.push(b("reportRound")),g.push(b("reportMonadic")),g.push(b("reportRandom")),g.push("-"),g.push(b("reportLessThan")),g.push(b("reportEquals")),g.push(b("reportGreaterThan")),g.push("-"),g.push(b("reportAnd")),g.push(b("reportOr")),g.push(b("reportNot")),g.push(b("reportBoolean")),g.push("-"),g.push(b("reportJoinWords")),
g.push(b("reportTextSplit")),g.push(b("reportLetter")),g.push(b("reportStringSize")),g.push("-"),g.push(b("reportUnicode")),g.push(b("reportUnicodeAsLetter")),g.push("-"),g.push(b("reportIsA")),g.push(b("reportIsIdentical")),g.push("-"),g.push(b("reportJSFunction")),this.world().isDevMode&&(g.push("-"),a=new TextMorph("development mode \ndebugging primitives:"),a.fontSize=9,a.setColor(this.paletteTextColor),g.push(a),g.push("-"),g.push(b("reportTypeOf")),g.push(b("reportTextFunction"))),g.push("="),
g.push(this.makeBlockButton(k))):"variables"===k&&(a=new PushButtonMorph(null,function(){(new VariableDialogMorph(null,f,h)).prompt("Variable name",null,h.world())},"Make a variable"),g.push(a),0<this.variables.allNames().length&&(a=new PushButtonMorph(null,function(){var a=new MenuMorph(h.deleteVariable,null,h);h.variables.allNames().forEach(function(b){a.addItem(b,b)});a.popUpAtHand(h.world())},"Delete a variable"),g.push(a)),g.push("-"),a=this.variables.allNames(),0<a.length&&(a.forEach(function(a){g.push(e(a));
g.push(c(a))}),g.push("-")),g.push(b("doSetVar")),g.push(b("doChangeVar")),g.push(b("doShowVar")),g.push(b("doHideVar")),g.push(b("doDeclareVariables")),g.push("="),g.push(b("reportNewList")),g.push("-"),g.push(b("reportCONS")),g.push(b("reportListItem")),g.push(b("reportCDR")),g.push("-"),g.push(b("reportListLength")),g.push(b("reportListContainsItem")),g.push("-"),g.push(b("doAddToList")),g.push(b("doDeleteFromList")),g.push(b("doInsertInList")),g.push(b("doReplaceInList")),this.world().isDevMode&&
(g.push("-"),a=new TextMorph(localize("development mode \ndebugging primitives:")),a.fontSize=9,a.setColor(this.paletteTextColor),g.push(a),g.push("-"),g.push(b("reportMap")),g.push("-"),g.push(b("doForEach")),g.push(b("doShowTable"))),g.push("="),StageMorph.prototype.enableCodeMapping&&(g.push(b("doMapCodeOrHeader")),g.push(b("doMapValueCode")),g.push(b("doMapListCode")),g.push("-"),g.push(b("reportMappedCode")),g.push("=")),g.push(this.makeBlockButton()));return g};StageMorph.prototype.clear=function(){this.clearPenTrails()};
StageMorph.prototype.userMenu=function(){var a=this.parentThatIsA(IDE_Morph),b=new MenuMorph(this),c=this;if(a&&a.isAppMode)return b;b.addItem("edit","edit");b.addItem("show all","showAll");b.addItem("pic...",function(){a.saveCanvasAs(c.fullImageClassic(),c.name)},"open a new window\nwith a picture of the stage");b.addLine();b.addItem("pen trails",function(){var b=a.currentSprite.reportPenTrailsAsCostume().copy();a.currentSprite.addCostume(b);a.currentSprite.wearCostume(b);a.hasChangedMedia=!0;a.spriteBar.tabBar.tabTo("costumes")},
a.currentSprite instanceof SpriteMorph?"turn all pen trails and stamps\ninto a new costume for the\ncurrently selected sprite":"turn all pen trails and stamps\ninto a new background for the stage");return b};StageMorph.prototype.showAll=function(){var a=this;this.children.forEach(function(b){b instanceof SpriteMorph?b.anchor||(b.show(),b.keepWithin(a)):(b.show(),b.keepWithin(a),b.fixLayout&&b.fixLayout())})};StageMorph.prototype.edit=SpriteMorph.prototype.edit;
StageMorph.prototype.thumbnail=function(a,b){var c=this,d=this.image,e=Math.min(a.x/d.width,a.y/d.height);a=newCanvas(a);var f=a.getContext("2d"),g,h;f.scale(e,e);f.drawImage(d,0,0);f.drawImage(this.penTrails(),0,0,this.dimensions.x*this.scale,this.dimensions.y*this.scale);this.children.forEach(function(a){a.isVisible&&a!==b&&(g=a.fullBounds(),h=a.fullImage(),h.width&&h.height&&f.drawImage(a.fullImage(),g.origin.x-c.bounds.origin.x,g.origin.y-c.bounds.origin.y))});return a};
StageMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};StageMorph.prototype.show=function(){this.isVisible=!0;this.changed()};StageMorph.prototype.createClone=nop;StageMorph.prototype.newClone=nop;StageMorph.prototype.categories=SpriteMorph.prototype.categories;StageMorph.prototype.blockColor=SpriteMorph.prototype.blockColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;StageMorph.prototype.setName=SpriteMorph.prototype.setName;
StageMorph.prototype.makeBlockButton=SpriteMorph.prototype.makeBlockButton;StageMorph.prototype.makeBlock=SpriteMorph.prototype.makeBlock;StageMorph.prototype.palette=SpriteMorph.prototype.palette;StageMorph.prototype.freshPalette=SpriteMorph.prototype.freshPalette;StageMorph.prototype.blocksMatching=SpriteMorph.prototype.blocksMatching;StageMorph.prototype.searchBlocks=SpriteMorph.prototype.searchBlocks;StageMorph.prototype.reporterize=SpriteMorph.prototype.reporterize;
StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher;StageMorph.prototype.addVariable=SpriteMorph.prototype.addVariable;StageMorph.prototype.deleteVariable=SpriteMorph.prototype.deleteVariable;StageMorph.prototype.doScreenshot=SpriteMorph.prototype.doScreenshot;StageMorph.prototype.newCostumeName=SpriteMorph.prototype.newCostumeName;StageMorph.prototype.blockForSelector=SpriteMorph.prototype.blockForSelector;StageMorph.prototype.findVariableWatcher=SpriteMorph.prototype.findVariableWatcher;
StageMorph.prototype.toggleVariableWatcher=SpriteMorph.prototype.toggleVariableWatcher;StageMorph.prototype.showingVariableWatcher=SpriteMorph.prototype.showingVariableWatcher;StageMorph.prototype.deleteVariableWatcher=SpriteMorph.prototype.deleteVariableWatcher;StageMorph.prototype.addCostume=SpriteMorph.prototype.addCostume;StageMorph.prototype.wearCostume=SpriteMorph.prototype.wearCostume;StageMorph.prototype.getCostumeIdx=SpriteMorph.prototype.getCostumeIdx;
StageMorph.prototype.doWearNextCostume=SpriteMorph.prototype.doWearNextCostume;StageMorph.prototype.doWearPreviousCostume=SpriteMorph.prototype.doWearPreviousCostume;StageMorph.prototype.doSwitchToCostume=SpriteMorph.prototype.doSwitchToCostume;StageMorph.prototype.reportCostumes=SpriteMorph.prototype.reportCostumes;StageMorph.prototype.graphicsChanged=SpriteMorph.prototype.graphicsChanged;StageMorph.prototype.applyGraphicsEffects=SpriteMorph.prototype.applyGraphicsEffects;
StageMorph.prototype.setEffect=SpriteMorph.prototype.setEffect;StageMorph.prototype.getGhostEffect=SpriteMorph.prototype.getGhostEffect;StageMorph.prototype.changeEffect=SpriteMorph.prototype.changeEffect;StageMorph.prototype.clearEffects=SpriteMorph.prototype.clearEffects;StageMorph.prototype.addSound=SpriteMorph.prototype.addSound;StageMorph.prototype.playSound=SpriteMorph.prototype.playSound;
StageMorph.prototype.stopAllActiveSounds=function(){this.activeSounds.forEach(function(a){a.pause()});this.activeSounds=[]};StageMorph.prototype.pauseAllActiveSounds=function(){this.activeSounds.forEach(function(a){a.pause()})};StageMorph.prototype.resumeAllActiveSounds=function(){this.activeSounds.forEach(function(a){a.play()})};StageMorph.prototype.reportSounds=SpriteMorph.prototype.reportSounds;StageMorph.prototype.toggleWatcher=SpriteMorph.prototype.toggleWatcher;
StageMorph.prototype.showingWatcher=SpriteMorph.prototype.showingWatcher;StageMorph.prototype.watcherFor=SpriteMorph.prototype.watcherFor;StageMorph.prototype.getLastAnswer=SpriteMorph.prototype.getLastAnswer;StageMorph.prototype.reportThreadCount=SpriteMorph.prototype.reportThreadCount;StageMorph.prototype.allMessageNames=SpriteMorph.prototype.allMessageNames;StageMorph.prototype.allHatBlocksFor=SpriteMorph.prototype.allHatBlocksFor;StageMorph.prototype.allHatBlocksForKey=SpriteMorph.prototype.allHatBlocksForKey;
StageMorph.prototype.allHatBlocksForInteraction=SpriteMorph.prototype.allHatBlocksForInteraction;StageMorph.prototype.allGenericHatBlocks=SpriteMorph.prototype.allGenericHatBlocks;StageMorph.prototype.mouseClickLeft=SpriteMorph.prototype.mouseClickLeft;StageMorph.prototype.mouseEnter=SpriteMorph.prototype.mouseEnter;StageMorph.prototype.mouseLeave=function(){this.receiveUserInteraction("mouse-departed")};StageMorph.prototype.mouseDownLeft=SpriteMorph.prototype.mouseDownLeft;
StageMorph.prototype.receiveUserInteraction=SpriteMorph.prototype.receiveUserInteraction;StageMorph.prototype.deleteAllBlockInstances=SpriteMorph.prototype.deleteAllBlockInstances;StageMorph.prototype.allBlockInstances=SpriteMorph.prototype.allBlockInstances;StageMorph.prototype.allLocalBlockInstances=SpriteMorph.prototype.allLocalBlockInstances;StageMorph.prototype.allEditorBlockInstances=SpriteMorph.prototype.allEditorBlockInstances;StageMorph.prototype.paletteBlockInstance=SpriteMorph.prototype.paletteBlockInstance;
StageMorph.prototype.usesBlockInstance=SpriteMorph.prototype.usesBlockInstance;StageMorph.prototype.doubleDefinitionsFor=SpriteMorph.prototype.doubleDefinitionsFor;StageMorph.prototype.replaceDoubleDefinitionsFor=SpriteMorph.prototype.replaceDoubleDefinitionsFor;StageMorph.prototype.allInvocationsOf=SpriteMorph.prototype.allInvocationsOf;StageMorph.prototype.allIndependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf;StageMorph.prototype.allDependentInvocationsOf=SpriteMorph.prototype.allInvocationsOf;
StageMorph.prototype.specimens=function(){return[]};StageMorph.prototype.allSpecimens=function(){return[]};StageMorph.prototype.shadowAttribute=nop;StageMorph.prototype.inheritsAttribute=function(){return!1};StageMorph.prototype.isVariableNameInUse=SpriteMorph.prototype.isVariableNameInUse;StageMorph.prototype.globalVariables=SpriteMorph.prototype.globalVariables;StageMorph.prototype.inheritedVariableNames=function(){return[]};StageMorph.prototype.getMethod=SpriteMorph.prototype.getMethod;
StageMorph.prototype.getLocalMethod=SpriteMorph.prototype.getLocalMethod;StageMorph.prototype.ownBlocks=SpriteMorph.prototype.ownBlocks;StageMorph.prototype.allBlocks=function(a){var b=this.ownBlocks();return a?Object.keys(b).map(function(a){return b[a]}):b};StageMorph.prototype.inheritedBlocks=function(){return[]};StageMorph.prototype.hasSpriteVariable=SpriteMorph.prototype.hasSpriteVariable;StageMorph.prototype.refactorVariableInstances=SpriteMorph.prototype.refactorVariableInstances;
StageMorph.prototype.reportPenTrailsAsCostume=function(){return new Costume(this.trailsCanvas,this.newCostumeName(localize("Background")))};SpriteBubbleMorph.prototype=new SpeechBubbleMorph;SpriteBubbleMorph.prototype.constructor=SpriteBubbleMorph;SpriteBubbleMorph.uber=SpeechBubbleMorph.prototype;function SpriteBubbleMorph(a,b,c,d){this.init(a,b,c,d)}
SpriteBubbleMorph.prototype.init=function(a,b,c,d){var e=SpriteMorph.prototype;this.scale=(this.stage=b)?b.scale:1;this.data=a;this.isQuestion=d;SpriteBubbleMorph.uber.init.call(this,this.dataAsMorph(a),e.bubbleColor,null,null,d?e.blockColor.sensing:e.bubbleBorderColor,null,c)};
SpriteBubbleMorph.prototype.dataAsMorph=function(a,b){var c=SpriteMorph.prototype;if(a instanceof Morph)if(isSnapObject(a)){var d=a.thumbnail(new Point(40,40));b=new Morph;b.silentSetWidth(d.width);b.silentSetHeight(d.height);b.image=d;b.version=a.version;b.step=function(){this.version!==a.version&&(this.image=d=a.thumbnail(new Point(40,40)),this.version=a.version,this.changed())}}else b=a;else if(isString(a)){var e=!0;b=new TextMorph(a,c.bubbleFontSize*this.scale,null,c.bubbleFontIsBold,!1,"center")}else"boolean"===
typeof a?(d=c.booleanMorph(a).fullImage(),b=new Morph,b.silentSetWidth(d.width),b.silentSetHeight(d.height),b.image=d):a instanceof Costume?(d=a.thumbnail(new Point(40,40)),b=new Morph,b.silentSetWidth(d.width),b.silentSetHeight(d.height),b.image=d):a instanceof Sound?b=new SymbolMorph("notes",30):a instanceof HTMLCanvasElement?(b=new Morph,b.silentSetWidth(a.width),b.silentSetHeight(a.height),b.image=a):a instanceof List?((b=b&&this.contentsMorph?this.contentsMorph instanceof ListWatcherMorph:a.isTable())?
b=new TableFrameMorph(new TableMorph(a,10)):(b=new ListWatcherMorph(a),b.update(!0),b.step=b.update),this.stage&&b.expand(this.stage.extent().translateBy(-2*(this.edge+this.border+this.padding))),b.isDraggable=!1):a instanceof Context?(d=a.image(),b=new Morph,b.silentSetWidth(d.width),b.silentSetHeight(d.height),b.image=d):b=new TextMorph(a.toString(),c.bubbleFontSize*this.scale,null,c.bubbleFontIsBold,!1,"center");if(b instanceof TextMorph){var f=Math.max(b.width(),2*c.bubbleCorner*this.scale);e&&
(f=Math.min(f,c.bubbleMaxTextWidth*this.scale));b.setWidth(f)}else a instanceof List||(c=newCanvas(b.extent().multiplyBy(this.scale)),c.getContext("2d").drawImage(b.image,0,0,c.width,c.height),b.image=c,b.bounds=b.bounds.scaleBy(this.scale));return b};SpriteBubbleMorph.prototype.setScale=function(a){this.scale=a;this.changed();this.drawNew();this.changed()};
SpriteBubbleMorph.prototype.drawNew=function(a){var b=SpriteMorph.prototype;this.edge=b.bubbleCorner*this.scale;this.border=b.bubbleBorder*this.scale;this.padding=b.bubbleCorner/2*this.scale;this.contentsMorph&&this.contentsMorph.destroy();this.contentsMorph=this.dataAsMorph(this.data,a);this.add(this.contentsMorph);this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge));this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2);SpeechBubbleMorph.uber.drawNew.call(this);
this.contentsMorph.setPosition(this.position().add(new Point(this.padding||this.edge,this.border+this.padding+1)))};
SpriteBubbleMorph.prototype.fixLayout=function(){var a=SpriteMorph.prototype;this.changed();this.edge=a.bubbleCorner*this.scale;this.border=a.bubbleBorder*this.scale;this.padding=a.bubbleCorner/2*this.scale;this.silentSetWidth(this.contentsMorph.width()+(this.padding?2*this.padding:2*this.edge));this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border+2*this.padding+2);SpeechBubbleMorph.uber.drawNew.call(this);this.contentsMorph.setPosition(this.position().add(new Point(this.padding||
this.edge,this.border+this.padding+1)));this.changed()};function Costume(a,b,c){this.contents=a?normalizeCanvas(a,!0):newCanvas(null,!0);this.shrinkToFit(this.maxExtent());this.name=b||null;this.rotationCenter=c||this.center();this.version=Date.now();this.loaded=null}Costume.prototype.maxExtent=function(){return StageMorph.prototype.dimensions};Costume.prototype.toString=function(){return"a Costume("+this.name+")"};Costume.prototype.extent=function(){return new Point(this.contents.width,this.contents.height)};
Costume.prototype.center=function(){return this.extent().divideBy(2)};Costume.prototype.width=function(){return this.contents.width};Costume.prototype.height=function(){return this.contents.height};Costume.prototype.bounds=function(){return new Rectangle(0,0,this.width(),this.height())};
Costume.prototype.shrinkWrap=function(){var a=this.boundingBox(),b=a.extent(),c=newCanvas(b,!0);c.getContext("2d").drawImage(this.contents,a.origin.x,a.origin.y,b.x,b.y,0,0,b.x,b.y);this.rotationCenter=this.rotationCenter.subtract(a.origin);this.contents=c;this.version=Date.now()};
Costume.prototype.canvasBoundingBox=function(a){var b,c,d=a.width,e=a.height,f=a.getContext("2d").getImageData(0,0,d,e);a:{for(c=0;c<=d;c+=1)for(b=0;b<=e;b+=1)if(f.data[b*d*4+4*c+3]){a=c;break a}a=0}a:{for(b=0;b<=e;b+=1)for(c=0;c<=d;c+=1)if(f.data[b*d*4+4*c+3]){var g=b;break a}g=0}a:{for(c=d;0<=c;--c)for(b=e;0<=b;--b)if(f.data[b*d*4+4*c+3]){var h=Math.min(c+1,d);break a}h=d}a:{for(b=e;0<=b;--b)for(c=d;0<=c;--c)if(f.data[b*d*4+4*c+3]){d=Math.min(b+1,e);break a}d=e}return new Rectangle(a,g,h,d)};
Costume.prototype.boundingBox=function(){return this.canvasBoundingBox(this.contents)};Costume.prototype.copy=function(){var a=newCanvas(this.extent(),!0);a.getContext("2d").drawImage(this.contents,0,0);a=new Costume(a,this.name?copy(this.name):null);a.rotationCenter=this.rotationCenter.copy();return a};
Costume.prototype.flipped=function(){var a=newCanvas(this.extent(),!0),b=a.getContext("2d");b.translate(this.width(),0);b.scale(-1,1);b.drawImage(this.contents,0,0);return new Costume(a,this.name,new Point(this.width()-this.rotationCenter.x,this.rotationCenter.y))};
Costume.prototype.edit=function(a,b,c,d,e){var f=this,g=new PaintEditorMorph;g.oncancel=d||nop;g.openIn(a,c?newCanvas(StageMorph.prototype.dimensions,!0):this.contents,c?null:this.rotationCenter,function(c,d){f.contents=c;f.rotationCenter=d;f.version=Date.now();a.changed();b&&(b.currentSprite instanceof SpriteMorph&&f.shrinkWrap(),b.currentSprite.wearCostume(f,!0),b.hasChangedMedia=!0);(e||nop)()})};
Costume.prototype.editRotationPointOnly=function(a){var b=new CostumeEditorMorph(this);var c=new DialogBoxMorph(this,function(){b.accept()});var d=new TextMorph(localize("click or drag crosshairs to move the rotation center"),c.fontSize,c.fontStyle,!0,!1,"center",null,null,new Point(1,1),new Color(255,255,255));c.labelString="Costume Editor";c.createLabel();c.setPicture(b);c.addBody(d);c.addButton("ok","Ok");c.addButton("cancel","Cancel");c.fixLayout();c.drawNew();c.fixLayout();c.popUp(a)};
Costume.prototype.shrinkToFit=function(a){if(a.x<this.width()||a.y<this.height())this.contents=this.thumbnail(a)};Costume.prototype.thumbnail=function(a){var b=this.contents,c=Math.min(a.x/b.width,a.y/b.height),d=(a.x-b.width*c)/2,e=(a.y-b.height*c)/2;a=newCanvas(a);var f=a.getContext("2d");if(!b||0===b.width+b.height)return a;f.scale(c,c);f.drawImage(b,Math.floor(d/c),Math.floor(e/c));return a};
Costume.prototype.isTainted=function(){try{this.contents.getContext("2d").getImageData(0,0,this.contents.width,this.contents.height)}catch(a){return!0}return!1};SVG_Costume.prototype=new Costume;SVG_Costume.prototype.constructor=SVG_Costume;SVG_Costume.uber=Costume.prototype;function SVG_Costume(a,b,c){this.contents=a;this.shrinkToFit(this.maxExtent());this.name=b||null;this.rotationCenter=c||this.center();this.version=Date.now();this.loaded=null}
SVG_Costume.prototype.toString=function(){return"an SVG_Costume("+this.name+")"};SVG_Costume.prototype.copy=function(){var a=new Image;a.src=this.contents.src;a=new SVG_Costume(a,this.name?copy(this.name):null);a.rotationCenter=this.rotationCenter.copy();return a};SVG_Costume.prototype.shrinkToFit=function(a){nop(a)};CostumeEditorMorph.prototype=new Morph;CostumeEditorMorph.prototype.constructor=CostumeEditorMorph;CostumeEditorMorph.uber=Morph.prototype;CostumeEditorMorph.prototype.size=Costume.prototype.maxExtent();
function CostumeEditorMorph(a){this.init(a)}CostumeEditorMorph.prototype.init=function(a){this.costume=a||new Costume;this.rotationCenter=this.costume.rotationCenter.copy();this.margin=new Point(0,0);CostumeEditorMorph.uber.init.call(this);this.noticesTransparentClick=!0};CostumeEditorMorph.prototype.accept=function(){this.costume.rotationCenter=this.rotationCenter.copy();this.costume.version=Date.now()};
CostumeEditorMorph.prototype.drawNew=function(){this.margin=this.size.subtract(this.costume.extent()).divideBy(2);var a=this.rotationCenter.add(this.margin);this.silentSetExtent(this.size);this.image=newCanvas(this.extent());this.cachedTexture||(this.cachedTexture=this.createTexture());this.drawCachedTexture();var b=this.image.getContext("2d");b.drawImage(this.costume.contents,this.margin.x,this.margin.y);b.globalAlpha=.5;b.fillStyle="white";b.beginPath();b.arc(a.x,a.y,20,radians(0),radians(360),
!1);b.closePath();b.fill();b.stroke();b.beginPath();b.arc(a.x,a.y,10,radians(0),radians(360),!1);b.stroke();b.beginPath();b.moveTo(0,a.y);b.lineTo(this.costume.width()+2*this.margin.x,a.y);b.stroke();b.beginPath();b.moveTo(a.x,0);b.lineTo(a.x,this.costume.height()+2*this.margin.y);b.stroke()};
CostumeEditorMorph.prototype.createTexture=function(){var a=newCanvas(new Point(10,10)),b=a.getContext("2d"),c=new Color(230,230,230);b.fillStyle="white";b.fillRect(0,0,10,10);b.fillStyle=c.toString();b.fillRect(0,0,5,5);b.fillRect(5,5,5,5);return a};CostumeEditorMorph.prototype.mouseDownLeft=function(a){this.rotationCenter=a.subtract(this.position().add(this.margin));this.drawNew();this.changed()};CostumeEditorMorph.prototype.mouseMove=CostumeEditorMorph.prototype.mouseDownLeft;
function Sound(a,b){this.audio=a;this.name=b||"Sound"}Sound.prototype.play=function(){var a=document.createElement("audio");a.src=this.audio.src;a.play();return a};Sound.prototype.copy=function(){var a=document.createElement("audio");a.src=this.audio.src;return new Sound(a,this.name?copy(this.name):null)};Sound.prototype.toDataURL=function(){return this.audio.src};function Note(a){this.pitch=0===a?0:a||69;this.setupContext();this.oscillator=null}Note.prototype.audioContext=null;
Note.prototype.gainNode=null;Note.prototype.setupContext=function(){if(!this.audioContext){var a=window.AudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext||window.webkitAudioContext;a.prototype.createGain||(a.prototype.createGain=a.prototype.createGainNode);if(!a)throw Error("Web Audio API is not supported\nin this browser");Note.prototype.audioContext=new a;Note.prototype.gainNode=Note.prototype.audioContext.createGain();Note.prototype.gainNode.gain.value=.25}};
Note.prototype.play=function(a){this.oscillator=this.audioContext.createOscillator();this.oscillator.start||(this.oscillator.start=this.oscillator.noteOn);this.oscillator.stop||(this.oscillator.stop=this.oscillator.noteOff);this.oscillator.type=["sine","square","sawtooth","triangle"][(a||1)-1];this.oscillator.frequency.value=440*Math.pow(2,(this.pitch-69)/12);this.oscillator.connect(this.gainNode);this.gainNode.connect(this.audioContext.destination);this.oscillator.start(0)};
Note.prototype.stop=function(){this.oscillator&&(this.oscillator.stop(0),this.oscillator=null)};CellMorph.prototype=new BoxMorph;CellMorph.prototype.constructor=CellMorph;CellMorph.uber=BoxMorph.prototype;function CellMorph(a,b,c,d){this.init(a,b,c,d)}
CellMorph.prototype.init=function(a,b,c,d){this.contents=0===a?0:!1===a?!1:a||"";this.isEditable=isNil(c)?!1:!0;this.idx=c||null;this.parentCell=d||null;CellMorph.uber.init.call(this,SyntaxElementMorph.prototype.corner,1.000001,new Color(255,255,255));this.color=b||new Color(255,140,0);this.isBig=!1;this.version=null;this.drawNew()};CellMorph.prototype.big=function(){this.isBig=!0;this.changed();this.drawNew();this.changed()};
CellMorph.prototype.normal=function(){this.isBig=!1;this.changed();this.drawNew();this.changed()};CellMorph.prototype.isCircular=function(a){return this.parentCell?a instanceof List?this.contents===a||this.parentCell.isCircular(a):this.parentCell.isCircular(this.contents):!1};CellMorph.prototype.fixLayout=function(){var a;this.changed();this.drawNew();this.changed();this.parent&&this.parent.fixLayout?this.parent.fixLayout():(a=this.parentThatIsA(ListWatcherMorph))&&a.fixLayout()};
CellMorph.prototype.update=function(){isSnapObject(this.contents)&&this.version!==this.contents.version&&this.drawNew()};
CellMorph.prototype.drawNew=function(a,b){var c=SyntaxElementMorph.prototype.fontSize;var d=this.contentsMorph instanceof ListWatcherMorph&&this.contentsMorph.list===this.contents,e=this.contentsMorph instanceof TableFrameMorph&&this.contentsMorph.tableMorph.table===this.contents;this.isBig&&(c*=1.5);if(a||this.contentsMorph&&!d&&!e)this.contentsMorph.destroy(),this.version=null;if(a||!d&&!e)this.contents instanceof Morph?isSnapObject(this.contents)?(c=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=
new Morph,this.contentsMorph.silentSetWidth(c.width),this.contentsMorph.silentSetHeight(c.height),this.contentsMorph.image=c,this.version=this.contents.version):this.contentsMorph=this.contents:isString(this.contents)?(b=500<this.contents.length?this.contents.slice(0,500)+"...":this.contents,this.contentsMorph=new TextMorph(b,c,null,!0,!1,"left"),this.isEditable&&(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))):"boolean"===
typeof this.contents?(c=SpriteMorph.prototype.booleanMorph.call(null,this.contents).fullImage(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(c.width),this.contentsMorph.silentSetHeight(c.height),this.contentsMorph.image=c):this.contents instanceof HTMLCanvasElement?(this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(this.contents.width),this.contentsMorph.silentSetHeight(this.contents.height),this.contentsMorph.image=this.contents):this.contents instanceof Context?(c=
this.contents.image(),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(c.width),this.contentsMorph.silentSetHeight(c.height),this.contentsMorph.image=c):this.contents instanceof Costume?(c=this.contents.thumbnail(new Point(40,40)),this.contentsMorph=new Morph,this.contentsMorph.silentSetWidth(c.width),this.contentsMorph.silentSetHeight(c.height),this.contentsMorph.image=c):this.contents instanceof Sound?this.contentsMorph=new SymbolMorph("notes",30):this.contents instanceof List?("table"===
b||!a&&this.contents.isTable()?(this.contentsMorph=new TableFrameMorph(new TableMorph(this.contents,10)),this.contentsMorph.expand(new Point(200,150))):this.isCircular()?(this.contentsMorph=new TextMorph("(...)",c,null,!1,!0,"center"),this.contentsMorph.setColor(new Color(255,255,255))):this.contentsMorph=new ListWatcherMorph(this.contents,this),this.contentsMorph.isDraggable=!1):(this.contentsMorph=new TextMorph(isNil(this.contents)?"":this.contents.toString(),c,null,!0,!1,"center"),this.isEditable&&
(this.contentsMorph.isEditable=!0,this.contentsMorph.enableSelecting()),this.contentsMorph.setColor(new Color(255,255,255))),this.add(this.contentsMorph);this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border);this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:3.5*SyntaxElementMorph.prototype.fontSize));this.image=newCanvas(this.extent());c=this.image.getContext("2d");if(0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),
null;c.fillStyle=this.color.toString();c.beginPath();this.outlinePath(c,Math.max(this.edge-this.border,0),this.border);c.closePath();c.fill();0<this.border&&!MorphicPreferences.isFlat&&(c.lineWidth=this.border,c.strokeStyle=this.borderColor.toString(),c.beginPath(),this.outlinePath(c,this.edge,this.border/2),c.closePath(),c.stroke(),c.shadowOffsetX=this.border,c.shadowOffsetY=this.border,c.shadowBlur=this.border,c.shadowColor=this.color.darker(80).toString(),this.drawShadow(c,this.edge,this.border/
2));(a||!d&&!e)&&this.contentsMorph.setCenter(this.center())};CellMorph.prototype.drawShadow=function(a,b,c){c=b+c;var d=this.width(),e=this.height();a.beginPath();a.moveTo(0,e-c);a.lineTo(0,c);a.stroke();a.beginPath();a.arc(c,c,b,radians(-180),radians(-90),!1);a.stroke();a.beginPath();a.moveTo(c,0);a.lineTo(d-c,0);a.stroke()};
CellMorph.prototype.layoutChanged=function(){var a=this.parentThatIsA(ListWatcherMorph);this.silentSetHeight(this.contentsMorph.height()+this.edge+2*this.border);this.silentSetWidth(Math.max(this.contentsMorph.width()+2*this.edge,this.contents instanceof Context||this.contents instanceof List?0:2*this.height()));this.image=newCanvas(this.extent());var b=this.image.getContext("2d");if(0===this.edge&&0===this.border)return BoxMorph.uber.drawNew.call(this),null;b.fillStyle=this.color.toString();b.beginPath();
this.outlinePath(b,Math.max(this.edge-this.border,0),this.border);b.closePath();b.fill();0<this.border&&!MorphicPreferences.isFlat&&(b.lineWidth=this.border,b.strokeStyle=this.borderColor.toString(),b.beginPath(),this.outlinePath(b,this.edge,this.border/2),b.closePath(),b.stroke(),b.shadowOffsetX=this.border,b.shadowOffsetY=this.border,b.shadowBlur=this.border,b.shadowColor=this.color.darker(80).toString(),this.drawShadow(b,this.edge,this.border/2));this.contentsMorph.setCenter(this.center());a&&
a.fixLayout()};CellMorph.prototype.reactToEdit=function(a){var b;isNil(this.idx)||(b=this.parentThatIsA(ListWatcherMorph))&&b.list.put(a.text,this.idx)};CellMorph.prototype.mouseClickLeft=function(a){this.isEditable&&this.contentsMorph instanceof TextMorph?this.contentsMorph.selectAllAndEdit():this.escalateEvent("mouseClickLeft",a)};
CellMorph.prototype.mouseDoubleClick=function(a){List.prototype.enableTables&&this.currentValue instanceof List?(new TableDialogMorph(this.contents)).popUp(this.world()):this.escalateEvent("mouseDoubleClick",a)};WatcherMorph.prototype=new BoxMorph;WatcherMorph.prototype.constructor=WatcherMorph;WatcherMorph.uber=BoxMorph.prototype;function WatcherMorph(a,b,c,d,e){this.init(a,b,c,d,e)}
WatcherMorph.prototype.init=function(a,b,c,d,e){this.labelText=a||"";this.version=null;this.objName="";WatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120));this.color=new Color(220,220,220);this.readoutColor=b;this.style="normal";this.target=c||null;this.getter=d||null;this.cellMorph=this.sliderMorph=this.labelMorph=this.currentValue=null;this.isDraggable=!0;this.fixLayout();this.update();e&&this.hide()};
WatcherMorph.prototype.isTemporary=function(){var a=this.parentThatIsA(StageMorph);return this.target instanceof VariableFrame?a&&this.target===a.variables.parentFrame?!1:null===this.target.owner:!1};WatcherMorph.prototype.object=function(){return this.target instanceof VariableFrame?this.target.owner:this.target};WatcherMorph.prototype.isGlobal=function(a){return contains("getLastAnswer getLastMessage getTempo getTimer reportMouseX reportMouseY reportThreadCount".split(" "),a)};
WatcherMorph.prototype.setSliderMin=function(a,b){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,b),this.sliderMorph.setStart(a,b),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,b))};WatcherMorph.prototype.setSliderMax=function(a,b){this.target instanceof VariableFrame&&(this.sliderMorph.setSize(1,b),this.sliderMorph.setStop(a,b),this.sliderMorph.setSize(this.sliderMorph.rangeSize()/5,b))};
WatcherMorph.prototype.update=function(){var a=!1;if(this.target&&this.getter){this.updateLabel();if(this.target instanceof VariableFrame){var b=this.target.vars[this.getter]?this.target.vars[this.getter].value:void 0;if(void 0===b&&this.target.owner)if(b=this.target.owner,contains(b.inheritedVariableNames(),this.getter))b=this.target.getVar(this.getter),this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables.lighter(35));else{this.destroy();return}else this.cellMorph.setColor(SpriteMorph.prototype.blockColor.variables)}else b=
this.target[this.getter](),a=(a={xPosition:"x position",yPosition:"y position",direction:"direction",getCostumeIdx:"costume #",getScale:"size"}[this.getter])?this.target.inheritsAttribute(a):!1;""===b||isNil(b)||"boolean"===typeof b||isNaN(+b)||(b=Math.round(1E9*b)/1E9);b!==this.currentValue&&(this.changed(),this.cellMorph.contents=b,isSnapObject(this.target)&&(a?this.cellMorph.setColor(this.readoutColor.lighter(35)):this.cellMorph.setColor(this.readoutColor)),this.cellMorph.drawNew(),isNaN(b)||(this.sliderMorph.value=
b,this.sliderMorph.drawNew()),this.fixLayout(),this.currentValue=b)}this.cellMorph.contentsMorph instanceof ListWatcherMorph?this.cellMorph.contentsMorph.update():isSnapObject(this.cellMorph.contents)&&this.cellMorph.update()};WatcherMorph.prototype.updateLabel=function(){var a=this.object();a&&!this.isGlobal(this.getter)&&a.version!==this.version&&(this.objName=a.name?a.name+" ":" ",this.labelMorph&&(this.labelMorph.destroy(),this.labelMorph=null,this.fixLayout()))};
WatcherMorph.prototype.fixLayout=function(){var a=SyntaxElementMorph.prototype.fontSize,b,c=this;this.changed();null===this.labelMorph&&(this.labelMorph=new StringMorph(this.objName+this.labelText,a,null,!0,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255)),this.add(this.labelMorph));null===this.cellMorph&&(this.cellMorph=new CellMorph("",this.readoutColor),this.add(this.cellMorph));null===this.sliderMorph&&(this.sliderMorph=new SliderMorph(0,100,0,20,"horizontal"),this.sliderMorph.alpha=
1,this.sliderMorph.button.color=this.color.darker(),this.sliderMorph.color=this.color.lighter(60),this.sliderMorph.button.highlightColor=this.color.darker(),this.sliderMorph.button.highlightColor.b+=50,this.sliderMorph.button.pressColor=this.color.darker(),this.sliderMorph.button.pressColor.b+=100,this.sliderMorph.setHeight(a),this.sliderMorph.action=function(a){c.target.setVar(c.getter,Math.round(a),c.target.owner)},this.add(this.sliderMorph));if(b=this.cellMorph.contents instanceof List)this.style=
"normal";"large"===this.style?(this.labelMorph.hide(),this.sliderMorph.hide(),this.cellMorph.big(),this.cellMorph.setPosition(this.position()),this.setExtent(this.cellMorph.extent().subtract(1))):(this.labelMorph.show(),this.sliderMorph.show(),this.cellMorph.normal(),this.labelMorph.setPosition(this.position().add(new Point(this.edge,this.border+SyntaxElementMorph.prototype.typeInPadding))),b?this.cellMorph.setPosition(this.labelMorph.bottomLeft().add(new Point(0,SyntaxElementMorph.prototype.typeInPadding))):
(this.cellMorph.setPosition(this.labelMorph.topRight().add(new Point(a/3,0))),this.labelMorph.setTop(this.cellMorph.top()+(this.cellMorph.height()-this.labelMorph.height())/2)),"slider"===this.style?(this.sliderMorph.silentSetPosition(new Point(this.labelMorph.left(),this.cellMorph.bottom()+SyntaxElementMorph.prototype.typeInPadding)),this.sliderMorph.setWidth(this.cellMorph.right()-this.labelMorph.left()),this.silentSetHeight(this.cellMorph.height()+this.sliderMorph.height()+2*this.border+3*SyntaxElementMorph.prototype.typeInPadding)):
(this.sliderMorph.hide(),this.bounds.corner.y=this.cellMorph.bottom()+this.border+SyntaxElementMorph.prototype.typeInPadding),this.bounds.corner.x=Math.max(this.cellMorph.right(),this.labelMorph.right())+this.edge+SyntaxElementMorph.prototype.typeInPadding,this.drawNew(),this.changed())};
WatcherMorph.prototype.mouseDoubleClick=function(a){List.prototype.enableTables&&this.currentValue instanceof List?(new TableDialogMorph(this.currentValue)).popUp(this.world()):this.escalateEvent("mouseDoubleClick",a)};WatcherMorph.prototype.rootForGrab=function(){var a=this.parentThatIsA(IDE_Morph);return a&&a.isAppMode?a:this};
WatcherMorph.prototype.userMenu=function(){function a(a){var c=b.parentThatIsA(StageMorph),e=b.currentValue.outerContext.variables;d.addItem(a+"...",function(){var b=detect(c.children,function(b){return b instanceof WatcherMorph&&b.target===e&&b.getter===a});if(null!==b)b.show();else{b=new WatcherMorph(a+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,e,a);b.setPosition(c.position().add(10));var d=c.watchers(b.left());0<d.length&&b.setTop(d[d.length-1].bottom());c.add(b)}b.fixLayout()})}
var b=this,c=this.parentThatIsA(IDE_Morph),d=new MenuMorph(this);if(!c||!c.isAppMode)return d.addItem(("normal"===this.style?"\u25cf":"\u25cb")+" "+localize("normal"),"styleNormal"),d.addItem(("large"===this.style?"\u25cf":"\u25cb")+" "+localize("large"),"styleLarge"),this.target instanceof VariableFrame&&(d.addItem(("slider"===this.style?"\u25cf":"\u25cb")+" "+localize("slider"),"styleSlider"),d.addLine(),d.addItem("slider min...","userSetSliderMin"),d.addItem("slider max...","userSetSliderMax"),
d.addLine(),d.addItem("import...",function(){var a=document.createElement("input"),c=b.parentThatIsA(IDE_Morph);c.filePicker&&(document.body.removeChild(c.filePicker),c.filePicker=null);a.type="file";a.style.color="transparent";a.style.backgroundColor="transparent";a.style.border="none";a.style.outline="none";a.style.position="absolute";a.style.top="0px";a.style.left="0px";a.style.width="0px";a.style.height="0px";a.style.display="none";a.addEventListener("change",function(){function d(a){var d=new FileReader;
d.onloadend=function(a){b.target.setVar(b.getter,a.target.result)};0===a.type.indexOf("text")?d.readAsText(a):c.inform("Unable to import",'Snap! can only import "text" files.\nYou selected a file of type "'+a.type+'".')}document.body.removeChild(a);c.filePicker=null;if(0<a.files.length){var e=a.files[a.files.length-1];d(e)}},!1);document.body.appendChild(a);c.filePicker=a;a.click()}),isString(this.currentValue)||!isNaN(+this.currentValue)?d.addItem("export...",function(){b.parentThatIsA(IDE_Morph).saveFileAs(b.currentValue.toString(),
"text/plain;charset=utf-8",b.getter)}):this.currentValue instanceof Context&&(c=this.currentValue.outerContext.variables.names(),c.length&&(d.addLine(),c.forEach(function(b){a(b)})))),d};WatcherMorph.prototype.setStyle=function(a){this.style=a;this.fixLayout()};WatcherMorph.prototype.styleNormal=function(){this.setStyle("normal")};WatcherMorph.prototype.styleLarge=function(){this.setStyle("large")};WatcherMorph.prototype.styleSlider=function(){this.setStyle("slider")};
WatcherMorph.prototype.userSetSliderMin=function(){(new DialogBoxMorph(this,this.setSliderMin,this)).prompt("Slider minimum value",this.sliderMorph.start.toString(),this.world(),null,null,null,!0)};WatcherMorph.prototype.userSetSliderMax=function(){(new DialogBoxMorph(this,this.setSliderMax,this)).prompt("Slider maximum value",this.sliderMorph.stop.toString(),this.world(),null,null,null,!0)};
WatcherMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());var a=this.image.getContext("2d");if(MorphicPreferences.isFlat||0===this.edge&&0===this.border)BoxMorph.uber.drawNew.call(this);else{var b=a.createLinearGradient(0,0,0,this.height());b.addColorStop(0,this.color.lighter().toString());b.addColorStop(1,this.color.darker().toString());a.fillStyle=b;a.beginPath();this.outlinePath(a,Math.max(this.edge-this.border,0),this.border);a.closePath();a.fill();0<this.border&&(b=a.createLinearGradient(0,
0,0,this.height()),b.addColorStop(0,this.borderColor.lighter().toString()),b.addColorStop(1,this.borderColor.darker().toString()),a.lineWidth=this.border,a.strokeStyle=b,a.beginPath(),this.outlinePath(a,this.edge,this.border/2),a.closePath(),a.stroke())}};StagePrompterMorph.prototype=new BoxMorph;StagePrompterMorph.prototype.constructor=StagePrompterMorph;StagePrompterMorph.uber=BoxMorph.prototype;function StagePrompterMorph(a){this.init(a)}
StagePrompterMorph.prototype.init=function(a){var b=this;this.isDone=!1;this.label=a?new StringMorph(a,SpriteMorph.prototype.bubbleFontSize,null,SpriteMorph.prototype.bubbleFontIsBold,!1,"left"):null;this.inputField=new InputFieldMorph;this.button=new PushButtonMorph(null,function(){b.accept()},"\u2713");StagePrompterMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,SpriteMorph.prototype.bubbleBorder,SpriteMorph.prototype.blockColor.sensing);this.color=new Color(255,255,255);this.label&&
this.add(this.label);this.add(this.inputField);this.add(this.button);this.setWidth(StageMorph.prototype.dimensions.x-20);this.fixLayout()};
StagePrompterMorph.prototype.fixLayout=function(){var a=0;this.label&&(this.label.setPosition(new Point(this.left()+this.edge,this.top()+this.edge)),a=this.label.bottom()-this.top());this.inputField.setPosition(new Point(this.left()+this.edge,this.top()+a+this.edge));this.inputField.setWidth(this.width()-2*this.edge-this.button.width()-this.border);this.button.setCenter(this.inputField.center());this.button.setLeft(this.inputField.right()+this.border);this.setHeight(this.inputField.bottom()-this.top()+
this.edge)};StagePrompterMorph.prototype.mouseClickLeft=function(){this.inputField.edit()};StagePrompterMorph.prototype.accept=function(){this.isDone=!0};modules.gui="2017-November-16";IDE_Morph.prototype=new Morph;IDE_Morph.prototype.constructor=IDE_Morph;IDE_Morph.uber=Morph.prototype;
IDE_Morph.prototype.setDefaultDesign=function(){MorphicPreferences.isFlat=!1;SpriteMorph.prototype.paletteColor=new Color(55,55,55);SpriteMorph.prototype.paletteTextColor=new Color(230,230,230);StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor.lighter(30);IDE_Morph.prototype.buttonContrast=30;IDE_Morph.prototype.backgroundColor=new Color(40,
40,40);IDE_Morph.prototype.frameColor=SpriteMorph.prototype.paletteColor;IDE_Morph.prototype.groupColor=SpriteMorph.prototype.paletteColor.lighter(8);IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;IDE_Morph.prototype.buttonLabelColor=new Color(255,255,255);IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.darker(40),IDE_Morph.prototype.groupColor.darker(60),IDE_Morph.prototype.groupColor];IDE_Morph.prototype.rotationStyleColors=IDE_Morph.prototype.tabColors;IDE_Morph.prototype.appModeColor=
new Color;IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture();IDE_Morph.prototype.padding=5;SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor};
IDE_Morph.prototype.setFlatDesign=function(){MorphicPreferences.isFlat=!0;SpriteMorph.prototype.paletteColor=new Color(255,255,255);SpriteMorph.prototype.paletteTextColor=new Color(70,70,70);StageMorph.prototype.paletteTextColor=SpriteMorph.prototype.paletteTextColor;StageMorph.prototype.paletteColor=SpriteMorph.prototype.paletteColor;SpriteMorph.prototype.sliderColor=SpriteMorph.prototype.paletteColor;IDE_Morph.prototype.buttonContrast=30;IDE_Morph.prototype.backgroundColor=new Color(200,200,200);
IDE_Morph.prototype.frameColor=new Color(255,255,255);IDE_Morph.prototype.groupColor=new Color(230,230,230);IDE_Morph.prototype.sliderColor=SpriteMorph.prototype.sliderColor;IDE_Morph.prototype.buttonLabelColor=new Color(70,70,70);IDE_Morph.prototype.tabColors=[IDE_Morph.prototype.groupColor.lighter(60),IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor];IDE_Morph.prototype.rotationStyleColors=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.groupColor.darker(10),IDE_Morph.prototype.groupColor.darker(30)];
IDE_Morph.prototype.appModeColor=IDE_Morph.prototype.frameColor;IDE_Morph.prototype.scriptsPaneTexture=null;IDE_Morph.prototype.padding=1;SpriteIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;CostumeIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;SoundIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor;TurtleIconMorph.prototype.labelColor=IDE_Morph.prototype.buttonLabelColor};
IDE_Morph.prototype.scriptsTexture=function(){var a=newCanvas(new Point(100,100)),b=a.getContext("2d"),c;for(c=0;100>c;c+=4)b.fillStyle=this.frameColor.toString(),b.fillRect(c,0,1,100),b.fillStyle=this.groupColor.lighter(6).toString(),b.fillRect(c+1,0,1,100),b.fillRect(c+3,0,1,100),b.fillStyle=this.groupColor.toString(),b.fillRect(c+2,0,1,100);return a};IDE_Morph.prototype.setDefaultDesign();function IDE_Morph(a){this.init(a)}
IDE_Morph.prototype.init=function(a){MorphicPreferences.globalFontFamily="Helvetica, Arial";this.userLanguage=null;this.projectsInURLs=!1;this.applySavedSettings();this.cloudMsg=null;this.source="local";this.serializer=new SnapSerializer;this.globalVariables=new VariableFrame;this.currentSprite=new SpriteMorph(this.globalVariables);this.sprites=new List([this.currentSprite]);this.currentCategory="motion";this.currentTab="scripts";this.projectNotes=this.projectName="";this.corral=this.corralBar=this.stageHandle=
this.stage=this.spriteEditor=this.spriteBar=this.paletteHandle=this.palette=this.categories=this.controlBar=this.logo=null;this.isAutoFill=void 0===a?!0:a;this.isSmallStage=this.isAppMode=!1;this.filePicker=null;this.hasChangedMedia=!1;this.isAnimating=!0;this.paletteWidth=200;this.stageRatio=1;this.loadNewProject=this.wasSingleStepping=!1;this.shield=null;this.savingPreferences=!0;IDE_Morph.uber.init.call(this);this.color=this.backgroundColor};
IDE_Morph.prototype.openIn=function(a){function b(a){try{var b=new XMLHttpRequest;b.open("GET",a,!1);b.send();if(200===b.status)return b.responseText;throw Error("unable to retrieve "+a);}catch(m){return g.showMessage("unable to retrieve project"),""}}function c(a){a.editMode?g.toggleAppMode(!1):g.toggleAppMode(!0);a.noRun||g.runScripts();a.hideControls&&(g.controlBar.hide(),window.onbeforeunload=nop);a.noExitWarning&&(window.onbeforeunload=nop)}function d(){if("#open:"===location.hash.substr(0,6)){e=
location.hash.substr(6);if("%"===e.charAt(0)||-1<e.search(/\%(?:[0-9a-f]{2})/i))e=decodeURIComponent(e);contains(["project","blocks","sprites","snapdata"].map(function(a){return e.substr(0,8).indexOf(a)}),1)?this.droppedText(e):this.droppedText(b(e))}else if("#run:"===location.hash.substr(0,5)){e=location.hash.substr(5);var a=e.indexOf("&");0<a&&(e=e.slice(0,a));if("%"===e.charAt(0)||-1<e.search(/\%(?:[0-9a-f]{2})/i))e=decodeURIComponent(e);"<project>"===e.substr(0,8)?this.rawOpenProjectString(e):
this.rawOpenProjectString(b(e));c(SnapCloud.parseDict(location.hash.substr(5)))}else if("#present:"===location.hash.substr(0,9)){this.shield=new Morph;this.shield.color=this.color;this.shield.setExtent(this.parent.extent());this.parent.add(this.shield);g.showMessage("Fetching project\nfrom the cloud...");var d=SnapCloud.parseDict(location.hash.substr(9));d.Username=d.Username.toLowerCase();SnapCloud.getPublicProject(SnapCloud.encodeDict(d),function(a){var b;g.nextSteps([function(){b=g.showMessage("Opening project...")},
function(){nop()},function(){0===a.indexOf("<snapdata")?g.rawOpenCloudDataString(a):0===a.indexOf("<project")&&g.rawOpenProjectString(a);g.hasChangedMedia=!0},function(){g.shield.destroy();g.shield=null;b.destroy();c(d)}])},this.cloudError())}else"#cloud:"===location.hash.substr(0,7)?(this.shield=new Morph,this.shield.alpha=0,this.shield.setExtent(this.parent.extent()),this.parent.add(this.shield),g.showMessage("Fetching project\nfrom the cloud..."),d=SnapCloud.parseDict(location.hash.substr(7)),
d.Username=d.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(d),function(a){var b;g.nextSteps([function(){b=g.showMessage("Opening project...")},function(){nop()},function(){0===a.indexOf("<snapdata")?g.rawOpenCloudDataString(a):0===a.indexOf("<project")&&g.rawOpenProjectString(a);g.hasChangedMedia=!0},function(){g.shield.destroy();g.shield=null;b.destroy();g.toggleAppMode(!1)}])},this.cloudError())):"#dl:"===location.hash.substr(0,4)?(g.showMessage("Fetching project\nfrom the cloud..."),
d=SnapCloud.parseDict(location.hash.substr(4)),d.Username=d.Username.toLowerCase(),SnapCloud.getPublicProject(SnapCloud.encodeDict(d),function(a){g.saveXMLAs(a,d.ProjectName);g.showMessage("Saved project\n"+d.ProjectName,2)},this.cloudError())):"#lang:"===location.hash.substr(0,6)?(h=location.hash.substr(6),this.setLanguage(h),this.loadNewProject=!0):"#signup"===location.hash.substr(0,7)&&this.createCloudAccount();this.loadNewProject=!1}var e,f,g=this,h=null;this.hasLocalStorage()&&(f=localStorage["-snap-user"])&&
(f=SnapCloud.parseResponse(f)[0])&&(SnapCloud.username=f.username||null,SnapCloud.password=f.password||null,SnapCloud.username&&(this.source="cloud"));this.buildPanes();a.add(this);a.userMenu=this.userMenu;SnapCloud.message=function(b){var c=new MenuMorph(null,b);c.popUpCenteredInWorld(a);var d=setInterval(function(){c.destroy();clearInterval(d)},2E3)};a.reactToDropOf=function(b){b instanceof DialogBoxMorph||(a.hand.grabOrigin?b.slideBackTo(a.hand.grabOrigin):a.hand.grab(b))};this.reactToWorldResize(a.bounds);
this.userLanguage?(this.loadNewProject=!0,this.setLanguage(this.userLanguage,d)):d.call(this)};IDE_Morph.prototype.buildPanes=function(){this.createLogo();this.createControlBar();this.createCategories();this.createPalette();this.createStage();this.createSpriteBar();this.createSpriteEditor();this.createCorralBar();this.createCorral()};
IDE_Morph.prototype.createLogo=function(){var a=this;this.logo&&this.logo.destroy();this.logo=new Morph;this.logo.drawNew=function(){this.image=newCanvas(this.extent());var b=this.image.getContext("2d"),c=b.createLinearGradient(0,0,this.width(),0);c.addColorStop(0,"black");c.addColorStop(.5,a.frameColor.toString());b.fillStyle=MorphicPreferences.isFlat?a.frameColor.toString():c;b.fillRect(0,0,this.width(),this.height());this.texture&&this.drawTexture(this.texture)};this.logo.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,
5,Math.round((this.height()-this.cachedTexture.height)/2));this.changed()};this.logo.mouseClickLeft=function(){a.snapMenu()};this.logo.color=new Color;this.logo.setExtent(new Point(200,28));this.add(this.logo)};
IDE_Morph.prototype.createControlBar=function(){var a,b=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)],c=this;this.controlBar&&this.controlBar.destroy();this.controlBar=new Morph;this.controlBar.color=this.frameColor;this.controlBar.setHeight(this.logo.height());this.controlBar.mouseClickLeft=function(){this.world().fillPage()};this.add(this.controlBar);var d=new ToggleButtonMorph(null,c,"toggleStageSize",[new SymbolMorph("smallStage",14),new SymbolMorph("normalStage",14)],
function(){return c.isSmallStage});d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=b[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=this.buttonLabelColor;d.contrast=this.buttonContrast;d.drawNew();d.fixLayout();d.refresh();var e=d;this.controlBar.add(e);this.controlBar.stageSizeButton=d;d=new ToggleButtonMorph(null,c,"toggleAppMode",[new SymbolMorph("fullScreen",14),new SymbolMorph("normalScreen",14)],function(){return c.isAppMode});
d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=b[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=this.buttonLabelColor;d.contrast=this.buttonContrast;d.drawNew();d.fixLayout();d.refresh();var f=d;this.controlBar.add(f);this.controlBar.appModeButton=f;d=new ToggleButtonMorph(null,c,"toggleSingleStepping",[new SymbolMorph("footprints",16),new SymbolMorph("footprints",16)],function(){return Process.prototype.enableSingleStepping});
d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=new Color(153,255,213);d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=this.buttonLabelColor;d.contrast=this.buttonContrast;d.drawNew();d.hint="Visible stepping";d.fixLayout();d.refresh();var g=d;this.controlBar.add(g);this.controlBar.steppingButton=g;d=new ToggleButtonMorph(null,this,"stopAllScripts",[new SymbolMorph("octagon",14),new SymbolMorph("square",14)],function(){return c.stage?
c.stage.enableCustomHatBlocks&&c.stage.threads.pauseCustomHatBlocks:!0});d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=b[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=new Color(200,0,0);d.contrast=this.buttonContrast;d.drawNew();d.fixLayout();d.refresh();var h=d;this.controlBar.add(h);this.controlBar.stopButton=h;d=new ToggleButtonMorph(null,this,"togglePauseResume",[new SymbolMorph("pause",12),new SymbolMorph("pointRight",
14)],function(){return c.isPaused()});d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=b[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=new Color(255,220,0);d.contrast=this.buttonContrast;d.drawNew();d.fixLayout();d.refresh();var k=d;this.controlBar.add(k);this.controlBar.pauseButton=k;d=new PushButtonMorph(this,"pressStart",new SymbolMorph("flag",14));d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=
b[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=new Color(0,200,0);d.contrast=this.buttonContrast;d.drawNew();d.fixLayout();var l=d;this.controlBar.add(l);this.controlBar.startButton=l;var m=new SliderMorph(61,1,100*Process.prototype.flashTime+1,6,"horizontal");m.action=function(a){Process.prototype.flashTime=(a-1)/100;c.controlBar.refreshResumeSymbol()};m.color=new Color(153,255,213);m.alpha=.3;m.setExtent(new Point(50,
14));this.controlBar.add(m);this.controlBar.steppingSlider=m;d=new PushButtonMorph(this,"projectMenu",new SymbolMorph("file",14));d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=b[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=this.buttonLabelColor;d.contrast=this.buttonContrast;d.drawNew();d.fixLayout();var n=d;this.controlBar.add(n);this.controlBar.projectButton=n;d=new PushButtonMorph(this,"settingsMenu",new SymbolMorph("gears",
14));d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=b[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=this.buttonLabelColor;d.contrast=this.buttonContrast;d.drawNew();d.fixLayout();var p=d;this.controlBar.add(p);this.controlBar.settingsButton=p;d=new PushButtonMorph(this,"cloudMenu",new SymbolMorph("cloud",11));d.corner=12;d.color=b[0];d.highlightColor=b[1];d.pressColor=b[2];d.labelMinExtent=new Point(36,18);d.padding=
0;d.labelShadowOffset=new Point(-1,-1);d.labelShadowColor=b[1];d.labelColor=this.buttonLabelColor;d.contrast=this.buttonContrast;d.drawNew();d.fixLayout();var q=d;this.controlBar.add(q);this.controlBar.cloudButton=q;this.controlBar.fixLayout=function(){a=this.right()-5;[h,k,l].forEach(function(b){b.setCenter(c.controlBar.center());b.setRight(a);a-=b.width();a-=5});a=Math.min(l.left()-(15+2*e.width()),c.right()-StageMorph.prototype.dimensions.x*(c.isSmallStage?c.stageRatio:1));[e,f].forEach(function(b){a+=
5;b.setCenter(c.controlBar.center());b.setLeft(a);a+=b.width()});m.setCenter(c.controlBar.center());m.setRight(e.left()-5);g.setCenter(c.controlBar.center());g.setRight(m.left()-5);p.setCenter(c.controlBar.center());p.setLeft(this.left());q.setCenter(c.controlBar.center());q.setRight(p.left()-5);n.setCenter(c.controlBar.center());n.setRight(q.left()-5);this.refreshSlider();this.updateLabel()};this.controlBar.refreshSlider=function(){Process.prototype.enableSingleStepping&&!c.isAppMode?(m.drawNew(),
m.show()):m.hide();this.refreshResumeSymbol()};this.controlBar.refreshResumeSymbol=function(){if(Process.prototype.enableSingleStepping&&.5<Process.prototype.flashTime){c.stage.threads.pauseAll(c.stage);var a=[new SymbolMorph("pause",12),new SymbolMorph("stepForward",14)]}else a=[new SymbolMorph("pause",12),new SymbolMorph("pointRight",14)];k.labelString=a;k.createLabel();k.fixLayout();k.refresh()};this.controlBar.updateLabel=function(){var a=c.world().isDevMode?" - "+localize("development mode"):
"";this.label&&this.label.destroy();c.isAppMode||(this.label=new StringMorph((c.projectName||localize("untitled"))+a,14,"sans-serif",!0,!1,!1,MorphicPreferences.isFlat?null:new Point(2,1),c.frameColor.darker(c.buttonContrast)),this.label.color=c.buttonLabelColor,this.label.drawNew(),this.add(this.label),this.label.setCenter(this.center()),this.label.setLeft(this.settingsButton.right()+5))}};
IDE_Morph.prototype.createCategories=function(){function a(a){var c=[b.frameColor,b.frameColor.darker(50),SpriteMorph.prototype.blockColor[a]];var e=new ToggleButtonMorph(c,b,function(){b.currentCategory=a;b.categories.children.forEach(function(a){a.refresh()});b.refreshPalette(!0)},a[0].toUpperCase().concat(a.slice(1)),function(){return b.currentCategory===a},null,null,null,75,!0);e.corner=8;e.padding=0;e.labelShadowOffset=new Point(-1,-1);e.labelShadowColor=c[1];e.labelColor=b.buttonLabelColor;
e.fixLayout();e.refresh();b.categories.add(e);return e}var b=this;this.categories&&this.categories.destroy();this.categories=new Morph;this.categories.color=this.groupColor;this.categories.silentSetWidth(this.paletteWidth);SpriteMorph.prototype.categories.forEach(function(b){contains(["lists","other"],b)||a(b)});(function(){var a=b.categories.children[0].width(),d=b.categories.children[0].height(),e=Math.ceil(b.categories.children.length/2),f=(197-2*a)/3,g=b.categories.left(),h=b.categories.top(),
k=0,l,m;b.categories.children.forEach(function(b){k+=1;l=Math.ceil(k/2);m=2-k%2;b.setPosition(new Point(g+(m*f+(m-1)*a),h+(2*l+(l-1)*d+3)))});b.categories.setHeight(2*(e+1)+e*d+6)})();this.add(this.categories)};
IDE_Morph.prototype.createPalette=function(a){var b=this;this.palette&&this.palette.destroy();this.palette=a?new ScrollFrameMorph(null,null,this.currentSprite.sliderColor):this.currentSprite.palette(this.currentCategory);this.palette.isDraggable=!1;this.palette.acceptsDrops=!0;this.palette.enableAutoScrolling=!1;this.palette.contents.acceptsDrops=!1;this.palette.reactToDropOf=function(a,d){a instanceof DialogBoxMorph?b.world().add(a):a instanceof SpriteMorph?b.removeSprite(a):a instanceof SpriteIconMorph?
(a.destroy(),b.removeSprite(a.object)):(a instanceof CostumeIconMorph?b.currentSprite.wearCostume(null):a instanceof BlockMorph&&(b.stage.threads.stopAllForBlock(a),d&&d.grabOrigin.origin instanceof ScriptsMorph&&(d.grabOrigin.origin.clearDropInfo(),d.grabOrigin.origin.lastDroppedBlock=a,d.grabOrigin.origin.recordDrop(d.grabOrigin))),a.perish())};this.palette.contents.reactToDropOf=function(a){a instanceof BlockMorph&&a.destroy()};this.palette.setWidth(this.logo.width());this.add(this.palette);return this.palette};
IDE_Morph.prototype.createPaletteHandle=function(){this.paletteHandle&&this.paletteHandle.destroy();this.paletteHandle=new PaletteHandleMorph(this.categories);this.add(this.paletteHandle)};
IDE_Morph.prototype.createStage=function(){this.stage&&this.stage.destroy();StageMorph.prototype.frameRate=0;this.stage=new StageMorph(this.globalVariables);this.stage.setExtent(this.stage.dimensions);this.currentSprite instanceof SpriteMorph&&(this.currentSprite.setPosition(this.stage.center().subtract(this.currentSprite.extent().divideBy(2))),this.stage.add(this.currentSprite));this.add(this.stage)};
IDE_Morph.prototype.createStageHandle=function(){this.stageHandle&&this.stageHandle.destroy();this.stageHandle=new StageHandleMorph(this.stage);this.add(this.stageHandle)};
IDE_Morph.prototype.createSpriteBar=function(){function a(a){var c=h.rotationStyleColors;var d=new ToggleButtonMorph(c,h,function(){h.currentSprite instanceof SpriteMorph&&(h.currentSprite.rotationStyle=a,h.currentSprite.changed(),h.currentSprite.drawNew(),h.currentSprite.changed());b.forEach(function(a){a.refresh()})},f[a],function(){return h.currentSprite instanceof SpriteMorph&&h.currentSprite.rotationStyle===a},null,localize(g[a]));d.corner=8;d.labelMinExtent=new Point(11,11);d.padding=0;d.labelShadowOffset=
new Point(-1,-1);d.labelShadowColor=c[1];d.labelColor=h.buttonLabelColor;d.fixLayout();d.refresh();b.push(d);d.setPosition(h.spriteBar.position().add(2));d.setTop(d.top()+(b.length-1)*(d.height()+2));h.spriteBar.add(d);h.currentSprite instanceof StageMorph&&d.hide();return d}var b=[],c=new Point(45,45),d=this.tabColors,e=new AlignmentMorph("row",-30),f=["\u2192","\u21bb","\u2194"],g=["don't rotate","can rotate","only face left/right"],h=this;this.spriteBar&&this.spriteBar.destroy();this.spriteBar=
new Morph;this.spriteBar.color=this.frameColor;this.add(this.spriteBar);a(1);a(2);a(0);this.rotationStyleButtons=b;var k=new Morph;k.setExtent(c);k.image=this.currentSprite.thumbnail(c);k.setPosition(b[0].topRight().add(new Point(5,3)));this.spriteBar.add(k);k.fps=3;k.step=function(){k.version!==h.currentSprite.version&&(k.image=h.currentSprite.thumbnail(c),k.changed(),k.version=h.currentSprite.version)};var l=new InputFieldMorph(this.currentSprite.name);l.setWidth(100);l.contrast=90;l.setPosition(k.topRight().add(new Point(10,
3)));this.spriteBar.add(l);l.drawNew();l.accept=function(){var a=l.getValue();h.currentSprite.setName(h.newSpriteName(a,h.currentSprite));l.setContents(h.currentSprite.name)};this.spriteBar.reactToEdit=l.accept;var m=new ToggleMorph("checkbox",null,function(){h.currentSprite.isDraggable=!h.currentSprite.isDraggable},localize("draggable"),function(){return h.currentSprite.isDraggable});m.label.isBold=!1;m.label.setColor(this.buttonLabelColor);m.color=d[2];m.highlightColor=d[0];m.pressColor=d[1];m.tick.shadowOffset=
MorphicPreferences.isFlat?new Point:new Point(-1,-1);m.tick.shadowColor=new Color;m.tick.color=this.buttonLabelColor;m.tick.isBold=!1;m.tick.drawNew();m.setPosition(l.bottomLeft().add(2));m.drawNew();this.spriteBar.add(m);this.currentSprite instanceof StageMorph&&m.hide();e.tabTo=function(a){var b;h.currentTab=a;this.children.forEach(function(a){a.refresh();a.state&&(b=a)});b.refresh();h.createSpriteEditor();h.fixLayout("tabEditor")};m=new TabMorph(d,null,function(){e.tabTo("scripts")},localize("Scripts"),
function(){return"scripts"===h.currentTab});m.padding=3;m.corner=15;m.edge=1;m.labelShadowOffset=new Point(-1,-1);m.labelShadowColor=d[1];m.labelColor=this.buttonLabelColor;m.drawNew();m.fixLayout();e.add(m);m=new TabMorph(d,null,function(){e.tabTo("costumes")},localize(this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds"),function(){return"costumes"===h.currentTab});m.padding=3;m.corner=15;m.edge=1;m.labelShadowOffset=new Point(-1,-1);m.labelShadowColor=d[1];m.labelColor=this.buttonLabelColor;
m.drawNew();m.fixLayout();e.add(m);m=new TabMorph(d,null,function(){e.tabTo("sounds")},localize("Sounds"),function(){return"sounds"===h.currentTab});m.padding=3;m.corner=15;m.edge=1;m.labelShadowOffset=new Point(-1,-1);m.labelShadowColor=d[1];m.labelColor=this.buttonLabelColor;m.drawNew();m.fixLayout();e.add(m);e.fixLayout();e.children.forEach(function(a){a.refresh()});this.spriteBar.tabBar=e;this.spriteBar.add(this.spriteBar.tabBar);this.spriteBar.fixLayout=function(){this.tabBar.setLeft(this.left());
this.tabBar.setBottom(this.bottom())}};
IDE_Morph.prototype.createSpriteEditor=function(){var a=this.currentSprite.scripts,b=this;this.spriteEditor&&this.spriteEditor.destroy();"scripts"===this.currentTab?(a.isDraggable=!1,a.color=this.groupColor,a.cachedTexture=this.scriptsPaneTexture,this.spriteEditor=new ScrollFrameMorph(a,null,this.sliderColor),this.spriteEditor.padding=10,this.spriteEditor.growth=50,this.spriteEditor.isDraggable=!1,this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!0,a.scrollFrame=this.spriteEditor,
a.updateToolbar(),this.add(this.spriteEditor),this.spriteEditor.scrollX(this.spriteEditor.padding),this.spriteEditor.scrollY(this.spriteEditor.padding)):"costumes"===this.currentTab?(this.spriteEditor=new WardrobeMorph(this.currentSprite,this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptsDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):"sounds"===this.currentTab?(this.spriteEditor=new JukeboxMorph(this.currentSprite,
this.sliderColor),this.spriteEditor.color=this.groupColor,this.add(this.spriteEditor),this.spriteEditor.updateSelection(),this.spriteEditor.acceptDrops=!1,this.spriteEditor.contents.acceptsDrops=!1):(this.spriteEditor=new Morph,this.spriteEditor.color=this.groupColor,this.spriteEditor.acceptsDrops=!0,this.spriteEditor.reactToDropOf=function(a){a instanceof DialogBoxMorph?b.world().add(a):a instanceof SpriteMorph?b.removeSprite(a):a.destroy()},this.add(this.spriteEditor))};
IDE_Morph.prototype.createCorralBar=function(){var a=[this.groupColor,this.frameColor.darker(50),this.frameColor.darker(50)];this.corralBar&&this.corralBar.destroy();this.corralBar=new Morph;this.corralBar.color=this.frameColor;this.corralBar.setHeight(this.logo.height());this.add(this.corralBar);var b=new PushButtonMorph(this,"addNewSprite",new SymbolMorph("turtle",14));b.corner=12;b.color=a[0];b.highlightColor=a[1];b.pressColor=a[2];b.labelMinExtent=new Point(36,18);b.padding=0;b.labelShadowOffset=
new Point(-1,-1);b.labelShadowColor=a[1];b.labelColor=this.buttonLabelColor;b.contrast=this.buttonContrast;b.drawNew();b.hint="add a new Turtle sprite";b.fixLayout();b.setCenter(this.corralBar.center());b.setLeft(this.corralBar.left()+5);this.corralBar.add(b);var c=new PushButtonMorph(this,"paintNewSprite",new SymbolMorph("brush",15));c.corner=12;c.color=a[0];c.highlightColor=a[1];c.pressColor=a[2];c.labelMinExtent=new Point(36,18);c.padding=0;c.labelShadowOffset=new Point(-1,-1);c.labelShadowColor=
a[1];c.labelColor=this.buttonLabelColor;c.contrast=this.buttonContrast;c.drawNew();c.hint="paint a new sprite";c.fixLayout();c.setCenter(this.corralBar.center());c.setLeft(this.corralBar.left()+5+b.width()+5);this.corralBar.add(c);if(CamSnapshotDialogMorph.prototype.enableCamera){var d=new PushButtonMorph(this,"newCamSprite",new SymbolMorph("camera",15));d.corner=12;d.color=a[0];d.highlightColor=a[1];d.pressColor=a[2];d.labelMinExtent=new Point(36,18);d.padding=0;d.labelShadowOffset=new Point(-1,
-1);d.labelShadowColor=a[1];d.labelColor=this.buttonLabelColor;d.contrast=this.buttonContrast;d.drawNew();d.hint="take a camera snapshot and\nimport it as a new sprite";d.fixLayout();d.setCenter(this.corralBar.center());d.setLeft(this.corralBar.left()+5+b.width()+5+c.width()+5);this.corralBar.add(d);document.addEventListener("cameraDisabled",function(a){d.disable();d.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})}};
IDE_Morph.prototype.createCorral=function(){var a,b=this;this.createStageHandle();this.createPaletteHandle();this.corral&&this.corral.destroy();this.corral=new Morph;this.corral.color=this.groupColor;this.add(this.corral);this.corral.stageIcon=new SpriteIconMorph(this.stage);this.corral.stageIcon.isDraggable=!1;this.corral.add(this.corral.stageIcon);var c=new ScrollFrameMorph(null,null,this.sliderColor);c.acceptsDrops=!1;c.contents.acceptsDrops=!1;c.contents.wantsDropOf=function(a){return a instanceof
SpriteIconMorph};c.contents.reactToDropOf=function(a){b.corral.reactToDropOf(a)};c.alpha=0;this.sprites.asArray().forEach(function(b){b.isTemporary||(a=new SpriteIconMorph(b,a),c.contents.add(a))});this.corral.frame=c;this.corral.add(c);this.corral.fixLayout=function(){this.stageIcon.setCenter(this.center());this.stageIcon.setLeft(this.left()+5);this.frame.setLeft(this.stageIcon.right()+5);this.frame.setExtent(new Point(this.right()-this.frame.left(),this.height()));this.arrangeIcons();this.refresh()};
this.corral.arrangeIcons=function(){var a=this.frame.left(),b=this.frame.top(),c=this.frame.right(),g=this.frame.left();this.frame.contents.children.forEach(function(d){var e=d.width();a+e>c&&(a=g,b+=d.height());d.setPosition(new Point(a,b));a+=e});this.frame.contents.adjustBounds()};this.corral.addSprite=function(a){this.frame.contents.add(new SpriteIconMorph(a));this.fixLayout()};this.corral.refresh=function(){this.stageIcon.refresh();this.frame.contents.children.forEach(function(a){a.refresh()})};
this.corral.wantsDropOf=function(a){return a instanceof SpriteIconMorph};this.corral.reactToDropOf=function(a){var c=1,d=a.position();a.destroy();this.frame.contents.children.forEach(function(a){if(d.gt(a.position())||d.y>a.bottom())c+=1});b.sprites.add(a.object,c);b.createCorral();b.fixLayout()}};
IDE_Morph.prototype.fixLayout=function(a){var b=this.padding;Morph.prototype.trackChanges=!1;"refreshPalette"!==a&&(this.controlBar.setPosition(this.logo.topRight()),this.controlBar.setWidth(this.right()-this.controlBar.left()),this.controlBar.fixLayout(),this.categories.setLeft(this.logo.left()),this.categories.setTop(this.logo.bottom()),this.categories.setWidth(this.paletteWidth));this.palette.setLeft(this.logo.left());this.palette.setTop(this.categories.bottom());this.palette.setHeight(this.bottom()-
this.palette.top());this.palette.setWidth(this.paletteWidth);if("refreshPalette"!==a){if(this.isAppMode)this.stage.setScale(Math.floor(10*Math.min((this.width()-2*b)/this.stage.dimensions.x,(this.height()-2*this.controlBar.height()-2*b)/this.stage.dimensions.y))/10),this.stage.setCenter(this.center());else{this.stage.setScale(this.isSmallStage?this.stageRatio:1);this.stage.setTop(this.logo.bottom()+b);this.stage.setRight(this.right());var c=Math.max(200,this.width()-this.stage.width()-this.spriteBar.tabBar.width()-
2*this.padding);this.paletteWidth>c&&(this.paletteWidth=c,this.fixLayout());this.stageHandle.fixLayout();this.paletteHandle.fixLayout()}this.spriteBar.setLeft(this.paletteWidth+b);this.spriteBar.setTop(this.logo.bottom()+b);this.spriteBar.setExtent(new Point(Math.max(0,this.stage.left()-b-this.spriteBar.left()),this.categories.bottom()-this.spriteBar.top()-b));this.spriteBar.fixLayout();this.spriteEditor.isVisible&&(this.spriteEditor.setPosition(this.spriteBar.bottomLeft()),this.spriteEditor.setExtent(new Point(this.spriteBar.width(),
this.bottom()-this.spriteEditor.top())));this.corralBar.setLeft(this.stage.left());this.corralBar.setTop(this.stage.bottom()+b);this.corralBar.setWidth(this.stage.width());contains(["selectSprite","tabEditor"],a)||(this.corral.setPosition(this.corralBar.bottomLeft()),this.corral.setWidth(this.stage.width()),this.corral.setHeight(this.bottom()-this.corral.top()),this.corral.fixLayout())}Morph.prototype.trackChanges=!0;this.changed()};
IDE_Morph.prototype.setProjectName=function(a){this.projectName=a.replace(/['"]/g,"");this.hasChangedMedia=!0;this.controlBar.updateLabel()};
IDE_Morph.prototype.setExtent=function(a){var b=new Point(430,110);b=this.isAppMode?StageMorph.prototype.dimensions.add(this.controlBar.height()+10):1<this.stageRatio?b.add(StageMorph.prototype.dimensions):b.add(StageMorph.prototype.dimensions.multiplyBy(this.stageRatio));a=a.max(b);b=a.x-(200+this.spriteBar.tabBar.width()+2*this.padding);var c=3*SpriteIconMorph.prototype.thumbSize.x;this.stageRatio=Math.min(Math.min(b/this.stage.dimensions.x,(a.y-3.5*SpriteIconMorph.prototype.thumbSize.y)/this.stage.dimensions.y),
Math.max(c/this.stage.dimensions.x,this.stageRatio));IDE_Morph.uber.setExtent.call(this,a);this.fixLayout()};IDE_Morph.prototype.reactToWorldResize=function(a){this.isAutoFill&&(this.setPosition(a.origin),this.setExtent(a.extent()));this.filePicker&&(document.body.removeChild(this.filePicker),this.filePicker=null)};
IDE_Morph.prototype.droppedImage=function(a,b){a=new Costume(a,this.currentSprite.newCostumeName(b?b.split(".")[0]:""));a.isTainted()?this.inform("Unable to import this image","The picture you wish to import has been\ntainted by a restrictive cross-origin policy\nmaking it unusable for costumes in Snap!. \n\nTry downloading this picture first to your\ncomputer, and import it from there."):(this.currentSprite.addCostume(a),this.currentSprite.wearCostume(a),this.spriteBar.tabBar.tabTo("costumes"),this.hasChangedMedia=
!0)};IDE_Morph.prototype.droppedSVG=function(a,b){a=new SVG_Costume(a,b.split(".")[0]);this.currentSprite.addCostume(a);this.currentSprite.wearCostume(a);this.spriteBar.tabBar.tabTo("costumes");this.hasChangedMedia=!0};IDE_Morph.prototype.droppedAudio=function(a,b){this.currentSprite.addSound(a,b.split(".")[0]);this.spriteBar.tabBar.tabTo("sounds");this.hasChangedMedia=!0};
IDE_Morph.prototype.droppedText=function(a,b){b=b?b.split(".")[0]:"";if(0===a.indexOf("<project"))return location.hash="",this.openProjectString(a);if(0===a.indexOf("<snapdata"))return location.hash="",this.openCloudDataString(a);if(0===a.indexOf("<blocks"))return this.openBlocksString(a,b,!0);if(0===a.indexOf("<sprites"))return this.openSpritesString(a);if(0===a.indexOf("<media"))return this.openMediaString(a);if(0===a.indexOf("<script"))return this.openScriptString(a)};
IDE_Morph.prototype.droppedBinary=function(a,b){function c(a,b){var c=new sb.Reader,d=b.split(".")[0];c.onload=function(a){e.droppedText((new sb.XMLWriter).write(d,a))};c.readYPR(new Uint8Array(a))}var d=document.getElementById("ypr"),e=this;"ypr"===b.substring(b.length-3).toLowerCase()&&(d?c(a,b):(d=document.createElement("script"),d.id="ypr",d.onload=function(){c(a,b)},document.head.appendChild(d),d.src="ypr.js"))};
IDE_Morph.prototype.refreshPalette=function(a){var b=this.palette.contents.top();this.createPalette();this.fixLayout("refreshPalette");a||this.palette.contents.setTop(b)};IDE_Morph.prototype.pressStart=function(){16===this.world().currentKey?this.toggleFastTracking():(this.stage.threads.pauseCustomHatBlocks=!1,this.controlBar.stopButton.refresh(),this.runScripts())};IDE_Morph.prototype.toggleFastTracking=function(){this.stage.isFastTracked?this.stopFastTracking():this.startFastTracking()};
IDE_Morph.prototype.toggleVariableFrameRate=function(){StageMorph.prototype.frameRate?(StageMorph.prototype.frameRate=0,this.stage.fps=0):(StageMorph.prototype.frameRate=30,this.stage.fps=30)};IDE_Morph.prototype.toggleSingleStepping=function(){this.stage.threads.toggleSingleStepping();this.controlBar.steppingButton.refresh();this.controlBar.refreshSlider()};
IDE_Morph.prototype.toggleCameraSupport=function(){CamSnapshotDialogMorph.prototype.enableCamera=!CamSnapshotDialogMorph.prototype.enableCamera;this.spriteBar.tabBar.tabTo(this.currentTab);this.createCorralBar();this.fixLayout()};IDE_Morph.prototype.startFastTracking=function(){this.stage.isFastTracked=!0;this.stage.fps=0;this.controlBar.startButton.labelString=new SymbolMorph("flash",14);this.controlBar.startButton.drawNew();this.controlBar.startButton.fixLayout()};
IDE_Morph.prototype.stopFastTracking=function(){this.stage.isFastTracked=!1;this.stage.fps=this.stage.frameRate;this.controlBar.startButton.labelString=new SymbolMorph("flag",14);this.controlBar.startButton.drawNew();this.controlBar.startButton.fixLayout()};IDE_Morph.prototype.runScripts=function(){this.stage.fireGreenFlagEvent()};IDE_Morph.prototype.togglePauseResume=function(){this.stage.threads.isPaused()?this.stage.threads.resumeAll(this.stage):this.stage.threads.pauseAll(this.stage);this.controlBar.pauseButton.refresh()};
IDE_Morph.prototype.isPaused=function(){return this.stage?this.stage.threads.isPaused():!1};IDE_Morph.prototype.stopAllScripts=function(){this.stage.threads.pauseCustomHatBlocks=this.stage.enableCustomHatBlocks?!this.stage.threads.pauseCustomHatBlocks:!1;this.controlBar.stopButton.refresh();this.stage.fireStopAllEvent()};
IDE_Morph.prototype.selectSprite=function(a){this.currentSprite&&this.currentSprite.scripts.focus&&this.currentSprite.scripts.focus.stopEditing();this.currentSprite=a;this.createPalette();this.createSpriteBar();this.createSpriteEditor();this.corral.refresh();this.fixLayout("selectSprite");this.currentSprite.scripts.fixMultiArgs()};
IDE_Morph.prototype.toggleRetina=function(){isRetinaEnabled()?disableRetinaSupport():enableRetinaSupport();this.world().fillPage();IDE_Morph.prototype.scriptsPaneTexture=this.scriptsTexture();this.stage.clearPenTrails();this.drawNew();this.refreshIDE()};IDE_Morph.prototype.defaultDesign=function(){this.setDefaultDesign();this.refreshIDE();this.removeSetting("design")};IDE_Morph.prototype.flatDesign=function(){this.setFlatDesign();this.refreshIDE();this.saveSetting("design","flat")};
IDE_Morph.prototype.refreshIDE=function(){if(Process.prototype.isCatchingErrors)try{var a=this.serializer.serialize(this.stage)}catch(b){this.showMessage("Serialization failed: "+b)}else a=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks();this.buildPanes();this.fixLayout();this.loadNewProject?this.newProject():this.openProjectString(a)};
IDE_Morph.prototype.applySavedSettings=function(){var a=this.getSetting("design"),b=this.getSetting("zoom"),c=this.getSetting("language"),d=this.getSetting("click"),e=this.getSetting("longform"),f=this.getSetting("longurls"),g=this.getSetting("plainprototype"),h=this.getSetting("keyboard"),k=this.getSetting("tables"),l=this.getSetting("tableLines"),m=this.getSetting("autowrapping");"flat"===a?this.setFlatDesign():this.setDefaultDesign();b&&(SyntaxElementMorph.prototype.setScale(Math.min(b,12)),CommentMorph.prototype.refreshScale(),
SpriteMorph.prototype.initBlocks());this.userLanguage=c&&"en"!==c?c:null;d&&!BlockMorph.prototype.snapSound&&BlockMorph.prototype.toggleSnapSound();e&&(InputSlotDialogMorph.prototype.isLaunchingExpanded=!0);this.projectsInURLs=f?!0:!1;ScriptsMorph.prototype.enableKeyboard="false"===h?!1:!0;List.prototype.enableTables="false"===k?!1:!0;TableMorph.prototype.highContrast=l?!0:!1;ScriptsMorph.prototype.enableNestedAutoWrapping="false"===m?!1:!0;g&&(BlockLabelPlaceHolderMorph.prototype.plainLabel=!0)};
IDE_Morph.prototype.saveSetting=function(a,b){this.savingPreferences&&this.hasLocalStorage()&&(localStorage["-snap-setting-"+a]=b)};IDE_Morph.prototype.getSetting=function(a){return this.hasLocalStorage()?localStorage["-snap-setting-"+a]:null};IDE_Morph.prototype.removeSetting=function(a){this.hasLocalStorage()&&delete localStorage["-snap-setting-"+a]};IDE_Morph.prototype.hasLocalStorage=function(){try{return!isNil(localStorage)}catch(a){return!1}};
IDE_Morph.prototype.addNewSprite=function(){var a=new SpriteMorph(this.globalVariables),b=Process.prototype.reportRandom;a.name=this.newSpriteName(a.name);a.setCenter(this.stage.center());this.stage.add(a);a.setHue(b.call(this,0,100));a.setBrightness(b.call(this,50,100));a.turn(b.call(this,1,360));a.setXPosition(b.call(this,-220,220));a.setYPosition(b.call(this,-160,160));this.sprites.add(a);this.corral.addSprite(a);this.selectSprite(a)};
IDE_Morph.prototype.paintNewSprite=function(){var a=new SpriteMorph(this.globalVariables),b=new Costume,c=this;a.name=this.newSpriteName(a.name);a.setCenter(this.stage.center());this.stage.add(a);this.sprites.add(a);this.corral.addSprite(a);this.selectSprite(a);b.edit(this.world(),this,!0,function(){c.removeSprite(a)},function(){a.addCostume(b);a.wearCostume(b)})};
IDE_Morph.prototype.newCamSprite=function(){var a=new SpriteMorph(this.globalVariables),b=this;a.name=this.newSpriteName(a.name);a.setCenter(this.stage.center());this.stage.add(a);this.sprites.add(a);this.corral.addSprite(a);this.selectSprite(a);(new CamSnapshotDialogMorph(this,a,function(){b.removeSprite(a)},function(b){a.addCostume(b);a.wearCostume(b);this.close()})).popUp(this.world())};
IDE_Morph.prototype.duplicateSprite=function(a){a=a.fullCopy();a.setPosition(this.world().hand.position());a.appearIn(this);a.keepWithin(this.stage);this.selectSprite(a)};IDE_Morph.prototype.instantiateSprite=function(a){a=a.fullCopy(!0);var b=a.allHatBlocksFor("__clone__init__");a.appearIn(this);b.length?a.initClone(b):(a.setPosition(this.world().hand.position()),a.keepWithin(this.stage));this.selectSprite(a)};
IDE_Morph.prototype.removeSprite=function(a){var b=this;a.parts.forEach(function(a){b.removeSprite(a)});var c=this.sprites.asArray().indexOf(a)+1;this.stage.threads.stopAllForReceiver(a);a.corpsify();a.destroy();this.stage.watchers().forEach(function(b){b.object()===a&&b.destroy()});0<c&&this.sprites.remove(c);this.createCorral();this.fixLayout();this.currentSprite=detect(this.stage.children,function(a){return a instanceof SpriteMorph&&!a.isTemporary})||this.stage;this.selectSprite(this.currentSprite)};
IDE_Morph.prototype.newSpriteName=function(a,b){var c=a.indexOf("(");a=0>c?a:a.substring(0,c);c=1;for(var d=a,e=this.sprites.asArray().concat(this.stage).filter(function(a){return a!==b}).map(function(a){return a.name});contains(e,d);)c+=1,d=a+"("+c+")";return d};IDE_Morph.prototype.removeBlock=function(a,b){this.stage.threads.stopAllForBlock(a);a.destroy(b)};IDE_Morph.prototype.userMenu=function(){return new MenuMorph(this)};
IDE_Morph.prototype.snapMenu=function(){var a=this,b=this.world();var c=new MenuMorph(this);c.addItem("About...","aboutSnap");c.addLine();c.addItem("Reference manual",function(){var b=a.resourceURL("help","SnapManual.pdf");window.open(b,"SnapReferenceManual")});c.addItem("Snap! website",function(){window.open("http://snap.berkeley.edu/","SnapWebsite")});c.addItem("Download source",function(){window.open("http://snap.berkeley.edu/snapsource/snap.zip","SnapSource")});b.isDevMode?(c.addLine(),c.addItem("Switch back to user mode",
"switchToUserMode","disable deep-Morphic\ncontext menus\nand show user-friendly ones",new Color(0,100,0))):16===b.currentKey&&(c.addLine(),c.addItem("Switch to dev mode","switchToDevMode","enable Morphic\ncontext menus\nand inspectors,\nnot user-friendly!",new Color(100,0,0)));c.popup(b,this.logo.bottomLeft())};
IDE_Morph.prototype.cloudMenu=function(){var a=this,b=this.world(),c=this.controlBar.cloudButton.bottomLeft(),d=16===b.currentKey;var e=new MenuMorph(this);d&&(e.addItem("url...","setCloudURL",null,new Color(100,0,0)),e.addLine());SnapCloud.username?(e.addItem(localize("Logout")+" "+SnapCloud.username,"logout"),e.addItem("Change Password...","changeCloudPassword")):(e.addItem("Login...","initializeCloud"),e.addItem("Signup...","createCloudAccount"),e.addItem("Reset Password...","resetCloudPassword"));
d&&(e.addLine(),e.addItem("export project media only...",function(){a.projectName?a.exportProjectMedia(a.projectName):a.prompt("Export Project As...",function(b){a.exportProjectMedia(b)},null,"exportProject")},null,this.hasChangedMedia?new Color(100,0,0):new Color(0,100,0)),e.addItem("export project without media...",function(){a.projectName?a.exportProjectNoMedia(a.projectName):a.prompt("Export Project As...",function(b){a.exportProjectNoMedia(b)},null,"exportProject")},null,new Color(100,0,0)),
e.addItem("export project as cloud data...",function(){a.projectName?a.exportProjectAsCloudData(a.projectName):a.prompt("Export Project As...",function(b){a.exportProjectAsCloudData(b)},null,"exportProject")},null,new Color(100,0,0)),e.addLine(),e.addItem("open shared project from cloud...",function(){a.prompt("Author name\u2026",function(b){a.prompt("Project name...",function(c){c="Username="+encodeURIComponent(b.toLowerCase())+"&ProjectName="+encodeURIComponent(c);a.showMessage("Fetching project\nfrom the cloud...");
SnapCloud.getPublicProject(c,function(b){var c;Process.prototype.isCatchingErrors||window.open("data:text/xml,"+b);a.nextSteps([function(){c=a.showMessage("Opening project...")},function(){nop()},function(){a.rawOpenCloudDataString(b)},function(){c.destroy()}])},a.cloudError())},null,"project")},null,"project")},null,new Color(100,0,0)));e.popup(b,c)};
IDE_Morph.prototype.settingsMenu=function(){function a(a,b,c,d,e,p){p&&!f||g.addItem((c?"\u2611 ":"\u2610 ")+localize(a),b,c?d:e,p?new Color(100,0,0):null)}var b=this.stage,c=this.world(),d=this,e=this.controlBar.settingsButton.bottomLeft(),f=16===c.currentKey;var g=new MenuMorph(this);g.addItem("Language...","languageMenu");g.addItem("Zoom blocks...","userSetBlocksScale");g.addItem("Stage size...","userSetStageSize");f&&g.addItem("Dragging threshold...","userSetDragThreshold","specify the distance the hand has to move\nbefore it picks up an object",
new Color(100,0,0));g.addLine();isRetinaSupported()&&a("Retina display support","toggleRetina",isRetinaEnabled(),"uncheck for lower resolution,\nsaves computing resources","check for higher resolution,\nuses more computing resources");a("Input sliders","toggleInputSliders",MorphicPreferences.useSliderForInput,"uncheck to disable\ninput sliders for\nentry fields","check to enable\ninput sliders for\nentry fields");MorphicPreferences.useSliderForInput&&a("Execute on slider change","toggleSliderExecute",
ArgMorph.prototype.executeOnSliderEdit,"uncheck to suppress\nrunning scripts\nwhen moving the slider","check to run\nthe edited script\nwhen moving the slider");a("Turbo mode","toggleFastTracking",this.stage.isFastTracked,"uncheck to run scripts\nat normal speed","check to prioritize\nscript execution");a("Visible stepping","toggleSingleStepping",Process.prototype.enableSingleStepping,"uncheck to turn off\nvisible stepping","check to turn on\n visible stepping (slow)",!1);a("Ternary Boolean slots",
function(){BooleanSlotMorph.prototype.isTernary=!BooleanSlotMorph.prototype.isTernary},BooleanSlotMorph.prototype.isTernary,"uncheck to limit\nBoolean slots to true / false","check to allow\nempty Boolean slots",!0);a("Camera support","toggleCameraSupport",CamSnapshotDialogMorph.prototype.enableCamera,"uncheck to disable\ncamera support","check to enable\ncamera support",!0);g.addLine();a("Blurred shadows","toggleBlurredShadows",useBlurredShadows,"uncheck to use solid drop\nshadows and highlights",
"check to use blurred drop\nshadows and highlights",!0);a("Zebra coloring","toggleZebraColoring",BlockMorph.prototype.zebraContrast,"uncheck to disable alternating\ncolors for nested block","check to enable alternating\ncolors for nested blocks",!0);a("Dynamic input labels","toggleDynamicInputLabels",SyntaxElementMorph.prototype.dynamicInputLabels,"uncheck to disable dynamic\nlabels for variadic inputs","check to enable dynamic\nlabels for variadic inputs",!0);a("Prefer empty slot drops","togglePreferEmptySlotDrops",
ScriptsMorph.prototype.isPreferringEmptySlots,"uncheck to allow dropped\nreporters to kick out others","settings menu prefer empty slots hint",!0);a("Long form input dialog","toggleLongFormInputDialog",InputSlotDialogMorph.prototype.isLaunchingExpanded,"uncheck to use the input\ndialog in short form","check to always show slot\ntypes in the input dialog");a("Plain prototype labels","togglePlainPrototypeLabels",BlockLabelPlaceHolderMorph.prototype.plainLabel,"uncheck to always show (+) symbols\nin block prototype labels",
"check to hide (+) symbols\nin block prototype labels");a("Virtual keyboard","toggleVirtualKeyboard",MorphicPreferences.useVirtualKeyboard,"uncheck to disable\nvirtual keyboard support\nfor mobile devices","check to enable\nvirtual keyboard support\nfor mobile devices",!0);a("Clicking sound",function(){BlockMorph.prototype.toggleSnapSound();BlockMorph.prototype.snapSound?d.saveSetting("click",!0):d.removeSetting("click")},BlockMorph.prototype.snapSound,"uncheck to turn\nblock clicking\nsound off",
"check to turn\nblock clicking\nsound on");a("Animations",function(){d.isAnimating=!d.isAnimating},d.isAnimating,"uncheck to disable\nIDE animations","check to enable\nIDE animations",!0);a("Cache Inputs",function(){BlockMorph.prototype.isCachingInputs=!BlockMorph.prototype.isCachingInputs},BlockMorph.prototype.isCachingInputs,"uncheck to stop caching\ninputs (for debugging the evaluator)","check to cache inputs\nboosts recursion",!0);a("Rasterize SVGs",function(){MorphicPreferences.rasterizeSVGs=
!MorphicPreferences.rasterizeSVGs},MorphicPreferences.rasterizeSVGs,"uncheck for smooth\nscaling of vector costumes","check to rasterize\nSVGs on import",!0);a("Flat design",function(){if(MorphicPreferences.isFlat)return d.defaultDesign();d.flatDesign()},MorphicPreferences.isFlat,"uncheck for default\nGUI design","check for alternative\nGUI design",!1);a("Nested auto-wrapping",function(){ScriptsMorph.prototype.enableNestedAutoWrapping=!ScriptsMorph.prototype.enableNestedAutoWrapping;ScriptsMorph.prototype.enableNestedAutoWrapping?
d.removeSetting("autowrapping"):d.saveSetting("autowrapping",!1)},ScriptsMorph.prototype.enableNestedAutoWrapping,"uncheck to confine auto-wrapping\nto top-level block stacks","check to enable auto-wrapping\ninside nested block stacks",!0);a("Project URLs",function(){d.projectsInURLs=!d.projectsInURLs;d.projectsInURLs?d.saveSetting("longurls",!0):d.removeSetting("longurls")},d.projectsInURLs,"uncheck to disable\nproject data in URLs","check to enable\nproject data in URLs",!0);a("Sprite Nesting",
function(){SpriteMorph.prototype.enableNesting=!SpriteMorph.prototype.enableNesting},SpriteMorph.prototype.enableNesting,"uncheck to disable\nsprite composition","check to enable\nsprite composition",!0);a("First-Class Sprites",function(){SpriteMorph.prototype.enableFirstClass=!SpriteMorph.prototype.enableFirstClass;d.currentSprite.blocksCache.sensing=null;d.currentSprite.paletteCache.sensing=null;d.refreshPalette()},SpriteMorph.prototype.enableFirstClass,"uncheck to disable support\nfor first-class sprites",
"check to enable support\n for first-class sprite",!0);a("Keyboard Editing",function(){ScriptsMorph.prototype.enableKeyboard=!ScriptsMorph.prototype.enableKeyboard;d.currentSprite.scripts.updateToolbar();ScriptsMorph.prototype.enableKeyboard?d.removeSetting("keyboard"):d.saveSetting("keyboard",!1)},ScriptsMorph.prototype.enableKeyboard,"uncheck to disable\nkeyboard editing support","check to enable\nkeyboard editing support",!0);a("Table support",function(){List.prototype.enableTables=!List.prototype.enableTables;
List.prototype.enableTables?d.removeSetting("tables"):d.saveSetting("tables",!1)},List.prototype.enableTables,"uncheck to disable\nmulti-column list views","check for multi-column\nlist view support",!0);List.prototype.enableTables&&a("Table lines",function(){TableMorph.prototype.highContrast=!TableMorph.prototype.highContrast;TableMorph.prototype.highContrast?d.saveSetting("tableLines",!0):d.removeSetting("tableLines")},TableMorph.prototype.highContrast,"uncheck for less contrast\nmulti-column list views",
"check for higher contrast\ntable views",!0);a("Live coding support",function(){Process.prototype.enableLiveCoding=!Process.prototype.enableLiveCoding},Process.prototype.enableLiveCoding,"EXPERIMENTAL! uncheck to disable live\ncustom control structures","EXPERIMENTAL! check to enable\n live custom control structures",!0);g.addLine();a("Thread safe scripts",function(){b.isThreadSafe=!b.isThreadSafe},this.stage.isThreadSafe,"uncheck to allow\nscript reentrance","check to disallow\nscript reentrance");
a("Prefer smooth animations","toggleVariableFrameRate",StageMorph.prototype.frameRate,"uncheck for greater speed\nat variable frame rates","check for smooth, predictable\nanimations across computers",!0);a("Flat line ends",function(){SpriteMorph.prototype.useFlatLineEnds=!SpriteMorph.prototype.useFlatLineEnds},SpriteMorph.prototype.useFlatLineEnds,"uncheck for round ends of lines","check for flat ends of lines");a("Codification support",function(){StageMorph.prototype.enableCodeMapping=!StageMorph.prototype.enableCodeMapping;
d.currentSprite.blocksCache.variables=null;d.currentSprite.paletteCache.variables=null;d.refreshPalette()},StageMorph.prototype.enableCodeMapping,"uncheck to disable\nblock to text mapping features","check for block\nto text mapping features",!1);a("Inheritance support",function(){StageMorph.prototype.enableInheritance=!StageMorph.prototype.enableInheritance;d.currentSprite.blocksCache.variables=null;d.currentSprite.paletteCache.variables=null;d.refreshPalette()},StageMorph.prototype.enableInheritance,
"uncheck to disable\nsprite inheritance features","check for sprite\ninheritance features",!1);a("Persist linked sublist IDs",function(){StageMorph.prototype.enableSublistIDs=!StageMorph.prototype.enableSublistIDs},StageMorph.prototype.enableSublistIDs,"uncheck to disable\nsaving linked sublist identities","check to enable\nsaving linked sublist identities",!0);g.popup(c,e)};
IDE_Morph.prototype.projectMenu=function(){var a=this,b=this.world(),c=this.controlBar.projectButton.bottomLeft(),d=this.currentSprite instanceof SpriteMorph?"Costumes":"Backgrounds",e=16===b.currentKey;var f=new MenuMorph(this);f.addItem("Project notes...","editProjectNotes");f.addLine();f.addPair("New","createNewProject","^N");f.addPair("Open...","openProjectsBrowser","^O");f.addPair("Save","save","^S");f.addItem("Save As...","saveProjectsBrowser");f.addLine();f.addItem("Import...",function(){var c=
document.createElement("input");a.filePicker&&(document.body.removeChild(a.filePicker),a.filePicker=null);c.type="file";c.style.color="transparent";c.style.backgroundColor="transparent";c.style.border="none";c.style.outline="none";c.style.position="absolute";c.style.top="0px";c.style.left="0px";c.style.width="0px";c.style.height="0px";c.style.display="none";c.addEventListener("change",function(){document.body.removeChild(c);a.filePicker=null;b.hand.processDrop(c.files)},!1);document.body.appendChild(c);
a.filePicker=c;c.click()},"file menu import hint");e&&f.addItem(localize("Export project...")+" "+localize("(in a new window)"),function(){a.projectName?a.exportProject(a.projectName,e):a.prompt("Export Project As...",function(b){a.exportProject(b,!1)},null,"exportProject")},"show project data as XML\nin a new browser window",new Color(100,0,0));f.addItem(e?"Export project as plain text...":"Export project...",function(){a.projectName?a.exportProject(a.projectName,e):a.prompt("Export Project As...",
function(b){a.exportProject(b,e)},null,"exportProject")},"save project data as XML\nto your downloads folder",e?new Color(100,0,0):null);this.stage.globalBlocks.length&&(f.addItem("Export blocks...",function(){a.exportGlobalBlocks()},"show global custom block definitions as XML\nin a new browser window"),f.addItem("Unused blocks...",function(){a.removeUnusedBlocks()},"find unused global custom blocks\nand remove their definitions"));f.addItem("Export summary...",function(){a.exportProjectSummary()},
"open a new browser browser window\n with a summary of this project");e&&(f.addItem("Export summary with drop-shadows...",function(){a.exportProjectSummary(!0)},"open a new browser browser window\nwith a summary of this project\nwith drop-shadows on all pictures.\nnot supported by all browsers",new Color(100,0,0)),f.addItem("Export all scripts as pic...",function(){a.exportScriptsPicture()},"show a picture of all scripts\nand block definitions",new Color(100,0,0)));f.addLine();f.addItem("Import tools",
function(){a.getURL(a.resourceURL("tools.xml"),function(b){a.droppedText(b,"tools")})},"load the official library of\npowerful blocks");f.addItem("Libraries...",function(){a.getURL(a.resourceURL("libraries","LIBRARIES"),function(b){b=a.parseResourceFile(b);(new LibraryImportDialogMorph(a,b)).popUp()})},"Select categories of additional blocks to add to this project.");f.addItem(localize(d)+"...",function(){a.importMedia(d)},"Select a costume from the media library");f.addItem(localize("Sounds")+"...",
function(){a.importMedia("Sounds")},"Select a sound from the media library");f.popup(b,c)};IDE_Morph.prototype.resourceURL=function(){return Array.prototype.slice.call(arguments,0).join("/")};
IDE_Morph.prototype.getMediaList=function(a,b){function c(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:1}a=this.resourceURL(a,a.toUpperCase());var d=this;if(b instanceof Function)this.getURL(a,function(a){a=d.parseResourceFile(a);a.sort(c);b.call(this,a)});else return a=this.parseResourceFile(this.getURL(a)),a.sort(c),a};
IDE_Morph.prototype.parseResourceFile=function(a){var b,c=[];a.split("\n").map(function(a){return a.trim()}).filter(function(a){return 0<a.length}).forEach(function(a){b=a.split("\t").map(function(a){return a.trim()});2>b.length||c.push({fileName:b[0],name:b[1],description:2<b.length?b[2]:""})});return c};IDE_Morph.prototype.importMedia=function(a){var b=this,c=this.showMessage("Opening "+a+"...");this.getMediaList(a,function(d){c.destroy();b.popupMediaImportDialog(a,d)})};
IDE_Morph.prototype.popupMediaImportDialog=function(a,b){var c=(new DialogBoxMorph).withKey("import"+a),d=new ScrollFrameMorph,e=null,f=new SymbolMorph("turtle",60),g=this,h=this.world();d.acceptsDrops=!1;d.contents.acceptsDrops=!1;d.color=g.groupColor;d.fixLayout=nop;c.labelString=a;c.createLabel();c.addBody(d);c.addButton("ok","Import");c.addButton("cancel","Cancel");c.ok=function(){e&&(e.object instanceof Sound?g.droppedAudio(e.object.copy().audio,e.labelString):e.object instanceof SVG_Costume?
g.droppedSVG(e.object.contents,e.labelString):g.droppedImage(e.object.contents,e.labelString))};c.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding,b=0,c=0;this.buttons.fixLayout();this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding)));this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height()));var e=this.body.position();var f=this.body.width();d.contents.children.forEach(function(a){a.setPosition(e.add(new Point(b,
c)));b+=a.width();b+a.width()>f&&(b=0,c+=a.height())});d.contents.adjustBounds();this.label.setCenter(this.center());this.label.setTop(this.top()+(a-this.label.height())/2);this.buttons.setCenter(this.center());this.buttons.setBottom(this.bottom()-this.padding)};b.forEach(function(b){var h=g.resourceURL(a,b.fileName),k=new Image,n=h.slice(h.lastIndexOf(".")+1).toLowerCase(),p="svg"===n&&!MorphicPreferences.rasterizeSVGs;n=contains(["wav","mp3"],n);var q,t,r;n?t=r=new SoundIconMorph(new Sound(new Audio,
b.name),t):q=r=new CostumeIconMorph(new Costume(f.image,b.name),q);r.isDraggable=!1;r.userMenu=nop;r.action=function(){if(e!==r){var a=e;e=r;a&&a.refresh()}};r.doubleClickAction=c.ok;r.query=function(){return r===e};d.addContents(r);n?(r.object.audio.onloadeddata=function(){r.createThumbnail();r.fixLayout();r.refresh()},r.object.audio.src=h,r.object.audio.load()):p?(k.onload=function(){r.object=new SVG_Costume(k,b.name);r.refresh()},g.getURL(h,function(a){k.src="data:image/svg+xml;base64,"+window.btoa(a)})):
(k.onload=function(){var a=newCanvas(new Point(k.width,k.height),!0);a.getContext("2d").drawImage(k,0,0);r.object=new Costume(a,b.name);r.refresh()},k.src=h)});c.popUp(h);c.setExtent(new Point(400,300));c.setCenter(h.center());c.drawNew();new HandleMorph(c,300,280,c.corner,c.corner)};
IDE_Morph.prototype.aboutSnap=function(){var a="",b,c=this.world();var d=localize("License")+"\n\nSnap! is free software: you can redistribute it and/or modify\nit under the terms of the GNU Affero General Public License as\npublished by the Free Software Foundation, either version 3 of\nthe License, or (at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\nGNU Affero General Public License for more details.\n\nYou should have received a copy of the\nGNU Affero General Public License along with this program.\nIf not, see http://www.gnu.org/licenses/\n\nWant to use Snap! but scared by the open-source license?\nGet in touch with us, we'll make it work.";var e=
localize("Contributors")+'\n\nNathan Dinsmore: Saving/Loading, Snap-Logo Design, \ncountless bugfixes and optimizations\nKartik Chandra: Paint Editor\nMichael Ball: Time/Date UI, Library Import Dialog,\ncountless bugfixes and optimizations\nBartosz Leper: Retina Display Support\nBernat Romagosa: Countless contributions\n"Ava" Yuan Yuan, Dylan Servilla: Graphic Effects\nKyle Hotchkiss: Block search design\nBrian Broll: Many bugfixes and optimizations\nIan Reynolds: UI Design, Event Bindings, Sound primitives\nIvan Motyashov: Initial Squeak Porting\nLucas Karahadian: Piano Keyboard Design\nDavide Della Casa: Morphic Optimizations\nAchal Dave: Web Audio\nJoe Otto: Morphic Testing and Debugging';
for(b in modules)Object.prototype.hasOwnProperty.call(modules,b)&&(a+="\n"+b+" ("+modules[b]+")");""!==a&&(a=localize("current module versions:")+" \n\nmorphic ("+morphicVersion+")"+a);var f=localize("Translations")+"\n"+SnapTranslator.credits();var g=new DialogBoxMorph;g.inform("About Snap","Snap! 4.1.0.4\nBuild Your Own Blocks\n\nCopyright \u24b8 2017 Jens M\u00f6nig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\nSnap! is developed by the University of California, Berkeley\n          with support from the National Science Foundation (NSF), MioSoft,          \nthe Communications Design Group (CDG) at SAP Labs, and the\nHuman Advancement Research Community (HARC) at YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu",
c);var h=g.buttons.children[0];var k=g.addButton(function(){g.body.text=f;g.body.drawNew();h.show();l.show();n.hide();p.hide();m.hide();k.hide();g.fixLayout();g.drawNew();g.setCenter(c.center())},"Translators...");var l=g.addButton(function(){g.body.text="Snap! 4.1.0.4\nBuild Your Own Blocks\n\nCopyright \u24b8 2017 Jens M\u00f6nig and Brian Harvey\njens@moenig.org, bh@cs.berkeley.edu\n\nSnap! is developed by the University of California, Berkeley\n          with support from the National Science Foundation (NSF), MioSoft,          \nthe Communications Design Group (CDG) at SAP Labs, and the\nHuman Advancement Research Community (HARC) at YC Research.\nThe design of Snap! is influenced and inspired by Scratch,\nfrom the Lifelong Kindergarten group at the MIT Media Lab\n\nfor more information see http://snap.berkeley.edu\nand http://scratch.mit.edu";
g.body.drawNew();h.show();l.hide();n.show();p.show();m.show();k.hide();g.fixLayout();g.drawNew();g.setCenter(c.center())},"Back...");l.hide();var m=g.addButton(function(){g.body.text=d;g.body.drawNew();h.show();l.show();n.hide();p.hide();m.hide();k.hide();g.fixLayout();g.drawNew();g.setCenter(c.center())},"License...");var n=g.addButton(function(){g.body.text=a;g.body.drawNew();h.show();l.show();n.hide();p.hide();m.hide();k.hide();g.fixLayout();g.drawNew();g.setCenter(c.center())},"Modules...");var p=
g.addButton(function(){g.body.text=e;g.body.drawNew();h.show();l.show();k.show();n.hide();p.hide();m.hide();g.fixLayout();g.drawNew();g.setCenter(c.center())},"Credits...");k.hide();g.fixLayout();g.drawNew()};
IDE_Morph.prototype.editProjectNotes=function(){var a=(new DialogBoxMorph).withKey("projectNotes"),b=new ScrollFrameMorph,c=new TextMorph(this.projectNotes||""),d=a.ok,e=this,f=this.world();b.padding=6;b.setWidth(250);b.acceptsDrops=!1;b.contents.acceptsDrops=!1;c.setWidth(250-2*b.padding);c.setPosition(b.topLeft().add(b.padding));c.enableSelecting();c.isEditable=!0;b.setHeight(250);b.fixLayout=nop;b.edge=InputFieldMorph.prototype.edge;b.fontSize=InputFieldMorph.prototype.fontSize;b.typeInPadding=
InputFieldMorph.prototype.typeInPadding;b.contrast=InputFieldMorph.prototype.contrast;b.drawNew=InputFieldMorph.prototype.drawNew;b.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;b.addContents(c);c.drawNew();a.ok=function(){e.projectNotes=c.text;d.call(this)};a.justDropped=function(){c.edit()};a.labelString="Project Notes";a.createLabel();a.addBody(b);b.drawNew();a.addButton("ok","OK");a.addButton("cancel","Cancel");a.fixLayout();a.drawNew();a.popUp(f);a.setCenter(f.center());c.edit()};
IDE_Morph.prototype.newProject=function(){this.source=SnapCloud.username?"cloud":"local";this.stage&&this.stage.destroy();"#lang:"!==location.hash.substr(0,6)&&(location.hash="");this.globalVariables=new VariableFrame;this.currentSprite=new SpriteMorph(this.globalVariables);this.sprites=new List([this.currentSprite]);StageMorph.prototype.dimensions=new Point(480,360);StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=
!1;StageMorph.prototype.enableInheritance=!0;StageMorph.prototype.enableSublistIDs=!1;SpriteMorph.prototype.useFlatLineEnds=!1;Process.prototype.enableLiveCoding=!1;this.setProjectName("");this.projectNotes="";this.createStage();this.add(this.stage);this.createCorral();this.selectSprite(this.stage.children[0]);this.fixLayout()};
IDE_Morph.prototype.save=function(){"examples"===this.source&&(this.source="local");this.projectName?"local"===this.source?this.saveProject(this.projectName):this.saveProjectToCloud(this.projectName):this.saveProjectsBrowser()};IDE_Morph.prototype.saveProject=function(a){var b=this;this.nextSteps([function(){b.showMessage("Saving...")},function(){b.rawSaveProject(a)}])};
IDE_Morph.prototype.rawSaveProject=function(a){var b;if(a)if(this.setProjectName(a),Process.prototype.isCatchingErrors)try{localStorage["-snap-project-"+a]=b=this.serializer.serialize(this.stage),this.setURL("#open:"+b),this.showMessage("Saved!",1)}catch(c){this.showMessage("Save failed: "+c)}else localStorage["-snap-project-"+a]=b=this.serializer.serialize(this.stage),this.setURL("#open:"+b),this.showMessage("Saved!",1)};
IDE_Morph.prototype.exportProject=function(a,b){if(a){this.setProjectName(a);b="data:text/"+b?"plain,":"xml,";try{var c=this.showMessage("Exporting");var d=this.serializer.serialize(this.stage);this.setURL("#open:"+b+encodeURIComponent(d));this.saveXMLAs(d,a);c.destroy();this.showMessage("Exported!",1)}catch(e){if(Process.prototype.isCatchingErrors)this.showMessage("Export failed: "+e);else throw e;}}};
IDE_Morph.prototype.exportGlobalBlocks=function(){0<this.stage.globalBlocks.length?(new BlockExportDialogMorph(this.serializer,this.stage.globalBlocks)).popUp(this.world()):this.inform("Export blocks","this project doesn't have any\ncustom global blocks yet")};
IDE_Morph.prototype.removeUnusedBlocks=function(){function a(){return c.filter(function(a){return contains(d,a)?!1:b.every(function(b,c){return!b.usesBlockInstance(a,!0,c,d)})})}for(var b=this.sprites.asArray().concat([this.stage]),c=this.stage.globalBlocks,d=[],e=!1,f;!e;)f=a(),f.length?d=d.concat(f):e=!0;0<d.length?(new BlockRemovalDialogMorph(d,this.stage)).popUp(this.world()):this.inform("Remove unused blocks","there are currently no unused\nglobal custom blocks in this project")};
IDE_Morph.prototype.exportSprite=function(a){var b=this.serializer.serialize(a.allParts());b='<sprites app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+b+"</sprites>";this.saveXMLAs(b,a.name)};
IDE_Morph.prototype.exportScriptsPicture=function(){var a=[],b=0,c=0,d=0;this.sprites.asArray().forEach(function(b){a.push(b.image);a.push(b.scripts.scriptsPicture());b.customBlocks.forEach(function(b){a.push(b.scriptsPicture())})});a.push(this.stage.image);a.push(this.stage.scripts.scriptsPicture());this.stage.customBlocks.forEach(function(b){a.push(b.scriptsPicture())});this.stage.globalBlocks.forEach(function(b){a.push(b.scriptsPicture())});a=a.filter(function(a){return!isNil(a)});a.forEach(function(a){b=
Math.max(b,a.width);c+=a.height;c+=20});c-=20;var e=newCanvas(new Point(b,c));var f=e.getContext("2d");a.forEach(function(a){f.drawImage(a,0,d);d+=20;d+=a.height});this.saveCanvasAs(e,this.projectName||localize("Untitled"))};
IDE_Morph.prototype.exportProjectSummary=function(a){function b(a,b,c){b||(b=m);return new XML_Element(a,c,b)}function c(a,b,c){b||(b="p");c||(c=m);return new XML_Element(b,a,c)}function d(a,c,d){c||(c=m);d=d?null:b("p",c);c=b("img",d||c);c.attributes.src=a.toDataURL();return c}function e(a){var e=a.names().sort(),f=!0,g;e.length&&(c(localize("Variables"),"h3"),e.forEach(function(c){f&&(g=b("ul"),f=!1);var e=b("li",g);c=new WatcherMorph(c,SpriteMorph.prototype.blockColor.variables,a,c);var h=c.cellMorph.contentsMorph;
h instanceof ListWatcherMorph&&h.expand();d(c.fullImageClassic(),e).attributes.class="script"}))}function f(a){a.length&&(c(localize("Blocks"),"h3"),SpriteMorph.prototype.categories.forEach(function(e){var f=!0,g;a.forEach(function(a){if(a.category===e){f&&(c(localize(e[0].toUpperCase().concat(e.slice(1))),"h4"),g=b("ul"),f=!1);var h=b("li",g);var k=d(a.templateInstance().scriptPic(),h);k.attributes.class="script";a.sortedElements().forEach(function(a){d(a instanceof BlockMorph?a.scriptPic():a.fullImageClassic(),
h).attributes.class="script"})}})}))}var g=this.stage;var h=this.projectName||localize("untitled");var k=new XML_Element("html");k.attributes.lang=SnapTranslator.language;var l=b("head",k);b("meta",l).attributes.charset="UTF-8";b("style",l,a?"img {vertical-align: top;filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-webkit-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));-ms-filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}":"img {vertical-align: top;}.toc {vertical-align: middle;padding: 2px 1em 2px 1em;}.sprite {border: 1px solid lightgray;}");
c(h,"title",l);var m=b("body",k);c(h,"h1");0===location.hash.indexOf("#present:")?(c(location.toString(),"a",m).attributes.href=location.toString(),d(g.thumbnail(g.dimensions)).attributes.class="sprite",c(this.serializer.app,"h4")):(c(this.serializer.app,"h4"),d(g.thumbnail(g.dimensions)).attributes.class="sprite");Process.prototype.reportTextSplit(this.projectNotes,"line").asArray().forEach(function(a){c(a)});c(localize("Contents"),"h4");var n=b("ul");this.sprites.asArray().concat([g]).forEach(function(a){var h=
b("li",n),k=a.scripts.sortedElements(),m=a.costumes.length();b("hr");d(a.thumbnail(new Point(40,40)),h,!0).attributes.class="toc";c(a.name,"a",h).attributes.href="#"+a.name;c(a.name,"h2").attributes.id=a.name;d(a.thumbnail(a.extent().divideBy(g.scale))).attributes.class="sprite";if(a instanceof SpriteMorph&&(a.exemplar&&(d(a.exemplar.thumbnail(new Point(40,40)),c(localize("Kind of")+" "+a.exemplar.name),!0).attributes.class="toc"),a.anchor&&(d(a.anchor.thumbnail(new Point(40,40)),c(localize("Part of")+
" "+a.anchor.name),!0).attributes.class="toc"),a.parts.length)){c(localize("Parts"),"h3");var l=b("ul");a.parts.forEach(function(a){var c=b("li",l,a.name);d(a.thumbnail(new Point(40,40)),c,!0).attributes.class="toc"})}if(1<m||a.getCostumeIdx()!==m)c(localize("Costumes"),"h3"),l=b("ol"),a.costumes.asArray().forEach(function(a){var c=b("li",l,a.name);d(a.thumbnail(new Point(40,40)),c,!0).attributes.class="toc"});a.sounds.length()&&(c(localize("Sounds"),"h3"),l=b("ol"),a.sounds.asArray().forEach(function(a){c(a.name,
"li",l)}));e(a.variables);k.length&&(c(localize("Scripts"),"h3"),k.forEach(function(a){d(a instanceof BlockMorph?a.scriptPic():a.fullImageClassic()).attributes.class="script"}));f(a.customBlocks)});a=g.globalVariables();if(Object.keys(a.vars).length||g.globalBlocks.length)b("hr"),c(localize("For all Sprites"),"a",b("li",n)).attributes.href="#global",c(localize("For all Sprites"),"h2").attributes.id="global",e(a),f(g.globalBlocks);this.saveFileAs("<!DOCTYPE html>"+k.toString(),"text/html;charset=utf-8",
h)};IDE_Morph.prototype.openProjectString=function(a){var b,c=this;this.nextSteps([function(){b=c.showMessage("Opening project...")},function(){nop()},function(){c.rawOpenProjectString(a)},function(){b.destroy()}])};
IDE_Morph.prototype.rawOpenProjectString=function(a){this.toggleAppMode(!1);this.spriteBar.tabBar.tabTo("scripts");StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=!1;StageMorph.prototype.enableInheritance=!0;StageMorph.prototype.enableSublistIDs=!1;Process.prototype.enableLiveCoding=!1;if(Process.prototype.isCatchingErrors)try{this.serializer.openProject(this.serializer.load(a,this),this)}catch(b){this.showMessage("Load failed: "+
b)}else this.serializer.openProject(this.serializer.load(a,this),this);this.stopFastTracking()};IDE_Morph.prototype.openCloudDataString=function(a){var b,c=this,d=Math.round(a.length/1024);this.nextSteps([function(){b=c.showMessage("Opening project\n"+d+" KB...")},function(){nop()},function(){c.rawOpenCloudDataString(a)},function(){b.destroy()}])};
IDE_Morph.prototype.rawOpenCloudDataString=function(a){StageMorph.prototype.hiddenPrimitives={};StageMorph.prototype.codeMappings={};StageMorph.prototype.codeHeaders={};StageMorph.prototype.enableCodeMapping=!1;StageMorph.prototype.enableInheritance=!0;StageMorph.prototype.enableSublistIDs=!1;Process.prototype.enableLiveCoding=!1;if(Process.prototype.isCatchingErrors)try{var b=this.serializer.parse(a);this.serializer.loadMediaModel(b.childNamed("media"));this.serializer.openProject(this.serializer.loadProjectModel(b.childNamed("project"),
this),this)}catch(c){this.showMessage("Load failed: "+c)}else b=this.serializer.parse(a),this.serializer.loadMediaModel(b.childNamed("media")),this.serializer.openProject(this.serializer.loadProjectModel(b.childNamed("project"),this),this);this.stopFastTracking()};IDE_Morph.prototype.openBlocksString=function(a,b,c){var d,e=this;this.nextSteps([function(){d=e.showMessage("Opening blocks...")},function(){nop()},function(){e.rawOpenBlocksString(a,b,c)},function(){d.destroy()}])};
IDE_Morph.prototype.rawOpenBlocksString=function(a,b,c){var d=this;if(Process.prototype.isCatchingErrors)try{var e=this.serializer.loadBlocks(a,d.stage)}catch(f){this.showMessage("Load failed: "+f)}else e=this.serializer.loadBlocks(a,d.stage);c?(e.forEach(function(a){a.receiver=d.stage;d.stage.globalBlocks.push(a);d.stage.replaceDoubleDefinitionsFor(a)}),this.flushPaletteCache(),this.refreshPalette(),this.showMessage("Imported Blocks Module"+(b?": "+b:"")+".",2)):(new BlockImportDialogMorph(e,this.stage,
b)).popUp()};IDE_Morph.prototype.openSpritesString=function(a){var b,c=this;this.nextSteps([function(){b=c.showMessage("Opening sprite...")},function(){nop()},function(){c.rawOpenSpritesString(a)},function(){b.destroy()}])};IDE_Morph.prototype.rawOpenSpritesString=function(a){if(Process.prototype.isCatchingErrors)try{this.serializer.loadSprites(a,this)}catch(b){this.showMessage("Load failed: "+b)}else this.serializer.loadSprites(a,this)};
IDE_Morph.prototype.openMediaString=function(a){if(Process.prototype.isCatchingErrors)try{this.serializer.loadMedia(a)}catch(b){this.showMessage("Load failed: "+b)}else this.serializer.loadMedia(a);this.showMessage("Imported Media Module.",2)};IDE_Morph.prototype.openScriptString=function(a){var b,c=this;this.nextSteps([function(){b=c.showMessage("Opening script...")},function(){nop()},function(){c.rawOpenScriptString(a)},function(){b.destroy()}])};
IDE_Morph.prototype.rawOpenScriptString=function(a){var b=this.currentSprite.scripts;if(Process.prototype.isCatchingErrors)try{var c=this.serializer.parse(a,this.currentSprite);var d=this.serializer.loadScript(c,this.currentSprite)}catch(e){this.showMessage("Load failed: "+e)}else c=this.serializer.loadScript(a,this.currentSprite),d=this.serializer.loadScript(c,this.currentSprite);d.setPosition(this.world().hand.position());b.add(d);b.adjustBounds();b.lastDroppedBlock=d;b.recordDrop({origin:this.palette,
position:this.palette.center()});this.showMessage("Imported Script.",2)};IDE_Morph.prototype.openProject=function(a){a&&(this.showMessage("opening project\n"+a),this.setProjectName(a),a=localStorage["-snap-project-"+a],this.openProjectString(a),this.setURL("#open:"+a))};IDE_Morph.prototype.setURL=function(a){this.projectsInURLs&&(location.hash=a)};
IDE_Morph.prototype.saveFileAs=function(a,b,c){var d=!1,e=this.world();var f=b.split("/")[1].split(";")[0];f="."+("plain"===f?"txt":f);try{d=!!new Blob}catch(g){}if(d){if(!(a instanceof Blob)){a=e=a;d=e.split(",");if(0===e.indexOf("data:")&&-1<d[0].indexOf("base64"))for(e=atob(d[1]),a=new Uint8Array(e.length),d=e.length;d--;)a[d]=e.charCodeAt(d);a=new Blob([a],{type:b})}saveAs(a,c+f,!1)}else b=new DialogBoxMorph,b.inform(localize("Could not export")+" "+c,"unable to export text",e),b.fixLayout(),
b.drawNew()};IDE_Morph.prototype.saveCanvasAs=function(a,b){this.saveFileAs(a.toDataURL(),"image/png",b)};IDE_Morph.prototype.saveXMLAs=function(a,b){this.saveFileAs(a,"text/xml;chartset=utf-8",b)};
IDE_Morph.prototype.switchToUserMode=function(){var a=this.world();a.isDevMode=!1;Process.prototype.isCatchingErrors=!0;this.controlBar.updateLabel();this.isAutoFill=!0;this.isDraggable=!1;this.reactToWorldResize(a.bounds.copy());this.siblings().forEach(function(b){b instanceof DialogBoxMorph?a.add(b):b.destroy()});this.flushBlocksCache();this.refreshPalette();a.reactToDropOf=function(b){b instanceof DialogBoxMorph||(a.hand.grabOrigin?b.slideBackTo(a.hand.grabOrigin):a.hand.grab(b))};this.showMessage("entering user mode",
1)};IDE_Morph.prototype.switchToDevMode=function(){var a=this.world();a.isDevMode=!0;Process.prototype.isCatchingErrors=!1;this.controlBar.updateLabel();this.isAutoFill=!1;this.isDraggable=!0;this.setExtent(a.extent().subtract(100));this.setPosition(a.position().add(20));this.flushBlocksCache();this.refreshPalette();delete a.reactToDropOf;this.showMessage("entering development mode.\n\nerror catching is turned off,\nuse the browser's web console\nto see error messages.")};
IDE_Morph.prototype.flushBlocksCache=function(a){a?(this.stage.blocksCache[a]=null,this.stage.children.forEach(function(b){b instanceof SpriteMorph&&(b.blocksCache[a]=null)})):(this.stage.blocksCache={},this.stage.children.forEach(function(a){a instanceof SpriteMorph&&(a.blocksCache={})}));this.flushPaletteCache(a)};
IDE_Morph.prototype.flushPaletteCache=function(a){a?(this.stage.paletteCache[a]=null,this.stage.children.forEach(function(b){b instanceof SpriteMorph&&(b.paletteCache[a]=null)})):(this.stage.paletteCache={},this.stage.children.forEach(function(a){a instanceof SpriteMorph&&(a.paletteCache={})}))};
IDE_Morph.prototype.toggleZebraColoring=function(){var a=[];BlockMorph.prototype.zebraContrast=BlockMorph.prototype.zebraContrast?0:40;this.stage.children.concat(this.stage).forEach(function(b){isSnapObject(b)&&(a=a.concat(b.scripts.children.filter(function(a){return a instanceof BlockMorph})))});a.forEach(function(a){a.fixBlockColor(null,!0)})};
IDE_Morph.prototype.toggleDynamicInputLabels=function(){SyntaxElementMorph.prototype.dynamicInputLabels=!SyntaxElementMorph.prototype.dynamicInputLabels;if(Process.prototype.isCatchingErrors)try{var a=this.serializer.serialize(this.stage)}catch(b){this.showMessage("Serialization failed: "+b)}else a=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks();this.spriteBar.tabBar.tabTo("scripts");this.createCategories();this.createCorralBar();this.openProjectString(a)};
IDE_Morph.prototype.toggleBlurredShadows=function(){window.useBlurredShadows=!useBlurredShadows};IDE_Morph.prototype.toggleLongFormInputDialog=function(){InputSlotDialogMorph.prototype.isLaunchingExpanded=!InputSlotDialogMorph.prototype.isLaunchingExpanded;InputSlotDialogMorph.prototype.isLaunchingExpanded?this.saveSetting("longform",!0):this.removeSetting("longform")};
IDE_Morph.prototype.togglePlainPrototypeLabels=function(){BlockLabelPlaceHolderMorph.prototype.plainLabel=!BlockLabelPlaceHolderMorph.prototype.plainLabel;BlockLabelPlaceHolderMorph.prototype.plainLabel?this.saveSetting("plainprototype",!0):this.removeSetting("plainprototype")};IDE_Morph.prototype.togglePreferEmptySlotDrops=function(){ScriptsMorph.prototype.isPreferringEmptySlots=!ScriptsMorph.prototype.isPreferringEmptySlots};
IDE_Morph.prototype.toggleVirtualKeyboard=function(){MorphicPreferences.useVirtualKeyboard=!MorphicPreferences.useVirtualKeyboard};IDE_Morph.prototype.toggleInputSliders=function(){MorphicPreferences.useSliderForInput=!MorphicPreferences.useSliderForInput};IDE_Morph.prototype.toggleSliderExecute=function(){ArgMorph.prototype.executeOnSliderEdit=!ArgMorph.prototype.executeOnSliderEdit};
IDE_Morph.prototype.toggleAppMode=function(a){var b=this.world(),c=[this.logo,this.controlBar.cloudButton,this.controlBar.projectButton,this.controlBar.settingsButton,this.controlBar.steppingButton,this.controlBar.stageSizeButton,this.paletteHandle,this.stageHandle,this.corral,this.corralBar,this.spriteEditor,this.spriteBar,this.palette,this.categories];this.isAppMode=isNil(a)?!this.isAppMode:a;Morph.prototype.trackChanges=!1;this.isAppMode?((this.wasSingleStepping=Process.prototype.enableSingleStepping)&&
this.toggleSingleStepping(),this.setColor(this.appModeColor),this.controlBar.setColor(this.color),this.controlBar.appModeButton.refresh(),c.forEach(function(a){a.hide()}),b.children.forEach(function(a){a instanceof DialogBoxMorph&&a.hide()}),b.keyboardReceiver instanceof ScriptFocusMorph&&b.keyboardReceiver.stopEditing()):(this.wasSingleStepping&&!Process.prototype.enableSingleStepping&&this.toggleSingleStepping(),this.setColor(this.backgroundColor),this.controlBar.setColor(this.frameColor),c.forEach(function(a){a.show()}),
this.stage.setScale(1),b.children.forEach(function(a){a instanceof DialogBoxMorph&&a.show()}),b.allChildren().filter(function(a){return a instanceof ScrollFrameMorph}).forEach(function(a){a.adjustScrollBars()}),this.currentSprite===this.stage&&this.spriteBar.children.forEach(function(a){a instanceof PushButtonMorph&&a.hide()}),this.currentSprite.scripts.updateToolbar());this.setExtent(this.world().extent())};
IDE_Morph.prototype.toggleStageSize=function(a,b){function c(){e.isSmallStage=isNil(a)?!e.isSmallStage:a}function d(a){e.isSmallStage=!0;g.animations.push(new Animation(function(a){e.stageRatio=a;e.setExtent(g.extent())},function(){return e.stageRatio},a-e.stageRatio,f,null,function(){e.isSmallStage=1!==a;e.controlBar.stageSizeButton.refresh()}))}var e=this;b=b||.5;var f=this.isAnimating?100:0,g=this.world(),h=18===g.currentKey;16===g.currentKey?(b=3*SpriteIconMorph.prototype.thumbSize.x/this.stage.dimensions.x,
this.isSmallStage&&b!==this.stageRatio||c()):h?(b=this.width()/2/this.stage.dimensions.x,this.isSmallStage&&b!==this.stageRatio||c()):c();this.isSmallStage?d(b):d(1)};IDE_Morph.prototype.setPaletteWidth=function(a){var b=this.isAnimating?100:0,c=this.world(),d=this;c.animations.push(new Animation(function(a){d.paletteWidth=a;d.setExtent(c.extent())},function(){return d.paletteWidth},a-d.paletteWidth,b))};
IDE_Morph.prototype.createNewProject=function(){var a=this;this.confirm("Replace the current project with a new one?","New Project",function(){a.newProject()})};IDE_Morph.prototype.openProjectsBrowser=function(){(new ProjectDialogMorph(this,"open")).popUp()};IDE_Morph.prototype.saveProjectsBrowser=function(){"examples"===this.source&&(this.source="local");(new ProjectDialogMorph(this,"save")).popUp()};
IDE_Morph.prototype.languageMenu=function(){var a=new MenuMorph(this),b=this.world(),c=this.controlBar.settingsButton.bottomLeft(),d=this;SnapTranslator.languages().forEach(function(b){a.addItem((SnapTranslator.language===b?"\u2713 ":"    ")+SnapTranslator.languageName(b),function(){d.loadNewProject=!1;d.setLanguage(b)})});a.popup(b,c)};
IDE_Morph.prototype.setLanguage=function(a,b){var c=document.getElementById("language"),d=this.resourceURL("lang-"+a+".js"),e=this;SnapTranslator.unload();c&&document.head.removeChild(c);if("en"===a)return this.reflectLanguage("en",b);c=document.createElement("script");c.id="language";c.onload=function(){e.reflectLanguage(a,b)};document.head.appendChild(c);c.src=d};
IDE_Morph.prototype.reflectLanguage=function(a,b){var c=location.hash;SnapTranslator.language=a;if(!this.loadNewProject)if(Process.prototype.isCatchingErrors)try{var d=this.serializer.serialize(this.stage)}catch(e){this.showMessage("Serialization failed: "+e)}else d=this.serializer.serialize(this.stage);SpriteMorph.prototype.initBlocks();this.spriteBar.tabBar.tabTo("scripts");this.createCategories();this.createCorralBar();this.fixLayout();this.loadNewProject?(this.newProject(),location.hash=c):this.openProjectString(d);
this.saveSetting("language",a);b&&b.call(this)};
IDE_Morph.prototype.userSetBlocksScale=function(){var a=this;var b=new CommandBlockMorph;b.color=SpriteMorph.prototype.blockColor.motion;b.setSpec(localize("build"));var c=new CommandBlockMorph;c.color=SpriteMorph.prototype.blockColor.sound;c.setSpec(localize("your own"));b.nextBlock(c);c=new CommandBlockMorph;c.color=SpriteMorph.prototype.blockColor.operators;c.setSpec(localize("blocks"));b.bottomBlock().nextBlock(c);var d=new FrameMorph;d.acceptsDrops=!1;d.color=IDE_Morph.prototype.groupColor;d.cachedTexture=
this.scriptsPaneTexture;d.setExtent(new Point(250,180));b.setPosition(d.position().add(10));d.add(b);c=new Morph;c.alpha=0;c.setExtent(d.extent());c.setPosition(d.position());d.add(c);(new DialogBoxMorph(null,function(b){a.setBlocksScale(Math.min(b,12))})).withKey("zoomBlocks").prompt("Zoom blocks",SyntaxElementMorph.prototype.scale.toString(),this.world(),d,{"normal (1x)":1,"demo (1.2x)":1.2,"presentation (1.4x)":1.4,"big (2x)":2,"huge (4x)":4,"giant (8x)":8,"monstrous (10x)":10},!1,!0,1,12,function(a){b.blockSequence().forEach(function(b){b.setScale(a);
b.drawNew();b.setSpec(b.blockSpec)});b.changed()})};
IDE_Morph.prototype.setBlocksScale=function(a){if(Process.prototype.isCatchingErrors)try{var b=this.serializer.serialize(this.stage)}catch(c){this.showMessage("Serialization failed: "+c)}else b=this.serializer.serialize(this.stage);SyntaxElementMorph.prototype.setScale(a);CommentMorph.prototype.refreshScale();SpriteMorph.prototype.initBlocks();this.spriteBar.tabBar.tabTo("scripts");this.createCategories();this.createCorralBar();this.fixLayout();this.openProjectString(b);this.saveSetting("zoom",a)};
IDE_Morph.prototype.userSetStageSize=function(){(new DialogBoxMorph(this,this.setStageExtent,this)).promptVector("Stage size",StageMorph.prototype.dimensions,new Point(480,360),"Stage width","Stage height",this.world(),null,null)};
IDE_Morph.prototype.setStageExtent=function(a){function b(){c.step=function(){var a=e.subtract(StageMorph.prototype.dimensions).divideBy(2);a.abs().lt(new Point(5,5))?(StageMorph.prototype.dimensions=e,delete c.step):StageMorph.prototype.dimensions=StageMorph.prototype.dimensions.add(a);c.stage.setExtent(StageMorph.prototype.dimensions);c.stage.clearPenTrails();c.fixLayout();this.setExtent(d.extent())}}var c=this,d=this.world(),e=a.max(new Point(240,180));this.stageRatio=1;this.isSmallStage=!1;this.controlBar.stageSizeButton.refresh();
this.setExtent(d.extent());this.isAnimating?b():(StageMorph.prototype.dimensions=e,this.stage.setExtent(StageMorph.prototype.dimensions),this.stage.clearPenTrails(),this.fixLayout(),this.setExtent(d.extent()))};IDE_Morph.prototype.userSetDragThreshold=function(){(new DialogBoxMorph(this,function(a){MorphicPreferences.grabThreshold=Math.min(Math.max(+a,0),200)},this)).prompt("Dragging threshold",MorphicPreferences.grabThreshold.toString(),this.world(),null,null,null,!0)};
IDE_Morph.prototype.initializeCloud=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(b){var c=hex_sha512(b.password),e;SnapCloud.login(b.username,c,function(){b.choice&&(e=SnapCloud.encodeDict({username:b.username,password:c}),localStorage["-snap-user"]=e);a.source="cloud";a.showMessage("now connected.",2)},a.cloudError())})).withKey("cloudlogin").promptCredentials("Sign in","login",null,null,null,null,"stay signed in on this computer\nuntil logging out",b,a.cloudIcon(),a.cloudMsg)};
IDE_Morph.prototype.createCloudAccount=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){SnapCloud.signup(c.username,c.email,function(c,e){(new DialogBoxMorph).inform(e,c+".\n\nAn e-mail with your password\nhas been sent to the address provided",b,a.cloudIcon(null,new Color(0,180,0)))},a.cloudError())})).withKey("cloudsignup").promptCredentials("Sign up","signup","http://snap.berkeley.edu/tos.html","Terms of Service...","http://snap.berkeley.edu/privacy.html","Privacy...",
"I have read and agree\nto the Terms of Service",b,a.cloudIcon(),a.cloudMsg)};
IDE_Morph.prototype.resetCloudPassword=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(c){SnapCloud.resetPassword(c.username,function(c,e){(new DialogBoxMorph).inform(e,c+".\n\nAn e-mail with a link to\nreset your password\nhas been sent to the address provided",b,a.cloudIcon(null,new Color(0,180,0)))},a.cloudError())})).withKey("cloudresetpassword").promptCredentials("Reset password","resetPassword",null,null,null,null,null,b,a.cloudIcon(),a.cloudMsg)};
IDE_Morph.prototype.changeCloudPassword=function(){var a=this,b=this.world();(new DialogBoxMorph(null,function(b){SnapCloud.changePassword(b.oldpassword,b.password,function(){a.logout();a.showMessage("password has been changed.",2)},a.cloudError())})).withKey("cloudpassword").promptCredentials("Change Password","changePassword",null,null,null,null,null,b,a.cloudIcon(),a.cloudMsg)};
IDE_Morph.prototype.logout=function(){var a=this;delete localStorage["-snap-user"];SnapCloud.logout(function(){SnapCloud.clear();a.showMessage("disconnected.",2)},function(){SnapCloud.clear();a.showMessage("disconnected.",2)})};IDE_Morph.prototype.saveProjectToCloud=function(a){var b=this;a&&(this.showMessage("Saving project\nto the cloud..."),this.setProjectName(a),SnapCloud.saveProject(this,function(){b.showMessage("saved.",2)},this.cloudError()))};
IDE_Morph.prototype.exportProjectMedia=function(a){this.serializer.isCollectingMedia=!0;if(a){this.setProjectName(a);try{var b=this.showMessage("Exporting");var c=this.serializer.mediaXML(a);this.saveXMLAs(c,this.projectName+" media");b.destroy();this.showMessage("Exported!",1)}catch(d){if(Process.prototype.isCatchingErrors)this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+d);else throw d;}}this.serializer.isCollectingMedia=!1;this.serializer.flushMedia()};
IDE_Morph.prototype.exportProjectNoMedia=function(a){this.serializer.isCollectingMedia=!0;if(a)if(this.setProjectName(a),Process.prototype.isCatchingErrors)try{var b=this.showMessage("Exporting");var c=this.serializer.serialize(this.stage);this.saveXMLAs(c,this.projectName);b.destroy();this.showMessage("Exported!",1)}catch(d){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+d)}else b=this.showMessage("Exporting"),c=this.serializer.serialize(this.stage),this.saveXMLAs(c,this.projectName),
b.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1;this.serializer.flushMedia()};
IDE_Morph.prototype.exportProjectAsCloudData=function(a){this.serializer.isCollectingMedia=!0;if(a)if(this.setProjectName(a),Process.prototype.isCatchingErrors)try{var b=this.showMessage("Exporting");var c=this.serializer.serialize(this.stage);this.serializer.mediaXML(a);this.saveXMLAs(c,this.projectName);b.destroy();this.showMessage("Exported!",1)}catch(d){this.serializer.isCollectingMedia=!1,this.showMessage("Export failed: "+d)}else b=this.showMessage("Exporting"),c=this.serializer.serialize(this.stage),
this.serializer.mediaXML(a),this.saveXMLAs(c,this.projectName),b.destroy(),this.showMessage("Exported!",1);this.serializer.isCollectingMedia=!1;this.serializer.flushMedia()};IDE_Morph.prototype.cloudAcknowledge=function(){var a=this;return function(b,c){nop(b);(new DialogBoxMorph).inform("Cloud Connection","Successfully connected to:\nhttp://"+c,a.world(),a.cloudIcon(null,new Color(0,180,0)))}};
IDE_Morph.prototype.cloudResponse=function(){var a=this;return function(b,c){50<b.length&&(b=b.substring(0,50)+"...");(new DialogBoxMorph).inform("Snap!Cloud","http://"+c+":\n\nresponds:\n"+b,a.world(),a.cloudIcon(null,new Color(0,180,0)))}};
IDE_Morph.prototype.cloudError=function(){var a=this;return function(b,c){a.shield&&(a.shield.destroy(),a.shield=null);50<b.length&&(b=b.substring(0,50)+"...");(new DialogBoxMorph).inform("Snap!Cloud",(c?c+"\n":"")+b,a.world(),a.cloudIcon(null,new Color(180,0,0)))}};
IDE_Morph.prototype.cloudIcon=function(a,b){b=b||DialogBoxMorph.prototype.titleBarColor;var c=MorphicPreferences.isFlat;a=new SymbolMorph(c?"cloud":"cloudGradient",a||50,b,c?null:new Point(-1,-1),b.darker(50));c||a.addShadow(new Point(1,1),1,b.lighter(95));return a};IDE_Morph.prototype.setCloudURL=function(){(new DialogBoxMorph(null,function(a){SnapCloud.url=a})).withKey("cloudURL").prompt("Cloud URL",SnapCloud.url,this.world(),null,{"Snap!Cloud":"https://snap.apps.miosoft.com/SnapCloud"})};
IDE_Morph.prototype.getURL=function(a,b){var c=new XMLHttpRequest,d=b instanceof Function,e=this;try{if(c.open("GET",a,d),d&&(c.onreadystatechange=function(){if(4===c.readyState)if(c.responseText)b.call(e,c.responseText);else throw Error("unable to retrieve "+a);}),c.send(),!d){if(200===c.status)return c.responseText;throw Error("unable to retrieve "+a);}}catch(f){if(e.showMessage(f.toString()),d)b.call(this);else return c.responseText}};
IDE_Morph.prototype.showMessage=function(a,b){var c=new MenuMorph(null,a),d;c.popUpCenteredInWorld(this.world());b&&(d=setInterval(function(){c.destroy();clearInterval(d)},1E3*b));return c};IDE_Morph.prototype.inform=function(a,b){(new DialogBoxMorph).inform(a,localize(b),this.world())};IDE_Morph.prototype.confirm=function(a,b,c){(new DialogBoxMorph(null,c)).askYesNo(b,localize(a),this.world())};
IDE_Morph.prototype.prompt=function(a,b,c,d){(new DialogBoxMorph(null,b)).withKey(d).prompt(a,"",this.world(),null,c)};ProjectDialogMorph.prototype=new DialogBoxMorph;ProjectDialogMorph.prototype.constructor=ProjectDialogMorph;ProjectDialogMorph.uber=DialogBoxMorph.prototype;function ProjectDialogMorph(a,b){this.init(a,b)}
ProjectDialogMorph.prototype.init=function(a,b){var c=this;this.ide=a;this.task=b||"open";this.source=a.source||"local";this.projectList=[];this.unshareButton=this.shareButton=this.deleteButton=this.notesField=this.notesText=this.preview=this.listField=this.magnifyingGlass=this.filterField=this.nameField=this.srcBar=this.handle=null;ProjectDialogMorph.uber.init.call(this,this,null,null);this.labelString="save"===this.task?"Save Project":"Open Project";this.createLabel();this.key="project"+b;this.buildContents();
this.onNextStep=function(){c.setSource(c.source)}};
ProjectDialogMorph.prototype.buildContents=function(){this.addBody(new Morph);this.body.color=this.color;this.srcBar=new AlignmentMorph("column",this.padding/2);if(this.ide.cloudMsg){var a=new TextMorph(this.ide.cloudMsg,10,null,!1,null,null,null,null,new Point(1,1),new Color(255,255,255));a.refresh=nop;this.srcBar.add(a)}this.addSourceButton("cloud",localize("Cloud"),"cloud");this.addSourceButton("local",localize("Browser"),"storage");"open"===this.task&&(this.buildFilterField(),this.addSourceButton("examples",
localize("Examples"),"poster"));this.srcBar.fixLayout();this.body.add(this.srcBar);"save"===this.task&&(this.nameField=new InputFieldMorph(this.ide.projectName),this.body.add(this.nameField));this.listField=new ListMorph([]);this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;
this.listField.drawNew=InputFieldMorph.prototype.drawNew;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.body.add(this.listField);this.preview=new Morph;this.preview.fixLayout=nop;this.preview.edge=InputFieldMorph.prototype.edge;this.preview.fontSize=InputFieldMorph.prototype.fontSize;this.preview.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.preview.contrast=InputFieldMorph.prototype.contrast;this.preview.drawNew=function(){InputFieldMorph.prototype.drawNew.call(this);
this.texture&&this.drawTexture(this.texture)};this.preview.drawCachedTexture=function(){this.image.getContext("2d").drawImage(this.cachedTexture,this.edge,this.edge);this.changed()};this.preview.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.preview.setExtent(this.ide.serializer.thumbnailSize.add(2*this.preview.edge));this.body.add(this.preview);this.preview.drawNew();if("save"===this.task){var b=this.ide.stage.thumbnail(SnapSerializer.prototype.thumbnailSize);this.preview.texture=null;
this.preview.cachedTexture=b;this.preview.drawCachedTexture()}this.notesField=new ScrollFrameMorph;this.notesField.fixLayout=nop;this.notesField.edge=InputFieldMorph.prototype.edge;this.notesField.fontSize=InputFieldMorph.prototype.fontSize;this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.notesField.contrast=InputFieldMorph.prototype.contrast;this.notesField.drawNew=InputFieldMorph.prototype.drawNew;this.notesField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;
this.notesField.acceptsDrops=!1;this.notesField.contents.acceptsDrops=!1;"open"===this.task?this.notesText=new TextMorph(""):(this.notesText=new TextMorph(this.ide.projectNotes),this.notesText.isEditable=!0,this.notesText.enableSelecting());this.notesField.isTextLineWrapping=!0;this.notesField.padding=3;this.notesField.setContents(this.notesText);this.notesField.setWidth(this.preview.width());this.body.add(this.notesField);"open"===this.task?(this.addButton("openProject","Open"),this.action="openProject"):
(this.addButton("saveProject","Save"),this.action="saveProject");this.shareButton=this.addButton("shareProject","Share");this.unshareButton=this.addButton("unshareProject","Unshare");this.shareButton.hide();this.unshareButton.hide();this.deleteButton=this.addButton("deleteProject","Delete");this.addButton("cancel","Cancel");a?this.setExtent((new Point(455,335)).add(a.extent())):this.setExtent(new Point(455,335));this.fixLayout()};
ProjectDialogMorph.prototype.popUp=function(a){if(a=a||this.ide.world())ProjectDialogMorph.uber.popUp.call(this,a),this.handle=new HandleMorph(this,350,300,this.corner,this.corner)};
ProjectDialogMorph.prototype.addSourceButton=function(a,b,c){var d=this,e=new StringMorph(b,10,null,!0,null,null,new Point(1,1),new Color(255,255,255));b=new StringMorph(b,10,null,!0,null,null,new Point(-1,-1),this.titleBarColor.darker(50),new Color(255,255,255));var f=new Morph,g=new Morph;e.add(new SymbolMorph(c,24,this.titleBarColor.darker(20),new Point(1,1),this.titleBarColor.darker(50)));e.children[0].setCenter(e.center());e.children[0].setBottom(e.top()-this.padding/2);f.image=e.fullImage();
f.bounds=e.fullBounds();b.add(new SymbolMorph(c,24,new Color(255,255,255),new Point(-1,-1),this.titleBarColor.darker(50)));b.children[0].setCenter(b.center());b.children[0].setBottom(b.top()-this.padding/2);g.image=b.fullImage();g.bounds=b.fullBounds();c=new ToggleButtonMorph(null,d,function(){d.setSource(a)},[f,g],function(){return d.source===a});c.corner=this.buttonCorner;c.edge=this.buttonEdge;c.outline=this.buttonOutline;c.outlineColor=this.buttonOutlineColor;c.outlineGradient=this.buttonOutlineGradient;
c.labelMinExtent=new Point(60,0);c.padding=this.buttonPadding;c.contrast=this.buttonContrast;c.pressColor=this.titleBarColor.darker(20);c.drawNew();c.fixLayout();c.refresh();this.srcBar.add(c)};ProjectDialogMorph.prototype.fixListFieldItemColors=function(){var a=this;this.listField.contents.children[0].alpha=0;this.listField.contents.children[0].children.forEach(function(b){b.pressColor=a.titleBarColor.darker(20);b.color=new Color(0,0,0,0);b.noticesTransparentClick=!0})};
ProjectDialogMorph.prototype.buildFilterField=function(){var a=this;this.filterField=new InputFieldMorph("");this.magnifyingGlass=new SymbolMorph("magnifyingGlass",this.filterField.height(),this.titleBarColor.darker(50));this.body.add(this.magnifyingGlass);this.body.add(this.filterField);this.filterField.reactToKeystroke=function(b){var c=this.getValue();a.listField.elements=a.projectList.filter(function(a){if(a.ProjectName){var b=a.ProjectName;a=a.Notes}else b=a.name,a=a.notes||"";return-1<b.toLowerCase().indexOf(c.toLowerCase())||
-1<a.toLowerCase().indexOf(c.toLowerCase())});0===a.listField.elements.length&&a.listField.elements.push("(no matches)");a.clearDetails();a.listField.buildListContents();a.fixListFieldItemColors();a.listField.adjustScrollBars();a.listField.scrollY(a.listField.top());a.fixLayout()}};
ProjectDialogMorph.prototype.setSource=function(a){var b=this;this.source=a;this.srcBar.children.forEach(function(a){a.refresh()});switch(this.source){case "cloud":var c=b.ide.showMessage("Updating\nproject list...");this.projectList=[];SnapCloud.getProjectList(function(a){"cloud"===b.source&&b.installCloudProjectList(a);c.destroy()},function(a,e){c.destroy();b.ide.cloudError().call(null,a,e)});return;case "examples":this.projectList=this.getExamplesProjectList();break;case "local":this.projectList=
this.getLocalProjectList()}this.listField.destroy();this.listField=new ListMorph(this.projectList,0<this.projectList.length?function(a){return a.name||a}:null,null,function(){b.ok()});this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.drawNew=
InputFieldMorph.prototype.drawNew;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.listField.action="local"===this.source?function(a){void 0!==a&&(b.nameField&&b.nameField.setContents(a.name||""),"open"===b.task&&(a=localStorage["-snap-project-"+a.name])&&(a=b.ide.serializer.parse(a),b.notesText.text=a.childNamed("notes").contents||"",b.notesText.drawNew(),b.notesField.contents.adjustBounds(),b.preview.texture=a.childNamed("thumbnail").contents||null,b.preview.cachedTexture=
null,b.preview.drawNew()),b.edit())}:function(a){void 0!==a&&(b.nameField&&b.nameField.setContents(a.name||""),a=b.ide.getURL(b.ide.resourceURL("Examples",a.fileName)),a=b.ide.serializer.parse(a),b.notesText.text=a.childNamed("notes").contents||"",b.notesText.drawNew(),b.notesField.contents.adjustBounds(),b.preview.texture=a.childNamed("thumbnail").contents||null,b.preview.cachedTexture=null,b.preview.drawNew(),b.edit())};this.body.add(this.listField);this.shareButton.hide();this.unshareButton.hide();
"local"===this.source?this.deleteButton.show():this.deleteButton.hide();this.buttons.fixLayout();this.fixLayout();"open"===this.task&&this.clearDetails()};ProjectDialogMorph.prototype.getLocalProjectList=function(){var a,b=[];for(a in localStorage)if(Object.prototype.hasOwnProperty.call(localStorage,a)&&"-snap-project-"===a.substr(0,14)){var c=a.substr(14);c={name:c,thumb:null,notes:null};b.push(c)}b.sort(function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:1});return b};
ProjectDialogMorph.prototype.getExamplesProjectList=function(){return this.ide.getMediaList("Examples")};
ProjectDialogMorph.prototype.installCloudProjectList=function(a){var b=this;this.projectList=a||[];this.projectList.sort(function(a,b){return a.ProjectName.toLowerCase()<b.ProjectName.toLowerCase()?-1:1});this.listField.destroy();this.listField=new ListMorph(this.projectList,0<this.projectList.length?function(a){return a.ProjectName||a}:null,[["bold",function(a){return"true"===a.Public}]],function(){b.ok()});this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;
this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;this.listField.drawNew=InputFieldMorph.prototype.drawNew;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.listField.action=function(a){void 0!==a&&(b.nameField&&b.nameField.setContents(a.ProjectName||""),"open"===b.task&&(b.notesText.text=a.Notes||"",b.notesText.drawNew(),b.notesField.contents.adjustBounds(),
b.preview.texture=a.Thumbnail||null,b.preview.cachedTexture=null,b.preview.drawNew(),(new SpeechBubbleMorph(new TextMorph(localize("last changed")+"\n"+a.Updated,null,null,null,null,"center"))).popUp(b.world(),b.preview.rightCenter().add(new Point(2,0)))),"true"===a.Public?(b.shareButton.hide(),b.unshareButton.show()):(b.unshareButton.hide(),b.shareButton.show()),b.buttons.fixLayout(),b.fixLayout(),b.edit())};this.body.add(this.listField);this.shareButton.show();this.unshareButton.hide();this.deleteButton.show();
this.buttons.fixLayout();this.fixLayout();"open"===this.task&&this.clearDetails()};ProjectDialogMorph.prototype.clearDetails=function(){this.notesText.text="";this.notesText.drawNew();this.notesField.contents.adjustBounds();this.preview.texture=null;this.preview.cachedTexture=null;this.preview.drawNew()};
ProjectDialogMorph.prototype.openProject=function(){var a=this.listField.selected;a&&(this.ide.source=this.source,"cloud"===this.source?this.openCloudProject(a):("examples"===this.source?(a=this.ide.getURL(this.ide.resourceURL("Examples",a.fileName)),this.ide.openProjectString(a)):this.ide.openProject(a.name),this.destroy()))};ProjectDialogMorph.prototype.openCloudProject=function(a){var b=this;b.ide.nextSteps([function(){b.ide.showMessage("Fetching project\nfrom the cloud...")},function(){b.rawOpenCloudProject(a)}])};
ProjectDialogMorph.prototype.rawOpenCloudProject=function(a){var b=this;SnapCloud.reconnect(function(){SnapCloud.callService("getRawProject",function(c){SnapCloud.disconnect();b.ide.source="cloud";b.ide.droppedText(c);"true"===a.Public&&(location.hash="#present:Username="+encodeURIComponent(SnapCloud.username)+"&ProjectName="+encodeURIComponent(a.ProjectName))},b.ide.cloudError(),[a.ProjectName])},b.ide.cloudError());this.destroy()};
ProjectDialogMorph.prototype.saveProject=function(){var a=this.nameField.contents().text.text,b=this;this.ide.projectNotes=this.notesText.text||this.ide.projectNotes;a&&("cloud"===this.source?detect(this.projectList,function(b){return b.ProjectName===a})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+a+'"?',"Replace Project",function(){b.ide.setProjectName(a);b.saveCloudProject()}):(this.ide.setProjectName(a),b.saveCloudProject()):detect(this.projectList,function(b){return b.name===
a})?this.ide.confirm(localize("Are you sure you want to replace")+'\n"'+a+'"?',"Replace Project",function(){b.ide.setProjectName(a);b.ide.source="local";b.ide.saveProject(a);b.destroy()}):(this.ide.setProjectName(a),b.ide.source="local",this.ide.saveProject(a),this.destroy()))};
ProjectDialogMorph.prototype.saveCloudProject=function(){var a=this;this.ide.showMessage("Saving project\nto the cloud...");SnapCloud.saveProject(this.ide,function(){a.ide.source="cloud";a.ide.showMessage("saved.",2)},this.ide.cloudError());this.destroy()};
ProjectDialogMorph.prototype.deleteProject=function(){var a=this,b,c;if("cloud"===this.source)(b=this.listField.selected)&&this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+b.ProjectName+'"?',"Delete Project",function(){SnapCloud.reconnect(function(){SnapCloud.callService("deleteProject",function(){SnapCloud.disconnect();a.ide.hasChangedMedia=!0;c=a.projectList.indexOf(b);a.projectList.splice(c,1);a.installCloudProjectList(a.projectList)},a.ide.cloudError(),[b.ProjectName])},a.ide.cloudError())});
else if(this.listField.selected){var d=this.listField.selected.name;this.ide.confirm(localize("Are you sure you want to delete")+'\n"'+d+'"?',"Delete Project",function(){delete localStorage["-snap-project-"+d];a.setSource(a.source)})}};
ProjectDialogMorph.prototype.shareProject=function(){var a=this,b=this.ide,c=this.listField.selected,d=this.listField.active;c&&this.ide.confirm(localize("Are you sure you want to publish")+'\n"'+c.ProjectName+'"?',"Share Project",function(){a.ide.showMessage("sharing\nproject...");SnapCloud.reconnect(function(){SnapCloud.callService("publishProject",function(){SnapCloud.disconnect();c.Public="true";a.unshareButton.show();a.shareButton.hide();d.label.isBold=!0;d.label.drawNew();d.label.changed();
a.buttons.fixLayout();a.drawNew();a.ide.showMessage("shared.",2)},a.ide.cloudError(),[c.ProjectName]);if(c.ProjectName===b.projectName){var e="Username="+encodeURIComponent(SnapCloud.username.toLowerCase())+"&ProjectName="+encodeURIComponent(c.ProjectName);location.hash="present:"+e}},a.ide.cloudError())})};
ProjectDialogMorph.prototype.unshareProject=function(){var a=this,b=this.ide,c=this.listField.selected,d=this.listField.active;c&&this.ide.confirm(localize("Are you sure you want to unpublish")+'\n"'+c.ProjectName+'"?',"Unshare Project",function(){a.ide.showMessage("unsharing\nproject...");SnapCloud.reconnect(function(){SnapCloud.callService("unpublishProject",function(){SnapCloud.disconnect();c.Public="false";a.shareButton.show();a.unshareButton.hide();d.label.isBold=!1;d.label.drawNew();d.label.changed();
a.buttons.fixLayout();a.drawNew();a.ide.showMessage("unshared.",2)},a.ide.cloudError(),[c.ProjectName]);c.ProjectName===b.projectName&&(location.hash="")},a.ide.cloudError())})};ProjectDialogMorph.prototype.edit=function(){this.nameField?this.nameField.edit():this.filterField&&this.filterField.edit()};
ProjectDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding,b=this.padding/2,c=this.nameField||this.filterField,d=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout();this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())),
this.srcBar.setPosition(this.body.position()),c.setWidth(this.body.width()-this.srcBar.width()-6*this.padding),c.setLeft(this.srcBar.right()+3*this.padding),c.setTop(this.srcBar.top()),c.drawNew(),this.listField.setLeft(this.srcBar.right()+this.padding),this.listField.setWidth(this.body.width()-this.srcBar.width()-this.preview.width()-this.padding-b),this.listField.contents.children[0].adjustWidths(),this.listField.setTop(c.bottom()+this.padding),this.listField.setHeight(this.body.height()-c.height()-
this.padding),this.magnifyingGlass&&(this.magnifyingGlass.setTop(c.top()),this.magnifyingGlass.setLeft(this.listField.left())),this.preview.setRight(this.body.right()),this.preview.setTop(c.bottom()+this.padding),this.notesField.setTop(this.preview.bottom()+b),this.notesField.setLeft(this.preview.left()),this.notesField.setHeight(this.body.bottom()-this.preview.bottom()-b));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&0<this.buttons.children.length&&
(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding));Morph.prototype.trackChanges=d;this.changed()};LibraryImportDialogMorph.prototype=new DialogBoxMorph;LibraryImportDialogMorph.prototype.constructor=LibraryImportDialogMorph;LibraryImportDialogMorph.uber=DialogBoxMorph.prototype;function LibraryImportDialogMorph(a,b){this.init(a,b)}
LibraryImportDialogMorph.prototype.init=function(a,b){LibraryImportDialogMorph.uber.init.call(this,this,null,null);this.ide=a;this.key="importLibrary";this.librariesData=b;this.libraryCache={};this.notesField=this.notesText=this.palette=this.listField=this.handle=null;this.labelString="Import library";this.createLabel();this.buildContents()};
LibraryImportDialogMorph.prototype.buildContents=function(){this.addBody(new Morph);this.body.color=this.color;this.initializePalette();this.initializeLibraryDescription();this.installLibrariesList();this.addButton("importLibrary","Import");this.addButton("cancel","Cancel");this.setExtent(new Point(460,455));this.fixLayout()};
LibraryImportDialogMorph.prototype.initializePalette=function(){this.palette&&this.palette.destroy();this.palette=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor);this.palette.color=SpriteMorph.prototype.paletteColor;this.palette.padding=4;this.palette.isDraggable=!1;this.palette.acceptsDrops=!1;this.palette.contents.acceptsDrops=!1;this.body.add(this.palette)};
LibraryImportDialogMorph.prototype.initializeLibraryDescription=function(){this.notesField&&this.notesField.destroy();this.notesField=new ScrollFrameMorph;this.notesField.fixLayout=nop;this.notesField.edge=InputFieldMorph.prototype.edge;this.notesField.fontSize=InputFieldMorph.prototype.fontSize;this.notesField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.notesField.contrast=InputFieldMorph.prototype.contrast;this.notesField.drawNew=InputFieldMorph.prototype.drawNew;this.notesField.drawRectBorder=
InputFieldMorph.prototype.drawRectBorder;this.notesField.acceptsDrops=!1;this.notesField.contents.acceptsDrops=!1;this.notesText=new TextMorph("");this.notesField.isTextLineWrapping=!0;this.notesField.padding=3;this.notesField.setContents(this.notesText);this.notesField.setHeight(100);this.body.add(this.notesField)};
LibraryImportDialogMorph.prototype.installLibrariesList=function(){var a=this;this.listField&&this.listField.destroy();this.listField=new ListMorph(this.librariesData,function(a){return a.name},null,function(){a.importLibrary()});this.fixListFieldItemColors();this.listField.fixLayout=nop;this.listField.edge=InputFieldMorph.prototype.edge;this.listField.fontSize=InputFieldMorph.prototype.fontSize;this.listField.typeInPadding=InputFieldMorph.prototype.typeInPadding;this.listField.contrast=InputFieldMorph.prototype.contrast;
this.listField.drawNew=InputFieldMorph.prototype.drawNew;this.listField.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;this.listField.action=function(b){isNil(b)||(a.notesText.text=b.description||"",a.notesText.drawNew(),a.notesField.contents.adjustBounds(),a.hasCached(b.fileName)?a.displayBlocks(b.fileName):(a.showMessage(localize("Loading")+"\n"+localize(b.name)),a.ide.getURL(a.ide.resourceURL("libraries",b.fileName),function(c){a.cacheLibrary(b.fileName,a.ide.serializer.loadBlocks(c));
a.displayBlocks(b.fileName)})))};this.listField.setWidth(200);this.body.add(this.listField);this.fixLayout()};LibraryImportDialogMorph.prototype.popUp=function(){var a=this.ide.world();a&&(LibraryImportDialogMorph.uber.popUp.call(this,a),this.handle=new HandleMorph(this,300,300,this.corner,this.corner))};LibraryImportDialogMorph.prototype.fixListFieldItemColors=ProjectDialogMorph.prototype.fixListFieldItemColors;LibraryImportDialogMorph.prototype.clearDetails=ProjectDialogMorph.prototype.clearDetails;
LibraryImportDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding,b=this.padding/2,c=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())),this.listField.setExtent(new Point(200,this.body.height())),this.notesField.setExtent(new Point(this.body.width()-
this.listField.width()-b,100)),this.palette.setExtent(new Point(this.notesField.width(),this.body.height()-this.notesField.height()-b)),this.listField.contents.children[0].adjustWidths(),this.listField.setPosition(this.body.position()),this.palette.setPosition(this.listField.topRight().add(new Point(b,0))),this.notesField.setPosition(this.palette.bottomLeft().add(new Point(0,b))));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&
(this.buttons.fixLayout(),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding));Morph.prototype.trackChanges=c;this.changed()};LibraryImportDialogMorph.prototype.hasCached=function(a){return this.libraryCache.hasOwnProperty(a)};LibraryImportDialogMorph.prototype.cacheLibrary=function(a,b){this.libraryCache[a]=b};LibraryImportDialogMorph.prototype.cachedLibrary=function(a){return this.libraryCache[a]};
LibraryImportDialogMorph.prototype.importLibrary=function(){var a=this.ide;var b=this.listField.selected.fileName;var c=this.listField.selected.name;this.hasCached(b)?(b=this.cachedLibrary(b),b.forEach(function(b){b.receiver=a.stage;a.stage.globalBlocks.push(b);a.stage.replaceDoubleDefinitionsFor(b)}),a.showMessage(localize("Imported")+" "+localize(c),2)):(a.showMessage(localize("Loading")+" "+localize(c)),a.getURL(a.resourceURL("libraries",b),function(b){a.droppedText(b,c)}));this.destroy()};
LibraryImportDialogMorph.prototype.displayBlocks=function(a){var b,c,d,e=this,f=this.cachedLibrary(a);if(f.length){this.initializePalette();var g=this.palette.left()+4;var h=this.palette.top();SpriteMorph.prototype.categories.forEach(function(a){f.forEach(function(f){f.category===a&&(a!==c&&(h+=4),c=a,b=f.templateInstance().fullImage(),d=new Morph,d.setExtent(new Point(b.width,b.height)),d.image=b,d.setPosition(new Point(g,h)),e.palette.addContents(d),h+=d.fullBounds().height()+4)})});this.palette.scrollX(4);
this.palette.scrollY(4);this.fixLayout()}};LibraryImportDialogMorph.prototype.showMessage=function(a){a=new MenuMorph(null,a);this.initializePalette();this.fixLayout();a.popUpCenteredInWorld(this.palette.contents)};SpriteIconMorph.prototype=new ToggleButtonMorph;SpriteIconMorph.prototype.constructor=SpriteIconMorph;SpriteIconMorph.uber=ToggleButtonMorph.prototype;SpriteIconMorph.prototype.thumbSize=new Point(40,40);SpriteIconMorph.prototype.labelShadowOffset=null;
SpriteIconMorph.prototype.labelShadowColor=null;SpriteIconMorph.prototype.labelColor=new Color(255,255,255);SpriteIconMorph.prototype.fontSize=9;function SpriteIconMorph(a,b){this.init(a,b)}
SpriteIconMorph.prototype.init=function(a,b){var c,d=this;b||(c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]);this.object=a||new SpriteMorph;this.version=this.object.version;this.rotationButton=this.thumbnail=null;SpriteIconMorph.uber.init.call(this,c,null,function(){var a=d.parentThatIsA(IDE_Morph);a&&a.selectSprite(d.object)},this.object.name,function(){var a=d.parentThatIsA(IDE_Morph);return a?a.currentSprite===d.object:!1},null,function(){return a.exemplar?
localize("parent")+":\n"+a.exemplar.name:null},b);this.isDraggable=!0;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};SpriteIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy();this.thumbnail=new Morph;this.thumbnail.setExtent(this.thumbSize);this.object instanceof SpriteMorph?(this.thumbnail.image=this.object.fullThumbnail(this.thumbSize),this.createRotationButton()):this.thumbnail.image=this.object.thumbnail(this.thumbSize);this.add(this.thumbnail)};
SpriteIconMorph.prototype.createLabel=function(){this.label&&this.label.destroy();var a=new StringMorph(this.object.name,this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.label=new FrameMorph;this.label.acceptsDrops=!1;this.label.alpha=0;this.label.setExtent(a.extent());a.setPosition(this.label.position());this.label.add(a);this.add(this.label)};
SpriteIconMorph.prototype.createRotationButton=function(){var a=this;this.rotationButton&&(this.rotationButton.destroy(),this.roationButton=null);if(this.object.anchor){var b=new ToggleButtonMorph(null,null,function(){a.object.rotatesWithAnchor=!a.object.rotatesWithAnchor},["\u2192","\u21bb"],function(){return a.object.rotatesWithAnchor});b.corner=8;b.labelMinExtent=new Point(11,11);b.padding=0;b.pressColor=b.color;b.drawNew();b.fixLayout();b.refresh();b.changed();this.rotationButton=b;this.add(this.rotationButton)}};
SpriteIconMorph.prototype.step=function(){this.version!==this.object.version&&(this.createThumbnail(),this.createLabel(),this.fixLayout(),this.version=this.object.version,this.refresh())};
SpriteIconMorph.prototype.fixLayout=function(){if(!this.thumbnail||!this.label)return null;this.setWidth(this.thumbnail.width()+2*this.outline+2*this.edge+2*this.padding);this.setHeight(this.thumbnail.height()+2*this.outline+2*this.edge+3*this.padding+this.label.height());this.thumbnail.setCenter(this.center());this.thumbnail.setTop(this.top()+this.outline+this.edge+this.padding);this.rotationButton&&(this.rotationButton.setTop(this.top()),this.rotationButton.setRight(this.right()));this.label.setWidth(Math.min(this.label.children[0].width(),
this.thumbnail.width()));this.label.setCenter(this.center());this.label.setTop(this.thumbnail.bottom()+this.padding)};
SpriteIconMorph.prototype.userMenu=function(){var a=new MenuMorph(this),b=this;if(this.object instanceof StageMorph)return a.addItem("pic...",function(){b.parentThatIsA(IDE_Morph).saveCanvasAs(b.object.fullImageClassic(),this.object.name)},"open a new window\nwith a picture of the stage"),a;if(!(this.object instanceof SpriteMorph))return null;a.addItem("show","showSpriteOnStage");a.addLine();a.addItem("duplicate","duplicateSprite");StageMorph.prototype.enableInheritance&&a.addItem("clone","instantiateSprite");
a.addItem("delete","removeSprite");a.addLine();StageMorph.prototype.enableInheritance&&(a.addItem("parent...","chooseExemplar"),this.object.exemplar&&a.addItem("release","releaseSprite","make temporary and\nhide in the sprite corral"));this.object.anchor&&a.addItem(localize("detach from")+" "+this.object.anchor.name,function(){b.object.detachFromAnchor()});this.object.parts.length&&a.addItem("detach all parts",function(){b.object.detachAllParts()});a.addItem("export...","exportSprite");return a};
SpriteIconMorph.prototype.duplicateSprite=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.duplicateSprite(this.object)};SpriteIconMorph.prototype.instantiateSprite=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.instantiateSprite(this.object)};SpriteIconMorph.prototype.removeSprite=function(){var a=this.parentThatIsA(IDE_Morph);a&&a.removeSprite(this.object)};SpriteIconMorph.prototype.exportSprite=function(){this.object.exportSprite()};SpriteIconMorph.prototype.chooseExemplar=function(){this.object.chooseExemplar()};
SpriteIconMorph.prototype.releaseSprite=function(){this.object.release()};SpriteIconMorph.prototype.showSpriteOnStage=function(){this.object.showOnStage()};SpriteIconMorph.prototype.mouseDoubleClick=function(){this.object instanceof SpriteMorph&&this.object.flash()};
SpriteIconMorph.prototype.createBackgrounds=function(){var a=this.extent();if(this.template)return this.image=this.template.image,this.normalImage=this.template.normalImage,this.highlightImage=this.template.highlightImage,this.pressImage=this.template.pressImage,null;this.normalImage=newCanvas(a);var b=this.normalImage.getContext("2d");this.drawBackground(b,this.color);this.highlightImage=newCanvas(a);b=this.highlightImage.getContext("2d");this.drawBackground(b,this.highlightColor);this.pressImage=
newCanvas(a);b=this.pressImage.getContext("2d");this.drawOutline(b);this.drawBackground(b,this.pressColor);this.drawEdges(b,this.pressColor,this.pressColor.lighter(this.contrast),this.pressColor.darker(this.contrast));this.image=this.normalImage};SpriteIconMorph.prototype.prepareToBeGrabbed=function(){var a=this.parentThatIsA(IDE_Morph);this.mouseClickLeft();this.alpha=.85;if(a){var b=a.sprites.asArray().indexOf(this.object);a.sprites.remove(b+1);a.createCorral();a.fixLayout()}};
SpriteIconMorph.prototype.justDropped=function(){this.alpha=1};SpriteIconMorph.prototype.wantsDropOf=function(a){return a instanceof BlockMorph||a instanceof CostumeIconMorph||a instanceof SoundIconMorph};SpriteIconMorph.prototype.reactToDropOf=function(a,b){a instanceof BlockMorph?this.copyStack(a):a instanceof CostumeIconMorph?this.copyCostume(a.object):a instanceof SoundIconMorph&&this.copySound(a.object);this.world().add(a);a.slideBackTo(b.grabOrigin)};
SpriteIconMorph.prototype.copyStack=function(a){var b=a.fullCopy();a=Math.max(this.object.scripts.children.map(function(a){return a.fullBounds().bottom()}).concat([this.object.scripts.top()]));b.setPosition(new Point(this.object.scripts.left()+20,a+20));this.object.scripts.add(b);b.allComments().forEach(function(a){a.align(b)});this.object.scripts.adjustBounds();b.allChildren().forEach(function(a){a.definition&&!a.definition.isGlobal&&a.deleteBlock()})};
SpriteIconMorph.prototype.copyCostume=function(a){a=a.copy();a.name=this.object.newCostumeName(a.name);this.object.addCostume(a);this.object.wearCostume(a)};SpriteIconMorph.prototype.copySound=function(a){a=a.copy();this.object.addSound(a.audio,a.name)};CostumeIconMorph.prototype=new ToggleButtonMorph;CostumeIconMorph.prototype.constructor=CostumeIconMorph;CostumeIconMorph.uber=ToggleButtonMorph.prototype;CostumeIconMorph.prototype.thumbSize=new Point(80,60);
CostumeIconMorph.prototype.labelShadowOffset=null;CostumeIconMorph.prototype.labelShadowColor=null;CostumeIconMorph.prototype.labelColor=new Color(255,255,255);CostumeIconMorph.prototype.fontSize=9;function CostumeIconMorph(a,b){this.init(a,b)}
CostumeIconMorph.prototype.init=function(a,b){var c,d=this;b||(c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]);this.object=a||new Costume;this.version=this.object.version;this.thumbnail=null;CostumeIconMorph.uber.init.call(this,c,null,function(){var a=d.parentThatIsA(IDE_Morph),b=d.parentThatIsA(WardrobeMorph);a&&a.currentSprite.wearCostume(d.object);b&&b.updateSelection()},this.object.name,function(){var a=d.parentThatIsA(IDE_Morph);return a?a.currentSprite.costume===
d.object:!1},null,null,b);this.isDraggable=!0;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};CostumeIconMorph.prototype.createThumbnail=function(){SpriteIconMorph.prototype.createThumbnail.call(this);if(this.object instanceof SVG_Costume){var a=new StringMorph("svg",.8*this.fontSize,this.fontStyle,!1,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor);a.setBottom(this.thumbnail.bottom());this.thumbnail.add(a)}};
CostumeIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;CostumeIconMorph.prototype.step=SpriteIconMorph.prototype.step;CostumeIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;
CostumeIconMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!(this.object instanceof Costume))return null;a.addItem("edit","editCostume");16===this.world().currentKey&&a.addItem("edit rotation point only...","editRotationPointOnly",null,new Color(100,0,0));a.addItem("rename","renameCostume");a.addLine();a.addItem("duplicate","duplicateCostume");a.addItem("delete","removeCostume");a.addLine();a.addItem("export","exportCostume");return a};
CostumeIconMorph.prototype.editCostume=function(){this.disinherit();this.object instanceof SVG_Costume?this.object.editRotationPointOnly(this.world()):this.object.edit(this.world(),this.parentThatIsA(IDE_Morph),!1)};CostumeIconMorph.prototype.editRotationPointOnly=function(){var a=this.parentThatIsA(IDE_Morph);this.object.editRotationPointOnly(this.world());a.hasChangedMedia=!0};
CostumeIconMorph.prototype.renameCostume=function(){this.disinherit();var a=this.object,b=this.parentThatIsA(WardrobeMorph),c=this.parentThatIsA(IDE_Morph);(new DialogBoxMorph(null,function(d){d&&d!==a.name&&(a.name=b.sprite.newCostumeName(d,a),a.version=Date.now(),c.hasChangedMedia=!0)})).prompt(this.currentSprite instanceof SpriteMorph?"rename costume":"rename background",a.name,this.world())};
CostumeIconMorph.prototype.duplicateCostume=function(){var a=this.parentThatIsA(WardrobeMorph),b=this.parentThatIsA(IDE_Morph),c=this.object.copy();c.name=a.sprite.newCostumeName(c.name);a.sprite.addCostume(c);a.updateList();b&&b.currentSprite.wearCostume(c)};
CostumeIconMorph.prototype.removeCostume=function(){var a=this.parentThatIsA(WardrobeMorph),b=this.parent.children.indexOf(this),c=CamSnapshotDialogMorph.prototype.enableCamera?3:2,d=this.parentThatIsA(IDE_Morph);a.removeCostumeAt(b-c);d.currentSprite.costume===this.object&&d.currentSprite.wearCostume(null)};
CostumeIconMorph.prototype.exportCostume=function(){var a=this.parentThatIsA(IDE_Morph);this.object instanceof SVG_Costume?a.saveFileAs(this.object.contents.src,"text/svg",this.object.name):a.saveCanvasAs(this.object.contents,this.object.name)};CostumeIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds;
CostumeIconMorph.prototype.disinherit=function(){var a=this.parentThatIsA(WardrobeMorph),b=this.parent.children.indexOf(this);a.sprite.inheritsAttribute("costumes")&&(a.sprite.shadowAttribute("costumes"),this.object=a.sprite.costumes.at(b-2))};CostumeIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit();this.mouseClickLeft();this.removeCostume()};TurtleIconMorph.prototype=new ToggleButtonMorph;TurtleIconMorph.prototype.constructor=TurtleIconMorph;TurtleIconMorph.uber=ToggleButtonMorph.prototype;
TurtleIconMorph.prototype.thumbSize=new Point(80,60);TurtleIconMorph.prototype.labelShadowOffset=null;TurtleIconMorph.prototype.labelShadowColor=null;TurtleIconMorph.prototype.labelColor=new Color(255,255,255);TurtleIconMorph.prototype.fontSize=9;function TurtleIconMorph(a,b){this.init(a,b)}
TurtleIconMorph.prototype.init=function(a,b){var c,d=this;b||(c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]);this.object=a;this.version=this.object.version;this.thumbnail=null;TurtleIconMorph.uber.init.call(this,c,null,function(){var a=d.parentThatIsA(IDE_Morph),b=d.parentThatIsA(WardrobeMorph);a&&a.currentSprite.wearCostume(null);b&&b.updateSelection()},"default",function(){var a=d.parentThatIsA(IDE_Morph);return a?null===a.currentSprite.costume:
!1},null,null,b);this.isDraggable=!1;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout()};TurtleIconMorph.prototype.createThumbnail=function(){var a=MorphicPreferences.isFlat;this.thumbnail&&this.thumbnail.destroy();this.thumbnail=this.object instanceof SpriteMorph?new SymbolMorph("turtle",this.thumbSize.y,this.labelColor,a?null:new Point(-1,-1),new Color(0,0,0)):new SymbolMorph("stage",this.thumbSize.y,this.labelColor,a?null:new Point(-1,-1),new Color(0,0,0));this.add(this.thumbnail)};
TurtleIconMorph.prototype.createLabel=function(){this.label&&this.label.destroy();var a=new StringMorph(localize(this.object instanceof SpriteMorph?"Turtle":"Empty"),this.fontSize,this.fontStyle,!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,this.labelColor);this.label=new FrameMorph;this.label.acceptsDrops=!1;this.label.alpha=0;this.label.setExtent(a.extent());a.setPosition(this.label.position());this.label.add(a);this.add(this.label)};TurtleIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;
TurtleIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds;
TurtleIconMorph.prototype.userMenu=function(){var a=this,b=new MenuMorph(this,"pen");if(this.object instanceof StageMorph)return null;b.addItem(("tip"===this.object.penPoint?"\u25cf":"\u25cb")+" "+localize("tip"),function(){a.object.penPoint="tip";a.object.changed();a.object.drawNew();a.object.changed()});b.addItem(("middle"===this.object.penPoint?"\u25cf":"\u25cb")+" "+localize("middle"),function(){a.object.penPoint="middle";a.object.changed();a.object.drawNew();a.object.changed()});return b};
WardrobeMorph.prototype=new ScrollFrameMorph;WardrobeMorph.prototype.constructor=WardrobeMorph;WardrobeMorph.uber=ScrollFrameMorph.prototype;function WardrobeMorph(a,b){this.init(a,b)}WardrobeMorph.prototype.init=function(a,b){this.sprite=a||new SpriteMorph;this.spriteVersion=this.costumesVersion=null;WardrobeMorph.uber.init.call(this,null,null,b);this.fps=2;this.updateList()};
WardrobeMorph.prototype.updateList=function(){var a=this,b=this.left()+5,c=this.top()+5,d=Morph.prototype.trackChanges,e=this.contents.position(),f;this.changed();d=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.contents.destroy();this.contents=new FrameMorph(this);this.contents.acceptsDrops=!1;this.contents.reactToDropOf=function(b){a.reactToDropOf(b)};this.addBack(this.contents);var g=new TurtleIconMorph(this.sprite);g.setPosition(new Point(b,c));a.addContents(g);c=g.bottom()+
4;var h=new PushButtonMorph(this,"paintNew",new SymbolMorph("brush",15));h.padding=0;h.corner=12;h.color=IDE_Morph.prototype.groupColor;h.highlightColor=IDE_Morph.prototype.frameColor.darker(50);h.pressColor=h.highlightColor;h.labelMinExtent=new Point(36,18);h.labelShadowOffset=new Point(-1,-1);h.labelShadowColor=h.highlightColor;h.labelColor=TurtleIconMorph.prototype.labelColor;h.contrast=this.buttonContrast;h.drawNew();h.hint="Paint a new costume";h.setPosition(new Point(b,c));h.fixLayout();h.setCenter(g.center());
h.setLeft(g.right()+16);this.addContents(h);if(CamSnapshotDialogMorph.prototype.enableCamera){var k=new PushButtonMorph(this,"newFromCam",new SymbolMorph("camera",15));k.padding=0;k.corner=12;k.color=IDE_Morph.prototype.groupColor;k.highlightColor=IDE_Morph.prototype.frameColor.darker(50);k.pressColor=h.highlightColor;k.labelMinExtent=new Point(36,18);k.labelShadowOffset=new Point(-1,-1);k.labelShadowColor=h.highlightColor;k.labelColor=TurtleIconMorph.prototype.labelColor;k.contrast=this.buttonContrast;
k.drawNew();k.hint="Import a new costume from your webcam";k.setPosition(new Point(b,c));k.fixLayout();k.setCenter(h.center());k.setLeft(h.right()+5);this.addContents(k);CamSnapshotDialogMorph.prototype.enabled||(k.disable(),k.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage);document.addEventListener("cameraDisabled",function(){k.disable();k.hint=CamSnapshotDialogMorph.prototype.notSupportedMessage})}h=new TextMorph(localize("costumes tab help"));h.fontSize=9;h.setColor(SpriteMorph.prototype.paletteTextColor);
h.setPosition(new Point(b,c));this.addContents(h);c=h.bottom()+4;this.sprite.costumes.asArray().forEach(function(d){f=g=new CostumeIconMorph(d,f);g.setPosition(new Point(b,c));a.addContents(g);c=g.bottom()+4});this.costumesVersion=this.sprite.costumes.lastChanged;this.contents.setPosition(e);this.adjustScrollBars();Morph.prototype.trackChanges=d;this.changed();this.updateSelection()};
WardrobeMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(a){a.refresh&&a.refresh()});this.spriteVersion=this.sprite.version};WardrobeMorph.prototype.step=function(){this.costumesVersion!==this.sprite.costumes.lastChanged&&this.updateList();this.spriteVersion!==this.sprite.version&&this.updateSelection()};WardrobeMorph.prototype.removeCostumeAt=function(a){this.sprite.shadowAttribute("costumes");this.sprite.costumes.remove(a);this.updateList()};
WardrobeMorph.prototype.paintNew=function(){var a=new Costume(newCanvas(null,!0),this.sprite.newCostumeName(localize("Untitled"))),b=this.parentThatIsA(IDE_Morph),c=this;a.edit(this.world(),b,!0,null,function(){c.sprite.shadowAttribute("costumes");c.sprite.addCostume(a);c.updateList();b&&b.currentSprite.wearCostume(a)})};
WardrobeMorph.prototype.newFromCam=function(){var a=this.parentThatIsA(IDE_Morph),b=this,c=this.sprite;(new CamSnapshotDialogMorph(a,c,nop,function(a){c.addCostume(a);c.wearCostume(a);b.updateList()})).popUp(this.world())};WardrobeMorph.prototype.wantsDropOf=function(a){return a instanceof CostumeIconMorph};
WardrobeMorph.prototype.reactToDropOf=function(a){var b=0,c=a.object,d=a.top();a.destroy();this.contents.children.forEach(function(a){a instanceof CostumeIconMorph&&a.top()<d-4&&(b+=1)});this.sprite.shadowAttribute("costumes");this.sprite.costumes.add(c,b+1);this.updateList();a.mouseClickLeft()};SoundIconMorph.prototype=new ToggleButtonMorph;SoundIconMorph.prototype.constructor=SoundIconMorph;SoundIconMorph.uber=ToggleButtonMorph.prototype;SoundIconMorph.prototype.thumbSize=new Point(80,60);
SoundIconMorph.prototype.labelShadowOffset=null;SoundIconMorph.prototype.labelShadowColor=null;SoundIconMorph.prototype.labelColor=new Color(255,255,255);SoundIconMorph.prototype.fontSize=9;function SoundIconMorph(a,b){this.init(a,b)}
SoundIconMorph.prototype.init=function(a,b){var c;b||(c=[IDE_Morph.prototype.groupColor,IDE_Morph.prototype.frameColor,IDE_Morph.prototype.frameColor]);this.object=a;this.version=this.object.version;this.thumbnail=null;SoundIconMorph.uber.init.call(this,c,null,function(){nop()},this.object.name,function(){return!1},null,null,b);this.isDraggable=!0;this.createThumbnail();this.padding=2;this.corner=8;this.fixLayout();this.fps=1};
SoundIconMorph.prototype.createThumbnail=function(){this.thumbnail&&this.thumbnail.destroy();this.thumbnail=new Morph;this.thumbnail.setExtent(this.thumbSize);this.add(this.thumbnail);var a=new StringMorph(this.createInfo(),"16","",!0,!1,!1,this.labelShadowOffset,this.labelShadowColor,new Color(200,200,200));this.thumbnail.add(a);a.setCenter(new Point(40,15));this.button=new PushButtonMorph(this,"toggleAudioPlaying",this.object.previewAudio?"Stop":"Play");this.button.drawNew();this.button.hint="Play sound";
this.button.fixLayout();this.thumbnail.add(this.button);this.button.setCenter(new Point(40,40))};SoundIconMorph.prototype.createInfo=function(){var a=Math.round(this.object.audio.duration||0),b=a%60;return Math.floor(a/60).toString()+":"+(10>b?"0":"")+b.toString()};
SoundIconMorph.prototype.toggleAudioPlaying=function(){var a=this;this.object.previewAudio?(this.button.labelString="Play",this.button.hint="Play sound",this.object.previewAudio.pause(),this.object.previewAudio.terminated=!0,this.object.previewAudio=null):(this.button.labelString="Stop",this.button.hint="Stop sound",this.object.previewAudio=this.object.play(),this.object.previewAudio.addEventListener("ended",function(){a.audioHasEnded()},!1));this.button.createLabel()};
SoundIconMorph.prototype.audioHasEnded=function(){this.button.trigger();this.button.mouseLeave()};SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;SoundIconMorph.prototype.fixLayout=SpriteIconMorph.prototype.fixLayout;SoundIconMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(!(this.object instanceof Sound))return null;a.addItem("rename","renameSound");a.addItem("delete","removeSound");return a};
SoundIconMorph.prototype.renameSound=function(){var a=this.object,b=this.parentThatIsA(IDE_Morph),c=this;this.disinherit();(new DialogBoxMorph(null,function(d){d&&d!==a.name&&(a.name=d,a.version=Date.now(),c.createLabel(),c.fixLayout(),b.hasChangedMedia=!0)})).prompt("rename sound",a.name,this.world())};SoundIconMorph.prototype.removeSound=function(){var a=this.parentThatIsA(JukeboxMorph),b=this.parent.children.indexOf(this);a.removeSound(b)};SoundIconMorph.prototype.createBackgrounds=SpriteIconMorph.prototype.createBackgrounds;
SoundIconMorph.prototype.createLabel=SpriteIconMorph.prototype.createLabel;SoundIconMorph.prototype.disinherit=function(){var a=this.parentThatIsA(JukeboxMorph),b=this.parent.children.indexOf(this);a.sprite.inheritsAttribute("sounds")&&(a.sprite.shadowAttribute("sounds"),this.object=a.sprite.sounds.at(b))};SoundIconMorph.prototype.prepareToBeGrabbed=function(){this.disinherit();this.removeSound()};JukeboxMorph.prototype=new ScrollFrameMorph;JukeboxMorph.prototype.constructor=JukeboxMorph;
JukeboxMorph.uber=ScrollFrameMorph.prototype;function JukeboxMorph(a,b){this.init(a,b)}JukeboxMorph.prototype.init=function(a,b){this.sprite=a||new SpriteMorph;this.spriteVersion=this.soundsVersion=null;JukeboxMorph.uber.init.call(this,null,null,b);this.acceptsDrops=!1;this.fps=2;this.updateList()};
JukeboxMorph.prototype.updateList=function(){var a=this,b=this.left()+5,c=this.top()+5,d=Morph.prototype.trackChanges,e,f;this.changed();d=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.contents.destroy();this.contents=new FrameMorph(this);this.contents.acceptsDrops=!1;this.contents.reactToDropOf=function(b){a.reactToDropOf(b)};this.addBack(this.contents);var g=new TextMorph(localize("import a sound from your computer\nby dragging it into here"));g.fontSize=9;g.setColor(SpriteMorph.prototype.paletteTextColor);
g.setPosition(new Point(b,c));this.addContents(g);c=g.bottom()+4;this.sprite.sounds.asArray().forEach(function(d){f=e=new SoundIconMorph(d,f);e.setPosition(new Point(b,c));a.addContents(e);c=e.bottom()+4});this.soundsVersion=this.sprite.costumes.lastChanged;Morph.prototype.trackChanges=d;this.changed();this.updateSelection()};JukeboxMorph.prototype.updateSelection=function(){this.contents.children.forEach(function(a){a.refresh&&a.refresh()});this.spriteVersion=this.sprite.version};
JukeboxMorph.prototype.step=function(){this.soundsVersion!==this.sprite.sounds.lastChanged&&this.updateList();this.spriteVersion!==this.sprite.version&&this.updateSelection()};JukeboxMorph.prototype.removeSound=function(a){this.sprite.sounds.remove(a);this.updateList()};JukeboxMorph.prototype.wantsDropOf=function(a){return a instanceof SoundIconMorph};
JukeboxMorph.prototype.reactToDropOf=function(a){var b=0,c=a.object,d=a.top();a.destroy();this.contents.children.forEach(function(a){a.top()<d-4&&(b+=1)});this.sprite.shadowAttribute("sounds");this.sprite.sounds.add(c,b);this.updateList()};StageHandleMorph.prototype=new Morph;StageHandleMorph.prototype.constructor=StageHandleMorph;StageHandleMorph.uber=Morph.prototype;function StageHandleMorph(a){this.init(a)}
StageHandleMorph.prototype.init=function(a){this.target=a||null;HandleMorph.uber.init.call(this);this.color=MorphicPreferences.isFlat?IDE_Morph.prototype.groupColor:new Color(190,190,190);this.isDraggable=!1;this.noticesTransparentClick=!0;this.setExtent(new Point(12,50))};
StageHandleMorph.prototype.drawNew=function(){this.normalImage=newCanvas(this.extent());this.highlightImage=newCanvas(this.extent());this.drawOnCanvas(this.normalImage,this.color);this.drawOnCanvas(this.highlightImage,MorphicPreferences.isFlat?new Color(245,245,255):new Color(100,100,255),this.color);this.image=this.normalImage;this.fixLayout()};
StageHandleMorph.prototype.drawOnCanvas=function(a,b,c){var d=a.getContext("2d"),e=a.height/8,f=a.width/6,g=f/2,h;d.lineWidth=f;d.lineCap="round";var k=a.height/2;d.strokeStyle=b.toString();b=a.width/12;for(h=0;3>h;h+=1)0<h&&(d.beginPath(),d.moveTo(b,k-(e-g)),d.lineTo(b,k+(e-g)),d.stroke()),b+=2*f,e*=2;if(c)for(d.strokeStyle=c.toString(),b=a.width/12+f,e=a.height/8,h=0;3>h;h+=1)0<h&&(d.beginPath(),d.moveTo(b,k-(e-g)),d.lineTo(b,k+(e-g)),d.stroke()),b+=2*f,e*=2};
StageHandleMorph.prototype.fixLayout=function(){if(this.target){var a=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10);this.setRight(this.target.left());a&&a.add(this)}};StageHandleMorph.prototype.step=null;
StageHandleMorph.prototype.mouseDownLeft=function(a){var b=this.world(),c=this.right()-a.x,d=this,e=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;e.isSmallStage=!0;e.controlBar.stageSizeButton.refresh();this.step=function(){if(b.hand.mouseButton){var a=b.hand.bounds.origin.x+c;a=d.target.right()-a;e.stageRatio=a/d.target.dimensions.x;e.setExtent(b.extent())}else this.step=null,e.isSmallStage=1!==e.stageRatio,e.controlBar.stageSizeButton.refresh()}};
StageHandleMorph.prototype.mouseEnter=function(){this.image=this.highlightImage;this.changed()};StageHandleMorph.prototype.mouseLeave=function(){this.image=this.normalImage;this.changed()};StageHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).toggleStageSize(!0,1)};PaletteHandleMorph.prototype=new Morph;PaletteHandleMorph.prototype.constructor=PaletteHandleMorph;PaletteHandleMorph.uber=Morph.prototype;function PaletteHandleMorph(a){this.init(a)}
PaletteHandleMorph.prototype.init=function(a){this.target=a||null;HandleMorph.uber.init.call(this);this.color=MorphicPreferences.isFlat?new Color(255,255,255):new Color(190,190,190);this.isDraggable=!1;this.noticesTransparentClick=!0;this.setExtent(new Point(12,50))};PaletteHandleMorph.prototype.drawNew=StageHandleMorph.prototype.drawNew;PaletteHandleMorph.prototype.drawOnCanvas=StageHandleMorph.prototype.drawOnCanvas;
PaletteHandleMorph.prototype.fixLayout=function(){if(this.target){var a=this.target.parentThatIsA(IDE_Morph);this.setTop(this.target.top()+10);this.setRight(this.target.right());a&&a.add(this)}};PaletteHandleMorph.prototype.step=null;
PaletteHandleMorph.prototype.mouseDownLeft=function(a){var b=this.world(),c=this.right()-a.x,d=this.target.parentThatIsA(IDE_Morph);if(!this.target)return null;this.step=function(){if(b.hand.mouseButton){var a=b.hand.bounds.origin.x+c;d.paletteWidth=Math.min(Math.max(200,a),d.stageHandle.left()-d.spriteBar.tabBar.width());d.setExtent(b.extent())}else this.step=null}};PaletteHandleMorph.prototype.mouseEnter=StageHandleMorph.prototype.mouseEnter;PaletteHandleMorph.prototype.mouseLeave=StageHandleMorph.prototype.mouseLeave;
PaletteHandleMorph.prototype.mouseDoubleClick=function(){this.target.parentThatIsA(IDE_Morph).setPaletteWidth(200)};CamSnapshotDialogMorph.prototype=new DialogBoxMorph;CamSnapshotDialogMorph.prototype.constructor=CamSnapshotDialogMorph;CamSnapshotDialogMorph.uber=DialogBoxMorph.prototype;CamSnapshotDialogMorph.prototype.enableCamera=!0;CamSnapshotDialogMorph.prototype.enabled=!0;CamSnapshotDialogMorph.prototype.notSupportedMessage='Please make sure your web browser is up to date\nand your camera is properly configured. \n\nSome browsers also require you to access Snap!\nthrough HTTPS to use the camera.\n\nPlase replace the "http://" part of the address\nin your browser by "https://" and try again.';
function CamSnapshotDialogMorph(a,b,c,d){this.init(a,b,c,d)}CamSnapshotDialogMorph.prototype.init=function(a,b,c,d){this.ide=a;this.sprite=b;this.padding=10;this.oncancel=c;this.accept=d;this.videoElement=null;this.videoView=new Morph;CamSnapshotDialogMorph.uber.init.call(this);this.labelString="Camera";this.createLabel();this.buildContents()};
CamSnapshotDialogMorph.prototype.buildContents=function(){function a(){b.disable();b.ide.inform("Camera not supported",CamSnapshotDialogMorph.prototype.notSupportedMessage);b.videoElement&&b.videoElement.remove();b.cancel()}var b=this,c=this.sprite.parentThatIsA(StageMorph);this.videoElement=document.createElement("video");this.videoElement.hidden=!0;this.videoElement.width=c.dimensions.x;this.videoElement.height=c.dimensions.y;document.body.appendChild(this.videoElement);navigator.mediaDevices&&
navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({video:!0}).then(function(c){b.videoElement.srcObject=c;b.videoElement.play().catch(a);b.videoElement.stream=c}).catch(a);this.videoView.setExtent(c.dimensions);this.videoView.image=newCanvas(c.dimensions);this.videoView.drawOn=function(a){a=a.getContext("2d");var d=b.videoElement.videoWidth,f=b.videoElement.videoHeight,g=c.dimensions.x,h=c.dimensions.y;if(d){a.save();a.translate(g,0);a.scale(-1,1);if(d/g>f/h){var k=f/h*g;d=
f}else k=d,d=d/g*h;a.drawImage(b.videoElement,0,0,k,d,-1*this.left(),this.top(),g,h);a.restore()}};this.videoView.step=function(){this.changed()};this.addBody(new AlignmentMorph("column",this.padding/2));this.body.add(this.videoView);this.body.fixLayout();this.addButton("ok","Save");this.addButton("cancel","Cancel");this.fixLayout();this.drawNew()};CamSnapshotDialogMorph.prototype.ok=function(){this.accept((new Costume(this.videoView.fullImageClassic(),this.sprite.newCostumeName("camera"))).flipped())};
CamSnapshotDialogMorph.prototype.disable=function(){CamSnapshotDialogMorph.prototype.enabled=!1;document.dispatchEvent(new Event("cameraDisabled"))};CamSnapshotDialogMorph.prototype.destroy=function(){this.oncancel.call(this);this.close()};CamSnapshotDialogMorph.prototype.close=function(){this.videoElement&&this.videoElement.stream&&(this.videoElement.stream.getTracks()[0].stop(),this.videoElement.remove());CamSnapshotDialogMorph.uber.destroy.call(this)};modules.paint="2017-April-10";PaintEditorMorph.prototype=new DialogBoxMorph;PaintEditorMorph.prototype.constructor=PaintEditorMorph;PaintEditorMorph.uber=DialogBoxMorph.prototype;PaintEditorMorph.prototype.padding=10;function PaintEditorMorph(){this.init()}PaintEditorMorph.prototype.init=function(){this.oncancel=this.paper=null;PaintEditorMorph.uber.init.call(this);this.labelString="Paint Editor";this.createLabel();this.buildContents()};
PaintEditorMorph.prototype.buildContents=function(){var a=this;this.paper=new PaintCanvasMorph(function(){return a.shift});this.paper.setExtent(StageMorph.prototype.dimensions);this.addBody(new AlignmentMorph("row",this.padding));this.controls=new AlignmentMorph("column",this.padding/2);this.controls.alignment="left";this.edits=new AlignmentMorph("row",this.padding/2);this.buildEdits();this.controls.add(this.edits);this.body.color=this.color;this.body.add(this.controls);this.body.add(this.paper);
this.toolbox=new BoxMorph;this.toolbox.color=SpriteMorph.prototype.paletteColor.lighter(8);this.toolbox.borderColor=this.toolbox.color.lighter(40);MorphicPreferences.isFlat&&(this.toolbox.edge=0);this.buildToolbox();this.controls.add(this.toolbox);this.scaleBox=new AlignmentMorph("row",this.padding/2);this.buildScaleBox();this.controls.add(this.scaleBox);this.propertiesControls={colorpicker:null,penSizeSlider:null,penSizeField:null,primaryColorButton:null,primaryColorViewer:null,constrain:null};this.populatePropertiesMenu();
this.addButton("ok","OK");this.addButton("cancel","Cancel");this.refreshToolButtons();this.fixLayout();this.drawNew()};
PaintEditorMorph.prototype.buildToolbox=function(){var a={brush:"Paintbrush tool\n(free draw)",rectangle:"Stroked Rectangle\n(shift: square)",circle:"Stroked Ellipse\n(shift: circle)",eraser:"Eraser tool",crosshairs:"Set the rotation center",line:"Line tool\n(shift: vertical/horizontal)",rectangleSolid:"Filled Rectangle\n(shift: square)",circleSolid:"Filled Ellipse\n(shift: circle)",paintbucket:"Fill a region",pipette:"Pipette tool\n(pick a color anywhere)"},b=this,c=this.toolbox.left(),d=this.toolbox.top(),
e=0,f=0;Object.keys(a).forEach(function(g){var h=b.toolButton(g,a[g]);h.setPosition(new Point(c+e,d+f));e+=h.width()+2;"crosshairs"===g&&(e=0,f+=h.height()+2,b.paper.drawcrosshair());b.toolbox[g]=h;b.toolbox.add(h)});this.toolbox.bounds=this.toolbox.fullBounds().expandBy(10);this.toolbox.drawNew()};PaintEditorMorph.prototype.buildEdits=function(){var a=this.paper;this.edits.add(this.pushButton("undo",function(){a.undo()}));this.edits.add(this.pushButton("clear",function(){a.clearCanvas()}));this.edits.fixLayout()};
PaintEditorMorph.prototype.buildScaleBox=function(){var a=this.paper;this.scaleBox.add(this.pushButton("grow",function(){a.scale(.05,.05)}));this.scaleBox.add(this.pushButton("shrink",function(){a.scale(-.05,-.05)}));this.scaleBox.add(this.pushButton("flip \u2194",function(){a.scale(-2,0)}));this.scaleBox.add(this.pushButton("flip \u2195",function(){a.scale(0,-2)}));this.scaleBox.fixLayout()};
PaintEditorMorph.prototype.openIn=function(a,b,c,d){this.oldim=b;this.callback=d||nop;this.processKeyUp=function(){this.shift=!1;this.propertiesControls.constrain.refresh()};this.processKeyDown=function(){this.shift=16===this.world().currentKey;this.propertiesControls.constrain.refresh()};this.oldim&&(this.paper.automaticCrosshairs=isNil(c),this.paper.centermerge(this.oldim,this.paper.paper),this.paper.rotationCenter=(c||new Point(0,0)).add(new Point((this.paper.paper.width-this.oldim.width)/2,(this.paper.paper.height-
this.oldim.height)/2)),this.paper.drawNew());this.key="paint";this.popUp(a)};PaintEditorMorph.prototype.fixLayout=function(){this.changed();var a=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.paper&&(this.paper.buildContents(),this.paper.drawNew());this.controls&&this.controls.fixLayout();this.body&&this.body.fixLayout();PaintEditorMorph.uber.fixLayout.call(this);Morph.prototype.trackChanges=a;this.changed()};PaintEditorMorph.prototype.refreshToolButtons=function(){this.toolbox.children.forEach(function(a){a.refresh()})};
PaintEditorMorph.prototype.ok=function(){this.paper.updateAutomaticCenter();this.callback(this.paper.paper,this.paper.rotationCenter);this.destroy()};PaintEditorMorph.prototype.cancel=function(){if(this.oncancel)this.oncancel();this.destroy()};
PaintEditorMorph.prototype.populatePropertiesMenu=function(){var a=this.controls,b=this,c=this.propertiesControls,d=new AlignmentMorph("row",this.padding);c.primaryColorViewer=new Morph;c.primaryColorViewer.setExtent(new Point(180,50));c.primaryColorViewer.color=new Color(0,0,0);c.colorpicker=new PaintColorPickerMorph(new Point(180,100),function(a){var d=newCanvas(c.primaryColorViewer.extent()),e=d.getContext("2d"),h;b.paper.settings.primarycolor=a;if("transparent"===a)for(a=0;180>a;a+=5)for(h=0;15>
h;h+=5)e.fillStyle=0===(h+a)/5%2?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.5)",e.fillRect(a,h,5,5);else e.fillStyle=a.toString(),e.fillRect(0,0,180,15);e.strokeStyle="black";e.lineWidth=Math.min(b.paper.settings.linewidth,20);e.beginPath();e.lineCap="round";e.moveTo(20,30);e.lineTo(160,30);e.stroke();c.primaryColorViewer.image=d;c.primaryColorViewer.changed()});c.colorpicker.action(new Color(0,0,0));c.penSizeSlider=new SliderMorph(0,20,5,5);c.penSizeSlider.orientation="horizontal";c.penSizeSlider.setHeight(15);
c.penSizeSlider.setWidth(150);c.penSizeSlider.action=function(a){c.penSizeField&&c.penSizeField.setContents(a);b.paper.settings.linewidth=a;c.colorpicker.action(b.paper.settings.primarycolor)};c.penSizeField=new InputFieldMorph("5",!0,null,!1);c.penSizeField.contents().minWidth=20;c.penSizeField.setWidth(25);c.penSizeField.accept=function(){var a=parseFloat(c.penSizeField.getValue());c.penSizeSlider.value=a;c.penSizeSlider.drawNew();c.penSizeSlider.updateValue();this.setContents(a);b.paper.settings.linewidth=
a;this.world().keyboardReceiver=b;c.colorpicker.action(b.paper.settings.primarycolor)};d.add(c.penSizeSlider);d.add(c.penSizeField);d.color=b.color;d.fixLayout();c.penSizeField.drawNew();c.constrain=new ToggleMorph("checkbox",this,function(){b.shift=!b.shift},"Constrain proportions of shapes?\n(you can also hold shift)",function(){return b.shift});a.add(c.colorpicker);a.add(c.primaryColorViewer);a.add(new TextMorph(localize("Brush size")));a.add(d);a.add(c.constrain)};
PaintEditorMorph.prototype.toolButton=function(a,b){var c=this;var d=new ToggleButtonMorph(null,this,function(){c.paper.currentTool=a;c.paper.toolChanged(a);c.refreshToolButtons();"pipette"===a&&c.getUserColor()},new SymbolMorph(a,18),function(){return c.paper.currentTool===a});d.hint=b;d.drawNew();d.fixLayout();return d};PaintEditorMorph.prototype.pushButton=function(a,b,c){return new PushButtonMorph(this,b,a,null,c)};
PaintEditorMorph.prototype.getUserColor=function(){var a=this,b=this.world(),c=b.hand,d=getDocumentPositionOf(b.worldCanvas),e=c.processMouseMove,f=c.processMouseDown,g=c.processMouseUp;c.processMouseMove=function(e){c.setPosition(new Point(e.pageX-d.x,e.pageY-d.y));e=b.getGlobalPixelColor(c.position());e.a&&(e.a=255,a.propertiesControls.colorpicker.action(e))};c.processMouseDown=nop;c.processMouseUp=function(){a.paper.currentTool="brush";a.paper.toolChanged("brush");a.refreshToolButtons();c.processMouseMove=
e;c.processMouseDown=f;c.processMouseUp=g}};PaintColorPickerMorph.prototype=new Morph;PaintColorPickerMorph.prototype.constructor=PaintColorPickerMorph;PaintColorPickerMorph.uber=Morph.prototype;function PaintColorPickerMorph(a,b){this.init(a,b)}PaintColorPickerMorph.prototype.init=function(a,b){this.setExtent(a||new Point(200,100));this.action=b||nop;this.drawNew()};
PaintColorPickerMorph.prototype.drawNew=function(){var a,b,c=newCanvas(this.extent()),d=c.getContext("2d");for(a=0;a<this.width();a+=1)for(b=0;b<this.height()-20;b+=1)d.fillStyle="hsl("+360*a/this.width()+",100%,"+100*b/(this.height()-20)+"%)",d.fillRect(a,b,1,1);for(a=0;a<this.width();a+=1)b=Math.floor(255*a/this.width()),d.fillStyle="rgb("+b+", "+b+", "+b+")",d.fillRect(a,this.height()-20,1,10);b=["black","white","gray"];for(a=0;a<b.length;a+=1)d.fillStyle=b[a],d.fillRect(a*this.width()/b.length,
this.height()-10,this.width()/b.length,10);for(a=2*this.width()/3;a<this.width();a+=2)for(b=this.height()-10;b<this.height();b+=2)0===(a+b)/2%2&&(d.fillStyle="#DDD",d.fillRect(a,b,2,2));this.image=c};PaintColorPickerMorph.prototype.mouseDownLeft=function(a){a.subtract(this.position()).x>2*this.width()/3&&a.subtract(this.position()).y>this.height()-10?this.action("transparent"):this.action(this.getPixelColor(a))};PaintColorPickerMorph.prototype.mouseMove=PaintColorPickerMorph.prototype.mouseDownLeft;
PaintCanvasMorph.prototype=new Morph;PaintCanvasMorph.prototype.constructor=PaintCanvasMorph;PaintCanvasMorph.uber=Morph.prototype;function PaintCanvasMorph(a){this.init(a)}
PaintCanvasMorph.prototype.init=function(a){this.rotationCenter=new Point(240,180);this.previousDragPoint=this.dragRect=null;this.currentTool="brush";this.dragRect=new Rectangle;this.mask=newCanvas(this.extent(),!0);this.paper=newCanvas(this.extent(),!0);this.erasermask=newCanvas(this.extent(),!0);this.background=newCanvas(this.extent());this.settings={primarycolor:new Color(0,0,0,255),secondarycolor:new Color(0,0,0,255),linewidth:3};this.brushBuffer=[];this.undoBuffer=[];this.isShiftPressed=a||function(){return 16===
this.world().currentKey};this.noticesTransparentClick=this.automaticCrosshairs=!0;this.buildContents()};PaintCanvasMorph.prototype.calculateCanvasCenter=function(a){a=Costume.prototype.canvasBoundingBox(a);return null===a?null:new Point((a.origin.x+a.corner.x)/2,(a.origin.y+a.corner.y)/2)};PaintCanvasMorph.prototype.updateAutomaticCenter=function(){if(this.automaticCrosshairs){var a=this.calculateCanvasCenter(this.paper);null!==a&&(this.rotationCenter=a)}};
PaintCanvasMorph.prototype.scale=function(a,b){this.updateAutomaticCenter();this.mask=newCanvas(this.extent(),!0);var c=newCanvas(this.extent(),!0);c.getContext("2d").save();c.getContext("2d").translate(this.rotationCenter.x,this.rotationCenter.y);c.getContext("2d").scale(1+a,1+b);c.getContext("2d").drawImage(this.paper,-this.rotationCenter.x,-this.rotationCenter.y);c.getContext("2d").restore();this.paper=c;this.drawNew();this.changed()};
PaintCanvasMorph.prototype.cacheUndo=function(){var a=newCanvas(this.extent(),!0);this.merge(this.paper,a);this.undoBuffer.push(a)};PaintCanvasMorph.prototype.undo=function(){0<this.undoBuffer.length&&(this.paper=newCanvas(this.extent(),!0),this.mask.width=this.mask.width+1-1,this.merge(this.undoBuffer.pop(),this.paper),this.drawNew(),this.changed())};PaintCanvasMorph.prototype.merge=function(a,b){b.getContext("2d").drawImage(a,0,0)};
PaintCanvasMorph.prototype.centermerge=function(a,b){b.getContext("2d").drawImage(a,(b.width-a.width)/2,(b.height-a.height)/2)};PaintCanvasMorph.prototype.clearCanvas=function(){this.buildContents();this.drawNew();this.changed()};PaintCanvasMorph.prototype.toolChanged=function(a){this.mask=newCanvas(this.extent(),!0);"crosshairs"===a&&(this.updateAutomaticCenter(),this.drawcrosshair());this.drawNew();this.changed()};
PaintCanvasMorph.prototype.drawcrosshair=function(a){a=a||this.mask.getContext("2d");var b=this.rotationCenter;a.lineWidth=1;a.strokeStyle="black";a.clearRect(0,0,this.mask.width,this.mask.height);a.globalAlpha=.5;a.fillStyle="white";a.beginPath();a.arc(b.x,b.y,20,radians(0),radians(360),!1);a.closePath();a.fill();a.stroke();a.beginPath();a.arc(b.x,b.y,10,radians(0),radians(360),!1);a.stroke();a.beginPath();a.moveTo(0,b.y);a.lineTo(this.mask.width,b.y);a.stroke();a.beginPath();a.moveTo(b.x,0);a.lineTo(b.x,
this.mask.height);a.stroke();this.drawNew();this.changed()};
PaintCanvasMorph.prototype.floodfill=function(a){var b=this.paper.width,c=this.paper.height,d=this.paper.getContext("2d"),e=d.getImageData(0,0,b,c),f=e.data;a=[Math.round(Math.round(a.y)*b+a.x)];var g=function(a){a*=4;return[f[a],f[a+1],f[a+2],f[a+3]]};var h=g(a[0]);var k=function(a){return a[0]===h[0]&&a[1]===h[1]&&a[2]===h[2]&&a[3]===h[3]};if(0!==h[3]||"transparent"!==this.settings.primarycolor)if(h[0]!==this.settings.primarycolor.r||h[1]!==this.settings.primarycolor.g||h[2]!==this.settings.primarycolor.b||
h[3]!==this.settings.primarycolor.a)if(0!==h[3]||0!==this.settings.primarycolor.a){for(;0<a.length;){var l=a.pop();k(g(l))&&(1<l%b&&(a.push(l+1),a.push(l-1)),0<l&&l<c*b&&(a.push(l+b),a.push(l-b)));"transparent"===this.settings.primarycolor?f[4*l+3]=0:(f[4*l]=this.settings.primarycolor.r,f[4*l+1]=this.settings.primarycolor.g,f[4*l+2]=this.settings.primarycolor.b,f[4*l+3]=255*this.settings.primarycolor.a)}d.putImageData(e,0,0);this.drawNew();this.changed()}};
PaintCanvasMorph.prototype.mouseDownLeft=function(a){this.cacheUndo();this.dragRect.origin=a.subtract(this.bounds.origin);this.dragRect.corner=a.subtract(this.bounds.origin);this.previousDragPoint=this.dragRect.corner.copy();if("crosshairs"===this.currentTool)this.rotationCenter=a.subtract(this.bounds.origin),this.drawcrosshair();else{if("paintbucket"===this.currentTool)return this.floodfill(a.subtract(this.bounds.origin));"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool&&
(this.erasermask=newCanvas(this.extent(),!0),this.merge(this.paper,this.erasermask))}};
PaintCanvasMorph.prototype.mouseMove=function(a){function b(){return l/Math.abs(l)*Math.max(Math.abs(l),Math.abs(m))}function c(){return m/Math.abs(m)*Math.max(Math.abs(l),Math.abs(m))}if("paintbucket"!==this.currentTool){a=a.subtract(this.bounds.origin);var d=this.mask.getContext("2d"),e=this.paper.getContext("2d"),f=this.dragRect.origin.x,g=this.dragRect.origin.y,h=a.x,k=a.y,l=(h-f)/2,m=(k-g)/2,n=this.paper.width;d.save();this.brushBuffer.push([h,k]);d.lineWidth=this.settings.linewidth;d.clearRect(0,
0,this.bounds.width(),this.bounds.height());this.dragRect.corner=a.subtract(this.dragRect.origin);"transparent"===this.settings.primarycolor&&"crosshairs"!==this.currentTool?(this.merge(this.erasermask,this.mask),e.clearRect(0,0,this.bounds.width(),this.bounds.height()),d.globalCompositeOperation="destination-out"):(d.fillStyle=this.settings.primarycolor.toString(),d.strokeStyle=this.settings.primarycolor.toString());switch(this.currentTool){case "rectangle":this.isShiftPressed()?d.strokeRect(f,g,
2*b(),2*c()):d.strokeRect(f,g,2*l,2*m);break;case "rectangleSolid":this.isShiftPressed()?d.fillRect(f,g,2*b(),2*c()):d.fillRect(f,g,2*l,2*m);break;case "brush":d.lineCap="round";d.lineJoin="round";d.beginPath();d.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]);for(e=0;e<this.brushBuffer.length;e+=1)d.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);d.stroke();break;case "line":d.beginPath();d.moveTo(f,g);this.isShiftPressed()?Math.abs(m)>Math.abs(l)?d.lineTo(f,k):d.lineTo(h,g):d.lineTo(h,
k);d.stroke();break;case "circle":case "circleSolid":d.beginPath();if(this.isShiftPressed())d.arc(f,g,(new Point(f,g)).distanceTo(new Point(h,k)),0,2*Math.PI,!1);else{for(e=0;e<n;e+=1)d.lineTo(e,2*m*Math.sqrt(2-Math.pow((e-f)/(2*l),2))+g);for(e=n;0<e;--e)d.lineTo(e,-2*m*Math.sqrt(2-Math.pow((e-f)/(2*l),2))+g)}d.closePath();"circleSolid"===this.currentTool?d.fill():"circle"===this.currentTool&&d.stroke();break;case "crosshairs":this.automaticCrosshairs=!1;this.rotationCenter=a.copy();this.drawcrosshair(d);
break;case "eraser":this.merge(this.paper,this.mask);d.save();d.globalCompositeOperation="destination-out";d.beginPath();d.moveTo(this.brushBuffer[0][0],this.brushBuffer[0][1]);for(e=0;e<this.brushBuffer.length;e+=1)d.lineTo(this.brushBuffer[e][0],this.brushBuffer[e][1]);d.stroke();d.restore();this.paper=newCanvas(this.extent(),!0);this.merge(this.mask,this.paper);break;default:nop()}this.previousDragPoint=a;this.drawNew();this.changed();d.restore()}};
PaintCanvasMorph.prototype.mouseClickLeft=function(){"crosshairs"!==this.currentTool&&this.merge(this.mask,this.paper);this.brushBuffer=[]};PaintCanvasMorph.prototype.mouseLeaveDragging=PaintCanvasMorph.prototype.mouseClickLeft;
PaintCanvasMorph.prototype.buildContents=function(){this.background=newCanvas(this.extent());this.paper=newCanvas(this.extent(),!0);this.mask=newCanvas(this.extent(),!0);this.erasermask=newCanvas(this.extent(),!0);var a,b,c=this.background.getContext("2d");for(a=0;a<this.background.width;a+=5)for(b=0;b<this.background.height;b+=5)c.fillStyle=1===(a+b)/5%2?"rgba(255, 255, 255, 1)":"rgba(255, 255, 255, 0.3)",c.fillRect(a,b,5,5)};
PaintCanvasMorph.prototype.drawNew=function(){var a=newCanvas(this.extent(),!0);this.merge(this.background,a);this.merge(this.paper,a);this.merge(this.mask,a);this.image=a;this.drawFrame()};
PaintCanvasMorph.prototype.drawFrame=function(){var a=this.image.getContext("2d");if(this.parent){this.color=this.parent.color.lighter(.75*this.contrast);var b=this.parent.color}else b=new Color(120,120,120);a.fillStyle=this.color.toString();this.cachedClr=b.toString();this.cachedClrBright=b.lighter(this.contrast).toString();this.cachedClrDark=b.darker(this.contrast).toString();this.drawRectBorder(a)};PaintCanvasMorph.prototype.drawRectBorder=InputFieldMorph.prototype.drawRectBorder;
PaintCanvasMorph.prototype.edge=InputFieldMorph.prototype.edge;PaintCanvasMorph.prototype.fontSize=InputFieldMorph.prototype.fontSize;PaintCanvasMorph.prototype.typeInPadding=InputFieldMorph.prototype.typeInPadding;PaintCanvasMorph.prototype.contrast=InputFieldMorph.prototype.contrast;modules.lists="2017-September-01";function List(a){this.type=null;this.contents=a||[];this.rest=this.first=null;this.isLinked=!1;this.lastChanged=Date.now()}List.prototype.enableTables=!1;List.prototype.toString=function(){return"a List ["+this.length+" elements]"};List.prototype.changed=function(){this.lastChanged=Date.now()};
List.prototype.cons=function(a,b){var c=new List;if(!(b instanceof List||isNil(b)))throw Error("cdr isn't a list: "+b);c.first=isNil(a)?null:a;c.rest=b||null;c.isLinked=!0;return c};List.prototype.cdr=function(){var a;if(this.isLinked)return this.rest||new List;if(2>this.contents.length)return new List;var b=new List;for(a=this.contents.length;1<a;--a)b=this.cons(this.at(a),b);return b};
List.prototype.add=function(a,b){b=b||this.length()+1;a=isNil(a)?null:a;this.becomeArray();this.contents.splice(b-1,0,a);this.changed()};List.prototype.put=function(a,b){a=0===a?0:!1===a?!1:a||null;this.becomeArray();this.contents[b-1]=a;this.changed()};List.prototype.remove=function(a){this.becomeArray();this.contents.splice(a-1,1);this.changed()};List.prototype.clear=function(){this.contents=[];this.rest=this.first=null;this.isLinked=!1;this.changed()};
List.prototype.length=function(){if(this.isLinked){for(var a=this,b=0;a&&a.isLinked;)b+=1,a=a.rest;return b+(a?a.contents.length:0)}return this.contents.length};List.prototype.at=function(a){a=+a;for(var b=this;b.isLinked;)if(1<a)b=b.rest,--a;else return b.first;a=b.contents[a-1];return isNil(a)?"":a};List.prototype.contains=function(a){for(var b=this;b.isLinked;){if(snapEquals(b.first,a))return!0;b=b.rest}return b.contents.some(function(b){return snapEquals(b,a)})};
List.prototype.isTable=function(){return this.enableTables&&(100<this.length()||1<this.cols())};List.prototype.get=function(a,b){if(!a)return b?b>this.rows()?null:this.rowName(b):[this.length()];if(!b)return 1===this.cols()?localize("items"):this.colName(a);var c=this.at(b);if(c instanceof List){b=c.length();var d=this.cols();return a>b?null:1===d&&1<b?[c]:a>=d&&b>d?new Variable(c.at(a)):c.at(a)}return 1===a&&b<=this.rows()?[c]:null};List.prototype.rows=function(){return this.length()};
List.prototype.cols=function(){var a=this.at(1);return a instanceof List?a.length():1};List.prototype.colName=function(a){return a>this.cols()?null:String.fromCharCode(64+(a%26||26)).repeat(Math.floor((a-1)/26)+1)};List.prototype.rowName=function(a){return a};List.prototype.columnNames=function(){return[]};List.prototype.version=function(a,b){b=Math.min(a+b,this.length());var c=this.lastChanged,d;for(d=a;d<=b;d+=1)a=this.at(d),c=Math.max(c,a.lastChanged?a.lastChanged:0);return c};
List.prototype.asArray=function(){this.becomeArray();return this.contents};List.prototype.itemsArray=function(){if(this.isLinked){for(var a=this,b=[],c;a&&a.isLinked;)b.push(a.first),a=a.rest;if(a)for(c=1;c<=a.contents.length;c+=1)b.push(a.at(c));return b}return this.contents};
List.prototype.asText=function(){for(var a="",b,c,d=this,e;d.isLinked;)c=d.first,c instanceof List?a=a.concat(c.asText()):(c=isNil(c)?"":c.toString(),a=a.concat(c)),d=d.rest;b=d.length();for(e=1;e<=b;e+=1)c=d.at(e),c instanceof List?a=a.concat(c.asText()):(c=isNil(c)?"":c.toString(),a=a.concat(c));return a};List.prototype.becomeArray=function(){this.isLinked&&(this.contents=this.itemsArray(),this.isLinked=!1,this.rest=this.first=null)};
List.prototype.becomeLinked=function(){var a,b=this;if(!this.isLinked){var c=this.length();for(a=0;a<c;a+=1)b.first=this.contents[a],a<c-1&&(b.rest=new List,b.isLinked=!0,b=b.rest);this.contents=[];this.isLinked=!0}};
List.prototype.equalTo=function(a){var b=this,c=a,d,e;if(!(a instanceof List))return!1;for(;b.isLinked&&c.isLinked;){if(!snapEquals(b.first,c.first))return!1;b=b.rest;c=c.rest}c.isLinked&&(a=c,c=b,b=a);for(d=0;b.isLinked;){if(!snapEquals(b.first,c.contents[d]))return!1;b=b.rest;d+=1}a=0;if(b.contents.length!==c.contents.length-d)return!1;for(e=b.contents.length;0<e;){--e;if(!snapEquals(b.contents[a],c.contents[d]))return!1;a+=1;d+=1}return!0};ListWatcherMorph.prototype=new BoxMorph;
ListWatcherMorph.prototype.constructor=ListWatcherMorph;ListWatcherMorph.uber=BoxMorph.prototype;ListWatcherMorph.prototype.cellColor=SpriteMorph.prototype.blockColor.lists;function ListWatcherMorph(a,b){this.init(a,b)}
ListWatcherMorph.prototype.init=function(a,b){var c=this;this.list=a||new List;this.start=1;this.range=100;this.lastUpdated=Date.now();this.lastCell=null;this.parentCell=b||null;this.label=new StringMorph(localize("length: ")+this.list.length(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255));this.label.mouseClickLeft=function(){c.startIndexMenu()};this.frame=new ScrollFrameMorph(null,10);this.frame.alpha=0;this.frame.acceptsDrops=
!1;this.frame.contents.acceptsDrops=!1;this.handle=new HandleMorph(this,80,70,3,3);this.handle.setExtent(new Point(13,13));this.arrow=new ArrowMorph("down",SyntaxElementMorph.prototype.fontSize);this.arrow.mouseClickLeft=function(){c.startIndexMenu()};this.arrow.setRight(this.handle.right());this.arrow.setBottom(this.handle.top());this.handle.add(this.arrow);this.plusButton=new PushButtonMorph(this.list,"add","+");this.plusButton.padding=0;this.plusButton.edge=0;this.plusButton.outlineColor=this.color;
this.plusButton.drawNew();this.plusButton.fixLayout();ListWatcherMorph.uber.init.call(this,SyntaxElementMorph.prototype.rounding,1.000001,new Color(120,120,120));this.color=new Color(220,220,220);this.isDraggable=!1;this.setExtent((new Point(80,70)).multiplyBy(SyntaxElementMorph.prototype.scale));this.add(this.label);this.add(this.frame);this.add(this.plusButton);this.add(this.handle);this.handle.drawNew();this.update();this.fixLayout()};
ListWatcherMorph.prototype.update=function(a){this.frame.contents.children.forEach(function(a){a instanceof CellMorph&&(a.contentsMorph instanceof ListWatcherMorph?a.contentsMorph.update():isSnapObject(a.contents)&&a.update())});if(this.lastUpdated===this.list.lastChanged&&!a)return null;this.updateLength(!0);this.start=Math.max(Math.min(this.start,Math.floor((this.list.length()-1)/this.range)*this.range+1),1);var b=Math.min(this.start+this.range-1,this.list.length());var c=Math.min(3*(b-this.start+
1),this.frame.contents.children.length);for(a=0;a<c;a+=3){var d=this.start+a/3;var e=this.frame.contents.children[a];var f=this.frame.contents.children[a+1];var g=this.frame.contents.children[a+2];var h=this.list.at(d);e.contents!==h&&(e.contents=h,e.drawNew(),this.lastCell&&e.setLeft(this.lastCell.left()));this.lastCell=e;f.text!==d.toString()&&(f.text=d.toString(),f.drawNew());g.action=d}for(a=3*(b-this.start+1);this.frame.contents.children.length>a;)this.frame.contents.children[a].destroy();c=
a;a=this.frame.contents.children.length;h=Date.now();if(c>a+1)for(a;a<c;a+=3){if(1E3<Date.now()-h)return this.fixLayout(),this.frame.contents.adjustBounds(),this.frame.contents.setLeft(this.frame.left()),null;d=this.start+a/3;f=new StringMorph(d.toString(),SyntaxElementMorph.prototype.fontSize,null,!1,!1,!1,MorphicPreferences.isFlat?new Point:new Point(1,1),new Color(255,255,255));e=new CellMorph(this.list.at(d),this.cellColor,d,this.parentCell);g=new PushButtonMorph(this.list.remove,d,"-",this.list);
g.padding=1;g.edge=0;g.corner=1;g.outlineColor=this.color.darker();g.drawNew();g.fixLayout();this.frame.contents.add(e);this.lastCell?e.setPosition(this.lastCell.bottomLeft()):e.setTop(this.frame.contents.top());this.lastCell=e;f.setCenter(e.center());f.setRight(e.left()-2);this.frame.contents.add(f);this.frame.contents.add(g)}this.lastCell=null;this.fixLayout();this.frame.contents.adjustBounds();this.frame.contents.setLeft(this.frame.left());this.updateLength();this.lastUpdated=this.list.lastChanged};
ListWatcherMorph.prototype.updateLength=function(a){this.label.text=localize("length: ")+this.list.length();this.label.color=a?new Color(0,0,100):new Color(0,0,0);this.label.drawNew();this.label.setCenter(this.center());this.label.setBottom(this.bottom()-3)};ListWatcherMorph.prototype.startIndexMenu=function(){var a,b=this,c=Math.ceil(this.list.length()/this.range),d=new MenuMorph(function(a){b.setStartIndex(a)},null,b);d.addItem("1...",1);for(a=1;a<c;a+=1){var e=100*a+1;d.addItem(e+"...",e)}d.popUpAtHand(this.world())};
ListWatcherMorph.prototype.setStartIndex=function(a){this.start=a;this.list.changed()};
ListWatcherMorph.prototype.fixLayout=function(){this.label&&(Morph.prototype.trackChanges=!1,this.frame&&(this.arrangeCells(),this.frame.silentSetPosition(this.position().add(3)),this.frame.bounds.corner=this.bounds.corner.subtract(new Point(3,17)),this.frame.drawNew(),this.frame.contents.adjustBounds()),this.label.setCenter(this.center()),this.label.setBottom(this.bottom()-3),this.plusButton.setLeft(this.left()+3),this.plusButton.setBottom(this.bottom()-3),Morph.prototype.trackChanges=!0,this.changed(),
this.parent&&this.parent.fixLayout&&this.parent.fixLayout())};ListWatcherMorph.prototype.arrangeCells=function(){var a,b=this.frame.contents.children.length;for(a=0;a<b;a+=3){var c=this.frame.contents.children[a];var d=this.frame.contents.children[a+1];var e=this.frame.contents.children[a+2];f&&c.setTop(f.bottom());d&&(d.setTop(c.center().y-d.height()/2),d.setRight(c.left()-2));e&&(e.setCenter(c.center()),e.setLeft(c.right()+2));var f=c}this.frame.contents.adjustBounds()};
ListWatcherMorph.prototype.expand=function(a){var b=this.frame.contents.extent();b=new Point(b.x+6,b.y+this.label.height()+6);a&&(b=b.min(a));this.setExtent(b);this.handle.setRight(this.right()-3);this.handle.setBottom(this.bottom()-3)};
ListWatcherMorph.prototype.userMenu=function(){if(!List.prototype.enableTables)return this.escalateEvent("userMenu");var a=new MenuMorph(this),b=this;a.addItem("table view...","showTableView");a.addLine();a.addItem("open in dialog...",function(){(new TableDialogMorph(b.list)).popUp(b.world())});return a};
ListWatcherMorph.prototype.showTableView=function(){var a=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);a&&(a instanceof SpriteBubbleMorph?(a.changed(),a.drawNew(!0)):a instanceof SpeechBubbleMorph?(a.contents=new TableFrameMorph(new TableMorph(this.list,10)),a.contents.expand(this.extent()),a.drawNew(!0)):(a.drawNew(!0,"table"),a.contentsMorph.expand(this.extent())),a.fixLayout())};
ListWatcherMorph.prototype.mouseDoubleClick=function(a){List.prototype.enableTables?(new TableDialogMorph(this.list)).popUp(this.world()):this.escalateEvent("mouseDoubleClick",a)};ListWatcherMorph.prototype.show=function(){ListWatcherMorph.uber.show.call(this);this.frame.contents.adjustBounds()};ListWatcherMorph.prototype.drawNew=function(){WatcherMorph.prototype.drawNew.call(this);this.fixLayout()};modules.byob="2017-October-09";function CustomBlockDefinition(a,b){this.body=null;this.scripts=[];this.category=null;this.isGlobal=!1;this.type="command";this.spec=a||"";this.declarations={};this.variableNames=[];this.codeHeader=this.codeMapping=this.comment=null;this.receiver=b||null;this.cachedIsRecursive=this.editorDimensions=null}
CustomBlockDefinition.prototype.blockInstance=function(){var a="command"===this.type?new CustomCommandBlockMorph(this):new CustomReporterBlockMorph(this,"predicate"===this.type);a.isDraggable=!0;return a};CustomBlockDefinition.prototype.templateInstance=function(){var a=this.blockInstance();a.refreshDefaults(this);a.isDraggable=!1;a.isTemplate=!0;return a};
CustomBlockDefinition.prototype.prototypeInstance=function(){var a,b=this;var c="command"===this.type?new CustomCommandBlockMorph(this,!0):new CustomReporterBlockMorph(this,"predicate"===this.type,!0);c.parts().forEach(function(c){c instanceof BlockInputFragmentMorph&&(a=b.declarations[c.fragment.labelString])&&(c.fragment.type=a[0],c.fragment.defaultValue=a[1],c.fragment.options=a[2],c.fragment.isReadOnly=a[3]||!1)});return c};
CustomBlockDefinition.prototype.copyAndBindTo=function(a,b){var c=copy(this);delete c[XML_Serializer.prototype.idProperty];c.receiver=a;c.declarations=copy(this.declarations);if(b)return c.body=null,c;c.body&&(c.body=Process.prototype.reify.call(null,this.body.expression,new List(this.inputNames())),c.body.outerContext=null);return c};
CustomBlockDefinition.prototype.blockSpec=function(){var a=this,b=[],c;this.parseSpec(this.spec).forEach(function(d){c="%"===d[0]&&1<d.length?a.typeOf(d.slice(1)):"$nl"===d?"%br":d;b.push(c);b.push(" ")});return"".concat.apply("",b).trim()};CustomBlockDefinition.prototype.helpSpec=function(){var a=[];this.parseSpec(this.spec).forEach(function(b){"%"!==b[0]&&a.push(b)});return"".concat.apply("",a).replace(/\?/g,"")};
CustomBlockDefinition.prototype.typeOf=function(a){return this.declarations[a]?this.declarations[a][0]:"%s"};CustomBlockDefinition.prototype.defaultValueOf=function(a){return this.declarations[a]?this.declarations[a][1]:""};CustomBlockDefinition.prototype.defaultValueOfInputIdx=function(a){a=this.inputNames()[a];return this.defaultValueOf(a)};CustomBlockDefinition.prototype.dropDownMenuOfInputIdx=function(a){a=this.inputNames()[a];return this.dropDownMenuOf(a)};
CustomBlockDefinition.prototype.isReadOnlyInputIdx=function(a){a=this.inputNames()[a];return this.isReadOnlyInput(a)};CustomBlockDefinition.prototype.inputOptionsOfIdx=function(a){a=this.inputNames()[a];return this.inputOptionsOf(a)};CustomBlockDefinition.prototype.dropDownMenuOf=function(a){return this.declarations[a]&&this.declarations[a][2]?this.parseChoices(this.declarations[a][2]):null};
CustomBlockDefinition.prototype.parseChoices=function(a){var b={},c=[b];a.split("\n").forEach(function(a){a=a.split("=");"}"===a[0]?(c.pop(),b=c[c.length-1]):"{"===a[1]?(b={},c[c.length-1][a[0]]=b,c.push(b)):b[a[0]]=isNil(a[1])?a[0]:a[1]});return b};CustomBlockDefinition.prototype.isReadOnlyInput=function(a){return this.declarations[a]&&!0===this.declarations[a][3]};CustomBlockDefinition.prototype.inputOptionsOf=function(a){return[this.dropDownMenuOf(a),this.isReadOnlyInput(a)]};
CustomBlockDefinition.prototype.inputNames=function(){var a=[];this.parseSpec(this.spec).forEach(function(b){"%"===b[0]&&1<b.length&&a.push(b.slice(1))});return a};CustomBlockDefinition.prototype.parseSpec=function(a){var b=[],c="",d,e=!1;for(d=0;d<a.length;d+=1){var f=a[d];"'"===f?e=!e:" "!==f||e?c=c.concat(f):(b.push(c),c="")}b.push(c);return b};
CustomBlockDefinition.prototype.isDirectlyRecursive=function(){if(null!==this.cachedIsRecursive)return this.cachedIsRecursive;if(this.body){var a=this.blockSpec();this.cachedIsRecursive=this.body.expression.anyChild(function(b){return b.isCustomBlock&&b.blockSpec===a})}else this.cachedIsRecursive=!1;return this.cachedIsRecursive};CustomBlockDefinition.prototype.scriptsPicture=function(){return this.scriptsModel().scriptsPicture()};CustomBlockDefinition.prototype.sortedElements=function(){return this.scriptsModel().sortedElements()};
CustomBlockDefinition.prototype.scriptsModel=function(){var a;var b=new ScriptsMorph;b.cleanUpMargin=10;var c=new PrototypeHatBlockMorph(this);c.setPosition(b.position().add(10));if(null!==this.comment){var d=this.comment.fullCopy();c.comment=d;d.block=c}null!==this.body&&c.nextBlock(this.body.expression.fullCopy());b.add(c);c.fixBlockColor(null,!0);this.scripts.forEach(function(c){a=c.fullCopy();a.setPosition(b.position().add(c.position()));b.add(a);a instanceof BlockMorph&&a.allComments().forEach(function(b){b.align(a)})});
c.allComments().forEach(function(a){a.align(c)});d=c.parts()[0];d.fixLayout();d.forceNormalColoring();d.fixBlockColor(c,!0);b.fixMultiArgs();return b};CustomBlockDefinition.prototype.purgeCorpses=function(){this.body&&this.body.expression.isCorpse&&(this.body=null);this.scripts=this.scripts.filter(function(a){return!a.isCorpse})};CustomCommandBlockMorph.prototype=new CommandBlockMorph;CustomCommandBlockMorph.prototype.constructor=CustomCommandBlockMorph;CustomCommandBlockMorph.uber=CommandBlockMorph.prototype;
CustomCommandBlockMorph.prototype.isCustomBlock=!0;function CustomCommandBlockMorph(a,b){this.init(a,b)}CustomCommandBlockMorph.prototype.init=function(a,b){this.isGlobal=(this.definition=a)?a.isGlobal:!1;this.isPrototype=b||!1;CustomCommandBlockMorph.uber.init.call(this,!0);this.category=a.category;this.selector="evaluateCustomBlock";this.variables=null;this.initializeVariables();a&&this.refresh()};
CustomCommandBlockMorph.prototype.initializeVariables=function(a){var b=this;this.variables=new VariableFrame;this.isGlobal&&this.definition.variableNames.forEach(function(c){var d=a?a[c]:null;b.variables.addVar(c,d instanceof Variable?d.value:null)})};
CustomCommandBlockMorph.prototype.refresh=function(a,b){var c=a||this.definition;a=this.isPrototype?c.spec:c.blockSpec();this.isGlobal||this.isPrototype||(this.definition=null);this.setCategory(c.category);if(this.blockSpec!==a){var d=this.inputs();this.zebraContrast?this.fixBlockColor():this.forceNormalColoring();this.setSpec(a,b,c);this.fixLabelColor();this.restoreInputs(d)}else this.inputs().forEach(function(a,b){a instanceof InputSlotMorph&&a.setChoices.apply(a,c.inputOptionsOfIdx(b))});this.cachedInputs=
null;this.inputs().forEach(function(a,b){a instanceof TemplateSlotMorph&&"\u2191"===a.contents()&&a.setContents(c.inputNames()[b])});this.isGlobal&&this.initializeVariables(this.variables.vars);this.forceNormalColoring();this.drawNew();this.fixBlockColor(null,!0)};
CustomCommandBlockMorph.prototype.restoreInputs=function(a){var b=0,c,d=this;this.isPrototype||(this.cachedInputs=null,this.inputs().forEach(function(e){c=a[b];c instanceof ReporterBlockMorph&&!(e instanceof TemplateSlotMorph)?d.silentReplaceInput(e,c.fullCopy()):c instanceof InputSlotMorph&&e instanceof InputSlotMorph?e.setContents(c.evaluate()):c instanceof TemplateSlotMorph&&e instanceof TemplateSlotMorph?e.setContents(c.evaluate()):c instanceof CSlotMorph&&e instanceof CSlotMorph&&e.nestedBlock(c.evaluate());
b+=1}),this.cachedInputs=null)};CustomCommandBlockMorph.prototype.refreshDefaults=function(a){var b=0,c=this;this.inputs().forEach(function(d){(d instanceof InputSlotMorph||d instanceof BooleanSlotMorph)&&d.setContents((a||c.definition).defaultValueOfInputIdx(b));b+=1});this.cachedInputs=null};
CustomCommandBlockMorph.prototype.refreshPrototype=function(){var a=[],b=this,c,d,e=0;if(!this.isPrototype)return null;var f=this.parentThatIsA(PrototypeHatBlockMorph);this.parts().forEach(function(e){e.fragment.isDeleted||(e.fragment.type?a.push(e.fragment):(c=b.definition.parseSpec(e.fragment.labelString),c.forEach(function(b){d=e.fragment.copy();d.labelString=b;a.push(d)})))});var g=this.specFromFragments();this instanceof CustomCommandBlockMorph&&("reporter"===f.type||"predicate"===f.type)?(b=
new CustomReporterBlockMorph(this.definition,"predicate"===f.type,!0),f.silentReplaceInput(this,b)):this instanceof CustomReporterBlockMorph&&("command"===f.type?(b=new CustomCommandBlockMorph(this.definition,!0),f.silentReplaceInput(this,b)):(this.isPredicate="predicate"===f.type,this.drawNew()));b.setCategory(f.blockCategory||"other");f.fixBlockColor();b.setSpec(g);b.parts().forEach(function(b){b instanceof BlockLabelPlaceHolderMorph||(a[e]&&(b.fragment=a[e]),e+=1)});this.refreshPrototypeSlotTypes();
f.fixLayout()};CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes=function(){this.parts().forEach(function(a){a instanceof BlockInputFragmentMorph&&(a.template().instantiationSpec=a.contents(),a.setContents(a.fragment.defTemplateSpecFragment()))});this.fixBlockColor(null,!0)};CustomCommandBlockMorph.prototype.inputFragmentNames=function(){var a=[];this.parts().forEach(function(b){!b.fragment.isDeleted&&b.fragment.type&&a.push(b.fragment.labelString)});return a};
CustomCommandBlockMorph.prototype.upvarFragmentNames=function(){var a=[];this.parts().forEach(function(b){b.fragment.isDeleted||"%upvar"!==b.fragment.type||a.push(b.fragment.labelString)});return a};CustomCommandBlockMorph.prototype.upvarFragmentName=function(a){return this.upvarFragmentNames()[a]||"\u2191"};CustomCommandBlockMorph.prototype.specFromFragments=function(){var a="";this.parts().forEach(function(b){b.fragment.isDeleted||(a=a+b.fragment.defSpecFragment()+" ")});return a.trim()};
CustomCommandBlockMorph.prototype.blockSpecFromFragments=function(){var a="";this.parts().forEach(function(b){b.fragment.isDeleted||(a=a+b.fragment.blockSpecFragment()+" ")});return a.trim()};CustomCommandBlockMorph.prototype.declarationsFromFragments=function(){var a={};this.parts().forEach(function(b){b instanceof BlockInputFragmentMorph&&(a[b.fragment.labelString]=[b.fragment.type,b.fragment.defaultValue,b.fragment.options,b.fragment.isReadOnly])});return a};
CustomCommandBlockMorph.prototype.parseSpec=function(a){return this.isPrototype?CustomBlockDefinition.prototype.parseSpec(a):CustomCommandBlockMorph.uber.parseSpec.call(this,a)};CustomCommandBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomCommandBlockMorph.uber.mouseClickLeft.call(this);this.edit()};
CustomCommandBlockMorph.prototype.edit=function(){var a=this,b=this.definition;if(this.isPrototype){b=this.definition.blockInstance();b.addShadow();var c=this.parentThatIsA(PrototypeHatBlockMorph);(new BlockDialogMorph(null,function(b){b&&(c.blockCategory=b.category,c.type=b.type,a.refreshPrototype())},a)).openForChange("Change block",c.blockCategory,c.type,a.world(),b.fullImage(),a.isInUse())}else{var d=this.scriptTarget();if(!this.isGlobal){if(contains(Object.keys(d.inheritedBlocks()),this.blockSpec)){this.duplicateBlockDefinition();
return}b=d.getMethod(this.blockSpec)}Morph.prototype.trackChanges=!1;b=new BlockEditorMorph(b,d);b.popUp();Morph.prototype.trackChanges=!0;b.changed()}};
CustomCommandBlockMorph.prototype.labelPart=function(a){if(!this.isPrototype)return CustomCommandBlockMorph.uber.labelPart.call(this,a);"%"===a[0]&&1<a.length?a=new BlockInputFragmentMorph(a.replace(/%/g,"")):(a=new BlockLabelFragmentMorph(a),a.fontSize=this.fontSize,a.color=new Color(255,255,255),a.isBold=!0,a.shadowColor=this.color.darker(this.labelContrast),a.shadowOffset=this.embossing,a.drawNew());return a};
CustomCommandBlockMorph.prototype.placeHolder=function(){var a=new BlockLabelPlaceHolderMorph;a.fontSize=1.4*this.fontSize;a.color=new Color(45,45,45);a.drawNew();return a};CustomCommandBlockMorph.prototype.attachTargets=function(){return this.isPrototype?[]:CustomCommandBlockMorph.uber.attachTargets.call(this)};
CustomCommandBlockMorph.prototype.isInUse=function(){var a=this.definition,b=this.scriptTarget(),c=b.parentThatIsA(IDE_Morph);return a.isGlobal&&c?c.sprites.asArray().concat([c.stage]).some(function(b,c){return b.usesBlockInstance(a,!1,c)}):0<b.allDependentInvocationsOf(this.blockSpec).length};
CustomCommandBlockMorph.prototype.userMenu=function(){function a(a,b,c,d,e){g.addItem((c?"\u2611 ":"\u2610 ")+localize(a),b,c?d:e)}function b(a){var b=d.parentThatIsA(StageMorph),c=e.variables;g.addItem(a+"...",function(){var d=detect(b.children,function(b){return b instanceof WatcherMorph&&b.target===c&&b.getter===a});if(null!==d)d.show();else{d=new WatcherMorph(a+" "+localize("(temporary)"),SpriteMorph.prototype.blockColor.variables,c,a);d.setPosition(b.position().add(10));var e=b.watchers(d.left());
0<e.length&&d.setTop(e[e.length-1].bottom());b.add(d)}d.fixLayout()})}var c=this.parentThatIsA(PrototypeHatBlockMorph),d=this.scriptTarget(),e=this,f=16===this.world().currentKey;if(this.isPrototype){var g=new MenuMorph(this);g.addItem("script pic...",function(){var a=this.world().children[0];a.saveCanvasAs(this.topBlock().scriptPic(),(a.projectName||localize("untitled"))+" "+localize("script pic"))},"open a new window\nwith a picture of this script");this.isGlobal&&(2>c.inputs().length?g.addItem("block variables...",
function(){c.enableBlockVars()},"experimental -\nunder construction"):g.addItem("remove block variables...",function(){c.enableBlockVars(!1)},"experimental -\nunder construction"))}else(g=this.constructor.uber.userMenu.call(this))?g.addLine():g=new MenuMorph(this),f&&g.addItem("duplicate block definition...","duplicateBlockDefinition",null,new Color(100,0,0)),this.isTemplate?this.isGlobal?g.addItem("delete block definition...","deleteBlockDefinition"):contains(Object.keys(d.inheritedBlocks()),this.blockSpec)?
a("inherited",function(){var a=e.parentThatIsA(IDE_Morph);d.customBlocks.push(d.getMethod(e.blockSpec).copyAndBindTo(d));a&&(a.flushPaletteCache(),a.refreshPalette())},!0,"uncheck to\ndisinherit",null):d.exemplar&&d.exemplar.getMethod(this.blockSpec)?a("inherited","deleteBlockDefinition",!1,null,localize("check to inherit\nfrom")+" "+d.exemplar.name):g.addItem("delete block definition...","deleteBlockDefinition"):(this.isGlobal||contains(Object.keys(d.ownBlocks()),this.blockSpec))&&g.addItem("delete block definition...",
"deleteBlockDefinition"),this.variables.names().forEach(function(a){b(a)});g.addItem("edit...","edit");return g};CustomCommandBlockMorph.prototype.exportBlockDefinition=function(){var a=(new SnapSerializer).serialize(this.definition);this.parentThatIsA(IDE_Morph).saveXMLAs(a,this.spec)};
CustomCommandBlockMorph.prototype.duplicateBlockDefinition=function(){var a=this.scriptTarget(),b=this.parentThatIsA(IDE_Morph),c=(this.isGlobal?this.definition:a.getMethod(this.blockSpec)).copyAndBindTo(a);this.isGlobal?b.stage.globalBlocks.push(c):a.customBlocks.push(c);b.flushPaletteCache();b.refreshPalette();(new BlockEditorMorph(c,a)).popUp()};
CustomCommandBlockMorph.prototype.deleteBlockDefinition=function(){var a,b,c,d=this.scriptTarget(),e=this;if(this.isPrototype)return null;var f=this.isGlobal?this.definition:d.getLocalMethod(this.blockSpec);var g=f.blockInstance();g.addShadow();(new DialogBoxMorph(this,function(){d.deleteAllBlockInstances(f);f.isGlobal?(b=d.parentThatIsA(StageMorph),a=b.globalBlocks.indexOf(f),-1!==a&&b.globalBlocks.splice(a,1)):(a=d.customBlocks.indexOf(f),-1!==a&&d.customBlocks.splice(a,1),(f=d.getMethod(e.blockSpec))&&
d.allDependentInvocationsOf(e.blockSpec).forEach(function(a){a.refresh(f)}));if(c=d.parentThatIsA(IDE_Morph))c.flushPaletteCache(),c.refreshPalette()},this)).askYesNo("Delete Custom Block",localize("block deletion dialog text"),e.world(),g.fullImage())};
CustomCommandBlockMorph.prototype.relabel=function(a){var b=new MenuMorph(this),c=this.inputs().map(function(a){return a.fullCopy()}),d=this;a.forEach(function(a){var e=a.blockInstance();e.restoreInputs(c);e.fixBlockColor(null,!0);e.addShadow(new Point(3,3));b.addItem(e,function(){d.definition=a;d.refresh()})});b.popup(this.world(),this.bottomLeft().subtract(new Point(8,this instanceof CommandBlockMorph?this.corner:0)))};
CustomCommandBlockMorph.prototype.alternatives=function(){var a=this.scriptTarget(),b=a.parentThatIsA(StageMorph);a=a.customBlocks.concat(b.globalBlocks);var c=this instanceof CommandBlockMorph?"command":this.isPredicate?"predicate":"reporter",d=this;return a.filter(function(a){return a!==d.definition&&a.type===c})};CustomReporterBlockMorph.prototype=new ReporterBlockMorph;CustomReporterBlockMorph.prototype.constructor=CustomReporterBlockMorph;CustomReporterBlockMorph.uber=ReporterBlockMorph.prototype;
CustomReporterBlockMorph.prototype.isCustomBlock=!0;function CustomReporterBlockMorph(a,b,c){this.init(a,b,c)}CustomReporterBlockMorph.prototype.init=function(a,b,c){this.isGlobal=(this.definition=a)?a.isGlobal:!1;this.isPrototype=c||!1;CustomReporterBlockMorph.uber.init.call(this,b,!0);this.category=a.category;this.variables=new VariableFrame;this.initializeVariables();this.selector="evaluateCustomBlock";a&&this.refresh()};CustomReporterBlockMorph.prototype.initializeVariables=CustomCommandBlockMorph.prototype.initializeVariables;
CustomReporterBlockMorph.prototype.refresh=function(a){var b=a||this.definition;CustomCommandBlockMorph.prototype.refresh.call(this,a,!0);this.isPrototype||(this.isPredicate="predicate"===b.type);this.parent instanceof SyntaxElementMorph&&(this.parent.cachedInputs=null);this.drawNew()};CustomReporterBlockMorph.prototype.mouseClickLeft=function(){if(!this.isPrototype)return CustomReporterBlockMorph.uber.mouseClickLeft.call(this);this.edit()};CustomReporterBlockMorph.prototype.placeHolder=CustomCommandBlockMorph.prototype.placeHolder;
CustomReporterBlockMorph.prototype.parseSpec=CustomCommandBlockMorph.prototype.parseSpec;CustomReporterBlockMorph.prototype.edit=CustomCommandBlockMorph.prototype.edit;CustomReporterBlockMorph.prototype.labelPart=CustomCommandBlockMorph.prototype.labelPart;CustomReporterBlockMorph.prototype.upvarFragmentNames=CustomCommandBlockMorph.prototype.upvarFragmentNames;CustomReporterBlockMorph.prototype.upvarFragmentName=CustomCommandBlockMorph.prototype.upvarFragmentName;
CustomReporterBlockMorph.prototype.inputFragmentNames=CustomCommandBlockMorph.prototype.inputFragmentNames;CustomReporterBlockMorph.prototype.specFromFragments=CustomCommandBlockMorph.prototype.specFromFragments;CustomReporterBlockMorph.prototype.blockSpecFromFragments=CustomCommandBlockMorph.prototype.blockSpecFromFragments;CustomReporterBlockMorph.prototype.declarationsFromFragments=CustomCommandBlockMorph.prototype.declarationsFromFragments;CustomReporterBlockMorph.prototype.refreshPrototype=CustomCommandBlockMorph.prototype.refreshPrototype;
CustomReporterBlockMorph.prototype.refreshPrototypeSlotTypes=CustomCommandBlockMorph.prototype.refreshPrototypeSlotTypes;CustomReporterBlockMorph.prototype.restoreInputs=CustomCommandBlockMorph.prototype.restoreInputs;CustomReporterBlockMorph.prototype.refreshDefaults=CustomCommandBlockMorph.prototype.refreshDefaults;CustomReporterBlockMorph.prototype.isInUse=CustomCommandBlockMorph.prototype.isInUse;CustomReporterBlockMorph.prototype.userMenu=CustomCommandBlockMorph.prototype.userMenu;
CustomReporterBlockMorph.prototype.duplicateBlockDefinition=CustomCommandBlockMorph.prototype.duplicateBlockDefinition;CustomReporterBlockMorph.prototype.deleteBlockDefinition=CustomCommandBlockMorph.prototype.deleteBlockDefinition;CustomReporterBlockMorph.prototype.bubbleHelp=CustomCommandBlockMorph.prototype.bubbleHelp;CustomReporterBlockMorph.prototype.popUpbubbleHelp=CustomCommandBlockMorph.prototype.popUpbubbleHelp;CustomReporterBlockMorph.prototype.relabel=CustomCommandBlockMorph.prototype.relabel;
CustomReporterBlockMorph.prototype.alternatives=CustomCommandBlockMorph.prototype.alternatives;JaggedBlockMorph.prototype=new ReporterBlockMorph;JaggedBlockMorph.prototype.constructor=JaggedBlockMorph;JaggedBlockMorph.uber=ReporterBlockMorph.prototype;JaggedBlockMorph.prototype.jag=5;function JaggedBlockMorph(a){this.init(a)}JaggedBlockMorph.prototype.init=function(a){JaggedBlockMorph.uber.init.call(this);a&&this.setSpec(a);"%cs"===a&&(this.minWidth=25,this.fixLayout())};
JaggedBlockMorph.prototype.drawNew=function(){this.cachedClr=this.color.toString();this.cachedClrBright=this.bright();this.cachedClrDark=this.dark();this.image=newCanvas(this.extent());var a=this.image.getContext("2d");a.fillStyle=this.cachedClr;this.drawBackground(a);MorphicPreferences.isFlat||this.drawEdges(a);this.eraseHoles(a)};
JaggedBlockMorph.prototype.drawBackground=function(a){var b=this.width(),c=this.height(),d=Math.round(c/this.jag),e=c/d,f,g;a.fillStyle=this.cachedClr;a.beginPath();a.moveTo(0,0);a.lineTo(b,0);for(f=g=0;f<d;f+=1)g+=e/2,a.lineTo(b-this.jag/2,g),g+=e/2,a.lineTo(b,g);a.lineTo(0,c);g=c;for(f=0;f<d;f+=1)g-=e/2,a.lineTo(this.jag/2,g),g-=e/2,a.lineTo(0,g);a.closePath();a.fill()};
JaggedBlockMorph.prototype.drawEdges=function(a){var b=this.width(),c=this.height(),d=Math.round(c/this.jag),e=c/d,f=this.edge/2,g;a.lineWidth=this.edge;a.lineJoin="round";a.lineCap="round";var h=a.createLinearGradient(0,0,0,this.edge);h.addColorStop(0,this.cachedClrBright);h.addColorStop(1,this.cachedClr);a.strokeStyle=h;a.beginPath();a.moveTo(f,f);a.lineTo(b-f,f);a.stroke();for(h=g=0;h<d;h+=1)a.strokeStyle=this.cachedClrDark,a.beginPath(),a.moveTo(b-f,g),g+=e/2,a.lineTo(b-this.jag/2-f,g),a.stroke(),
g+=e/2;h=a.createLinearGradient(0,c-this.edge,0,c);h.addColorStop(0,this.cachedClr);h.addColorStop(1,this.cachedClrDark);a.strokeStyle=h;a.beginPath();a.moveTo(b-f,c-f);a.lineTo(f,c-f);a.stroke();g=c;for(h=0;h<d;h+=1)a.strokeStyle=this.cachedClrBright,a.beginPath(),a.moveTo(f,g),g-=e/2,a.lineTo(this.jag/2+f,g),a.stroke(),g-=e/2};BlockDialogMorph.prototype=new DialogBoxMorph;BlockDialogMorph.prototype.constructor=BlockDialogMorph;BlockDialogMorph.uber=DialogBoxMorph.prototype;
function BlockDialogMorph(a,b,c){this.init(a,b,c)}
BlockDialogMorph.prototype.init=function(a,b,c){this.blockType="command";this.category="other";this.isGlobal=!0;this.categories=this.types=null;BlockDialogMorph.uber.init.call(this,a,b,c);this.key="makeABlock";this.types=new AlignmentMorph("row",this.padding);this.add(this.types);this.scopes=new AlignmentMorph("row",this.padding);this.add(this.scopes);this.categories=new BoxMorph;this.categories.color=SpriteMorph.prototype.paletteColor.lighter(8);this.categories.borderColor=this.categories.color.lighter(40);
this.createCategoryButtons();this.fixCategoriesLayout();this.add(this.categories);this.createTypeButtons();this.createScopeButtons();this.fixLayout()};
BlockDialogMorph.prototype.openForChange=function(a,b,c,d,e,f){var g=SpriteMorph.prototype.blockColor[b];this.key="changeABlock";this.category=b;this.blockType=c;this.categories.children.forEach(function(a){a.refresh()});this.types.children.forEach(function(a){a.setColor(g);a.refresh()});this.labelString=a;this.createLabel();e&&this.setPicture(e);this.addButton("ok","OK");this.addButton("cancel","Cancel");f&&(this.types.destroy(),this.types=null);this.scopes.destroy();this.scopes=null;this.fixLayout();
this.drawNew();this.popUp(d)};BlockDialogMorph.prototype.createCategoryButtons=function(){var a=this,b=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;SpriteMorph.prototype.categories.forEach(function(b){a.addCategoryButton(b)});Morph.prototype.trackChanges=b};
BlockDialogMorph.prototype.addCategoryButton=function(a){var b=this,c=[SpriteMorph.prototype.paletteColor,SpriteMorph.prototype.paletteColor.darker(50),SpriteMorph.prototype.blockColor[a]];var d=new ToggleButtonMorph(c,this,function(){b.category=a;b.categories.children.forEach(function(a){a.refresh()});b.types&&b.types.children.forEach(function(a){a.setColor(c[2])});b.edit()},a[0].toUpperCase().concat(a.slice(1)),function(){return b.category===a},null,null,null,75,!0);d.corner=8;d.padding=0;d.labelShadowOffset=
new Point(-1,-1);d.labelShadowColor=c[1];d.labelColor=IDE_Morph.prototype.buttonLabelColor;d.contrast=this.buttonContrast;d.fixLayout();d.refresh();this.categories.add(d);return d};
BlockDialogMorph.prototype.fixCategoriesLayout=function(){var a=this.categories.children[0].width(),b=this.categories.children[0].height(),c=Math.ceil(this.categories.children.length/2),d=this.categories.left(),e=this.categories.top(),f=0,g,h,k=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.categories.children.forEach(function(c){f+=1;g=Math.ceil(f/2);h=2-f%2;c.setPosition(new Point(d+(15*h+(h-1)*a),e+(2*g+(g-1)*b+10)))});MorphicPreferences.isFlat&&(this.categories.corner=0,this.categories.border=
0,this.categories.edge=0);this.categories.setExtent(new Point(45+2*a,2*(c+1)+c*b+20));Morph.prototype.trackChanges=k;this.categories.changed()};
BlockDialogMorph.prototype.createTypeButtons=function(){var a=this,b=SpriteMorph.prototype.blockColor[this.category];var c=new CommandBlockMorph;c.setColor(b);c.setSpec(localize("Command"));this.addBlockTypeButton(function(){a.setType("command")},c,function(){return"command"===a.blockType});c=new ReporterBlockMorph;c.setColor(b);c.setSpec(localize("Reporter"));this.addBlockTypeButton(function(){a.setType("reporter")},c,function(){return"reporter"===a.blockType});c=new ReporterBlockMorph(!0);c.setColor(b);
c.setSpec(localize("Predicate"));this.addBlockTypeButton(function(){a.setType("predicate")},c,function(){return"predicate"===a.blockType})};BlockDialogMorph.prototype.addBlockTypeButton=function(a,b,c){a=new ToggleElementMorph(this,a,b,c,null,null,"rebuild");a.refresh();this.types.add(a);return a};
BlockDialogMorph.prototype.addTypeButton=function(a,b,c){a=new ToggleMorph("radiobutton",this,a,b,c);a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.contrast=this.buttonContrast;a.drawNew();a.fixLayout();this.types.add(a);return a};BlockDialogMorph.prototype.setType=function(a){this.blockType=a||this.blockType;this.types.children.forEach(function(a){a.refresh()});this.edit()};
BlockDialogMorph.prototype.createScopeButtons=function(){var a=this;this.addScopeButton(function(){a.setScope("global")},"for all sprites",function(){return a.isGlobal});this.addScopeButton(function(){a.setScope("local")},"for this sprite only",function(){return!a.isGlobal})};
BlockDialogMorph.prototype.addScopeButton=function(a,b,c){a=new ToggleMorph("radiobutton",this,a,b,c);a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.contrast=this.buttonContrast;a.drawNew();a.fixLayout();this.scopes.add(a);return a};BlockDialogMorph.prototype.setScope=function(a){this.isGlobal="global"===a;this.scopes.children.forEach(function(a){a.refresh()});this.edit()};
BlockDialogMorph.prototype.getInput=function(){var a;this.body instanceof InputFieldMorph&&(a=this.normalizeSpaces(this.body.getValue()));a=new CustomBlockDefinition(a);a.type=this.blockType;a.category=this.category;a.isGlobal=this.isGlobal;if("reporter"===a.type||"predicate"===a.type){var b=Process.prototype.reify.call(null,SpriteMorph.prototype.blockForSelector("doReport"),new List,!0);b.outerContext=null;a.body=b}return a};
BlockDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body?(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+a),this.categories&&(this.categories.setCenter(this.body.center()),this.categories.setTop(this.body.top()),this.body.setTop(this.categories.bottom()+this.padding),this.silentSetHeight(this.height()+
this.categories.height()+this.padding))):this.head&&(this.types?(this.types.fixLayout(),this.silentSetWidth(Math.max(this.types.width(),this.head.width())+2*this.padding)):this.silentSetWidth(Math.max(this.categories.width(),this.head.width())+2*this.padding),this.head.setCenter(this.center()),this.head.setTop(a+this.padding),this.silentSetHeight(this.head.height()+2*this.padding+a),this.categories&&(this.categories.setCenter(this.center()),this.categories.setTop(this.head.bottom()+this.padding),
this.silentSetHeight(this.height()+this.categories.height()+this.padding)));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+
this.padding));this.scopes&&(this.scopes.fixLayout(),this.silentSetHeight(this.height()+this.scopes.height()+this.padding/3),this.silentSetWidth(Math.max(this.width(),this.scopes.width()+2*this.padding)),this.scopes.setCenter(this.center()),this.types&&this.scopes.setTop(this.types.bottom()+this.padding/3));this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-
this.padding))};BlockDialogMorph.prototype.accept=function(){this.body instanceof InputFieldMorph&&""===this.normalizeSpaces(this.body.getValue())?this.edit():BlockDialogMorph.uber.accept.call(this)};BlockEditorMorph.prototype=new DialogBoxMorph;BlockEditorMorph.prototype.constructor=BlockEditorMorph;BlockEditorMorph.uber=DialogBoxMorph.prototype;function BlockEditorMorph(a,b){this.init(a,b)}
BlockEditorMorph.prototype.init=function(a,b){var c=this,d=Process.prototype.enableLiveCoding||Process.prototype.enableSingleStepping;this.definition=a;this.handle=null;BlockEditorMorph.uber.init.call(this,b,function(){c.updateDefinition()},b);this.key="editBlock"+a.spec;this.labelString=this.definition.isGlobal?"Block Editor":"Method Editor";this.createLabel();var e=new ScriptsMorph;e.rejectsHats=!0;e.isDraggable=!1;e.color=IDE_Morph.prototype.groupColor;e.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture;
e.cleanUpMargin=10;var f=new PrototypeHatBlockMorph(this.definition);f.setPosition(e.position().add(10));null!==a.comment&&(b=a.comment.fullCopy(),f.comment=b,b.block=f);null!==a.body&&f.nextBlock(d?a.body.expression:a.body.expression.fullCopy());e.add(f);f.fixBlockColor(null,!0);f.drawNew();this.definition.scripts.forEach(function(a){g=a.fullCopy();g.setPosition(e.position().add(a.position()));e.add(g);g instanceof BlockMorph&&g.allComments().forEach(function(a){a.align(g)})});f.allComments().forEach(function(a){a.align(f)});
a=new ScrollFrameMorph(e);a.padding=10;a.growth=50;a.isDraggable=!1;a.acceptsDrops=!1;a.contents.acceptsDrops=!0;e.scrollFrame=a;e.updateToolbar();this.addBody(a);this.addButton("ok","OK");d||(this.addButton("updateDefinition","Apply"),this.addButton("cancel","Cancel"));this.setExtent(new Point(375,300));this.fixLayout();e.fixMultiArgs();var g=f.parts()[0];g.forceNormalColoring();g.fixBlockColor(f,!0)};
BlockEditorMorph.prototype.popUp=function(){var a=this.target.world();a&&(BlockEditorMorph.uber.popUp.call(this,a),this.setInitialDimensions(),this.handle=new HandleMorph(this,280,220,this.corner,this.corner),a.keyboardReceiver=null)};BlockEditorMorph.prototype.justDropped=function(){nop()};
BlockEditorMorph.prototype.accept=function(a){if(!(a instanceof CursorMorph)){if(this.action)if("function"===typeof this.target)"function"===typeof this.action?this.target.call(this.environment,this.action.call()):this.target.call(this.environment,this.action);else if("function"===typeof this.action)this.action.call(this.target,this.getInput());else this.target[this.action](this.getInput());this.close()}};BlockEditorMorph.prototype.cancel=function(a){a instanceof CursorMorph||this.close()};
BlockEditorMorph.prototype.close=function(){var a;if(this.definition.isGlobal&&(a=detect(this.body.contents.allChildren(),function(a){return a.definition&&!a.definition.isGlobal}))){a=a.definition.blockInstance();a.addShadow();(new DialogBoxMorph).inform("Local Block(s) in Global Definition","This global block definition contains one or more\nlocal custom blocks which must be removed first.",this.world(),a.fullImage());return}a=this.target.doubleDefinitionsFor(this.definition);0<a.length?(a=a[0].blockInstance(),
a.addShadow(),(new DialogBoxMorph(this,"consolidateDoubles",this)).askYesNo("Same Named Blocks","Another custom block with this name exists.\nWould you like to replace it?",this.world(),a.fullImage())):this.destroy()};BlockEditorMorph.prototype.consolidateDoubles=function(){this.target.replaceDoubleDefinitionsFor(this.definition);this.destroy()};
BlockEditorMorph.prototype.refreshAllBlockInstances=function(a){var b=this.definition,c=this.target.paletteBlockInstance(b);this.definition.isGlobal?this.target.allBlockInstances(this.definition).forEach(function(a){a.refresh()}):this.target.allDependentInvocationsOf(a).forEach(function(a){a.refresh(b)});c&&c.refreshDefaults()};
BlockEditorMorph.prototype.updateDefinition=function(){var a;var b=this.definition.blockSpec();var c=this.body.contents.position(),d,e=this;this.definition.receiver=this.target;this.definition.spec=this.prototypeSpec();this.definition.declarations=this.prototypeSlots();this.definition.variableNames=this.variableNames();this.definition.scripts=[];this.definition.editorDimensions=this.bounds.copy();this.definition.cachedIsRecursive=null;this.body.contents.children.forEach(function(b){if(b instanceof
PrototypeHatBlockMorph)a=b;else if(b instanceof BlockMorph||b instanceof CommentMorph&&!b.block)d=b.fullCopy(),d.parent=null,d.setPosition(b.position().subtract(c)),e.definition.scripts.push(d)});a&&(this.definition.category!==a.blockCategory&&this.target.shadowAttribute("scripts"),this.definition.category=a.blockCategory,this.definition.type=a.type,a.comment?(this.definition.comment=a.comment.fullCopy(),this.definition.comment.block=!0):this.definition.comment=null);this.definition.body=this.context(a);
this.refreshAllBlockInstances(b);b=this.target.parentThatIsA(IDE_Morph);b.flushPaletteCache();b.refreshPalette()};BlockEditorMorph.prototype.context=function(a){a=(a||detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph})).nextBlock();if(null===a)return null;a.allChildren().forEach(function(a){a instanceof BlockMorph&&(a.cachedInputs=null)});a=Process.prototype.reify.call(null,a,new List(this.definition.inputNames()),!0);a.outerContext=null;return a};
BlockEditorMorph.prototype.prototypeSpec=function(){return detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}).parts()[0].specFromFragments()};BlockEditorMorph.prototype.prototypeSlots=function(){return detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}).parts()[0].declarationsFromFragments()};BlockEditorMorph.prototype.variableNames=function(){return detect(this.body.contents.children,function(a){return a instanceof PrototypeHatBlockMorph}).variableNames()};
BlockEditorMorph.prototype.setInitialDimensions=function(){var a=this.world(),b=a.extent().subtract(new Point(this.padding,this.padding)),c=fontHeight(this.titleFontSize)+2*this.titlePadding,d=this.buttons.height();this.definition.editorDimensions?(this.setPosition(this.definition.editorDimensions.origin),this.setExtent(this.definition.editorDimensions.extent().min(b)),this.keepWithin(a)):(this.setExtent(this.body.contents.extent().add(new Point(this.padding,this.padding+c+d)).min(b)),this.setCenter(this.world().center()))};
BlockEditorMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.buttons&&0<this.buttons.children.length&&this.buttons.fixLayout();this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.body.setExtent(new Point(this.width()-2*this.padding,this.height()-3*this.padding-a-this.buttons.height())));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.buttons&&
0<this.buttons.children.length&&(this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))};PrototypeHatBlockMorph.prototype=new HatBlockMorph;PrototypeHatBlockMorph.prototype.constructor=PrototypeHatBlockMorph;PrototypeHatBlockMorph.uber=HatBlockMorph.prototype;function PrototypeHatBlockMorph(a){this.init(a)}
PrototypeHatBlockMorph.prototype.init=function(a){var b=a.prototypeInstance();this.blockCategory=(this.definition=a)?a.category:null;this.type=a?a.type:null;HatBlockMorph.uber.init.call(this);this.color=SpriteMorph.prototype.blockColor.control;this.category="control";this.add(b);if(a.variableNames.length){var c=this.labelPart("%blockVars");this.add(this.labelPart("%br"));this.add(c);a.variableNames.forEach(function(a){c.addInput(a)})}b.refreshPrototypeSlotTypes();this.fixLayout();b.fixBlockColor(this,
!0)};PrototypeHatBlockMorph.prototype.mouseClickLeft=function(){if(16===this.world().currentKey)return this.focus();this.parts()[0].mouseClickLeft()};PrototypeHatBlockMorph.prototype.userMenu=function(){return this.parts()[0].userMenu()};
PrototypeHatBlockMorph.prototype.fixBlockColor=function(a,b){a=this.parts()[0]||a;if(this.zebraContrast||b){if(!this.zebraContrast&&b)return this.forceNormalColoring();a.category===this.category?a.color.eq(this.color)&&this.alternateBlockColor():this.category&&!this.color.eq(SpriteMorph.prototype.blockColor[this.category])&&this.alternateBlockColor();b&&this.fixChildrensBlockColor(!0)}};PrototypeHatBlockMorph.prototype.variableNames=function(a){a=this.parts();return 3>a.length?[]:a[2].evaluate()};
PrototypeHatBlockMorph.prototype.enableBlockVars=function(a){var b=this.parts()[0];!1===a?this.setSpec("%s",!0):this.setSpec("%s %br %blockVars",!0);this.replaceInput(this.parts()[0],b);this.spec=null};function BlockLabelFragment(a){this.labelString=a||"";this.type="%s";this.options=this.defaultValue="";this.isDeleted=this.isReadOnly=!1}BlockLabelFragment.prototype.defSpecFragment=function(){var a=this.type?"%'":"";return this.isDeleted?"":a+this.labelString+(this.type?"'":"")};
BlockLabelFragment.prototype.defTemplateSpecFragment=function(){var a="";if(!this.type)return this.defSpecFragment();this.isUpvar()?a=" \u2191":this.isMultipleInput()?a="...":"%cs"===this.type?a=" \u03bb":"%b"===this.type?a=" ?":"%l"===this.type?a=" \ufe19":"%obj"===this.type?a=" %turtleOutline":contains(["%cmdRing","%repRing","%predRing","%anyUE","%boolUE"],this.type)?a=" \u03bb":this.defaultValue?a="%n"===this.type?" # = "+this.defaultValue.toString():" = "+this.defaultValue.toString():"%n"===this.type&&
(a=" #");return this.labelString+a};BlockLabelFragment.prototype.blockSpecFragment=function(){return this.isDeleted?"":this.type||this.labelString};BlockLabelFragment.prototype.copy=function(){var a=new BlockLabelFragment(this.labelString);a.type=this.type;a.defaultValue=this.defaultValue;a.options=this.options;a.isReadOnly=this.isReadOnly;return a};BlockLabelFragment.prototype.isSingleInput=function(){return!this.isMultipleInput()&&"%upvar"!==this.type};
BlockLabelFragment.prototype.isMultipleInput=function(){return this.type?-1<this.type.indexOf("%mult"):!1};BlockLabelFragment.prototype.isUpvar=function(){return this.type?"%upvar"===this.type:!1};BlockLabelFragment.prototype.setToSingleInput=function(){if(!this.type)return null;this.type="%upvar"===this.type?"%s":this.singleInputType()};BlockLabelFragment.prototype.setToMultipleInput=function(){if(!this.type)return null;"%upvar"===this.type&&(this.type="%s");this.type="%mult".concat(this.singleInputType())};
BlockLabelFragment.prototype.setToUpvar=function(){if(!this.type)return null;this.type="%upvar"};BlockLabelFragment.prototype.singleInputType=function(){return this.type?this.isMultipleInput()?this.type.substr(5):this.type:null};BlockLabelFragment.prototype.setSingleInputType=function(a){this.type&&this.isMultipleInput()?this.type="%mult".concat(a):this.type=a};BlockLabelFragmentMorph.prototype=new StringMorph;BlockLabelFragmentMorph.prototype.constructor=BlockLabelFragmentMorph;
BlockLabelFragmentMorph.uber=StringMorph.prototype;function BlockLabelFragmentMorph(a){this.init(a)}BlockLabelFragmentMorph.prototype.init=function(a){this.fragment=new BlockLabelFragment(a);this.sO=this.fragment.type=null;BlockLabelFragmentMorph.uber.init.call(this,a,null,SyntaxElementMorph.prototype.labelFontStyle,null,null,null,null,null,null,SyntaxElementMorph.prototype.labelFontName)};
BlockLabelFragmentMorph.prototype.mouseEnter=function(){this.sO=this.shadowOffset;this.shadowOffset=this.sO.neg();this.drawNew();this.changed()};BlockLabelFragmentMorph.prototype.mouseLeave=function(){this.shadowOffset=this.sO;this.drawNew();this.changed()};
BlockLabelFragmentMorph.prototype.mouseClickLeft=function(){var a=this.fragment.copy(),b=this,c=this instanceof BlockLabelPlaceHolderMorph,d=2>this.parent.parseSpec(this.parent.blockSpec).length;(new InputSlotDialogMorph(a,null,function(){b.updateBlockLabel(a)},this,this.parent.definition.category)).open(this instanceof BlockLabelFragmentMorph?"Edit label fragment":c?"Create input name":"Edit input name",a.labelString,this.world(),null,c||d)};
BlockLabelFragmentMorph.prototype.updateBlockLabel=function(a){var b=this.parentThatIsA(BlockMorph);this.fragment=a;b&&b.refreshPrototype()};
BlockLabelFragmentMorph.prototype.userMenu=function(){var a=this,b=new Color(100,100,130),c=new MenuMorph(function(b){var c=a.text.split("-");a.changed();c[0]="$"+b;a.text=c.join("-");a.fragment.labelString=a.text;a.parent.parent.changed();a.drawNew();a.changed();a.parent.parent.fixLayout();a.parent.parent.changed()},null,this,this.fontSize);SymbolMorph.prototype.names.forEach(function(a){c.addItem([new SymbolMorph(a,c.fontSize,b),a],a)});c.addLine();c.addItem("\u23ce "+localize("new line"),"nl");
return c};BlockLabelPlaceHolderMorph.prototype=new StringMorph;BlockLabelPlaceHolderMorph.prototype.constructor=BlockLabelPlaceHolderMorph;BlockLabelPlaceHolderMorph.uber=StringMorph.prototype;BlockLabelPlaceHolderMorph.prototype.plainLabel=!1;function BlockLabelPlaceHolderMorph(){this.init()}
BlockLabelPlaceHolderMorph.prototype.init=function(){this.fragment=new BlockLabelFragment("");this.fragment.type="%s";this.fragment.isDeleted=!0;this.isHighlighted=!1;this.isProtectedLabel=!0;BlockLabelFragmentMorph.uber.init.call(this,"+")};
BlockLabelPlaceHolderMorph.prototype.drawNew=function(){this.plainLabel&&(this.text=this.isHighlighted?" + ":"");this.image=newCanvas();var a=this.image.getContext("2d");a.font=this.font();var b=Math.max(a.measureText(this.text).width+Math.abs(this.shadowOffset.x),1);this.bounds.corner=this.bounds.origin.add(new Point(b,fontHeight(this.fontSize)+Math.abs(this.shadowOffset.y)));this.image.width=b;this.image.height=this.height();if(this.isHighlighted){b=Math.floor(b/2);var c=Math.floor(this.height()/
2);a.fillStyle=this.color.toString();a.beginPath();a.arc(b,1.2*c,Math.min(b,c),radians(0),radians(360),!1);a.closePath();a.fill()}a.font=this.font();a.textAlign="left";a.textBaseline="bottom";this.shadowColor&&(b=Math.max(this.shadowOffset.x,0),c=Math.max(this.shadowOffset.y,0),a.fillStyle=this.shadowColor.toString(),a.fillText(this.text,b,fontHeight(this.fontSize)+c));b=Math.abs(Math.min(this.shadowOffset.x,0));c=Math.abs(Math.min(this.shadowOffset.y,0));a.fillStyle=this.isHighlighted?"white":this.color.toString();
a.fillText(this.text,b,fontHeight(this.fontSize)+c);this.parent&&(this.parent.fixLayout&&this.parent.fixLayout(),this.parent.parent instanceof PrototypeHatBlockMorph&&this.parent.parent.fixLayout())};BlockLabelPlaceHolderMorph.prototype.mouseEnter=function(){var a=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!0;this.plainLabel&&a?(a.changed(),this.drawNew(),a.changed()):(this.drawNew(),this.changed())};
BlockLabelPlaceHolderMorph.prototype.mouseLeave=function(){var a=this.parentThatIsA(PrototypeHatBlockMorph);this.isHighlighted=!1;this.plainLabel&&a?(a.changed(),this.drawNew(),a.changed()):(this.drawNew(),this.changed())};BlockLabelPlaceHolderMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft;BlockLabelPlaceHolderMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel;BlockInputFragmentMorph.prototype=new TemplateSlotMorph;
BlockInputFragmentMorph.prototype.constructor=BlockInputFragmentMorph;BlockInputFragmentMorph.uber=TemplateSlotMorph.prototype;function BlockInputFragmentMorph(a){this.init(a)}BlockInputFragmentMorph.prototype.init=function(a){this.fragment=new BlockLabelFragment(a);this.fragment.type="%s";BlockInputFragmentMorph.uber.init.call(this,a)};BlockInputFragmentMorph.prototype.mouseClickLeft=BlockLabelFragmentMorph.prototype.mouseClickLeft;BlockInputFragmentMorph.prototype.updateBlockLabel=BlockLabelFragmentMorph.prototype.updateBlockLabel;
InputSlotDialogMorph.prototype=new DialogBoxMorph;InputSlotDialogMorph.prototype.constructor=InputSlotDialogMorph;InputSlotDialogMorph.uber=DialogBoxMorph.prototype;InputSlotDialogMorph.prototype.isLaunchingExpanded=!1;function InputSlotDialogMorph(a,b,c,d,e){this.init(a,b,c,d,e)}
InputSlotDialogMorph.prototype.init=function(a,b,c,d,e){var f=SyntaxElementMorph.prototype.scale,g=fontHeight(10)/1.2*f;this.fragment=a||new BlockLabelFragment;this.slots=this.types=this.textfield=null;this.isExpanded=!1;this.category=e||"other";this.cachedRadioButton=null;this.noDelete=!1;BlockDialogMorph.uber.init.call(this,b,c,d);this.types=new AlignmentMorph("row",this.padding);this.types.respectHiddens=!0;this.add(this.types);this.slots=new BoxMorph;this.slots.color=new Color(55,55,55);this.slots.borderColor=
this.slots.color.lighter(50);this.slots.setExtent(new Point(24*(g+10),10.4*(g+10*f)));this.add(this.slots);this.createSlotTypeButtons();this.fixSlotsLayout();this.addSlotsMenu();this.createTypeButtons();this.fixLayout()};
InputSlotDialogMorph.prototype.createTypeButtons=function(){var a=this,b=SpriteMorph.prototype.blockColor[this.category];var c=new JaggedBlockMorph(localize("Title text"));c.setColor(b);this.addBlockTypeButton(function(){a.setType(null)},c,function(){return null===a.fragment.type});c=new JaggedBlockMorph("%inputName");c.setColor(b);this.addBlockTypeButton(function(){a.setType("%s")},c,function(){return null!==a.fragment.type});var d=new ArrowMorph("right",PushButtonMorph.prototype.fontSize+4,2);d.noticesTransparentClick=
!0;this.types.add(d);this.types.fixLayout();d.refresh=function(){null===a.fragment.type?(a.isExpanded=!1,d.hide(),a.drawNew()):(d.show(),d.direction=a.isExpanded?"down":"right",d.drawNew(),d.changed())};d.mouseClickLeft=function(){d.isVisible&&(a.isExpanded=!a.isExpanded,a.types.children.forEach(function(a){a.refresh()}),a.drawNew(),a.edit())};d.refresh()};InputSlotDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;InputSlotDialogMorph.prototype.addBlockTypeButton=BlockDialogMorph.prototype.addBlockTypeButton;
InputSlotDialogMorph.prototype.setType=function(a){this.textfield.choices=a?null:this.symbolMenu;this.textfield.drawNew();this.fragment.type=a||null;this.types.children.forEach(function(a){a.refresh()});this.slots.children.forEach(function(a){a.refresh()});this.edit()};
InputSlotDialogMorph.prototype.getInput=function(){var a;this.body instanceof InputFieldMorph&&(a=this.normalizeSpaces(this.body.getValue()));if(a)return this.fragment.labelString=a,contains(["%b","%boolUE"],this.fragment.type)?this.fragment.defaultValue=this.slots.defaultSwitch.evaluate():this.fragment.defaultValue=this.slots.defaultInputField.getValue(),a;this.noDelete||(this.fragment.isDeleted=!0);return null};
InputSlotDialogMorph.prototype.fixLayout=function(){var a=this.left(),b=fontHeight(this.titleFontSize)+2*this.titlePadding;if(!this.isExpanded)return this.slots&&this.slots.hide(),BlockDialogMorph.prototype.fixLayout.call(this);this.slots.show();var c=this.slots.width();this.body.setPosition(this.position().add(new Point(this.padding+(c-this.body.width())/2,b+this.padding)));this.label.setLeft(a+this.padding+(c-this.label.width())/2);this.label.setTop(this.top()+(b-this.label.height())/2);this.types.fixLayout();
this.types.setTop(this.body.bottom()+this.padding);this.types.setLeft(a+this.padding+(c-this.types.width())/2);this.slots.setPosition(new Point(this.left()+this.padding,this.types.bottom()+this.padding));this.slots.children.forEach(function(a){a.refresh()});this.buttons.fixLayout();this.buttons.setTop(this.slots.bottom()+this.padding);this.buttons.setLeft(a+this.padding+(c-this.buttons.width())/2);this.silentSetHeight(this.buttons.bottom()-this.top()+this.padding);this.silentSetWidth(this.slots.right()-
this.left()+this.padding)};
InputSlotDialogMorph.prototype.open=function(a,b,c,d,e){b=new InputFieldMorph(b);var f=Morph.prototype.trackChanges;this.fragment.type||(b.choices=this.symbolMenu);Morph.prototype.trackChanges=!1;this.isExpanded=this.isLaunchingExpanded;b.setWidth(250);this.labelString=a;this.createLabel();d&&this.setPicture(d);this.addBody(b);b.drawNew();this.textfield=b;this.addButton("ok","OK");e?this.noDelete=!0:this.addButton("deleteFragment","Delete");this.addButton("cancel","Cancel");this.fixLayout();this.drawNew();
this.fixLayout();this.popUp(c);this.add(this.types);Morph.prototype.trackChanges=f;this.changed()};InputSlotDialogMorph.prototype.symbolMenu=function(){var a=[],b=new Color(100,100,130),c=this;SymbolMorph.prototype.names.forEach(function(d){a.push([[new SymbolMorph(d,c.fontSize,b),localize(d)],"$"+d])});a.push(["\u23ce "+localize("new line"),"$nl"]);return a};InputSlotDialogMorph.prototype.deleteFragment=function(){this.fragment.isDeleted=!0;this.accept()};
InputSlotDialogMorph.prototype.createSlotTypeButtons=function(){var a=this,b=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;this.addSlotTypeButton("Object","%obj");this.addSlotTypeButton("Text","%txt");this.addSlotTypeButton("List","%l");this.addSlotTypeButton("Number","%n");this.addSlotTypeButton("Any type","%s");this.addSlotTypeButton("Boolean (T/F)","%b");this.addSlotTypeButton("Command\n(inline)","%cmdRing");this.addSlotTypeButton("Reporter","%repRing");this.addSlotTypeButton("Predicate",
"%predRing");this.addSlotTypeButton("Command\n(C-shape)","%cs");this.addSlotTypeButton("Any\n(unevaluated)","%anyUE");this.addSlotTypeButton("Boolean\n(unevaluated)","%boolUE");this.slots.radioButtonSingle=this.addSlotArityButton(function(){a.setSlotArity("single")},"Single input.",function(){return a.fragment.isSingleInput()});this.addSlotArityButton(function(){a.setSlotArity("multiple")},"Multiple inputs (value is list of inputs)",function(){return a.fragment.isMultipleInput()});this.addSlotArityButton(function(){a.setSlotArity("upvar")},
"Upvar - make internal variable visible to caller",function(){return a.fragment.isUpvar()});var c=new StringMorph(localize("Default Value:"));c.fontSize=this.slots.radioButtonSingle.fontSize;c.setColor(new Color(255,255,255));c.refresh=function(){a.isExpanded&&contains("%s %n %txt %anyUE %b %boolUE".split(" "),a.fragment.type)?c.show():c.hide()};this.slots.defaultInputLabel=c;this.slots.add(c);var d=new InputFieldMorph(this.fragment.defaultValue);d.contents().fontSize=c.fontSize;d.contrast=90;d.contents().drawNew();
d.setWidth(50);d.refresh=function(){a.isExpanded&&contains(["%s","%n","%txt","%anyUE"],a.fragment.type)?(d.show(),"%n"===a.fragment.type?d.setIsNumeric(!0):d.setIsNumeric(!1)):d.hide()};this.slots.defaultInputField=d;this.slots.add(d);d.drawNew();var e=new BooleanSlotMorph(this.fragment.defaultValue);e.refresh=function(){a.isExpanded&&contains(["%b","%boolUE"],a.fragment.type)?e.show():e.hide()};this.slots.defaultSwitch=e;this.slots.add(e);e.drawNew();Morph.prototype.trackChanges=b};
InputSlotDialogMorph.prototype.setSlotType=function(a){this.fragment.setSingleInputType(a);this.slots.children.forEach(function(a){a.refresh()});this.edit()};InputSlotDialogMorph.prototype.setSlotArity=function(a){"single"===a?this.fragment.setToSingleInput():"multiple"===a?this.fragment.setToMultipleInput():"upvar"===a&&this.fragment.setToUpvar();this.slots.children.forEach(function(a){a.refresh()});this.edit()};
InputSlotDialogMorph.prototype.addSlotTypeButton=function(a,b){var c=this,d=new JaggedBlockMorph(b);d.setCategory(this.category);d.rebuild();a=new ToggleMorph("radiobutton",this,function(){c.setSlotType(b)},a,function(){return c.fragment.singleInputType()===b},null,null,this.cachedRadioButton,d.fullImage(),"rebuild");a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.drawNew();a.fixLayout();a.label.isBold=!1;
a.label.setColor(new Color(255,255,255));this.cachedRadioButton||(this.cachedRadioButton=a);this.slots.add(a);return a};
InputSlotDialogMorph.prototype.addSlotArityButton=function(a,b,c){a=new ToggleMorph("radiobutton",this,a,b,c,null,null,this.cachedRadioButton);a.edge=this.buttonEdge/2;a.outline=this.buttonOutline/2;a.outlineColor=this.buttonOutlineColor;a.outlineGradient=this.buttonOutlineGradient;a.drawNew();a.fixLayout();a.label.setColor(new Color(255,255,255));this.slots.add(a);this.cachedRadioButton||(this.cachedRadioButton=a);return a};
InputSlotDialogMorph.prototype.fixSlotsLayout=function(){var a=this.slots,b=SyntaxElementMorph.prototype.scale,c=10*b,d=14*b,e=(fontHeight(10)/1.2+15)*b;b*=fontHeight(10)/1.2+10;c=[a.left()+c,a.left()+a.width()/3,a.left()+2*a.width()/3];d=[a.top()+d,a.top()+d+e,a.top()+d+2*e,a.top()+d+3*e,a.top()+d+4*e,a.top()+d+5*e,a.top()+d+5*e+b,a.top()+d+5*e+2*b];b=-1;var f=Morph.prototype.trackChanges;Morph.prototype.trackChanges=!1;for(e=0;12>e;e+=1){var g=e%3;0===e%3&&(b+=1);a.children[e].setPosition(new Point(c[g],
d[b]))}g=0;b=5;for(e=12;15>e;e+=1)a.children[e].setPosition(new Point(c[g],d[b+e-12]));this.slots.defaultInputLabel.setPosition(this.slots.radioButtonSingle.label.topRight().add(new Point(5,0)));this.slots.defaultInputField.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultInputField.width()/2+this.slots.defaultInputLabel.width()/2+5,0)));this.slots.defaultSwitch.setCenter(this.slots.defaultInputLabel.center().add(new Point(this.slots.defaultSwitch.width()/2+this.slots.defaultInputLabel.width()/
2+5,0)));Morph.prototype.trackChanges=f;this.slots.changed()};InputSlotDialogMorph.prototype.addSlotsMenu=function(){var a=this;this.slots.userMenu=function(){if(contains(["%s","%n","%txt","%anyUE"],a.fragment.type)){var b=new MenuMorph(a);b.addItem("options...","editSlotOptions");b.addItem((a.fragment.isReadOnly?"\u2611 ":"\u2610 ")+localize("read-only"),function(){a.fragment.isReadOnly=!a.fragment.isReadOnly});return b}return Morph.prototype.userMenu.call(a)}};
InputSlotDialogMorph.prototype.editSlotOptions=function(){var a=this;(new DialogBoxMorph(a,function(b){a.fragment.options=b.trim()},a)).promptCode("Input Slot Options",a.fragment.options,a.world(),null,localize('Enter one option per line.\nOptionally use "=" as key/value delimiter and {} for submenus. e.g.\n   the answer=42'))};InputSlotDialogMorph.prototype.hide=function(){this.isVisible=!1;this.changed()};InputSlotDialogMorph.prototype.show=function(){this.isVisible=!0;this.changed()};
VariableDialogMorph.prototype=new DialogBoxMorph;VariableDialogMorph.prototype.constructor=VariableDialogMorph;VariableDialogMorph.uber=DialogBoxMorph.prototype;function VariableDialogMorph(a,b,c){this.init(a,b,c)}VariableDialogMorph.prototype.init=function(a,b,c){this.types=null;this.isGlobal=!0;BlockDialogMorph.uber.init.call(this,a,b,c);this.types=new AlignmentMorph("row",this.padding);this.add(this.types);this.createTypeButtons()};
VariableDialogMorph.prototype.createTypeButtons=function(){var a=this;this.addTypeButton(function(){a.setType("global")},"for all sprites",function(){return a.isGlobal});this.addTypeButton(function(){a.setType("local")},"for this sprite only",function(){return!a.isGlobal})};VariableDialogMorph.prototype.addTypeButton=BlockDialogMorph.prototype.addTypeButton;VariableDialogMorph.prototype.setType=function(a){this.isGlobal="global"===a;this.types.children.forEach(function(a){a.refresh()});this.edit()};
VariableDialogMorph.prototype.getInput=function(){var a=this.normalizeSpaces(this.body.getValue());return a?[a,this.isGlobal]:null};
VariableDialogMorph.prototype.fixLayout=function(){var a=fontHeight(this.titleFontSize)+2*this.titlePadding;this.body&&(this.body.setPosition(this.position().add(new Point(this.padding,a+this.padding))),this.silentSetWidth(this.body.width()+2*this.padding),this.silentSetHeight(this.body.height()+2*this.padding+a));this.label&&(this.label.setCenter(this.center()),this.label.setTop(this.top()+(a-this.label.height())/2));this.types&&(this.types.fixLayout(),this.silentSetHeight(this.height()+this.types.height()+
this.padding),this.silentSetWidth(Math.max(this.width(),this.types.width()+2*this.padding)),this.types.setCenter(this.center()),this.body?this.types.setTop(this.body.bottom()+this.padding):this.categories&&this.types.setTop(this.categories.bottom()+this.padding));this.buttons&&0<this.buttons.children.length&&(this.buttons.fixLayout(),this.silentSetHeight(this.height()+this.buttons.height()+this.padding),this.buttons.setCenter(this.center()),this.buttons.setBottom(this.bottom()-this.padding))};
BlockExportDialogMorph.prototype=new DialogBoxMorph;BlockExportDialogMorph.prototype.constructor=BlockExportDialogMorph;BlockExportDialogMorph.uber=DialogBoxMorph.prototype;BlockExportDialogMorph.prototype.key="blockExport";function BlockExportDialogMorph(a,b){this.init(a,b)}
BlockExportDialogMorph.prototype.init=function(a,b){var c=this;this.serializer=a;this.blocks=b.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,null,function(){c.exportBlocks()},null);this.labelString="Export blocks";this.createLabel();this.buildContents()};
BlockExportDialogMorph.prototype.buildContents=function(){var a,b,c,d=this;var e=new ScrollFrameMorph(null,null,SpriteMorph.prototype.sliderColor);e.color=SpriteMorph.prototype.paletteColor;e.padding=4;e.isDraggable=!1;e.acceptsDrops=!1;e.contents.acceptsDrops=!1;var f=e.left()+4;var g=e.top()+4;SpriteMorph.prototype.categories.forEach(function(h){d.blocks.forEach(function(k){k.category===h&&(c&&h!==c&&(g+=4),c=h,a=k.templateInstance(),b=new ToggleMorph("checkbox",d,function(){var a=d.blocks.indexOf(k);
-1<a?d.blocks.splice(a,1):d.blocks.push(k)},null,function(){return contains(d.blocks,k)},null,null,null,a.fullImage()),b.setPosition(new Point(f,g+(b.top()-b.toggleElement.top()))),e.addContents(b),g+=b.fullBounds().height()+4)})});e.scrollX(4);e.scrollY(4);this.addBody(e);this.addButton("ok","OK");this.addButton("cancel","Cancel");this.setExtent(new Point(220,300));this.fixLayout()};
BlockExportDialogMorph.prototype.popUp=function(a){if(a=a||this.target.world())BlockExportDialogMorph.uber.popUp.call(this,a),this.handle=new HandleMorph(this,200,220,this.corner,this.corner)};BlockExportDialogMorph.prototype.userMenu=function(){var a=new MenuMorph(this,"select");a.addItem("all","selectAll");a.addItem("none","selectNone");return a};BlockExportDialogMorph.prototype.selectAll=function(){this.body.contents.children.forEach(function(a){a.state||a.trigger()})};
BlockExportDialogMorph.prototype.selectNone=function(){this.blocks=[];this.body.contents.children.forEach(function(a){a.refresh()})};
BlockExportDialogMorph.prototype.exportBlocks=function(){var a=this.serializer.serialize(this.blocks,!0),b=this.world().children[0];0<this.blocks.length?(a='<blocks app="'+this.serializer.app+'" version="'+this.serializer.version+'">'+a+"</blocks>",b.saveXMLAs(a,(b.projectName||localize("untitled"))+" "+localize("blocks"))):(new DialogBoxMorph).inform("Export blocks","no blocks were selected",this.world())};BlockExportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;
BlockImportDialogMorph.prototype=new DialogBoxMorph;BlockImportDialogMorph.prototype.constructor=BlockImportDialogMorph;BlockImportDialogMorph.uber=DialogBoxMorph.prototype;BlockImportDialogMorph.prototype.key="blockImport";function BlockImportDialogMorph(a,b,c){this.init(a,b,c)}
BlockImportDialogMorph.prototype.init=function(a,b,c){var d=this;this.blocks=a.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,b,function(){d.importBlocks(c)},null);this.labelString=localize("Import blocks")+(c?": ":"")+c||"";this.createLabel();this.buildContents()};BlockImportDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents;BlockImportDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp;
BlockImportDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu;BlockImportDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll;BlockImportDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone;
BlockImportDialogMorph.prototype.importBlocks=function(a){var b=this.target.parentThatIsA(IDE_Morph);b&&(0<this.blocks.length?(this.blocks.forEach(function(a){a.receiver=b.stage;b.stage.globalBlocks.push(a);b.stage.replaceDoubleDefinitionsFor(a)}),b.flushPaletteCache(),b.refreshPalette(),b.showMessage("Imported Blocks Module"+(a?": "+a:"")+".",2)):(new DialogBoxMorph).inform("Import blocks","no blocks were selected",this.world()))};BlockImportDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;
BlockRemovalDialogMorph.prototype=new DialogBoxMorph;BlockRemovalDialogMorph.prototype.constructor=BlockImportDialogMorph;BlockRemovalDialogMorph.uber=DialogBoxMorph.prototype;BlockRemovalDialogMorph.prototype.key="blockRemove";function BlockRemovalDialogMorph(a,b){this.init(a,b)}
BlockRemovalDialogMorph.prototype.init=function(a,b){var c=this;this.blocks=a.slice(0);this.handle=null;BlockExportDialogMorph.uber.init.call(this,b,function(){c.removeBlocks()},null);this.labelString=localize("Remove unused blocks")+(name?": ":"")+name||"";this.createLabel();this.buildContents()};BlockRemovalDialogMorph.prototype.buildContents=BlockExportDialogMorph.prototype.buildContents;BlockRemovalDialogMorph.prototype.popUp=BlockExportDialogMorph.prototype.popUp;
BlockRemovalDialogMorph.prototype.userMenu=BlockExportDialogMorph.prototype.userMenu;BlockRemovalDialogMorph.prototype.selectAll=BlockExportDialogMorph.prototype.selectAll;BlockRemovalDialogMorph.prototype.selectNone=BlockExportDialogMorph.prototype.selectNone;
BlockRemovalDialogMorph.prototype.removeBlocks=function(){var a=this.target.parentThatIsA(IDE_Morph);a&&(0<this.blocks.length?(this.blocks.forEach(function(b){b=a.stage.globalBlocks.indexOf(b);-1!==b&&a.stage.globalBlocks.splice(b,1)}),a.flushPaletteCache(),a.refreshPalette(),a.showMessage(this.blocks.length+" "+localize("unused block(s) removed"),2)):(new DialogBoxMorph).inform("Remove unused blocks","no blocks were selected",this.world()))};BlockRemovalDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;modules.tables="2017-September-01";function Table(a,b){this.colCount=+a;this.rowCount=+b;this.colNames=[];this.rowNames=[];this.contents=Array(+b);for(var c=0;c<b;c+=1)this.contents[c]=Array(+a);this.lastChanged=Date.now()}Table.prototype.demo=function(a){this.fillWithTestData();(new TableDialogMorph(this)).popUp(a)};Table.prototype.changed=function(){this.lastChanged=Date.now()};
Table.prototype.get=function(a,b){return a?b?a>this.colCount||b>this.rowCount?null:(this.contents[b-1]||[])[a-1]:this.colName(a):b?this.rowName(b):[this.rowCount]};Table.prototype.row=function(a){return this.contents[a-1]};Table.prototype.col=function(a){var b=[];--a;var c;for(c=0;c<this.rowCount;c+=1)b.push(this.contents[c][a]);return b};
Table.prototype.colName=function(a){if(a>this.colCount)return null;var b=this.colNames[a-1];return void 0!==b?b:String.fromCharCode(64+(a%26||26)).repeat(Math.floor((a-1)/26)+1)};Table.prototype.rowName=function(a){return a>this.rowCount?null:this.rowNames[a-1]||a};Table.prototype.rows=function(){return this.rowCount};Table.prototype.cols=function(){return this.colCount};Table.prototype.columnNames=function(){return this.colNames};Table.prototype.set=function(a,b,c){this.contents[c-1][b-1]=a;this.changed()};
Table.prototype.setRows=function(a,b,c){this.contents=a;b&&(this.colNames=b);c&&(this.rowNames=c);this.changed()};Table.prototype.setCols=function(a,b,c){var d,e;for(e=0;e<this.colCount;e+=1)for(d=0;d<this.rowCount;d+=1)this.contents[d][e]=a[e][d];b&&(this.colNames=b);c&&(this.rowNames=c);this.changed()};Table.prototype.setColNames=function(a){this.colNames=a||[];this.changed()};Table.prototype.setRowNames=function(a){this.rowNames=a||[];this.changed()};
Table.prototype.setColName=function(a,b){this.colNames[a+1]=b;this.changed()};Table.prototype.setRowName=function(a,b){this.rowNames[a+1]=b;this.changed()};Table.prototype.addRow=function(a,b){this.contents[this.rowCount]=a?a:Array(this.rowCount);this.rowNames[this.rowCount]=b;this.rowCount+=1;this.changed()};Table.prototype.addCol=function(a,b){var c;if(a)for(c=0;c<this.col;c+=1)this.contents[c][this.colCount]=a[c];this.colNames[this.colCount]=b;this.colCount+=1;this.changed()};
Table.prototype.toList=function(){return new List(this.contents.map(function(a){return new List(a)}))};Table.prototype.fillWithTestData=function(){var a,b;for(a=1;a<=this.colCount;a+=1)for(b=1;b<=this.rowCount;b+=1)this.set(this.colName(a)+this.rowName(b),a,b)};TableCellMorph.prototype=new Morph;TableCellMorph.prototype.constructor=TableCellMorph;TableCellMorph.uber=Morph.prototype;TableCellMorph.prototype.listSymbol=ArgMorph.prototype.listIcon();function TableCellMorph(a,b,c){this.init(a,b,c)}
TableCellMorph.prototype.init=function(a,b,c){this.data=a;this.isLabel=c||!1;TableCellMorph.uber.init.call(this,!0);this.noticesTransparentClick=!0;b&&this.silentSetExtent(b);this.drawNew()};TableCellMorph.prototype.setData=function(a,b){this.data=a;b&&!b.eq(this.extent())?(this.silentSetExtent(b),this.drawNew()):this.drawData()};TableCellMorph.prototype.getData=function(){return this.data instanceof Array?this.data[0]:this.data};
TableCellMorph.prototype.drawNew=function(){this.image=newCanvas(this.extent());this.drawData()};
TableCellMorph.prototype.drawData=function(a,b){a=a||this.dataRepresentation(this.data);var c=this.image.getContext("2d"),d=SyntaxElementMorph.prototype.fontSize,e=TableMorph.prototype.highContrast?"rgb(220, 220, 220)":"transparent",f=(this.isLabel?this.data instanceof Array?"italic":"":this.shouldBeList()?"bold":"")+" "+d+"px Helvetica, Arial, sans-serif",g=b||(this.isLabel?e:this.shouldBeList()?"rgb(217, 77, 17)":this.isOvershooting()?"white":isNil(this.data)?e:"white");e=!this.isLabel&&this.shouldBeList()?
"white":"black";var h=this.width();b=this.height();c.clearRect(0,0,h,b);c.fillStyle=g;this.shouldBeList()?(BoxMorph.prototype.outlinePath.call(this,c,SyntaxElementMorph.prototype.corner+1,0),c.fill()):this.isOvershooting()?(this.raggedBoxPath(c),c.fill()):c.fillRect(0,0,h,b);a&&(a instanceof HTMLCanvasElement?(f=Math.max((h-a.width)/2,0),b=Math.max((b-a.height)/2,0),c.shadowOffsetX=4,c.shadowOffsetY=4,c.shadowBlur=4,c.shadowColor="lightgray",c.drawImage(a,f,b)):(c.font=f,c.textAlign="left",c.textBaseline=
"bottom",f=c.measureText(a).width,d=fontHeight(d),c.fillStyle=e,f=Math.max((h-f)/2,0),b=Math.max((b-d)/2,0),c.fillText(a,f,d+b)))};
TableCellMorph.prototype.dataRepresentation=function(a){return a instanceof Morph?isSnapObject(a)?a.thumbnail(new Point(40,40)):a.fullImageClassic():isString(a)?100<a.length?a.slice(0,100)+"...":a:"number"===typeof a?a.toString():"boolean"===typeof a?SpriteMorph.prototype.booleanMorph.call(null,a).fullImage():a instanceof Array?this.dataRepresentation(a[0]):a instanceof Variable?this.dataRepresentation(a.value):a instanceof HTMLCanvasElement?a:a instanceof Context?a.image():a instanceof Costume?a.thumbnail(new Point(40,
40)):a instanceof Sound?(new SymbolMorph("notes",30)).image:a instanceof List?this.listSymbol:a?a.toString():0===a?"0":null};TableCellMorph.prototype.raggedBoxPath=function(a){var b=this.width(),c=this.height(),d=.75*b,e=c/6,f;a.beginPath();a.moveTo(0,0);a.lineTo(b,0);for(f=0;f<c;f+=2*e)a.lineTo(d,f+e),a.lineTo(b,f+2*e);a.lineTo(b,c);a.lineTo(0,c);a.closePath()};TableCellMorph.prototype.shouldBeList=function(){return this.data instanceof Array};
TableCellMorph.prototype.isOvershooting=function(){return this.data instanceof Variable};TableCellMorph.prototype.mouseDoubleClick=function(a){this.data instanceof Table||this.data instanceof List?(new TableDialogMorph(this.data)).popUp(this.world()):this.data instanceof Array&&this.data[0]instanceof List?(new TableDialogMorph(this.data[0])).popUp(this.world()):this.escalateEvent("mouseDoubleClick",a)};
TableCellMorph.prototype.mouseEnter=function(){if(this.isLabel){var a=this.parentThatIsA(TableMorph);var b=a.world().hand.left()-a.left();a=a.columnAt(b);0<a&&(this.drawData(a,"rgb(220, 220, 250)"),this.changed())}};TableCellMorph.prototype.mouseLeave=function(){this.isLabel&&(this.drawData(),this.changed())};TableMorph.prototype=new FrameMorph;TableMorph.prototype.constructor=TableMorph;TableMorph.uber=FrameMorph.prototype;TableMorph.prototype.highContrast=!1;
function TableMorph(a,b,c,d,e,f,g,h,k,l){this.init(a,b,c,d,e,f,g,h,k,l)}
TableMorph.prototype.init=function(a,b,c,d,e,f,g,h,k,l){this.table=a;this.scrollBarSize=b||MorphicPreferences.scrollBarSize;this.startRow=d||1;this.startCol=e||1;this.textHeight=Math.ceil(1.3*fontHeight(SyntaxElementMorph.prototype.fontSize));this.rowHeight=h||this.textHeight;this.colWidths=g||[];this.globalColWidth=f||Math.ceil(3.5*this.textHeight);this.colLabelHeight=k||this.textHeight;this.padding=l||SyntaxElementMorph.prototype.scale;this.tableVersion=this.table.lastChanged;this.vBar=this.hBar=
null;this.rowLabelWidth=0;this.columns=[];this.rows=0;this.resizeRow=this.resizeCol=this.resizeAnchor=this.dragAnchor=this.maxStartCol=this.maxStartRow=null;this.wantsUpdate=!1;Morph.prototype.init.call(this,!0);c&&this.silentSetExtent(c);this.initScrollBars();this.drawNew()};
TableMorph.prototype.initScrollBars=function(){var a=this;this.hBar=new SliderMorph(1,null,null,null,"horizontal");this.hBar.setHeight(this.scrollBarSize);this.hBar.action=function(b){a.showData(b,null,!0)};this.hBar.isDraggable=!1;this.add(this.hBar);this.vBar=new SliderMorph(1,null,null,null,"vertical");this.vBar.setWidth(this.scrollBarSize);this.vBar.action=function(b){a.showData(null,b,!0)};this.vBar.isDraggable=!1;this.add(this.vBar)};
TableMorph.prototype.updateScrollBars=function(){1===this.maxStartCol?this.hBar.hide():(this.hBar.show(),this.hBar.stop=this.maxStartCol,this.hBar.value=this.startCol,this.hBar.size=Math.max(this.hBar.rangeSize()*this.columns.length/this.table.cols(),this.hBar.rangeSize()/10),this.hBar.drawNew());this.vBar.stop=this.maxStartRow;this.vBar.value=this.startRow;1===this.maxStartRow?this.vBar.hide():(this.vBar.show(),this.vBar.size=Math.max(this.vBar.rangeSize()*this.rows/this.table.rows(),this.vBar.rangeSize()/
10),this.vBar.drawNew())};
TableMorph.prototype.drawNew=function(){var a;this.image=newCanvas(this.extent());var b=this.image.getContext("2d");b.fillStyle="rgb(220, 220, 220)";BoxMorph.prototype.outlinePath.call(this,b,SyntaxElementMorph.prototype.corner+1,0);b.fill();this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();if(this.highContrast&&1<this.table.cols()){var c=this.padding;for(a=this.startCol;a<=this.table.cols();a+=1)c+=this.colWidth(a)+this.padding;b.fillStyle="darkGray";
b.fillRect(this.padding+this.rowLabelWidth,this.padding+this.colLabelHeight,c,(this.rowHeight+this.padding)*(this.table.rows()+1-this.startRow)+this.padding)}this.buildCells();this.hBar.setWidth(this.width()-this.vBar.width());this.hBar.setLeft(this.left());this.hBar.setBottom(this.bottom());this.vBar.setHeight(this.height()-this.hBar.height());this.vBar.setRight(this.right());this.vBar.setTop(this.top())};
TableMorph.prototype.buildCells=function(){var a,b,c=this.position();this.children=[];for(b=0;b<=this.columns.length;b+=1)for(a=0;a<=this.rows;a+=1){var d=new TableCellMorph(this.table.get(b?b+this.startCol-1:b,a?a+this.startRow-1:a),new Point(b?this.colWidth(b+this.startCol-1):this.rowLabelWidth,a?this.rowHeight:this.colLabelHeight),!(a&&b),!1);d.setPosition((new Point(b?this.columns[b-1]:this.padding,a?2*this.padding+this.colLabelHeight+(a-1)*(this.rowHeight+this.padding):this.padding)).add(c));
this.add(d);isSnapObject(d.getData())&&(this.wantsUpdate=!0)}this.add(this.hBar);this.add(this.vBar);this.updateScrollBars();this.changed()};TableMorph.prototype.drawData=function(a){var b=0,c,d;for(d=0;d<=this.columns.length;d+=1)for(c=0;c<=this.rows;c+=1){var e=this.children[b];b+=1;e.setData(this.table.get(d?d+this.startCol-1:d,c?c+this.startRow-1:c));isSnapObject(e.getData())&&(this.wantsUpdate=!0)}a||this.updateScrollBars();this.changed()};
TableMorph.prototype.scroll=function(a,b){this.showData(Math.min(this.maxStartCol,Math.max(1,this.startCol+Math.round(a))),Math.min(this.maxStartRow,Math.max(1,this.startRow+Math.round(b))));this.updateScrollBars()};
TableMorph.prototype.showData=function(a,b,c){a=a||this.startCol;b=b||this.startRow;a===this.startCol?b!==this.startRow&&(this.startRow=b,this.rows=this.visibleRows(),this.drawData(c)):(this.startCol=a,this.startRow=b,this.rows=this.visibleRows(),this.colWidths.length?(this.columns=this.columnsLayout(),this.buildCells()):this.drawData(c))};
TableMorph.prototype.step=function(){this.dragAnchor?this.shiftCells(this.world().hand.position()):this.resizeAnchor&&this.resizeCells(this.world().hand.position());this.update()};
TableMorph.prototype.update=function(){var a=this.table instanceof List?this.table.version(this.startRow,this.rows):this.table.lastChanged;if(this.tableVersion!==a||this.wantsUpdate){this.wantsUpdate=!1;if(this.table instanceof List){var b=this.columns.length;var c=this.rows;this.rowLabelWidth=this.rowLabelsWidth();this.columns=this.columnsLayout();this.rows=this.visibleRows();this.columns.length!==b||this.rows!==c?this.buildCells():this.drawData()}else this.drawData();this.tableVersion=a}};
TableMorph.prototype.rowLabelsWidth=function(){var a=newCanvas().getContext("2d");a.font="italic "+SyntaxElementMorph.prototype.fontSize+"px Helvetica, Arial, sans-serif";return Math.max(0,Math.max.apply(null,this.table.columnNames().map(function(b){return b?a.measureText(b).width:0})))||a.measureText(this.table.rows().toString()).width+6*SyntaxElementMorph.prototype.scale};
TableMorph.prototype.columnsLayout=function(){var a=[],b=2*this.padding+this.rowLabelWidth,c;var d=this.table.cols();for(c=b;c<this.width()&&0<d;)c+=this.colWidth(d),--d;0===d&&c<this.width()?this.maxStartCol=1:this.maxStartCol=Math.min(d+2,this.table.cols());for(d=this.startCol=Math.min(this.startCol,this.maxStartCol);b<this.width()&&d<this.table.cols()+this.startCol;)c=this.colWidth(d),a.push(b),b+=c,b+=this.padding,d+=1;return a};
TableMorph.prototype.colWidth=function(a){return this.colWidths[a-1]||this.globalColWidth};TableMorph.prototype.visibleRows=function(){var a=this.height()-this.colLabelHeight-this.padding;if(0>a)return 0;a=Math.ceil(a/(this.rowHeight+this.padding));this.maxStartRow=Math.max(1,this.table.rows()-a+2);this.startRow=Math.min(this.startRow,this.maxStartRow);return Math.min(this.table.rows(),a)};
TableMorph.prototype.globalExtent=function(){var a,b=this.rowLabelsWidth()+2,c=this.table.cols();for(a=0;a<c;a+=1)b+=this.colWidth(a+1),b+=this.padding;1===c&&(b+=this.scrollBarSize,b+=2*this.padding);return new Point(b+this.padding,this.colLabelHeight+2*this.padding+(this.rowHeight+this.padding)*this.table.rows())};TableMorph.prototype.mouseScroll=function(a,b){this.scroll(-(+b*MorphicPreferences.mouseScrollAmount/4),-(+a*MorphicPreferences.mouseScrollAmount))};
TableMorph.prototype.mouseDownLeft=function(a){var b=a.subtract(this.position());b.x<=this.rowLabelWidth||b.y<=this.colLabelHeight?(16===this.world().currentKey?this.resizeCol=0:this.resizeCol=this.columnAt(b.x),this.resizeRow=b.y>this.colLabelHeight,this.resizeAnchor=a):(this.resizeRow=null,this.dragAnchor=a)};TableMorph.prototype.mouseClickLeft=function(a){this.resizeRow=this.resizeAnchor=this.dragAnchor=null};
TableMorph.prototype.mouseLeaveDragging=function(a){this.resizeRow=this.resizeAnchor=this.dragAnchor=null};TableMorph.prototype.mouseDoubleClick=function(a){this.parentThatIsA(TableDialogMorph)?this.escalateEvent("mouseDoubleClick",a):(new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight)).popUp(this.world())};
TableMorph.prototype.shiftCells=function(a){var b=this.dragAnchor.subtract(a),c=Math.round(b.x/this.globalColWidth);b=Math.round(b.y/this.rowHeight);if(c||b)this.scroll(c,b),this.dragAnchor=a};
TableMorph.prototype.resizeCells=function(a){var b=a.subtract(this.resizeAnchor),c;if(this.resizeCol)this.colWidths[this.resizeCol-1]=Math.max(16,(this.colWidths[this.resizeCol-1]||this.globalColWidth)+b.x);else if(this.resizeRow)this.rowHeight=Math.max(16,this.rowHeight+b.y);else for(this.globalColWidth=Math.max(16,this.globalColWidth+b.x),c=0;c<this.colWidths.length;c+=1)this.colWidths[c]&&(this.colWidths[c]=Math.max(16,this.colWidths[c]+b.x));this.highContrast?this.drawNew():(this.rowLabelWidth=
this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells());this.resizeAnchor=a};TableMorph.prototype.columnAt=function(a){var b=0;if(a<this.columns[0])return 0;for(;a>this.columns[b];)b+=1;return b+this.startCol-1};
TableMorph.prototype.userMenu=function(){var a=new MenuMorph(this);if(this.parentThatIsA(TableDialogMorph))return this.colWidths.length&&(a.addItem("reset columns","resetColumns"),a.addLine()),a.addItem("open in another dialog...","openInDialog"),a;this.colWidths.length&&a.addItem("reset columns","resetColumns");a.addItem("list view...","showListView");a.addLine();a.addItem("open in dialog...","openInDialog");return a};
TableMorph.prototype.resetColumns=function(){this.colWidths=[];this.highContrast?this.drawNew():(this.rowLabelWidth=this.rowLabelsWidth(),this.columns=this.columnsLayout(),this.rows=this.visibleRows(),this.buildCells())};TableMorph.prototype.openInDialog=function(){(new TableDialogMorph(this.table,this.globalColWidth,this.colWidths,this.rowHeight)).popUp(this.world())};
TableMorph.prototype.showListView=function(){var a=this.parentThatIsAnyOf([SpriteBubbleMorph,SpeechBubbleMorph,CellMorph]);a&&(a instanceof SpriteBubbleMorph?(a.changed(),a.drawNew(!0)):a instanceof SpeechBubbleMorph?(a.contents=new ListWatcherMorph(this.table),a.contents.step=a.contents.update,a.contents.expand(this.extent()),a.drawNew(!0)):(a.drawNew(!0),a.contentsMorph.expand(this.extent())),a.fixLayout())};TableMorph.prototype.show=function(){TableMorph.uber.show.call(this);this.updateScrollBars()};
TableFrameMorph.prototype=new Morph;TableFrameMorph.prototype.constructor=TableFrameMorph;TableFrameMorph.uber=Morph.prototype;function TableFrameMorph(a,b){this.init(a,b)}TableFrameMorph.prototype.init=function(a,b){this.tableMorph=a;this.handle=null;TableFrameMorph.uber.init.call(this,!0);this.color="transparent";this.noticesTransparentClick=!1;this.bounds=this.tableMorph.bounds.copy();this.add(this.tableMorph);b||(this.handle=new HandleMorph(this,80,25,null,null));this.drawNew()};
TableFrameMorph.prototype.fixLayout=function(){var a=this.extent();this.tableMorph.extent().eq(a)||(this.tableMorph.setExtent(this.extent()),this.parent&&this.parent.fixLayout&&this.parent.fixLayout())};TableFrameMorph.prototype.setExtent=function(a,b){TableFrameMorph.uber.setExtent.call(this,a,b);this.fixLayout()};TableFrameMorph.prototype.expand=function(a){var b=this.tableMorph.globalExtent();a&&(b=b.min(a));this.setExtent(b);this.handle.setRight(this.right());this.handle.setBottom(this.bottom())};
TableDialogMorph.prototype=new DialogBoxMorph;TableDialogMorph.prototype.constructor=TableDialogMorph;TableDialogMorph.uber=DialogBoxMorph.prototype;function TableDialogMorph(a,b,c,d){this.init(a,b,c,d)}TableDialogMorph.prototype.init=function(a,b,c,d){this.handle=null;this.data=a;this.tableView=null;TableDialogMorph.uber.init.call(this);this.labelString="Table view";this.createLabel();this.buildContents(a,b,c,d)};
TableDialogMorph.prototype.buildContents=function(a,b,c,d){this.tableView=new TableMorph(a,null,null,null,null,b,c,d,null,null);this.addBody(new TableFrameMorph(this.tableView,!0));this.addButton("ok","OK")};
TableDialogMorph.prototype.setInitialDimensions=function(){var a=this.world().extent().subtract(new Point(this.padding,this.padding)),b=fontHeight(this.titleFontSize)+3*this.titlePadding,c=this.buttons.height();this.setExtent(this.tableView.globalExtent().add(new Point(2*this.padding,2*this.padding+b+c)).min(a).max(new Point(100,100)));this.setCenter(this.world().center())};
TableDialogMorph.prototype.popUp=function(a){a&&(TableDialogMorph.uber.popUp.call(this,a),this.setInitialDimensions(),this.handle=new HandleMorph(this,100,100,this.corner,this.corner))};TableDialogMorph.prototype.fixLayout=BlockEditorMorph.prototype.fixLayout;modules.symbols="2017-September-26";SymbolMorph.prototype=new Morph;SymbolMorph.prototype.constructor=SymbolMorph;SymbolMorph.uber=Morph.prototype;SymbolMorph.prototype.names="square pointRight stepForward gears file fullScreen normalScreen smallStage normalStage turtle stage turtleOutline pause flag octagon cloud cloudOutline cloudGradient turnRight turnLeft storage poster flash brush rectangle rectangleSolid circle circleSolid line cross crosshairs paintbucket eraser pipette speechBubble speechBubbleOutline turnBack turnForward arrowUp arrowUpOutline arrowLeft arrowLeftOutline arrowDown arrowDownOutline arrowRight arrowRightOutline robot magnifyingGlass magnifierOutline notes camera location footprints keyboard keyboardFilled".split(" ");
function SymbolMorph(a,b,c,d,e){this.init(a,b,c,d,e)}SymbolMorph.prototype.init=function(a,b,c,d,e){this.isProtectedLabel=!1;this.isReadOnly=!0;this.name=a||"square";this.size=b||(0===b?0:50);this.shadowOffset=d||new Point(0,0);this.shadowColor=e||null;SymbolMorph.uber.init.call(this,!0);this.color=c||new Color(0,0,0);this.drawNew()};SymbolMorph.prototype.setLabelColor=function(a,b,c){this.shadowOffset=c||new Point;this.shadowColor=b;this.setColor(a)};
SymbolMorph.prototype.drawNew=function(){this.image=newCanvas(new Point(this.symbolWidth()+Math.abs(this.shadowOffset.x),this.size+Math.abs(this.shadowOffset.y)));this.silentSetWidth(this.image.width);this.silentSetHeight(this.image.height);var a=this.image.getContext("2d");var b=0>this.shadowOffset.x?0:this.shadowOffset.x;var c=0>this.shadowOffset.y?0:this.shadowOffset.y;var d=0>this.shadowOffset.x?Math.abs(this.shadowOffset.x):0;var e=0>this.shadowOffset.y?Math.abs(this.shadowOffset.y):0;this.shadowColor&&
a.drawImage(this.symbolCanvasColored(this.shadowColor),b,c);a.drawImage(this.symbolCanvasColored(this.color),d,e)};
SymbolMorph.prototype.symbolCanvasColored=function(a){if(this.name instanceof Costume)return this.name.thumbnail(new Point(this.symbolWidth(),this.size));var b=newCanvas(new Point(this.symbolWidth(),this.size));switch(this.name){case "square":return this.drawSymbolStop(b,a);case "pointRight":return this.drawSymbolPointRight(b,a);case "stepForward":return this.drawSymbolStepForward(b,a);case "gears":return this.drawSymbolGears(b,a);case "file":return this.drawSymbolFile(b,a);case "fullScreen":return this.drawSymbolFullScreen(b,
a);case "normalScreen":return this.drawSymbolNormalScreen(b,a);case "smallStage":return this.drawSymbolSmallStage(b,a);case "normalStage":return this.drawSymbolNormalStage(b,a);case "turtle":return this.drawSymbolTurtle(b,a);case "stage":return this.drawSymbolStop(b,a);case "turtleOutline":return this.drawSymbolTurtleOutline(b,a);case "pause":return this.drawSymbolPause(b,a);case "flag":return this.drawSymbolFlag(b,a);case "octagon":return this.drawSymbolOctagon(b,a);case "cloud":return this.drawSymbolCloud(b,
a);case "cloudOutline":return this.drawSymbolCloudOutline(b,a);case "cloudGradient":return this.drawSymbolCloudGradient(b,a);case "turnRight":return this.drawSymbolTurnRight(b,a);case "turnLeft":return this.drawSymbolTurnLeft(b,a);case "storage":return this.drawSymbolStorage(b,a);case "poster":return this.drawSymbolPoster(b,a);case "flash":return this.drawSymbolFlash(b,a);case "brush":return this.drawSymbolBrush(b,a);case "rectangle":return this.drawSymbolRectangle(b,a);case "rectangleSolid":return this.drawSymbolRectangleSolid(b,
a);case "circle":return this.drawSymbolCircle(b,a);case "circleSolid":return this.drawSymbolCircleSolid(b,a);case "line":return this.drawSymbolLine(b,a);case "cross":return this.drawSymbolCross(b,a);case "crosshairs":return this.drawSymbolCrosshairs(b,a);case "paintbucket":return this.drawSymbolPaintbucket(b,a);case "eraser":return this.drawSymbolEraser(b,a);case "pipette":return this.drawSymbolPipette(b,a);case "speechBubble":return this.drawSymbolSpeechBubble(b,a);case "speechBubbleOutline":return this.drawSymbolSpeechBubbleOutline(b,
a);case "turnBack":return this.drawSymbolTurnBack(b,a);case "turnForward":return this.drawSymbolTurnForward(b,a);case "arrowUp":return this.drawSymbolArrowUp(b,a);case "arrowUpOutline":return this.drawSymbolArrowUpOutline(b,a);case "arrowLeft":return this.drawSymbolArrowLeft(b,a);case "arrowLeftOutline":return this.drawSymbolArrowLeftOutline(b,a);case "arrowDown":return this.drawSymbolArrowDown(b,a);case "arrowDownOutline":return this.drawSymbolArrowDownOutline(b,a);case "arrowRight":return this.drawSymbolArrowRight(b,
a);case "arrowRightOutline":return this.drawSymbolArrowRightOutline(b,a);case "robot":return this.drawSymbolRobot(b,a);case "magnifyingGlass":return this.drawSymbolMagnifyingGlass(b,a);case "magnifierOutline":return this.drawSymbolMagnifierOutline(b,a);case "notes":return this.drawSymbolNotes(b,a);case "camera":return this.drawSymbolCamera(b,a);case "location":return this.drawSymbolLocation(b,a);case "footprints":return this.drawSymbolFootprints(b,a);case "keyboard":return this.drawSymbolKeyboard(b,
a);case "keyboardFilled":return this.drawSymbolKeyboardFilled(b,a);default:return b}};
SymbolMorph.prototype.symbolWidth=function(){var a=this.size;if(this.name instanceof Costume)return a/this.name.height()*this.name.width();switch(this.name){case "pointRight":return Math.sqrt(a*a-Math.pow(a/2,2));case "location":return.6*a;case "flash":case "file":return.8*a;case "smallStage":case "normalStage":return 1.2*a;case "turtle":case "turtleOutline":case "stage":return 1.3*a;case "cloud":case "cloudGradient":case "cloudOutline":case "turnBack":case "turnForward":case "keyboard":case "keyboardFilled":return 1.6*a;
case "turnRight":case "turnLeft":return a/3*2;default:return a}};SymbolMorph.prototype.drawSymbolStop=function(a,b){var c=a.getContext("2d");c.fillStyle=b.toString();c.fillRect(0,0,a.width,a.height);return a};SymbolMorph.prototype.drawSymbolPointRight=function(a,b){var c=a.getContext("2d");c.fillStyle=b.toString();c.beginPath();c.moveTo(0,0);c.lineTo(a.width,Math.round(a.height/2));c.lineTo(0,a.height);c.lineTo(0,0);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolStepForward=function(a,b){var c=a.getContext("2d");c.fillStyle=b.toString();c.beginPath();c.moveTo(0,0);c.lineTo(.75*a.width,Math.round(a.height/2));c.lineTo(0,a.height);c.lineTo(0,0);c.closePath();c.fill();c.fillRect(.75*a.width,0,.25*a.width,a.height);return a};
SymbolMorph.prototype.drawSymbolGears=function(a,b){var c=a.getContext("2d"),d=a.width,e=d/2,f=d/6;c.strokeStyle=b.toString();c.lineWidth=a.width/7;c.beginPath();c.arc(e,e,d,radians(0),radians(360),!0);c.arc(e,e,1.5*f,radians(0),radians(360),!1);c.closePath();c.clip();c.moveTo(0,e);c.lineTo(d,e);c.stroke();c.moveTo(e,0);c.lineTo(e,d);c.stroke();c.moveTo(f,f);c.lineTo(d-f,d-f);c.stroke();c.moveTo(d-f,f);c.lineTo(f,d-f);c.stroke();return a};
SymbolMorph.prototype.drawSymbolFile=function(a,b){var c=a.getContext("2d"),d=Math.min(a.width,a.height)/2;c.fillStyle=b.toString();c.beginPath();c.moveTo(0,0);c.lineTo(d,0);c.lineTo(d,d);c.lineTo(a.width,d);c.lineTo(a.width,a.height);c.lineTo(0,a.height);c.closePath();c.fill();c.fillStyle=b.darker(25).toString();c.beginPath();c.moveTo(d,0);c.lineTo(a.width,d);c.lineTo(d,d);c.lineTo(d,0);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolFullScreen=function(a,b){var c=a.getContext("2d"),d=a.height,e=a.width/2,f=a.width/20,g=a.width/2;c.strokeStyle=b.toString();c.lineWidth=a.width/5;c.moveTo(e-f,e+f);c.lineTo(0,d);c.stroke();c.strokeStyle=b.toString();c.lineWidth=a.width/5;c.moveTo(e+f,e-f);c.lineTo(d,0);c.stroke();c.fillStyle=b.toString();c.beginPath();c.moveTo(0,d);c.lineTo(0,d-g);c.lineTo(g,d);c.closePath();c.fill();c.fillStyle=b.toString();c.beginPath();c.moveTo(d,0);c.lineTo(d-g,0);c.lineTo(d,g);
c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolNormalScreen=function(a,b){var c=a.getContext("2d"),d=a.height,e=a.width/2,f=a.width/20,g=a.width;c.strokeStyle=b.toString();c.lineWidth=a.width/5;c.moveTo(e-3*f,e+3*f);c.lineTo(0,d);c.stroke();c.strokeStyle=b.toString();c.lineWidth=a.width/5;c.moveTo(e+3*f,e-3*f);c.lineTo(d,0);c.stroke();c.fillStyle=b.toString();c.beginPath();c.moveTo(e+f,e-f);c.lineTo(g,e-f);c.lineTo(e+f,0);c.closePath();c.fill();c.fillStyle=b.toString();c.beginPath();c.moveTo(e-f,e+f);c.lineTo(0,
e+f);c.lineTo(e-f,g);c.closePath();c.fill();return a};SymbolMorph.prototype.drawSymbolSmallStage=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=d/2,g=e/2;c.fillStyle=b.darker(40).toString();c.fillRect(0,0,d,e);c.fillStyle=b.toString();c.fillRect(f,0,f,g);return a};SymbolMorph.prototype.drawSymbolNormalStage=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=d/2,g=e/2;c.fillStyle=b.toString();c.fillRect(0,0,d,e);c.fillStyle=b.darker(25).toString();c.fillRect(f,0,f,g);return a};
SymbolMorph.prototype.drawSymbolTurtle=function(a,b){var c=a.getContext("2d");c.fillStyle=b.toString();c.beginPath();c.moveTo(0,0);c.lineTo(a.width,a.height/2);c.lineTo(0,a.height);c.lineTo(a.height/2,a.height/2);c.closePath();c.fill();return a};SymbolMorph.prototype.drawSymbolTurtleOutline=function(a,b){var c=a.getContext("2d");c.strokeStyle=b.toString();c.beginPath();c.moveTo(0,0);c.lineTo(a.width,a.height/2);c.lineTo(0,a.height);c.lineTo(a.height/2,a.height/2);c.closePath();c.stroke();return a};
SymbolMorph.prototype.drawSymbolPause=function(a,b){var c=a.getContext("2d"),d=a.width/5;c.fillStyle=b.toString();c.fillRect(0,0,2*d,a.height);c.fillRect(3*d,0,2*d,a.height);return a};
SymbolMorph.prototype.drawSymbolFlag=function(a,b){var c=a.getContext("2d"),d=a.width,e=Math.max(d/12,1),f=a.height;c.lineWidth=e;c.strokeStyle=b.toString();c.beginPath();c.moveTo(e/2,0);c.lineTo(e/2,a.height);c.stroke();c.lineWidth=f/2;c.beginPath();c.moveTo(0,f/4);c.bezierCurveTo(.8*d,f/4,.1*d,.5*f,d,.5*f);c.stroke();return a};
SymbolMorph.prototype.drawSymbolOctagon=function(a,b){var c=a.getContext("2d"),d=a.width,e=(d-.383*d)/2;c.fillStyle=b.toString();c.beginPath();c.moveTo(e,0);c.lineTo(d-e,0);c.lineTo(d,e);c.lineTo(d,d-e);c.lineTo(d-e,d);c.lineTo(e,d);c.lineTo(0,d-e);c.lineTo(0,e);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolCloud=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=2*e/5,g=e/4,h=3*e/10,k=e/5;c.fillStyle=b.toString();c.beginPath();c.arc(g,e-g,g,radians(90),radians(259),!1);c.arc(d/20*5,e/9*4,k,radians(165),radians(300),!1);c.arc(d/20*11,f,f,radians(200),radians(357),!1);c.arc(d-h,e-h,h,radians(269),radians(90),!1);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolCloudGradient=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=2*e/5,g=e/4,h=3*e/10,k=e/5;var l=c.createRadialGradient(0,0,0,0,0,d);l.addColorStop(0,b.lighter(25).toString());l.addColorStop(1,b.darker(25).toString());c.fillStyle=l;c.beginPath();c.arc(g,e-g,g,radians(90),radians(259),!1);c.arc(d/20*5,e/9*4,k,radians(165),radians(300),!1);c.arc(d/20*11,f,f,radians(200),radians(357),!1);c.arc(d-h,e-h,h,radians(269),radians(90),!1);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolCloudOutline=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=2*e/5,g=e/4,h=3*e/10,k=e/5;c.strokeStyle=b.toString();c.beginPath();c.arc(g+1,e-g-1,g,radians(90),radians(259),!1);c.arc(d/20*5,e/9*4,k,radians(165),radians(300),!1);c.arc(d/20*11,f+1,f,radians(200),radians(357),!1);c.arc(d-h-1,e-h-1,h,radians(269),radians(90),!1);c.closePath();c.stroke();return a};
SymbolMorph.prototype.drawSymbolTurnRight=function(a,b){var c=a.getContext("2d"),d=a.width,e=Math.max(d/10,1),f=d/2;c.lineWidth=e;c.strokeStyle=b.toString();c.beginPath();c.arc(f,2*f,f-e/2,radians(0),radians(-90),!1);c.stroke();c.fillStyle=b.toString();c.beginPath();c.moveTo(d,f);c.lineTo(f,0);c.lineTo(f,2*f);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolTurnLeft=function(a,b){var c=a.getContext("2d"),d=a.width,e=Math.max(d/10,1);d/=2;c.lineWidth=e;c.strokeStyle=b.toString();c.beginPath();c.arc(d,2*d,d-e/2,radians(180),radians(-90),!0);c.stroke();c.fillStyle=b.toString();c.beginPath();c.moveTo(0,d);c.lineTo(d,0);c.lineTo(d,2*d);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolStorage=function(a,b){function c(a,c){d.fillStyle=b.toString();d.beginPath();d.arc(e/2,a-f,g,radians(60),radians(120),!1);d.lineTo(0,a-2*h);d.arc(e/2,a-f-2*h,g,radians(120),radians(60),!0);d.closePath();d.fill();d.fillStyle=b.darker(25).toString();d.beginPath();c&&d.arc(e/2,a-f-2*h,g,radians(120),radians(60),!0);d.arc(e/2,a+6*h+1,g,radians(60),radians(120),!0);d.closePath();c?d.fill():d.stroke()}var d=a.getContext("2d"),e=a.width,f=a.height,g=a.height,h=a.height/11;
d.strokeStyle=b.toString();c(f);c(f-3*h);c(f-6*h,!1);return a};
SymbolMorph.prototype.drawSymbolPoster=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=.75*e,g=a.height/5;c.fillStyle=b.toString();c.strokeStyle=b.toString();c.lineWidth=d/15;c.moveTo(d/2,e/3);c.lineTo(d/6,e);c.stroke();c.moveTo(d/2,e/3);c.lineTo(d/2,e);c.stroke();c.moveTo(d/2,e/3);c.lineTo(5*d/6,e);c.stroke();c.fillRect(0,0,d,f);c.clearRect(0,f,d,d/20);c.clearRect(d-g,f-g,g+1,g+1);c.fillStyle=b.darker(25).toString();c.beginPath();c.moveTo(d,f-g);c.lineTo(d-g,f-g);c.lineTo(d-g,f);c.closePath();
c.fill();return a};SymbolMorph.prototype.drawSymbolFlash=function(a,b){var c=a.getContext("2d"),d=a.width,e=d/3,f=a.height,g=f/3,h=g/3;c.fillStyle=b.toString();c.beginPath();c.moveTo(e,0);c.lineTo(0,g);c.lineTo(e,g);c.lineTo(0,2*g);c.lineTo(e,2*g);c.lineTo(0,f);c.lineTo(d,2*g-h);c.lineTo(2*e,2*g-h);c.lineTo(d,g-h);c.lineTo(2*e,g-h);c.lineTo(d,0);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolBrush=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=Math.max(d/30,.5);c.fillStyle=b.toString();c.lineWidth=2*f;c.beginPath();c.moveTo(d/8*3,e/2);c.quadraticCurveTo(0,e/2,f,e-f);c.quadraticCurveTo(d/2,e,d/2,e/8*5);c.closePath();c.fill();c.lineJoin="round";c.lineCap="round";c.strokeStyle=b.toString();c.moveTo(d/8*3,e/2);c.lineTo(.75*d,f);c.quadraticCurveTo(d,0,d-f,.25*e);c.stroke();c.moveTo(d/2,e/8*5);c.lineTo(d-f,.25*e);c.stroke();return a};
SymbolMorph.prototype.drawSymbolRectangle=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.width,f=Math.max(d/20,.5);c.strokeStyle=b.toString();c.lineWidth=2*f;c.beginPath();c.moveTo(f,f);c.lineTo(d-f,f);c.lineTo(d-f,e-f);c.lineTo(f,e-f);c.closePath();c.stroke();return a};
SymbolMorph.prototype.drawSymbolRectangleSolid=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.width;c.fillStyle=b.toString();c.beginPath();c.moveTo(0,0);c.lineTo(d,0);c.lineTo(d,e);c.lineTo(0,e);c.closePath();c.fill();return a};SymbolMorph.prototype.drawSymbolCircle=function(a,b){var c=a.getContext("2d"),d=a.width,e=Math.max(d/20,.5);c.strokeStyle=b.toString();c.lineWidth=2*e;c.arc(d/2,d/2,d/2-e,radians(0),radians(360),!1);c.stroke();return a};
SymbolMorph.prototype.drawSymbolCircleSolid=function(a,b){var c=a.getContext("2d"),d=a.width;c.fillStyle=b.toString();c.arc(d/2,d/2,d/2,radians(0),radians(360),!1);c.fill();return a};SymbolMorph.prototype.drawSymbolLine=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=Math.max(d/20,.5);c.strokeStyle=b.toString();c.lineWidth=2*f;c.lineCap="round";c.moveTo(f,f);c.lineTo(d-f,e-f);c.stroke();return a};
SymbolMorph.prototype.drawSymbolCross=function(a,b){var c=a.getContext("2d"),d=a.width,e=Math.max(d/20,.5);c.strokeStyle=b.toString();c.lineWidth=2*e;c.lineCap="round";c.moveTo(e,d/2);c.lineTo(d-e,d/2);c.stroke();c.moveTo(d/2,e);c.lineTo(d/2,d-e);c.stroke();return a};
SymbolMorph.prototype.drawSymbolCrosshairs=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height;c.strokeStyle=b.toString();c.lineWidth=1;c.moveTo(.5,e/2);c.lineTo(d-.5,e/2);c.stroke();c.moveTo(d/2,.5);c.lineTo(d/2,e-.5);c.stroke();c.moveTo(d/2,e/2);c.arc(d/2,d/2,d/3-.5,radians(0),radians(360),!1);c.stroke();return a};
SymbolMorph.prototype.drawSymbolPaintbucket=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=a.width/5,g=Math.max(d/30,.5);c.strokeStyle=b.toString();c.lineWidth=2*g;c.beginPath();c.moveTo(2*f,f);c.lineTo(4*f,3*f);c.lineTo(3*f,4*f);c.quadraticCurveTo(2*f,e,f,4*f);c.quadraticCurveTo(0,3*f,f,2*f);c.closePath();c.stroke();c.lineWidth=g;c.moveTo(2*f,2.5*f);c.arc(2*f,2.5*f,g,radians(0),radians(360),!1);c.stroke();c.moveTo(2*f,2.5*f);c.lineTo(2*f,f/2+g);c.stroke();c.arc(1.5*f,f/2+g,f/2,radians(0),
radians(180),!0);c.stroke();c.moveTo(f,f/2+g);c.lineTo(f,2*f);c.stroke();c.fillStyle=b.toString();c.beginPath();c.moveTo(3.5*f,3.5*f);c.quadraticCurveTo(d,3.5*f,d-g,e);c.lineTo(d,e);c.quadraticCurveTo(d,2*f,2.5*f,1.5*f);c.lineTo(4*f,3*f);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolEraser=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=a.width/4,g=Math.max(d/20,.5);c.strokeStyle=b.toString();c.lineWidth=2*g;c.beginPath();c.moveTo(3*f,g);c.lineTo(g,3*f);c.quadraticCurveTo(f,e,2*f,3*f);c.lineTo(d-g,f);c.closePath();c.stroke();c.fillStyle=b.toString();c.beginPath();c.moveTo(3*f,0);c.lineTo(1.5*f,1.5*f);c.lineTo(2.5*f,2.5*f);c.lineTo(d,f);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolPipette=function(a,b){var c=a.getContext("2d"),d=a.height,e=a.width/4,f=e/2,g=Math.max(a.width/20,.5);c.strokeStyle=b.toString();c.lineWidth=2*g;c.beginPath();c.moveTo(g,d-g);c.quadraticCurveTo(f,d-f,f,d-e);c.lineTo(2*e,1.5*e);c.stroke();c.beginPath();c.moveTo(g,d-g);c.quadraticCurveTo(f,d-f,e,d-f);c.lineTo(2.5*e,2*e);c.stroke();c.fillStyle=b.toString();c.arc(3*e,e,e-g,radians(0),radians(360),!1);c.fill();c.beginPath();c.moveTo(2*e,e);c.lineTo(3*e,2*e);c.stroke();return a};
SymbolMorph.prototype.drawSymbolSpeechBubble=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=a.width/3,g=Math.max(d/20,.5);c.fillStyle=b.toString();c.lineWidth=2*g;c.beginPath();c.moveTo(f,2*f);c.quadraticCurveTo(g,2*f,g,f);c.quadraticCurveTo(g,g,f,g);c.lineTo(2*f,g);c.quadraticCurveTo(d-g,g,d-g,f);c.quadraticCurveTo(d-g,2*f,2*f,2*f);c.lineTo(f/2,e-g);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolSpeechBubbleOutline=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=a.width/3,g=Math.max(d/20,.5);c.strokeStyle=b.toString();c.lineWidth=2*g;c.beginPath();c.moveTo(f,2*f);c.quadraticCurveTo(g,2*f,g,f);c.quadraticCurveTo(g,g,f,g);c.lineTo(2*f,g);c.quadraticCurveTo(d-g,g,d-g,f);c.quadraticCurveTo(d-g,2*f,2*f,2*f);c.lineTo(f/2,e-g);c.closePath();c.stroke();return a};
SymbolMorph.prototype.drawSymbolTurnBack=function(a,b){var c=a.getContext("2d"),d=a.height,e=a.width/2,f=a.height/2,g=Math.max(a.width/20,.5);c.fillStyle=b.toString();c.lineWidth=2*g;c.beginPath();c.moveTo(0,f);c.lineTo(e,0);c.lineTo(e,d);c.closePath();c.fill();c.lineWidth=3*g;c.strokeStyle=b.toString();c.beginPath();c.arc(e,d,f,radians(0),radians(-90),!0);c.stroke();return a};
SymbolMorph.prototype.drawSymbolTurnForward=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=a.width/2,g=a.height/2,h=Math.max(d/20,.5);c.fillStyle=b.toString();c.lineWidth=2*h;c.beginPath();c.moveTo(d,g);c.lineTo(f,0);c.lineTo(f,e);c.closePath();c.fill();c.lineWidth=3*h;c.strokeStyle=b.toString();c.beginPath();c.arc(f,e,g,radians(-180),radians(-90),!1);c.stroke();return a};
SymbolMorph.prototype.drawSymbolArrowUp=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=a.width/2,g=Math.max(d/20,.5);c.fillStyle=b.toString();c.lineWidth=2*g;c.beginPath();c.moveTo(g,f);c.lineTo(f,g);c.lineTo(d-g,f);c.lineTo(.65*d,f);c.lineTo(.65*d,e-g);c.lineTo(.35*d,e-g);c.lineTo(.35*d,f);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolArrowUpOutline=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=a.width/2,g=Math.max(d/20,.5);c.strokeStyle=b.toString();c.lineWidth=2*g;c.beginPath();c.moveTo(g,f);c.lineTo(f,g);c.lineTo(d-g,f);c.lineTo(.65*d,f);c.lineTo(.65*d,e-g);c.lineTo(.35*d,e-g);c.lineTo(.35*d,f);c.closePath();c.stroke();return a};
SymbolMorph.prototype.drawSymbolArrowDown=function(a,b){var c=a.getContext("2d"),d=a.width;c.save();c.translate(d,d);c.rotate(radians(180));this.drawSymbolArrowUp(a,b);c.restore();return a};SymbolMorph.prototype.drawSymbolArrowDownOutline=function(a,b){var c=a.getContext("2d"),d=a.width;c.save();c.translate(d,d);c.rotate(radians(180));this.drawSymbolArrowUpOutline(a,b);c.restore();return a};
SymbolMorph.prototype.drawSymbolArrowLeft=function(a,b){var c=a.getContext("2d"),d=a.width;c.save();c.translate(0,d);c.rotate(radians(-90));this.drawSymbolArrowUp(a,b);c.restore();return a};SymbolMorph.prototype.drawSymbolArrowLeftOutline=function(a,b){var c=a.getContext("2d"),d=a.width;c.save();c.translate(0,d);c.rotate(radians(-90));this.drawSymbolArrowUpOutline(a,b);c.restore();return a};
SymbolMorph.prototype.drawSymbolArrowRight=function(a,b){var c=a.getContext("2d"),d=a.width;c.save();c.translate(d,0);c.rotate(radians(90));this.drawSymbolArrowUp(a,b);c.restore();return a};SymbolMorph.prototype.drawSymbolArrowRightOutline=function(a,b){var c=a.getContext("2d"),d=a.width;c.save();c.translate(d,0);c.rotate(radians(90));this.drawSymbolArrowUpOutline(a,b);c.restore();return a};
SymbolMorph.prototype.drawSymbolRobot=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=a.width/6,g=f/2,h=Math.max(d/20,.5);c.fillStyle=b.toString();c.beginPath();c.moveTo(f+h,f);c.lineTo(2*f,f);c.lineTo(2.5*f,1.5*f);c.lineTo(3.5*f,1.5*f);c.lineTo(4*f,f);c.lineTo(5*f-h,f);c.lineTo(4*f,3*f);c.lineTo(4*f,4*f-h);c.lineTo(2*f,4*f-h);c.lineTo(2*f,3*f);c.closePath();c.fill();c.beginPath();c.moveTo(2.75*f,f+h);c.lineTo(2.4*f,f);c.lineTo(2.2*f,0);c.lineTo(3.8*f,0);c.lineTo(3.6*f,f);c.lineTo(3.25*
f,f+h);c.closePath();c.fill();c.beginPath();c.moveTo(2.5*f,4*f);c.lineTo(f,4*f);c.lineTo(g+h,e);c.lineTo(2*f,e);c.closePath();c.fill();c.beginPath();c.moveTo(3.5*f,4*f);c.lineTo(5*f,4*f);c.lineTo(d-(g+h),e);c.lineTo(4*f,e);c.closePath();c.fill();c.beginPath();c.moveTo(f,f);c.lineTo(h,1.5*f);c.lineTo(h,3.25*f);c.lineTo(1.5*f,3.5*f);c.closePath();c.fill();c.beginPath();c.moveTo(5*f,f);c.lineTo(d-h,1.5*f);c.lineTo(d-h,3.25*f);c.lineTo(4.5*f,3.5*f);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolMagnifyingGlass=function(a,b){var c=a.getContext("2d");var d=a.width;var e=a.height,f=.3*d,g=2*d/3-Math.sqrt(f),h=e/3+Math.sqrt(f),k=Math.max(d/5,.5);c.strokeStyle=b.toString();d=c.createRadialGradient(g,h,0,g+f,h+f,d);d.addColorStop(0,b.inverted().lighter(50).toString());d.addColorStop(1,b.inverted().darker(25).toString());c.fillStyle=d;c.arc(g,h,f,radians(0),radians(360),!1);c.fill();c.lineWidth=k/2;c.arc(g,h,f,radians(0),radians(360),!1);c.stroke();c.lineWidth=k;
c.beginPath();c.moveTo(k/2,e-k/2);c.lineTo(g-Math.sqrt(f+k),h+Math.sqrt(f+k));c.closePath();c.stroke();return a};SymbolMorph.prototype.drawSymbolMagnifierOutline=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=.3*d,g=2*d/3-Math.sqrt(f),h=e/3+Math.sqrt(f);d=Math.max(d/5,.5);c.strokeStyle=b.toString();c.lineWidth=.5*d;c.arc(g,h,f,radians(0),radians(360),!1);c.stroke();c.lineWidth=d;c.beginPath();c.moveTo(d/2,e-d/2);c.lineTo(g-Math.sqrt(f+d),h+Math.sqrt(f+d));c.closePath();c.stroke();return a};
SymbolMorph.prototype.drawSymbolNotes=function(a,b){var c=a.getContext("2d"),d=a.width,e=d/6,f=Math.max(e/3,1);c.strokeStyle=b.toString();c.fillStyle=b.toString();c.arc(e,d-e,e,radians(0),radians(360),!1);c.fill();c.arc(d-e,d-2*e,e,radians(0),radians(360),!1);c.fill();c.beginPath();c.moveTo(2*e-f,e);c.lineTo(d,0);c.lineTo(d,e);c.lineTo(2*e-f,2*e);c.closePath();c.fill();c.lineWidth=f;c.beginPath();c.moveTo(2*e-f/2,d-e);c.lineTo(2*e-f/2,e+f);c.stroke();c.beginPath();c.moveTo(d-f/2,d-2*e);c.lineTo(d-
f/2,f);c.stroke();return a};
SymbolMorph.prototype.drawSymbolCamera=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.width,f=.16*d,g=Math.max(d/20,.5);c.lineWidth=2*g;c.fillStyle=b.toString();c.beginPath();c.moveTo(g,5*e/6);c.lineTo(d-g,5*e/6);c.lineTo(d-g,e/4);c.lineTo(3*d/4,e/4);c.lineTo(5*d/8,g);c.lineTo(3*d/8,g);c.lineTo(d/4,e/4);c.lineTo(g,e/4);c.closePath();c.fill();c.save();c.globalCompositeOperation="destination-out";c.beginPath();c.arc(d/2,e/2,f,radians(0),radians(360),!1);c.fill();c.restore();return a};
SymbolMorph.prototype.drawSymbolLocation=function(a,b){var c=a.getContext("2d"),d=a.height,e=a.width/2;c.fillStyle=b.toString();c.beginPath();c.arc(e,e,e,radians(-210),radians(30),!1);c.lineTo(e,d);c.closePath();c.fill();c.globalCompositeOperation="destination-out";c.beginPath();c.arc(e,e,.5*e,radians(0),radians(360),!1);c.closePath();c.fill();return a};
SymbolMorph.prototype.drawSymbolFootprints=function(a,b){var c=a.getContext("2d"),d=a.width,e=d/10,f=1.5*e;c.fillStyle=b.toString();c.beginPath();c.arc(f,f,f,radians(-200),radians(0),!1);c.lineTo(2*f,5.5*e);c.lineTo(e,6*e);c.closePath();c.fill();c.beginPath();c.arc(2.25*e,6.75*e,e,radians(-40),radians(-170),!1);c.closePath();c.fill();c.beginPath();c.arc(d-f,4.5*e,f,radians(-180),radians(20),!1);c.lineTo(d-e,8.5*e);c.lineTo(d-2*f,8*e);c.closePath();c.fill();c.beginPath();c.arc(d-2.25*e,9*e,e,radians(0),
radians(-150),!1);c.closePath();c.fill();return a};SymbolMorph.prototype.drawSymbolKeyboard=function(a,b){var c=a.getContext("2d"),d=a.height,e=d/10;d/=5;var f;c.fillStyle=b.toString();for(b=0;2>b;b+=1)for(f=0;5>f;f+=1)c.fillRect((e+d)*f+e,(e+d)*b+e,d,d);c.fillRect(4*e,7*e,4*d,d);return a};
SymbolMorph.prototype.drawSymbolKeyboardFilled=function(a,b){var c=a.getContext("2d"),d=a.width,e=a.height,f=e/10,g=e/5;c.fillStyle=b.toString();c.fillRect(0,0,d,e);c.globalCompositeOperation="destination-out";for(b=0;2>b;b+=1)for(d=0;5>d;d+=1)c.fillRect((f+g)*d+f,(f+g)*b+f,g,g);c.fillRect(4*f,7*f,4*g,g);return a};modules.xml="2017-November-15";function ReadStream(a){this.contents=a||"";this.index=0}ReadStream.prototype.nonSpace=/\S|$/g;ReadStream.prototype.nonWord=/[\s\>\/\=]|$/g;ReadStream.prototype.next=function(a){if(void 0===a)return a=this.contents[this.index],this.index+=1,a;var b=this.index;this.index+=a;return this.contents.slice(b,this.index)};ReadStream.prototype.peek=function(){return this.contents[this.index]};ReadStream.prototype.skip=function(a){this.index+=a||1};
ReadStream.prototype.atEnd=function(){return this.index>this.contents.length-1};ReadStream.prototype.upTo=function(a){a=this.contents.indexOf(a,this.index);return-1===a?"":this.contents.slice(this.index,this.index=a)};ReadStream.prototype.peekUpTo=function(a){a=this.contents.indexOf(a,this.index);return-1===a?"":this.contents.slice(this.index,a)};ReadStream.prototype.skipSpace=function(){this.nonSpace.lastIndex=this.index;var a=this.nonSpace.exec(this.contents);a&&(this.index=a.index)};
ReadStream.prototype.word=function(){this.nonWord.lastIndex=this.index;var a=this.nonWord.exec(this.contents);return a?this.contents.slice(this.index,this.index=a.index):""};XML_Element.prototype=Object.create(Node.prototype);XML_Element.prototype.constructor=XML_Element;XML_Element.uber=Node.prototype;XML_Element.prototype.indentation="  ";function XML_Element(a,b,c){this.init(a,b,c)}
XML_Element.prototype.init=function(a,b,c){this.tag=a||"unnamed";this.attributes={};this.contents=b||"";XML_Element.uber.init.call(this);c&&c.addChild(this)};XML_Element.prototype.require=function(a){var b=this.childNamed(a);if(!b)throw Error("Missing required element <"+a+">!");return b};XML_Element.prototype.childNamed=function(a){return detect(this.children,function(b){return b.tag===a})};XML_Element.prototype.childrenNamed=function(a){return this.children.filter(function(b){return b.tag===a})};
XML_Element.prototype.parentNamed=function(a){return this.tag===a?this:this.parent?this.parent.parentNamed(a):null};
XML_Element.prototype.toString=function(a,b){var c="",d="",e=b||0,f;if(a){for(b=0;b<e;b+=1)d+=this.indentation;c+=d}c+="<"+this.tag;for(f in this.attributes)Object.prototype.hasOwnProperty.call(this.attributes,f)&&this.attributes[f]&&(c+=" "+f+'="'+this.escape(this.attributes[f])+'"');this.contents.length||this.children.length?(c+=">",c+=this.escape(this.contents),this.children.forEach(function(b){a&&(c+="\n");c+=b.toString(a,e+1)}),a&&this.children.length&&(c+="\n"+d),c+="</"+this.tag+">"):c+="/>";
return c};XML_Element.prototype.escape=function(a,b){a=isNil(a)?"":a.toString();var c="",d;for(d=0;d<a.length;d+=1){var e=a[d];switch(e){case "'":c+="&apos;";break;case '"':c+=b?e:"&quot;";break;case "<":c+="&lt;";break;case ">":c+="&gt;";break;case "&":c+="&amp;";break;case "\n":c+="&#xD;";break;case "~":c+="&#126;";break;default:c+=e}}return c};
XML_Element.prototype.unescape=function(a){return a.replace(/&(amp|apos|quot|lt|gt|#xD|#126);/g,function(a,c){switch(c){case "amp":return"&";case "apos":return"'";case "quot":return'"';case "lt":return"<";case "gt":return">";case "#xD":return"\n";case "#126":return"~";default:console.warn("unreachable")}})};XML_Element.prototype.parseString=function(a){a=new ReadStream(a);a.upTo("<");a.skip();this.parseStream(a)};
XML_Element.prototype.parseStream=function(a){var b;this.tag=a.word();a.skipSpace();for(b=a.peek();">"!==b&&"/"!==b;){var c=a.word();a.skipSpace();if("="!==a.next())throw Error('Expected "=" after attribute name');a.skipSpace();b=a.next();if('"'!==b&&"'"!==b)throw Error("Expected single- or double-quoted attribute value");b=a.upTo(b);a.skip(1);a.skipSpace();this.attributes[c]=this.unescape(b);b=a.peek()}if("/"===b){if(a.skip(),">"!==a.next())throw Error('Expected ">" after "/" in empty tag');}else{if(">"!==
a.next())throw Error('Expected ">" after tag name and attributes');for(;!a.atEnd();)if(b=a.next(),"<"===b){if("/"===a.peek()){a.skip();if(a.word()!==this.tag)throw Error("Expected to close "+this.tag);a.upTo(">");a.skip();this.contents=this.unescape(this.contents);break}c=new XML_Element(null,null,this);c.parseStream(a)}else this.contents+=b}};modules.store="2017-October-28";function XML_Serializer(){this.contents=[];this.media=[];this.isExportingBlocksLibrary=this.isCollectingMedia=!1}XML_Serializer.prototype.idProperty="serializationID";XML_Serializer.prototype.mediaIdProperty="serializationMediaID";XML_Serializer.prototype.mediaDetectionProperty="isMedia";XML_Serializer.prototype.version=1;XML_Serializer.prototype.serialize=function(a,b){this.flush();this.flushMedia();this.isExportingBlocksLibrary=b;a=this.store(a);this.flush();return a};
XML_Serializer.prototype.store=function(a,b){if(isNil(a)||!a.toXML)return"";if(this.isCollectingMedia&&a[this.mediaDetectionProperty])return this.addMedia(a,b),this.format('<ref mediaID="@"></ref>',a[this.mediaIdProperty]);if(a[this.idProperty])return this.format('<ref id="@"></ref>',a[this.idProperty]);this.add(a);return a.toXML(this,b).replace("~",this.format('id="@"',a[this.idProperty]))};
XML_Serializer.prototype.mediaXML=function(){var a="<media>",b=this;this.media.forEach(function(c){c=c.toXML(b).replace("~",b.format('mediaID="@"',c[b.mediaIdProperty]));a+=c});return a+"</media>"};XML_Serializer.prototype.add=function(a){if(a[this.idProperty])return-1;this.contents.push(a);return a[this.idProperty]=this.contents.length};XML_Serializer.prototype.addMedia=function(a,b){if(a[this.mediaIdProperty])return-1;this.media.push(a);a[this.mediaIdProperty]=b?b+"_"+a.name:this.media.length;return this.media.length};
XML_Serializer.prototype.at=function(a){return this.contents[a-1]};XML_Serializer.prototype.flush=function(){var a=this;this.contents.forEach(function(b){delete b[a.idProperty]});this.contents=[]};XML_Serializer.prototype.flushMedia=function(){var a=this;this.media instanceof Array&&this.media.forEach(function(b){delete b[a.mediaIdProperty]});this.media=[];this.isExportingBlocksLibrary=!1};XML_Serializer.prototype.escape=XML_Element.prototype.escape;XML_Serializer.prototype.unescape=XML_Element.prototype.unescape;
XML_Serializer.prototype.format=function(a){var b=this,c=-1,d=arguments,e;return a.replace(/[@$%]([\d]+)?/g,function(a,g){g=parseInt(g,10);isNaN(g)?(c+=1,e=d[c+1]):e=d[g+1];return"@"===a?b.escape(e):"$"===a?b.escape(e,!0):e})};XML_Serializer.prototype.load=function(a){nop(a);throw Error("loading should be implemented in heir of XML_Serializer");};XML_Serializer.prototype.parse=function(a){var b=new XML_Element;b.parseString(a);return b};SnapSerializer.prototype=new XML_Serializer;
SnapSerializer.prototype.constructor=SnapSerializer;SnapSerializer.uber=XML_Serializer.prototype;SnapSerializer.prototype.app="Snap! 4.1, http://snap.berkeley.edu";SnapSerializer.prototype.thumbnailSize=new Point(160,120);SnapSerializer.prototype.watcherLabels={xPosition:"x position",yPosition:"y position",direction:"direction",getScale:"size",getTempo:"tempo",getLastAnswer:"answer",getLastMessage:"message",getTimer:"timer",getCostumeIdx:"costume #",reportMouseX:"mouse x",reportMouseY:"mouse y",reportThreadCount:"processes"};
function SnapSerializer(){this.init()}SnapSerializer.prototype.init=function(){this.project={};this.objects={};this.mediaDict={}};XML_Serializer.prototype.mediaXML=function(a){var b='<media name="'+(a||"untitled")+'" app="'+this.app+'" version="'+this.version+'">',c=this;this.media.forEach(function(a){a=a.toXML(c).replace("~",c.format('mediaID="@"',a[c.mediaIdProperty]));b+=a});return b+"</media>"};SnapSerializer.prototype.load=function(a,b){return this.loadProjectModel(this.parse(a),b)};
SnapSerializer.prototype.loadProjectModel=function(a,b){var c=a.attributes.app;c=c?c.split(" ")[0]:null;b&&c&&c!==this.app.split(" ")[0]&&b.inform(c+" Project","This project has been created by a different app:\n\n"+c+"\n\nand may be incompatible or fail to load here.");return this.rawLoadProjectModel(a)};
SnapSerializer.prototype.rawLoadProjectModel=function(a){var b,c,d=this,e={sprites:{}};this.project=e;var f=c=c=c=c=c=f=b=b=void 0;if(+a.attributes.version>this.version)throw"Project uses newer version of Serializer";this.objects={};e.name=a.attributes.name;if(!e.name){for(b=1;Object.prototype.hasOwnProperty.call(localStorage,"-snap-project-Untitled "+b);)b+=1;e.name="Untitled "+b}if(b=a.childNamed("notes"))e.notes=b.contents;b=a.childNamed("variables");e.globalVariables=new VariableFrame;f=a.require("stage");
StageMorph.prototype.frameRate=0;e.stage=new StageMorph(e.globalVariables);Object.prototype.hasOwnProperty.call(f.attributes,"id")&&(this.objects[f.attributes.id]=e.stage);f.attributes.name&&(e.stage.name=f.attributes.name);"true"===f.attributes.scheduled&&(e.stage.fps=30,StageMorph.prototype.frameRate=30);if(c=f.childNamed("pentrails"))e.pentrails=new Image,e.pentrails.onload=function(){e.stage.trailsCanvas&&(normalizeCanvas(e.stage.trailsCanvas),e.stage.trailsCanvas.getContext("2d").drawImage(e.pentrails,
0,0),e.stage.changed())},e.pentrails.src=c.contents;e.stage.setTempo(f.attributes.tempo);StageMorph.prototype.dimensions=new Point(480,360);f.attributes.width&&(StageMorph.prototype.dimensions.x=Math.max(+f.attributes.width,480));f.attributes.height&&(StageMorph.prototype.dimensions.y=Math.max(+f.attributes.height,180));e.stage.setExtent(StageMorph.prototype.dimensions);SpriteMorph.prototype.useFlatLineEnds="flat"===f.attributes.lines;BooleanSlotMorph.prototype.isTernary="false"!==f.attributes.ternary;
e.stage.isThreadSafe="true"===f.attributes.threadsafe;StageMorph.prototype.enableCodeMapping="true"===f.attributes.codify;StageMorph.prototype.enableInheritance="false"!==f.attributes.inheritance;StageMorph.prototype.enableSublistIDs="true"===f.attributes.sublistIDs;(c=a.childNamed("hidden"))&&c.contents.split(" ").forEach(function(a){a&&(StageMorph.prototype.hiddenPrimitives[a]=!0)});(c=a.childNamed("headers"))&&c.children.forEach(function(a){StageMorph.prototype.codeHeaders[a.tag]=a.contents});
(c=a.childNamed("code"))&&c.children.forEach(function(a){StageMorph.prototype.codeMappings[a.tag]=a.contents});if(c=a.childNamed("blocks"))this.loadCustomBlocks(e.stage,c,!0),this.populateCustomBlocks(e.stage,c,!0);this.loadObject(e.stage,f);f=f.require("sprites");e.sprites[e.stage.name]=e.stage;f.childrenNamed("sprite").forEach(function(a){d.loadValue(a)});d.project.stage.children.forEach(function(a){var b;a.inheritanceInfo&&((b=d.project.sprites[a.inheritanceInfo.exemplar])&&a.setExemplar(b),a.inheritedAttributes=
a.inheritanceInfo.delegated||[]);a.nestingInfo&&((b=d.project.sprites[a.nestingInfo.anchor])&&b.attachPart(a),a.rotatesWithAnchor="true"===a.nestingInfo.synch)});d.project.stage.children.forEach(function(a){var b;a.nestingInfo&&(a.nestingScale=+(a.nestingInfo.scale||a.scale),delete a.nestingInfo);["scripts","costumes","sounds"].forEach(function(b){a.inheritsAttribute(b)&&a.refreshInheritedAttribute(b)});a.inheritsAttribute("costumes")&&(b=a.costumes.asArray()[a.inheritanceInfo.costumeNumber-1])&&
(b.loaded?a.wearCostume(b,!0):b.loaded=function(){a.wearCostume(b,!0);this.loaded=!0});delete a.inheritanceInfo});b&&this.loadVariables(e.globalVariables,b);this.objects={};f.childrenNamed("watcher").forEach(function(a){var b=d.loadColor(a.attributes.color);var c=Object.prototype.hasOwnProperty.call(a.attributes,"scope")?e.sprites[a.attributes.scope]:null;var f=Object.prototype.hasOwnProperty.call(a.attributes,"hidden")&&"false"!==a.attributes.hidden;b=Object.prototype.hasOwnProperty.call(a.attributes,
"var")?new WatcherMorph(a.attributes["var"],b,isNil(c)?e.globalVariables:c.variables,a.attributes["var"],f):new WatcherMorph(localize(d.watcherLabels[a.attributes.s]),b,c,a.attributes.s,f);b.setStyle(a.attributes.style||"normal");"slider"===b.style&&(b.setSliderMin(a.attributes.min||"1",!0),b.setSliderMax(a.attributes.max||"100",!0));b.setPosition(e.stage.topLeft().add(new Point(+a.attributes.x||0,+a.attributes.y||0)));e.stage.add(b);b.onNextStep=function(){this.currentValue=null};b.currentValue instanceof
List&&((c=a.attributes.extX)&&b.cellMorph.contentsMorph.setWidth(+c),(a=a.attributes.extY)&&b.cellMorph.contentsMorph.setHeight(+a),b.cellMorph.contentsMorph.handle.drawNew())});d.project.stage.children.forEach(function(a){a.inheritedMethodsCache=[]});this.objects={};return e};
SnapSerializer.prototype.loadBlocks=function(a,b){var c=new StageMorph;this.project={stage:c,sprites:{},targetStage:b};a=this.parse(a);if(+a.attributes.version>this.version)throw"Module uses newer version of Serializer";this.loadCustomBlocks(c,a,!0);this.populateCustomBlocks(c,a,!0);this.objects={};c.globalBlocks.forEach(function(a){a.receiver=null});this.objects={};this.project={};this.mediaDict={};return c.globalBlocks};
SnapSerializer.prototype.loadSprites=function(a,b){var c=this;var d=this.project={globalVariables:b.globalVariables,stage:b.stage,sprites:{}};d.sprites[d.stage.name]=d.stage;a=this.parse(a);if(+a.attributes.version>this.version)throw"Module uses newer version of Serializer";a.childrenNamed("sprite").forEach(function(a){var e=new SpriteMorph(d.globalVariables);a.attributes.id&&(c.objects[a.attributes.id]=e);a.attributes.name&&(e.name=b.newSpriteName(a.attributes.name),d.sprites[e.name]=e);a.attributes.color&&
(e.color=c.loadColor(a.attributes.color));a.attributes.pen&&(e.penPoint=a.attributes.pen);d.stage.add(e);b.sprites.add(e);e.scale=parseFloat(a.attributes.scale||"1");e.rotationStyle=parseFloat(a.attributes.rotation||"1");e.isDraggable="false"!==a.attributes.draggable;e.isVisible="true"!==a.attributes.hidden;e.heading=parseFloat(a.attributes.heading)||0;e.drawNew();e.gotoXY(+a.attributes.x||0,+a.attributes.y||0);c.loadObject(e,a)});d.stage.children.forEach(function(a){var b;a.inheritanceInfo&&(b=d.sprites[a.inheritanceInfo.exemplar])&&
a.setExemplar(b);a.nestingInfo&&((b=d.sprites[a.nestingInfo.anchor])&&b.attachPart(a),a.rotatesWithAnchor="true"===a.nestingInfo.synch)});d.stage.children.forEach(function(a){delete a.inheritanceInfo;a.nestingInfo&&(a.nestingScale=+(a.nestingInfo.scale||a.scale),delete a.nestingInfo)});this.objects={};this.project={};this.mediaDict={};b.createCorral();b.fixLayout()};SnapSerializer.prototype.loadMedia=function(a){return this.loadMediaModel(this.parse(a))};
SnapSerializer.prototype.loadMediaModel=function(a){var b=this;this.mediaDict={};if(+a.attributes.version>this.version)throw"Module uses newer version of Serializer";a.children.forEach(function(a){b.loadValue(a)});return this.mediaDict};
SnapSerializer.prototype.loadObject=function(a,b){var c=b.require("blocks"),d=b.childNamed("dispatches");b.attributes.instrument&&(a.instrument=+b.attributes.instrument);this.loadInheritanceInfo(a,b);this.loadNestingInfo(a,b);a.inheritanceInfo&&a.inheritanceInfo.delegated instanceof Array&&contains(a.inheritanceInfo.delegated,"costumes")||this.loadCostumes(a,b);a.inheritanceInfo&&a.inheritanceInfo.delegated instanceof Array&&contains(a.inheritanceInfo.delegated,"sounds")||this.loadSounds(a,b);this.loadCustomBlocks(a,
c);d&&this.loadCustomBlocks(a,d,!1,!0);this.populateCustomBlocks(a,c);this.loadVariables(a.variables,b.require("variables"),a);a.inheritanceInfo&&a.inheritanceInfo.delegated instanceof Array&&contains(a.inheritanceInfo.delegated,"scripts")||this.loadScripts(a,a.scripts,b.require("scripts"))};
SnapSerializer.prototype.loadInheritanceInfo=function(a,b){var c=b.childNamed("inherit");if(c){a.inheritanceInfo=c.attributes;if(c=c.childNamed("list"))a.inheritanceInfo.delegated=this.loadValue(c).asArray();a.inheritanceInfo.costumeNumber=b.attributes.costume}};SnapSerializer.prototype.loadNestingInfo=function(a,b){if(b=b.childNamed("nest"))a.nestingInfo=b.attributes};
SnapSerializer.prototype.loadCostumes=function(a,b){var c=b.childNamed("costumes"),d;c&&(a.costumes=this.loadValue(c.require("list")),a.costumes.type="costume");Object.prototype.hasOwnProperty.call(b.attributes,"costume")&&(d=a.costumes.asArray()[b.attributes.costume-1])&&(d.loaded?a.wearCostume(d,!0):d.loaded=function(){a.wearCostume(d,!0);this.loaded=!0})};SnapSerializer.prototype.loadSounds=function(a,b){if(b=b.childNamed("sounds"))a.sounds=this.loadValue(b.require("list")),a.sounds.type="sound"};
SnapSerializer.prototype.loadVariables=function(a,b,c){var d=this;b.children.forEach(function(b){if("variable"===b.tag){var e=b.children[0];var g=new Variable;g.isTransient="true"===b.attributes.transient;g.value=g.isTransient||!e?0:d.loadValue(e,c);a.vars[b.attributes.name]=g}})};
SnapSerializer.prototype.loadCustomBlocks=function(a,b,c,d){var e=this;b.children.forEach(function(b){var f;if("block-definition"===b.tag){var h=new CustomBlockDefinition(b.attributes.s||"",a);h.category=b.attributes.category||"other";h.type=b.attributes.type||"command";h.isGlobal=!0===c;d?a.inheritedMethodsCache.push(h):h.isGlobal?a.globalBlocks.push(h):a.customBlocks.push(h);var k=h.parseSpec(h.spec).filter(function(a){return"%"===a.charAt(0)&&1<a.length}).map(function(a){return a.substr(1)});h.names=
k;if(f=b.childNamed("inputs")){var l=-1;f.children.forEach(function(a){var b=a.childNamed("options");"input"===a.tag&&(l+=1,h.declarations[k[l]]=[a.attributes.type,contains(["%b","%boolUE"],a.attributes.type)?a.contents?"true"===a.contents:null:a.contents,b?b.contents:void 0,"true"===a.attributes.readonly])})}if(f=b.childNamed("variables"))h.variableNames=e.loadValue(f.require("list")).asArray();if(f=b.childNamed("header"))h.codeHeader=f.contents;if(f=b.childNamed("code"))h.codeMapping=f.contents;
if(b=b.childNamed("comment"))h.comment=e.loadComment(b)}})};SnapSerializer.prototype.populateCustomBlocks=function(a,b,c){var d=this;b.children.forEach(function(b,f){var e;if("block-definition"===b.tag){f=c?a.globalBlocks[f]:a.customBlocks[f];if(e=b.childNamed("script"))f.body=new Context(null,e?d.loadScript(e,a):null,null,a),f.body.inputs=f.names.slice(0);if(b=b.childNamed("scripts"))f.scripts=d.loadScriptsArray(b,a);delete f.names}})};
SnapSerializer.prototype.loadScripts=function(a,b,c){var d=this,e=SyntaxElementMorph.prototype.scale;b.cachedTexture=IDE_Morph.prototype.scriptsPaneTexture;c.children.forEach(function(c){var f;if("script"===c.tag){if(f=d.loadScript(c,a))f.setPosition((new Point((+c.attributes.x||0)*e,(+c.attributes.y||0)*e)).add(b.topLeft())),b.add(f),f.fixBlockColor(null,!0),f.allComments().forEach(function(a){a.align(f)})}else"comment"===c.tag&&(f=d.loadComment(c))&&(f.setPosition((new Point((+c.attributes.x||0)*
e,(+c.attributes.y||0)*e)).add(b.topLeft())),b.add(f))})};SnapSerializer.prototype.loadScriptsArray=function(a,b){var c=this,d=SyntaxElementMorph.prototype.scale,e=[];a.children.forEach(function(a){var f;if("script"===a.tag){if(f=c.loadScript(a,b))f.setPosition(new Point((+a.attributes.x||0)*d,(+a.attributes.y||0)*d)),e.push(f),f.fixBlockColor(null,!0)}else"comment"===a.tag&&(f=c.loadComment(a))&&(f.setPosition(new Point((+a.attributes.x||0)*d,(+a.attributes.y||0)*d)),e.push(f))});return e};
SnapSerializer.prototype.loadScript=function(a,b){var c,d,e,f=this;a.children.forEach(function(a){if(e=f.loadBlock(a,!1,b)){if(d)if(d.nextBlock&&e instanceof CommandBlockMorph)d.nextBlock(e);else return console.log("SNAP: expecting a command but getting a reporter:\n  "+d.blockSpec+"\n  "+e.blockSpec),c;else c=e;d=e}});return c};
SnapSerializer.prototype.loadComment=function(a){var b=new CommentMorph(a.contents),c=SyntaxElementMorph.prototype.scale;b.isCollapsed="true"===a.attributes.collapsed;b.setTextWidth(+a.attributes.w*c);return b};
SnapSerializer.prototype.loadBlock=function(a,b,c){var d,e=0;if("block"===a.tag){if(Object.prototype.hasOwnProperty.call(a.attributes,"var"))return SpriteMorph.prototype.variableBlock(a.attributes["var"]);var f=SpriteMorph.prototype.blockForSelector(a.attributes.s);if(d=SpriteMorph.prototype.blockMigrations[a.attributes.s])e=d.offset}else if("custom-block"===a.tag){var g=(d=a.attributes.scope?!1:!0)?this.project.stage:c;d?(d=detect(g.globalBlocks,function(b){return b.blockSpec()===a.attributes.s}),
!d&&this.project.targetStage&&(d=detect(this.project.targetStage.globalBlocks,function(b){return b.blockSpec()===a.attributes.s}))):d=detect(g.customBlocks,function(b){return b.blockSpec()===a.attributes.s})||(g.inheritedMethodsCache?detect(g.inheritedMethodsCache,function(b){return b.blockSpec()===a.attributes.s}):null);if(!d)return this.obsoleteBlock(b);f="command"===d.type?new CustomCommandBlockMorph(d,!1):new CustomReporterBlockMorph(d,"predicate"===d.type,!1)}null===f&&(f=this.obsoleteBlock(b));
f.isDraggable=!0;var h=f.inputs();a.children.forEach(function(a,b){"variables"===a.tag?this.loadVariables(f.variables,a,c):"comment"===a.tag?(f.comment=this.loadComment(a),f.comment.block=f):"receiver"===a.tag?nop():this.loadInput(a,h[b+e],f,c)},this);f.cachedInputs=null;return f};SnapSerializer.prototype.obsoleteBlock=function(a){a=a?new ReporterBlockMorph:new CommandBlockMorph;a.selector="errorObsolete";a.color=new Color(200,0,20);a.setSpec("Obsolete!");a.isDraggable=!0;return a};
SnapSerializer.prototype.loadInput=function(a,b,c,d){var e=this;if(!isNil(b))if("script"===a.tag){if(a=this.loadScript(a,d))b.add(a),b.fixLayout()}else if("autolambda"===a.tag&&a.children[0]){if(a=this.loadBlock(a.children[0],!0,d))b.silentReplaceInput(b.children[0],a),b.fixLayout()}else if("list"===a.tag){for(;0<b.inputs().length;)b.removeInput();a.children.forEach(function(a){b.addInput();e.loadInput(a,b.children[b.children.length-2],b,d)});b.fixLayout()}else"block"===a.tag||"custom-block"===a.tag?
c.silentReplaceInput(b,this.loadBlock(a,!0,d)):"color"===a.tag?b.setColor(this.loadColor(a.contents)):(c=this.loadValue(a),isNil(c)||isNil(b)||!b.setContents||b.setContents(this.loadValue(a)))};
SnapSerializer.prototype.loadValue=function(a,b){function c(){Object.prototype.hasOwnProperty.call(a.attributes,"id")&&(f.objects[a.attributes.id]=g);Object.prototype.hasOwnProperty.call(a.attributes,"mediaID")&&(f.mediaDict[a.attributes.mediaID]=g)}var d,e,f=this;switch(a.tag){case "ref":if(Object.prototype.hasOwnProperty.call(a.attributes,"id"))return this.objects[a.attributes.id];if(Object.prototype.hasOwnProperty.call(a.attributes,"mediaID"))return this.mediaDict[a.attributes.mediaID];throw Error("expecting a reference id");
case "l":return(d=a.childNamed("option"))?[d.contents]:(e=a.childNamed("bool"))?this.loadValue(e):a.contents;case "bool":return"true"===a.contents;case "list":if(a.attributes.hasOwnProperty("linked")){var g=new List;g.isLinked=!0;c();d=g;var h=a.childrenNamed("item");h.forEach(function(c,d){c=c.children[0];g.first=c?f.loadValue(c,b):0;(c=a.childNamed("list")||a.childNamed("ref"))?g.rest=f.loadValue(c,b):d<h.length-1&&(g.rest=new List,g=g.rest,g.isLinked=!0)});return d}g=new List;c();g.contents=a.childrenNamed("item").map(function(a){return(a=
a.children[0])?f.loadValue(a,b):0});return g;case "sprite":return g=new SpriteMorph(f.project.globalVariables),a.attributes.id&&(f.objects[a.attributes.id]=g),a.attributes.name&&(g.name=a.attributes.name,f.project.sprites[a.attributes.name]=g),a.attributes.idx&&(g.idx=+a.attributes.idx),a.attributes.color&&(g.color=f.loadColor(a.attributes.color)),a.attributes.pen&&(g.penPoint=a.attributes.pen),f.project.stage.add(g),g.scale=parseFloat(a.attributes.scale||"1"),g.rotationStyle=parseFloat(a.attributes.rotation||
"1"),g.isDraggable="false"!==a.attributes.draggable,g.isVisible="true"!==a.attributes.hidden,g.heading=parseFloat(a.attributes.heading)||0,g.drawNew(),g.gotoXY(+a.attributes.x||0,+a.attributes.y||0),f.loadObject(g,a),g;case "context":g=new Context(null);c();if(d=a.childNamed("origin"))if(d=d.childNamed("ref")||d.childNamed("sprite"))g.origin=this.loadValue(d);if(d=a.childNamed("receiver"))if(d=d.childNamed("ref")||d.childNamed("sprite"))g.receiver=this.loadValue(d);var k=g.origin||g.receiver||b;if(d=
a.childNamed("script"))g.expression=this.loadScript(d,k);else if(d=a.childNamed("block")||a.childNamed("custom-block"))g.expression=this.loadBlock(d,null,k);else if(d=a.childNamed("l"))e=d.childNamed("bool"),g.expression=e?new BooleanSlotMorph(this.loadValue(e)):new InputSlotMorph(d.contents);if(g.expression instanceof BlockMorph){var l=0;g.expression.allEmptySlots().forEach(function(a){l+=1;a.bindingID=a instanceof MultiArgMorph?["arguments"]:l});g.emptySlots=l}(d=a.childNamed("inputs"))&&d.children.forEach(function(a){"input"===
a.tag&&g.inputs.push(a.contents)});(d=a.childNamed("variables"))&&this.loadVariables(g.variables,d,k);if(d=a.childNamed("context"))g.outerContext=this.loadValue(d,k);g.outerContext&&g.receiver&&!g.outerContext.variables.parentFrame&&(g.outerContext.variables.parentFrame=g.receiver.variables);return g;case "costume":d=new Point;Object.prototype.hasOwnProperty.call(a.attributes,"center-x")&&(d.x=parseFloat(a.attributes["center-x"]));Object.prototype.hasOwnProperty.call(a.attributes,"center-y")&&(d.y=
parseFloat(a.attributes["center-y"]));Object.prototype.hasOwnProperty.call(a.attributes,"name")&&(e=a.attributes.name);if(Object.prototype.hasOwnProperty.call(a.attributes,"image")){var m=new Image;0!==a.attributes.image.indexOf("data:image/svg+xml")||MorphicPreferences.rasterizeSVGs?(g=new Costume(null,e,d),m.onload=function(){var a=newCanvas(new Point(m.width,m.height),!0);a.getContext("2d").drawImage(m,0,0);g.contents=a;g.version=+new Date;"function"===typeof g.loaded?g.loaded():g.loaded=!0}):
(g=new SVG_Costume(null,e,d),m.onload=function(){g.contents=m;g.version=+new Date;"function"===typeof g.loaded?g.loaded():g.loaded=!0});m.src=a.attributes.image}c();return g;case "sound":return d=new Audio,d.src=a.attributes.sound,g=new Sound(d,a.attributes.name),Object.prototype.hasOwnProperty.call(a.attributes,"mediaID")&&(f.mediaDict[a.attributes.mediaID]=g),c(),g}};
SnapSerializer.prototype.loadColor=function(a){a=(a||"").split(",");return new Color(parseFloat(a[0]),parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]))};
SnapSerializer.prototype.openProject=function(a,b){var c=b.stage,d=[];a&&a.stage&&(b.projectName=a.name,b.projectNotes=a.notes||"",b.globalVariables&&(b.globalVariables=a.globalVariables),c&&c.destroy(),b.add(a.stage),b.stage=a.stage,d=b.stage.children.filter(function(a){return a instanceof SpriteMorph}),d.sort(function(a,b){return a.idx-b.idx}),b.sprites=new List(d),c=d[0]||a.stage,0<sizeOf(this.mediaDict)?(b.hasChangedMedia=!1,this.mediaDict={}):b.hasChangedMedia=!0,a.stage.drawNew(),b.createCorral(),
b.selectSprite(c),b.fixLayout(),b.world().keyboardReceiver=a.stage)};Array.prototype.toXML=function(a){return this.reduce(function(b,c){return b+a.store(c)},"")};
StageMorph.prototype.toXML=function(a){function b(a){var b="";Object.keys(StageMorph.prototype[a]).forEach(function(c){b+="<"+c+">"+XML_Element.prototype.escape(StageMorph.prototype[a][c])+"</"+c+">"});return b}var c=normalizeCanvas(this.thumbnail(SnapSerializer.prototype.thumbnailSize),!0),d=this.parentThatIsA(IDE_Morph);try{var e=c.toDataURL("image/png")}catch(f){e=null}this.removeAllClones();return a.format('<project name="@" app="@" version="@"><notes>$</notes><thumbnail>$</thumbnail><stage name="@" width="@" height="@" costume="@" tempo="@" threadsafe="@" %lines="@" ternary="@" codify="@" inheritance="@" sublistIDs="@" scheduled="@" ~><pentrails>$</pentrails><costumes>%</costumes><sounds>%</sounds><variables>%</variables><blocks>%</blocks><scripts>%\x3c/scripts><sprites>%</sprites></stage><hidden>$</hidden><headers>%</headers><code>%</code><blocks>%</blocks><variables>%</variables></project>',
d&&d.projectName?d.projectName:localize("Untitled"),a.app,a.version,d&&d.projectNotes?d.projectNotes:"",e,this.name,StageMorph.prototype.dimensions.x,StageMorph.prototype.dimensions.y,this.getCostumeIdx(),this.getTempo(),this.isThreadSafe,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",SpriteMorph.prototype.useFlatLineEnds?"flat":"round",BooleanSlotMorph.prototype.isTernary,this.enableCodeMapping,this.enableInheritance,this.enableSublistIDs,0!==StageMorph.prototype.frameRate,normalizeCanvas(this.trailsCanvas,
!0).toDataURL("image/png"),a.store(this.costumes,this.name+"_cst"),a.store(this.sounds,this.name+"_snd"),a.store(this.variables),a.store(this.customBlocks),a.store(this.scripts),a.store(this.children),Object.keys(StageMorph.prototype.hiddenPrimitives).reduce(function(a,b){return a+" "+b},""),b("codeHeaders"),b("codeMappings"),a.store(this.globalBlocks),d&&d.globalVariables?a.store(d.globalVariables):"")};
SpriteMorph.prototype.toXML=function(a){var b=this.parentThatIsA(StageMorph);b=(b=b?b.parentThatIsA(IDE_Morph):null)?b.sprites.asArray().indexOf(this)+1:0;var c=this.inheritsAttribute("costumes"),d=this.inheritsAttribute("sounds"),e=this.inheritsAttribute("scripts");return a.format('<sprite name="@" idx="@" x="@" y="@" heading="@" scale="@" rotation="@"% draggable="@"% costume="@" color="@,@,@" pen="@" ~>%%'+(c?"%":"<costumes>%</costumes>")+(d?"%":"<sounds>%</sounds>")+"<blocks>%</blocks><variables>%</variables>"+
(this.exemplar?"<dispatches>%</dispatches>":"%")+(e?"%":"<scripts>%\x3c/scripts>")+"</sprite>",this.name,b,this.xPosition(),this.yPosition(),this.heading,this.scale,this.rotationStyle,this.instrument?' instrument="'+parseInt(this.instrument)+'" ':"",this.isDraggable,this.isVisible?"":' hidden="true"',this.getCostumeIdx(),this.color.r,this.color.g,this.color.b,this.penPoint,this.exemplar?'<inherit exemplar="'+this.exemplar.name+'">'+(this.inheritedAttributes.length?a.store(new List(this.inheritedAttributes)):
"")+"</inherit>":"",this.anchor?'<nest anchor="'+this.anchor.name+'" synch="'+this.rotatesWithAnchor+(this.scale===this.nestingScale?"":'" scale="'+this.nestingScale)+'"/>':"",c?"":a.store(this.costumes,this.name+"_cst"),d?"":a.store(this.sounds,this.name+"_snd"),this.customBlocks?a.store(this.customBlocks):"",a.store(this.variables),this.exemplar?a.store(this.inheritedMethods()):"",e?"":a.store(this.scripts))};Costume.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0;
Costume.prototype.toXML=function(a){return a.format('<costume name="@" center-x="@" center-y="@" image="@" ~/>',this.name,this.rotationCenter.x,this.rotationCenter.y,this instanceof SVG_Costume?this.contents.src:normalizeCanvas(this.contents).toDataURL("image/png"))};Sound.prototype[XML_Serializer.prototype.mediaDetectionProperty]=!0;Sound.prototype.toXML=function(a){return a.format('<sound name="@" sound="@" ~/>',this.name,this.toDataURL())};
VariableFrame.prototype.toXML=function(a){var b=this;return Object.keys(this.vars).reduce(function(c,d){var e=b.vars[d].value;d=b.vars[d].isTransient?a.format('<variable name="@" transient="true"/>',d):void 0===e||null===e?a.format('<variable name="@"/>',d):a.format('<variable name="@">%</variable>',d,"object"===typeof e?isSnapObject(e)?"":a.store(e):"boolean"===typeof e?a.format("<bool>$</bool>",e):a.format("<l>$</l>",e));return c+d},"")};
WatcherMorph.prototype.toXML=function(a){var b=this.target instanceof VariableFrame,c=this.currentValue instanceof List,d=this.readoutColor,e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return this.isTemporary()?"":a.format('<watcher% % style="@"% x="@" y="@" color="@,@,@"%%/>',b&&this.target.owner||!b&&this.target?a.format(' scope="@"',b?this.target.owner.name:this.target.name):"",a.format(b?'var="@"':'s="@"',this.getter),this.style,b&&"slider"===this.style?a.format(' min="@" max="@"',
this.sliderMorph.start,this.sliderMorph.stop):"",e.x,e.y,d.r,d.g,d.b,c?a.format(' extX="@" extY="@"',this.cellMorph.contentsMorph.width(),this.cellMorph.contentsMorph.height()):"",this.isVisible?"":' hidden="true"')};ScriptsMorph.prototype.toXML=function(a){return this.children.reduce(function(b,c){return c instanceof BlockMorph?b+c.toScriptXML(a,!0):c instanceof CommentMorph&&!c.block?b+c.toXML(a):b},"")};
BlockMorph.prototype.toXML=BlockMorph.prototype.toScriptXML=function(a,b){var c=SyntaxElementMorph.prototype.scale,d=this;var e=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();b=b?a.format('<script x="@" y="@">',e.x/c,e.y/c):"<script>";do b+=d.toBlockXML(a),d=d.nextBlock();while(d);return b+"\x3c/script>"};BlockMorph.prototype.toBlockXML=function(a){return a.format('<block s="@">%%</block>',this.selector,a.store(this.inputs()),this.comment?this.comment.toXML(a):"")};
ReporterBlockMorph.prototype.toXML=function(a){return"reportGetVar"===this.selector?a.format('<block var="@"/>',this.blockSpec):this.toBlockXML(a)};ReporterBlockMorph.prototype.toScriptXML=function(a,b){var c=SyntaxElementMorph.prototype.scale;var d=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return b?a.format('<script x="@" y="@">%\x3c/script>',d.x/c,d.y/c,this.toXML(a)):a.format("<script>%\x3c/script>",this.toXML(a))};
CustomCommandBlockMorph.prototype.toBlockXML=function(a){var b=this.isGlobal?void 0:"local";return a.format('<custom-block s="@"%>%%%</custom-block>',this.blockSpec,this.isGlobal?"":a.format(' scope="@"',b),a.store(this.inputs()),this.isGlobal&&this.definition.variableNames.length&&!a.isExportingBlocksLibrary?"<variables>"+this.variables.toXML(a)+"</variables>":"",this.comment?this.comment.toXML(a):"")};CustomReporterBlockMorph.prototype.toBlockXML=CustomCommandBlockMorph.prototype.toBlockXML;
CustomBlockDefinition.prototype.toXML=function(a){function b(b){return b.reduce(function(b,c){return c instanceof BlockMorph?b+c.toScriptXML(a,!0):c instanceof CommentMorph&&!c.block?b+c.toXML(a):b},"")}var c=this;return a.format('<block-definition s="@" type="@" category="@">%'+(this.variableNames.length?"<variables>%</variables>":"@")+"<header>@</header><code>@</code><inputs>%</inputs>%%</block-definition>",this.spec,this.type,this.category||"other",this.comment?this.comment.toXML(a):"",this.variableNames.length?
a.store(new List(this.variableNames)):"",this.codeHeader||"",this.codeMapping||"",Object.keys(this.declarations).reduce(function(b,e){return b+a.format('<input type="@"$>$%</input>',c.declarations[e][0],c.declarations[e][3]?' readonly="true"':"",c.declarations[e][1],c.declarations[e][2]?"<options>"+c.declarations[e][2]+"</options>":"")},""),this.body?a.store(this.body.expression):"",0<this.scripts.length?"<scripts>"+b(this.scripts)+"\x3c/scripts>":"")};ArgMorph.prototype.toXML=function(){return"<l/>"};
BooleanSlotMorph.prototype.toXML=function(){return"boolean"===typeof this.value?"<l><bool>"+this.value+"</bool></l>":"<l/>"};InputSlotMorph.prototype.toXML=function(a){return this.constant?a.format("<l><option>$</option></l>",this.constant):a.format("<l>$</l>",this.contents().text)};TemplateSlotMorph.prototype.toXML=function(a){return a.format("<l>$</l>",this.contents())};
CommandSlotMorph.prototype.toXML=function(a){var b=this.children[0];return b instanceof BlockMorph?b instanceof ReporterBlockMorph?a.format("<autolambda>%</autolambda>",a.store(b)):a.store(b):"<script>\x3c/script>"};FunctionSlotMorph.prototype.toXML=CommandSlotMorph.prototype.toXML;MultiArgMorph.prototype.toXML=function(a){return a.format("<list>%</list>",a.store(this.inputs()))};ArgLabelMorph.prototype.toXML=function(a){return a.format("%",a.store(this.inputs()[0]))};
ColorSlotMorph.prototype.toXML=function(a){return a.format("<color>$,$,$,$</color>",this.color.r,this.color.g,this.color.b,this.color.a)};
List.prototype.toXML=function(a,b){if(this.isLinked){var c='<list linked="linked" ~>';if(StageMorph.prototype.enableSublistIDs){var d=this.first;isNil(d)||(c+=a.format("<item>%</item>","object"===typeof d?isSnapObject(d)?"":a.store(d,b):"boolean"===typeof d?a.format("<bool>$</bool>",d):a.format("<l>$</l>",d)));isNil(this.rest)||(c+=a.store(this.rest,b));return c+"</list>"}var e=this;do d=e.first,isNil(d)||(c+=a.format("<item>%</item>","object"===typeof d?isSnapObject(d)?"":a.store(d,b):"boolean"===
typeof d?a.format("<bool>$</bool>",d):a.format("<l>$</l>",d))),e=e.rest;while(!isNil(e));return c+"</list>"}return a.format("<list ~>%</list>",this.contents.reduce(function(c,d){return c+a.format("<item>%</item>","object"===typeof d?isSnapObject(d)?"":a.store(d,b):"boolean"===typeof d?a.format("<bool>$</bool>",d):a.format("<l>$</l>",d))},""))};
Context.prototype.toXML=function(a){return this.isContinuation?"":a.format("<context ~><inputs>%</inputs><variables>%</variables>%<receiver>%</receiver><origin>%</origin>%</context>",this.inputs.reduce(function(b,c){return b+a.format("<input>$</input>",c)},""),this.variables?a.store(this.variables):"",this.expression?a.store(this.expression):"",this.receiver?a.store(this.receiver):"",this.receiver?a.store(this.origin):"",this.outerContext?a.store(this.outerContext):"")};
CommentMorph.prototype.toXML=function(a){var b=SyntaxElementMorph.prototype.scale;if(this.block)return a.format('<comment w="@" collapsed="@">%</comment>',this.textWidth()/b,this.isCollapsed,a.escape(this.text()));var c=this.parent?this.topLeft().subtract(this.parent.topLeft()):this.topLeft();return a.format('<comment x="@" y="@" w="@" collapsed="@">%</comment>',c.x/b,c.y/b,this.textWidth()/b,this.isCollapsed,a.escape(this.text()))};modules.locale="2017-November-15";var SnapTranslator=new Localizer;function localize(a){return a}function Localizer(a,b){this.language=a||"en";this.dict=b||{}}Localizer.prototype.translate=function(a){return Object.prototype.hasOwnProperty.call(this.dict[this.language],a)?this.dict[this.language][a]:a};Localizer.prototype.languages=function(){var a,b=[];for(a in this.dict)Object.prototype.hasOwnProperty.call(this.dict,a)&&b.push(a);return b.sort()};
Localizer.prototype.languageName=function(a){return this.dict[a].language_name||a};Localizer.prototype.credits=function(){var a="",b=this;this.languages().forEach(function(c){a=a+"\n"+b.languageName(c)+" ("+c+") - "+b.dict[c].language_translator+" - "+b.dict[c].last_changed});return a};
Localizer.prototype.unload=function(){var a,b=["language_name","language_translator","last_changed"],c=this;this.languages().forEach(function(d){var e;if("en"!==d)for(e in a=c.dict[d],a)Object.prototype.hasOwnProperty.call(a,e)&&!contains(b,e)&&delete a[e]})};
SnapTranslator.dict.en={language_name:"English",language_translator:"Jens M\u00f6nig","translator_e-mail":"jens@moenig.org",last_changed:"2015-12-22",any:"random","file menu import hint":"load an exported project file\nor block library, a costume\nor a sound","settings menu prefer empty slots hint":"check to focus on empty slots\nwhen dragging & dropping reporters","costumes tab help":"import a picture from another web page or from\na file on your computer by dropping it here\n","block deletion dialog text":"Are you sure you want to delete this\ncustom block and all its instances?",
"download to disk text":"This item could not be opened in a new tab.\nIt has been saved to your browser's downloads folder.","unable to export text":"This item could not be exported from Snap!.\nIt's likely that your project may contain a lot of media (sounds and images) or that you are using an older browser.Please try using a recent version of Chrome, Firefox, or Safari."};
SnapTranslator.dict.de={language_name:"Deutsch",language_translator:"Jens M\u00f6nig","translator_e-mail":"jens@moenig.org",last_changed:"2017-10-20"};SnapTranslator.dict.it={language_name:"Italiano",language_translator:"Stefano Federici, Alberto Firpo, Massimo Ghisalberti","translator_e-mail":"s_federici@yahoo.com, albertofirpo12@gmail.com, zairik@gmail.com",last_changed:"2016-05-10"};
SnapTranslator.dict.ja={language_name:"\u65e5\u672c\u8a9e",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2012-04-02"};SnapTranslator.dict.ja_HIRA={language_name:"\u306b\u307b\u3093\u3054",language_translator:"Kazuhiro Abe","translator_e-mail":"abee@squeakland.jp",last_changed:"2012-04-02"};SnapTranslator.dict.ko={language_name:"\ud55c\uad6d\uc5b4",language_translator:"Yunjae Jang","translator_e-mail":"janggoons@gmail.com",last_changed:"2015-01-21"};
SnapTranslator.dict.pt={language_name:"Portugu\u00eas",language_translator:"Manuel Menezes de Sequeira","translator_e-mail":"mmsequeira@gmail.com",last_changed:"2017-10-30"};SnapTranslator.dict.cs={language_name:"\u010cesky",language_translator:"Michal Moc, Jan Tomsa","translator_e-mail":"info@iguru.eu, jan.tomsa.1976@gmail.com",last_changed:"2015-11-16"};
SnapTranslator.dict.zh_CN={language_name:"\u7b80\u4f53\u4e2d\u6587",language_translator:"\u4e94\u767e\u5200/\u9093\u6c5f\u534e","translator_e-mail":"ubertao@qq.com/djh@rhjxx.cn",last_changed:"2017-10-28"};SnapTranslator.dict.eo={language_name:"Esperanto",language_translator:"Sebastian Cyprych","translator_e-mail":"sebacyp(heliko)gmail(punkto)com",last_changed:"2017-10-01"};
SnapTranslator.dict.fr={language_name:"Fran\u00e7ais",language_translator:"Jean-Jacques Valliet, Mark Rafter, Martin Quinson, Damien Caselli","translator_e-mail":"i.scool@mac.com",last_changed:"2016-10-27"};SnapTranslator.dict.si={language_name:"Sloven\u0161\u010dina",language_translator:"Sasa Divjak, Gorazd Breskvar","translator_e-mail":"sasa.divjak@fri.uni-lj.si",last_changed:"2016-04-22"};
SnapTranslator.dict.ru={language_name:"\u0420\u0443\u0441\u0441\u043a\u0438\u0439",language_translator:"Svetlana Ptashnaya, \u041f\u0440\u043e\u0441\u043a\u0443\u0440\u043d\u0451\u0432 \u0410\u0440\u0442\u0451\u043c","translator_e-mail":"svetlanap@berkeley.edu, tema@school830.ru",last_changed:"2017-09-01"};SnapTranslator.dict.es={language_name:"Espa\u00f1ol",language_translator:"V\u00edctor Manuel Muratalla Morales","translator_e-mail":"victor.muratalla@yahoo.com",last_changed:"2013-03-25"};
SnapTranslator.dict.nl={language_name:"Nederlands",language_translator:"Sjoerd Dirk Meijer, Frank Sierens, Jan-Gerard van der Toorn","translator_e-mail":"sjoerddirk@fromScratchEd.nl, frank.sierens@telenet.be, jg.2019@xs4all.nl",last_changed:"2017-09-01"};SnapTranslator.dict.pl={language_name:"Polski",language_translator:"Witek Kranas & deKrain","translator_e-mail":"witek@oeiizk.waw.pl",last_changed:"2017-11-09"};
SnapTranslator.dict.zh_TW={language_name:"\u7e41\u9ad4\u4e2d\u6587",language_translator:"cch","translator_e-mail":"cchuang2009@gmail.com",last_changed:"2013-8-14"};SnapTranslator.dict.no={language_name:"Norsk",language_translator:"Olav A Marschall","translator_e-mail":"mattebananer@gmail.com",last_changed:"2013-09-16"};SnapTranslator.dict.dk={language_name:"Dansk",language_translator:"FAB, Pelle Hjek","translator_e-mail":"fab@nielsen.mail.dk, hjek@mail.com",last_changed:"2016-11-16"};
SnapTranslator.dict.el={language_name:"\u0395\u03bb\u03bb\u03b7\u03bd\u03b9\u03ba\u03ac",language_translator:"Ino Samaras","translator_e-mail":"ino.samaras@berkeley.edu",last_changed:"2013-09-16"};SnapTranslator.dict.ca={language_name:"Catal\u00e0",language_translator:"Bernat Romagosa Carrasquer, Joan Guill\u00e9n i Pelegay","translator_e-mail":"bernat@snap4arduino.rocks, jguille2@xtec.cat",last_changed:"2017-11-15"};
SnapTranslator.dict.fi={language_name:"suomi",language_translator:"Jouni K. Sepp\u00e4nen","translator_e-mail":"jks@iki.fi",last_changed:"2014-04-18"};SnapTranslator.dict.sv={language_name:"svenska",language_translator:"Erik A. Olsson","translator_e-mail":"eolsson@gmail.com",last_changed:"2016-06-09"};SnapTranslator.dict.pt_BR={language_name:"Portugu\u00eas do Brasil",language_translator:"Aldo von Wangenheim","translator_e-mail":"awangenh@inf.ufsc.br",last_changed:"2014-04-20"};
SnapTranslator.dict.bn={language_name:"\u09ac\u09be\u0982\u09b2\u09be",language_translator:"Dr. Mokter Hossain","translator_e-mail":"mokter@gmail.com",last_changed:"2014-07-02"};SnapTranslator.dict.kn={language_name:"\u0c95\u0ca8\u0ccd\u0ca8\u0ca1",language_translator:"Vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2014-12-02"};SnapTranslator.dict.ml={language_name:"Malayalam",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"};
SnapTranslator.dict.ta={language_name:"Tamil",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"};SnapTranslator.dict.te={language_name:"Telagu",language_translator:"vinayakumar R","translator_e-mail":"vnkmr7620@gmail.com",last_changed:"2015-02-20"};SnapTranslator.dict.tr={language_name:"T\u00fcrk\u00e7e",language_translator:"Hakan Atas","translator_e-mail":"hakanatas@gmail.com",last_changed:"2015-7-27"};
SnapTranslator.dict.hu={language_name:"Magyar",language_translator:"Mak\u00e1ny Gy\u00f6rgy","translator_e-mail":"makany.gyorgy@gmail.com",last_changed:"2015-07-27"};SnapTranslator.dict.ia={language_name:"Interlingua",language_translator:"Ken Dickey","translator_e-mail":"Ken.Dickey@whidbey.com",last_changed:"2015-08-09"};SnapTranslator.dict.hr={language_name:"Hrvatski",language_translator:"\u017deljko Hrvoj","translator_e-mail":"zeljko.hrvoj@zg.t-com.hr",last_changed:"2017-08-15"};
SnapTranslator.dict.bg={language_name:"\u0411\u044a\u043b\u0433\u0430\u0440\u0441\u043a\u0438",language_translator:"Ivan Savov","translator_e-mail":"ivan.savov@gmail.com",last_changed:"2015-11-16"};SnapTranslator.dict.ro={language_name:"Rom\u00e2n",language_translator:"Cristian Macarascu","translator_e-mail":"",last_changed:"2015-10-24"};
SnapTranslator.dict.ar={language_name:"\u0627\u0644\u0639\u0631\u0628\u064a\u0629",language_translator:"\u0637\u0627\u0631\u0642 \u062c\u0644\u0627\u0644","translator_e-mail":"tarekgalal46@hotmail.com",last_changed:"2016-02-24"};SnapTranslator.dict.id={language_name:"Bahasa Indonesia",language_translator:"Alexander Raphael Liu","translator_e-mail":"raphaxander@gmail.com",last_changed:"2016-5-2"};
SnapTranslator.dict.et={language_name:"Eesti",language_translator:"Hasso Tepper","translator_e-mail":"hasso.tepper@gmail.com",last_changed:"2016-05-03"};SnapTranslator.dict.gl={language_name:"Galego",language_translator:"tecnoloxia","translator_e-mail":"",last_changed:"2016-11-09"};modules.cloud="2015-December-15";var SnapCloud=new Cloud("https://snap.apps.miosoft.com/SnapCloudLocal");function Cloud(a){this.password=this.username=null;this.url=a;this.route=this.limo=this.session=null;this.api={}}Cloud.prototype.clear=function(){this.route=this.limo=this.session=this.password=this.username=null;this.api={}};Cloud.prototype.hasProtocol=function(){return 0===this.url.toLowerCase().indexOf("http")};
Cloud.prototype.setRoute=function(a){var b=0,c;for(c=0;c<a.length;c+=1)b+=a.charCodeAt(c);b=b%20+1;this.route=".sc1m"+(10>b?"0":"")+b};
Cloud.prototype.signup=function(a,b,c,d){var e=new XMLHttpRequest,f=this;try{e.open("GET",(this.hasProtocol()?"":"http://")+this.url+"SignUp?Username="+encodeURIComponent(a)+"&Email="+encodeURIComponent(b),!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.withCredentials=!0,e.onreadystatechange=function(){4===e.readyState&&(e.responseText?0===e.responseText.indexOf("ERROR")?d.call(this,e.responseText,"Signup"):c.call(null,e.responseText,"Signup"):d.call(null,f.url+"SignUp",
localize("could not connect to:")))},e.send(null)}catch(g){d.call(this,g.toString(),"Snap!Cloud")}};
Cloud.prototype.getPublicProject=function(a,b,c){var d=new XMLHttpRequest,e=this;try{d.open("GET",(this.hasProtocol()?"":"http://")+this.url+"RawPublic?"+a,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.withCredentials=!0,d.onreadystatechange=function(){4===d.readyState&&(d.responseText?0===d.responseText.indexOf("ERROR")?c.call(this,d.responseText):b.call(null,d.responseText):c.call(null,e.url+"Public",localize("could not connect to:")))},d.send(null)}catch(f){c.call(this,
f.toString(),"Snap!Cloud")}};
Cloud.prototype.resetPassword=function(a,b,c){var d=new XMLHttpRequest,e=this;try{d.open("GET",(this.hasProtocol()?"":"http://")+this.url+"ResetPW?Username="+encodeURIComponent(a),!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.withCredentials=!0,d.onreadystatechange=function(){4===d.readyState&&(d.responseText?0===d.responseText.indexOf("ERROR")?c.call(this,d.responseText,"Reset Password"):b.call(null,d.responseText,"Reset Password"):c.call(null,e.url+"ResetPW",localize("could not connect to:")))},
d.send(null)}catch(f){c.call(this,f.toString(),"Snap!Cloud")}};
Cloud.prototype.login=function(a,b,c,d){var e=new XMLHttpRequest,f=JSON.stringify({__h:b,__u:a}),g=this;this.setRoute(a);try{e.open("POST",(this.hasProtocol()?"":"http://")+this.url+"?SESSIONGLUE="+this.route,!0),e.setRequestHeader("Content-Type","application/json; charset=utf-8"),e.setRequestHeader("SESSIONGLUE",this.route),e.withCredentials=!0,e.onreadystatechange=function(){4===e.readyState&&(e.responseText?(g.api=g.parseAPI(e.responseText),g.session=e.getResponseHeader("MioCracker").split(";")[0],
g.limo=this.getResponseHeader("miocracker").substring(9,this.getResponseHeader("miocracker").indexOf("=")),g.api.logout?(g.username=a,g.password=b,c.call(null,g.api,"Snap!Cloud")):d.call(null,e.responseText,"connection failed")):d.call(null,g.url,localize("could not connect to:")))},e.send(f)}catch(h){d.call(this,h.toString(),"Snap!Cloud")}};Cloud.prototype.reconnect=function(a,b){this.username&&this.password?this.login(this.username,this.password,a,b):this.message("You are not logged in")};
Cloud.prototype.saveProject=function(a,b,c){var d=this;a.serializer.isCollectingMedia=!0;var e=a.serializer.serialize(a.stage);var f=a.hasChangedMedia?a.serializer.mediaXML(a.projectName):null;a.serializer.isCollectingMedia=!1;a.serializer.flushMedia();var g=f?f.length:0;var h=e.length+g;if(10485760<g)throw(new DialogBoxMorph).inform("Snap!Cloud - Cannot Save Project","The media inside this project exceeds 10 MB.\nPlease reduce the size of costumes or sounds.\n",a.world(),a.cloudIcon(null,new Color(180,
0,0))),Error("Project media exceeds 10 MB size limit");try{a.serializer.parse(e)}catch(k){throw a.showMessage("Serialization of program data failed:\n"+k),Error("Serialization of program data failed:\n"+k);}if(null!==f)try{a.serializer.parse(f)}catch(k){throw a.showMessage("Serialization of media failed:\n"+k),Error("Serialization of media failed:\n"+k);}a.serializer.isCollectingMedia=!1;a.serializer.flushMedia();a.showMessage("Uploading "+Math.round(h/1024)+" KB...");d.reconnect(function(){d.callService("saveProject",
function(c,e){b.call(null,c,e);d.disconnect();a.hasChangedMedia=!1},c,[a.projectName,e,f,e.length,f?f.length:0])},c)};Cloud.prototype.getProjectList=function(a,b){var c=this;this.reconnect(function(){c.callService("getProjectList",function(b,e){a.call(null,b,e);c.disconnect()},b)},b)};Cloud.prototype.changePassword=function(a,b,c,d){var e=this;this.reconnect(function(){e.callService("changePassword",function(a,b){c.call(null,a,b);e.disconnect()},d,[hex_sha512(a),hex_sha512(b)])},d)};
Cloud.prototype.logout=function(a,b){this.clear();this.callService("logout",a,b)};Cloud.prototype.disconnect=function(){this.callService("logout",nop,nop)};
Cloud.prototype.callURL=function(a,b,c){var d=new XMLHttpRequest,e=this;try{var f=a+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo;d.open("GET",f,!0);d.withCredentials=!0;d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");d.setRequestHeader("MioCracker",this.session);d.setRequestHeader("SESSIONGLUE",this.route);d.onreadystatechange=function(){if(4===d.readyState)if(d.responseText){var f=e.parseResponse(d.responseText);b.call(null,f,a)}else c.call(null,a,"no response from:")};d.send(null)}catch(g){c.call(this,
g.toString(),a)}};
Cloud.prototype.callService=function(a,b,c,d){var e=new XMLHttpRequest,f=this.api[a],g=this;if(this.session)if(f){if(d&&0<d.length){var h={};f.parameters.forEach(function(a,b){h[a]=d[b]})}try{var k=this.url+"/"+f.url+"&SESSIONGLUE="+this.route+"&_Limo="+this.limo;e.open(f.method,k,!0);e.withCredentials=!0;e.setRequestHeader("Content-Type","application/x-www-form-urlencoded");e.setRequestHeader("MioCracker",this.session);e.setRequestHeader("SESSIONGLUE",this.route);e.onreadystatechange=function(){if(4===
e.readyState)if(e.responseText&&0===e.responseText.indexOf("ERROR"))c.call(this,e.responseText,localize("Service:")+" "+localize(a));else{"login"===a&&(g.api=g.parseAPI(e.responseText));var d="getRawProject"===a?e.responseText:g.parseResponse(e.responseText);b.call(null,d,f.url)}};e.send(this.encodeDict(h))}catch(l){c.call(this,l.toString(),f.url)}}else c.call(null,"service "+a+" is not available","API");else c.call(null,"You are not connected","Cloud")};
Cloud.prototype.parseAPI=function(a){var b={};a.split(" ").forEach(function(a){var c={},e;a.split("&").forEach(function(a){var d=a.split("=");a=decodeURIComponent(d[0]).toLowerCase();d=decodeURIComponent(d[1]);if("service"===a)b[d]=c;else if("parameters"===a){if(e=d.split(","),1!==e.length||e[0])c.parameters=e}else c[a]=d})});return b};
Cloud.prototype.parseResponse=function(a){var b=[];if(!a)return b;a.split(" ").forEach(function(a){var c={};a.split("&").forEach(function(a){var b=a.split("=");a=decodeURIComponent(b[0]);b=decodeURIComponent(b[1]);c[a]=b});b.push(c)});return b};Cloud.prototype.parseDict=function(a){var b={};if(!a)return b;a.split("&").forEach(function(a){var c=a.split("=");a=decodeURIComponent(c[0]);c=decodeURIComponent(c[1]);b[a]=c});return b};
Cloud.prototype.encodeDict=function(a){var b="",c;if(!a)return null;for(c in a)if(a.hasOwnProperty(c)){var d=encodeURIComponent(c)+"="+encodeURIComponent(a[c]);0<b.length&&(b+="&");b+=d}return b};Cloud.prototype.message=function(a){alert(a)};var hex_sha512=function(a){function a(a){return c.SHA512(b(a)).toString(c.enc.Hex)}function b(a){for(var b="",c=-1,d,h;++c<a.length;)d=a.charCodeAt(c),h=c+1<a.length?a.charCodeAt(c+1):0,55296<=d&&56319>=d&&56320<=h&&57343>=h&&(d=65536+((d&1023)<<10)+(h&1023),c++),127>=d?b+=String.fromCharCode(d):2047>=d?b+=String.fromCharCode(192|d>>>6&31,128|d&63):65535>=d?b+=String.fromCharCode(224|d>>>12&15,128|d>>>6&63,128|d&63):2097151>=d&&(b+=String.fromCharCode(240|d>>>18&7,128|d>>>12&63,128|d>>>6&63,128|d&
63));return b}var c=c||function(a,b){var c={},d=c.lib={},e=d.Base=function(){function a(){}return{extend:function(b){a.prototype=this;var c=new a;b&&c.mixIn(b);c.$super=this;return c},create:function(){var a=this.extend();a.init.apply(a,arguments);return a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.$super.extend(this)}}}(),k=d.WordArray=e.extend({init:function(a,c){a=
this.words=a||[];this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||m).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;a=a.sigBytes;this.clamp();if(d%4)for(var e=0;e<a;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-e%4*8&255)<<24-(d+e)%4*8;else if(65535<c.length)for(e=0;e<a;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);this.sigBytes+=a;return this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-c%4*8;b.length=a.ceil(c/4)},clone:function(){var a=
e.clone.call(this);a.words=this.words.slice(0);return a},random:function(b){for(var c=[],d=0;d<b;d+=4)c.push(4294967296*a.random()|0);return k.create(c,b)}}),l=c.enc={},m=l.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;d<a;d++){var e=b[d>>>2]>>>24-d%4*8&255;c.push((e>>>4).toString(16));c.push((e&15).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;d<b;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-d%8*4;return k.create(c,b/2)}},n=l.Latin1={stringify:function(a){var b=
a.words;a=a.sigBytes;for(var c=[],d=0;d<a;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-d%4*8&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;d<b;d++)c[d>>>2]|=(a.charCodeAt(d)&255)<<24-d%4*8;return k.create(c,b)}},p=l.Utf8={stringify:function(a){try{return decodeURIComponent(escape(n.stringify(a)))}catch(z){throw Error("Malformed UTF-8 data");}},parse:function(a){return n.parse(unescape(encodeURIComponent(a)))}},q=d.BufferedBlockAlgorithm=e.extend({reset:function(){this._data=
k.create();this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=p.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,g=e/(4*f);g=b?a.ceil(g):a.max((g|0)-this._minBufferSize,0);b=g*f;e=a.min(4*b,e);if(b){for(var h=0;h<b;h+=f)this._doProcessBlock(d,h);h=d.splice(0,b);c.sigBytes-=e}return k.create(h,e)},clone:function(){var a=e.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});d.Hasher=
q.extend({init:function(){this.reset()},reset:function(){q.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);this._doFinalize();return this._hash},clone:function(){var a=q.clone.call(this);a._hash=this._hash.clone();return a},blockSize:16,_createHelper:function(a){return function(b,c){return a.create(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return t.HMAC.create(a,c).finalize(b)}}});var t=
c.algo={};return c}(Math);(function(a){var b=c,d=b.lib,g=d.Base,h=d.WordArray;b=b.x64={};b.Word=g.extend({init:function(a,b){this.high=a;this.low=b}});b.WordArray=g.extend({init:function(b,c){b=this.words=b||[];this.sigBytes=c!=a?c:8*b.length},toX32:function(){for(var a=this.words,b=a.length,c=[],d=0;d<b;d++){var e=a[d];c.push(e.high);c.push(e.low)}return h.create(c,this.sigBytes)},clone:function(){for(var a=g.clone.call(this),b=a.words=this.words.slice(0),c=b.length,d=0;d<c;d++)b[d]=b[d].clone();
return a}})})();(function(){function a(){return h.create.apply(h,arguments)}var b=c,f=b.lib.Hasher,g=b.x64,h=g.Word,k=g.WordArray;g=b.algo;var l=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,
633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),
a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,
3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,
3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],m=[];(function(){for(var b=0;80>b;b++)m[b]=a()})();g=g.SHA512=f.extend({_doReset:function(){this._hash=k.create([a(1779033703,4089235720),a(3144134277,2227873595),a(1013904242,4271175723),a(2773480762,1595750129),a(1359893119,2917565137),a(2600822924,725511199),a(528734635,4215389547),a(1541459225,327033209)])},_doProcessBlock:function(a,b){var c=this._hash.words,d=c[0],e=c[1],f=c[2],g=c[3],h=c[4],k=c[5],n=c[6];
c=c[7];var p=d.high,w=d.low,U=e.high,D=e.low,P=f.high,x=f.low,A=g.high,u=g.low,I=h.high,B=h.low,L=k.high,C=k.low,oa=n.high,ha=n.low,pa=c.high,ia=c.low;var H=p;var E=w;var aa=U;var W=D;var ba=P;var X=x;var la=A;var ca=u;var J=I;var F=B;var ja=L;var da=C;var ka=oa;var ea=ha;var ma=pa;var fa=ia;for(var K=0;80>K;K++){var Q=m[K];if(16>K){var G=Q.high=a[b+2*K]|0;var v=Q.low=a[b+2*K+1]|0}else{G=m[K-15];v=G.high;var M=G.low;G=(M<<31|v>>>1)^(M<<24|v>>>8)^v>>>7;M=(v<<31|M>>>1)^(v<<24|M>>>8)^(v<<25|M>>>7);var V=
m[K-2];v=V.high;var y=V.low;V=(y<<13|v>>>19)^(v<<3|y>>>29)^v>>>6;y=(v<<13|y>>>19)^(y<<3|v>>>29)^(v<<26|y>>>6);v=m[K-7];var na=v.high;var R=m[K-16];var N=R.high;R=R.low;v=M+v.low;G=G+na+(v>>>0<M>>>0?1:0);v+=y;G=G+V+(v>>>0<y>>>0?1:0);v+=R;G=G+N+(v>>>0<R>>>0?1:0);Q.high=G;Q.low=v}na=J&ja^~J&ka;R=F&da^~F&ea;Q=H&aa^H&ba^aa&ba;var ra=E&W^E&X^W&X;M=(E<<4|H>>>28)^(H<<30|E>>>2)^(H<<25|E>>>7);V=(H<<4|E>>>28)^(E<<30|H>>>2)^(E<<25|H>>>7);y=l[K];var sa=y.high,qa=y.low;y=fa+((J<<18|F>>>14)^(J<<14|F>>>18)^(F<<23|
J>>>9));N=ma+((F<<18|J>>>14)^(F<<14|J>>>18)^(J<<23|F>>>9))+(y>>>0<fa>>>0?1:0);y+=R;N=N+na+(y>>>0<R>>>0?1:0);y+=qa;N=N+sa+(y>>>0<qa>>>0?1:0);y+=v;N=N+G+(y>>>0<v>>>0?1:0);v=V+ra;Q=M+Q+(v>>>0<V>>>0?1:0);ma=ka;fa=ea;ka=ja;ea=da;ja=J;da=F;F=ca+y|0;J=la+N+(F>>>0<ca>>>0?1:0)|0;la=ba;ca=X;ba=aa;X=W;aa=H;W=E;E=y+v|0;H=N+Q+(E>>>0<y>>>0?1:0)|0}w=d.low=w+E|0;d.high=p+H+(w>>>0<E>>>0?1:0)|0;D=e.low=D+W|0;e.high=U+aa+(D>>>0<W>>>0?1:0)|0;x=f.low=x+X|0;f.high=P+ba+(x>>>0<X>>>0?1:0)|0;u=g.low=u+ca|0;g.high=A+la+(u>>>
0<ca>>>0?1:0)|0;B=h.low=B+F|0;h.high=I+J+(B>>>0<F>>>0?1:0)|0;C=k.low=C+da|0;k.high=L+ja+(C>>>0<da>>>0?1:0)|0;ha=n.low=ha+ea|0;n.high=oa+ka+(ha>>>0<ea>>>0?1:0)|0;ia=c.low=ia+fa|0;c.high=pa+ma+(ia>>>0<fa>>>0?1:0)|0},_doFinalize:function(){var a=this._data,b=a.words,c=8*this._nDataBytes,d=8*a.sigBytes;b[d>>>5]|=128<<24-d%32;b[(d+128>>>10<<5)+31]=c;a.sigBytes=4*b.length;this._process();this._hash=this._hash.toX32()},blockSize:32});b.SHA512=f._createHelper(g);b.HmacSHA512=f._createHmacHelper(g)})();return a}({});/*
 @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||function(a){if(!("undefined"===typeof a||"undefined"!==typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var b=a.document.createElementNS("http://www.w3.org/1999/xhtml","a"),c="download"in b,d=/constructor/i.test(a.HTMLElement)||a.safari,e=/CriOS\/[\d]+/.test(navigator.userAgent),f=function(b){(a.setImmediate||a.setTimeout)(function(){throw b;},0)},g=function(b){setTimeout(function(){"string"===typeof b?(a.URL||a.webkitURL||a).revokeObjectURL(b):b.remove()},4E4)},h=function(a){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?
new Blob([String.fromCharCode(65279),a],{type:a.type}):a},k=function(k,l,p){p||(k=h(k));var m=this,n="application/octet-stream"===k.type,r=function(){var a=["writestart","progress","write","writeend"];a=[].concat(a);for(var b=a.length;b--;){var c=m["on"+a[b]];if("function"===typeof c)try{c.call(m,m)}catch(O){f(O)}}};m.readyState=m.INIT;if(c){var z=(a.URL||a.webkitURL||a).createObjectURL(k);setTimeout(function(){b.href=z;b.download=l;var a=new MouseEvent("click");b.dispatchEvent(a);r();g(z);m.readyState=
m.DONE})}else(function(){if((e||n&&d)&&a.FileReader){var b=new FileReader;b.onloadend=function(){var c=e?b.result:b.result.replace(/^data:[^;]*;/,"data:attachment/file;");a.open(c,"_blank")||(a.location.href=c);m.readyState=m.DONE;r()};b.readAsDataURL(k);m.readyState=m.INIT}else z||(z=(a.URL||a.webkitURL||a).createObjectURL(k)),n?a.location.href=z:a.open(z,"_blank")||(a.location.href=z),m.readyState=m.DONE,r(),g(z)})()},l=k.prototype;if("undefined"!==typeof navigator&&navigator.msSaveOrOpenBlob)return function(a,
b,c){b=b||a.name||"download";c||(a=h(a));return navigator.msSaveOrOpenBlob(a,b)};l.abort=function(){};l.readyState=l.INIT=0;l.WRITING=1;l.DONE=2;l.error=l.onwritestart=l.onprogress=l.onwrite=l.onabort=l.onerror=l.onwriteend=null;return function(a,b,c){return new k(a,b||a.name||"download",c)}}}("undefined"!==typeof self&&self||"undefined"!==typeof window&&window||this.content);
"undefined"!==typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!==typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});var world;
window.onload=function(){var a=document.getElementById("world"),b=new IDE_Morph;world=new WorldMorph(a);b.openIn(world);if(window.frameElement){var c=window.frameElement.getAttribute("project_path"),d=window.frameElement.getAttribute("run_full_screen"),e=d||window.frameElement.getAttribute("full_screen");c&&fetch(c).then(function(a){a.text().then(function(a){b.rawOpenProjectString(a);e&&b.toggleAppMode(!0);d&&b.runScripts()})}).catch(function(a){console.error("Error fetching "+c+": "+a.message)});e||
(b.controlBar.hide(),b.toggleAppMode(!1));window.onbeforeunload=function(){};ecraft2learn.get_voice_names()}(function g(){requestAnimationFrame(g);world.doOneCycle()})()};
